!function(){function e(e,t,n,r,i,o,a){try{var s=e[o](a),u=s.value}catch(c){return void n(c)}s.done?t(u):Promise.resolve(u).then(r,i)}function t(t){return function(){var n=this,r=arguments;return new Promise((function(i,o){var a=t.apply(n,r);function s(t){e(a,i,o,s,u,"next",t)}function u(t){e(a,i,o,s,u,"throw",t)}s(void 0)}))}}function n(){return n="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(e,t,n){var r=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=_(e)););return e}(e,t);if(r){var i=Object.getOwnPropertyDescriptor(r,t);return i.get?i.get.call(arguments.length<3?e:n):i.value}},n.apply(this,arguments)}function r(e){return function(e){if(Array.isArray(e))return b(e)}(e)||function(e){if("undefined"!=typeof Symbol&&null!=e[Symbol.iterator]||null!=e["@@iterator"])return Array.from(e)}(e)||E(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function i(){"use strict";/*! regenerator-runtime -- Copyright (c) 2014-present, Facebook, Inc. -- license (MIT): https://github.com/facebook/regenerator/blob/main/LICENSE */i=function(){return t};var e,t={},n=Object.prototype,r=n.hasOwnProperty,o=Object.defineProperty||function(e,t,n){e[t]=n.value},a="function"==typeof Symbol?Symbol:{},u=a.iterator||"@@iterator",c=a.asyncIterator||"@@asyncIterator",l=a.toStringTag||"@@toStringTag";function f(e,t,n){return Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{f({},"")}catch(e){f=function(e,t,n){return e[t]=n}}function h(e,t,n,r){var i=t&&t.prototype instanceof y?t:y,a=Object.create(i.prototype),s=new k(r||[]);return o(a,"_invoke",{value:M(e,n,s)}),a}function d(e,t,n){try{return{type:"normal",arg:e.call(t,n)}}catch(e){return{type:"throw",arg:e}}}t.wrap=h;var p="suspendedStart",v="suspendedYield",m="executing",g="completed",_={};function y(){}function E(){}function b(){}var A={};f(A,u,(function(){return this}));var x=Object.getPrototypeOf,S=x&&x(x(N([])));S&&S!==n&&r.call(S,u)&&(A=S);var T=b.prototype=y.prototype=Object.create(A);function R(e){["next","throw","return"].forEach((function(t){f(e,t,(function(e){return this._invoke(t,e)}))}))}function C(e,t){function n(i,o,a,u){var c=d(e[i],e,o);if("throw"!==c.type){var l=c.arg,f=l.value;return f&&"object"==s(f)&&r.call(f,"__await")?t.resolve(f.__await).then((function(e){n("next",e,a,u)}),(function(e){n("throw",e,a,u)})):t.resolve(f).then((function(e){l.value=e,a(l)}),(function(e){return n("throw",e,a,u)}))}u(c.arg)}var i;o(this,"_invoke",{value:function(e,r){function o(){return new t((function(t,i){n(e,r,t,i)}))}return i=i?i.then(o,o):o()}})}function M(t,n,r){var i=p;return function(o,a){if(i===m)throw Error("Generator is already running");if(i===g){if("throw"===o)throw a;return{value:e,done:!0}}for(r.method=o,r.arg=a;;){var s=r.delegate;if(s){var u=w(s,r);if(u){if(u===_)continue;return u}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(i===p)throw i=g,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);i=m;var c=d(t,n,r);if("normal"===c.type){if(i=r.done?g:v,c.arg===_)continue;return{value:c.arg,done:r.done}}"throw"===c.type&&(i=g,r.method="throw",r.arg=c.arg)}}}function w(t,n){var r=n.method,i=t.iterator[r];if(i===e)return n.delegate=null,"throw"===r&&t.iterator.return&&(n.method="return",n.arg=e,w(t,n),"throw"===n.method)||"return"!==r&&(n.method="throw",n.arg=new TypeError("The iterator does not provide a '"+r+"' method")),_;var o=d(i,t.iterator,n.arg);if("throw"===o.type)return n.method="throw",n.arg=o.arg,n.delegate=null,_;var a=o.arg;return a?a.done?(n[t.resultName]=a.value,n.next=t.nextLoc,"return"!==n.method&&(n.method="next",n.arg=e),n.delegate=null,_):a:(n.method="throw",n.arg=new TypeError("iterator result is not an object"),n.delegate=null,_)}function L(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function O(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function k(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(L,this),this.reset(!0)}function N(t){if(t||""===t){var n=t[u];if(n)return n.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var i=-1,o=function n(){for(;++i<t.length;)if(r.call(t,i))return n.value=t[i],n.done=!1,n;return n.value=e,n.done=!0,n};return o.next=o}}throw new TypeError(s(t)+" is not iterable")}return E.prototype=b,o(T,"constructor",{value:b,configurable:!0}),o(b,"constructor",{value:E,configurable:!0}),E.displayName=f(b,l,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===E||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,b):(e.__proto__=b,f(e,l,"GeneratorFunction")),e.prototype=Object.create(T),e},t.awrap=function(e){return{__await:e}},R(C.prototype),f(C.prototype,c,(function(){return this})),t.AsyncIterator=C,t.async=function(e,n,r,i,o){void 0===o&&(o=Promise);var a=new C(h(e,n,r,i),o);return t.isGeneratorFunction(n)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},R(T),f(T,l,"Generator"),f(T,u,(function(){return this})),f(T,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),n=[];for(var r in t)n.push(r);return n.reverse(),function e(){for(;n.length;){var r=n.pop();if(r in t)return e.value=r,e.done=!1,e}return e.done=!0,e}},t.values=N,k.prototype={constructor:k,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(O),!t)for(var n in this)"t"===n.charAt(0)&&r.call(this,n)&&!isNaN(+n.slice(1))&&(this[n]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var n=this;function i(r,i){return s.type="throw",s.arg=t,n.next=r,i&&(n.method="next",n.arg=e),!!i}for(var o=this.tryEntries.length-1;o>=0;--o){var a=this.tryEntries[o],s=a.completion;if("root"===a.tryLoc)return i("end");if(a.tryLoc<=this.prev){var u=r.call(a,"catchLoc"),c=r.call(a,"finallyLoc");if(u&&c){if(this.prev<a.catchLoc)return i(a.catchLoc,!0);if(this.prev<a.finallyLoc)return i(a.finallyLoc)}else if(u){if(this.prev<a.catchLoc)return i(a.catchLoc,!0)}else{if(!c)throw Error("try statement without catch or finally");if(this.prev<a.finallyLoc)return i(a.finallyLoc)}}}},abrupt:function(e,t){for(var n=this.tryEntries.length-1;n>=0;--n){var i=this.tryEntries[n];if(i.tryLoc<=this.prev&&r.call(i,"finallyLoc")&&this.prev<i.finallyLoc){var o=i;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=e,a.arg=t,o?(this.method="next",this.next=o.finallyLoc,_):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),_},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.finallyLoc===e)return this.complete(n.completion,n.afterLoc),O(n),_}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var n=this.tryEntries[t];if(n.tryLoc===e){var r=n.completion;if("throw"===r.type){var i=r.arg;O(n)}return i}}throw Error("illegal catch attempt")},delegateYield:function(t,n,r){return this.delegate={iterator:N(t),resultName:n,nextLoc:r},"next"===this.method&&(this.arg=e),_}},t}function o(e,t,n){return(t=l(t))in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function a(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=n){var r,i,o,a,s=[],u=!0,c=!1;try{if(o=(n=n.call(e)).next,0===t){if(Object(n)!==n)return;u=!1}else for(;!(u=(r=o.call(n)).done)&&(s.push(r.value),s.length!==t);u=!0);}catch(e){c=!0,i=e}finally{try{if(!u&&null!=n.return&&(a=n.return(),Object(a)!==a))return}finally{if(c)throw i}}return s}}(e,t)||E(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function s(e){return s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},s(e)}function u(e,t){for(var n=0;n<t.length;n++){var r=t[n];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,l(r.key),r)}}function c(e,t,n){return t&&u(e.prototype,t),n&&u(e,n),Object.defineProperty(e,"prototype",{writable:!1}),e}function l(e){var t=function(e,t){if("object"!=s(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,t||"default");if("object"!=s(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==s(t)?t:t+""}function f(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function h(e,t,n){return t=_(t),function(e,t){if(t&&("object"===s(t)||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}(e,m()?Reflect.construct(t,n||[],_(e).constructor):t.apply(e,n))}function d(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&g(e,t)}function p(e){var t="function"==typeof Map?new Map:void 0;return p=function(e){if(null===e||!function(e){try{return-1!==Function.toString.call(e).indexOf("[native code]")}catch(t){return"function"==typeof e}}(e))return e;if("function"!=typeof e)throw new TypeError("Super expression must either be null or a function");if(void 0!==t){if(t.has(e))return t.get(e);t.set(e,n)}function n(){return v(e,arguments,_(this).constructor)}return n.prototype=Object.create(e.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),g(n,e)},p(e)}function v(e,t,n){if(m())return Reflect.construct.apply(null,arguments);var r=[null];r.push.apply(r,t);var i=new(e.bind.apply(e,r));return n&&g(i,n.prototype),i}function m(){try{var e=!Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){})))}catch(e){}return(m=function(){return!!e})()}function g(e,t){return g=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,t){return e.__proto__=t,e},g(e,t)}function _(e){return _=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},_(e)}function y(e,t){var n="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=E(e))||t&&e&&"number"==typeof e.length){n&&(e=n);var r=0,i=function(){};return{s:i,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:i}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var o,a=!0,s=!1;return{s:function(){n=n.call(e)},n:function(){var e=n.next();return a=e.done,e},e:function(e){s=!0,o=e},f:function(){try{a||null==n.return||n.return()}finally{if(s)throw o}}}}function E(e,t){if(e){if("string"==typeof e)return b(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);return"Object"===n&&e.constructor&&(n=e.constructor.name),"Map"===n||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?b(e,t):void 0}}function b(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}System.register(["./index-legacy.b41ee0ef.js","./antdv-legacy.7bd4694a.js"],(function(e,u){"use strict";var l,m,g,E,b,A,x,S,T,R,C,M,w,L,O,k,N,I,P,D,F,B,U,G,z,j,V,H,X,W,Y,Z,q,K,Q,$,J,ee,te,ne,re,ie,oe,ae,se,ue,ce,le,fe,he;return{setters:[function(e){l=e.t,m=e.b,g=e.i,E=e.c,b=e.d,A=e.m,x=e.e,S=e.f,T=e.g,R=e.h,C=e.j,M=e.k,w=e.l,L=e.n,O=e.o,k=e.p,N=e.q,I=e.v,P=e.w,D=e.x,F=e.y,B=e.z,U=e.A,G=e.B,z=e.C,j=e.D,V=e.E,H=e.F,X=e.G,W=e.H,Y=e.I,Z=e.J,q=e.K,K=e.L,Q=e.M,$=e.N,J=e.O,ee=e.P,te=e.Q},function(e){ne=e.S,re=e.Y,ie=e.T,oe=e.Z,e.P,ae=e.R,se=e.W,ue=e.V,ce=e.r,le=e.aa,fe=e.k,he=e.o}],execute:function(){var u,de,pe,ve=134217729,me=33306690738754706e-32;function ge(e,t,n,r,i){var o,a,s,u,c=t[0],l=r[0],f=0,h=0;l>c==l>-c?(o=c,c=t[++f]):(o=l,l=r[++h]);var d=0;if(f<e&&h<n)for(l>c==l>-c?(s=o-((a=c+o)-c),c=t[++f]):(s=o-((a=l+o)-l),l=r[++h]),o=a,0!==s&&(i[d++]=s);f<e&&h<n;)l>c==l>-c?(s=o-((a=o+c)-(u=a-o))+(c-u),c=t[++f]):(s=o-((a=o+l)-(u=a-o))+(l-u),l=r[++h]),o=a,0!==s&&(i[d++]=s);for(;f<e;)s=o-((a=o+c)-(u=a-o))+(c-u),c=t[++f],o=a,0!==s&&(i[d++]=s);for(;h<n;)s=o-((a=o+l)-(u=a-o))+(l-u),l=r[++h],o=a,0!==s&&(i[d++]=s);return 0===o&&0!==d||(i[d++]=o),d}function _e(e){return new Float64Array(e)}var ye=22204460492503146e-32,Ee=11093356479670487e-47,be=_e(4),Ae=_e(8),xe=_e(12),Se=_e(16),Te=_e(4);function Re(e,t,n,r,i,o){var a=(t-o)*(n-i),s=(e-i)*(r-o),u=a-s,c=Math.abs(a+s);return Math.abs(u)>=33306690738754716e-32*c?u:-function(e,t,n,r,i,o,a){var s,u,c,l,f,h,d,p,v,m,g,_,y,E,b,A,x,S,T=e-i,R=n-i,C=t-o,M=r-o;f=(b=(p=T-(d=(h=ve*T)-(h-T)))*(m=M-(v=(h=ve*M)-(h-M)))-((E=T*M)-d*v-p*v-d*m))-(g=b-(x=(p=C-(d=(h=ve*C)-(h-C)))*(m=R-(v=(h=ve*R)-(h-R)))-((A=C*R)-d*v-p*v-d*m))),be[0]=b-(g+f)+(f-x),f=(y=E-((_=E+g)-(f=_-E))+(g-f))-(g=y-A),be[1]=y-(g+f)+(f-A),f=(S=_+g)-_,be[2]=_-(S-f)+(g-f),be[3]=S;var w=function(e,t){for(var n=t[0],r=1;r<e;r++)n+=t[r];return n}(4,be),L=ye*a;if(w>=L||-w>=L)return w;if(s=e-(T+(f=e-T))+(f-i),c=n-(R+(f=n-R))+(f-i),u=t-(C+(f=t-C))+(f-o),l=r-(M+(f=r-M))+(f-o),0===s&&0===u&&0===c&&0===l)return w;if(L=Ee*a+me*Math.abs(w),(w+=T*l+M*s-(C*c+R*u))>=L||-w>=L)return w;f=(b=(p=s-(d=(h=ve*s)-(h-s)))*(m=M-(v=(h=ve*M)-(h-M)))-((E=s*M)-d*v-p*v-d*m))-(g=b-(x=(p=u-(d=(h=ve*u)-(h-u)))*(m=R-(v=(h=ve*R)-(h-R)))-((A=u*R)-d*v-p*v-d*m))),Te[0]=b-(g+f)+(f-x),f=(y=E-((_=E+g)-(f=_-E))+(g-f))-(g=y-A),Te[1]=y-(g+f)+(f-A),f=(S=_+g)-_,Te[2]=_-(S-f)+(g-f),Te[3]=S;var O=ge(4,be,4,Te,Ae);f=(b=(p=T-(d=(h=ve*T)-(h-T)))*(m=l-(v=(h=ve*l)-(h-l)))-((E=T*l)-d*v-p*v-d*m))-(g=b-(x=(p=C-(d=(h=ve*C)-(h-C)))*(m=c-(v=(h=ve*c)-(h-c)))-((A=C*c)-d*v-p*v-d*m))),Te[0]=b-(g+f)+(f-x),f=(y=E-((_=E+g)-(f=_-E))+(g-f))-(g=y-A),Te[1]=y-(g+f)+(f-A),f=(S=_+g)-_,Te[2]=_-(S-f)+(g-f),Te[3]=S;var k=ge(O,Ae,4,Te,xe);f=(b=(p=s-(d=(h=ve*s)-(h-s)))*(m=l-(v=(h=ve*l)-(h-l)))-((E=s*l)-d*v-p*v-d*m))-(g=b-(x=(p=u-(d=(h=ve*u)-(h-u)))*(m=c-(v=(h=ve*c)-(h-c)))-((A=u*c)-d*v-p*v-d*m))),Te[0]=b-(g+f)+(f-x),f=(y=E-((_=E+g)-(f=_-E))+(g-f))-(g=y-A),Te[1]=y-(g+f)+(f-A),f=(S=_+g)-_,Te[2]=_-(S-f)+(g-f),Te[3]=S;var N=ge(k,xe,4,Te,Se);return Se[N-1]}(e,t,n,r,i,o,c)}var Ce={},Me={},we=function(e){return Me[e]},Le=function(e,t){Me[e]=t},Oe=function(e,t){Ce[e]=t},ke={},Ne={};function Ie(e){return new Function("d","return {"+e.map((function(e,t){return JSON.stringify(e)+": d["+t+'] || ""'})).join(",")+"}")}function Pe(e){var t=Object.create(null),n=[];return e.forEach((function(e){for(var r in e)r in t||n.push(t[r]=r)})),n}function De(e,t){var n=e+"",r=n.length;return r<t?new Array(t-r+1).join(0)+n:n}function Fe(e){var t=e.getUTCHours(),n=e.getUTCMinutes(),r=e.getUTCSeconds(),i=e.getUTCMilliseconds();return isNaN(e)?"Invalid Date":function(e){return e<0?"-"+De(-e,6):e>9999?"+"+De(e,6):De(e,4)}(e.getUTCFullYear())+"-"+De(e.getUTCMonth()+1,2)+"-"+De(e.getUTCDate(),2)+(i?"T"+De(t,2)+":"+De(n,2)+":"+De(r,2)+"."+De(i,3)+"Z":r?"T"+De(t,2)+":"+De(n,2)+":"+De(r,2)+"Z":n||t?"T"+De(t,2)+":"+De(n,2)+"Z":"")}var Be=function(e){var t=new RegExp('["'+e+"\n\r]"),n=e.charCodeAt(0);function r(e,t){var r,i=[],o=e.length,a=0,s=0,u=o<=0,c=!1;function l(){if(u)return Ne;if(c)return c=!1,ke;var t,r,i=a;if(34===e.charCodeAt(i)){for(;a++<o&&34!==e.charCodeAt(a)||34===e.charCodeAt(++a););return(t=a)>=o?u=!0:10===(r=e.charCodeAt(a++))?c=!0:13===r&&(c=!0,10===e.charCodeAt(a)&&++a),e.slice(i+1,t-1).replace(/""/g,'"')}for(;a<o;){if(10===(r=e.charCodeAt(t=a++)))c=!0;else if(13===r)c=!0,10===e.charCodeAt(a)&&++a;else if(r!==n)continue;return e.slice(i,t)}return u=!0,e.slice(i,o)}for(10===e.charCodeAt(o-1)&&--o,13===e.charCodeAt(o-1)&&--o;(r=l())!==Ne;){for(var f=[];r!==ke&&r!==Ne;)f.push(r),r=l();t&&null==(f=t(f,s++))||i.push(f)}return i}function i(t,n){return t.map((function(t){return n.map((function(e){return a(t[e])})).join(e)}))}function o(t){return t.map(a).join(e)}function a(e){return null==e?"":e instanceof Date?Fe(e):t.test(e+="")?'"'+e.replace(/"/g,'""')+'"':e}return{parse:function(e,t){var n,i,o=r(e,(function(e,r){if(n)return n(e,r-1);i=e,n=t?function(e,t){var n=Ie(e);return function(r,i){return t(n(r),i,e)}}(e,t):Ie(e)}));return o.columns=i||[],o},parseRows:r,format:function(t,n){return null==n&&(n=Pe(t)),[n.map(a).join(e)].concat(i(t,n)).join("\n")},formatBody:function(e,t){return null==t&&(t=Pe(e)),i(e,t).join("\n")},formatRows:function(e){return e.map(o).join("\n")},formatRow:o,formatValue:a}}(","),Ue=Be.parse;function Ge(e,t,n){void 0===n&&(n={});var r={type:"Feature"};return(0===n.id||n.id)&&(r.id=n.id),n.bbox&&(r.bbox=n.bbox),r.properties=t||{},r.geometry=e,r}function ze(e,t,n){void 0===n&&(n={});for(var r=0,i=e;r<i.length;r++){var o=i[r];if(o.length<4)throw new Error("Each LinearRing of a Polygon must have 4 or more Positions.");for(var a=0;a<o[o.length-1].length;a++)if(o[o.length-1][a]!==o[0][a])throw new Error("First and last Position are not equivalent.")}return Ge({type:"Polygon",coordinates:e},t,n)}function je(e,t,n){if(void 0===n&&(n={}),e.length<2)throw new Error("coordinates must be an array of two or more positions");return Ge({type:"LineString",coordinates:e},t,n)}function Ve(e){if(Array.isArray(e))return e;if("Feature"===e.type){if(null!==e.geometry)return e.geometry.coordinates}else if(e.coordinates)return e.coordinates;throw new Error("coords must be GeoJSON Feature, Geometry Object or an Array")}function He(e){return"Feature"===e.type?e.geometry:e}function Xe(e,t,n){if(null!==e)for(var r,i,o,a,s,u,c,l,f=0,h=0,d=e.type,p="FeatureCollection"===d,v="Feature"===d,m=p?e.features.length:1,g=0;g<m;g++){s=(l=!!(c=p?e.features[g].geometry:v?e.geometry:e)&&"GeometryCollection"===c.type)?c.geometries.length:1;for(var _=0;_<s;_++){var y=0,E=0;if(null!==(a=l?c.geometries[_]:c)){u=a.coordinates;var b=a.type;switch(f=!n||"Polygon"!==b&&"MultiPolygon"!==b?0:1,b){case null:break;case"Point":if(!1===t(u,h,g,y,E))return!1;h++,y++;break;case"LineString":case"MultiPoint":for(r=0;r<u.length;r++){if(!1===t(u[r],h,g,y,E))return!1;h++,"MultiPoint"===b&&y++}"LineString"===b&&y++;break;case"Polygon":case"MultiLineString":for(r=0;r<u.length;r++){for(i=0;i<u[r].length-f;i++){if(!1===t(u[r][i],h,g,y,E))return!1;h++}"MultiLineString"===b&&y++,"Polygon"===b&&E++}"Polygon"===b&&y++;break;case"MultiPolygon":for(r=0;r<u.length;r++){for(E=0,i=0;i<u[r].length;i++){for(o=0;o<u[r][i].length-f;o++){if(!1===t(u[r][i][o],h,g,y,E))return!1;h++}E++}y++}break;case"GeometryCollection":for(r=0;r<a.geometries.length;r++)if(!1===Xe(a.geometries[r],t,n))return!1;break;default:throw new Error("Unknown Geometry Type")}}}}}function We(e,t){!function(e,t){var n,r,i,o,a,s,u,c,l,f,h=0,d="FeatureCollection"===e.type,p="Feature"===e.type,v=d?e.features.length:1;for(n=0;n<v;n++){for(s=d?e.features[n].geometry:p?e.geometry:e,c=d?e.features[n].properties:p?e.properties:{},l=d?e.features[n].bbox:p?e.bbox:void 0,f=d?e.features[n].id:p?e.id:void 0,a=(u=!!s&&"GeometryCollection"===s.type)?s.geometries.length:1,i=0;i<a;i++)if(null!==(o=u?s.geometries[i]:s))switch(o.type){case"Point":case"LineString":case"MultiPoint":case"Polygon":case"MultiLineString":case"MultiPolygon":if(!1===t(o,h,c,l,f))return!1;break;case"GeometryCollection":for(r=0;r<o.geometries.length;r++)if(!1===t(o.geometries[r],h,c,l,f))return!1;break;default:throw new Error("Unknown Geometry Type")}else if(!1===t(null,h,c,l,f))return!1;h++}}(e,(function(e,n,r,i,o){var a,s=null===e?null:e.type;switch(s){case null:case"Point":case"LineString":case"Polygon":return!1!==t(Ge(e,r,{bbox:i,id:o}),n,0)&&void 0}switch(s){case"MultiPoint":a="Point";break;case"MultiLineString":a="LineString";break;case"MultiPolygon":a="Polygon"}for(var u=0;u<e.coordinates.length;u++){var c=e.coordinates[u];if(!1===t(Ge({type:a,coordinates:c},r),n,u))return!1}}))}var Ye={REGISTERED_PROTOCOLS:{}},Ze=Object.defineProperty,qe=Object.defineProperties,Ke=Object.getOwnPropertyDescriptors,Qe=Object.getOwnPropertySymbols,$e=Object.prototype.hasOwnProperty,Je=Object.prototype.propertyIsEnumerable,et=function(e,t,n){return t in e?Ze(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n},tt=function(e,t){for(var n in t||(t={}))$e.call(t,n)&&et(e,n,t[n]);if(Qe){var r,i=y(Qe(t));try{for(i.s();!(r=i.n()).done;){n=r.value;Je.call(t,n)&&et(e,n,t[n])}}catch(o){i.e(o)}finally{i.f()}}return e},nt=function(e,t){return qe(e,Ke(t))},rt=function(e){return Ye.REGISTERED_PROTOCOLS[e.substring(0,e.indexOf("://"))]},it=function(e){function t(e,n,r,i){var o;return f(this,t),(o=h(this,t,["AJAXError: ".concat(n," (").concat(e,"): ").concat(r)])).status=e,o.statusText=n,o.url=r,o.body=i,o}return d(t,e),c(t)}(p(Error));function ot(e,t){var n=new XMLHttpRequest,r=Array.isArray(e.url)?e.url[0]:e.url;for(var i in n.open(e.method||"GET",r,!0),"arrayBuffer"===e.type&&(n.responseType="arraybuffer"),e.headers)e.headers.hasOwnProperty(i)&&n.setRequestHeader(i,e.headers[i]);return"json"===e.type&&(n.responseType="text",n.setRequestHeader("Accept","application/json")),n.withCredentials="include"===e.credentials,n.onerror=function(){t(new Error(n.statusText))},n.onload=function(){if((n.status>=200&&n.status<300||0===n.status)&&null!==n.response){var i=n.response;if("json"===e.type)try{i=JSON.parse(n.response)}catch(a){return t(a)}t(null,i,n.getResponseHeader("Cache-Control"),n.getResponseHeader("Expires"),n)}else{var o=new Blob([n.response],{type:n.getResponseHeader("Content-Type")});t(new it(n.status,n.statusText,r.toString(),o))}},n.cancel=n.abort,n.send(e.body),n}function at(e){return new Promise((function(t,n){ot(e,(function(e,r,i,o,a){e?n({err:e,data:null,xhr:a}):t({err:null,data:r,cacheControl:i,expires:o,xhr:a})}))}))}function st(e,t){return ot(e,t)}var ut=function(e,t){return(rt(e.url)||st)(nt(tt({},e),{type:"arrayBuffer"}),t)},ct=function(e,t){return st(nt(tt({},e),{method:"GET"}),t)},lt="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVQYV2NgAAIAAAUAAarVyFEAAAAASUVORK5CYII=";function ft(e,t){var n=new window.Image,r=window.URL||window.webkitURL;n.crossOrigin="anonymous",n.onload=function(){t(null,n),r.revokeObjectURL(n.src),n.onload=null,window.requestAnimationFrame((function(){n.src=lt}))},n.onerror=function(){return t(new Error("Could not load image. Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported."))};var i=new Blob([new Uint8Array(e)],{type:"image/png"});n.src=e.byteLength?r.createObjectURL(i):lt}function ht(e,t){var n=new Blob([new Uint8Array(e)],{type:"image/png"});createImageBitmap(n).then((function(e){t(null,e)})).catch((function(e){t(new Error("Could not load image because of ".concat(e.message,". Please make sure to use a supported image type such as PNG or JPEG. Note that SVGs are not supported.")))}))}var dt=function(e,t,n){var r=function(e,r){if(e)t(e);else if(r){var i="function"==typeof createImageBitmap,o=n?n(r):r;i?ht(o,t):ft(o,t)}};return"json"===e.type?function(e,t){return(rt(e.url)||st)(nt(tt({},e),{type:"json"}),t)}(e,r):ut(e,r)};function pt(e,t,n){e.prototype=t.prototype=n,n.constructor=e}function vt(e,t){var n=Object.create(e.prototype);for(var r in t)n[r]=t[r];return n}function mt(){}var gt=.7,_t=1/gt,yt="\\s*([+-]?\\d+)\\s*",Et="\\s*([+-]?\\d*\\.?\\d+(?:[eE][+-]?\\d+)?)\\s*",bt="\\s*([+-]?\\d*\\.?\\d+(?:[eE][+-]?\\d+)?)%\\s*",At=/^#([0-9a-f]{3,8})$/,xt=new RegExp("^rgb\\("+[yt,yt,yt]+"\\)$"),St=new RegExp("^rgb\\("+[bt,bt,bt]+"\\)$"),Tt=new RegExp("^rgba\\("+[yt,yt,yt,Et]+"\\)$"),Rt=new RegExp("^rgba\\("+[bt,bt,bt,Et]+"\\)$"),Ct=new RegExp("^hsl\\("+[Et,bt,bt]+"\\)$"),Mt=new RegExp("^hsla\\("+[Et,bt,bt,Et]+"\\)$"),wt={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,rebeccapurple:6697881,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};function Lt(){return this.rgb().formatHex()}function Ot(){return this.rgb().formatRgb()}function kt(e){var t,n;return e=(e+"").trim().toLowerCase(),(t=At.exec(e))?(n=t[1].length,t=parseInt(t[1],16),6===n?Nt(t):3===n?new Dt(t>>8&15|t>>4&240,t>>4&15|240&t,(15&t)<<4|15&t,1):8===n?It(t>>24&255,t>>16&255,t>>8&255,(255&t)/255):4===n?It(t>>12&15|t>>8&240,t>>8&15|t>>4&240,t>>4&15|240&t,((15&t)<<4|15&t)/255):null):(t=xt.exec(e))?new Dt(t[1],t[2],t[3],1):(t=St.exec(e))?new Dt(255*t[1]/100,255*t[2]/100,255*t[3]/100,1):(t=Tt.exec(e))?It(t[1],t[2],t[3],t[4]):(t=Rt.exec(e))?It(255*t[1]/100,255*t[2]/100,255*t[3]/100,t[4]):(t=Ct.exec(e))?Gt(t[1],t[2]/100,t[3]/100,1):(t=Mt.exec(e))?Gt(t[1],t[2]/100,t[3]/100,t[4]):wt.hasOwnProperty(e)?Nt(wt[e]):"transparent"===e?new Dt(NaN,NaN,NaN,0):null}function Nt(e){return new Dt(e>>16&255,e>>8&255,255&e,1)}function It(e,t,n,r){return r<=0&&(e=t=n=NaN),new Dt(e,t,n,r)}function Pt(e,t,n,r){return 1===arguments.length?((i=e)instanceof mt||(i=kt(i)),i?new Dt((i=i.rgb()).r,i.g,i.b,i.opacity):new Dt):new Dt(e,t,n,null==r?1:r);var i}function Dt(e,t,n,r){this.r=+e,this.g=+t,this.b=+n,this.opacity=+r}function Ft(){return"#"+Ut(this.r)+Ut(this.g)+Ut(this.b)}function Bt(){var e=this.opacity;return(1===(e=isNaN(e)?1:Math.max(0,Math.min(1,e)))?"rgb(":"rgba(")+Math.max(0,Math.min(255,Math.round(this.r)||0))+", "+Math.max(0,Math.min(255,Math.round(this.g)||0))+", "+Math.max(0,Math.min(255,Math.round(this.b)||0))+(1===e?")":", "+e+")")}function Ut(e){return((e=Math.max(0,Math.min(255,Math.round(e)||0)))<16?"0":"")+e.toString(16)}function Gt(e,t,n,r){return r<=0?e=t=n=NaN:n<=0||n>=1?e=t=NaN:t<=0&&(e=NaN),new jt(e,t,n,r)}function zt(e){if(e instanceof jt)return new jt(e.h,e.s,e.l,e.opacity);if(e instanceof mt||(e=kt(e)),!e)return new jt;if(e instanceof jt)return e;var t=(e=e.rgb()).r/255,n=e.g/255,r=e.b/255,i=Math.min(t,n,r),o=Math.max(t,n,r),a=NaN,s=o-i,u=(o+i)/2;return s?(a=t===o?(n-r)/s+6*(n<r):n===o?(r-t)/s+2:(t-n)/s+4,s/=u<.5?o+i:2-o-i,a*=60):s=u>0&&u<1?0:a,new jt(a,s,u,e.opacity)}function jt(e,t,n,r){this.h=+e,this.s=+t,this.l=+n,this.opacity=+r}function Vt(e,t,n){return 255*(e<60?t+(n-t)*e/60:e<180?n:e<240?t+(n-t)*(240-e)/60:t)}function Ht(e){var t=kt(e),n=[0,0,0,0];return null!=t&&(n[0]=t.r/255,n[1]=t.g/255,n[2]=t.b/255,n[3]=t.opacity),n}function Xt(e){return(e&&e[0])+256*(e&&e[1])+65536*(e&&e[2])-1}function Wt(e){return[e+1&255,e+1>>8&255,e+1>>8>>8&255]}function Yt(e,t){for(var n=e.createImageData(256,1),r=0;r<n.data.length;r+=4)n.data[r+0]=t[r+0],n.data[r+1]=t[r+1],n.data[r+2]=t[r+2],n.data[r+3]=t[r+3];return n}function Zt(e){return"cat"===(null==e?void 0:e.type)?[0,255]:[0,1]}pt(mt,kt,{copy:function(e){return Object.assign(new this.constructor,this,e)},displayable:function(){return this.rgb().displayable()},hex:Lt,formatHex:Lt,formatHsl:function(){return zt(this).formatHsl()},formatRgb:Ot,toString:Ot}),pt(Dt,Pt,vt(mt,{brighter:function(e){return e=null==e?_t:Math.pow(_t,e),new Dt(this.r*e,this.g*e,this.b*e,this.opacity)},darker:function(e){return e=null==e?gt:Math.pow(gt,e),new Dt(this.r*e,this.g*e,this.b*e,this.opacity)},rgb:function(){return this},displayable:function(){return-.5<=this.r&&this.r<255.5&&-.5<=this.g&&this.g<255.5&&-.5<=this.b&&this.b<255.5&&0<=this.opacity&&this.opacity<=1},hex:Ft,formatHex:Ft,formatRgb:Bt,toString:Bt})),pt(jt,(function(e,t,n,r){return 1===arguments.length?zt(e):new jt(e,t,n,null==r?1:r)}),vt(mt,{brighter:function(e){return e=null==e?_t:Math.pow(_t,e),new jt(this.h,this.s,this.l*e,this.opacity)},darker:function(e){return e=null==e?gt:Math.pow(gt,e),new jt(this.h,this.s,this.l*e,this.opacity)},rgb:function(){var e=this.h%360+360*(this.h<0),t=isNaN(e)||isNaN(this.s)?0:this.s,n=this.l,r=n+(n<.5?n:1-n)*t,i=2*n-r;return new Dt(Vt(e>=240?e-240:e+120,i,r),Vt(e,i,r),Vt(e<120?e+240:e-120,i,r),this.opacity)},displayable:function(){return(0<=this.s&&this.s<=1||isNaN(this.s))&&0<=this.l&&this.l<=1&&0<=this.opacity&&this.opacity<=1},formatHsl:function(){var e=this.opacity;return(1===(e=isNaN(e)?1:Math.max(0,Math.min(1,e)))?"hsl(":"hsla(")+(this.h||0)+", "+100*(this.s||0)+"%, "+100*(this.l||0)+"%"+(1===e?")":", "+e+")")}}));var qt=1029,Kt=1028;function Qt(e){switch(e){case"GAODE1.x":case"GAODE2.x":case"GLOBEL":return qt;default:return Kt}}var $t=function(e,t,n){return e==e&&(void 0!==n&&(e=e<=n?e:n),void 0!==t&&(e=e>=t?e:t)),e},Jt=$t,en=l;var tn=function(e,t,n){return void 0===n&&(n=t,t=void 0),void 0!==n&&(n=(n=en(n))==n?n:0),void 0!==t&&(t=(t=en(t))==t?t:0),Jt(en(e),t,n)},nn=m,rn=g,on=function(){return nn.Date.now()},an=l,sn=Math.max,un=Math.min;var cn=function(e,t,n){var r,i,o,a,s,u,c=0,l=!1,f=!1,h=!0;if("function"!=typeof e)throw new TypeError("Expected a function");function d(t){var n=r,o=i;return r=i=void 0,c=t,a=e.apply(o,n)}function p(e){var n=e-u;return void 0===u||n>=t||n<0||f&&e-c>=o}function v(){var e=on();if(p(e))return m(e);s=setTimeout(v,function(e){var n=t-(e-u);return f?un(n,o-(e-c)):n}(e))}function m(e){return s=void 0,h&&r?d(e):(r=i=void 0,a)}function g(){var e=on(),n=p(e);if(r=arguments,i=this,u=e,n){if(void 0===s)return function(e){return c=e,s=setTimeout(v,t),l?d(e):a}(u);if(f)return clearTimeout(s),s=setTimeout(v,t),d(u)}return void 0===s&&(s=setTimeout(v,t)),a}return t=an(t)||0,rn(n)&&(l=!!n.leading,o=(f="maxWait"in n)?sn(an(n.maxWait)||0,t):o,h="trailing"in n?!!n.trailing:h),g.cancel=function(){void 0!==s&&clearTimeout(s),c=0,r=u=i=s=void 0},g.flush=function(){return void 0===s?a:m(on())},g},ln=E,fn=b,hn=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,dn=/^\w*$/;var pn=function(e,t){if(ln(e))return!1;var n=s(e);return!("number"!=n&&"symbol"!=n&&"boolean"!=n&&null!=e&&!fn(e))||(dn.test(e)||!hn.test(e)||null!=t&&e in Object(t))},vn=A;var mn=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,gn=/\\(\\)?/g,_n=function(e){var t=vn(e,(function(e){return 500===n.size&&n.clear(),e})),n=t.cache;return t}((function(e){var t=[];return 46===e.charCodeAt(0)&&t.push(""),e.replace(mn,(function(e,n,r,i){t.push(r?i.replace(gn,"$1"):n||e)})),t})),yn=E,En=pn,bn=_n,An=x;var xn=function(e,t){return yn(e)?e:En(e,t)?[e]:bn(An(e))},Sn=b;var Tn=xn,Rn=function(e){if("string"==typeof e||Sn(e))return e;var t=e+"";return"0"==t&&1/e==-1/0?"-0":t};var Cn=function(e,t){for(var n=0,r=(t=Tn(t,e)).length;null!=e&&n<r;)e=e[Rn(t[n++])];return n&&n==r?e:void 0},Mn=Cn;var wn=function(e,t,n){var r=null==e?void 0:Mn(e,t);return void 0===r?n:r},Ln=S,On=T;var kn=function(e){return!0===e||!1===e||On(e)&&"[object Boolean]"==Ln(e)};var Nn=function(e,t){for(var n=-1,r=null==e?0:e.length;++n<r;)if(t(e[n],n,e))return!0;return!1},In=R,Pn=Nn,Dn=C;var Fn=function(e,t,n,r,i,o){var a=1&n,s=e.length,u=t.length;if(s!=u&&!(a&&u>s))return!1;var c=o.get(e),l=o.get(t);if(c&&l)return c==t&&l==e;var f=-1,h=!0,d=2&n?new In:void 0;for(o.set(e,t),o.set(t,e);++f<s;){var p=e[f],v=t[f];if(r)var m=a?r(v,p,f,t,e,o):r(p,v,f,e,t,o);if(void 0!==m){if(m)continue;h=!1;break}if(d){if(!Pn(t,(function(e,t){if(!Dn(d,t)&&(p===e||i(p,e,n,r,o)))return d.push(t)}))){h=!1;break}}else if(p!==v&&!i(p,v,n,r,o)){h=!1;break}}return o.delete(e),o.delete(t),h};var Bn=function(e){var t=-1,n=Array(e.size);return e.forEach((function(e,r){n[++t]=[r,e]})),n};var Un=function(e){var t=-1,n=Array(e.size);return e.forEach((function(e){n[++t]=e})),n},Gn=w,zn=L,jn=Fn,Vn=Bn,Hn=Un,Xn=M?M.prototype:void 0,Wn=Xn?Xn.valueOf:void 0;var Yn=function(e,t,n,r,i,o,a){switch(n){case"[object DataView]":if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case"[object ArrayBuffer]":return!(e.byteLength!=t.byteLength||!o(new Gn(e),new Gn(t)));case"[object Boolean]":case"[object Date]":case"[object Number]":return zn(+e,+t);case"[object Error]":return e.name==t.name&&e.message==t.message;case"[object RegExp]":case"[object String]":return e==t+"";case"[object Map]":var s=Vn;case"[object Set]":var u=1&r;if(s||(s=Hn),e.size!=t.size&&!u)return!1;var c=a.get(e);if(c)return c==t;r|=2,a.set(e,t);var l=jn(s(e),s(t),r,i,o,a);return a.delete(e),l;case"[object Symbol]":if(Wn)return Wn.call(e)==Wn.call(t)}return!1},Zn=O,qn=Object.prototype.hasOwnProperty;var Kn=function(e,t,n,r,i,o){var a=1&n,s=Zn(e),u=s.length;if(u!=Zn(t).length&&!a)return!1;for(var c=u;c--;){var l=s[c];if(!(a?l in t:qn.call(t,l)))return!1}var f=o.get(e),h=o.get(t);if(f&&h)return f==t&&h==e;var d=!0;o.set(e,t),o.set(t,e);for(var p=a;++c<u;){var v=e[l=s[c]],m=t[l];if(r)var g=a?r(m,v,l,t,e,o):r(v,m,l,e,t,o);if(!(void 0===g?v===m||i(v,m,n,r,o):g)){d=!1;break}p||(p="constructor"==l)}if(d&&!p){var _=e.constructor,y=t.constructor;_==y||!("constructor"in e)||!("constructor"in t)||"function"==typeof _&&_ instanceof _&&"function"==typeof y&&y instanceof y||(d=!1)}return o.delete(e),o.delete(t),d},Qn=k,$n=Fn,Jn=Yn,er=Kn,tr=N,nr=E,rr=I.exports,ir=P,or="[object Arguments]",ar="[object Array]",sr="[object Object]",ur=Object.prototype.hasOwnProperty;var cr=function(e,t,n,r,i,o){var a=nr(e),s=nr(t),u=a?ar:tr(e),c=s?ar:tr(t),l=(u=u==or?sr:u)==sr,f=(c=c==or?sr:c)==sr,h=u==c;if(h&&rr(e)){if(!rr(t))return!1;a=!0,l=!1}if(h&&!l)return o||(o=new Qn),a||ir(e)?$n(e,t,n,r,i,o):Jn(e,t,u,n,r,i,o);if(!(1&n)){var d=l&&ur.call(e,"__wrapped__"),p=f&&ur.call(t,"__wrapped__");if(d||p){var v=d?e.value():e,m=p?t.value():t;return o||(o=new Qn),i(v,m,n,r,o)}}return!!h&&(o||(o=new Qn),er(e,t,n,r,i,o))},lr=cr,fr=T;var hr=function e(t,n,r,i,o){return t===n||(null==t||null==n||!fr(t)&&!fr(n)?t!=t&&n!=n:lr(t,n,r,i,e,o))},dr=hr;var pr=function(e,t){return dr(e,t)};var vr=function(e){return null==e},mr=S,gr=T;var _r=function(e){return"number"==typeof e||gr(e)&&"[object Number]"==mr(e)},yr=S,Er=E,br=T;var Ar=function(e){return"string"==typeof e||!Er(e)&&br(e)&&"[object String]"==yr(e)},xr=F,Sr=D((function(e,t,n){xr(e,t,n)})),Tr=Sr;var Rr=function(e,t,n,r){for(var i=n-1,o=e.length;++i<o;)if(r(e[i],t))return i;return-1},Cr=B,Mr=G,wr=Rr,Lr=z,Or=U,kr=Array.prototype.splice;var Nr=function(e,t,n,r){var i=r?wr:Mr,o=-1,a=t.length,s=e;for(e===t&&(t=Or(t)),n&&(s=Cr(e,Lr(n)));++o<a;)for(var u=0,c=t[o],l=n?n(c):c;(u=i(s,l,u,r))>-1;)s!==e&&kr.call(s,u,1),kr.call(e,u,1);return e},Ir=Nr;var Pr=function(e,t){return e&&e.length&&t&&t.length?Ir(e,t):e},Dr=j(Pr),Fr=cn,Br=g;var Ur=function(e,t,n){var r=!0,i=!0;if("function"!=typeof e)throw new TypeError("Expected a function");return Br(n)&&(r="leading"in n?!!n.leading:r,i="trailing"in n?!!n.trailing:i),Fr(e,t,{leading:r,maxWait:t,trailing:i})},Gr=V,zr=H,jr=Gr&&1/Un(new Gr([,-0]))[1]==1/0?function(e){return new Gr(e)}:zr,Vr=R,Hr=X,Xr=W,Wr=C,Yr=jr,Zr=Un;var qr=function(e,t,n){var r=-1,i=Hr,o=e.length,a=!0,s=[],u=s;if(n)a=!1,i=Xr;else if(o>=200){var c=t?null:Yr(e);if(c)return Zr(c);a=!1,i=Wr,u=new Vr}else u=t?[]:s;e:for(;++r<o;){var l=e[r],f=t?t(l):l;if(l=n||0!==l?l:0,a&&f==f){for(var h=u.length;h--;)if(u[h]===f)continue e;t&&u.push(f),s.push(l)}else i(u,f,n)||(u!==s&&u.push(f),s.push(l))}return s},Kr=qr;var Qr=function(e){return e&&e.length?Kr(e):[]};var $r=function(e,t,n){var r=-1,i=e.length;t<0&&(t=-t>i?0:i+t),(n=n>i?i:n)<0&&(n+=i),i=t>n?0:n-t>>>0,t>>>=0;for(var o=Array(i);++r<i;)o[r]=e[r+t];return o},Jr=$r;var ei=function(e,t,n){var r=e.length;return n=void 0===n?r:n,!t&&n>=r?e:Jr(e,t,n)},ti=RegExp("[\\u200d\\ud800-\\udfff\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff\\ufe0e\\ufe0f]");var ni=function(e){return ti.test(e)};var ri=function(e){return e.split("")},ii="\\ud800-\\udfff",oi="["+ii+"]",ai="[\\u0300-\\u036f\\ufe20-\\ufe2f\\u20d0-\\u20ff]",si="\\ud83c[\\udffb-\\udfff]",ui="[^"+ii+"]",ci="(?:\\ud83c[\\udde6-\\uddff]){2}",li="[\\ud800-\\udbff][\\udc00-\\udfff]",fi="(?:"+ai+"|"+si+")"+"?",hi="[\\ufe0e\\ufe0f]?",di=hi+fi+("(?:\\u200d(?:"+[ui,ci,li].join("|")+")"+hi+fi+")*"),pi="(?:"+[ui+ai+"?",ai,ci,li,oi].join("|")+")",vi=RegExp(si+"(?="+si+")|"+pi+di,"g");var mi=function(e){return e.match(vi)||[]},gi=ri,_i=ni,yi=mi;var Ei=function(e){return _i(e)?yi(e):gi(e)},bi=ei,Ai=ni,xi=Ei,Si=x;var Ti=function(e){return function(t){t=Si(t);var n=Ai(t)?xi(t):void 0,r=n?n[0]:t.charAt(0),i=n?bi(n,1).join(""):t.slice(1);return r[e]()+i}},Ri=Ti("toUpperCase");var Ci=function(e){return void 0===e},Mi=x,wi=Ri;var Li=function(e){return wi(Mi(e).toLowerCase())},Oi=Li,ki=Y((function(e,t,n){return t=t.toLowerCase(),e+(n?Oi(t):t)})),Ni={isNil:vr,merge:Tr,throttle:Ur,isString:Ar,debounce:cn,pull:Dr,isTypedArray:P,isPlainObject:Z,isNumber:_r,isBoolean:kn,isEqual:pr,cloneDeep:q,uniq:Qr,clamp:tn,upperFirst:Ri,get:wn,mergeWith:K,isFunction:Q,isObject:g,isUndefined:Ci,camelCase:ki};function Ii(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}function Pi(e){return Ii(e).split(/\s+/)}function Di(e,t,n){var r=window.document.createElement(e);return t&&(r.className=t||""),n&&n.appendChild(r),r}function Fi(e){var t=e.parentNode;t&&t.removeChild(e)}function Bi(e,t){if(void 0!==e.classList)for(var n=Pi(t),r=0,i=n.length;r<i;r++)e.classList.add(n[r]);else if(!function(e,t){if(void 0!==e.classList)return e.classList.contains(t);var n=zi(e);return n.length>0&&new RegExp("(^|\\s)"+t+"(\\s|$)").test(n)}(e,t)){var o=zi(e);Gi(e,(o?o+" ":"")+t)}}function Ui(e,t){void 0!==e.classList?Pi(t).forEach((function(t){e.classList.remove(t)})):Gi(e,Ii((" "+zi(e)+" ").replace(" "+t+" "," ")))}function Gi(e,t){e instanceof HTMLElement?e.className=t:e.className.baseVal=t}function zi(e){return e instanceof SVGElement&&(e=e.correspondingElement),void 0===e.className.baseVal?e.className:e.className.baseVal}!function(e){var t,n=null==(t=null==document?void 0:document.documentElement)?void 0:t.style;if(!n)return e[0];for(var r in e)if(e[r]&&e[r]in n)return e[r];e[0]}(["transform","WebkitTransform"]);var ji=function(){var e,t=window.document.querySelector('meta[name="viewport"]');if(!t)return 1;var n=(null==(e=t.content)?void 0:e.split(",")).find((function(e){return"initial-scale"===a(e.split("="),1)[0]}));return n?1*n.split("=")[1]:1}()<1?1:window.devicePixelRatio;function Vi(e){e.innerHTML=""}var Hi=null==navigator?void 0:navigator.userAgent;function Xi(e){var t=[1/0,1/0,-1/0,-1/0];return Xe(e,(function(e){t[0]>e[0]&&(t[0]=e[0]),t[1]>e[1]&&(t[1]=e[1]),t[2]<e[0]&&(t[2]=e[0]),t[3]<e[1]&&(t[3]=e[1])})),t}function Wi(e){return"number"==typeof e}Hi.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/),Hi.indexOf("Android")>-1||Hi.indexOf("Adr"),Xi.default=Xi;var Yi=2*Math.PI*6378137/2;function Zi(e){var t=[1/0,1/0,-1/0,-1/0];return e.forEach((function(e){var n=e.coordinates;qi(t,n)})),t}function qi(e,t){return Array.isArray(t[0])?t.forEach((function(t){qi(e,t)})):(e[0]>t[0]&&(e[0]=t[0]),e[1]>t[1]&&(e[1]=t[1]),e[2]<t[0]&&(e[2]=t[0]),e[3]<t[1]&&(e[3]=t[1])),e}function Ki(e){var t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{enable:!0,decimal:1};e=function(e,t){if(!1===t)return e;var n=function(e){if(null==e)throw new Error("lng is required");(e>180||e<-180)&&((e%=360)>180&&(e=-360+e),e<-180&&(e=360+e),0===e&&(e=0));return e}(e[0]),r=function(e){if(null==e)throw new Error("lat is required");(e>90||e<-90)&&((e%=180)>90&&(e=-180+e),e<-90&&(e=180+e),0===e&&(e=0));return e}(e[1]);r>85&&(r=85);r<-85&&(r=-85);return 3===e.length?[n,r,e[2]]:[n,r]}(e,!(arguments.length>1&&void 0!==arguments[1])||arguments[1]);var n=e[0],r=e[1],i=n*Yi/180,o=Math.log(Math.tan((90+r)*Math.PI/360))/(Math.PI/180);return o=o*Yi/180,t.enable&&(i=Number(i.toFixed(t.decimal)),o=Number(o.toFixed(t.decimal))),3===e.length?[i,o,e[2]]:[i,o]}function Qi(e){var t=85.0511287798,n=Math.max(Math.min(t,e[1]),-t),r=256<<20,i=Math.PI/180,o=e[0]*i,a=n*i;a=Math.log(Math.tan(Math.PI/4+a/2));return o=r*(.5/Math.PI*o+.5),a=r*(-.5/Math.PI*a+(i=.5)),[Math.floor(o),Math.floor(a)]}function $i(e,t){var n=85.0511287798,r=Math.PI/180,i=6378137;return t=Math.max(Math.min(n,t),-n),t*=r,[(e*=r)*i,(t=Math.log(Math.tan(Math.PI/4+t/2)))*i]}function Ji(e,t){var n=Math.abs(e[1][1]-e[0][1])*t,r=Math.abs(e[1][0]-e[0][0])*t;return[[e[0][0]-r,e[0][1]-n],[e[1][0]+r,e[1][1]+n]]}function eo(e,t){return e[0][0]<=t[0][0]&&e[0][1]<=t[0][1]&&e[1][0]>=t[1][0]&&e[1][1]>=t[1][1]}function to(e){return[[e[0],e[1]],[e[2],e[3]]]}function no(e){var t,n,r=(t=e,n=[0,0],Math.sqrt(Math.pow(t[0]-n[0],2)+Math.pow(t[1]-n[1],2)));return[e[0]/r,e[1]/r]}function ro(e){if(Wi(e[0]))return e;if(Wi(e[0][0]))throw new Error("当前数据不支持标注");if(Wi(e[0][0][0])){var t=0,n=0,r=0;return e.forEach((function(e){e.forEach((function(e){t+=e[0],n+=e[1],r++}))})),[t/r,n/r,0]}throw new Error("当前数据不支持标注")}var io=function(e){return e["GAODE1.x"]="GAODE1.x",e["GAODE2.x"]="GAODE2.x",e.MAPBOX="MAPBOX",e.DEFAULT="DEFAUlTMAP",e.SIMPLE="SIMPLE",e.GLOBEL="GLOBEL",e}(io||{}),oo=function(){return c((function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:50,n=arguments.length>1?arguments[1]:void 0;f(this,e),this.limit=t,this.destroy=n||this.defaultDestroy,this.order=[],this.clear()}),[{key:"clear",value:function(){var e=this;this.order.forEach((function(t){e.delete(t)})),this.cache={},this.order=[]}},{key:"get",value:function(e){var t=this.cache[e];return t&&(this.deleteOrder(e),this.appendOrder(e)),t}},{key:"set",value:function(e,t){this.cache[e]?(this.delete(e),this.cache[e]=t,this.appendOrder(e)):(Object.keys(this.cache).length===this.limit&&this.delete(this.order[0]),this.cache[e]=t,this.appendOrder(e))}},{key:"delete",value:function(e){var t=this.cache[e];t&&(this.deleteCache(e),this.deleteOrder(e),this.destroy(t,e))}},{key:"deleteCache",value:function(e){delete this.cache[e]}},{key:"deleteOrder",value:function(e){var t=this.order.findIndex((function(t){return t===e}));t>=0&&this.order.splice(t,1)}},{key:"appendOrder",value:function(e){this.order.push(e)}},{key:"defaultDestroy",value:function(e,t){return null}}])}();function ao(e){if(0===e.length)return 0;for(var t=1*e[0],n=1;n<e.length;n++)t+=1*e[n];return t}var so={min:function(e){if(0===e.length)throw new Error("min requires at least one data point");for(var t=e[0],n=1;n<e.length;n++)e[n]<t&&(t=e[n]);return 1*t},max:function(e){if(0===e.length)throw new Error("max requires at least one data point");for(var t=e[0],n=1;n<e.length;n++)e[n]>t&&(t=e[n]);return 1*t},mean:function(e){if(0===e.length)throw new Error("mean requires at least one data point");return ao(e)/e.length},sum:ao,mode:function(e){if(0===e.length)throw new Error("mean requires at least one data point");if(e.length<3)return e[0];e.sort();for(var t=e[0],n=NaN,r=0,i=1,o=1;o<e.length+1;o++)e[o]!==t?(i>r&&(r=i,n=t),i=1,t=e[o]):i++;return 1*n}};function uo(e,t){return e.map((function(e){return e[t]}))}function co(e,t){void 0===t&&(t={});var n=Number(e[0]),r=Number(e[1]),i=Number(e[2]),o=Number(e[3]);if(6===e.length)throw new Error("@turf/bbox-polygon does not support BBox with 6 positions");var a=[n,r];return ze([[a,[i,r],[i,o],[n,o],a]],t.properties,{bbox:e,id:t.id})}var lo={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,n="~";function r(){}function i(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function o(e,t,r,o,a){if("function"!=typeof r)throw new TypeError("The listener must be a function");var s=new i(r,o||e,a),u=n?n+t:t;return e._events[u]?e._events[u].fn?e._events[u]=[e._events[u],s]:e._events[u].push(s):(e._events[u]=s,e._eventsCount++),e}function a(e,t){0==--e._eventsCount?e._events=new r:delete e._events[t]}function s(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(n=!1)),s.prototype.eventNames=function(){var e,r,i=[];if(0===this._eventsCount)return i;for(r in e=this._events)t.call(e,r)&&i.push(n?r.slice(1):r);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(e)):i},s.prototype.listeners=function(e){var t=n?n+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var i=0,o=r.length,a=new Array(o);i<o;i++)a[i]=r[i].fn;return a},s.prototype.listenerCount=function(e){var t=n?n+e:e,r=this._events[t];return r?r.fn?1:r.length:0},s.prototype.emit=function(e,t,r,i,o,a){var s=n?n+e:e;if(!this._events[s])return!1;var u,c,l=this._events[s],f=arguments.length;if(l.fn){switch(l.once&&this.removeListener(e,l.fn,void 0,!0),f){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,t),!0;case 3:return l.fn.call(l.context,t,r),!0;case 4:return l.fn.call(l.context,t,r,i),!0;case 5:return l.fn.call(l.context,t,r,i,o),!0;case 6:return l.fn.call(l.context,t,r,i,o,a),!0}for(c=1,u=new Array(f-1);c<f;c++)u[c-1]=arguments[c];l.fn.apply(l.context,u)}else{var h,d=l.length;for(c=0;c<d;c++)switch(l[c].once&&this.removeListener(e,l[c].fn,void 0,!0),f){case 1:l[c].fn.call(l[c].context);break;case 2:l[c].fn.call(l[c].context,t);break;case 3:l[c].fn.call(l[c].context,t,r);break;case 4:l[c].fn.call(l[c].context,t,r,i);break;default:if(!u)for(h=1,u=new Array(f-1);h<f;h++)u[h-1]=arguments[h];l[c].fn.apply(l[c].context,u)}}return!0},s.prototype.on=function(e,t,n){return o(this,e,t,n,!1)},s.prototype.once=function(e,t,n){return o(this,e,t,n,!0)},s.prototype.removeListener=function(e,t,r,i){var o=n?n+e:e;if(!this._events[o])return this;if(!t)return a(this,o),this;var s=this._events[o];if(s.fn)s.fn!==t||i&&!s.once||r&&s.context!==r||a(this,o);else{for(var u=0,c=[],l=s.length;u<l;u++)(s[u].fn!==t||i&&!s[u].once||r&&s[u].context!==r)&&c.push(s[u]);c.length?this._events[o]=1===c.length?c[0]:c:a(this,o)}return this},s.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&a(this,t)):(this._events=new r,this._eventsCount=0),this},s.prototype.off=s.prototype.removeListener,s.prototype.addListener=s.prototype.on,s.prefixed=n,s.EventEmitter=s,e.exports=s}(lo);var fo=lo.exports,ho=function(e){return e.Realtime="realtime",e.Overlap="overlap",e.Replace="replace",e}(ho||{}),po=function(e){return e.Loading="Loading",e.Loaded="Loaded",e.Failure="Failure",e.Cancelled="Cancelled",e}(po||{}),vo=2;function mo(e){for(;e;){if(e.isLoaded)return e.properties.state|=vo,!0;e=e.parent}return!1}function go(e){e.children.forEach((function(e){e.isLoaded?e.properties.state|=vo:go(e)}))}var _o=[-1/0,-1/0,1/0,1/0],yo=o(o(o({},ho.Realtime,(function(e){e.forEach((function(e){e.isCurrent&&(e.isVisible=e.isLoaded)}))})),ho.Overlap,(function(e){e.forEach((function(e){e.properties.state=0})),e.forEach((function(e){e.isCurrent&&!mo(e)&&go(e)})),e.forEach((function(e){e.isVisible=Boolean(e.properties.state&vo)}))})),ho.Replace,(function(e){e.forEach((function(e){e.properties.state=0})),e.forEach((function(e){e.isCurrent&&mo(e)}));var t=e.slice().sort((function(e,t){return e.z-t.z}));t.forEach((function(e){e.isVisible=Boolean(e.properties.state&vo),e.children.length&&(e.isVisible||1&e.properties.state)?e.children.forEach((function(e){e.properties.state=1})):e.isCurrent&&go(e)}))})),Eo=function(){};function bo(e,t,n){return[Math.floor((e+180)/360*Math.pow(2,n)),Math.floor((1-Math.log(Math.tan(t*Math.PI/180)+1/Math.cos(t*Math.PI/180))/Math.PI)/2*Math.pow(2,n))]}function Ao(e,t,n){var r=e/Math.pow(2,n)*360-180,i=Math.PI-2*Math.PI*t/Math.pow(2,n);return[r,180/Math.PI*Math.atan(.5*(Math.exp(i)-Math.exp(-i)))]}var xo=function(e,t,n){var r=a(Ao(e,t,n),2),i=r[0],o=r[1],s=a(Ao(e+1,t+1,n),2),u=s[0];return[i,s[1],u,o]};var So=function(e,t,n){var r=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],i=Math.pow(2,n),o=e;return r&&(o<0?o+=i:o>i-1&&(o%=i)),{warpX:o,warpY:t}},To=function(e){function t(e){var n;f(this,t),(n=h(this,t)).tileSize=256,n.isVisible=!1,n.isCurrent=!1,n.isVisibleChange=!1,n.loadedLayers=0,n.isLayerLoaded=!1,n.isLoad=!1,n.isChildLoad=!1,n.parent=null,n.children=[],n.data=null,n.properties={},n.loadDataId=0;var r=e.x,i=e.y,o=e.z,a=e.tileSize,s=e.warp,u=void 0===s||s;return n.x=r,n.y=i,n.z=o,n.warp=u||!0,n.tileSize=a,n}return d(t,e),c(t,[{key:"isLoading",get:function(){return this.loadStatus===po.Loading}},{key:"isLoaded",get:function(){return this.loadStatus===po.Loaded}},{key:"isFailure",get:function(){return this.loadStatus===po.Failure}},{key:"setTileLayerLoaded",value:function(){this.isLayerLoaded=!0}},{key:"isCancelled",get:function(){return this.loadStatus===po.Cancelled}},{key:"isDone",get:function(){return[po.Loaded,po.Cancelled,po.Failure].includes(this.loadStatus)}},{key:"bounds",get:function(){return xo(this.x,this.y,this.z)}},{key:"bboxPolygon",get:function(){var e=a(this.bounds,4),t=e[0],n=e[1],r=[(e[2]-t)/2,(e[3]-n)/2];return co(this.bounds,{properties:{key:this.key,id:this.key,bbox:this.bounds,center:r,meta:"\n      ".concat(this.key,"\n      ")}})}},{key:"key",get:function(){return"".concat(this.x,"_").concat(this.y,"_").concat(this.z)}},{key:"layerLoad",value:function(){this.loadedLayers++,this.emit("layerLoaded")}},{key:"loadData",value:function(e){return t=this,n=arguments,r=function(e){var t=this,n=e.getData,r=e.onLoad,o=e.onError;return i().mark((function e(){var a,s,u,c,l,f,h,d,p,v,m,g,_,y;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return t.loadDataId++,a=t.loadDataId,t.isLoading&&t.abortLoad(),t.abortController=new AbortController,t.loadStatus=po.Loading,s=null,e.prev=6,c=t.x,l=t.y,f=t.z,h=t.bounds,d=t.tileSize,p=t.warp,v=So(c,l,f,p),m=v.warpX,g=v.warpY,_=t.abortController.signal,y={x:m,y:g,z:f,bounds:h,tileSize:d,signal:_,warp:p},e.next=13,n(y,t);case 13:s=e.sent,e.next=19;break;case 16:e.prev=16,e.t0=e.catch(6),u=e.t0;case 19:if(a===t.loadDataId){e.next=21;break}return e.abrupt("return");case 21:if(!t.isCancelled||s){e.next=23;break}return e.abrupt("return");case 23:if(!u&&s){e.next=27;break}return t.loadStatus=po.Failure,o(u,t),e.abrupt("return");case 27:t.loadStatus=po.Loaded,t.data=s,r(t);case 30:case"end":return e.stop()}}),e,null,[[6,16]])}))()},new Promise((function(e,i){var o=function(e){try{s(r.next(e))}catch(t){i(t)}},a=function(e){try{s(r.throw(e))}catch(t){i(t)}},s=function(t){return t.done?e(t.value):Promise.resolve(t.value).then(o,a)};s((r=r.apply(t,n)).next())}));var t,n,r}},{key:"reloadData",value:function(e){this.isLoading&&this.abortLoad(),this.loadData(e)}},{key:"abortLoad",value:function(){this.isLoaded||this.isCancelled||(this.loadStatus=po.Cancelled,this.abortController.abort(),this.xhrCancel&&this.xhrCancel())}}])}(lo.exports.EventEmitter),Ro=Object.defineProperty,Co=Object.defineProperties,Mo=Object.getOwnPropertyDescriptors,wo=Object.getOwnPropertySymbols,Lo=Object.prototype.hasOwnProperty,Oo=Object.prototype.propertyIsEnumerable,ko=function(e,t,n){return t in e?Ro(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n},No=function(e,t){for(var n in t||(t={}))Lo.call(t,n)&&ko(e,n,t[n]);if(wo){var r,i=y(wo(t));try{for(i.s();!(r=i.n()).done;){n=r.value;Oo.call(t,n)&&ko(e,n,t[n])}}catch(o){i.e(o)}finally{i.f()}}return e},Io=Ni.throttle,Po=function(e){function t(e){var n;return f(this,t),(n=h(this,t)).currentTiles=[],n.cacheTiles=new Map,n.throttleUpdate=Io((function(e,t){n.update(e,t)}),16),n.onTileLoad=function(e){n.emit("tile-loaded",e),n.updateTileVisible(),n.loadFinished()},n.onTileError=function(e,t){n.emit("tile-error",{error:e,tile:t}),n.updateTileVisible(),n.loadFinished()},n.onTileUnload=function(e){n.emit("tile-unload",e),n.loadFinished()},n.options={tileSize:256,minZoom:0,maxZoom:1/0,zoomOffset:0,extent:_o,getTileData:Eo,warp:!0,updateStrategy:ho.Replace},n.updateOptions(e),n}return d(t,e),c(t,[{key:"isLoaded",get:function(){return this.currentTiles.every((function(e){return e.isDone}))}},{key:"tiles",get:function(){var e=Array.from(this.cacheTiles.values()).sort((function(e,t){return e.z-t.z}));return e}},{key:"updateOptions",value:function(e){var t,n=void 0===e.minZoom?this.options.minZoom:Math.ceil(e.minZoom),r=void 0===e.maxZoom?this.options.maxZoom:Math.floor(e.maxZoom);this.options=(t=No(No({},this.options),e),Co(t,Mo({minZoom:n,maxZoom:r})))}},{key:"update",value:function(e,t){var n=this,r=Math.max(0,Math.ceil(e));if(!this.lastViewStates||this.lastViewStates.zoom!==r||!function(e,t){return eo(to(e),to(t))}(this.lastViewStates.latLonBoundsBuffer,t)){var i=function(e,t){var n=Ji(to(e),t),r=85.0511287798065;return[Math.max(n[0][0],-900),Math.max(n[0][1],-r),Math.min(n[1][0],900),Math.min(n[1][1],r)]}(t,.2);this.lastViewStates={zoom:r,latLonBounds:t,latLonBoundsBuffer:i},this.currentZoom=r;var o=!1,a=this.getTileIndices(r,i).filter((function(e){return n.options.warp||e.x>=0&&e.x<Math.pow(2,r)}));this.emit("tiles-load-start"),this.currentTiles=a.map((function(e){var t=e.x,r=e.y,i=e.z,a=n.getTile(t,r,i);return a?(((null==a?void 0:a.isFailure)||(null==a?void 0:a.isCancelled))&&a.loadData({getData:n.options.getTileData,onLoad:n.onTileLoad,onError:n.onTileError}),a):(a=n.createTile(t,r,i),o=!0,a)})),o&&this.resizeCacheTiles(),this.updateTileVisible(),this.pruneRequests()}}},{key:"reloadAll",value:function(){var e,t=y(this.cacheTiles);try{for(t.s();!(e=t.n()).done;){var n=a(e.value,2),r=n[0],i=n[1];if(!this.currentTiles.includes(i))return this.cacheTiles.delete(r),void this.onTileUnload(i);this.onTileUnload(i),i.loadData({getData:this.options.getTileData,onLoad:this.onTileLoad,onError:this.onTileError})}}catch(o){t.e(o)}finally{t.f()}}},{key:"reloadTileById",value:function(e,t,n){var r=this.cacheTiles.get("".concat(t,",").concat(n,",").concat(e));r&&(this.onTileUnload(r),r.loadData({getData:this.options.getTileData,onLoad:this.onTileLoad,onError:this.onTileError}))}},{key:"reloadTileByLnglat",value:function(e,t,n){var r=this.getTileByLngLat(e,t,n);r&&this.reloadTileById(r.z,r.x,r.y)}},{key:"reloadTileByExtent",value:function(e,t){var n=this;this.getTileIndices(t,e).forEach((function(e){n.reloadTileById(e.z,e.x,e.y)}))}},{key:"pruneRequests",value:function(){var e,t=[],n=y(this.cacheTiles.values());try{for(n.s();!(e=n.n()).done;){var r=e.value;r.isLoading&&(r.isCurrent||r.isVisible||t.push(r))}}catch(i){n.e(i)}finally{n.f()}for(;t.length>0;){t.shift().abortLoad()}}},{key:"getTileByLngLat",value:function(e,t,n){var r=this.options.zoomOffset,i=Math.ceil(n)+r,o=bo(e,t,i);return this.tiles.filter((function(e){return e.key==="".concat(o[0],"_").concat(o[1],"_").concat(i)}))[0]}},{key:"getTileExtent",value:function(e,t){return this.getTileIndices(t,e)}},{key:"getTileByZXY",value:function(e,t,n){return this.tiles.filter((function(r){return r.key==="".concat(t,"_").concat(n,"_").concat(e)}))[0]}},{key:"clear",value:function(){var e,t=y(this.cacheTiles.values());try{for(t.s();!(e=t.n()).done;){var n=e.value;n.isLoading?n.abortLoad():this.onTileUnload(n)}}catch(r){t.e(r)}finally{t.f()}this.lastViewStates=void 0,this.cacheTiles.clear(),this.currentTiles=[]}},{key:"destroy",value:function(){this.clear(),this.removeAllListeners()}},{key:"updateTileVisible",value:function(){var e,t=this.options.updateStrategy,n=new Map,r=y(this.cacheTiles.values());try{for(r.s();!(e=r.n()).done;){var i=e.value;n.set(i.key,i.isVisible),i.isCurrent=!1,i.isVisible=!1}}catch(l){r.e(l)}finally{r.f()}var o,a=y(this.currentTiles);try{for(a.s();!(o=a.n()).done;){var s=o.value;s.isCurrent=!0,s.isVisible=!0}}catch(l){a.e(l)}finally{a.f()}var u=Array.from(this.cacheTiles.values());"function"==typeof t?t(u):yo[t](u);var c=!1;Array.from(this.cacheTiles.values()).forEach((function(e){e.isVisible!==n.get(e.key)?(e.isVisibleChange=!0,c=!0):e.isVisibleChange=!1})),c&&this.emit("tile-update")}},{key:"getTileIndices",value:function(e,t){var n=this.options,r=n.tileSize,i=n.extent,o=n.zoomOffset,s=function(e){var t=e.zoom,n=e.latLonBounds,r=e.maxZoom,i=void 0===r?1/0:r,o=e.minZoom,s=void 0===o?0:o,u=e.zoomOffset,c=void 0===u?0:u,l=e.extent,f=void 0===l?_o:l,h=Math.ceil(t)+c;if(Number.isFinite(s)&&h<s)return[];Number.isFinite(i)&&h>i&&(h=i);for(var d=a(n,4),p=d[0],v=d[1],m=d[2],g=d[3],_=[Math.max(p,f[0]),Math.max(v,f[1]),Math.min(m,f[2]),Math.min(g,f[3])],y=[],E=a(bo(_[0],_[1],h),2),b=E[0],A=E[1],x=a(bo(_[2],_[3],h),2),S=x[0],T=x[1],R=b;R<=S;R++)for(var C=T;C<=A;C++)y.push({x:R,y:C,z:h});var M=(S+b)/2,w=(A+T)/2,L=function(e,t){return Math.abs(e-M)+Math.abs(t-w)};return y.sort((function(e,t){return L(e.x,e.y)-L(t.x,t.y)})),y}({maxZoom:Math.floor(this.options.maxZoom),minZoom:Math.ceil(this.options.minZoom),zoomOffset:o,tileSize:r,zoom:e,latLonBounds:t,extent:i});return s}},{key:"getTileId",value:function(e,t,n){return"".concat(e,",").concat(t,",").concat(n)}},{key:"loadFinished",value:function(){var e=!this.currentTiles.some((function(e){return!e.isDone}));return e&&this.emit("tiles-load-finished"),e}},{key:"getTile",value:function(e,t,n){var r=this.getTileId(e,t,n);return this.cacheTiles.get(r)}},{key:"createTile",value:function(e,t,n){var r=this.getTileId(e,t,n),i=new To({x:e,y:t,z:n,tileSize:this.options.tileSize,warp:this.options.warp});return this.cacheTiles.set(r,i),i.loadData({getData:this.options.getTileData,onLoad:this.onTileLoad,onError:this.onTileError}),i}},{key:"resizeCacheTiles",value:function(){var e=5*this.currentTiles.length;if(this.cacheTiles.size>e){var t,n=y(this.cacheTiles);try{for(n.s();!(t=n.n()).done;){var r=a(t.value,2),i=r[0],o=r[1];if(o.isVisible||this.currentTiles.includes(o)||(this.cacheTiles.delete(i),this.onTileUnload(o)),this.cacheTiles.size<=e)break}}catch(s){n.e(s)}finally{n.f()}}this.rebuildTileTree()}},{key:"rebuildTileTree",value:function(){var e,t=y(this.cacheTiles.values());try{for(t.s();!(e=t.n()).done;){var n=e.value;n.parent=null,n.children.length=0}}catch(s){t.e(s)}finally{t.f()}var r,i=y(this.cacheTiles.values());try{for(i.s();!(r=i.n()).done;){var o=r.value,a=this.getNearestAncestor(o.x,o.y,o.z);o.parent=a,(null==a?void 0:a.children)&&a.children.push(o)}}catch(s){i.e(s)}finally{i.f()}}},{key:"getNearestAncestor",value:function(e,t,n){for(;n>this.options.minZoom;){e=Math.floor(e/2),t=Math.floor(t/2),n-=1;var r=this.getTile(e,t,n);if(r)return r}return null}}])}(fo);function Do(e){var t=[],n=/\{([a-z])-([a-z])\}/.exec(e);if(n){var r,i=n[1].charCodeAt(0),o=n[2].charCodeAt(0);for(r=i;r<=o;++r)t.push(e.replace(n[0],String.fromCharCode(r)));return t}if(n=/\{(\d+)-(\d+)\}/.exec(e)){for(var a=parseInt(n[2],10),s=parseInt(n[1],10);s<=a;s++)t.push(e.replace(n[0],s.toString()));return t}return t.push(e),t}function Fo(e,t){if(!e||!e.length)throw new Error("url is not allowed to be empty");var n=t.x,r=t.y,i=t.z,o=Do(e),a=Math.abs(n+r)%o.length;return(rt(o[a])?"".concat(o[a],"/{z}/{x}/{y}"):o[a]).replace(/\{x\}/g,n.toString()).replace(/\{y\}/g,r.toString()).replace(/\{z\}/g,i.toString()).replace(/\{bbox\}/g,xo(n,r,i).join(",")).replace(/\{-y\}/g,(Math.pow(2,i)-r-1).toString())}function Bo(e,t){var n=t.x,r=t.y,i=t.z,o=t.layer,a=t.version,s=void 0===a?"1.0.0":a,u=t.style,c=void 0===u?"default":u,l=t.format,f=t.service,h=void 0===f?"WMTS":f,d=t.tileMatrixset,p=Do(e),v=Math.abs(n+r)%p.length;return"".concat(p[v],"&SERVICE=").concat(h,"&REQUEST=GetTile&VERSION=").concat(s,"&LAYER=").concat(o,"&STYLE=").concat(c,"&TILEMATRIXSET=").concat(d,"&FORMAT=").concat(l,"&TILECOL=").concat(n,"&TILEROW=").concat(r,"&TILEMATRIX=").concat(i)}function Uo(e,t){return null==e?t:e}var Go=function e(t,n){var r,i=t&&t.type;if("FeatureCollection"===i)for(r=0;r<t.features.length;r++)e(t.features[r],n);else if("GeometryCollection"===i)for(r=0;r<t.geometries.length;r++)e(t.geometries[r],n);else if("Feature"===i)e(t.geometry,n);else if("Polygon"===i)zo(t.coordinates,n);else if("MultiPolygon"===i)for(r=0;r<t.coordinates.length;r++)zo(t.coordinates[r],n);return t};function zo(e,t){if(0!==e.length){jo(e[0],t);for(var n=1;n<e.length;n++)jo(e[n],!t)}}function jo(e,t){for(var n=0,r=0,i=0,o=e.length,a=o-1;i<o;a=i++){var s=(e[i][0]-e[a][0])*(e[a][1]+e[i][1]),u=n+s;r+=Math.abs(n)>=Math.abs(s)?n-u+s:s-u+n,n=u}n+r>=0!=!!t&&e.reverse()}function Vo(e){return!!Array.isArray(e)&&(0===e.length||"number"==typeof e[0])}function Ho(e){var t=Object.isFrozen(e)?Ni.cloneDeep(e):e;return Go(t,!0),t}function Xo(e,t){return e||[[t[0],t[3]],[t[2],t[3]],[t[2],t[1]],[t[0],t[1]]]}var Wo=Object.defineProperty,Yo=Object.defineProperties,Zo=Object.getOwnPropertyDescriptors,qo=Object.getOwnPropertySymbols,Ko=Object.prototype.hasOwnProperty,Qo=Object.prototype.propertyIsEnumerable,$o=function(e,t,n){return t in e?Wo(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n},Jo=function(e,t){for(var n in t||(t={}))Ko.call(t,n)&&$o(e,n,t[n]);if(qo){var r,i=y(qo(t));try{for(i.s();!(r=i.n()).done;){n=r.value;Qo.call(t,n)&&$o(e,n,t[n])}}catch(o){i.e(o)}finally{i.f()}}return e},ea=function(e,t){return Yo(e,Zo(t))};function ta(e,t){var n=t.x,r=t.y,i=t.x1,o=t.y1,a=t.coordinates,s=t.geometry,u=[];if(!Array.isArray(e))return{dataArray:[]};if(s)return e.filter((function(e){return e[s]&&e[s].type&&e[s].coordinates&&e[s].coordinates.length>0})).forEach((function(e,t){We(Ho(e[s]),(function(n){var r=Ve(n),i=ea(Jo({},e),{_id:t,coordinates:r});u.push(i)}))})),{dataArray:u};for(var c=0;c<e.length;c++){var l=e[c],f=[];if(a){var h="Polygon";Array.isArray(a[0])||(h="Point"),Array.isArray(a[0])&&!Array.isArray(a[0][0])&&(h="LineString"),f=Ho({type:h,coordinates:l[a]}).coordinates}else if(n&&r&&i&&o){f=[[parseFloat(l[n]),parseFloat(l[r])],[parseFloat(l[i]),parseFloat(l[o])]]}else n&&r&&(f=[parseFloat(l[n]),parseFloat(l[r])]);var d=ea(Jo({},l),{_id:c,coordinates:f});u.push(d)}return{dataArray:u}}var na=Object.defineProperty,ra=Object.defineProperties,ia=Object.getOwnPropertyDescriptors,oa=Object.getOwnPropertySymbols,aa=Object.prototype.hasOwnProperty,sa=Object.prototype.propertyIsEnumerable,ua=function(e,t,n){return t in e?na(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n};function ca(e,t,n,r){for(var i,o=r,a=n-t>>1,s=n-t,u=e[t],c=e[t+1],l=e[n],f=e[n+1],h=t+3;h<n;h+=3){var d=la(e[h],e[h+1],u,c,l,f);if(d>o)i=h,o=d;else if(d===o){var p=Math.abs(h-a);p<s&&(i=h,s=p)}}o>r&&(i-t>3&&ca(e,t,i,r),e[i+2]=o,n-i>3&&ca(e,i,n,r))}function la(e,t,n,r,i,o){var a=i-n,s=o-r;if(0!==a||0!==s){var u=((e-n)*a+(t-r)*s)/(a*a+s*s);u>1?(n=i,r=o):u>0&&(n+=a*u,r+=s*u)}return(a=e-n)*a+(s=t-r)*s}function fa(e,t,n,r){var i={id:void 0===e?null:e,type:t,geometry:n,tags:r,minX:1/0,minY:1/0,maxX:-1/0,maxY:-1/0};return function(e){var t=e.geometry,n=e.type;if("Point"===n||"MultiPoint"===n||"LineString"===n)ha(e,t);else if("Polygon"===n||"MultiLineString"===n)for(var r=0;r<t.length;r++)ha(e,t[r]);else if("MultiPolygon"===n)for(r=0;r<t.length;r++)for(var i=0;i<t[r].length;i++)ha(e,t[r][i])}(i),i}function ha(e,t){for(var n=0;n<t.length;n+=3)e.minX=Math.min(e.minX,t[n]),e.minY=Math.min(e.minY,t[n+1]),e.maxX=Math.max(e.maxX,t[n]),e.maxY=Math.max(e.maxY,t[n+1])}function da(e,t,n,r){if(t.geometry){var i=t.geometry.coordinates,o=t.geometry.type,a=Math.pow(n.tolerance/((1<<n.maxZoom)*n.extent),2),s=[],u=t.id;if(n.promoteId?u=t.properties[n.promoteId]:n.generateId&&(u=r||0),"Point"===o)pa(i,s);else if("MultiPoint"===o)for(var c=0;c<i.length;c++)pa(i[c],s);else if("LineString"===o)va(i,s,a,!1);else if("MultiLineString"===o){if(n.lineMetrics){for(c=0;c<i.length;c++)s=[],va(i[c],s,a,!1),e.push(fa(u,"LineString",s,t.properties));return}ma(i,s,a,!1)}else if("Polygon"===o)ma(i,s,a,!0);else{if("MultiPolygon"!==o){if("GeometryCollection"===o){for(c=0;c<t.geometry.geometries.length;c++)da(e,{id:u,geometry:t.geometry.geometries[c],properties:t.properties},n,r);return}throw new Error("Input data is not a valid GeoJSON object.")}for(c=0;c<i.length;c++){var l=[];ma(i[c],l,a,!0),s.push(l)}}e.push(fa(u,o,s,t.properties))}}function pa(e,t){t.push(ga(e[0])),t.push(_a(e[1])),t.push(0)}function va(e,t,n,r){for(var i,o,a=0,s=0;s<e.length;s++){var u=ga(e[s][0]),c=_a(e[s][1]);t.push(u),t.push(c),t.push(0),s>0&&(a+=r?(i*c-u*o)/2:Math.sqrt(Math.pow(u-i,2)+Math.pow(c-o,2))),i=u,o=c}var l=t.length-3;t[2]=1,ca(t,0,l,n),t[l+2]=1,t.size=Math.abs(a),t.start=0,t.end=t.size}function ma(e,t,n,r){for(var i=0;i<e.length;i++){var o=[];va(e[i],o,n,r),t.push(o)}}function ga(e){return e/360+.5}function _a(e){var t=Math.sin(e*Math.PI/180),n=.5-.25*Math.log((1+t)/(1-t))/Math.PI;return n<0?0:n>1?1:n}function ya(e,t,n,r,i,o,a,s){if(r/=t,o>=(n/=t)&&a<r)return e;if(a<n||o>=r)return null;for(var u=[],c=0;c<e.length;c++){var l=e[c],f=l.geometry,h=l.type,d=0===i?l.minX:l.minY,p=0===i?l.maxX:l.maxY;if(d>=n&&p<r)u.push(l);else if(!(p<n||d>=r)){var v=[];if("Point"===h||"MultiPoint"===h)Ea(f,v,n,r,i);else if("LineString"===h)ba(f,v,n,r,i,!1,s.lineMetrics);else if("MultiLineString"===h)xa(f,v,n,r,i,!1);else if("Polygon"===h)xa(f,v,n,r,i,!0);else if("MultiPolygon"===h)for(var m=0;m<f.length;m++){var g=[];xa(f[m],g,n,r,i,!0),g.length&&v.push(g)}if(v.length){if(s.lineMetrics&&"LineString"===h){for(m=0;m<v.length;m++)u.push(fa(l.id,h,v[m],l.tags));continue}"LineString"!==h&&"MultiLineString"!==h||(1===v.length?(h="LineString",v=v[0]):h="MultiLineString"),"Point"!==h&&"MultiPoint"!==h||(h=3===v.length?"Point":"MultiPoint"),u.push(fa(l.id,h,v,l.tags))}}}return u.length?u:null}function Ea(e,t,n,r,i){for(var o=0;o<e.length;o+=3){var a=e[o+i];a>=n&&a<=r&&(t.push(e[o]),t.push(e[o+1]),t.push(e[o+2]))}}function ba(e,t,n,r,i,o,a){for(var s,u,c=Aa(e),l=0===i?Ta:Ra,f=e.start,h=0;h<e.length-3;h+=3){var d=e[h],p=e[h+1],v=e[h+2],m=e[h+3],g=e[h+4],_=0===i?d:p,y=0===i?m:g,E=!1;a&&(s=Math.sqrt(Math.pow(d-m,2)+Math.pow(p-g,2))),_<n?y>n&&(u=l(c,d,p,m,g,n),a&&(c.start=f+s*u)):_>r?y<r&&(u=l(c,d,p,m,g,r),a&&(c.start=f+s*u)):Sa(c,d,p,v),y<n&&_>=n&&(u=l(c,d,p,m,g,n),E=!0),y>r&&_<=r&&(u=l(c,d,p,m,g,r),E=!0),!o&&E&&(a&&(c.end=f+s*u),t.push(c),c=Aa(e)),a&&(f+=s)}var b=e.length-3;d=e[b],p=e[b+1],v=e[b+2],(_=0===i?d:p)>=n&&_<=r&&Sa(c,d,p,v),b=c.length-3,o&&b>=3&&(c[b]!==c[0]||c[b+1]!==c[1])&&Sa(c,c[0],c[1],c[2]),c.length&&t.push(c)}function Aa(e){var t=[];return t.size=e.size,t.start=e.start,t.end=e.end,t}function xa(e,t,n,r,i,o){for(var a=0;a<e.length;a++)ba(e[a],t,n,r,i,o,!1)}function Sa(e,t,n,r){e.push(t),e.push(n),e.push(r)}function Ta(e,t,n,r,i,o){var a=(o-t)/(r-t);return e.push(o),e.push(n+(i-n)*a),e.push(1),a}function Ra(e,t,n,r,i,o){var a=(o-n)/(i-n);return e.push(t+(r-t)*a),e.push(o),e.push(1),a}function Ca(e,t){for(var n=[],r=0;r<e.length;r++){var i,o=e[r],a=o.type;if("Point"===a||"MultiPoint"===a||"LineString"===a)i=Ma(o.geometry,t);else if("MultiLineString"===a||"Polygon"===a){i=[];for(var s=0;s<o.geometry.length;s++)i.push(Ma(o.geometry[s],t))}else if("MultiPolygon"===a)for(i=[],s=0;s<o.geometry.length;s++){for(var u=[],c=0;c<o.geometry[s].length;c++)u.push(Ma(o.geometry[s][c],t));i.push(u)}n.push(fa(o.id,a,i,o.tags))}return n}function Ma(e,t){var n=[];n.size=e.size,void 0!==e.start&&(n.start=e.start,n.end=e.end);for(var r=0;r<e.length;r+=3)n.push(e[r]+t,e[r+1],e[r+2]);return n}function wa(e,t){if(e.transformed)return e;var n,r,i,o=1<<e.z,a=e.x,s=e.y;for(n=0;n<e.features.length;n++){var u=e.features[n],c=u.geometry,l=u.type;if(u.geometry=[],1===l)for(r=0;r<c.length;r+=2)u.geometry.push(La(c[r],c[r+1],t,o,a,s));else for(r=0;r<c.length;r++){var f=[];for(i=0;i<c[r].length;i+=2)f.push(La(c[r][i],c[r][i+1],t,o,a,s));u.geometry.push(f)}}return e.transformed=!0,e}function La(e,t,n,r,i,o){return[Math.round(n*(e*r-i)),Math.round(n*(t*r-o))]}function Oa(e,t,n,r,i){for(var o=t===i.maxZoom?0:i.tolerance/((1<<t)*i.extent),a={features:[],numPoints:0,numSimplified:0,numFeatures:0,source:null,x:n,y:r,z:t,transformed:!1,minX:2,minY:1,maxX:-1,maxY:0},s=0;s<e.length;s++){a.numFeatures++,ka(a,e[s],o,i);var u=e[s].minX,c=e[s].minY,l=e[s].maxX,f=e[s].maxY;u<a.minX&&(a.minX=u),c<a.minY&&(a.minY=c),l>a.maxX&&(a.maxX=l),f>a.maxY&&(a.maxY=f)}return a}function ka(e,t,n,r){var i=t.geometry,o=t.type,a=[];if("Point"===o||"MultiPoint"===o)for(var s=0;s<i.length;s+=3)a.push(i[s]),a.push(i[s+1]),e.numPoints++,e.numSimplified++;else if("LineString"===o)Na(a,i,e,n,!1,!1);else if("MultiLineString"===o||"Polygon"===o)for(s=0;s<i.length;s++)Na(a,i[s],e,n,"Polygon"===o,0===s);else if("MultiPolygon"===o)for(var u=0;u<i.length;u++){var c=i[u];for(s=0;s<c.length;s++)Na(a,c[s],e,n,!0,0===s)}if(a.length){var l=t.tags||null;if("LineString"===o&&r.lineMetrics){for(var f in l={},t.tags)l[f]=t.tags[f];l.mapbox_clip_start=i.start/i.size,l.mapbox_clip_end=i.end/i.size}var h={geometry:a,type:"Polygon"===o||"MultiPolygon"===o?3:"LineString"===o||"MultiLineString"===o?2:1,tags:l};null!==t.id&&(h.id=t.id),e.features.push(h)}}function Na(e,t,n,r,i,o){var a=r*r;if(r>0&&t.size<(i?a:r))n.numPoints+=t.length/3;else{for(var s=[],u=0;u<t.length;u+=3)(0===r||t[u+2]>a)&&(n.numSimplified++,s.push(t[u]),s.push(t[u+1])),n.numPoints++;i&&function(e,t){for(var n=0,r=0,i=e.length,o=i-2;r<i;o=r,r+=2)n+=(e[r]-e[o])*(e[r+1]+e[o+1]);if(n>0===t)for(r=0,i=e.length;r<i/2;r+=2){var a=e[r],s=e[r+1];e[r]=e[i-2-r],e[r+1]=e[i-1-r],e[i-2-r]=a,e[i-1-r]=s}}(s,o),e.push(s)}}function Ia(e,t){var n=(t=this.options=function(e,t){for(var n in t)e[n]=t[n];return e}(Object.create(this.options),t)).debug;if(n&&console.time("preprocess data"),t.maxZoom<0||t.maxZoom>24)throw new Error("maxZoom should be in the 0-24 range");if(t.promoteId&&t.generateId)throw new Error("promoteId and generateId cannot be used together.");var r=function(e,t){var n=[];if("FeatureCollection"===e.type)for(var r=0;r<e.features.length;r++)da(n,e.features[r],t,r);else"Feature"===e.type?da(n,e,t):da(n,{geometry:e},t);return n}(e,t);this.tiles={},this.tileCoords=[],n&&(console.timeEnd("preprocess data"),console.log("index: maxZoom: %d, maxPoints: %d",t.indexMaxZoom,t.indexMaxPoints),console.time("generate tiles"),this.stats={},this.total=0),r=function(e,t){var n=t.buffer/t.extent,r=e,i=ya(e,1,-1-n,n,0,-1,2,t),o=ya(e,1,1-n,2+n,0,-1,2,t);return(i||o)&&(r=ya(e,1,-n,1+n,0,-1,2,t)||[],i&&(r=Ca(i,1).concat(r)),o&&(r=r.concat(Ca(o,-1)))),r}(r,t),r.length&&this.splitTile(r,0,0,0),n&&(r.length&&console.log("features: %d, points: %d",this.tiles[0].numFeatures,this.tiles[0].numPoints),console.timeEnd("generate tiles"),console.log("tiles generated:",this.total,JSON.stringify(this.stats)))}function Pa(e,t,n){return 32*((1<<e)*n+t)+e}Ia.prototype.options={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!1,debug:0},Ia.prototype.splitTile=function(e,t,n,r,i,o,a){for(var s=[e,t,n,r],u=this.options,c=u.debug;s.length;){r=s.pop(),n=s.pop(),t=s.pop(),e=s.pop();var l=1<<t,f=Pa(t,n,r),h=this.tiles[f];if(!h&&(c>1&&console.time("creation"),h=this.tiles[f]=Oa(e,t,n,r,u),this.tileCoords.push({z:t,x:n,y:r}),c)){c>1&&(console.log("tile z%d-%d-%d (features: %d, points: %d, simplified: %d)",t,n,r,h.numFeatures,h.numPoints,h.numSimplified),console.timeEnd("creation"));var d="z"+t;this.stats[d]=(this.stats[d]||0)+1,this.total++}if(h.source=e,i){if(t===u.maxZoom||t===i)continue;var p=1<<i-t;if(n!==Math.floor(o/p)||r!==Math.floor(a/p))continue}else if(t===u.indexMaxZoom||h.numPoints<=u.indexMaxPoints)continue;if(h.source=null,0!==e.length){c>1&&console.time("clipping");var v,m,g,_,y,E,b=.5*u.buffer/u.extent,A=.5-b,x=.5+b,S=1+b;v=m=g=_=null,y=ya(e,l,n-b,n+x,0,h.minX,h.maxX,u),E=ya(e,l,n+A,n+S,0,h.minX,h.maxX,u),e=null,y&&(v=ya(y,l,r-b,r+x,1,h.minY,h.maxY,u),m=ya(y,l,r+A,r+S,1,h.minY,h.maxY,u),y=null),E&&(g=ya(E,l,r-b,r+x,1,h.minY,h.maxY,u),_=ya(E,l,r+A,r+S,1,h.minY,h.maxY,u),E=null),c>1&&console.timeEnd("clipping"),s.push(v||[],t+1,2*n,2*r),s.push(m||[],t+1,2*n,2*r+1),s.push(g||[],t+1,2*n+1,2*r),s.push(_||[],t+1,2*n+1,2*r+1)}}},Ia.prototype.getTile=function(e,t,n){var r=this.options,i=r.extent,o=r.debug;if(e<0||e>24)return null;var a=1<<e,s=Pa(e,t=(t%a+a)%a,n);if(this.tiles[s])return wa(this.tiles[s],i);o>1&&console.log("drilling down to z%d-%d-%d",e,t,n);for(var u,c=e,l=t,f=n;!u&&c>0;)c--,l=Math.floor(l/2),f=Math.floor(f/2),u=this.tiles[Pa(c,l,f)];return u&&u.source?(o>1&&console.log("found parent tile z%d-%d-%d",c,l,f),o>1&&console.time("drilling down"),this.splitTile(u.source,c,l,f,e,t,n),o>1&&console.timeEnd("drilling down"),this.tiles[s]?wa(this.tiles[s],i):null):null};var Da=function(){return c((function e(t,n,r,i){f(this,e),this.vectorLayerCache={},this.x=n,this.y=r,this.z=i,this.vectorTile=t}),[{key:"getTileData",value:function(e){return e&&this.vectorTile.layers[e]?this.vectorLayerCache[e]?this.vectorLayerCache[e]:this.vectorTile.layers[e].features:[]}},{key:"getFeatureById",value:function(){throw new Error("Method not implemented.")}}])}(),Fa=Object.defineProperty,Ba=Object.defineProperties,Ua=Object.getOwnPropertyDescriptors,Ga=Object.getOwnPropertySymbols,za=Object.prototype.hasOwnProperty,ja=Object.prototype.propertyIsEnumerable,Va=function(e,t,n){return t in e?Fa(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n},Ha=function(e,t){for(var n in t||(t={}))za.call(t,n)&&Va(e,n,t[n]);if(Ga){var r,i=y(Ga(t));try{for(i.s();!(r=i.n()).done;){n=r.value;ja.call(t,n)&&Va(e,n,t[n])}}catch(o){i.e(o)}finally{i.f()}}return e},Xa={tileSize:256,minZoom:0,maxZoom:1/0,zoomOffset:0};function Wa(e){for(var t,n,r=0,i=0,o=e.length,a=o-1;i<o;a=i++)t=e[i],r+=((n=e[a]).x-t.x)*(t.y+n.y);return r}var Ya=["Unknown","Point","LineString","Polygon"];function Za(e,t,n,r,i){var o,a,s=i.geometry,u=i.type,c=i.tags,l=i.id,f=e*Math.pow(2,r),h=e*t,d=e*n,p=Ya[u];function v(e){for(var t=0;t<e.length;t++){var n=e[t];if(n[3])break;var r=180-360*(n[1]+d)/f,i=360*(n[0]+h)/f-180,o=360/Math.PI*Math.atan(Math.exp(r*Math.PI/180))-90;e[t]=[i,o,0,1]}}switch(u){case 1:var m=[];for(o=0;o<s.length;o++)m[o]=s[o][0];v(s=m);break;case 2:for(o=0;o<s.length;o++)v(s[o]);break;case 3:for(s=function(e){var t=e.length;if(t<=1)return[e];for(var n,r,i=[],o=0;o<t;o++){var a=Wa(e[o]);0!==a&&(void 0===r&&(r=a<0),r===a<0?(n&&i.push(n),n=[e[o]]):n.push(e[o]))}return n&&i.push(n),i}(s),o=0;o<s.length;o++)for(a=0;a<s[o].length;a++)v(s[o][a])}return 1===s.length?s=s[0]:p="Multi"+p,{type:"Feature",geometry:{type:p,coordinates:s},properties:c,id:l,tileOrigin:[0,0],coord:""}}var qa=function(e,t,n,r){return o=void 0,a=null,s=i().mark((function o(){return i().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return i.abrupt("return",new Promise((function(i){var o=t.getTile(e.z,e.x,e.y),a=o?o.features.map((function(e){return Za(r,n.x,n.y,n.z,e)})):[];i(new Da({layers:{defaultLayer:{features:a}}},e.x,e.y,e.z))})));case 1:case"end":return i.stop()}}),o)})),new Promise((function(e,t){var n=function(e){try{i(s.next(e))}catch(n){t(n)}},r=function(e){try{i(s.throw(e))}catch(n){t(n)}},i=function(t){return t.done?e(t.value):Promise.resolve(t.value).then(n,r)};i((s=s.apply(o,a)).next())}));var o,a,s};var Ka=Object.defineProperty,Qa=Object.defineProperties,$a=Object.getOwnPropertyDescriptors,Ja=Object.getOwnPropertySymbols,es=Object.prototype.hasOwnProperty,ts=Object.prototype.propertyIsEnumerable,ns=function(e,t,n){return t in e?Ka(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n},rs=function(e,t){for(var n in t||(t={}))es.call(t,n)&&ns(e,n,t[n]);if(Ja){var r,i=y(Ja(t));try{for(i.s();!(r=i.n()).done;){n=r.value;ts.call(t,n)&&ns(e,n,t[n])}}catch(o){i.e(o)}finally{i.f()}}return e},is=function(e,t){return Qa(e,$a(t))};function os(e,t){var n=t.extent,r=void 0===n?[121.168,30.2828,121.384,30.4219]:n,i=t.coordinates,o=t.requestParameters,a=void 0===o?{}:o,s=new Promise((function(t){e instanceof HTMLImageElement||function(e){return"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap}(e)?t([e]):function(e,t,n){var r=[];if("string"==typeof e)dt(is(rs({},t),{url:e}),(function(e,t){t&&(r.push(t),n(r))}));else{var i=e.length,o=0;e.forEach((function(e){dt(is(rs({},t),{url:e}),(function(e,t){o++,t&&r.push(t),o===i&&n(r)}))}))}}(e,a,(function(e){t(e)}))})),u=Xo(i,r);return{originData:e,images:s,_id:1,dataArray:[{_id:0,coordinates:u}]}}var as=Object.defineProperty,ss=Object.defineProperties,us=Object.getOwnPropertyDescriptors,cs=Object.getOwnPropertySymbols,ls=Object.prototype.hasOwnProperty,fs=Object.prototype.propertyIsEnumerable,hs=function(e,t,n){return t in e?as(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n},ds=function(e,t){for(var n in t||(t={}))ls.call(t,n)&&hs(e,n,t[n]);if(cs){var r,i=y(cs(t));try{for(i.s();!(r=i.n()).done;){n=r.value;fs.call(t,n)&&hs(e,n,t[n])}}catch(o){i.e(o)}finally{i.f()}}return e},ps=function(e,t){return ss(e,us(t))},vs=function(e,t,n,r){return o=void 0,a=null,s=i().mark((function o(){var a,s;return i().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return a={x:t.x,y:t.y,z:t.z},s=Fo(e,a),i.abrupt("return",new Promise((function(e){r?r(a,(function(n,r){if(n||!r){var i=new Da({layers:{defaultLayer:{features:[]}}},t.x,t.y,t.z);e(i)}else{var o={layers:{defaultLayer:{features:r.features}}},a=new Da(o,t.x,t.y,t.z);e(a)}})):ct(ps(ds({},n),{url:s}),(function(n,r){if(n||!r){var i=new Da({layers:{defaultLayer:{features:[]}}},t.x,t.y,t.z);e(i)}else{var o=JSON.parse(r),a=new Da({layers:{defaultLayer:{features:o}}},t.x,t.y,t.z);e(a)}}))})));case 3:case"end":return i.stop()}}),o)})),new Promise((function(e,t){var n=function(e){try{i(s.next(e))}catch(n){t(n)}},r=function(e){try{i(s.throw(e))}catch(n){t(n)}},i=function(t){return t.done?e(t.value):Promise.resolve(t.value).then(n,r)};i((s=s.apply(o,a)).next())}));var o,a,s};var ms=gs;function gs(e,t){this.x=e,this.y=t}gs.prototype={clone:function(){return new gs(this.x,this.y)},add:function(e){return this.clone()._add(e)},sub:function(e){return this.clone()._sub(e)},multByPoint:function(e){return this.clone()._multByPoint(e)},divByPoint:function(e){return this.clone()._divByPoint(e)},mult:function(e){return this.clone()._mult(e)},div:function(e){return this.clone()._div(e)},rotate:function(e){return this.clone()._rotate(e)},rotateAround:function(e,t){return this.clone()._rotateAround(e,t)},matMult:function(e){return this.clone()._matMult(e)},unit:function(){return this.clone()._unit()},perp:function(){return this.clone()._perp()},round:function(){return this.clone()._round()},mag:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},equals:function(e){return this.x===e.x&&this.y===e.y},dist:function(e){return Math.sqrt(this.distSqr(e))},distSqr:function(e){var t=e.x-this.x,n=e.y-this.y;return t*t+n*n},angle:function(){return Math.atan2(this.y,this.x)},angleTo:function(e){return Math.atan2(this.y-e.y,this.x-e.x)},angleWith:function(e){return this.angleWithSep(e.x,e.y)},angleWithSep:function(e,t){return Math.atan2(this.x*t-this.y*e,this.x*e+this.y*t)},_matMult:function(e){var t=e[0]*this.x+e[1]*this.y,n=e[2]*this.x+e[3]*this.y;return this.x=t,this.y=n,this},_add:function(e){return this.x+=e.x,this.y+=e.y,this},_sub:function(e){return this.x-=e.x,this.y-=e.y,this},_mult:function(e){return this.x*=e,this.y*=e,this},_div:function(e){return this.x/=e,this.y/=e,this},_multByPoint:function(e){return this.x*=e.x,this.y*=e.y,this},_divByPoint:function(e){return this.x/=e.x,this.y/=e.y,this},_unit:function(){return this._div(this.mag()),this},_perp:function(){var e=this.y;return this.y=this.x,this.x=-e,this},_rotate:function(e){var t=Math.cos(e),n=Math.sin(e),r=t*this.x-n*this.y,i=n*this.x+t*this.y;return this.x=r,this.y=i,this},_rotateAround:function(e,t){var n=Math.cos(e),r=Math.sin(e),i=t.x+n*(this.x-t.x)-r*(this.y-t.y),o=t.y+r*(this.x-t.x)+n*(this.y-t.y);return this.x=i,this.y=o,this},_round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}},gs.convert=function(e){return e instanceof gs?e:Array.isArray(e)?new gs(e[0],e[1]):e};var _s=ms,ys=Es;function Es(e,t,n,r,i){this.properties={},this.extent=n,this.type=0,this._pbf=e,this._geometry=-1,this._keys=r,this._values=i,e.readFields(bs,this,t)}function bs(e,t,n){1==e?t.id=n.readVarint():2==e?function(e,t){var n=e.readVarint()+e.pos;for(;e.pos<n;){var r=t._keys[e.readVarint()],i=t._values[e.readVarint()];t.properties[r]=i}}(n,t):3==e?t.type=n.readVarint():4==e&&(t._geometry=n.pos)}function As(e){for(var t,n,r=0,i=0,o=e.length,a=o-1;i<o;a=i++)t=e[i],r+=((n=e[a]).x-t.x)*(t.y+n.y);return r}Es.types=["Unknown","Point","LineString","Polygon"],Es.prototype.loadGeometry=function(){var e=this._pbf;e.pos=this._geometry;for(var t,n=e.readVarint()+e.pos,r=1,i=0,o=0,a=0,s=[];e.pos<n;){if(i<=0){var u=e.readVarint();r=7&u,i=u>>3}if(i--,1===r||2===r)o+=e.readSVarint(),a+=e.readSVarint(),1===r&&(t&&s.push(t),t=[]),t.push(new _s(o,a));else{if(7!==r)throw new Error("unknown command "+r);t&&t.push(t[0].clone())}}return t&&s.push(t),s},Es.prototype.bbox=function(){var e=this._pbf;e.pos=this._geometry;for(var t=e.readVarint()+e.pos,n=1,r=0,i=0,o=0,a=1/0,s=-1/0,u=1/0,c=-1/0;e.pos<t;){if(r<=0){var l=e.readVarint();n=7&l,r=l>>3}if(r--,1===n||2===n)(i+=e.readSVarint())<a&&(a=i),i>s&&(s=i),(o+=e.readSVarint())<u&&(u=o),o>c&&(c=o);else if(7!==n)throw new Error("unknown command "+n)}return[a,u,s,c]},Es.prototype.toGeoJSON=function(e,t,n){var r,i,o=this.extent*Math.pow(2,n),a=this.extent*e,s=this.extent*t,u=this.loadGeometry(),c=Es.types[this.type];function l(e){for(var t=0;t<e.length;t++){var n=e[t],r=180-360*(n.y+s)/o;e[t]=[360*(n.x+a)/o-180,360/Math.PI*Math.atan(Math.exp(r*Math.PI/180))-90]}}switch(this.type){case 1:var f=[];for(r=0;r<u.length;r++)f[r]=u[r][0];l(u=f);break;case 2:for(r=0;r<u.length;r++)l(u[r]);break;case 3:for(u=function(e){var t=e.length;if(t<=1)return[e];for(var n,r,i=[],o=0;o<t;o++){var a=As(e[o]);0!==a&&(void 0===r&&(r=a<0),r===a<0?(n&&i.push(n),n=[e[o]]):n.push(e[o]))}n&&i.push(n);return i}(u),r=0;r<u.length;r++)for(i=0;i<u[r].length;i++)l(u[r][i])}1===u.length?u=u[0]:c="Multi"+c;var h={type:"Feature",geometry:{type:c,coordinates:u},properties:this.properties};return"id"in this&&(h.id=this.id),h};var xs=ys,Ss=Ts;function Ts(e,t){this.version=1,this.name=null,this.extent=4096,this.length=0,this._pbf=e,this._keys=[],this._values=[],this._features=[],e.readFields(Rs,this,t),this.length=this._features.length}function Rs(e,t,n){15===e?t.version=n.readVarint():1===e?t.name=n.readString():5===e?t.extent=n.readVarint():2===e?t._features.push(n.pos):3===e?t._keys.push(n.readString()):4===e&&t._values.push(function(e){var t=null,n=e.readVarint()+e.pos;for(;e.pos<n;){var r=e.readVarint()>>3;t=1===r?e.readString():2===r?e.readFloat():3===r?e.readDouble():4===r?e.readVarint64():5===r?e.readVarint():6===r?e.readSVarint():7===r?e.readBoolean():null}return t}(n))}Ts.prototype.feature=function(e){if(e<0||e>=this._features.length)throw new Error("feature index out of bounds");this._pbf.pos=this._features[e];var t=this._pbf.readVarint()+this._pbf.pos;return new xs(this._pbf,t,this.extent,this._keys,this._values)};var Cs=Ss,Ms=function(e,t){this.layers=e.readFields(ws,{},t)};function ws(e,t,n){if(3===e){var r=new Cs(n,n.readVarint()+n.pos);r.length&&(t[r.name]=r)}}var Ls=Ms,Os={/*! ieee754. BSD-3-Clause License. Feross Aboukhadijeh <https://feross.org/opensource> */read:function(e,t,n,r,i){var o,a,s=8*i-r-1,u=(1<<s)-1,c=u>>1,l=-7,f=n?i-1:0,h=n?-1:1,d=e[t+f];for(f+=h,o=d&(1<<-l)-1,d>>=-l,l+=s;l>0;o=256*o+e[t+f],f+=h,l-=8);for(a=o&(1<<-l)-1,o>>=-l,l+=r;l>0;a=256*a+e[t+f],f+=h,l-=8);if(0===o)o=1-c;else{if(o===u)return a?NaN:1/0*(d?-1:1);a+=Math.pow(2,r),o-=c}return(d?-1:1)*a*Math.pow(2,o-r)},write:function(e,t,n,r,i,o){var a,s,u,c=8*o-i-1,l=(1<<c)-1,f=l>>1,h=23===i?Math.pow(2,-24)-Math.pow(2,-77):0,d=r?0:o-1,p=r?1:-1,v=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(s=isNaN(t)?1:0,a=l):(a=Math.floor(Math.log(t)/Math.LN2),t*(u=Math.pow(2,-a))<1&&(a--,u*=2),(t+=a+f>=1?h/u:h*Math.pow(2,1-f))*u>=2&&(a++,u/=2),a+f>=l?(s=0,a=l):a+f>=1?(s=(t*u-1)*Math.pow(2,i),a+=f):(s=t*Math.pow(2,f-1)*Math.pow(2,i),a=0));i>=8;e[n+d]=255&s,d+=p,s/=256,i-=8);for(a=a<<i|s,c+=i;c>0;e[n+d]=255&a,d+=p,a/=256,c-=8);e[n+d-p]|=128*v}},ks=Is,Ns=Os;function Is(e){this.buf=ArrayBuffer.isView&&ArrayBuffer.isView(e)?e:new Uint8Array(e||0),this.pos=0,this.type=0,this.length=this.buf.length}Is.Varint=0,Is.Fixed64=1,Is.Bytes=2,Is.Fixed32=5;var Ps=4294967296,Ds=1/Ps,Fs="undefined"==typeof TextDecoder?null:new TextDecoder("utf8");function Bs(e){return e.type===Is.Bytes?e.readVarint()+e.pos:e.pos+1}function Us(e,t,n){return n?4294967296*t+(e>>>0):4294967296*(t>>>0)+(e>>>0)}function Gs(e,t,n){var r=t<=16383?1:t<=2097151?2:t<=268435455?3:Math.floor(Math.log(t)/(7*Math.LN2));n.realloc(r);for(var i=n.pos-1;i>=e;i--)n.buf[i+r]=n.buf[i]}function zs(e,t){for(var n=0;n<e.length;n++)t.writeVarint(e[n])}function js(e,t){for(var n=0;n<e.length;n++)t.writeSVarint(e[n])}function Vs(e,t){for(var n=0;n<e.length;n++)t.writeFloat(e[n])}function Hs(e,t){for(var n=0;n<e.length;n++)t.writeDouble(e[n])}function Xs(e,t){for(var n=0;n<e.length;n++)t.writeBoolean(e[n])}function Ws(e,t){for(var n=0;n<e.length;n++)t.writeFixed32(e[n])}function Ys(e,t){for(var n=0;n<e.length;n++)t.writeSFixed32(e[n])}function Zs(e,t){for(var n=0;n<e.length;n++)t.writeFixed64(e[n])}function qs(e,t){for(var n=0;n<e.length;n++)t.writeSFixed64(e[n])}function Ks(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16)+16777216*e[t+3]}function Qs(e,t,n){e[n]=t,e[n+1]=t>>>8,e[n+2]=t>>>16,e[n+3]=t>>>24}function $s(e,t){return(e[t]|e[t+1]<<8|e[t+2]<<16)+(e[t+3]<<24)}Is.prototype={destroy:function(){this.buf=null},readFields:function(e,t,n){for(n=n||this.length;this.pos<n;){var r=this.readVarint(),i=r>>3,o=this.pos;this.type=7&r,e(i,t,this),this.pos===o&&this.skip(r)}return t},readMessage:function(e,t){return this.readFields(e,t,this.readVarint()+this.pos)},readFixed32:function(){var e=Ks(this.buf,this.pos);return this.pos+=4,e},readSFixed32:function(){var e=$s(this.buf,this.pos);return this.pos+=4,e},readFixed64:function(){var e=Ks(this.buf,this.pos)+Ks(this.buf,this.pos+4)*Ps;return this.pos+=8,e},readSFixed64:function(){var e=Ks(this.buf,this.pos)+$s(this.buf,this.pos+4)*Ps;return this.pos+=8,e},readFloat:function(){var e=Ns.read(this.buf,this.pos,!0,23,4);return this.pos+=4,e},readDouble:function(){var e=Ns.read(this.buf,this.pos,!0,52,8);return this.pos+=8,e},readVarint:function(e){var t,n,r=this.buf;return t=127&(n=r[this.pos++]),n<128?t:(t|=(127&(n=r[this.pos++]))<<7,n<128?t:(t|=(127&(n=r[this.pos++]))<<14,n<128?t:(t|=(127&(n=r[this.pos++]))<<21,n<128?t:function(e,t,n){var r,i,o=n.buf;if(i=o[n.pos++],r=(112&i)>>4,i<128)return Us(e,r,t);if(i=o[n.pos++],r|=(127&i)<<3,i<128)return Us(e,r,t);if(i=o[n.pos++],r|=(127&i)<<10,i<128)return Us(e,r,t);if(i=o[n.pos++],r|=(127&i)<<17,i<128)return Us(e,r,t);if(i=o[n.pos++],r|=(127&i)<<24,i<128)return Us(e,r,t);if(i=o[n.pos++],r|=(1&i)<<31,i<128)return Us(e,r,t);throw new Error("Expected varint not more than 10 bytes")}(t|=(15&(n=r[this.pos]))<<28,e,this))))},readVarint64:function(){return this.readVarint(!0)},readSVarint:function(){var e=this.readVarint();return e%2==1?(e+1)/-2:e/2},readBoolean:function(){return Boolean(this.readVarint())},readString:function(){var e=this.readVarint()+this.pos,t=this.pos;return this.pos=e,e-t>=12&&Fs?function(e,t,n){return Fs.decode(e.subarray(t,n))}(this.buf,t,e):function(e,t,n){var r="",i=t;for(;i<n;){var o,a,s,u=e[i],c=null,l=u>239?4:u>223?3:u>191?2:1;if(i+l>n)break;1===l?u<128&&(c=u):2===l?128==(192&(o=e[i+1]))&&(c=(31&u)<<6|63&o)<=127&&(c=null):3===l?(o=e[i+1],a=e[i+2],128==(192&o)&&128==(192&a)&&((c=(15&u)<<12|(63&o)<<6|63&a)<=2047||c>=55296&&c<=57343)&&(c=null)):4===l&&(o=e[i+1],a=e[i+2],s=e[i+3],128==(192&o)&&128==(192&a)&&128==(192&s)&&((c=(15&u)<<18|(63&o)<<12|(63&a)<<6|63&s)<=65535||c>=1114112)&&(c=null)),null===c?(c=65533,l=1):c>65535&&(c-=65536,r+=String.fromCharCode(c>>>10&1023|55296),c=56320|1023&c),r+=String.fromCharCode(c),i+=l}return r}(this.buf,t,e)},readBytes:function(){var e=this.readVarint()+this.pos,t=this.buf.subarray(this.pos,e);return this.pos=e,t},readPackedVarint:function(e,t){if(this.type!==Is.Bytes)return e.push(this.readVarint(t));var n=Bs(this);for(e=e||[];this.pos<n;)e.push(this.readVarint(t));return e},readPackedSVarint:function(e){if(this.type!==Is.Bytes)return e.push(this.readSVarint());var t=Bs(this);for(e=e||[];this.pos<t;)e.push(this.readSVarint());return e},readPackedBoolean:function(e){if(this.type!==Is.Bytes)return e.push(this.readBoolean());var t=Bs(this);for(e=e||[];this.pos<t;)e.push(this.readBoolean());return e},readPackedFloat:function(e){if(this.type!==Is.Bytes)return e.push(this.readFloat());var t=Bs(this);for(e=e||[];this.pos<t;)e.push(this.readFloat());return e},readPackedDouble:function(e){if(this.type!==Is.Bytes)return e.push(this.readDouble());var t=Bs(this);for(e=e||[];this.pos<t;)e.push(this.readDouble());return e},readPackedFixed32:function(e){if(this.type!==Is.Bytes)return e.push(this.readFixed32());var t=Bs(this);for(e=e||[];this.pos<t;)e.push(this.readFixed32());return e},readPackedSFixed32:function(e){if(this.type!==Is.Bytes)return e.push(this.readSFixed32());var t=Bs(this);for(e=e||[];this.pos<t;)e.push(this.readSFixed32());return e},readPackedFixed64:function(e){if(this.type!==Is.Bytes)return e.push(this.readFixed64());var t=Bs(this);for(e=e||[];this.pos<t;)e.push(this.readFixed64());return e},readPackedSFixed64:function(e){if(this.type!==Is.Bytes)return e.push(this.readSFixed64());var t=Bs(this);for(e=e||[];this.pos<t;)e.push(this.readSFixed64());return e},skip:function(e){var t=7&e;if(t===Is.Varint)for(;this.buf[this.pos++]>127;);else if(t===Is.Bytes)this.pos=this.readVarint()+this.pos;else if(t===Is.Fixed32)this.pos+=4;else{if(t!==Is.Fixed64)throw new Error("Unimplemented type: "+t);this.pos+=8}},writeTag:function(e,t){this.writeVarint(e<<3|t)},realloc:function(e){for(var t=this.length||16;t<this.pos+e;)t*=2;if(t!==this.length){var n=new Uint8Array(t);n.set(this.buf),this.buf=n,this.length=t}},finish:function(){return this.length=this.pos,this.pos=0,this.buf.subarray(0,this.length)},writeFixed32:function(e){this.realloc(4),Qs(this.buf,e,this.pos),this.pos+=4},writeSFixed32:function(e){this.realloc(4),Qs(this.buf,e,this.pos),this.pos+=4},writeFixed64:function(e){this.realloc(8),Qs(this.buf,-1&e,this.pos),Qs(this.buf,Math.floor(e*Ds),this.pos+4),this.pos+=8},writeSFixed64:function(e){this.realloc(8),Qs(this.buf,-1&e,this.pos),Qs(this.buf,Math.floor(e*Ds),this.pos+4),this.pos+=8},writeVarint:function(e){(e=+e||0)>268435455||e<0?function(e,t){var n,r;e>=0?(n=e%4294967296|0,r=e/4294967296|0):(r=~(-e/4294967296),4294967295^(n=~(-e%4294967296))?n=n+1|0:(n=0,r=r+1|0));if(e>=0x10000000000000000||e<-0x10000000000000000)throw new Error("Given varint doesn't fit into 10 bytes");t.realloc(10),function(e,t,n){n.buf[n.pos++]=127&e|128,e>>>=7,n.buf[n.pos++]=127&e|128,e>>>=7,n.buf[n.pos++]=127&e|128,e>>>=7,n.buf[n.pos++]=127&e|128,e>>>=7,n.buf[n.pos]=127&e}(n,0,t),function(e,t){var n=(7&e)<<4;if(t.buf[t.pos++]|=n|((e>>>=3)?128:0),!e)return;if(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),!e)return;if(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),!e)return;if(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),!e)return;if(t.buf[t.pos++]=127&e|((e>>>=7)?128:0),!e)return;t.buf[t.pos++]=127&e}(r,t)}(e,this):(this.realloc(4),this.buf[this.pos++]=127&e|(e>127?128:0),e<=127||(this.buf[this.pos++]=127&(e>>>=7)|(e>127?128:0),e<=127||(this.buf[this.pos++]=127&(e>>>=7)|(e>127?128:0),e<=127||(this.buf[this.pos++]=e>>>7&127))))},writeSVarint:function(e){this.writeVarint(e<0?2*-e-1:2*e)},writeBoolean:function(e){this.writeVarint(Boolean(e))},writeString:function(e){e=String(e),this.realloc(4*e.length),this.pos++;var t=this.pos;this.pos=function(e,t,n){for(var r,i,o=0;o<t.length;o++){if((r=t.charCodeAt(o))>55295&&r<57344){if(!i){r>56319||o+1===t.length?(e[n++]=239,e[n++]=191,e[n++]=189):i=r;continue}if(r<56320){e[n++]=239,e[n++]=191,e[n++]=189,i=r;continue}r=i-55296<<10|r-56320|65536,i=null}else i&&(e[n++]=239,e[n++]=191,e[n++]=189,i=null);r<128?e[n++]=r:(r<2048?e[n++]=r>>6|192:(r<65536?e[n++]=r>>12|224:(e[n++]=r>>18|240,e[n++]=r>>12&63|128),e[n++]=r>>6&63|128),e[n++]=63&r|128)}return n}(this.buf,e,this.pos);var n=this.pos-t;n>=128&&Gs(t,n,this),this.pos=t-1,this.writeVarint(n),this.pos+=n},writeFloat:function(e){this.realloc(4),Ns.write(this.buf,e,this.pos,!0,23,4),this.pos+=4},writeDouble:function(e){this.realloc(8),Ns.write(this.buf,e,this.pos,!0,52,8),this.pos+=8},writeBytes:function(e){var t=e.length;this.writeVarint(t),this.realloc(t);for(var n=0;n<t;n++)this.buf[this.pos++]=e[n]},writeRawMessage:function(e,t){this.pos++;var n=this.pos;e(t,this);var r=this.pos-n;r>=128&&Gs(n,r,this),this.pos=n-1,this.writeVarint(r),this.pos+=r},writeMessage:function(e,t,n){this.writeTag(e,Is.Bytes),this.writeRawMessage(t,n)},writePackedVarint:function(e,t){t.length&&this.writeMessage(e,zs,t)},writePackedSVarint:function(e,t){t.length&&this.writeMessage(e,js,t)},writePackedBoolean:function(e,t){t.length&&this.writeMessage(e,Xs,t)},writePackedFloat:function(e,t){t.length&&this.writeMessage(e,Vs,t)},writePackedDouble:function(e,t){t.length&&this.writeMessage(e,Hs,t)},writePackedFixed32:function(e,t){t.length&&this.writeMessage(e,Ws,t)},writePackedSFixed32:function(e,t){t.length&&this.writeMessage(e,Ys,t)},writePackedFixed64:function(e,t){t.length&&this.writeMessage(e,Zs,t)},writePackedSFixed64:function(e,t){t.length&&this.writeMessage(e,qs,t)},writeBytesField:function(e,t){this.writeTag(e,Is.Bytes),this.writeBytes(t)},writeFixed32Field:function(e,t){this.writeTag(e,Is.Fixed32),this.writeFixed32(t)},writeSFixed32Field:function(e,t){this.writeTag(e,Is.Fixed32),this.writeSFixed32(t)},writeFixed64Field:function(e,t){this.writeTag(e,Is.Fixed64),this.writeFixed64(t)},writeSFixed64Field:function(e,t){this.writeTag(e,Is.Fixed64),this.writeSFixed64(t)},writeVarintField:function(e,t){this.writeTag(e,Is.Varint),this.writeVarint(t)},writeSVarintField:function(e,t){this.writeTag(e,Is.Varint),this.writeSVarint(t)},writeStringField:function(e,t){this.writeTag(e,Is.Bytes),this.writeString(t)},writeFloatField:function(e,t){this.writeTag(e,Is.Fixed32),this.writeFloat(t)},writeDoubleField:function(e,t){this.writeTag(e,Is.Fixed64),this.writeDouble(t)},writeBooleanField:function(e,t){this.writeVarintField(e,Boolean(t))}};var Js=Object.defineProperty,eu=Object.defineProperties,tu=Object.getOwnPropertyDescriptors,nu=Object.getOwnPropertySymbols,ru=Object.prototype.hasOwnProperty,iu=Object.prototype.propertyIsEnumerable,ou=function(e,t,n){return t in e?Js(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n},au=function(e,t){for(var n in t||(t={}))ru.call(t,n)&&ou(e,n,t[n]);if(nu){var r,i=y(nu(t));try{for(i.s();!(r=i.n()).done;){n=r.value;iu.call(t,n)&&ou(e,n,t[n])}}catch(o){i.e(o)}finally{i.f()}}return e},su=function(){return c((function e(t,n,r,i){f(this,e),this.vectorLayerCache={},this.x=n,this.y=r,this.z=i,this.vectorTile=new Ls(new ks(t))}),[{key:"getTileData",value:function(e){if(!e||!this.vectorTile.layers[e])return[];if(this.vectorLayerCache[e])return this.vectorLayerCache[e];var t=this.vectorTile.layers[e];if(Array.isArray(t.features))return this.vectorLayerCache[e]=t.features,t.features;for(var n,r,i=[],o=0;o<t.length;o++){var a=t.feature(o).toGeoJSON(this.x,this.y,this.z);i.push((n=au({},a),r={properties:au({id:a.id},a.properties)},eu(n,tu(r))))}return this.vectorLayerCache[e]=i,i}},{key:"getFeatureById",value:function(){throw new Error("Method not implemented.")}}])}(),uu=Object.defineProperty,cu=Object.defineProperties,lu=Object.getOwnPropertyDescriptors,fu=Object.getOwnPropertySymbols,hu=Object.prototype.hasOwnProperty,du=Object.prototype.propertyIsEnumerable,pu=function(e,t,n){return t in e?uu(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n},vu=function(e,t){for(var n in t||(t={}))hu.call(t,n)&&pu(e,n,t[n]);if(fu){var r,i=y(fu(t));try{for(i.s();!(r=i.n()).done;){n=r.value;du.call(t,n)&&pu(e,n,t[n])}}catch(o){i.e(o)}finally{i.f()}}return e},mu=function(e,t){return cu(e,lu(t))},gu={tileSize:256,minZoom:0,maxZoom:1/0,zoomOffset:0,warp:!0},_u=function(e,t,n,r,o){return a=void 0,s=null,u=i().mark((function a(){var s;return i().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return s=Fo(e,t),i.abrupt("return",new Promise((function(e){if(o)o({x:n.x,y:n.y,z:n.z},(function(t,r){if(t||!r)e(void 0);else{var i=new su(r,n.x,n.y,n.z);e(i)}}));else{var t=ut(mu(vu({},r),{url:s}),(function(t,r){if(t||!r)e(void 0);else{var i=new su(r,n.x,n.y,n.z);e(i)}}));n.xhrCancel=function(){return t.cancel()}}})));case 2:case"end":return i.stop()}}),a)})),new Promise((function(e,t){var n=function(e){try{i(u.next(e))}catch(n){t(n)}},r=function(e){try{i(u.throw(e))}catch(n){t(n)}},i=function(t){return t.done?e(t.value):Promise.resolve(t.value).then(n,r)};i((u=u.apply(a,s)).next())}));var a,s,u};function yu(e,t){for(var n=t[0],r=n.width,i=n.height,o=t.map((function(e){return e.rasterData})),a=r*i,s=[],u=JSON.stringify(e),c=0;c<a;c++){var l=JSON.parse(u),f=Eu(l,o,c);if("number"==typeof f)s.push(f);else{var h=bu(l);s.push(h)}}return s}function Eu(e,t,n){if(2===e.length&&"band"===e[0]&&"number"==typeof e[1])try{return t[e[1]][n]}catch(r){return console.warn("Raster Data err!"),0}e.map((function(i,o){if(Array.isArray(i)&&i.length>0)if("band"===i[0])try{e[o]=t[i[1]][n]}catch(r){console.warn("Raster Data err!"),e[o]=0}else Eu(i,t,n)}))}function bu(e){var t=function(e){var t=a(e,3),n=t[0],r=t[1],i=void 0===r?-1:r,o=t[2],s=void 0===o?-1:o;return void 0===n?(console.warn("Express err!"),["+",0,0]):[n.replace(/\s+/g,""),i,s]}(e),n=t[0],r=t[1],i=t[2];return Array.isArray(r)&&(r=bu(e[1])),Array.isArray(i)&&(i=bu(e[2])),function(e,t,n){switch(e){case"+":return t+n;case"-":return t-n;case"*":return t*n;case"/":return t/n;case"%":return t%n;case"^":return Math.pow(t,n);case"abs":return Math.abs(t);case"floor":return Math.floor(t);case"round":return Math.round(t);case"ceil":return Math.ceil(t);case"sin":return Math.sin(t);case"cos":return Math.cos(t);case"atan":return-1===n?Math.atan(t):Math.atan2(t,n);case"min":return Math.min(t,n);case"max":return Math.max(t,n);case"log10":return Math.log(t);case"log2":return Math.log2(t);default:return console.warn("Calculate symbol err! Return default 0"),0}}(n,r,i)}var Au={nd:{type:"operation",expression:["/",["-",["band",1],["band",0]],["+",["band",1],["band",0]]]},rgb:{type:"function",method:function(e,t){for(var n=e[0].rasterData,r=e[1].rasterData,i=e[2].rasterData,o=[],s=a((null==t?void 0:t.countCut)||[2,98],2),u=s[0],c=s[1],l=(null==t?void 0:t.RMinMax)||xu(n,u,c),f=(null==t?void 0:t.GMinMax)||xu(r,u,c),h=(null==t?void 0:t.BMinMax)||xu(i,u,c),d=0;d<n.length;d++)o.push(Math.max(0,n[d]-l[0])),o.push(Math.max(0,r[d]-f[0])),o.push(Math.max(0,i[d]-h[0]));return{rasterData:o,rMinMax:l,gMinMax:f,bMinMax:h}}}};function xu(e,t,n){var r=e.slice().sort((function(e,t){return e-t})),i=r.length;return[r[Math.ceil(i*t/100)],r[Math.ceil(i*n/100)]]}var Su=Object.defineProperty,Tu=Object.defineProperties,Ru=Object.getOwnPropertyDescriptors,Cu=Object.getOwnPropertySymbols,Mu=Object.prototype.hasOwnProperty,wu=Object.prototype.propertyIsEnumerable,Lu=function(e,t,n){return t in e?Su(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n},Ou=function(e,t){for(var n in t||(t={}))Mu.call(t,n)&&Lu(e,n,t[n]);if(Cu){var r,i=y(Cu(t));try{for(i.s();!(r=i.n()).done;){n=r.value;wu.call(t,n)&&Lu(e,n,t[n])}}catch(o){i.e(o)}finally{i.f()}}return e},ku=function(e,t){return Tu(e,Ru(t))},Nu=function(e,t,n){return new Promise((function(r,i){var o=function(e){try{s(n.next(e))}catch(t){i(t)}},a=function(e){try{s(n.throw(e))}catch(t){i(t)}},s=function(e){return e.done?r(e.value):Promise.resolve(e.value).then(o,a)};s((n=n.apply(e,t)).next())}))};function Iu(e,t,n){return Nu(this,null,i().mark((function o(){var a,u,c,l,f,h;return i().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:if(0!==e.length){i.next=2;break}return i.abrupt("return",{rasterData:[0],width:1,heigh:1});case 2:return i.next=4,Promise.all(e.map((function(e){var n=e.data,r=e.bands;return t(n,void 0===r?[0]:r)})));case 4:a=i.sent,u=[],a.forEach((function(e){Array.isArray(e)?u.push.apply(u,r(e)):u.push(e)})),c=u[0],l=c.width,f=c.height,i.t0=s(n),i.next="function"===i.t0?11:"object"===i.t0?13:15;break;case 11:return h=n(u),i.abrupt("break",16);case 13:return h=Array.isArray(n)?{rasterData:yu(n,u)}:Pu(n,u),i.abrupt("break",16);case 15:h={rasterData:u[0].rasterData};case 16:return i.abrupt("return",ku(Ou({},h),{width:l,height:f}));case 17:case"end":return i.stop()}}),o)})))}function Pu(e,t){var n=Au[e.type];return"function"===n.type?n.method(t,null==e?void 0:e.options):"operation"===n.type?"rgb"===e.type?function(e,t){void 0===e.r&&console.warn("Channel R lost in Operation! Use band[0] to fill!");void 0===e.g&&console.warn("Channel G lost in Operation! Use band[0] to fill!");void 0===e.b&&console.warn("Channel B lost in Operation! Use band[0] to fill!");var n=yu(e.r||["band",0],t),r=yu(e.g||["band",0],t),i=yu(e.b||["band",0],t);return[n,r,i]}(n.expression,t):{rasterData:yu(n.expression,t)}:void 0}function Du(e,t,n,r){return Nu(this,null,i().mark((function o(){var a;return i().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return i.next=2,Iu(e,t,n);case 2:a=i.sent,r(null,{data:a});case 4:case"end":return i.stop()}}),o)})))}var Fu=function(e){return e.Normal="normal",e.PostProcessing="post-processing",e}({}),Bu=function(e){return e[e.DEPTH_BUFFER_BIT=256]="DEPTH_BUFFER_BIT",e[e.STENCIL_BUFFER_BIT=1024]="STENCIL_BUFFER_BIT",e[e.COLOR_BUFFER_BIT=16384]="COLOR_BUFFER_BIT",e[e.POINTS=0]="POINTS",e[e.LINES=1]="LINES",e[e.LINE_LOOP=2]="LINE_LOOP",e[e.LINE_STRIP=3]="LINE_STRIP",e[e.TRIANGLES=4]="TRIANGLES",e[e.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",e[e.TRIANGLE_FAN=6]="TRIANGLE_FAN",e[e.ZERO=0]="ZERO",e[e.ONE=1]="ONE",e[e.SRC_COLOR=768]="SRC_COLOR",e[e.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",e[e.SRC_ALPHA=770]="SRC_ALPHA",e[e.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",e[e.DST_ALPHA=772]="DST_ALPHA",e[e.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",e[e.DST_COLOR=774]="DST_COLOR",e[e.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",e[e.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE",e[e.FUNC_ADD=32774]="FUNC_ADD",e[e.BLEND_EQUATION=32777]="BLEND_EQUATION",e[e.BLEND_EQUATION_RGB=32777]="BLEND_EQUATION_RGB",e[e.BLEND_EQUATION_ALPHA=34877]="BLEND_EQUATION_ALPHA",e[e.FUNC_SUBTRACT=32778]="FUNC_SUBTRACT",e[e.FUNC_REVERSE_SUBTRACT=32779]="FUNC_REVERSE_SUBTRACT",e[e.MAX_EXT=32776]="MAX_EXT",e[e.MIN_EXT=32775]="MIN_EXT",e[e.BLEND_DST_RGB=32968]="BLEND_DST_RGB",e[e.BLEND_SRC_RGB=32969]="BLEND_SRC_RGB",e[e.BLEND_DST_ALPHA=32970]="BLEND_DST_ALPHA",e[e.BLEND_SRC_ALPHA=32971]="BLEND_SRC_ALPHA",e[e.CONSTANT_COLOR=32769]="CONSTANT_COLOR",e[e.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",e[e.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",e[e.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",e[e.BLEND_COLOR=32773]="BLEND_COLOR",e[e.ARRAY_BUFFER=34962]="ARRAY_BUFFER",e[e.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER",e[e.ARRAY_BUFFER_BINDING=34964]="ARRAY_BUFFER_BINDING",e[e.ELEMENT_ARRAY_BUFFER_BINDING=34965]="ELEMENT_ARRAY_BUFFER_BINDING",e[e.STREAM_DRAW=35040]="STREAM_DRAW",e[e.STATIC_DRAW=35044]="STATIC_DRAW",e[e.DYNAMIC_DRAW=35048]="DYNAMIC_DRAW",e[e.BUFFER_SIZE=34660]="BUFFER_SIZE",e[e.BUFFER_USAGE=34661]="BUFFER_USAGE",e[e.CURRENT_VERTEX_ATTRIB=34342]="CURRENT_VERTEX_ATTRIB",e[e.FRONT=1028]="FRONT",e[e.BACK=1029]="BACK",e[e.FRONT_AND_BACK=1032]="FRONT_AND_BACK",e[e.CULL_FACE=2884]="CULL_FACE",e[e.BLEND=3042]="BLEND",e[e.DITHER=3024]="DITHER",e[e.STENCIL_TEST=2960]="STENCIL_TEST",e[e.DEPTH_TEST=2929]="DEPTH_TEST",e[e.SCISSOR_TEST=3089]="SCISSOR_TEST",e[e.POLYGON_OFFSET_FILL=32823]="POLYGON_OFFSET_FILL",e[e.SAMPLE_ALPHA_TO_COVERAGE=32926]="SAMPLE_ALPHA_TO_COVERAGE",e[e.SAMPLE_COVERAGE=32928]="SAMPLE_COVERAGE",e[e.NO_ERROR=0]="NO_ERROR",e[e.INVALID_ENUM=1280]="INVALID_ENUM",e[e.INVALID_VALUE=1281]="INVALID_VALUE",e[e.INVALID_OPERATION=1282]="INVALID_OPERATION",e[e.OUT_OF_MEMORY=1285]="OUT_OF_MEMORY",e[e.CW=2304]="CW",e[e.CCW=2305]="CCW",e[e.LINE_WIDTH=2849]="LINE_WIDTH",e[e.ALIASED_POINT_SIZE_RANGE=33901]="ALIASED_POINT_SIZE_RANGE",e[e.ALIASED_LINE_WIDTH_RANGE=33902]="ALIASED_LINE_WIDTH_RANGE",e[e.CULL_FACE_MODE=2885]="CULL_FACE_MODE",e[e.FRONT_FACE=2886]="FRONT_FACE",e[e.DEPTH_RANGE=2928]="DEPTH_RANGE",e[e.DEPTH_WRITEMASK=2930]="DEPTH_WRITEMASK",e[e.DEPTH_CLEAR_VALUE=2931]="DEPTH_CLEAR_VALUE",e[e.DEPTH_FUNC=2932]="DEPTH_FUNC",e[e.STENCIL_CLEAR_VALUE=2961]="STENCIL_CLEAR_VALUE",e[e.STENCIL_FUNC=2962]="STENCIL_FUNC",e[e.STENCIL_FAIL=2964]="STENCIL_FAIL",e[e.STENCIL_PASS_DEPTH_FAIL=2965]="STENCIL_PASS_DEPTH_FAIL",e[e.STENCIL_PASS_DEPTH_PASS=2966]="STENCIL_PASS_DEPTH_PASS",e[e.STENCIL_REF=2967]="STENCIL_REF",e[e.STENCIL_VALUE_MASK=2963]="STENCIL_VALUE_MASK",e[e.STENCIL_WRITEMASK=2968]="STENCIL_WRITEMASK",e[e.STENCIL_BACK_FUNC=34816]="STENCIL_BACK_FUNC",e[e.STENCIL_BACK_FAIL=34817]="STENCIL_BACK_FAIL",e[e.STENCIL_BACK_PASS_DEPTH_FAIL=34818]="STENCIL_BACK_PASS_DEPTH_FAIL",e[e.STENCIL_BACK_PASS_DEPTH_PASS=34819]="STENCIL_BACK_PASS_DEPTH_PASS",e[e.STENCIL_BACK_REF=36003]="STENCIL_BACK_REF",e[e.STENCIL_BACK_VALUE_MASK=36004]="STENCIL_BACK_VALUE_MASK",e[e.STENCIL_BACK_WRITEMASK=36005]="STENCIL_BACK_WRITEMASK",e[e.VIEWPORT=2978]="VIEWPORT",e[e.SCISSOR_BOX=3088]="SCISSOR_BOX",e[e.COLOR_CLEAR_VALUE=3106]="COLOR_CLEAR_VALUE",e[e.COLOR_WRITEMASK=3107]="COLOR_WRITEMASK",e[e.UNPACK_ALIGNMENT=3317]="UNPACK_ALIGNMENT",e[e.PACK_ALIGNMENT=3333]="PACK_ALIGNMENT",e[e.MAX_TEXTURE_SIZE=3379]="MAX_TEXTURE_SIZE",e[e.MAX_VIEWPORT_DIMS=3386]="MAX_VIEWPORT_DIMS",e[e.SUBPIXEL_BITS=3408]="SUBPIXEL_BITS",e[e.RED_BITS=3410]="RED_BITS",e[e.GREEN_BITS=3411]="GREEN_BITS",e[e.BLUE_BITS=3412]="BLUE_BITS",e[e.ALPHA_BITS=3413]="ALPHA_BITS",e[e.DEPTH_BITS=3414]="DEPTH_BITS",e[e.STENCIL_BITS=3415]="STENCIL_BITS",e[e.POLYGON_OFFSET_UNITS=10752]="POLYGON_OFFSET_UNITS",e[e.POLYGON_OFFSET_FACTOR=32824]="POLYGON_OFFSET_FACTOR",e[e.TEXTURE_BINDING_2D=32873]="TEXTURE_BINDING_2D",e[e.SAMPLE_BUFFERS=32936]="SAMPLE_BUFFERS",e[e.SAMPLES=32937]="SAMPLES",e[e.SAMPLE_COVERAGE_VALUE=32938]="SAMPLE_COVERAGE_VALUE",e[e.SAMPLE_COVERAGE_INVERT=32939]="SAMPLE_COVERAGE_INVERT",e[e.COMPRESSED_TEXTURE_FORMATS=34467]="COMPRESSED_TEXTURE_FORMATS",e[e.DONT_CARE=4352]="DONT_CARE",e[e.FASTEST=4353]="FASTEST",e[e.NICEST=4354]="NICEST",e[e.GENERATE_MIPMAP_HINT=33170]="GENERATE_MIPMAP_HINT",e[e.BYTE=5120]="BYTE",e[e.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",e[e.SHORT=5122]="SHORT",e[e.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",e[e.INT=5124]="INT",e[e.UNSIGNED_INT=5125]="UNSIGNED_INT",e[e.FLOAT=5126]="FLOAT",e[e.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",e[e.ALPHA=6406]="ALPHA",e[e.RGB=6407]="RGB",e[e.RGBA=6408]="RGBA",e[e.LUMINANCE=6409]="LUMINANCE",e[e.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",e[e.RED=6403]="RED",e[e.UNSIGNED_SHORT_4_4_4_4=32819]="UNSIGNED_SHORT_4_4_4_4",e[e.UNSIGNED_SHORT_5_5_5_1=32820]="UNSIGNED_SHORT_5_5_5_1",e[e.UNSIGNED_SHORT_5_6_5=33635]="UNSIGNED_SHORT_5_6_5",e[e.FRAGMENT_SHADER=35632]="FRAGMENT_SHADER",e[e.VERTEX_SHADER=35633]="VERTEX_SHADER",e[e.MAX_VERTEX_ATTRIBS=34921]="MAX_VERTEX_ATTRIBS",e[e.MAX_VERTEX_UNIFORM_VECTORS=36347]="MAX_VERTEX_UNIFORM_VECTORS",e[e.MAX_VARYING_VECTORS=36348]="MAX_VARYING_VECTORS",e[e.MAX_COMBINED_TEXTURE_IMAGE_UNITS=35661]="MAX_COMBINED_TEXTURE_IMAGE_UNITS",e[e.MAX_VERTEX_TEXTURE_IMAGE_UNITS=35660]="MAX_VERTEX_TEXTURE_IMAGE_UNITS",e[e.MAX_TEXTURE_IMAGE_UNITS=34930]="MAX_TEXTURE_IMAGE_UNITS",e[e.MAX_FRAGMENT_UNIFORM_VECTORS=36349]="MAX_FRAGMENT_UNIFORM_VECTORS",e[e.SHADER_TYPE=35663]="SHADER_TYPE",e[e.DELETE_STATUS=35712]="DELETE_STATUS",e[e.LINK_STATUS=35714]="LINK_STATUS",e[e.VALIDATE_STATUS=35715]="VALIDATE_STATUS",e[e.ATTACHED_SHADERS=35717]="ATTACHED_SHADERS",e[e.ACTIVE_UNIFORMS=35718]="ACTIVE_UNIFORMS",e[e.ACTIVE_ATTRIBUTES=35721]="ACTIVE_ATTRIBUTES",e[e.SHADING_LANGUAGE_VERSION=35724]="SHADING_LANGUAGE_VERSION",e[e.CURRENT_PROGRAM=35725]="CURRENT_PROGRAM",e[e.NEVER=512]="NEVER",e[e.LESS=513]="LESS",e[e.EQUAL=514]="EQUAL",e[e.LEQUAL=515]="LEQUAL",e[e.GREATER=516]="GREATER",e[e.NOTEQUAL=517]="NOTEQUAL",e[e.GEQUAL=518]="GEQUAL",e[e.ALWAYS=519]="ALWAYS",e[e.KEEP=7680]="KEEP",e[e.REPLACE=7681]="REPLACE",e[e.INCR=7682]="INCR",e[e.DECR=7683]="DECR",e[e.INVERT=5386]="INVERT",e[e.INCR_WRAP=34055]="INCR_WRAP",e[e.DECR_WRAP=34056]="DECR_WRAP",e[e.VENDOR=7936]="VENDOR",e[e.RENDERER=7937]="RENDERER",e[e.VERSION=7938]="VERSION",e[e.NEAREST=9728]="NEAREST",e[e.LINEAR=9729]="LINEAR",e[e.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",e[e.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",e[e.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",e[e.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR",e[e.TEXTURE_MAG_FILTER=10240]="TEXTURE_MAG_FILTER",e[e.TEXTURE_MIN_FILTER=10241]="TEXTURE_MIN_FILTER",e[e.TEXTURE_WRAP_S=10242]="TEXTURE_WRAP_S",e[e.TEXTURE_WRAP_T=10243]="TEXTURE_WRAP_T",e[e.TEXTURE_2D=3553]="TEXTURE_2D",e[e.TEXTURE=5890]="TEXTURE",e[e.TEXTURE_CUBE_MAP=34067]="TEXTURE_CUBE_MAP",e[e.TEXTURE_BINDING_CUBE_MAP=34068]="TEXTURE_BINDING_CUBE_MAP",e[e.TEXTURE_CUBE_MAP_POSITIVE_X=34069]="TEXTURE_CUBE_MAP_POSITIVE_X",e[e.TEXTURE_CUBE_MAP_NEGATIVE_X=34070]="TEXTURE_CUBE_MAP_NEGATIVE_X",e[e.TEXTURE_CUBE_MAP_POSITIVE_Y=34071]="TEXTURE_CUBE_MAP_POSITIVE_Y",e[e.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072]="TEXTURE_CUBE_MAP_NEGATIVE_Y",e[e.TEXTURE_CUBE_MAP_POSITIVE_Z=34073]="TEXTURE_CUBE_MAP_POSITIVE_Z",e[e.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074]="TEXTURE_CUBE_MAP_NEGATIVE_Z",e[e.MAX_CUBE_MAP_TEXTURE_SIZE=34076]="MAX_CUBE_MAP_TEXTURE_SIZE",e[e.TEXTURE0=33984]="TEXTURE0",e[e.TEXTURE1=33985]="TEXTURE1",e[e.TEXTURE2=33986]="TEXTURE2",e[e.TEXTURE3=33987]="TEXTURE3",e[e.TEXTURE4=33988]="TEXTURE4",e[e.TEXTURE5=33989]="TEXTURE5",e[e.TEXTURE6=33990]="TEXTURE6",e[e.TEXTURE7=33991]="TEXTURE7",e[e.TEXTURE8=33992]="TEXTURE8",e[e.TEXTURE9=33993]="TEXTURE9",e[e.TEXTURE10=33994]="TEXTURE10",e[e.TEXTURE11=33995]="TEXTURE11",e[e.TEXTURE12=33996]="TEXTURE12",e[e.TEXTURE13=33997]="TEXTURE13",e[e.TEXTURE14=33998]="TEXTURE14",e[e.TEXTURE15=33999]="TEXTURE15",e[e.TEXTURE16=34e3]="TEXTURE16",e[e.TEXTURE17=34001]="TEXTURE17",e[e.TEXTURE18=34002]="TEXTURE18",e[e.TEXTURE19=34003]="TEXTURE19",e[e.TEXTURE20=34004]="TEXTURE20",e[e.TEXTURE21=34005]="TEXTURE21",e[e.TEXTURE22=34006]="TEXTURE22",e[e.TEXTURE23=34007]="TEXTURE23",e[e.TEXTURE24=34008]="TEXTURE24",e[e.TEXTURE25=34009]="TEXTURE25",e[e.TEXTURE26=34010]="TEXTURE26",e[e.TEXTURE27=34011]="TEXTURE27",e[e.TEXTURE28=34012]="TEXTURE28",e[e.TEXTURE29=34013]="TEXTURE29",e[e.TEXTURE30=34014]="TEXTURE30",e[e.TEXTURE31=34015]="TEXTURE31",e[e.ACTIVE_TEXTURE=34016]="ACTIVE_TEXTURE",e[e.REPEAT=10497]="REPEAT",e[e.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",e[e.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",e[e.FLOAT_VEC2=35664]="FLOAT_VEC2",e[e.FLOAT_VEC3=35665]="FLOAT_VEC3",e[e.FLOAT_VEC4=35666]="FLOAT_VEC4",e[e.INT_VEC2=35667]="INT_VEC2",e[e.INT_VEC3=35668]="INT_VEC3",e[e.INT_VEC4=35669]="INT_VEC4",e[e.BOOL=35670]="BOOL",e[e.BOOL_VEC2=35671]="BOOL_VEC2",e[e.BOOL_VEC3=35672]="BOOL_VEC3",e[e.BOOL_VEC4=35673]="BOOL_VEC4",e[e.FLOAT_MAT2=35674]="FLOAT_MAT2",e[e.FLOAT_MAT3=35675]="FLOAT_MAT3",e[e.FLOAT_MAT4=35676]="FLOAT_MAT4",e[e.SAMPLER_2D=35678]="SAMPLER_2D",e[e.SAMPLER_CUBE=35680]="SAMPLER_CUBE",e[e.VERTEX_ATTRIB_ARRAY_ENABLED=34338]="VERTEX_ATTRIB_ARRAY_ENABLED",e[e.VERTEX_ATTRIB_ARRAY_SIZE=34339]="VERTEX_ATTRIB_ARRAY_SIZE",e[e.VERTEX_ATTRIB_ARRAY_STRIDE=34340]="VERTEX_ATTRIB_ARRAY_STRIDE",e[e.VERTEX_ATTRIB_ARRAY_TYPE=34341]="VERTEX_ATTRIB_ARRAY_TYPE",e[e.VERTEX_ATTRIB_ARRAY_NORMALIZED=34922]="VERTEX_ATTRIB_ARRAY_NORMALIZED",e[e.VERTEX_ATTRIB_ARRAY_POINTER=34373]="VERTEX_ATTRIB_ARRAY_POINTER",e[e.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING=34975]="VERTEX_ATTRIB_ARRAY_BUFFER_BINDING",e[e.COMPILE_STATUS=35713]="COMPILE_STATUS",e[e.LOW_FLOAT=36336]="LOW_FLOAT",e[e.MEDIUM_FLOAT=36337]="MEDIUM_FLOAT",e[e.HIGH_FLOAT=36338]="HIGH_FLOAT",e[e.LOW_INT=36339]="LOW_INT",e[e.MEDIUM_INT=36340]="MEDIUM_INT",e[e.HIGH_INT=36341]="HIGH_INT",e[e.FRAMEBUFFER=36160]="FRAMEBUFFER",e[e.RENDERBUFFER=36161]="RENDERBUFFER",e[e.RGBA4=32854]="RGBA4",e[e.RGB5_A1=32855]="RGB5_A1",e[e.RGB565=36194]="RGB565",e[e.DEPTH_COMPONENT16=33189]="DEPTH_COMPONENT16",e[e.STENCIL_INDEX=6401]="STENCIL_INDEX",e[e.STENCIL_INDEX8=36168]="STENCIL_INDEX8",e[e.DEPTH_STENCIL=34041]="DEPTH_STENCIL",e[e.RENDERBUFFER_WIDTH=36162]="RENDERBUFFER_WIDTH",e[e.RENDERBUFFER_HEIGHT=36163]="RENDERBUFFER_HEIGHT",e[e.RENDERBUFFER_INTERNAL_FORMAT=36164]="RENDERBUFFER_INTERNAL_FORMAT",e[e.RENDERBUFFER_RED_SIZE=36176]="RENDERBUFFER_RED_SIZE",e[e.RENDERBUFFER_GREEN_SIZE=36177]="RENDERBUFFER_GREEN_SIZE",e[e.RENDERBUFFER_BLUE_SIZE=36178]="RENDERBUFFER_BLUE_SIZE",e[e.RENDERBUFFER_ALPHA_SIZE=36179]="RENDERBUFFER_ALPHA_SIZE",e[e.RENDERBUFFER_DEPTH_SIZE=36180]="RENDERBUFFER_DEPTH_SIZE",e[e.RENDERBUFFER_STENCIL_SIZE=36181]="RENDERBUFFER_STENCIL_SIZE",e[e.FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE=36048]="FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE",e[e.FRAMEBUFFER_ATTACHMENT_OBJECT_NAME=36049]="FRAMEBUFFER_ATTACHMENT_OBJECT_NAME",e[e.FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL=36050]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL",e[e.FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE=36051]="FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE",e[e.COLOR_ATTACHMENT0=36064]="COLOR_ATTACHMENT0",e[e.DEPTH_ATTACHMENT=36096]="DEPTH_ATTACHMENT",e[e.STENCIL_ATTACHMENT=36128]="STENCIL_ATTACHMENT",e[e.DEPTH_STENCIL_ATTACHMENT=33306]="DEPTH_STENCIL_ATTACHMENT",e[e.NONE=0]="NONE",e[e.FRAMEBUFFER_COMPLETE=36053]="FRAMEBUFFER_COMPLETE",e[e.FRAMEBUFFER_INCOMPLETE_ATTACHMENT=36054]="FRAMEBUFFER_INCOMPLETE_ATTACHMENT",e[e.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT=36055]="FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT",e[e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS=36057]="FRAMEBUFFER_INCOMPLETE_DIMENSIONS",e[e.FRAMEBUFFER_UNSUPPORTED=36061]="FRAMEBUFFER_UNSUPPORTED",e[e.FRAMEBUFFER_BINDING=36006]="FRAMEBUFFER_BINDING",e[e.RENDERBUFFER_BINDING=36007]="RENDERBUFFER_BINDING",e[e.MAX_RENDERBUFFER_SIZE=34024]="MAX_RENDERBUFFER_SIZE",e[e.INVALID_FRAMEBUFFER_OPERATION=1286]="INVALID_FRAMEBUFFER_OPERATION",e[e.UNPACK_FLIP_Y_WEBGL=37440]="UNPACK_FLIP_Y_WEBGL",e[e.UNPACK_PREMULTIPLY_ALPHA_WEBGL=37441]="UNPACK_PREMULTIPLY_ALPHA_WEBGL",e[e.CONTEXT_LOST_WEBGL=37442]="CONTEXT_LOST_WEBGL",e[e.UNPACK_COLORSPACE_CONVERSION_WEBGL=37443]="UNPACK_COLORSPACE_CONVERSION_WEBGL",e[e.BROWSER_DEFAULT_WEBGL=37444]="BROWSER_DEFAULT_WEBGL",e}({}),Uu=Ni.camelCase,Gu=Ni.isNil,zu=Ni.upperFirst,ju=function(){return c((function e(){f(this,e),ne(this,"shaderModuleService",void 0),ne(this,"rendererService",void 0),ne(this,"config",void 0),ne(this,"quad","attribute vec2 a_Position;\n\nvarying vec2 v_UV;\n\nvoid main() {\n  v_UV = 0.5 * (a_Position + 1.0);\n  gl_Position = vec4(a_Position, 0., 1.);\n}"),ne(this,"enabled",!0),ne(this,"renderToScreen",!1),ne(this,"model",void 0),ne(this,"name",void 0),ne(this,"optionsToUpdate",{})}),[{key:"getName",value:function(){return this.name}},{key:"setName",value:function(e){this.name=e}},{key:"getType",value:function(){return Fu.PostProcessing}},{key:"init",value:function(e,t){this.config=t,this.rendererService=e.getContainer().rendererService,this.shaderModuleService=e.getContainer().shaderModuleService;var n=this.rendererService,r=n.createAttribute,i=n.createBuffer,o=n.createModel,a=this.setupShaders(),s=a.vs,u=a.fs,c=a.uniforms;this.model=o({vs:s,fs:u,attributes:{a_Position:r({buffer:i({data:[-4,-4,4,-4,0,4],type:Bu.FLOAT}),size:2})},uniforms:re(re({u_Texture:null},c),this.config&&this.convertOptionsToUniforms(this.config)),depth:{enable:!1},count:3,blend:{enable:"copy"===this.getName()}})}},{key:"render",value:function(e,t){var n=this,r=e.multiPassRenderer.getPostProcessor(),i=this.rendererService,o=i.useFramebuffer,a=i.getViewportSize,s=i.clear,u=a(),c=u.width,l=u.height;o(this.renderToScreen?null:r.getWriteFBO(),(function(){s({framebuffer:r.getWriteFBO(),color:[0,0,0,0],depth:1,stencil:0});var e=re({u_BloomFinal:0,u_Texture:r.getReadFBO(),u_ViewportSize:[c,l]},n.convertOptionsToUniforms(n.optionsToUpdate));t&&(e.u_BloomFinal=1,e.u_Texture2=t),n.model.draw({uniforms:e})}))}},{key:"isEnabled",value:function(){return this.enabled}},{key:"setEnabled",value:function(e){this.enabled=e}},{key:"setRenderToScreen",value:function(e){this.renderToScreen=e}},{key:"updateOptions",value:function(e){this.optionsToUpdate=re(re({},this.optionsToUpdate),e)}},{key:"setupShaders",value:function(){throw new Error("Method not implemented.")}},{key:"convertOptionsToUniforms",value:function(e){var t={};return Object.keys(e).forEach((function(n){Gu(e[n])||(t["u_".concat(zu(Uu(n)))]=e[n])})),t}}])}();var Vu=/uniform\s+(bool|float|int|vec2|vec3|vec4|ivec2|ivec3|ivec4|mat2|mat3|mat4|sampler2D|samplerCube)\s+([\s\S]*?);/g;function Hu(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n={};return e=e.replace(Vu,(function(e,r,i){var o=i.split(":"),a=o[0].trim(),s="";switch(o.length>1&&(s=o[1].trim()),r){case"bool":s="true"===s;break;case"float":case"int":s=Number(s);break;case"vec2":case"vec3":case"vec4":case"ivec2":case"ivec3":case"ivec4":case"mat2":case"mat3":case"mat4":s=s?s.replace("[","").replace("]","").split(",").reduce((function(e,t){return e.push(Number(t.trim())),e}),[]):new Array(function(e){var t=0;switch(e){case"vec2":case"ivec2":t=2;break;case"vec3":case"ivec3":t=3;break;case"vec4":case"ivec4":case"mat2":t=4;break;case"mat3":t=9;break;case"mat4":t=16}return t}(r)).fill(0)}return n[a]=s,"".concat(t?"uniform ":"").concat(r," ").concat(a,";\n")})),{content:e,uniforms:n}}function Xu(e){var t=Hu(e,!0),n=t.content,r=t.uniforms;return{content:n=n.replace(/(\s*uniform\s*.*\s*){((?:\s*.*\s*)*?)};/g,(function(e,t,n){var i=Hu(n=n.trim().replace(/^.*$/gm,(function(e){return"uniform ".concat(e)}))),o=i.content,a=i.uniforms;return Object.assign(r,a),"".concat(t,"{\n").concat(o,"\n};")})),uniforms:r}}function Wu(e){var t={};return e.replace(Vu,(function(e,n,r){var i=r.trim();return t[i]?"":(t[i]=!0,"uniform ".concat(n," ").concat(i,";\n"))}))}var Yu="u_ProjectionMatrix",Zu="u_ViewMatrix",qu="u_ViewProjectionMatrix",Ku="u_Zoom",Qu="u_ZoomScale",$u="u_FocalDistance",Ju="u_CameraPosition",ec=function(e){return e.TOPRIGHT="topright",e.TOPLEFT="topleft",e.BOTTOMRIGHT="bottomright",e.BOTTOMLEFT="bottomleft",e.TOPCENTER="topcenter",e.BOTTOMCENTER="bottomcenter",e.LEFTCENTER="leftcenter",e.RIGHTCENTER="rightcenter",e.LEFTTOP="lefttop",e.RIGHTTOP="righttop",e.LEFTBOTTOM="leftbottom",e.RIGHTBOTTOM="rightbottom",e}({}),tc=function(e){return e[e.LNGLAT=1]="LNGLAT",e[e.LNGLAT_OFFSET=2]="LNGLAT_OFFSET",e[e.VECTOR_TILE=3]="VECTOR_TILE",e[e.IDENTITY=4]="IDENTITY",e[e.P20=5]="P20",e[e.P20_OFFSET=6]="P20_OFFSET",e[e.METER_OFFSET=7]="METER_OFFSET",e[e.P20_2=8]="P20_2",e}({}),nc="u_CoordinateSystem",rc="u_ViewportCenter",ic="u_ViewportCenterProjection",oc="u_PixelsPerDegree",ac="u_PixelsPerDegree2",sc="u_PixelsPerMeter",uc="u_Mvp",cc="layerInitStart",lc="layerInitEnd",fc="sourceInitStart",hc="sourceInitEnd",dc="scaleInitStart",pc="scaleInitEnd",vc="mappingStart",mc="mappingEnd",gc="buildModelStart",_c="buildModelEnd",yc=function(e){return e.Hover="hover",e.Click="click",e.Select="select",e.Active="active",e.Drag="drag",e}({}),Ec=function(e){return e.normal="normal",e.additive="additive",e.subtractive="subtractive",e.min="min",e.max="max",e.none="none",e}({}),bc=function(e){return e.MULTIPLE="MULTIPLE",e.SINGLE="SINGLE",e}({}),Ac=function(e){return e.AND="and",e.OR="or",e}({}),xc=function(e){return e.INIT="init",e.UPDATE="update",e}({}),Sc=function(e){return e.LINEAR="linear",e.SEQUENTIAL="sequential",e.POWER="power",e.LOG="log",e.IDENTITY="identity",e.TIME="time",e.QUANTILE="quantile",e.QUANTIZE="quantize",e.THRESHOLD="threshold",e.CAT="cat",e.DIVERGING="diverging",e.CUSTOM="threshold",e}({}),Tc=function(e){return e.CONSTANT="constant",e.VARIABLE="variable",e}({}),Rc=function(e){return e[e.Attribute=0]="Attribute",e[e.InstancedAttribute=1]="InstancedAttribute",e[e.Uniform=2]="Uniform",e}({}),Cc=["mapload","mapchange","mapAfterFrameChange"],Mc={exports:{}};Mc.exports=Lc,Mc.exports.default=Lc;var wc=1e20;function Lc(e,t,n,r,i,o){this.fontSize=e||24,this.buffer=void 0===t?3:t,this.cutoff=r||.25,this.fontFamily=i||"sans-serif",this.fontWeight=o||"normal",this.radius=n||8;var a=this.size=this.fontSize+2*this.buffer,s=a+2*this.buffer;this.canvas=document.createElement("canvas"),this.canvas.width=this.canvas.height=a,this.ctx=this.canvas.getContext("2d"),this.ctx.font=this.fontWeight+" "+this.fontSize+"px "+this.fontFamily,this.ctx.textAlign="left",this.ctx.fillStyle="black",this.gridOuter=new Float64Array(s*s),this.gridInner=new Float64Array(s*s),this.f=new Float64Array(s),this.z=new Float64Array(s+1),this.v=new Uint16Array(s),this.useMetrics=void 0!==this.ctx.measureText("A").actualBoundingBoxLeft,this.middle=Math.round(a/2*(navigator.userAgent.indexOf("Gecko/")>=0?1.2:1))}function Oc(e,t,n,r,i,o){for(var a=0;a<t;a++)kc(e,a,t,n,r,i,o);for(var s=0;s<n;s++)kc(e,s*t,1,t,r,i,o)}function kc(e,t,n,r,i,o,a){var s,u,c,l;for(o[0]=0,a[0]=-wc,a[1]=wc,s=0;s<r;s++)i[s]=e[t+s*n];for(s=1,u=0,c=0;s<r;s++){do{l=o[u],c=(i[s]-i[l]+s*s-l*l)/(s-l)/2}while(c<=a[u]&&--u>-1);o[++u]=s,a[u]=c,a[u+1]=wc}for(s=0,u=0;s<r;s++){for(;a[u+1]<s;)u++;l=o[u],e[t+s*n]=i[l]+(s-l)*(s-l)}}Lc.prototype._draw=function(e,t){var n,r,i,o,a,s,u,c,l,f=this.ctx.measureText(e),h=f.width,d=2*this.buffer;t&&this.useMetrics?(a=Math.floor(f.actualBoundingBoxAscent),c=this.buffer+Math.ceil(f.actualBoundingBoxAscent),s=this.buffer,u=this.buffer,n=(r=Math.min(this.size,Math.ceil(f.actualBoundingBoxRight-f.actualBoundingBoxLeft)))+d,i=(o=Math.min(this.size-s,Math.ceil(f.actualBoundingBoxAscent+f.actualBoundingBoxDescent)))+d,this.ctx.textBaseline="alphabetic"):(n=r=this.size,i=o=this.size,a=19*this.fontSize/24,s=u=0,c=this.middle,this.ctx.textBaseline="middle"),r&&o&&(this.ctx.clearRect(u,s,r,o),this.ctx.fillText(e,this.buffer,c),l=this.ctx.getImageData(u,s,r,o));var p=new Uint8ClampedArray(n*i);return function(e,t,n,r,i,o,a){o.fill(wc,0,t*n),a.fill(0,0,t*n);for(var s=(t-r)/2,u=0;u<i;u++)for(var c=0;c<r;c++){var l=(u+s)*t+c+s,f=e.data[4*(u*r+c)+3]/255;if(1===f)o[l]=0,a[l]=wc;else if(0===f)o[l]=wc,a[l]=0;else{var h=Math.max(0,.5-f),d=Math.max(0,f-.5);o[l]=h*h,a[l]=d*d}}}(l,n,i,r,o,this.gridOuter,this.gridInner),Oc(this.gridOuter,n,i,this.f,this.v,this.z),Oc(this.gridInner,n,i,this.f,this.v,this.z),function(e,t,n,r,i,o,a){for(var s=0;s<t*n;s++){var u=Math.sqrt(r[s])-Math.sqrt(i[s]);e[s]=Math.round(255-255*(u/o+a))}}(p,n,i,this.gridOuter,this.gridInner,this.radius,this.cutoff),{data:p,metrics:{width:r,height:o,sdfWidth:n,sdfHeight:i,top:a,left:0,advance:h}}},Lc.prototype.draw=function(e){return this._draw(e,!1).data},Lc.prototype.drawWithMetrics=function(e){return this._draw(e,!0)};function Nc(e,t,n){var r,i=y(t);try{for(i.s();!(r=i.n()).done;){var o=r.value,a=o.icon,s=o.xOffset;e[a.id]=re(re({},a),{},{x:s,y:n,image:a.image,width:a.width,height:a.height})}}catch(u){i.e(u)}finally{i.f()}}function Ic(e){return Math.pow(2,Math.ceil(Math.log2(e)))}var Pc=function(){for(var e=[],t=32;t<128;t++)e.push(String.fromCharCode(t));return e}();function Dc(e,t,n,r){e.font="".concat(r," ").concat(n,"px ").concat(t),e.fillStyle="black",e.textBaseline="middle"}function Fc(e,t){for(var n=0;n<e.length;n++)t.data[4*n+3]=e[n]}var Bc=function(e){function t(){var e;f(this,t);for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];return e=h(this,t,[].concat(r)),ne(e,"fontAtlas",void 0),ne(e,"iconFontMap",void 0),ne(e,"iconFontGlyphs",{}),ne(e,"fontOptions",void 0),ne(e,"key",void 0),ne(e,"cache",new oo(3)),e}return d(t,e),c(t,[{key:"scale",get:function(){return 1}},{key:"canvas",get:function(){var e=this.cache.get(this.key);return e&&e.data}},{key:"mapping",get:function(){var e=this.cache.get(this.key);return e&&e.mapping||{}}},{key:"getCanvasByKey",value:function(e){var t=this.cache.get(e);return t&&t.data}},{key:"getMappingByKey",value:function(e){var t=this.cache.get(e);return t&&t.mapping||{}}},{key:"init",value:function(){this.cache.clear(),this.fontOptions={fontFamily:"sans-serif",fontWeight:"normal",characterSet:Pc,fontSize:24,buffer:3,sdf:!0,cutoff:.25,radius:8,iconfont:!1},this.key="",this.iconFontMap=new Map}},{key:"addIconGlyphs",value:function(e){var t=this;e.forEach((function(e){t.iconFontGlyphs[e.name]=e.unicode}))}},{key:"addIconFont",value:function(e,t){this.iconFontMap.set(e,t)}},{key:"getIconFontKey",value:function(e){return this.iconFontMap.get(e)||e}},{key:"getGlyph",value:function(e){return this.iconFontGlyphs[e]?String.fromCharCode(parseInt(this.iconFontGlyphs[e],16)):""}},{key:"setFontOptions",value:function(e){this.fontOptions=re(re({},this.fontOptions),e),this.key=this.getKey();var t=this.getNewChars(this.key,this.fontOptions.characterSet),n=this.cache.get(this.key);if(!n||0!==t.length){var r=this.generateFontAtlas(this.key,t,n);this.fontAtlas=r,this.cache.set(this.key,r)}}},{key:"addFontFace",value:function(e,t){var n=this,r=document.createElement("style");r.type="text/css",r.innerText="\n        @font-face{\n            font-family: '".concat(e,"';\n            src: url('").concat(t,"') format('woff2'),\n            url('").concat(t,"') format('woff'),\n            url('").concat(t,"') format('truetype');\n        }"),r.onload=function(){if(document.fonts)try{document.fonts.load("24px ".concat(e),"L7text"),document.fonts.ready.then((function(){n.emit("fontloaded",{fontFamily:e})}))}catch(t){console.warn("当前环境不支持 document.fonts !"),console.warn("当前环境不支持 iconfont !"),console.warn(t)}},document.getElementsByTagName("head")[0].appendChild(r)}},{key:"destroy",value:function(){this.cache.clear(),this.iconFontMap.clear()}},{key:"generateFontAtlas",value:function(e,t,n){var r=this.fontOptions,i=r.fontFamily,o=r.fontWeight,a=r.fontSize,s=r.buffer,u=r.sdf,c=r.radius,l=r.cutoff,f=r.iconfont,h=n&&n.data;h||((h=window.document.createElement("canvas")).width=1024);var d=h.getContext("2d",{willReadFrequently:!0});Dc(d,i,a,o);var p=function(e){var t=e.characterSet,n=e.getFontWidth,r=e.fontHeight,i=e.buffer,o=e.maxCanvasWidth,a=e.mapping,s=void 0===a?{}:a,u=e.xOffset,c=void 0===u?0:u,l=e.yOffset,f=void 0===l?0:l,h=0,d=c;Array.from(t).forEach((function(e,t){if(!s[e]){var r=n(e,t);d+30>o&&(d=0,h++),s[e]={x:d,y:f+30*h,width:30,height:30,advance:r},d+=30}}));var p=r+2*i;return{mapping:s,xOffset:d,yOffset:f+h*p,canvasHeight:Ic(f+(h+1)*p)}}(re({getFontWidth:function(e){return d.measureText(e).width},fontHeight:1*a,buffer:s,characterSet:t,maxCanvasWidth:1024},n&&{mapping:n.mapping,xOffset:n.xOffset,yOffset:n.yOffset})),v=p.mapping,m=p.canvasHeight,g=p.xOffset,_=p.yOffset,E=d.getImageData(0,0,h.width,h.height);if(h.height=m,d.putImageData(E,0,0),Dc(d,i,a,o),u){var b,A=new Mc.exports(a,s,c,l,i,o),x=d.getImageData(0,0,A.size,A.size),S=y(t);try{for(S.s();!(b=S.n()).done;){var T=b.value;if(f){var R=String.fromCharCode(parseInt(T.replace("&#x","").replace(";",""),16));Fc(A.draw(R),x)}else Fc(A.draw(T),x);d.putImageData(x,v[T].x,v[T].y)}}catch(L){S.e(L)}finally{S.f()}}else{var C,M=y(t);try{for(M.s();!(C=M.n()).done;){var w=C.value;d.fillText(w,v[w].x,v[w].y+1*a)}}catch(L){M.e(L)}finally{M.f()}}return{xOffset:g,yOffset:_,mapping:v,data:h,width:h.width,height:h.height}}},{key:"getKey",value:function(){var e=this.fontOptions,t=e.fontFamily,n=e.fontWeight;return"".concat(t,"_").concat(n)}},{key:"getNewChars",value:function(e,t){var n=this.cache.get(e);if(!n)return t;var r=[],i=n.mapping,o=new Set(Object.keys(i));return new Set(t).forEach((function(e){o.has(e)||r.push(e)})),r}}])}(lo.exports.EventEmitter),Uc=function(e){function t(){var e;f(this,t);for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];return e=h(this,t,[].concat(r)),ne(e,"canvasHeight",128),ne(e,"texture",void 0),ne(e,"canvas",void 0),ne(e,"iconData",void 0),ne(e,"iconMap",void 0),ne(e,"ctx",void 0),ne(e,"loadingImageCount",0),e}return d(t,e),c(t,[{key:"isLoading",value:function(){return 0===this.loadingImageCount}},{key:"init",value:function(){this.iconData=[],this.iconMap={},this.canvas=window.document.createElement("canvas"),this.canvas.width=128,this.canvas.height=128,this.ctx=this.canvas.getContext("2d")}},{key:"addImage",value:function(e,t){var n=this;return ie(i().mark((function r(){var o,a;return i().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return o=new Image,n.loadingImageCount++,n.hasImage(e)?console.warn("Image Id already exists"):n.iconData.push({id:e,size:64}),n.updateIconMap(),r.next=6,n.loadImage(t);case 6:o=r.sent,(a=n.iconData.find((function(t){return t.id===e})))&&(a.image=o,a.width=o.width,a.height=o.height),n.update();case 10:case"end":return r.stop()}}),r)})))()}},{key:"addImageMini",value:function(e,t,n){var r=this,i=n.getSceneConfig().canvas,o=i.createImage();if(this.loadingImageCount++,this.hasImage(e))throw new Error("Image Id already exists");this.iconData.push({id:e,size:64}),this.updateIconMap(),this.loadImageMini(t,i).then((function(t){o=t;var n=r.iconData.find((function(t){return t.id===e}));n&&(n.image=o,n.width=o.width,n.height=o.height),r.update()}))}},{key:"getTexture",value:function(){return this.texture}},{key:"getIconMap",value:function(){return this.iconMap}},{key:"getCanvas",value:function(){return this.canvas}},{key:"hasImage",value:function(e){return this.iconMap.hasOwnProperty(e)}},{key:"removeImage",value:function(e){this.hasImage(e)&&(this.iconData=this.iconData.filter((function(t){return t.id!==e})),delete this.iconMap[e],this.update())}},{key:"destroy",value:function(){this.removeAllListeners("imageUpdate"),this.iconData=[],this.iconMap={}}},{key:"loadImage",value:function(e){return new Promise((function(t,n){if(e instanceof HTMLImageElement)t(e);else{var r=new Image;r.crossOrigin="anonymous",r.onload=function(){t(r)},r.onerror=function(){n(new Error("Could not load image at "+e))},r.src=e instanceof File?URL.createObjectURL(e):e}}))}},{key:"update",value:function(){this.updateIconMap(),this.updateIconAtlas(),this.loadingImageCount--,0===this.loadingImageCount&&this.emit("imageUpdate")}},{key:"updateIconAtlas",value:function(){var e=this;this.canvas.width=1024,this.canvas.height=this.canvasHeight,Object.keys(this.iconMap).forEach((function(t){var n=e.iconMap[t],r=n.x,i=n.y,o=n.image,a=n.width,s=void 0===a?64:a,u=n.height,c=void 0===u?64:u,l=Math.max(s,c)/64,f=c/l,h=s/l;o&&e.ctx.drawImage(o,r+(64-h)/2,i+(64-f)/2,h,f)}))}},{key:"updateIconMap",value:function(){var e=function(e,t,n){var r,i=0,o=0,a=0,s=[],u={},c=y(e);try{for(c.s();!(r=c.n()).done;){var l=r.value;if(!u[l.id]){var f=l.size;i+f+t>n&&(Nc(u,s,o),i=0,o=a+o+t,a=0,s=[]),s.push({icon:l,xOffset:i}),i=i+f+t,a=Math.max(a,f)}}}catch(h){c.e(h)}finally{c.f()}return s.length>0&&Nc(u,s,o),{mapping:u,canvasHeight:Ic(a+o+t)}}(this.iconData,3,1024),t=e.mapping,n=e.canvasHeight;this.iconMap=t,this.canvasHeight=n}},{key:"loadImageMini",value:function(e,t){return new Promise((function(n,r){var i=t.createImage();i.crossOrigin="anonymous",i.onload=function(){n(i)},i.onerror=function(){r(new Error("Could not load image at "+e))},i.src=e}))}}])}(lo.exports.EventEmitter),Gc=1e-6,zc="undefined"!=typeof Float32Array?Float32Array:Array;function jc(){var e=new zc(16);return zc!=Float32Array&&(e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=0,e[12]=0,e[13]=0,e[14]=0),e[0]=1,e[5]=1,e[10]=1,e[15]=1,e}function Vc(e,t,n,r,i,o,a,s,u,c,l,f,h,d,p,v){var m=new zc(16);return m[0]=e,m[1]=t,m[2]=n,m[3]=r,m[4]=i,m[5]=o,m[6]=a,m[7]=s,m[8]=u,m[9]=c,m[10]=l,m[11]=f,m[12]=h,m[13]=d,m[14]=p,m[15]=v,m}function Hc(e,t){var n=t[0],r=t[1],i=t[2],o=t[3],a=t[4],s=t[5],u=t[6],c=t[7],l=t[8],f=t[9],h=t[10],d=t[11],p=t[12],v=t[13],m=t[14],g=t[15],_=n*s-r*a,y=n*u-i*a,E=n*c-o*a,b=r*u-i*s,A=r*c-o*s,x=i*c-o*u,S=l*v-f*p,T=l*m-h*p,R=l*g-d*p,C=f*m-h*v,M=f*g-d*v,w=h*g-d*m,L=_*w-y*M+E*C+b*R-A*T+x*S;return L?(L=1/L,e[0]=(s*w-u*M+c*C)*L,e[1]=(i*M-r*w-o*C)*L,e[2]=(v*x-m*A+g*b)*L,e[3]=(h*A-f*x-d*b)*L,e[4]=(u*R-a*w-c*T)*L,e[5]=(n*w-i*R+o*T)*L,e[6]=(m*E-p*x-g*y)*L,e[7]=(l*x-h*E+d*y)*L,e[8]=(a*M-s*R+c*S)*L,e[9]=(r*R-n*M-o*S)*L,e[10]=(p*A-v*E+g*_)*L,e[11]=(f*E-l*A-d*_)*L,e[12]=(s*T-a*C-u*S)*L,e[13]=(n*C-r*T+i*S)*L,e[14]=(v*y-p*b-m*_)*L,e[15]=(l*b-f*y+h*_)*L,e):null}function Xc(e,t,n){var r=t[0],i=t[1],o=t[2],a=t[3],s=t[4],u=t[5],c=t[6],l=t[7],f=t[8],h=t[9],d=t[10],p=t[11],v=t[12],m=t[13],g=t[14],_=t[15],y=n[0],E=n[1],b=n[2],A=n[3];return e[0]=y*r+E*s+b*f+A*v,e[1]=y*i+E*u+b*h+A*m,e[2]=y*o+E*c+b*d+A*g,e[3]=y*a+E*l+b*p+A*_,y=n[4],E=n[5],b=n[6],A=n[7],e[4]=y*r+E*s+b*f+A*v,e[5]=y*i+E*u+b*h+A*m,e[6]=y*o+E*c+b*d+A*g,e[7]=y*a+E*l+b*p+A*_,y=n[8],E=n[9],b=n[10],A=n[11],e[8]=y*r+E*s+b*f+A*v,e[9]=y*i+E*u+b*h+A*m,e[10]=y*o+E*c+b*d+A*g,e[11]=y*a+E*l+b*p+A*_,y=n[12],E=n[13],b=n[14],A=n[15],e[12]=y*r+E*s+b*f+A*v,e[13]=y*i+E*u+b*h+A*m,e[14]=y*o+E*c+b*d+A*g,e[15]=y*a+E*l+b*p+A*_,e}function Wc(e,t,n){var r,i,o,a,s,u,c,l,f,h,d,p,v=n[0],m=n[1],g=n[2];return t===e?(e[12]=t[0]*v+t[4]*m+t[8]*g+t[12],e[13]=t[1]*v+t[5]*m+t[9]*g+t[13],e[14]=t[2]*v+t[6]*m+t[10]*g+t[14],e[15]=t[3]*v+t[7]*m+t[11]*g+t[15]):(r=t[0],i=t[1],o=t[2],a=t[3],s=t[4],u=t[5],c=t[6],l=t[7],f=t[8],h=t[9],d=t[10],p=t[11],e[0]=r,e[1]=i,e[2]=o,e[3]=a,e[4]=s,e[5]=u,e[6]=c,e[7]=l,e[8]=f,e[9]=h,e[10]=d,e[11]=p,e[12]=r*v+s*m+f*g+t[12],e[13]=i*v+u*m+h*g+t[13],e[14]=o*v+c*m+d*g+t[14],e[15]=a*v+l*m+p*g+t[15]),e}function Yc(e,t,n){var r=n[0],i=n[1],o=n[2];return e[0]=t[0]*r,e[1]=t[1]*r,e[2]=t[2]*r,e[3]=t[3]*r,e[4]=t[4]*i,e[5]=t[5]*i,e[6]=t[6]*i,e[7]=t[7]*i,e[8]=t[8]*o,e[9]=t[9]*o,e[10]=t[10]*o,e[11]=t[11]*o,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function Zc(e,t,n){var r=Math.sin(n),i=Math.cos(n),o=t[4],a=t[5],s=t[6],u=t[7],c=t[8],l=t[9],f=t[10],h=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=o*i+c*r,e[5]=a*i+l*r,e[6]=s*i+f*r,e[7]=u*i+h*r,e[8]=c*i-o*r,e[9]=l*i-a*r,e[10]=f*i-s*r,e[11]=h*i-u*r,e}function qc(e,t,n){var r=Math.sin(n),i=Math.cos(n),o=t[0],a=t[1],s=t[2],u=t[3],c=t[8],l=t[9],f=t[10],h=t[11];return t!==e&&(e[4]=t[4],e[5]=t[5],e[6]=t[6],e[7]=t[7],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=o*i-c*r,e[1]=a*i-l*r,e[2]=s*i-f*r,e[3]=u*i-h*r,e[8]=o*r+c*i,e[9]=a*r+l*i,e[10]=s*r+f*i,e[11]=u*r+h*i,e}function Kc(e,t,n){var r=Math.sin(n),i=Math.cos(n),o=t[0],a=t[1],s=t[2],u=t[3],c=t[4],l=t[5],f=t[6],h=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=o*i+c*r,e[1]=a*i+l*r,e[2]=s*i+f*r,e[3]=u*i+h*r,e[4]=c*i-o*r,e[5]=l*i-a*r,e[6]=f*i-s*r,e[7]=h*i-u*r,e}Math.hypot||(Math.hypot=function(){for(var e=0,t=arguments.length;t--;)e+=arguments[t]*arguments[t];return Math.sqrt(e)});var Qc=function(e,t,n,r,i){var o,a=1/Math.tan(t/2);return e[0]=a/n,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=i&&i!==1/0?(o=1/(r-i),e[10]=(i+r)*o,e[14]=2*i*r*o):(e[10]=-1,e[14]=-2*r),e};function $c(e,t){var n=e[0],r=e[1],i=e[2],o=e[3],a=e[4],s=e[5],u=e[6],c=e[7],l=e[8],f=e[9],h=e[10],d=e[11],p=e[12],v=e[13],m=e[14],g=e[15],_=t[0],y=t[1],E=t[2],b=t[3],A=t[4],x=t[5],S=t[6],T=t[7],R=t[8],C=t[9],M=t[10],w=t[11],L=t[12],O=t[13],k=t[14],N=t[15];return Math.abs(n-_)<=Gc*Math.max(1,Math.abs(n),Math.abs(_))&&Math.abs(r-y)<=Gc*Math.max(1,Math.abs(r),Math.abs(y))&&Math.abs(i-E)<=Gc*Math.max(1,Math.abs(i),Math.abs(E))&&Math.abs(o-b)<=Gc*Math.max(1,Math.abs(o),Math.abs(b))&&Math.abs(a-A)<=Gc*Math.max(1,Math.abs(a),Math.abs(A))&&Math.abs(s-x)<=Gc*Math.max(1,Math.abs(s),Math.abs(x))&&Math.abs(u-S)<=Gc*Math.max(1,Math.abs(u),Math.abs(S))&&Math.abs(c-T)<=Gc*Math.max(1,Math.abs(c),Math.abs(T))&&Math.abs(l-R)<=Gc*Math.max(1,Math.abs(l),Math.abs(R))&&Math.abs(f-C)<=Gc*Math.max(1,Math.abs(f),Math.abs(C))&&Math.abs(h-M)<=Gc*Math.max(1,Math.abs(h),Math.abs(M))&&Math.abs(d-w)<=Gc*Math.max(1,Math.abs(d),Math.abs(w))&&Math.abs(p-L)<=Gc*Math.max(1,Math.abs(p),Math.abs(L))&&Math.abs(v-O)<=Gc*Math.max(1,Math.abs(v),Math.abs(O))&&Math.abs(m-k)<=Gc*Math.max(1,Math.abs(m),Math.abs(k))&&Math.abs(g-N)<=Gc*Math.max(1,Math.abs(g),Math.abs(N))}function Jc(){var e=new zc(3);return zc!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e}function el(e,t,n){var r=new zc(3);return r[0]=e,r[1]=t,r[2]=n,r}function tl(e,t){var n=t[0],r=t[1],i=t[2],o=n*n+r*r+i*i;return o>0&&(o=1/Math.sqrt(o)),e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o,e}function nl(e,t,n){var r=t[0],i=t[1],o=t[2],a=n[3]*r+n[7]*i+n[11]*o+n[15];return a=a||1,e[0]=(n[0]*r+n[4]*i+n[8]*o+n[12])/a,e[1]=(n[1]*r+n[5]*i+n[9]*o+n[13])/a,e[2]=(n[2]*r+n[6]*i+n[10]*o+n[14])/a,e}function rl(e,t){var n=e[0],r=e[1],i=e[2],o=t[0],a=t[1],s=t[2],u=Math.sqrt(n*n+r*r+i*i)*Math.sqrt(o*o+a*a+s*s),c=u&&function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}(e,t)/u;return Math.acos(Math.min(Math.max(c,-1),1))}var il=function(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e[2]=t[2]-n[2],e};function ol(){var e=new zc(4);return zc!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0,e[3]=0),e}function al(e,t,n){var r=t[0],i=t[1],o=t[2],a=t[3];return e[0]=n[0]*r+n[4]*i+n[8]*o+n[12]*a,e[1]=n[1]*r+n[5]*i+n[9]*o+n[13]*a,e[2]=n[2]*r+n[6]*i+n[10]*o+n[14]*a,e[3]=n[3]*r+n[7]*i+n[11]*o+n[15]*a,e}function sl(){var e=new zc(2);return zc!=Float32Array&&(e[0]=0,e[1]=0),e}function ul(e,t){var n=new zc(2);return n[0]=e,n[1]=t,n}function cl(e,t){return e[0]=t[0],e[1]=t[1],e}function ll(e,t,n){return e[0]=t[0]+n[0],e[1]=t[1]+n[1],e}function fl(e,t,n){return e[0]=t[0]-n[0],e[1]=t[1]-n[1],e}function hl(e,t){var n=t[0],r=t[1],i=n*n+r*r;return i>0&&(i=1/Math.sqrt(i)),e[0]=t[0]*i,e[1]=t[1]*i,e}function dl(e,t){return e[0]*t[0]+e[1]*t[1]}!function(){var e=Jc()}(),function(){var e=ol()}();var pl=fl;!function(){var e=sl()}();var vl=function(){return c((function e(){f(this,e),ne(this,"viewport",void 0),ne(this,"overridedViewProjectionMatrix",void 0),ne(this,"jitteredViewProjectionMatrix",void 0),ne(this,"jitteredProjectionMatrix",void 0),ne(this,"viewMatrixInverse",void 0),ne(this,"cameraPosition",void 0)}),[{key:"init",value:function(){}},{key:"update",value:function(e){this.viewport=e,this.viewMatrixInverse=jc(),Hc(this.viewMatrixInverse,e.getViewMatrix()),this.cameraPosition=[this.viewMatrixInverse[12],this.viewMatrixInverse[13],this.viewMatrixInverse[14]]}},{key:"getProjectionMatrix",value:function(){return this.jitteredProjectionMatrix||this.viewport.getProjectionMatrix()}},{key:"getModelMatrix",value:function(){return this.viewport.getModelMatrix()}},{key:"getViewMatrix",value:function(){return this.viewport.getViewMatrix()}},{key:"getViewMatrixUncentered",value:function(){return this.viewport.getViewMatrixUncentered()}},{key:"getViewProjectionMatrixUncentered",value:function(){return this.viewport.getViewProjectionMatrixUncentered()}},{key:"getViewProjectionMatrix",value:function(){return this.overridedViewProjectionMatrix||this.jitteredViewProjectionMatrix||this.viewport.getViewProjectionMatrix()}},{key:"getZoom",value:function(){return this.viewport.getZoom()}},{key:"getZoomScale",value:function(){return this.viewport.getZoomScale()}},{key:"getCenter",value:function(){var e=a(this.viewport.getCenter(),2);return[e[0],e[1]]}},{key:"getFocalDistance",value:function(){return this.viewport.getFocalDistance()}},{key:"getCameraPosition",value:function(){return this.cameraPosition}},{key:"projectFlat",value:function(e,t){return this.viewport.projectFlat(e,t)}},{key:"setViewProjectionMatrix",value:function(e){this.overridedViewProjectionMatrix=e}},{key:"jitterProjectionMatrix",value:function(e,t){var n,r,i=(n=jc(),r=[e,t,0],n[0]=1,n[1]=0,n[2]=0,n[3]=0,n[4]=0,n[5]=1,n[6]=0,n[7]=0,n[8]=0,n[9]=0,n[10]=1,n[11]=0,n[12]=r[0],n[13]=r[1],n[14]=r[2],n[15]=1,n);this.jitteredProjectionMatrix=Xc(jc(),i,this.viewport.getProjectionMatrix()),this.jitteredViewProjectionMatrix=Xc(jc(),this.jitteredProjectionMatrix,this.viewport.getViewMatrix())}},{key:"clearJitterProjectionMatrix",value:function(){this.jitteredProjectionMatrix=void 0,this.jitteredViewProjectionMatrix=void 0}}])}(),ml={topleft:"column",topright:"column",bottomright:"column",bottomleft:"column",leftcenter:"column",rightcenter:"column",topcenter:"row",bottomcenter:"row",lefttop:"row",righttop:"row",leftbottom:"row",rightbottom:"row"},gl=function(){return c((function e(){f(this,e),ne(this,"container",void 0),ne(this,"controlCorners",void 0),ne(this,"controlContainer",void 0),ne(this,"scene",void 0),ne(this,"mapsService",void 0),ne(this,"controls",[]),ne(this,"unAddControls",[])}),[{key:"init",value:function(e,t){this.container=e.container,this.scene=t,this.mapsService=t.mapService,this.initControlPos()}},{key:"addControl",value:function(e,t){t.mapService.map?(e.addTo(this.scene),this.controls.push(e)):this.unAddControls.push(e)}},{key:"getControlByName",value:function(e){return this.controls.find((function(t){return t.controlOption.name===e}))}},{key:"removeControl",value:function(e){var t=this.controls.indexOf(e);return t>-1&&this.controls.splice(t,1),e.remove(),this}},{key:"addControls",value:function(){var e=this;this.unAddControls.forEach((function(t){t.addTo(e.scene),e.controls.push(t)})),this.unAddControls=[]}},{key:"destroy",value:function(){var e,t=y(this.controls);try{for(t.s();!(e=t.n()).done;){e.value.remove()}}catch(n){t.e(n)}finally{t.f()}this.controls=[],this.clearControlPos()}},{key:"initControlPos",value:function(){var e=this.controlCorners={},t=this.controlContainer=Di("div","l7-control-container",this.container);Object.values(ec).forEach((function(n){var i,o;!function(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],r=n.map((function(e){return"l7-"+e})).join(" ");e[n.filter((function(e){return!["row","column"].includes(e)})).join("")]=Di("div",r,t)}((i=n,o=i.replace(/^(top|bottom|left|right|center)/,"$1-").split("-"),[].concat(r(o),[ml[i]])))})),this.checkCornerOverlap()}},{key:"clearControlPos",value:function(){for(var e in this.controlCorners)this.controlCorners[e]&&Fi(this.controlCorners[e]);this.controlContainer&&Fi(this.controlContainer)}},{key:"checkCornerOverlap",value:function(){var e=this,t=window.MutationObserver;if(t)for(var n=function(){var n=i[r].match(/^(top|bottom)(left|right)$/);if(n){var o=a(n,3),s=o[1],u=o[2],c=e.controlCorners["".concat(s).concat(u)];new t((function(e){var t=a(e,1)[0].target;c&&(c.style[s]=t.clientHeight+"px")})).observe(e.controlCorners["".concat(u).concat(s)],{childList:!0,attributes:!0})}},r=0,i=Object.keys(this.controlCorners);r<i.length;r++)n()}}])}(),_l=function(){return c((function e(){f(this,e),ne(this,"container",void 0),ne(this,"scene",void 0),ne(this,"mapsService",void 0),ne(this,"markers",[]),ne(this,"markerLayers",[]),ne(this,"unAddMarkers",[]),ne(this,"unAddMarkerLayers",[])}),[{key:"addMarkerLayer",value:function(e){this.mapsService.map&&this.mapsService.getMarkerContainer()?(this.markerLayers.push(e),e.addTo(this.scene)):this.unAddMarkerLayers.push(e)}},{key:"removeMarkerLayer",value:function(e){e.destroy(),this.markerLayers.indexOf(e);var t=this.markerLayers.indexOf(e);t>-1&&this.markerLayers.splice(t,1)}},{key:"addMarker",value:function(e){this.mapsService.map&&this.mapsService.getMarkerContainer()?(this.markers.push(e),e.addTo(this.scene)):this.unAddMarkers.push(e)}},{key:"addMarkers",value:function(){var e=this;this.unAddMarkers.forEach((function(t){t.addTo(e.scene),e.markers.push(t)})),this.unAddMarkers=[]}},{key:"addMarkerLayers",value:function(){var e=this;this.unAddMarkerLayers.forEach((function(t){e.markerLayers.push(t),t.addTo(e.scene)})),this.unAddMarkers=[]}},{key:"removeMarker",value:function(e){e.remove(),this.markers.indexOf(e);var t=this.markers.indexOf(e);t>-1&&this.markers.splice(t,1)}},{key:"removeAllMarkers",value:function(){this.destroy()}},{key:"init",value:function(e){this.scene=e,this.mapsService=e.mapService}},{key:"destroy",value:function(){this.markers.forEach((function(e){e.remove()})),this.markers=[],this.markerLayers.forEach((function(e){e.destroy()})),this.markerLayers=[]}},{key:"removeMakerLayerMarker",value:function(e){e.destroy()}}])}(),yl=function(){return c((function e(){f(this,e),ne(this,"scene",void 0),ne(this,"mapsService",void 0),ne(this,"popups",[]),ne(this,"unAddPopups",[])}),[{key:"isMarkerReady",get:function(){return this.mapsService.map&&this.mapsService.getMarkerContainer()}},{key:"removePopup",value:function(e){null!=e&&e.isOpen()&&e.remove();var t=this.popups.indexOf(e);t>-1&&this.popups.splice(t,1);var n=this.unAddPopups.indexOf(e);n>-1&&this.unAddPopups.splice(n,1)}},{key:"destroy",value:function(){this.popups.forEach((function(e){return e.remove()}))}},{key:"addPopup",value:function(e){var t=this;e&&e.getOptions().autoClose&&[].concat(r(this.popups),r(this.unAddPopups)).forEach((function(e){e.getOptions().autoClose&&t.removePopup(e)})),this.isMarkerReady?(e.addTo(this.scene),this.popups.push(e)):this.unAddPopups.push(e),e.on("close",(function(){t.removePopup(e)}))}},{key:"initPopup",value:function(){var e=this;this.unAddPopups.length&&this.unAddPopups.forEach((function(t){e.addPopup(t),e.unAddPopups=[]}))}},{key:"init",value:function(e){this.scene=e,this.mapsService=e.mapService}}])}(),El={MapToken:"您正在使用 Demo 测试 Token, 生产环境务必自行注册 Token 确保服务稳定 高德地图申请地址 https://lbs.amap.com/api/javascript-api/guide/abc/prepare  Mapbox地图申请地址 https://docs.mapbox.com/help/glossary/access-token/",SDK:"请确认引入了mapbox-gl api且在L7之前引入"},bl=Ni.merge,Al={id:"map",logoPosition:"bottomleft",logoVisible:!0,antialias:!0,stencil:!0,preserveDrawingBuffer:!1,pickBufferScale:1,fitBoundsOptions:{animate:!1}},xl={colors:["rgb(103,0,31)","rgb(178,24,43)","rgb(214,96,77)","rgb(244,165,130)","rgb(253,219,199)","rgb(247,247,247)","rgb(209,229,240)","rgb(146,197,222)","rgb(67,147,195)","rgb(33,102,172)","rgb(5,48,97)"],size:10,shape:"circle",scales:{},shape2d:["circle","triangle","square","pentagon","hexagon","octogon","hexagram","rhombus","vesica"],shape3d:["cylinder","triangleColumn","hexagonColumn","squareColumn"],minZoom:-1,maxZoom:24,visible:!0,autoFit:!1,pickingBuffer:0,enablePropagation:!1,zIndex:0,blend:"normal",maskLayers:[],enableMask:!0,maskOperation:Ac.AND,pickedFeatureID:-1,enableMultiPassRenderer:!1,enablePicking:!0,active:!1,activeColor:"#2f54eb",enableHighlight:!1,enableSelect:!1,highlightColor:"#2f54eb",activeMix:0,selectColor:"blue",selectMix:0,enableTAA:!1,jitterScale:1,enableLighting:!1,animateOption:{enable:!1,interval:.2,duration:4,trailLength:.15},forward:!0},Sl=function(){return c((function e(){f(this,e),ne(this,"sceneConfigCache",{}),ne(this,"layerConfigCache",{}),ne(this,"layerAttributeConfigCache",{})}),[{key:"getSceneConfig",value:function(e){return this.sceneConfigCache[e]}},{key:"getSceneWarninfo",value:function(e){return El[e]}},{key:"setSceneConfig",value:function(e,t){this.sceneConfigCache[e]=re(re({},Al),t)}},{key:"getLayerConfig",value:function(e){return this.layerConfigCache[e]}},{key:"setLayerConfig",value:function(e,t,n){this.layerConfigCache[t]=re({},bl({},this.sceneConfigCache[e],xl,n))}},{key:"getAttributeConfig",value:function(e){return this.layerAttributeConfigCache[e]}},{key:"setAttributeConfig",value:function(e,t){this.layerAttributeConfigCache[e]=re(re({},this.layerAttributeConfigCache[e]),t)}},{key:"clean",value:function(){this.sceneConfigCache={},this.layerConfigCache={}}}])}(),Tl=Math.PI/180,Rl=4003e4;function Cl(e){var t=e.latitude,n=void 0===t?0:t,r=e.zoom,i=void 0===r?0:r,o=e.scale,a=e.highPrecision,s=void 0!==a&&a,u=e.flipY,c=void 0!==u&&u,l={},f=512*(o=void 0!==o?o:Math.pow(2,i)),h=Math.cos(n*Tl),d=f/360,p=d/h,v=f/Rl/h;if(l.pixelsPerMeter=[v,-v,v],l.metersPerPixel=[1/v,-1/v,1/v],l.pixelsPerDegree=[d,-p,v],l.degreesPerPixel=[1/d,-1/p,1/v],s){var m=Tl*Math.tan(n*Tl)/h,g=d*m/2,_=f/Rl*m,y=_/p*v;l.pixelsPerDegree2=[0,-g,_],l.pixelsPerMeter2=[y,0,y],c&&(l.pixelsPerDegree2[1]=-l.pixelsPerDegree2[1],l.pixelsPerMeter2[1]=-l.pixelsPerMeter2[1])}return c&&(l.pixelsPerMeter[1]=-l.pixelsPerMeter[1],l.metersPerPixel[1]=-l.metersPerPixel[1],l.pixelsPerDegree[1]=-l.pixelsPerDegree[1],l.degreesPerPixel[1]=-l.degreesPerPixel[1]),l}var Ml=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,0],wl=function(){return c((function e(t){f(this,e),ne(this,"needRefresh",!0),ne(this,"coordinateSystem",void 0),ne(this,"viewportCenter",void 0),ne(this,"viewportCenterProjection",void 0),ne(this,"pixelsPerDegree",void 0),ne(this,"pixelsPerDegree2",void 0),ne(this,"pixelsPerMeter",void 0),this.cameraService=t}),[{key:"refresh",value:function(e){var t=this.cameraService.getZoom(),n=this.cameraService.getZoomScale(),r=e||this.cameraService.getCenter(),i=Cl({latitude:r[1],zoom:t}),o=i.pixelsPerMeter,a=i.pixelsPerDegree;this.viewportCenter=r,this.viewportCenterProjection=[0,0,0,0],this.pixelsPerMeter=o,this.pixelsPerDegree=a,this.pixelsPerDegree2=[0,0,0],this.coordinateSystem===tc.LNGLAT||this.coordinateSystem===tc.P20?this.cameraService.setViewProjectionMatrix(void 0):this.coordinateSystem===tc.LNGLAT_OFFSET?this.calculateLnglatOffset(r,t):this.coordinateSystem===tc.P20_OFFSET&&this.calculateLnglatOffset(r,t,n,!0),this.needRefresh=!1}},{key:"getCoordinateSystem",value:function(){return this.coordinateSystem}},{key:"setCoordinateSystem",value:function(e){this.coordinateSystem=e}},{key:"getViewportCenter",value:function(){return this.viewportCenter}},{key:"getViewportCenterProjection",value:function(){return this.viewportCenterProjection}},{key:"getPixelsPerDegree",value:function(){return this.pixelsPerDegree}},{key:"getPixelsPerDegree2",value:function(){return this.pixelsPerDegree2}},{key:"getPixelsPerMeter",value:function(){return this.pixelsPerMeter}},{key:"calculateLnglatOffset",value:function(e,t,n,r){var i=Cl({latitude:e[1],zoom:t,scale:n,flipY:r,highPrecision:!0}),o=i.pixelsPerMeter,a=i.pixelsPerDegree,s=i.pixelsPerDegree2,u=this.cameraService.getViewMatrix(),c=this.cameraService.getProjectionMatrix(),l=Xc([],c,u),f=this.cameraService.projectFlat([Math.fround(e[0]),Math.fround(e[1])],Math.pow(2,t));this.viewportCenterProjection=al([],[f[0],f[1],0,1],l),l=Xc([],c,u=this.cameraService.getViewMatrixUncentered()||u),l=Xc([],l,Ml),this.cameraService.setViewProjectionMatrix(l),this.pixelsPerMeter=o,this.pixelsPerDegree=a,this.pixelsPerDegree2=s}}])}(),Ll=function(e){function t(){var e;f(this,t);for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];return e=h(this,t,[].concat(r)),ne(e,"renderMap",new Map),ne(e,"enable",!1),ne(e,"renderEnable",!1),ne(e,"cacheLogs",{}),e}return d(t,e),c(t,[{key:"setEnable",value:function(e){this.enable=!!e}},{key:"log",value:function(e,t){var n=this;if(this.enable){var r=e.split("."),i=null;r.forEach((function(e,o){null!==i?(i[e]||(i[e]={}),o!==r.length-1&&(i=i[e])):(n.cacheLogs[e]||(n.cacheLogs[e]={}),o!==r.length-1&&(i=n.cacheLogs[e])),o===r.length-1&&(i[e]=re(re({time:Date.now()},i[e]),t))}))}}},{key:"getLog",value:function(e){var t=this;switch(s(e)){case"string":return this.cacheLogs[e];case"object":return e.map((function(e){return t.cacheLogs[e]})).filter((function(e){return void 0!==e}));case"undefined":return this.cacheLogs}}},{key:"removeLog",value:function(e){delete this.cacheLogs[e]}},{key:"generateRenderUid",value:function(){return this.renderEnable?"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})):""}},{key:"renderDebug",value:function(e){this.renderEnable=e}},{key:"renderStart",value:function(e){if(this.renderEnable&&this.enable){var t=this.renderMap.get(e)||{};this.renderMap.set(e,re(re({},t),{},{renderUid:e,renderStart:Date.now()}))}}},{key:"renderEnd",value:function(e){if(this.renderEnable&&this.enable){var t=this.renderMap.get(e);if(t){var n=t.renderStart,r=Date.now();this.emit("renderEnd",re(re({},t),{},{renderEnd:r,renderDuration:r-n})),this.renderMap.delete(e)}}}},{key:"destroy",value:function(){this.cacheLogs=null,this.renderMap.clear()}}])}(lo.exports.EventEmitter),Ol={exports:{}};
/*! Hammer.JS - v2.0.7 - 2016-04-22
             * http://hammerjs.github.io/
             *
             * Copyright (c) 2016 Jorik Tangelder;
             * Licensed under the MIT license */
!function(e){!function(t,n,r,i){var o,a=["","webkit","Moz","MS","ms","o"],u=n.createElement("div"),c="function",l=Math.round,f=Math.abs,h=Date.now;function d(e,t,n){return setTimeout(E(e,n),t)}function p(e,t,n){return!!Array.isArray(e)&&(v(e,n[t],n),!0)}function v(e,t,n){var r;if(e)if(e.forEach)e.forEach(t,n);else if(e.length!==i)for(r=0;r<e.length;)t.call(n,e[r],r,e),r++;else for(r in e)e.hasOwnProperty(r)&&t.call(n,e[r],r,e)}function m(e,n,r){var i="DEPRECATED METHOD: "+n+"\n"+r+" AT \n";return function(){var n=new Error("get-stack-trace"),r=n&&n.stack?n.stack.replace(/^[^\(]+?[\n$]/gm,"").replace(/^\s+at\s+/gm,"").replace(/^Object.<anonymous>\s*\(/gm,"{anonymous}()@"):"Unknown Stack Trace",o=t.console&&(t.console.warn||t.console.log);return o&&o.call(t.console,i,r),e.apply(this,arguments)}}o="function"!=typeof Object.assign?function(e){if(e===i||null===e)throw new TypeError("Cannot convert undefined or null to object");for(var t=Object(e),n=1;n<arguments.length;n++){var r=arguments[n];if(r!==i&&null!==r)for(var o in r)r.hasOwnProperty(o)&&(t[o]=r[o])}return t}:Object.assign;var g=m((function(e,t,n){for(var r=Object.keys(t),o=0;o<r.length;)(!n||n&&e[r[o]]===i)&&(e[r[o]]=t[r[o]]),o++;return e}),"extend","Use `assign`."),_=m((function(e,t){return g(e,t,!0)}),"merge","Use `assign`.");function y(e,t,n){var r,i=t.prototype;(r=e.prototype=Object.create(i)).constructor=e,r._super=i,n&&o(r,n)}function E(e,t){return function(){return e.apply(t,arguments)}}function b(e,t){return s(e)==c?e.apply(t&&t[0]||i,t):e}function A(e,t){return e===i?t:e}function x(e,t,n){v(C(t),(function(t){e.addEventListener(t,n,!1)}))}function S(e,t,n){v(C(t),(function(t){e.removeEventListener(t,n,!1)}))}function T(e,t){for(;e;){if(e==t)return!0;e=e.parentNode}return!1}function R(e,t){return e.indexOf(t)>-1}function C(e){return e.trim().split(/\s+/g)}function M(e,t,n){if(e.indexOf&&!n)return e.indexOf(t);for(var r=0;r<e.length;){if(n&&e[r][n]==t||!n&&e[r]===t)return r;r++}return-1}function w(e){return Array.prototype.slice.call(e,0)}function L(e,t,n){for(var r=[],i=[],o=0;o<e.length;){var a=t?e[o][t]:e[o];M(i,a)<0&&r.push(e[o]),i[o]=a,o++}return n&&(r=t?r.sort((function(e,n){return e[t]>n[t]})):r.sort()),r}function O(e,t){for(var n,r,o=t[0].toUpperCase()+t.slice(1),s=0;s<a.length;){if((r=(n=a[s])?n+o:t)in e)return r;s++}return i}var k=1;function N(e){var n=e.ownerDocument||e;return n.defaultView||n.parentWindow||t}var I="ontouchstart"in t,P=O(t,"PointerEvent")!==i,D=I&&/mobile|tablet|ip(ad|hone|od)|android/i.test(navigator.userAgent),F="touch",B="mouse",U=25,G=1,z=4,j=8,V=1,H=2,X=4,W=8,Y=16,Z=H|X,q=W|Y,K=Z|q,Q=["x","y"],$=["clientX","clientY"];function J(e,t){var n=this;this.manager=e,this.callback=t,this.element=e.element,this.target=e.options.inputTarget,this.domHandler=function(t){b(e.options.enable,[e])&&n.handler(t)},this.init()}function ee(e,t,n){var r=n.pointers.length,o=n.changedPointers.length,a=t&G&&r-o==0,s=t&(z|j)&&r-o==0;n.isFirst=!!a,n.isFinal=!!s,a&&(e.session={}),n.eventType=t,function(e,t){var n=e.session,r=t.pointers,o=r.length;n.firstInput||(n.firstInput=te(t));o>1&&!n.firstMultiple?n.firstMultiple=te(t):1===o&&(n.firstMultiple=!1);var a=n.firstInput,s=n.firstMultiple,u=s?s.center:a.center,c=t.center=ne(r);t.timeStamp=h(),t.deltaTime=t.timeStamp-a.timeStamp,t.angle=ae(u,c),t.distance=oe(u,c),function(e,t){var n=t.center,r=e.offsetDelta||{},i=e.prevDelta||{},o=e.prevInput||{};t.eventType!==G&&o.eventType!==z||(i=e.prevDelta={x:o.deltaX||0,y:o.deltaY||0},r=e.offsetDelta={x:n.x,y:n.y});t.deltaX=i.x+(n.x-r.x),t.deltaY=i.y+(n.y-r.y)}(n,t),t.offsetDirection=ie(t.deltaX,t.deltaY);var l=re(t.deltaTime,t.deltaX,t.deltaY);t.overallVelocityX=l.x,t.overallVelocityY=l.y,t.overallVelocity=f(l.x)>f(l.y)?l.x:l.y,t.scale=s?(d=s.pointers,p=r,oe(p[0],p[1],$)/oe(d[0],d[1],$)):1,t.rotation=s?function(e,t){return ae(t[1],t[0],$)+ae(e[1],e[0],$)}(s.pointers,r):0,t.maxPointers=n.prevInput?t.pointers.length>n.prevInput.maxPointers?t.pointers.length:n.prevInput.maxPointers:t.pointers.length,function(e,t){var n,r,o,a,s=e.lastInterval||t,u=t.timeStamp-s.timeStamp;if(t.eventType!=j&&(u>U||s.velocity===i)){var c=t.deltaX-s.deltaX,l=t.deltaY-s.deltaY,h=re(u,c,l);r=h.x,o=h.y,n=f(h.x)>f(h.y)?h.x:h.y,a=ie(c,l),e.lastInterval=t}else n=s.velocity,r=s.velocityX,o=s.velocityY,a=s.direction;t.velocity=n,t.velocityX=r,t.velocityY=o,t.direction=a}(n,t);var d,p;var v=e.element;T(t.srcEvent.target,v)&&(v=t.srcEvent.target);t.target=v}(e,n),e.emit("hammer.input",n),e.recognize(n),e.session.prevInput=n}function te(e){for(var t=[],n=0;n<e.pointers.length;)t[n]={clientX:l(e.pointers[n].clientX),clientY:l(e.pointers[n].clientY)},n++;return{timeStamp:h(),pointers:t,center:ne(t),deltaX:e.deltaX,deltaY:e.deltaY}}function ne(e){var t=e.length;if(1===t)return{x:l(e[0].clientX),y:l(e[0].clientY)};for(var n=0,r=0,i=0;i<t;)n+=e[i].clientX,r+=e[i].clientY,i++;return{x:l(n/t),y:l(r/t)}}function re(e,t,n){return{x:t/e||0,y:n/e||0}}function ie(e,t){return e===t?V:f(e)>=f(t)?e<0?H:X:t<0?W:Y}function oe(e,t,n){n||(n=Q);var r=t[n[0]]-e[n[0]],i=t[n[1]]-e[n[1]];return Math.sqrt(r*r+i*i)}function ae(e,t,n){n||(n=Q);var r=t[n[0]]-e[n[0]],i=t[n[1]]-e[n[1]];return 180*Math.atan2(i,r)/Math.PI}J.prototype={handler:function(){},init:function(){this.evEl&&x(this.element,this.evEl,this.domHandler),this.evTarget&&x(this.target,this.evTarget,this.domHandler),this.evWin&&x(N(this.element),this.evWin,this.domHandler)},destroy:function(){this.evEl&&S(this.element,this.evEl,this.domHandler),this.evTarget&&S(this.target,this.evTarget,this.domHandler),this.evWin&&S(N(this.element),this.evWin,this.domHandler)}};var se={mousedown:G,mousemove:2,mouseup:z},ue="mousedown",ce="mousemove mouseup";function le(){this.evEl=ue,this.evWin=ce,this.pressed=!1,J.apply(this,arguments)}y(le,J,{handler:function(e){var t=se[e.type];t&G&&0===e.button&&(this.pressed=!0),2&t&&1!==e.which&&(t=z),this.pressed&&(t&z&&(this.pressed=!1),this.callback(this.manager,t,{pointers:[e],changedPointers:[e],pointerType:B,srcEvent:e}))}});var fe={pointerdown:G,pointermove:2,pointerup:z,pointercancel:j,pointerout:j},he={2:F,3:"pen",4:B,5:"kinect"},de="pointerdown",pe="pointermove pointerup pointercancel";function ve(){this.evEl=de,this.evWin=pe,J.apply(this,arguments),this.store=this.manager.session.pointerEvents=[]}t.MSPointerEvent&&!t.PointerEvent&&(de="MSPointerDown",pe="MSPointerMove MSPointerUp MSPointerCancel"),y(ve,J,{handler:function(e){var t=this.store,n=!1,r=e.type.toLowerCase().replace("ms",""),i=fe[r],o=he[e.pointerType]||e.pointerType,a=o==F,s=M(t,e.pointerId,"pointerId");i&G&&(0===e.button||a)?s<0&&(t.push(e),s=t.length-1):i&(z|j)&&(n=!0),s<0||(t[s]=e,this.callback(this.manager,i,{pointers:t,changedPointers:[e],pointerType:o,srcEvent:e}),n&&t.splice(s,1))}});var me={touchstart:G,touchmove:2,touchend:z,touchcancel:j};function ge(){this.evTarget="touchstart",this.evWin="touchstart touchmove touchend touchcancel",this.started=!1,J.apply(this,arguments)}function _e(e,t){var n=w(e.touches),r=w(e.changedTouches);return t&(z|j)&&(n=L(n.concat(r),"identifier",!0)),[n,r]}y(ge,J,{handler:function(e){var t=me[e.type];if(t===G&&(this.started=!0),this.started){var n=_e.call(this,e,t);t&(z|j)&&n[0].length-n[1].length==0&&(this.started=!1),this.callback(this.manager,t,{pointers:n[0],changedPointers:n[1],pointerType:F,srcEvent:e})}}});var ye={touchstart:G,touchmove:2,touchend:z,touchcancel:j},Ee="touchstart touchmove touchend touchcancel";function be(){this.evTarget=Ee,this.targetIds={},J.apply(this,arguments)}function Ae(e,t){var n=w(e.touches),r=this.targetIds;if(t&(2|G)&&1===n.length)return r[n[0].identifier]=!0,[n,n];var i,o,a=w(e.changedTouches),s=[],u=this.target;if(o=n.filter((function(e){return T(e.target,u)})),t===G)for(i=0;i<o.length;)r[o[i].identifier]=!0,i++;for(i=0;i<a.length;)r[a[i].identifier]&&s.push(a[i]),t&(z|j)&&delete r[a[i].identifier],i++;return s.length?[L(o.concat(s),"identifier",!0),s]:void 0}y(be,J,{handler:function(e){var t=ye[e.type],n=Ae.call(this,e,t);n&&this.callback(this.manager,t,{pointers:n[0],changedPointers:n[1],pointerType:F,srcEvent:e})}});var xe=2500;function Se(){J.apply(this,arguments);var e=E(this.handler,this);this.touch=new be(this.manager,e),this.mouse=new le(this.manager,e),this.primaryTouch=null,this.lastTouches=[]}function Te(e,t){e&G?(this.primaryTouch=t.changedPointers[0].identifier,Re.call(this,t)):e&(z|j)&&Re.call(this,t)}function Re(e){var t=e.changedPointers[0];if(t.identifier===this.primaryTouch){var n={x:t.clientX,y:t.clientY};this.lastTouches.push(n);var r=this.lastTouches;setTimeout((function(){var e=r.indexOf(n);e>-1&&r.splice(e,1)}),xe)}}function Ce(e){for(var t=e.srcEvent.clientX,n=e.srcEvent.clientY,r=0;r<this.lastTouches.length;r++){var i=this.lastTouches[r],o=Math.abs(t-i.x),a=Math.abs(n-i.y);if(o<=25&&a<=25)return!0}return!1}y(Se,J,{handler:function(e,t,n){var r=n.pointerType==F,i=n.pointerType==B;if(!(i&&n.sourceCapabilities&&n.sourceCapabilities.firesTouchEvents)){if(r)Te.call(this,t,n);else if(i&&Ce.call(this,n))return;this.callback(e,t,n)}},destroy:function(){this.touch.destroy(),this.mouse.destroy()}});var Me=O(u.style,"touchAction"),we=Me!==i,Le="compute",Oe="auto",ke="manipulation",Ne="none",Ie="pan-x",Pe="pan-y",De=function(){if(!we)return!1;var e={},n=t.CSS&&t.CSS.supports;return["auto","manipulation","pan-y","pan-x","pan-x pan-y","none"].forEach((function(r){e[r]=!n||t.CSS.supports("touch-action",r)})),e}();function Fe(e,t){this.manager=e,this.set(t)}Fe.prototype={set:function(e){e==Le&&(e=this.compute()),we&&this.manager.element.style&&De[e]&&(this.manager.element.style[Me]=e),this.actions=e.toLowerCase().trim()},update:function(){this.set(this.manager.options.touchAction)},compute:function(){var e=[];return v(this.manager.recognizers,(function(t){b(t.options.enable,[t])&&(e=e.concat(t.getTouchAction()))})),function(e){if(R(e,Ne))return Ne;var t=R(e,Ie),n=R(e,Pe);if(t&&n)return Ne;if(t||n)return t?Ie:Pe;if(R(e,ke))return ke;return Oe}(e.join(" "))},preventDefaults:function(e){var t=e.srcEvent,n=e.offsetDirection;if(this.manager.session.prevented)t.preventDefault();else{var r=this.actions,i=R(r,Ne)&&!De[Ne],o=R(r,Pe)&&!De[Pe],a=R(r,Ie)&&!De[Ie];if(i){var s=1===e.pointers.length,u=e.distance<2,c=e.deltaTime<250;if(s&&u&&c)return}if(!a||!o)return i||o&&n&Z||a&&n&q?this.preventSrc(t):void 0}},preventSrc:function(e){this.manager.session.prevented=!0,e.preventDefault()}};var Be=1,Ue=32;function Ge(e){this.options=o({},this.defaults,e||{}),this.id=k++,this.manager=null,this.options.enable=A(this.options.enable,!0),this.state=Be,this.simultaneous={},this.requireFail=[]}function ze(e){return 16&e?"cancel":8&e?"end":4&e?"move":2&e?"start":""}function je(e){return e==Y?"down":e==W?"up":e==H?"left":e==X?"right":""}function Ve(e,t){var n=t.manager;return n?n.get(e):e}function He(){Ge.apply(this,arguments)}function Xe(){He.apply(this,arguments),this.pX=null,this.pY=null}function We(){He.apply(this,arguments)}function Ye(){Ge.apply(this,arguments),this._timer=null,this._input=null}function Ze(){He.apply(this,arguments)}function qe(){He.apply(this,arguments)}function Ke(){Ge.apply(this,arguments),this.pTime=!1,this.pCenter=!1,this._timer=null,this._input=null,this.count=0}function Qe(e,t){return(t=t||{}).recognizers=A(t.recognizers,Qe.defaults.preset),new $e(e,t)}Ge.prototype={defaults:{},set:function(e){return o(this.options,e),this.manager&&this.manager.touchAction.update(),this},recognizeWith:function(e){if(p(e,"recognizeWith",this))return this;var t=this.simultaneous;return t[(e=Ve(e,this)).id]||(t[e.id]=e,e.recognizeWith(this)),this},dropRecognizeWith:function(e){return p(e,"dropRecognizeWith",this)||(e=Ve(e,this),delete this.simultaneous[e.id]),this},requireFailure:function(e){if(p(e,"requireFailure",this))return this;var t=this.requireFail;return-1===M(t,e=Ve(e,this))&&(t.push(e),e.requireFailure(this)),this},dropRequireFailure:function(e){if(p(e,"dropRequireFailure",this))return this;e=Ve(e,this);var t=M(this.requireFail,e);return t>-1&&this.requireFail.splice(t,1),this},hasRequireFailures:function(){return this.requireFail.length>0},canRecognizeWith:function(e){return!!this.simultaneous[e.id]},emit:function(e){var t=this,n=this.state;function r(n){t.manager.emit(n,e)}n<8&&r(t.options.event+ze(n)),r(t.options.event),e.additionalEvent&&r(e.additionalEvent),n>=8&&r(t.options.event+ze(n))},tryEmit:function(e){if(this.canEmit())return this.emit(e);this.state=Ue},canEmit:function(){for(var e=0;e<this.requireFail.length;){if(!(this.requireFail[e].state&(Ue|Be)))return!1;e++}return!0},recognize:function(e){var t=o({},e);if(!b(this.options.enable,[this,t]))return this.reset(),void(this.state=Ue);56&this.state&&(this.state=Be),this.state=this.process(t),30&this.state&&this.tryEmit(t)},process:function(e){},getTouchAction:function(){},reset:function(){}},y(He,Ge,{defaults:{pointers:1},attrTest:function(e){var t=this.options.pointers;return 0===t||e.pointers.length===t},process:function(e){var t=this.state,n=e.eventType,r=6&t,i=this.attrTest(e);return r&&(n&j||!i)?16|t:r||i?n&z?8|t:2&t?4|t:2:Ue}}),y(Xe,He,{defaults:{event:"pan",threshold:10,pointers:1,direction:K},getTouchAction:function(){var e=this.options.direction,t=[];return e&Z&&t.push(Pe),e&q&&t.push(Ie),t},directionTest:function(e){var t=this.options,n=!0,r=e.distance,i=e.direction,o=e.deltaX,a=e.deltaY;return i&t.direction||(t.direction&Z?(i=0===o?V:o<0?H:X,n=o!=this.pX,r=Math.abs(e.deltaX)):(i=0===a?V:a<0?W:Y,n=a!=this.pY,r=Math.abs(e.deltaY))),e.direction=i,n&&r>t.threshold&&i&t.direction},attrTest:function(e){return He.prototype.attrTest.call(this,e)&&(2&this.state||!(2&this.state)&&this.directionTest(e))},emit:function(e){this.pX=e.deltaX,this.pY=e.deltaY;var t=je(e.direction);t&&(e.additionalEvent=this.options.event+t),this._super.emit.call(this,e)}}),y(We,He,{defaults:{event:"pinch",threshold:0,pointers:2},getTouchAction:function(){return[Ne]},attrTest:function(e){return this._super.attrTest.call(this,e)&&(Math.abs(e.scale-1)>this.options.threshold||2&this.state)},emit:function(e){if(1!==e.scale){var t=e.scale<1?"in":"out";e.additionalEvent=this.options.event+t}this._super.emit.call(this,e)}}),y(Ye,Ge,{defaults:{event:"press",pointers:1,time:251,threshold:9},getTouchAction:function(){return[Oe]},process:function(e){var t=this.options,n=e.pointers.length===t.pointers,r=e.distance<t.threshold,i=e.deltaTime>t.time;if(this._input=e,!r||!n||e.eventType&(z|j)&&!i)this.reset();else if(e.eventType&G)this.reset(),this._timer=d((function(){this.state=8,this.tryEmit()}),t.time,this);else if(e.eventType&z)return 8;return Ue},reset:function(){clearTimeout(this._timer)},emit:function(e){8===this.state&&(e&&e.eventType&z?this.manager.emit(this.options.event+"up",e):(this._input.timeStamp=h(),this.manager.emit(this.options.event,this._input)))}}),y(Ze,He,{defaults:{event:"rotate",threshold:0,pointers:2},getTouchAction:function(){return[Ne]},attrTest:function(e){return this._super.attrTest.call(this,e)&&(Math.abs(e.rotation)>this.options.threshold||2&this.state)}}),y(qe,He,{defaults:{event:"swipe",threshold:10,velocity:.3,direction:Z|q,pointers:1},getTouchAction:function(){return Xe.prototype.getTouchAction.call(this)},attrTest:function(e){var t,n=this.options.direction;return n&(Z|q)?t=e.overallVelocity:n&Z?t=e.overallVelocityX:n&q&&(t=e.overallVelocityY),this._super.attrTest.call(this,e)&&n&e.offsetDirection&&e.distance>this.options.threshold&&e.maxPointers==this.options.pointers&&f(t)>this.options.velocity&&e.eventType&z},emit:function(e){var t=je(e.offsetDirection);t&&this.manager.emit(this.options.event+t,e),this.manager.emit(this.options.event,e)}}),y(Ke,Ge,{defaults:{event:"tap",pointers:1,taps:1,interval:300,time:250,threshold:9,posThreshold:10},getTouchAction:function(){return[ke]},process:function(e){var t=this.options,n=e.pointers.length===t.pointers,r=e.distance<t.threshold,i=e.deltaTime<t.time;if(this.reset(),e.eventType&G&&0===this.count)return this.failTimeout();if(r&&i&&n){if(e.eventType!=z)return this.failTimeout();var o=!this.pTime||e.timeStamp-this.pTime<t.interval,a=!this.pCenter||oe(this.pCenter,e.center)<t.posThreshold;if(this.pTime=e.timeStamp,this.pCenter=e.center,a&&o?this.count+=1:this.count=1,this._input=e,0===this.count%t.taps)return this.hasRequireFailures()?(this._timer=d((function(){this.state=8,this.tryEmit()}),t.interval,this),2):8}return Ue},failTimeout:function(){return this._timer=d((function(){this.state=Ue}),this.options.interval,this),Ue},reset:function(){clearTimeout(this._timer)},emit:function(){8==this.state&&(this._input.tapCount=this.count,this.manager.emit(this.options.event,this._input))}}),Qe.VERSION="2.0.7",Qe.defaults={domEvents:!1,touchAction:Le,enable:!0,inputTarget:null,inputClass:null,preset:[[Ze,{enable:!1}],[We,{enable:!1},["rotate"]],[qe,{direction:Z}],[Xe,{direction:Z},["swipe"]],[Ke],[Ke,{event:"doubletap",taps:2},["tap"]],[Ye]],cssProps:{userSelect:"none",touchSelect:"none",touchCallout:"none",contentZooming:"none",userDrag:"none",tapHighlightColor:"rgba(0,0,0,0)"}};function $e(e,t){var n;this.options=o({},Qe.defaults,t||{}),this.options.inputTarget=this.options.inputTarget||e,this.handlers={},this.session={},this.recognizers=[],this.oldCssProps={},this.element=e,this.input=new((n=this).options.inputClass||(P?ve:D?be:I?Se:le))(n,ee),this.touchAction=new Fe(this,this.options.touchAction),Je(this,!0),v(this.options.recognizers,(function(e){var t=this.add(new e[0](e[1]));e[2]&&t.recognizeWith(e[2]),e[3]&&t.requireFailure(e[3])}),this)}function Je(e,t){var n,r=e.element;r.style&&(v(e.options.cssProps,(function(i,o){n=O(r.style,o),t?(e.oldCssProps[n]=r.style[n],r.style[n]=i):r.style[n]=e.oldCssProps[n]||""})),t||(e.oldCssProps={}))}$e.prototype={set:function(e){return o(this.options,e),e.touchAction&&this.touchAction.update(),e.inputTarget&&(this.input.destroy(),this.input.target=e.inputTarget,this.input.init()),this},stop:function(e){this.session.stopped=e?2:1},recognize:function(e){var t=this.session;if(!t.stopped){var n;this.touchAction.preventDefaults(e);var r=this.recognizers,i=t.curRecognizer;(!i||i&&8&i.state)&&(i=t.curRecognizer=null);for(var o=0;o<r.length;)n=r[o],2===t.stopped||i&&n!=i&&!n.canRecognizeWith(i)?n.reset():n.recognize(e),!i&&14&n.state&&(i=t.curRecognizer=n),o++}},get:function(e){if(e instanceof Ge)return e;for(var t=this.recognizers,n=0;n<t.length;n++)if(t[n].options.event==e)return t[n];return null},add:function(e){if(p(e,"add",this))return this;var t=this.get(e.options.event);return t&&this.remove(t),this.recognizers.push(e),e.manager=this,this.touchAction.update(),e},remove:function(e){if(p(e,"remove",this))return this;if(e=this.get(e)){var t=this.recognizers,n=M(t,e);-1!==n&&(t.splice(n,1),this.touchAction.update())}return this},on:function(e,t){if(e!==i&&t!==i){var n=this.handlers;return v(C(e),(function(e){n[e]=n[e]||[],n[e].push(t)})),this}},off:function(e,t){if(e!==i){var n=this.handlers;return v(C(e),(function(e){t?n[e]&&n[e].splice(M(n[e],t),1):delete n[e]})),this}},emit:function(e,t){this.options.domEvents&&function(e,t){var r=n.createEvent("Event");r.initEvent(e,!0,!0),r.gesture=t,t.target.dispatchEvent(r)}(e,t);var r=this.handlers[e]&&this.handlers[e].slice();if(r&&r.length){t.type=e,t.preventDefault=function(){t.srcEvent.preventDefault()};for(var i=0;i<r.length;)r[i](t),i++}},destroy:function(){this.element&&Je(this,!1),this.handlers={},this.session={},this.input.destroy(),this.element=null}},o(Qe,{INPUT_START:G,INPUT_MOVE:2,INPUT_END:z,INPUT_CANCEL:j,STATE_POSSIBLE:Be,STATE_BEGAN:2,STATE_CHANGED:4,STATE_ENDED:8,STATE_RECOGNIZED:8,STATE_CANCELLED:16,STATE_FAILED:Ue,DIRECTION_NONE:V,DIRECTION_LEFT:H,DIRECTION_RIGHT:X,DIRECTION_UP:W,DIRECTION_DOWN:Y,DIRECTION_HORIZONTAL:Z,DIRECTION_VERTICAL:q,DIRECTION_ALL:K,Manager:$e,Input:J,TouchAction:Fe,TouchInput:be,MouseInput:le,PointerEventInput:ve,TouchMouseInput:Se,SingleTouchInput:ge,Recognizer:Ge,AttrRecognizer:He,Tap:Ke,Pan:Xe,Swipe:qe,Pinch:We,Rotate:Ze,Press:Ye,on:x,off:S,each:v,merge:_,extend:g,assign:o,inherit:y,bindFn:E,prefixed:O}),(void 0!==t?t:"undefined"!=typeof self?self:{}).Hammer=Qe,"function"==typeof i&&i.amd?i((function(){return Qe})):e.exports?e.exports=Qe:t.Hammer=Qe}(window,document)}(Ol);var kl=Ol.exports,Nl={panstart:"dragstart",panmove:"dragging",panend:"dragend",pancancel:"dragcancel"},Il=function(e){function t(e){var n;return f(this,t),n=h(this,t),ne(n,"indragging",!1),ne(n,"hammertime",void 0),ne(n,"lastClickTime",0),ne(n,"lastClickXY",[-1,-1]),ne(n,"clickTimer",void 0),ne(n,"$containter",void 0),ne(n,"onDrag",(function(e){var t=n.interactionEvent(e);t.type=Nl[t.type],"dragging"===t.type?n.indragging=!0:n.indragging=!1,n.emit(yc.Drag,t)})),ne(n,"onHammer",(function(e){e.srcEvent.stopPropagation();var t=n.interactionEvent(e);n.emit(yc.Hover,t)})),ne(n,"onTouch",(function(e){var t=e.touches[0];n.onHover({clientX:t.clientX,clientY:t.clientY,type:"touchstart"})})),ne(n,"onTouchEnd",(function(e){if(e.changedTouches.length>0){var t=e.changedTouches[0];n.onHover({clientX:t.clientX,clientY:t.clientY,type:"touchend"})}})),ne(n,"onTouchMove",(function(e){var t=e.changedTouches[0];n.onHover({clientX:t.clientX,clientY:t.clientY,type:"touchmove"})})),ne(n,"onHover",(function(e){var t=e.clientX,r=e.clientY,i=e.type,o=n.mapService.getMapContainer();if(o){var a=o.getBoundingClientRect(),s=a.top;t=t-a.left-o.clientLeft,r=r-s-o.clientTop}var u=n.mapService.containerToLngLat([t,r]);"click"!==i&&"touch"!==i?"click"!==i&&"dblclick"!==i&&n.emit(yc.Hover,{x:t,y:r,lngLat:u,type:i,target:e}):n.isDoubleTap(t,r,u)})),n.container=e,n}return d(t,e),c(t,[{key:"mapService",get:function(){return this.container.mapService}},{key:"init",value:function(){this.addEventListenerOnMap(),this.$containter=this.mapService.getMapContainer()}},{key:"destroy",value:function(){this.hammertime&&this.hammertime.destroy(),this.removeEventListenerOnMap(),this.off(yc.Hover)}},{key:"triggerHover",value:function(e){var t=e.x,n=e.y;this.emit(yc.Hover,{x:t,y:n})}},{key:"triggerSelect",value:function(e){this.emit(yc.Select,{featureId:e})}},{key:"triggerActive",value:function(e){this.emit(yc.Active,{featureId:e})}},{key:"addEventListenerOnMap",value:function(){var e=this.mapService.getMapContainer();if(e){var t=new kl.Manager(e);t.add(new kl.Tap({event:"dblclick",taps:2})),t.add(new kl.Tap({event:"click"})),t.add(new kl.Pan({threshold:0,pointers:0})),t.add(new kl.Press({})),t.on("dblclick click",this.onHammer),t.on("panstart panmove panend pancancel",this.onDrag),e.addEventListener("touchstart",this.onTouch),e.addEventListener("touchend",this.onTouchEnd),e.addEventListener("mousemove",this.onHover),e.addEventListener("touchmove",this.onTouchMove),e.addEventListener("mousedown",this.onHover,!0),e.addEventListener("mouseup",this.onHover),e.addEventListener("contextmenu",this.onHover),this.hammertime=t}}},{key:"removeEventListenerOnMap",value:function(){var e=this.mapService.getMapContainer();e&&(e.removeEventListener("mousemove",this.onHover),this.hammertime.off("dblclick click",this.onHammer),this.hammertime.off("panstart panmove panend pancancel",this.onDrag),e.removeEventListener("touchstart",this.onTouch),e.removeEventListener("touchend",this.onTouchEnd),e.removeEventListener("mousedown",this.onHover),e.removeEventListener("mouseup",this.onHover),e.removeEventListener("contextmenu",this.onHover))}},{key:"interactionEvent",value:function(e){var t,n,r=e.type;"touch"===e.pointerType?(n=Math.floor(e.pointers[0].clientY),t=Math.floor(e.pointers[0].clientX)):(n=Math.floor(e.srcEvent.y),t=Math.floor(e.srcEvent.x));var i=this.mapService.getMapContainer();if(i){var o=i.getBoundingClientRect(),a=o.top;t-=o.left,n-=a}return{x:t,y:n,lngLat:this.mapService.containerToLngLat([t,n]),type:r,target:e.srcEvent}}},{key:"isDoubleTap",value:function(e,t,n){var r=this,i=(new Date).getTime(),o="click";i-this.lastClickTime<400&&Math.abs(this.lastClickXY[0]-e)<10&&Math.abs(this.lastClickXY[1]-t)<10?(this.lastClickTime=0,this.lastClickXY=[-1,-1],this.clickTimer&&clearTimeout(this.clickTimer),o="dblclick",this.emit(yc.Hover,{x:e,y:t,lngLat:n,type:o})):(this.lastClickTime=i,this.lastClickXY=[e,t],this.clickTimer=setTimeout((function(){o="click",r.emit(yc.Hover,{x:e,y:t,lngLat:n,type:o})}),400))}}])}(fo),Pl=0;function Dl(e){var t=e;if("string"==typeof e&&(t=document.getElementById(e)),t){var n=document.createElement("div");return n.style.cssText+="\n      position: absolute;\n      z-index:2;\n      height: 100%;\n      width: 100%;\n      pointer-events: none;\n    ",n.id="l7-scene-".concat(Pl++),n.classList.add("l7-scene"),t.appendChild(n),n}return null}var Fl=function(e){return e[e.SAMPLED=0]="SAMPLED",e[e.RENDER_TARGET=1]="RENDER_TARGET",e}({}),Bl=function(){return c((function e(t){f(this,e);var n=this;ne(this,"pickedColors",void 0),ne(this,"pickedTileLayers",[]),ne(this,"pickingFBO",void 0),ne(this,"width",0),ne(this,"height",0),ne(this,"alreadyInPicking",!1),ne(this,"pickBufferScale",1),ne(this,"pickFromPickingFBO",function(){var e=ie((function(e,t){var r=t.x,o=t.y,a=t.lngLat,s=t.type,u=t.target;return i().mark((function t(){var c,l,f,h,d,p,v,m,g,_,y,E,b,A,x,S,T,R;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(c=!1,l=n.rendererService,f=l.readPixelsAsync,h=l.getViewportSize,d=h(),p=d.width,v=d.height,m=e.getLayerConfig(),g=m.enableHighlight,_=m.enableSelect,E=o*ji,!((y=r*ji)>p-1*ji||y<0||E>v-1*ji||E<0)){t.next=8;break}return t.abrupt("return",!1);case 8:return t.next=10,f({x:Math.floor(y/n.pickBufferScale),y:Math.floor((v-(o+1)*ji)/n.pickBufferScale),width:1,height:1,data:new Uint8Array(4),framebuffer:n.pickingFBO});case 10:return b=t.sent,n.pickedColors=b,0!==b[0]||0!==b[1]||0!==b[2]?(A=Xt(b),x=e.layerPickService.getFeatureById(A),A!==e.getCurrentPickId()&&"mousemove"===s&&(s="mouseenter"),S={x:r,y:o,type:s,lngLat:a,featureId:A,feature:x,target:u},x&&(c=!0,e.setCurrentPickId(A),n.triggerHoverOnLayer(e,S))):(T={x:r,y:o,lngLat:a,type:null!==e.getCurrentPickId()&&"mousemove"===s?"mouseout":"un"+s,featureId:null,target:u,feature:null},n.triggerHoverOnLayer(e,re(re({},T),{},{type:"unpick"})),n.triggerHoverOnLayer(e,T),e.setCurrentPickId(null)),g&&e.layerPickService.highlightPickedFeature(b),_&&"click"===s&&(null==b?void 0:b.toString())!==[0,0,0,0].toString()&&(R=Xt(b),null===e.getCurrentSelectedId()||R!==e.getCurrentSelectedId()?(e.layerPickService.selectFeature(b),e.setCurrentSelectedId(R)):(e.layerPickService.selectFeature(new Uint8Array([0,0,0,0])),e.setCurrentSelectedId(null))),t.abrupt("return",c);case 16:case"end":return t.stop()}}),t)}))()}));return function(t,n){return e.apply(this,arguments)}}()),this.container=t}),[{key:"mapService",get:function(){return this.container.mapService}},{key:"rendererService",get:function(){return this.container.rendererService}},{key:"configService",get:function(){return this.container.globalConfigService}},{key:"interactionService",get:function(){return this.container.interactionService}},{key:"layerService",get:function(){return this.container.layerService}},{key:"init",value:function(e){var t=this.rendererService,n=t.createTexture2D,r=t.createFramebuffer,i=(0,t.getViewportSize)(),o=i.width,a=i.height;this.pickBufferScale=this.configService.getSceneConfig(e).pickBufferScale||1;var s=n({width:o=Math.round(o/this.pickBufferScale),height:a=Math.round(a/this.pickBufferScale),usage:Fl.RENDER_TARGET,label:"Picking Texture"});this.pickingFBO=r({color:s,depth:!0,width:o,height:a}),this.interactionService.on(yc.Hover,this.pickingAllLayer.bind(this))}},{key:"boxPickLayer",value:function(e,t,n){var r=this;return ie(i().mark((function o(){var a,s,u,c;return i().wrap((function(o){for(;;)switch(o.prev=o.next){case 0:return a=r.rendererService,s=a.useFramebufferAsync,u=a.clear,r.resizePickingFBO(),e.hooks.beforePickingEncode.call(),o.next=5,s(r.pickingFBO,ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:u({framebuffer:r.pickingFBO,color:[0,0,0,0],stencil:0,depth:1}),e.renderModels({ispick:!0});case 2:case"end":return t.stop()}}),t)}))));case 5:return e.hooks.afterPickingEncode.call(),o.next=8,r.pickBox(e,t);case 8:c=o.sent,n(c);case 10:case"end":return o.stop()}}),o)})))()}},{key:"pickBox",value:function(e,t){var n=this;return ie(i().mark((function r(){var o,s,u,c,l,f,h,d,p,v,m,g,_,y,E,b,A,x,S,T,R;return i().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(o=t.map((function(e){var t=e<0?0:e;return Math.floor(t*ji/n.pickBufferScale)})),s=a(o,4),u=s[0],c=s[1],l=s[2],f=s[3],h=n.rendererService,d=h.readPixelsAsync,p=h.getViewportSize,v=p(),m=v.width,g=v.height,!(u>(m-1)*ji/n.pickBufferScale||l<0||c>(g-1)*ji/n.pickBufferScale||f<0)){r.next=5;break}return r.abrupt("return",[]);case 5:return _=Math.min(m/n.pickBufferScale,l)-u,y=Math.min(g/n.pickBufferScale,f)-c,r.next=9,d({x:u,y:Math.floor(g/n.pickBufferScale-(f+1)),width:_,height:y,data:new Uint8Array(_*y*4),framebuffer:n.pickingFBO});case 9:for(E=r.sent,b=[],A={},x=0;x<E.length/4;x+=1)S=E.slice(4*x,4*x+4),-1===(T=Xt(S))||A[T]||(R=e.layerPickService.getFeatureById(T),b.push(re(re({},R),{},{pickedFeatureIdx:T})),A[T]=!0);return r.abrupt("return",b);case 14:case"end":return r.stop()}}),r)})))()}},{key:"handleCursor",value:function(e,t){var n=e.getLayerConfig(),r=n.cursor,i=void 0===r?"":r;if(n.cursorEnabled){var o="GAODE2.x"===this.mapService.version?this.mapService.getMapContainer():this.mapService.getMarkerContainer(),a=null==o?void 0:o.style.getPropertyValue("cursor");"unmousemove"===t&&""!==a?null==o||o.style.setProperty("cursor",""):"mousemove"===t&&(null==o||o.style.setProperty("cursor",i))}}},{key:"destroy",value:function(){this.pickingFBO.destroy(),this.pickingFBO=null}},{key:"pickingAllLayer",value:function(e){var t=this;return ie(i().mark((function n(){return i().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(t.layerService.needPick(e.type)&&t.isPickingAllLayer()){n.next=2;break}return n.abrupt("return");case 2:return t.alreadyInPicking=!0,n.next=5,t.pickingLayers(e);case 5:t.layerService.renderLayers(),t.alreadyInPicking=!1;case 7:case"end":return n.stop()}}),n)})))()}},{key:"isPickingAllLayer",value:function(){return!this.alreadyInPicking&&(!this.layerService.alreadyInRendering&&(!this.interactionService.indragging&&!!this.layerService.getShaderPickStat()))}},{key:"resizePickingFBO",value:function(){var e=(0,this.rendererService.getViewportSize)(),t=e.width,n=e.height;this.width===t&&this.height===n||(this.pickingFBO.resize({width:Math.round(t/this.pickBufferScale),height:Math.round(n/this.pickBufferScale)}),this.width=t,this.height=n)}},{key:"pickingLayers",value:function(e){var t=this;return ie(i().mark((function n(){var r,o,a,s,u,c,l;return i().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:r=t.rendererService,o=r.clear,a=r.useFramebufferAsync,t.resizePickingFBO(),s=t.layerService.getRenderList(),u=y(s.filter((function(t){return t.needPick(e.type)})).reverse()),n.prev=4,l=i().mark((function n(){var r,s;return i().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return r=c.value,n.next=3,a(t.pickingFBO,ie(i().mark((function n(){return i().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:o({framebuffer:t.pickingFBO,color:[0,0,0,0],stencil:0,depth:1}),r.layerPickService.pickRender(e);case 2:case"end":return n.stop()}}),n)}))));case 3:return n.next=5,t.pickFromPickingFBO(r,e);case 5:if(s=n.sent,t.layerService.pickedLayerId=s?+r.id:-1,!s||r.getLayerConfig().enablePropagation){n.next=9;break}return n.abrupt("return",1);case 9:case"end":return n.stop()}}),n)})),u.s();case 7:if((c=u.n()).done){n.next=13;break}return n.delegateYield(l(),"t0",9);case 9:if(!n.t0){n.next=11;break}return n.abrupt("break",13);case 11:n.next=7;break;case 13:n.next=18;break;case 15:n.prev=15,n.t1=n.catch(4),u.e(n.t1);case 18:return n.prev=18,u.f(),n.finish(18);case 21:case"end":return n.stop()}}),n,null,[[4,15,18,21]])})))()}},{key:"triggerHoverOnLayer",value:function(e,t){(function(e){var t,n=!0;if((null==e||null===(t=e.target)||void 0===t?void 0:t.target)instanceof HTMLElement)for(var r,i=null==e||null===(r=e.target)||void 0===r?void 0:r.target;i;){var o,a=Array.from(i.classList);if(a.includes("l7-marker")||a.includes("l7-popup")){n=!1;break}i=null===(o=i)||void 0===o?void 0:o.parentElement}return n})(t)&&(this.handleCursor(e,t.type),e.emit(t.type,t))}}])}(),Ul=function(){return c((function e(){var t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];f(this,e),ne(this,"autoStart",void 0),ne(this,"startTime",0),ne(this,"oldTime",0),ne(this,"running",!1),ne(this,"elapsedTime",0),this.autoStart=t}),[{key:"start",value:function(){this.startTime=("undefined"==typeof performance?Date:performance).now(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0}},{key:"stop",value:function(){this.getElapsedTime(),this.running=!1,this.autoStart=!1}},{key:"getElapsedTime",value:function(){return this.getDelta(),this.elapsedTime}},{key:"getDelta",value:function(){var e=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){var t=("undefined"==typeof performance?Date:performance).now();e=(t-this.oldTime)/1e3,this.oldTime=t,this.elapsedTime+=e}return e}}])}(),Gl=Ni.throttle,zl=function(e){function t(e){var n;return f(this,t),n=h(this,t),ne(n,"pickedLayerId",-1),ne(n,"clock",new Ul),ne(n,"alreadyInRendering",!1),ne(n,"layers",[]),ne(n,"layerList",[]),ne(n,"layerRenderID",void 0),ne(n,"sceneInited",!1),ne(n,"animateInstanceCount",0),ne(n,"shaderPicking",!0),ne(n,"enableRender",!0),ne(n,"reRender",Gl((function(){n.renderLayers()}),32)),ne(n,"throttleRenderLayers",Gl((function(){n.renderLayers()}),16)),n.container=e,n}return d(t,e),c(t,[{key:"renderService",get:function(){return this.container.rendererService}},{key:"mapService",get:function(){return this.container.mapService}},{key:"debugService",get:function(){return this.container.debugService}},{key:"needPick",value:function(e){return this.updateLayerRenderList(),this.layerList.some((function(t){return t.needPick(e)}))}},{key:"add",value:function(e){var t=this;this.layers.push(e),this.sceneInited&&e.init().then((function(){t.renderLayers()}))}},{key:"addMask",value:function(e){var t=this;this.sceneInited&&e.init().then((function(){t.renderLayers()}))}},{key:"initLayers",value:function(){var e=this;return ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:e.sceneInited=!0,e.layers.forEach(function(){var t=ie(i().mark((function t(n){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n.startInit){t.next=4;break}return t.next=3,n.init();case 3:e.updateLayerRenderList();case 4:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}());case 2:case"end":return t.stop()}}),t)})))()}},{key:"getSceneInited",value:function(){return this.sceneInited}},{key:"getRenderList",value:function(){return this.layerList}},{key:"getLayers",value:function(){return this.layers}},{key:"getLayer",value:function(e){return this.layers.find((function(t){return t.id===e}))}},{key:"getLayerByName",value:function(e){return this.layers.find((function(t){return t.name===e}))}},{key:"remove",value:function(e,t){var n=this;return ie(i().mark((function r(){return i().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:t?t.layerChildren=t.layerChildren.filter((function(t){return t!==e})):n.layers=n.layers.filter((function(t){return t!==e})),e.destroy(),n.reRender(),n.emit("layerChange",n.layers);case 4:case"end":return r.stop()}}),r)})))()}},{key:"removeAllLayers",value:function(){var e=this;return ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:e.destroy(),e.reRender();case 2:case"end":return t.stop()}}),t)})))()}},{key:"setEnableRender",value:function(e){this.enableRender=e}},{key:"renderLayers",value:function(){var e=this;return ie(i().mark((function t(){var n,r,o,a,s,u,c,l;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!e.alreadyInRendering&&e.enableRender){t.next=2;break}return t.abrupt("return");case 2:e.updateLayerRenderList(),n=e.debugService.generateRenderUid(),e.debugService.renderStart(n),e.alreadyInRendering=!0,e.clear(),r=y(e.layerList);try{for(r.s();!(o=r.n()).done;)o.value.prerender()}catch(i){r.e(i)}finally{r.f()}e.renderService.beginFrame(),a=y(e.layerList),t.prev=11,a.s();case 13:if((s=a.n()).done){t.next=25;break}if(u=s.value,c=u.getLayerConfig(),l=c.enableMask,u.masks.filter((function(e){return e.inited})).length>0&&l&&e.renderMask(u.masks),!u.getLayerConfig().enableMultiPassRenderer){t.next=22;break}return t.next=20,u.renderMultiPass();case 20:t.next=23;break;case 22:u.render();case 23:t.next=13;break;case 25:t.next=30;break;case 27:t.prev=27,t.t0=t.catch(11),a.e(t.t0);case 30:return t.prev=30,a.f(),t.finish(30);case 33:e.renderService.endFrame(),e.debugService.renderEnd(n),e.alreadyInRendering=!1;case 36:case"end":return t.stop()}}),t,null,[[11,27,30,33]])})))()}},{key:"renderMask",value:function(e){var t=0;this.renderService.clear({stencil:0,depth:1,framebuffer:null});var n,r=e.length>1?bc.MULTIPLE:bc.SINGLE,i=y(e);try{for(i.s();!(n=i.n()).done;){n.value.render({isStencil:!0,stencilType:r,stencilIndex:t++})}}catch(o){i.e(o)}finally{i.f()}}},{key:"beforeRenderData",value:function(e){var t=this;return ie(i().mark((function n(){return i().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,e.hooks.beforeRenderData.promise();case 2:n.sent&&t.renderLayers();case 4:case"end":return n.stop()}}),n)})))()}},{key:"renderTileLayerMask",value:function(e){var t=0,n=e.getLayerConfig().enableMask,r=void 0===n||n,i=e.tileMask?1:0,o=e.masks.filter((function(e){return e.inited})),a=(i+=r?o.length:1)>1?bc.MULTIPLE:bc.SINGLE;if((e.tileMask||o.length&&r)&&this.renderService.clear({stencil:0,depth:1,framebuffer:null}),o.length&&r){var s,u=y(o);try{for(u.s();!(s=u.n()).done;){s.value.render({isStencil:!0,stencilType:a,stencilIndex:t++})}}catch(c){u.e(c)}finally{u.f()}}e.tileMask&&e.tileMask.render({isStencil:!0,stencilType:a,stencilIndex:t++,stencilOperation:Ac.OR})}},{key:"renderTileLayer",value:function(e){var t=this;return ie(i().mark((function n(){return i().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(t.renderTileLayerMask(e),!e.getLayerConfig().enableMultiPassRenderer){n.next=6;break}return n.next=4,e.renderMultiPass();case 4:n.next=8;break;case 6:return n.next=8,e.render();case 8:case"end":return n.stop()}}),n)})))()}},{key:"updateLayerRenderList",value:function(){var e=this;this.layerList=[],this.layers.filter((function(e){return e.inited})).filter((function(e){return e.isVisible()})).sort((function(e,t){return e.zIndex-t.zIndex})).forEach((function(t){e.layerList.push(t)}))}},{key:"destroy",value:function(){this.layers.forEach((function(e){e.destroy()})),this.layers=[],this.layerList=[],this.emit("layerChange",this.layers)}},{key:"startAnimate",value:function(){0==this.animateInstanceCount++&&(this.clock.start(),this.runRender())}},{key:"stopAnimate",value:function(){0==--this.animateInstanceCount&&(this.stopRender(),this.clock.stop())}},{key:"getOESTextureFloat",value:function(){return this.renderService.extensionObject.OES_texture_float}},{key:"enableShaderPick",value:function(){this.shaderPicking=!0}},{key:"disableShaderPick",value:function(){this.shaderPicking=!1}},{key:"getShaderPickStat",value:function(){return this.shaderPicking}},{key:"clear",value:function(){var e=Ht(this.mapService.bgColor);this.renderService.clear({color:e,depth:1,stencil:0,framebuffer:null})}},{key:"runRender",value:function(){this.renderLayers(),this.layerRenderID=window.requestAnimationFrame(this.runRender.bind(this))}},{key:"stopRender",value:function(){window.cancelAnimationFrame(this.layerRenderID)}}])}(lo.exports.EventEmitter),jl=Ni.isNil,Vl=function(){return c((function e(t){var n=this;f(this,e),ne(this,"name",void 0),ne(this,"type",void 0),ne(this,"scale",void 0),ne(this,"descriptor",void 0),ne(this,"featureBufferLayout",[]),ne(this,"needRescale",!1),ne(this,"needRemapping",!1),ne(this,"needRegenerateVertices",!1),ne(this,"featureRange",{startIndex:0,endIndex:1/0}),ne(this,"vertexAttribute",void 0),ne(this,"defaultCallback",(function(e){var t;return 0===e.length?(null===(t=n.scale)||void 0===t?void 0:t.defaultValues)||[]:e.map((function(e,t){var r;return(null===(r=n.scale)||void 0===r?void 0:r.scalers[t].func)(e)}))})),this.setProps(t)}),[{key:"setProps",value:function(e){Object.assign(this,e)}},{key:"mapping",value:function(e){var t;if(null!==(t=this.scale)&&void 0!==t&&t.callback){var n,i,o=null===(i=this.scale)||void 0===i?void 0:(n=i).callback.apply(n,r(e));if(!jl(o))return[o]}return this.defaultCallback(e)}},{key:"resetDescriptor",value:function(){this.descriptor&&(this.descriptor.buffer.data=[])}}])}(),Hl=["buffer","update","name"],Xl=["buffer","update","name"],Wl=o(o(o({},Bu.FLOAT,4),Bu.UNSIGNED_BYTE,1),Bu.UNSIGNED_SHORT,2),Yl=function(){return c((function e(t){f(this,e),ne(this,"attributesAndIndices",void 0),ne(this,"attributes",[]),ne(this,"triangulation",void 0),ne(this,"featureLayout",{sizePerElement:0,elements:[]}),this.rendererService=t}),[{key:"registerStyleAttribute",value:function(e){var t=this.getLayerStyleAttribute(e.name||"");return t?t.setProps(e):(t=new Vl(e),this.attributes.push(t)),t}},{key:"unRegisterStyleAttribute",value:function(e){var t=this.attributes.findIndex((function(t){return t.name===e}));t>-1&&this.attributes.splice(t,1)}},{key:"updateScaleAttribute",value:function(e){this.attributes.forEach((function(t){var n,r=t.name,i=null===(n=t.scale)||void 0===n?void 0:n.field;(e[r]||i&&e[i])&&(t.needRescale=!0,t.needRemapping=!0,t.needRegenerateVertices=!0)}))}},{key:"updateStyleAttribute",value:function(e,t,n){var r=this.getLayerStyleAttribute(e);r||(r=this.registerStyleAttribute(re(re({},t),{},{name:e})));var i=t.scale;i&&r&&(r.scale=i,r.needRescale=!0,r.needRemapping=!0,r.needRegenerateVertices=!0,n&&n.featureRange&&(r.featureRange=n.featureRange))}},{key:"getLayerStyleAttributes",value:function(){return this.attributes}},{key:"getLayerStyleAttribute",value:function(e){return this.attributes.find((function(t){return t.name===e}))}},{key:"getLayerAttributeScale",value:function(e){var t,n=this.getLayerStyleAttribute(e),r=null==n||null===(t=n.scale)||void 0===t?void 0:t.scalers;return r&&r[0]?r[0].func:null}},{key:"updateAttributeByFeatureRange",value:function(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3?arguments[3]:void 0,o=arguments.length>4?arguments[4]:void 0,a=this.attributes.find((function(t){return t.name===e}));if(a&&a.descriptor){var s=a.descriptor,u=s.update,c=s.buffer,l=s.size,f=void 0===l?0:l,h=Wl[c.type||Bu.FLOAT];if(u){var d=this.featureLayout,p=d.elements,v=d.sizePerElement,m=p.slice(n,i);if(!m.length)return;var g=m[0].offset*f*h,_=m.map((function(e,n){for(var i=e.featureIdx,o=e.vertices,a=e.normals,s=o.length/v,c=[],l=0;l<s;l++){var f=a?a.slice(3*l,3*l+3):[];c.push.apply(c,r(u(t[i],i,o.slice(l*v,l*v+v),n,f)))}return c})).flat();a.vertexAttribute.updateBuffer({data:_,offset:g}),null==o||o.emit("legend:".concat(e),o.getLegend(e))}}}},{key:"createAttributesAndIndices",value:function(e,t,n,i){var o=this;this.featureLayout={sizePerElement:0,elements:[]},t&&(this.triangulation=t);var a=this.attributes.map((function(e){return e.resetDescriptor(),e.descriptor})),s=0,u=0,c=[],l=3;e.forEach((function(e,t){var i=o.triangulation(e,n),f=i.indices,h=i.vertices,d=i.normals,p=i.size,v=i.indexes,m=i.count;"number"==typeof m&&(u+=m),f.forEach((function(e){c.push(e+s)})),l=p;var g=h.length/p;o.featureLayout.sizePerElement=l,o.featureLayout.elements.push({featureIdx:t,vertices:h,normals:d,offset:s}),s+=g;for(var _=function(n){var i=(null==d?void 0:d.slice(3*n,3*n+3))||[],o=h.slice(n*p,n*p+p),s=0;v&&void 0!==v[n]&&(s=v[n]),a.forEach((function(a,u){var c;a&&a.update&&(c=a.buffer.data).push.apply(c,r(a.update(e,t,o,n,i,s)))}))},y=0;y<g;y++)_(y)}));var f=this.rendererService,h=f.createAttribute,d=f.createBuffer,p=f.createElements,v={};a.forEach((function(e,t){if(e){var n=e.buffer,r=(e.update,e.name,oe(e,Hl)),i=h(re({buffer:d(n)},r));v[e.name||""]=i,o.attributes[t].vertexAttribute=i}}));var m=p({data:c,type:Bu.UNSIGNED_INT,count:c.length});return this.attributesAndIndices={attributes:v,elements:m,count:u},Object.values(this.attributes).filter((function(e){return e.scale})).forEach((function(e){var t=e.name;null==i||i.emit("legend:".concat(t),i.getLegend(t))})),this.attributesAndIndices}},{key:"createAttributes",value:function(e,t){var n=this;this.featureLayout={sizePerElement:0,elements:[]},t&&(this.triangulation=t);var i=this.attributes.map((function(e){return e.resetDescriptor(),e.descriptor})),o=0,a=3;e.forEach((function(e,t){var s=n.triangulation(e),u=s.indices,c=s.vertices,l=s.normals,f=s.size,h=s.indexes;u.forEach((function(e){})),a=f;var d=c.length/f;n.featureLayout.sizePerElement=a,n.featureLayout.elements.push({featureIdx:t,vertices:c,normals:l,offset:o}),o+=d;for(var p=function(n){var o=(null==l?void 0:l.slice(3*n,3*n+3))||[],a=c.slice(n*f,n*f+f),s=0;h&&void 0!==h[n]&&(s=h[n]),i.forEach((function(i,u){var c;i&&i.update&&(c=i.buffer.data).push.apply(c,r(i.update(e,t,a,n,o,s)))}))},v=0;v<d;v++)p(v)}));var s=this.rendererService,u=s.createAttribute,c=s.createBuffer,l={};return i.forEach((function(e,t){if(e){var r=e.buffer,i=(e.update,e.name,oe(e,Xl)),o=u(re({buffer:c(r)},i));l[e.name||""]=o,n.attributes[t].vertexAttribute=o}})),{attributes:l}}},{key:"clearAllAttributes",value:function(){var e;this.attributes.forEach((function(e){e.vertexAttribute&&e.vertexAttribute.destroy()})),null===(e=this.attributesAndIndices)||void 0===e||e.elements.destroy(),this.attributes=[]}}])}();function Zl(e,t,n,r){return new(n||(n=Promise))((function(i,o){function a(e){try{u(r.next(e))}catch(t){o(t)}}function s(e){try{u(r.throw(e))}catch(t){o(t)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((r=r.apply(e,t||[])).next())}))}function ql(e,t){var n,r,i,o,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(i=a.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){a.label=o[1];break}if(6===o[0]&&a.label<i[1]){a.label=i[1],i=o;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(o);break}i[2]&&a.ops.pop(),a.trys.pop();continue}o=t.call(e,a)}catch(s){o=[6,s],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}function Kl(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,i,o=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=o.next()).done;)a.push(r.value)}catch(s){i={error:s}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return a}function Ql(e,t,n){if(n||2===arguments.length)for(var r,i=0,o=t.length;i<o;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))}function $l(e){return e&&e.__esModule&&Object.prototype.hasOwnProperty.call(e,"default")?e.default:e}var Jl={exports:{}},ef={exports:{}},tf={exports:{}};!function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return e&&"number"==typeof e.length&&e.length>=0&&e.length%1==0},e.exports=t.default}(tf,tf.exports);var nf={},rf={exports:{}},of={exports:{}};!function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return function(){for(var t=[],n=arguments.length;n--;)t[n]=arguments[n];var r=t.pop();return e.call(this,t,r)}},e.exports=t.default}(of,of.exports);var af={};Object.defineProperty(af,"__esModule",{value:!0}),af.fallback=ff,af.wrap=hf;var sf,uf=af.hasQueueMicrotask="function"==typeof queueMicrotask&&queueMicrotask,cf=af.hasSetImmediate="function"==typeof setImmediate&&setImmediate,lf=af.hasNextTick="object"===("undefined"==typeof process?"undefined":s(process))&&"function"==typeof process.nextTick;function ff(e){setTimeout(e,0)}function hf(e){return function(t){for(var n=[],r=arguments.length-1;r-- >0;)n[r]=arguments[r+1];return e((function(){return t.apply(void 0,n)}))}}sf=uf?queueMicrotask:cf?setImmediate:lf?process.nextTick:ff,af.default=hf(sf),function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){if((0,i.isAsync)(e))return function(){for(var t=[],n=arguments.length;n--;)t[n]=arguments[n];var r=t.pop();return a(e.apply(this,t),r)};return(0,n.default)((function(t,n){var r;try{r=e.apply(this,t)}catch(i){return n(i)}if(r&&"function"==typeof r.then)return a(r,n);n(null,r)}))};var n=o(of.exports),r=o(af),i=nf;function o(e){return e&&e.__esModule?e:{default:e}}function a(e,t){return e.then((function(e){s(t,null,e)}),(function(e){s(t,e&&e.message?e:new Error(e))}))}function s(e,t,n){try{e(t,n)}catch(i){(0,r.default)((function(e){throw e}),i)}}e.exports=t.default}(rf,rf.exports),Object.defineProperty(nf,"__esModule",{value:!0}),nf.isAsyncIterable=nf.isAsyncGenerator=nf.isAsync=void 0;var df,pf=(df=rf.exports)&&df.__esModule?df:{default:df};function vf(e){return"AsyncFunction"===e[Symbol.toStringTag]}nf.default=function(e){if("function"!=typeof e)throw new Error("expected a function");return vf(e)?(0,pf.default)(e):e},nf.isAsync=vf,nf.isAsyncGenerator=function(e){return"AsyncGenerator"===e[Symbol.toStringTag]},nf.isAsyncIterable=function(e){return"function"==typeof e[Symbol.asyncIterator]};var mf={exports:{}};!function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){void 0===t&&(t=e.length);if(!t)throw new Error("arity is undefined");return function(){for(var n=this,r=[],i=arguments.length;i--;)r[i]=arguments[i];return"function"==typeof r[t-1]?e.apply(this,r):new Promise((function(i,o){r[t-1]=function(e){for(var t=[],n=arguments.length-1;n-- >0;)t[n]=arguments[n+1];if(e)return o(e);i(t.length>1?t:t[0])},e.apply(n,r)}))}},e.exports=t.default}(mf,mf.exports),function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=o(tf.exports),r=o(nf),i=o(mf.exports);function o(e){return e&&e.__esModule?e:{default:e}}t.default=(0,i.default)((function(e,t,i){var o=(0,n.default)(t)?[]:{};e(t,(function(e,t,n){(0,r.default)(e)((function(e){for(var r=[],i=arguments.length-1;i-- >0;)r[i]=arguments[i+1];r.length<2&&(r=r[0]),o[t]=r,n(e)}))}),(function(e){return i(e,o)}))}),3),e.exports=t.default}(ef,ef.exports);var gf={exports:{}},_f={exports:{}},yf={exports:{}},Ef={exports:{}};!function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){function t(){for(var t=[],n=arguments.length;n--;)t[n]=arguments[n];if(null!==e){var r=e;e=null,r.apply(this,t)}}return Object.assign(t,e),t},e.exports=t.default}(Ef,Ef.exports);var bf={exports:{}},Af={exports:{}};!function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return e[Symbol.iterator]&&e[Symbol.iterator]()},e.exports=t.default}(Af,Af.exports),function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){if((0,n.default)(e))return function(e){var t=-1,n=e.length;return function(){return++t<n?{value:e[t],key:t}:null}}(e);var t=(0,r.default)(e);return t?function(e){var t=-1;return function(){var n=e.next();return n.done?null:(t++,{value:n.value,key:t})}}(t):function(e){var t=e?Object.keys(e):[],n=-1,r=t.length;return function i(){var o=t[++n];return"__proto__"===o?i():n<r?{value:e[o],key:o}:null}}(e)};var n=i(tf.exports),r=i(Af.exports);function i(e){return e&&e.__esModule?e:{default:e}}e.exports=t.default}(bf,bf.exports);var xf={exports:{}};!function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return function(){for(var t=[],n=arguments.length;n--;)t[n]=arguments[n];if(null===e)throw new Error("Callback was already called.");var r=e;e=null,r.apply(this,t)}},e.exports=t.default}(xf,xf.exports);var Sf={exports:{}},Tf={exports:{}};!function(e,t){Object.defineProperty(t,"__esModule",{value:!0});t.default={},e.exports=t.default}(Tf,Tf.exports),function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t,r,i){var o=!1,a=!1,s=!1,u=0,c=0;function l(){u>=t||s||o||(s=!0,e.next().then((function(e){var t=e.value,n=e.done;if(!a&&!o){if(s=!1,n)return o=!0,void(u<=0&&i(null));u++,r(t,c,f),c++,l()}})).catch(h))}function f(e,t){if(u-=1,!a)return e?h(e):!1===e?(o=!0,void(a=!0)):t===n.default||o&&u<=0?(o=!0,i(null)):void l()}function h(e){a||(s=!1,o=!0,i(e))}l()};var n=function(e){return e&&e.__esModule?e:{default:e}}(Tf.exports);e.exports=t.default}(Sf,Sf.exports),function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=u(Ef.exports),r=u(bf.exports),i=u(xf.exports),o=nf,a=u(Sf.exports),s=u(Tf.exports);function u(e){return e&&e.__esModule?e:{default:e}}t.default=function(e){return function(t,u,c){if(c=(0,n.default)(c),e<=0)throw new RangeError("concurrency limit cannot be less than 1");if(!t)return c(null);if((0,o.isAsyncGenerator)(t))return(0,a.default)(t,e,u,c);if((0,o.isAsyncIterable)(t))return(0,a.default)(t[Symbol.asyncIterator](),e,u,c);var l=(0,r.default)(t),f=!1,h=!1,d=0,p=!1;function v(e,t){if(!h)if(d-=1,e)f=!0,c(e);else if(!1===e)f=!0,h=!0;else{if(t===s.default||f&&d<=0)return f=!0,c(null);p||m()}}function m(){for(p=!0;d<e&&!f;){var t=l();if(null===t)return f=!0,void(d<=0&&c(null));d+=1,u(t.value,t.key,(0,i.default)(v))}p=!1}m()}},e.exports=t.default}(yf,yf.exports),function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=o(yf.exports),r=o(nf),i=o(mf.exports);function o(e){return e&&e.__esModule?e:{default:e}}t.default=(0,i.default)((function(e,t,i,o){return(0,n.default)(t)(e,(0,r.default)(i),o)}),4),e.exports=t.default}(_f,_f.exports),function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=i(_f.exports),r=i(mf.exports);function i(e){return e&&e.__esModule?e:{default:e}}t.default=(0,r.default)((function(e,t,r){return(0,n.default)(e,1,t,r)}),3),e.exports=t.default}(gf,gf.exports),function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){return(0,n.default)(r.default,e,t)};var n=i(ef.exports),r=i(gf.exports);function i(e){return e&&e.__esModule?e:{default:e}}e.exports=t.default}(Jl,Jl.exports);var Rf=$l(Jl.exports),Cf=function(){function e(){this.args=[],this.tasks=[]}return e.prototype.call=function(){for(var e=arguments,t=[],n=0;n<arguments.length;n++)t[n]=e[n];return this.args=t,Rf(this.tasks)},e.prototype.tap=function(e,t){var n=this;this.tasks.push((function(r){t.apply(void 0,Ql([],Kl(n.args),!1)),r(null,e)}))},e}(),Mf={exports:{}},wf={exports:{}};!function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=c(tf.exports),r=c(Tf.exports),i=c(_f.exports),o=c(Ef.exports),a=c(xf.exports),s=c(nf),u=c(mf.exports);function c(e){return e&&e.__esModule?e:{default:e}}function l(e,t,n){n=(0,o.default)(n);var i=0,s=0,u=e.length,c=!1;function l(e,t){!1===e&&(c=!0),!0!==c&&(e?n(e):++s!==u&&t!==r.default||n(null))}for(0===u&&n(null);i<u;i++)t(e[i],i,(0,a.default)(l))}function f(e,t,n){return(0,i.default)(e,1/0,t,n)}t.default=(0,u.default)((function(e,t,r){return((0,n.default)(e)?l:f)(e,(0,s.default)(t),r)}),3),e.exports=t.default}(wf,wf.exports),function(e,t){Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){return(0,r.default)(n.default,e,t)};var n=i(wf.exports),r=i(ef.exports);function i(e){return e&&e.__esModule?e:{default:e}}e.exports=t.default}(Mf,Mf.exports);var Lf={exports:{}};!function(e,t){Object.defineProperty(t,"__esModule",{value:!0});var n=a(Ef.exports),r=a(xf.exports),i=a(nf),o=a(mf.exports);function a(e){return e&&e.__esModule?e:{default:e}}t.default=(0,o.default)((function(e,t){if(t=(0,n.default)(t),!Array.isArray(e))return t(new Error("First argument to waterfall must be an array of functions"));if(!e.length)return t();var o=0;function a(t){(0,i.default)(e[o++]).apply(void 0,t.concat([(0,r.default)(s)]))}function s(n){for(var r=[],i=arguments.length-1;i-- >0;)r[i]=arguments[i+1];if(!1!==n)return n||o===e.length?t.apply(void 0,[n].concat(r)):void a(r)}a([])})),e.exports=t.default}(Lf,Lf.exports);var Of=$l(Lf.exports),kf=function(){function e(){this.tasks=[]}return e.prototype.call=function(){return Rf(this.tasks)},e.prototype.tap=function(e,t){this.tasks.push((function(n){n(t(),e)}))},e}(),Nf=function(){function e(){this.args=[],this.tasks=[]}return e.prototype.promise=function(){for(var e=arguments,t=[],n=0;n<arguments.length;n++)t[n]=e[n];return this.args=t,Rf(this.tasks)},e.prototype.tapPromise=function(e,t){var n=this;this.tasks.push((function(r){return Zl(n,void 0,void 0,(function(){return ql(this,(function(n){switch(n.label){case 0:return[4,t.apply(void 0,Ql([],Kl(this.args),!1))];case 1:return n.sent(),r(null,e),[2]}}))}))}))},e}(),If=function(){function e(){this.args=[],this.tasks=[]}return e.prototype.promise=function(){for(var e=arguments,t=[],n=0;n<arguments.length;n++)t[n]=e[n];return this.args=t,Rf(this.tasks)},e.prototype.tapPromise=function(e,t){var n=this;this.tasks.push((function(r){return Zl(n,void 0,void 0,(function(){var n;return ql(this,(function(i){switch(i.label){case 0:return[4,t.apply(void 0,Ql([],Kl(this.args),!1))];case 1:return n=i.sent(),r(n,e),[2]}}))}))}))},e}(),Pf=function(){function e(){this.tasks=[]}return e.prototype.promise=function(){return Of(this.tasks)},e.prototype.tapPromise=function(e,t){0===this.tasks.length?this.tasks.push((function(e){t().then((function(t){e(null,t)}))})):this.tasks.push((function(e,n){t(e).then((function(e){n(null,e)}))}))},e}(),Df={exports:{}};(Df.exports={}).forEach=function(e,t){for(var n=0;n<e.length;n++){var r=t(e[n]);if(r)return r}};var Ff={exports:{}},Bf=Ff.exports={};Bf.isIE=function(e){return(-1!==(t=navigator.userAgent.toLowerCase()).indexOf("msie")||-1!==t.indexOf("trident")||-1!==t.indexOf(" edge/"))&&(!e||e===function(){var e=3,t=document.createElement("div"),n=t.getElementsByTagName("i");do{t.innerHTML="\x3c!--[if gt IE "+ ++e+"]><i></i><![endif]--\x3e"}while(n[0]);return e>4?e:undefined}());var t},Bf.isLegacyOpera=function(){return!!window.opera};var Uf={exports:{}};(Uf.exports={}).getOption=function(e,t,n){var r=e[t];if(null==r&&void 0!==n)return n;return r};var Gf=Uf.exports;function zf(){var e={},t=0,n=0,r=0;return{add:function(i,o){o||(o=i,i=0),i>n?n=i:i<r&&(r=i),e[i]||(e[i]=[]),e[i].push(o),t++},process:function(){for(var t=r;t<=n;t++)for(var i=e[t],o=0;o<i.length;o++){(0,i[o])()}},size:function(){return t}}}var jf="_erd";function Vf(e){return e[jf]}var Hf={initState:function(e){return e[jf]={},Vf(e)},getState:Vf,cleanState:function(e){delete e[jf]}},Xf=Ff.exports,Wf=Df.exports.forEach,Yf=Df.exports.forEach,Zf=function(e){var t=e.stateHandler.getState;return{isDetectable:function(e){var n=t(e);return n&&!!n.isDetectable},markAsDetectable:function(e){t(e).isDetectable=!0},isBusy:function(e){return!!t(e).busy},markBusy:function(e,n){t(e).busy=!!n}}},qf=function(e){var t={};function n(n){var r=e.get(n);return void 0===r?[]:t[r]||[]}return{get:n,add:function(n,r){var i=e.get(n);t[i]||(t[i]=[]),t[i].push(r)},removeListener:function(e,t){for(var r=n(e),i=0,o=r.length;i<o;++i)if(r[i]===t){r.splice(i,1);break}},removeAllListeners:function(e){var t=n(e);t&&(t.length=0)}}},Kf=function(){var e=1;return{generate:function(){return e++}}},Qf=function(e){var t=e.idGenerator,n=e.stateHandler.getState;return{get:function(e){var t=n(e);return t&&void 0!==t.id?t.id:null},set:function(e){var r=n(e);if(!r)throw new Error("setId required the element to have a resize detection state.");var i=t.generate();return r.id=i,i}}},$f=function(e){function t(){}var n={log:t,warn:t,error:t};if(!e&&window.console){var r=function(e,t){e[t]=function(){var e=console[t];if(e.apply)e.apply(console,arguments);else for(var n=0;n<arguments.length;n++)e(arguments[n])}};r(n,"log"),r(n,"warn"),r(n,"error")}return n},Jf=Ff.exports,eh=function(e){var t=(e=e||{}).reporter,n=Gf.getOption(e,"async",!0),r=Gf.getOption(e,"auto",!0);r&&!n&&(t&&t.warn("Invalid options combination. auto=true and async=false is invalid. Setting async=true."),n=!0);var i,o=zf(),a=!1;function s(){for(a=!0;o.size();){var e=o;o=zf(),e.process()}a=!1}function u(){var e;e=s,i=setTimeout(e,0)}return{add:function(e,t){!a&&r&&n&&0===o.size()&&u(),o.add(e,t)},force:function(e){a||(void 0===e&&(e=n),i&&(clearTimeout(i),i=null),e?u():s())}}},th=Hf,nh=function(e){var t=(e=e||{}).reporter,n=e.batchProcessor,r=e.stateHandler.getState;if(!t)throw new Error("Missing required dependency: reporter.");function i(t){var n=e.important?" !important; ":"; ";return(t.join(n)+n).trim()}function o(e){return r(e).object}return{makeDetectable:function(e,o,a){a||(a=o,o=e,e=null),(e=e||{}).debug,Xf.isIE(8)?a(o):function(o,a){var s=i(["display: block","position: absolute","top: 0","left: 0","width: 100%","height: 100%","border: none","padding: 0","margin: 0","opacity: 0","z-index: -1000","pointer-events: none"]),u=!1,c=window.getComputedStyle(o),l=o.offsetWidth,f=o.offsetHeight;function h(){function n(){if("static"===c.position){o.style.setProperty("position","relative",e.important?"important":"");var n=function(t,n,r,i){var o=r[i];"auto"!==o&&"0"!==function(e){return e.replace(/[^-\d\.]/g,"")}(o)&&(t.warn("An element that is positioned static has style."+i+"="+o+" which is ignored due to the static positioning. The element will need to be positioned relative, so the style."+i+" will be set to 0. Element: ",n),n.style.setProperty(i,"0",e.important?"important":""))};n(t,o,c,"top"),n(t,o,c,"right"),n(t,o,c,"bottom"),n(t,o,c,"left")}}""!==c.position&&(n(),u=!0);var i=document.createElement("object");i.style.cssText=s,i.tabIndex=-1,i.type="text/html",i.setAttribute("aria-hidden","true"),i.onload=function(){u||n(),function e(t,n){if(!t.contentDocument){var i=r(t);return i.checkForObjectDocumentTimeoutId&&window.clearTimeout(i.checkForObjectDocumentTimeoutId),void(i.checkForObjectDocumentTimeoutId=setTimeout((function(){i.checkForObjectDocumentTimeoutId=0,e(t,n)}),100))}n(t.contentDocument)}(this,(function(e){a(o)}))},Xf.isIE()||(i.data="about:blank"),r(o)&&(o.appendChild(i),r(o).object=i,Xf.isIE()&&(i.data="about:blank"))}r(o).startSize={width:l,height:f},n?n.add(h):h()}(o,a)},addListener:function(e,t){function n(){t(e)}if(Xf.isIE(8))r(e).object={proxy:n},e.attachEvent("onresize",n);else{var i=o(e);if(!i)throw new Error("Element is not detectable by this strategy.");i.contentDocument.defaultView.addEventListener("resize",n)}},uninstall:function(e){if(r(e)){var t=o(e);t&&(Xf.isIE(8)?e.detachEvent("onresize",t.proxy):e.removeChild(t),r(e).checkForObjectDocumentTimeoutId&&window.clearTimeout(r(e).checkForObjectDocumentTimeoutId),delete r(e).object)}}}},rh=function(e){var t=(e=e||{}).reporter,n=e.batchProcessor,r=e.stateHandler.getState;e.stateHandler.hasState;var i=e.idHandler;if(!n)throw new Error("Missing required dependency: batchProcessor");if(!t)throw new Error("Missing required dependency: reporter.");var o=function(){var e=500,t=500,n=document.createElement("div");n.style.cssText=u(["position: absolute","width: 1000px","height: 1000px","visibility: hidden","margin: 0","padding: 0"]);var r=document.createElement("div");r.style.cssText=u(["position: absolute","width: 500px","height: 500px","overflow: scroll","visibility: none","top: -1500px","left: -1500px","visibility: hidden","margin: 0","padding: 0"]),r.appendChild(n),document.body.insertBefore(r,document.body.firstChild);var i=e-r.clientWidth,o=t-r.clientHeight;return document.body.removeChild(r),{width:i,height:o}}(),a="erd_scroll_detection_container";function s(e){!function(e,t,n){function r(n,r){r=r||function(t){e.head.appendChild(t)};var i=e.createElement("style");return i.innerHTML=n,i.id=t,r(i),i}if(!e.getElementById(t)){var i=n+"_animation",o=n+"_animation_active",a="/* Created by the element-resize-detector library. */\n";a+="."+n+" > div::-webkit-scrollbar { "+u(["display: none"])+" }\n\n",a+="."+o+" { "+u(["-webkit-animation-duration: 0.1s","animation-duration: 0.1s","-webkit-animation-name: "+i,"animation-name: "+i])+" }\n",a+="@-webkit-keyframes "+i+" { 0% { opacity: 1; } 50% { opacity: 0; } 100% { opacity: 1; } }\n",r(a+="@keyframes "+i+" { 0% { opacity: 1; } 50% { opacity: 0; } 100% { opacity: 1; } }")}}(e,"erd_scroll_detection_scrollbar_style",a)}function u(t){var n=e.important?" !important; ":"; ";return(t.join(n)+n).trim()}function c(e,n,r){if(e.addEventListener)e.addEventListener(n,r);else{if(!e.attachEvent)return t.error("[scroll] Don't know how to add event listeners.");e.attachEvent("on"+n,r)}}function l(e,n,r){if(e.removeEventListener)e.removeEventListener(n,r);else{if(!e.detachEvent)return t.error("[scroll] Don't know how to remove event listeners.");e.detachEvent("on"+n,r)}}function f(e){return r(e).container.childNodes[0].childNodes[0].childNodes[0]}function h(e){return r(e).container.childNodes[0].childNodes[0].childNodes[1]}return s(window.document),{makeDetectable:function(e,s,l){function d(){if(e.debug){var n=Array.prototype.slice.call(arguments);if(n.unshift(i.get(s),"Scroll: "),t.log.apply)t.log.apply(null,n);else for(var r=0;r<n.length;r++)t.log(n[r])}}function p(e){var t=r(e).container.childNodes[0],n=window.getComputedStyle(t);return!n.width||-1===n.width.indexOf("px")}function v(){var e=window.getComputedStyle(s),t={};return t.position=e.position,t.width=s.offsetWidth,t.height=s.offsetHeight,t.top=e.top,t.right=e.right,t.bottom=e.bottom,t.left=e.left,t.widthCSS=e.width,t.heightCSS=e.height,t}function m(){if(d("storeStyle invoked."),r(s)){var e=v();r(s).style=e}else d("Aborting because element has been uninstalled")}function g(e,t,n){r(e).lastWidth=t,r(e).lastHeight=n}function _(){return 2*o.width+1}function y(){return 2*o.height+1}function E(e){return e+10+_()}function b(e){return e+10+y()}function A(e,t,n){var r=f(e),i=h(e),o=E(t),a=b(n),s=function(e){return 2*e+_()}(t),u=function(e){return 2*e+y()}(n);r.scrollLeft=o,r.scrollTop=a,i.scrollLeft=s,i.scrollTop=u}function x(){var e=r(s).container;if(!e){(e=document.createElement("div")).className=a,e.style.cssText=u(["visibility: hidden","display: inline","width: 0px","height: 0px","z-index: -1","overflow: hidden","margin: 0","padding: 0"]),r(s).container=e,function(e){e.className+=" "+a+"_animation_active"}(e),s.appendChild(e);var t=function(){r(s).onRendered&&r(s).onRendered()};c(e,"animationstart",t),r(s).onAnimationStart=t}return e}function S(){if(d("Injecting elements"),r(s)){!function(){var n=r(s).style;if("static"===n.position){s.style.setProperty("position","relative",e.important?"important":"");var i=function(e,t,n,r){var i=n[r];"auto"!==i&&"0"!==function(e){return e.replace(/[^-\d\.]/g,"")}(i)&&(e.warn("An element that is positioned static has style."+r+"="+i+" which is ignored due to the static positioning. The element will need to be positioned relative, so the style."+r+" will be set to 0. Element: ",t),t.style[r]=0)};i(t,s,n,"top"),i(t,s,n,"right"),i(t,s,n,"bottom"),i(t,s,n,"left")}}();var n=r(s).container;n||(n=x());var i,l,f,h,p=o.width,v=o.height,m=u(["position: absolute","flex: none","overflow: hidden","z-index: -1","visibility: hidden","width: 100%","height: 100%","left: 0px","top: 0px"]),g=u(["position: absolute","flex: none","overflow: hidden","z-index: -1","visibility: hidden"].concat(["left: "+(i=(i=-(1+p))?i+"px":"0"),"top: "+(l=(l=-(1+v))?l+"px":"0"),"right: "+(h=(h=-p)?h+"px":"0"),"bottom: "+(f=(f=-v)?f+"px":"0")])),_=u(["position: absolute","flex: none","overflow: scroll","z-index: -1","visibility: hidden","width: 100%","height: 100%"]),y=u(["position: absolute","flex: none","overflow: scroll","z-index: -1","visibility: hidden","width: 100%","height: 100%"]),E=u(["position: absolute","left: 0","top: 0"]),b=u(["position: absolute","width: 200%","height: 200%"]),A=document.createElement("div"),S=document.createElement("div"),T=document.createElement("div"),R=document.createElement("div"),C=document.createElement("div"),M=document.createElement("div");A.dir="ltr",A.style.cssText=m,A.className=a,S.className=a,S.style.cssText=g,T.style.cssText=_,R.style.cssText=E,C.style.cssText=y,M.style.cssText=b,T.appendChild(R),C.appendChild(M),S.appendChild(T),S.appendChild(C),A.appendChild(S),n.appendChild(A),c(T,"scroll",w),c(C,"scroll",L),r(s).onExpandScroll=w,r(s).onShrinkScroll=L}else d("Aborting because element has been uninstalled");function w(){var e=r(s);e&&e.onExpand?e.onExpand():d("Aborting expand scroll handler: element has been uninstalled")}function L(){var e=r(s);e&&e.onShrink?e.onShrink():d("Aborting shrink scroll handler: element has been uninstalled")}}function T(){function o(t,n,r){var i=function(e){return f(e).childNodes[0]}(t),o=E(n),a=b(r);i.style.setProperty("width",o+"px",e.important?"important":""),i.style.setProperty("height",a+"px",e.important?"important":"")}function a(a){var c=s.offsetWidth,l=s.offsetHeight,f=c!==r(s).lastWidth||l!==r(s).lastHeight;d("Storing current size",c,l),g(s,c,l),n.add(0,(function(){if(f)if(r(s))if(u()){if(e.debug){var n=s.offsetWidth,a=s.offsetHeight;n===c&&a===l||t.warn(i.get(s),"Scroll: Size changed before updating detector elements.")}o(s,c,l)}else d("Aborting because element container has not been initialized");else d("Aborting because element has been uninstalled")})),n.add(1,(function(){r(s)?u()?A(s,c,l):d("Aborting because element container has not been initialized"):d("Aborting because element has been uninstalled")})),f&&a&&n.add(2,(function(){r(s)?u()?a():d("Aborting because element container has not been initialized"):d("Aborting because element has been uninstalled")}))}function u(){return!!r(s).container}function c(){d("notifyListenersIfNeeded invoked");var e=r(s);return void 0===r(s).lastNotifiedWidth&&e.lastWidth===e.startSize.width&&e.lastHeight===e.startSize.height?d("Not notifying: Size is the same as the start size, and there has been no notification yet."):e.lastWidth===e.lastNotifiedWidth&&e.lastHeight===e.lastNotifiedHeight?d("Not notifying: Size already notified"):(d("Current size not notified, notifying..."),e.lastNotifiedWidth=e.lastWidth,e.lastNotifiedHeight=e.lastHeight,void Wf(r(s).listeners,(function(e){e(s)})))}function l(){d("Scroll detected."),p(s)?d("Scroll event fired while unrendered. Ignoring..."):a(c)}if(d("registerListenersAndPositionElements invoked."),r(s)){r(s).onRendered=function(){if(d("startanimation triggered."),p(s))d("Ignoring since element is still unrendered...");else{d("Element rendered.");var e=f(s),t=h(s);0!==e.scrollLeft&&0!==e.scrollTop&&0!==t.scrollLeft&&0!==t.scrollTop||(d("Scrollbars out of sync. Updating detector elements..."),a(c))}},r(s).onExpand=l,r(s).onShrink=l;var v=r(s).style;o(s,v.width,v.height)}else d("Aborting because element has been uninstalled")}function R(){if(d("finalizeDomMutation invoked."),r(s)){var e=r(s).style;g(s,e.width,e.height),A(s,e.width,e.height)}else d("Aborting because element has been uninstalled")}function C(){l(s)}function M(){var e;d("Installing..."),r(s).listeners=[],e=v(),r(s).startSize={width:e.width,height:e.height},d("Element start size",r(s).startSize),n.add(0,m),n.add(1,S),n.add(2,T),n.add(3,R),n.add(4,C)}l||(l=s,s=e,e=null),e=e||{},d("Making detectable..."),!function(e){return!function(e){var t=e.getRootNode&&e.getRootNode().contains(e);return e===e.ownerDocument.body||e.ownerDocument.body.contains(e)||t}(e)||null===window.getComputedStyle(e)}(s)?M():(d("Element is detached"),x(),d("Waiting until element is attached..."),r(s).onRendered=function(){d("Element is now attached"),M()})},addListener:function(e,t){if(!r(e).listeners.push)throw new Error("Cannot add listener to an element that is not detectable.");r(e).listeners.push(t)},uninstall:function(e){var t=r(e);t&&(t.onExpandScroll&&l(f(e),"scroll",t.onExpandScroll),t.onShrinkScroll&&l(h(e),"scroll",t.onShrinkScroll),t.onAnimationStart&&l(t.container,"animationstart",t.onAnimationStart),t.container&&e.removeChild(t.container))},initDocument:s}};function ih(e){return Array.isArray(e)||void 0!==e.length}function oh(e){if(Array.isArray(e))return e;var t=[];return Yf(e,(function(e){t.push(e)})),t}function ah(e){return e&&1===e.nodeType}var sh=function(e){var t;if((e=e||{}).idHandler)t={get:function(t){return e.idHandler.get(t,!0)},set:e.idHandler.set};else{var n=Kf(),r=Qf({idGenerator:n,stateHandler:th});t=r}var i=e.reporter;i||(i=$f(!1===i));var o=uh(e,"batchProcessor",eh({reporter:i})),a={};a.callOnAdd=!!uh(e,"callOnAdd",!0),a.debug=!!uh(e,"debug",!1);var s,u=qf(t),c=Zf({stateHandler:th}),l=uh(e,"strategy","object"),f=uh(e,"important",!1),h={reporter:i,batchProcessor:o,stateHandler:th,idHandler:t,important:f};if("scroll"===l&&(Jf.isLegacyOpera()?(i.warn("Scroll strategy is not supported on legacy Opera. Changing to object strategy."),l="object"):Jf.isIE(9)&&(i.warn("Scroll strategy is not supported on IE9. Changing to object strategy."),l="object")),"scroll"===l)s=rh(h);else{if("object"!==l)throw new Error("Invalid strategy name: "+l);s=nh(h)}var d={};return{listenTo:function(e,n,r){function o(e){var t=u.get(e);Yf(t,(function(t){t(e)}))}function l(e,t,n){u.add(t,n),e&&n(t)}if(r||(r=n,n=e,e={}),!n)throw new Error("At least one element required.");if(!r)throw new Error("Listener required.");if(ah(n))n=[n];else{if(!ih(n))return i.error("Invalid arguments. Must be a DOM element or a collection of DOM elements.");n=oh(n)}var h=0,p=uh(e,"callOnAdd",a.callOnAdd),v=uh(e,"onReady",(function(){})),m=uh(e,"debug",a.debug);Yf(n,(function(e){th.getState(e)||(th.initState(e),t.set(e));var a=t.get(e);if(m&&i.log("Attaching listener to element",a,e),!c.isDetectable(e))return m&&i.log(a,"Not detectable."),c.isBusy(e)?(m&&i.log(a,"System busy making it detectable"),l(p,e,r),d[a]=d[a]||[],void d[a].push((function(){++h===n.length&&v()}))):(m&&i.log(a,"Making detectable..."),c.markBusy(e,!0),s.makeDetectable({debug:m,important:f},e,(function(e){if(m&&i.log(a,"onElementDetectable"),th.getState(e)){c.markAsDetectable(e),c.markBusy(e,!1),s.addListener(e,o),l(p,e,r);var t=th.getState(e);if(t&&t.startSize){var u=e.offsetWidth,f=e.offsetHeight;t.startSize.width===u&&t.startSize.height===f||o(e)}d[a]&&Yf(d[a],(function(e){e()}))}else m&&i.log(a,"Element uninstalled before being detectable.");delete d[a],++h===n.length&&v()})));m&&i.log(a,"Already detecable, adding listener."),l(p,e,r),h++})),h===n.length&&v()},removeListener:u.removeListener,removeAllListeners:u.removeAllListeners,uninstall:function(e){if(!e)return i.error("At least one element is required.");if(ah(e))e=[e];else{if(!ih(e))return i.error("Invalid arguments. Must be a DOM element or a collection of DOM elements.");e=oh(e)}Yf(e,(function(e){u.removeAllListeners(e),s.uninstall(e),th.cleanState(e)}))},initDocument:function(e){s.initDocument&&s.initDocument(e)}}};function uh(e,t,n){var r=e[t];return null==r&&void 0!==n?n:r}var ch=function(e){function t(e){var n;return f(this,t),n=h(this,t),ne(n,"destroyed",!1),ne(n,"loaded",!1),ne(n,"id",void 0),ne(n,"inited",!1),ne(n,"rendering",!1),ne(n,"$container",void 0),ne(n,"canvas",void 0),ne(n,"markerContainer",void 0),ne(n,"resizeDetector",void 0),ne(n,"hooks",void 0),ne(n,"handleWindowResized",(function(){n.emit("resize"),n.$container&&(n.initContainer(),n.coordinateSystemService.needRefresh=!0,n.render())})),ne(n,"handleMapCameraChanged",(function(e){n.cameraService.update(e),n.render()})),n.container=e,n.hooks={init:new Nf},n.id=e.id,n}return d(t,e),c(t,[{key:"iconService",get:function(){return this.container.iconService}},{key:"fontService",get:function(){return this.container.fontService}},{key:"controlService",get:function(){return this.container.controlService}},{key:"configService",get:function(){return this.container.globalConfigService}},{key:"map",get:function(){return this.container.mapService}},{key:"coordinateSystemService",get:function(){return this.container.coordinateSystemService}},{key:"rendererService",get:function(){return this.container.rendererService}},{key:"layerService",get:function(){return this.container.layerService}},{key:"debugService",get:function(){return this.container.debugService}},{key:"cameraService",get:function(){return this.container.cameraService}},{key:"interactionService",get:function(){return this.container.interactionService}},{key:"pickingService",get:function(){return this.container.pickingService}},{key:"shaderModuleService",get:function(){return this.container.shaderModuleService}},{key:"markerService",get:function(){return this.container.markerService}},{key:"popupService",get:function(){return this.container.popupService}},{key:"init",value:function(e){var t=this,n=this;this.configService.setSceneConfig(this.id,e),this.shaderModuleService.registerBuiltinModules(),this.iconService.init(),this.iconService.on("imageUpdate",(function(){return t.render()})),this.fontService.init(),this.hooks.init.tapPromise("initMap",ie(i().mark((function e(){return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n.debugService.log("map.mapInitStart",{type:n.map.version}),e.next=3,new Promise((function(e){n.map.onCameraChanged((function(t){n.cameraService.init(),n.cameraService.update(t),e()})),n.map.init()}));case 3:n.map.onCameraChanged(n.handleMapCameraChanged),n.map.addMarkerContainer(),n.markerService.addMarkers(),n.markerService.addMarkerLayers(),n.popupService.initPopup(),n.interactionService.init(),n.interactionService.on(yc.Drag,n.addSceneEvent.bind(n));case 10:case"end":return e.stop()}}),e)})))),this.hooks.init.tapPromise("initRenderer",ie(i().mark((function t(){var r,o,a;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(o=(null===(r=n.map)||void 0===r?void 0:r.getOverlayContainer())||void 0,n.$container=o||Dl(n.configService.getSceneConfig(n.id).id||""),!n.$container){t.next=14;break}return n.canvas=Di("canvas","",n.$container),n.setCanvas(),t.next=7,n.rendererService.init(n.canvas,n.configService.getSceneConfig(n.id),e.gl);case 7:n.registerContextLost(),n.initContainer(),n.resizeDetector=sh({strategy:"scroll"}),n.resizeDetector.listenTo(n.$container,n.handleWindowResized),window.matchMedia&&(null===(a=window.matchMedia("screen and (-webkit-min-device-pixel-ratio: 1.5)"))||void 0===a||a.addListener(n.handleWindowResized.bind("screen"))),t.next=15;break;case 14:console.error("容器 id 不存在");case 15:n.pickingService.init(n.id);case 16:case"end":return t.stop()}}),t)})))),this.render()}},{key:"registerContextLost",value:function(){var e=this,t=this.rendererService.getCanvas();t&&t.addEventListener("webglcontextlost",(function(){return e.emit("webglcontextlost")}))}},{key:"addLayer",value:function(e){this.layerService.sceneService=this,this.layerService.add(e)}},{key:"addMask",value:function(e){this.layerService.sceneService=this,this.layerService.addMask(e)}},{key:"render",value:function(){var e=this;return ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!e.rendering&&!e.destroyed){t.next=2;break}return t.abrupt("return");case 2:if(e.rendering=!0,e.inited){t.next=16;break}return t.next=6,e.hooks.init.promise();case 6:return e.destroyed&&e.destroy(),t.next=9,e.layerService.initLayers();case 9:e.layerService.renderLayers(),e.controlService.addControls(),e.loaded=!0,e.emit("loaded"),e.inited=!0,t.next=20;break;case 16:return t.next=18,e.layerService.initLayers();case 18:return t.next=20,e.layerService.renderLayers();case 20:e.rendering=!1;case 21:case"end":return t.stop()}}),t)})))()}},{key:"addFontFace",value:function(e,t){this.fontService.addFontFace(e,t)}},{key:"getSceneContainer",value:function(){return this.$container}},{key:"exportPng",value:function(e){var t=this;return ie(i().mark((function n(){var r,o,a;return i().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return o=null===(r=t.$container)||void 0===r?void 0:r.getElementsByTagName("canvas")[0],n.next=3,t.render();case 3:return a="jpg"===e?null==o?void 0:o.toDataURL("image/jpeg"):null==o?void 0:o.toDataURL("image/png"),n.abrupt("return",a);case 5:case"end":return n.stop()}}),n)})))()}},{key:"getSceneConfig",value:function(){return this.configService.getSceneConfig(this.id)}},{key:"getPointSizeRange",value:function(){return this.rendererService.getPointSizeRange()}},{key:"addMarkerContainer",value:function(){var e=this.$container.parentElement;null!==e&&(this.markerContainer=Di("div","l7-marker-container",e))}},{key:"getMarkerContainer",value:function(){return this.markerContainer}},{key:"destroy",value:function(){var e,t=this;this.inited?(this.resizeDetector.removeListener(this.$container,this.handleWindowResized),this.pickingService.destroy(),this.layerService.destroy(),this.interactionService.destroy(),this.controlService.destroy(),this.markerService.destroy(),this.fontService.destroy(),this.iconService.destroy(),this.removeAllListeners(),this.inited=!1,this.map.destroy(),setTimeout((function(){var e;null===(e=t.$container)||void 0===e||e.removeChild(t.canvas),t.canvas=null,t.rendererService.destroy()})),null===(e=this.$container)||void 0===e||null===(e=e.parentNode)||void 0===e||e.removeChild(this.$container),this.emit("destroy")):this.destroyed=!0}},{key:"initContainer",value:function(){var e,t,n=ji,r=(null===(e=this.$container)||void 0===e?void 0:e.clientWidth)||400,i=(null===(t=this.$container)||void 0===t?void 0:t.clientHeight)||300,o=this.canvas;o&&(o.width=r*n,o.height=i*n),this.rendererService.viewport({x:0,y:0,width:n*r,height:n*i})}},{key:"setCanvas",value:function(){var e,t,n=ji,r=(null===(e=this.$container)||void 0===e?void 0:e.clientWidth)||400,i=(null===(t=this.$container)||void 0===t?void 0:t.clientHeight)||300,o=this.canvas;o.width=r*n,o.height=i*n,o.style.width="100%",o.style.height="100%"}},{key:"addSceneEvent",value:function(e){this.emit(e.type,e)}}])}(lo.exports.EventEmitter),lh=Ni.uniq,fh="#define PI 3.14159265359",hh="layout(std140) uniform PickingUniforms {\n  vec4 u_HighlightColor;\n  vec4 u_SelectColor;\n  vec3 u_PickingColor;\n  float u_PickingStage;\n  vec3 u_CurrentSelectedId;\n  float u_PickingThreshold;\n  float u_PickingBuffer;\n  float u_shaderPick;\n  float u_activeMix;\n};",dh='#define TILE_SIZE 512.0\n#define PI 3.1415926536\n#define WORLD_SCALE TILE_SIZE / (PI * 2.0)\n#define EARTH_CIRCUMFERENCE 40.03e6\n\n#define COORDINATE_SYSTEM_LNGLAT 1.0        // mapbox\n#define COORDINATE_SYSTEM_LNGLAT_OFFSET 2.0 // mapbox offset\n#define COORDINATE_SYSTEM_VECTOR_TILE 3.0\n#define COORDINATE_SYSTEM_IDENTITY 4.0\n#define COORDINATE_SYSTEM_P20 5.0           // amap\n#define COORDINATE_SYSTEM_P20_OFFSET 6.0    // amap offset\n#define COORDINATE_SYSTEM_METER_OFFSET 7.0\n\n#define COORDINATE_SYSTEM_P20_2 8.0         // amap2.0\n#pragma include "scene_uniforms"\n\n\n// web mercator coords -> world coords\nvec2 project_mercator(vec2 lnglat) {\n   if (u_CoordinateSystem == COORDINATE_SYSTEM_P20_2) { // gaode2.0\n    return lnglat;\n  }\n  float x = lnglat.x;\n  return vec2(\n    radians(x) + PI,\n    PI - log(tan(PI * 0.25 + radians(lnglat.y) * 0.5))\n  );\n}\n\nfloat project_scale(float meters) {\n  return meters * u_PixelsPerMeter.z;\n}\n\n\n// offset coords -> world coords\nvec4 project_offset(vec4 offset) {\n  float dy = offset.y;\n  dy = clamp(dy, -1., 1.);\n  vec3 pixels_per_unit = u_PixelsPerDegree + u_PixelsPerDegree2 * dy;\n  return vec4(offset.xyz * pixels_per_unit, offset.w);\n}\n\nvec3 project_normal(vec3 normal) {\n  vec4 normal_modelspace = u_ModelMatrix * vec4(normal, 0.0);\n  return normalize(normal_modelspace.xyz * u_PixelsPerMeter);\n}\n\nvec3 project_offset_normal(vec3 vector) {\n  if (u_CoordinateSystem < COORDINATE_SYSTEM_LNGLAT + 0.01 && u_CoordinateSystem >COORDINATE_SYSTEM_LNGLAT - 0.01\n    || u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSET) {\n    // normals generated by the polygon tesselator are in lnglat offsets instead of meters\n    return normalize(vector * u_PixelsPerDegree);\n  }\n  return project_normal(vector);\n}\n// || u_CoordinateSystem < COORDINATE_SYSTEM_P20_OFFSET + 0.01 && u_CoordinateSystem >COORDINATE_SYSTEM_P20_OFFSET - 0.01\n// reverse Y\nvec3 reverse_offset_normal(vec3 vector) {\n  if (u_CoordinateSystem == COORDINATE_SYSTEM_P20 ||u_CoordinateSystem == COORDINATE_SYSTEM_P20_OFFSET ) {\n    return vector * vec3(1.0, -1.0, 1.0);\n  }\n\n  if (u_CoordinateSystem == COORDINATE_SYSTEM_P20_2) { // gaode2.0\n    return vector;\n  }\n  return vector;\n}\n\nvec4 project_mvt_offset_position(vec4 position) {\n  float a = COORDINATE_SYSTEM_LNGLAT_OFFSET;\n  float b = COORDINATE_SYSTEM_P20_OFFSET;\n  float c = COORDINATE_SYSTEM_LNGLAT;\n  if (u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSET || u_CoordinateSystem == COORDINATE_SYSTEM_P20_OFFSET) {\n    return project_offset(vec4(0.0, 0.0, position.z, position.w));\n  }\n  if (u_CoordinateSystem < COORDINATE_SYSTEM_LNGLAT + 0.01 && u_CoordinateSystem >COORDINATE_SYSTEM_LNGLAT - 0.01) {\n    return vec4(\n      project_mercator(position.xy) * WORLD_SCALE * u_ZoomScale,\n      project_scale(position.z),\n      position.w\n    );\n  }\n  return position;\n}\n\nvec4 project_position(vec4 position) {\n  float a = COORDINATE_SYSTEM_LNGLAT_OFFSET;\n  float b = COORDINATE_SYSTEM_P20_OFFSET;\n  float c = COORDINATE_SYSTEM_LNGLAT;\n  if (u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSET\n    || u_CoordinateSystem == COORDINATE_SYSTEM_P20_OFFSET) {\n    float X = position.x - u_ViewportCenter.x;\n    float Y = position.y - u_ViewportCenter.y;\n    return project_offset(vec4(X, Y, position.z, position.w));\n  }\n  if (u_CoordinateSystem < COORDINATE_SYSTEM_LNGLAT + 0.01 && u_CoordinateSystem >COORDINATE_SYSTEM_LNGLAT - 0.01) {\n    return vec4(\n      project_mercator(position.xy) * WORLD_SCALE * u_ZoomScale,\n      project_scale(position.z),\n      position.w\n    );\n  }\n  if (u_CoordinateSystem == COORDINATE_SYSTEM_P20) {\n    return vec4(\n      (project_mercator(position.xy) * WORLD_SCALE * u_ZoomScale - vec2(215440491., 106744817.)) * vec2(1., -1.),\n      project_scale(position.z),\n      position.w\n    );\n  }\n\n  // if(u_CoordinateSystem == COORDINATE_SYSTEM_P20_2) {\n \n\n  //    return vec4(\n  //     position.xy,\n  //     project_scale(position.z),\n  //     position.w);\n  // }\n  return position;\n\n  // TODO: 瓦片坐标系 & 常规世界坐标系\n}\nvec2 project_pixel_size_to_clipspace(vec2 pixels) {\n  vec2 offset = pixels / u_ViewportSize * u_DevicePixelRatio * 2.0;\n  return offset * u_FocalDistance;\n}\n\n\n\nfloat project_pixel_allmap(float pixel) {\n  if(u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT) {\n    return pixel * pow(2.0, u_Zoom);\n  }\n  return pixel * u_FocalDistance ;\n}\n\n// 适配纹理贴图的等像素大小\nfloat project_pixel_texture(float pixel) {\n  // mapbox zoom > 12\n  if(u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSET) {\n    return pixel * pow(0.5, u_Zoom) * u_FocalDistance ;\n  }\n\n  // amap2 zoom > 12\n  if(u_CoordinateSystem == COORDINATE_SYSTEM_P20_2) {\n    return pixel * pow(2.0, (19.0 - 3.0 - u_Zoom))* u_FocalDistance ;\n  }\n\n  // amap zoom > 12\n  if (u_CoordinateSystem == COORDINATE_SYSTEM_P20_OFFSET) {\n    return pixel * pow(0.5, u_Zoom)* u_FocalDistance ;\n  }\n\n  // amap zoom < 12\n  if (u_CoordinateSystem == COORDINATE_SYSTEM_P20) {\n    return pixel * pow(2.0, (20.0 - u_Zoom))* u_FocalDistance ;\n  }\n  return pixel * 2.0 *  u_FocalDistance;;\n}\n\n// 在不论什么底图下需要统一处理的时候使用\nfloat project_float_pixel(float pixel) {\n  if (u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT || u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSET) {\n    // mapbox P20 坐标系下，为了和 Web 墨卡托坐标系统一，zoom 默认减1\n    return pixel * pow(2.0, (19.0 - u_Zoom))  * u_FocalDistance ;\n  }\n  if (u_CoordinateSystem == COORDINATE_SYSTEM_P20 || u_CoordinateSystem == COORDINATE_SYSTEM_P20_OFFSET) {\n    // amap P20 坐标系下，为了和 Web 墨卡托坐标系统一，zoom 默认减1\n    return pixel * pow(2.0, (19.0 - u_Zoom));\n  }\n  if(u_CoordinateSystem == COORDINATE_SYSTEM_P20_2) {\n    // amap2 P20_2 坐标系下，为了和 Web 墨卡托坐标系统一，zoom 默认减3\n    return pixel * pow(2.0, (19.0 - 3.0 - u_Zoom))* u_FocalDistance ;\n  }\n  return pixel * u_FocalDistance;\n}\n\n// Project meter into the unit of pixel which used in the camera world space\nfloat project_float_meter(float meter) {\n  if (u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT || u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSET) {\n    // Since the zoom level uniform is updated by mapservice and it\'s alread been subtracted by 1\n    // Not sure if we are supposed to do that again\n   return meter;\n  } else  {\n    return project_float_pixel(meter);\n  }\n\n  // TODO: change the following code to make adaptations for amap\n  // return u_FocalDistance * TILE_SIZE * pow(2.0, u_Zoom) * meter / EARTH_CIRCUMFERENCE;\n}\n\nfloat project_pixel(float pixel) {\n  if (u_CoordinateSystem == COORDINATE_SYSTEM_P20 || u_CoordinateSystem == COORDINATE_SYSTEM_P20_OFFSET) {\n    // amap P20 坐标系下，为了和 Web 墨卡托坐标系统一，zoom 默认减1\n    return pixel * pow(2.0, (19.0 - u_Zoom)) * u_FocalDistance ;\n  }\n  if(u_CoordinateSystem == COORDINATE_SYSTEM_P20_2) {\n    // amap2 P20_2 坐标系下，为了和 Web 墨卡托坐标系统一，zoom 默认减3\n    return pixel * pow(2.0, (19.0 - 3.0 - u_Zoom)) * u_FocalDistance ;\n  }\n  return pixel * u_FocalDistance;\n}\nvec2 project_pixel(vec2 pixel) {\n  if (u_CoordinateSystem == COORDINATE_SYSTEM_P20 || u_CoordinateSystem == COORDINATE_SYSTEM_P20_OFFSET) {\n    // P20 坐标系下，为了和 Web 墨卡托坐标系统一，zoom 默认减1\n    return pixel * pow(2.0, (19.0 - u_Zoom)) * u_FocalDistance ;\n  }\n  if(u_CoordinateSystem == COORDINATE_SYSTEM_P20_2) {\n    // P20_2 坐标系下，为了和 Web 墨卡托坐标系统一，zoom 默认减3\n    return pixel * pow(2.0, (19.0 - 3.0 - u_Zoom)) * u_FocalDistance ;\n  }\n  return pixel * -1. * u_FocalDistance;\n}\nvec3 project_pixel(vec3 pixel) {\n  if (u_CoordinateSystem == COORDINATE_SYSTEM_P20 || u_CoordinateSystem == COORDINATE_SYSTEM_P20_OFFSET) {\n    // P20 坐标系下，为了和 Web 墨卡托坐标系统一，zoom 默认减1\n    return pixel * pow(2.0, (19.0 - u_Zoom)) *  u_FocalDistance ;\n  }\n  if(u_CoordinateSystem == COORDINATE_SYSTEM_P20_2) {\n    // P20_2 坐标系下，为了和 Web 墨卡托坐标系统一，zoom 默认减3\n    return pixel * pow(2.0, (19.0 - 3.0 - u_Zoom))  * u_FocalDistance ;\n  }\n  return pixel * -1. * u_FocalDistance;\n}\n\nvec4 project_common_position_to_clipspace(vec4 position, mat4 viewProjectionMatrix, vec4 center) {\n  if (u_CoordinateSystem == COORDINATE_SYSTEM_METER_OFFSET ||\n    u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSET) {\n    // Needs to be divided with project_uCommonUnitsPerMeter\n    position.w *= u_PixelsPerMeter.z;\n  }\n\n  return viewProjectionMatrix * position + center;\n}\n\n// Projects from common space coordinates to clip space\nvec4 project_common_position_to_clipspace(vec4 position) {\n  return project_common_position_to_clipspace(\n    position,\n    u_ViewProjectionMatrix,\n    u_ViewportCenterProjection\n  );\n}\n\nvec4 unproject_clipspace_to_position(vec4 clipspacePos, mat4 u_InverseViewProjectionMatrix) {\n  vec4 pos = u_InverseViewProjectionMatrix * (clipspacePos - u_ViewportCenterProjection);\n\n  if (u_CoordinateSystem == COORDINATE_SYSTEM_METER_OFFSET ||\n    u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSET) {\n    // Needs to be divided with project_uCommonUnitsPerMeter\n     pos.w = pos.w / u_PixelsPerMeter.z;\n  }\n  return pos;\n}\n\n\nbool isEqual( float a,  float b) {\n    return  a< b + 0.001 && a > b - 0.001;\n}\n\n// 支持 GaodeV2、Mapbox\nvec4 project_common_position_to_clipspace_v2(vec4 position) {\n  if(u_CoordinateSystem == COORDINATE_SYSTEM_P20_2) { // gaode2.x\n    return u_Mvp * position;\n  } else {\n    return project_common_position_to_clipspace(position);\n  }\n}\n',ph="layout(std140) uniform SceneUniforms {\n  mat4 u_ViewMatrix;\n  mat4 u_ProjectionMatrix;\n  mat4 u_ViewProjectionMatrix;\n  mat4 u_ModelMatrix;\n  vec4 u_ViewportCenterProjection;\n  vec3 u_PixelsPerDegree;\n  float u_Zoom;\n  vec3 u_PixelsPerDegree2;\n  float u_ZoomScale;\n  vec3 u_PixelsPerMeter;\n  float u_CoordinateSystem;\n  vec3 u_CameraPosition;\n  float u_DevicePixelRatio;\n  vec2 u_ViewportCenter;\n  vec2 u_ViewportSize;\n  float u_FocalDistance;\n};\n\nlayout(std140) uniform LayerUniforms {\n  mat4 u_Mvp;\n  vec2 u_sceneCenterMercator;\n};\n",vh=/precision\s+(high|low|medium)p\s+float/,mh="#ifdef GL_FRAGMENT_PRECISION_HIGH\n precision highp float;\n #else\n precision mediump float;\n#endif\n",gh=/#pragma include (["^+"]?["[a-zA-Z_0-9](.*)"]*?)/g,_h=/void\s+main\s*\([^)]*\)\s*\{\n?/,yh=function(){return c((function e(){f(this,e),ne(this,"moduleCache",{}),ne(this,"rawContentCache",{})}),[{key:"registerBuiltinModules",value:function(){this.destroy(),this.registerModule("common",{vs:fh,fs:fh}),this.registerModule("decode",{vs:"#define SHIFT_RIGHT17 1.0 / 131072.0\n#define SHIFT_RIGHT18 1.0 / 262144.0\n#define SHIFT_RIGHT19 1.0 / 524288.0\n#define SHIFT_RIGHT20 1.0 / 1048576.0\n#define SHIFT_RIGHT21 1.0 / 2097152.0\n#define SHIFT_RIGHT22 1.0 / 4194304.0\n#define SHIFT_RIGHT23 1.0 / 8388608.0\n#define SHIFT_RIGHT24 1.0 / 16777216.0\n\n#define SHIFT_LEFT17 131072.0\n#define SHIFT_LEFT18 262144.0\n#define SHIFT_LEFT19 524288.0\n#define SHIFT_LEFT20 1048576.0\n#define SHIFT_LEFT21 2097152.0\n#define SHIFT_LEFT22 4194304.0\n#define SHIFT_LEFT23 8388608.0\n#define SHIFT_LEFT24 16777216.0\n\nvec2 unpack_float(float packedValue) {\n  int packedIntValue = int(packedValue);\n  int v0 = packedIntValue / 256;\n  return vec2(v0, packedIntValue - v0 * 256);\n}\n\nvec4 decode_color(vec2 encodedColor) {\n  return vec4(\n    unpack_float(encodedColor[0]) / 255.0,\n    unpack_float(encodedColor[1]) / 255.0\n  );\n}\n",fs:""}),this.registerModule("scene_uniforms",{vs:ph,fs:ph}),this.registerModule("picking_uniforms",{vs:hh,fs:hh}),this.registerModule("projection",{vs:dh,fs:dh}),this.registerModule("project",{vs:"\n#define E 2.718281828459045\nvec2 ProjectFlat(vec2 lnglat){\n  float maxs=85.0511287798;\n  float lat=max(min(maxs,lnglat.y),-maxs);\n  float scale= 268435456.;\n  float d=PI/180.;\n  float x=lnglat.x*d;\n  float y=lat*d;\n  y=log(tan((PI/4.)+(y/2.)));\n\n  float a=.5/PI,\n  b=.5,\n  c=-.5/PI;\n  d=.5;\n  x=scale*(a*x+b);\n  y=scale*(c*y+d);\n  return vec2(x,y);\n}\n\nvec2 unProjectFlat(vec2 px){\n  float a=.5/PI;\n  float b=.5;\n  float c=-.5/PI;\n  float d=.5;\n  float scale = 268435456.;\n  float x=(px.x/scale-b)/a;\n  float y=(px.y/scale-d)/c;\n  y=(atan(pow(E,y))-(PI/4.))*2.;\n  d=PI/180.;\n  float lat=y/d;\n  float lng=x/d;\n  return vec2(lng,lat);\n}\n\nfloat pixelDistance(vec2 from, vec2 to) {\n vec2 a1 = ProjectFlat(from);\n vec2 b1 = ProjectFlat(to);\n return distance(a1, b1);\n}\n\n// gaode2.0\nvec2 customProject(vec2 lnglat) { // 经纬度 => 平面坐标\n  float t = lnglat.x;\n  float e = lnglat.y;\n  float Sm = 180.0 / PI;\n  float Tm = 6378137.0;\n  float Rm = PI / 180.0;\n  float r = 85.0511287798;\n  e = max(min(r, e), -r);\n  t *= Rm;\n  e *= Rm;\n  e = log(tan(PI / 4.0 + e / 2.0));\n  return vec2(t * Tm, e * Tm);\n}\n\nvec2 unProjCustomCoord(vec2 point) { // 平面坐标 => 经纬度\n  float Sm = 57.29577951308232; //180 / Math.PI\n  float Tm = 6378137.0;\n  float t = point.x;\n  float e = point.y;\n  return vec2(t / Tm * Sm, (2.0 * atan(exp(e / Tm)) - PI / 2.0) * Sm);\n}\n\n\nfloat customPixelDistance(vec2 from, vec2 to) {\n vec2 a1 = ProjectFlat(from);\n vec2 b1 = ProjectFlat(to);\n return distance(a1, b1);\n}",fs:""}),this.registerModule("sdf_2d",{vs:"",fs:"/**\n * 2D signed distance field functions\n * @see http://www.iquilezles.org/www/articles/distfunctions2d/distfunctions2d.htm\n */\n\nfloat ndot(vec2 a, vec2 b ) { return a.x*b.x - a.y*b.y; }\n\nfloat sdCircle(vec2 p, float r) {\n  return length(p) - r;\n}\n\nfloat sdEquilateralTriangle(vec2 p) {\n  float k = sqrt(3.0);\n  p.x = abs(p.x) - 1.0;\n  p.y = p.y + 1.0/k;\n  if( p.x + k*p.y > 0.0 ) p = vec2(p.x-k*p.y,-k*p.x-p.y)/2.0;\n  p.x -= clamp( p.x, -2.0, 0.0 );\n  return -length(p)*sign(p.y);\n}\n\nfloat sdBox(vec2 p, vec2 b) {\n  vec2 d = abs(p)-b;\n  return length(max(d,vec2(0))) + min(max(d.x,d.y),0.0);\n}\n\nfloat sdPentagon(vec2 p, float r) {\n  vec3 k = vec3(0.809016994,0.587785252,0.726542528);\n  p.x = abs(p.x);\n  p -= 2.0*min(dot(vec2(-k.x,k.y),p),0.0)*vec2(-k.x,k.y);\n  p -= 2.0*min(dot(vec2( k.x,k.y),p),0.0)*vec2( k.x,k.y);\n  p -= vec2(clamp(p.x,-r*k.z,r*k.z),r);\n  return length(p)*sign(p.y);\n}\n\nfloat sdHexagon(vec2 p, float r) {\n  vec3 k = vec3(-0.866025404,0.5,0.577350269);\n  p = abs(p);\n  p -= 2.0*min(dot(k.xy,p),0.0)*k.xy;\n  p -= vec2(clamp(p.x, -k.z*r, k.z*r), r);\n  return length(p)*sign(p.y);\n}\n\nfloat sdOctogon(vec2 p, float r) {\n  vec3 k = vec3(-0.9238795325, 0.3826834323, 0.4142135623 );\n  p = abs(p);\n  p -= 2.0*min(dot(vec2( k.x,k.y),p),0.0)*vec2( k.x,k.y);\n  p -= 2.0*min(dot(vec2(-k.x,k.y),p),0.0)*vec2(-k.x,k.y);\n  p -= vec2(clamp(p.x, -k.z*r, k.z*r), r);\n  return length(p)*sign(p.y);\n}\n\nfloat sdHexagram(vec2 p, float r) {\n  vec4 k=vec4(-0.5,0.8660254038,0.5773502692,1.7320508076);\n  p = abs(p);\n  p -= 2.0*min(dot(k.xy,p),0.0)*k.xy;\n  p -= 2.0*min(dot(k.yx,p),0.0)*k.yx;\n  p -= vec2(clamp(p.x,r*k.z,r*k.w),r);\n  return length(p)*sign(p.y);\n}\n\nfloat sdRhombus(vec2 p, vec2 b) {\n  vec2 q = abs(p);\n  float h = clamp((-2.0*ndot(q,b)+ndot(b,b))/dot(b,b),-1.0,1.0);\n  float d = length( q - 0.5*b*vec2(1.0-h,1.0+h) );\n  return d * sign( q.x*b.y + q.y*b.x - b.x*b.y );\n}\n\nfloat sdVesica(vec2 p, float r, float d) {\n  p = abs(p);\n  float b = sqrt(r*r-d*d); // can delay this sqrt\n  return ((p.y-b)*d>p.x*b)\n          ? length(p-vec2(0.0,b))\n          : length(p-vec2(-d,0.0))-r;\n}\n"}),this.registerModule("lighting",{vs:"// Blinn-Phong model\n// apply lighting in vertex shader instead of fragment shader\n// @see https://learnopengl.com/Advanced-Lighting/Advanced-Lighting\nuniform float u_Ambient : 1.0;\nuniform float u_Diffuse : 1.0;\nuniform float u_Specular : 1.0;\nuniform int u_NumOfDirectionalLights : 1;\nuniform int u_NumOfSpotLights : 0;\n\n#define SHININESS 32.0\n#define MAX_NUM_OF_DIRECTIONAL_LIGHTS 3\n#define MAX_NUM_OF_SPOT_LIGHTS 3\n\nstruct DirectionalLight {\n  vec3 direction;\n  vec3 ambient;\n  vec3 diffuse;\n  vec3 specular;\n};\n\nstruct SpotLight {\n  vec3 position;\n  vec3 direction;\n  vec3 ambient;\n  vec3 diffuse;\n  vec3 specular;\n  float constant;\n  float linear;\n  float quadratic;\n  float angle;\n  float blur;\n  float exponent;\n};\n\nuniform DirectionalLight u_DirectionalLights[MAX_NUM_OF_DIRECTIONAL_LIGHTS];\nuniform SpotLight u_SpotLights[MAX_NUM_OF_SPOT_LIGHTS];\n\nvec3 calc_directional_light(DirectionalLight light, vec3 normal, vec3 viewDir) {\n  vec3 lightDir = normalize(light.direction);\n  // diffuse shading\n  float diff = max(dot(normal, lightDir), 0.0);\n  // Blinn-Phong specular shading\n  vec3 halfwayDir = normalize(lightDir + viewDir);\n  float spec = pow(max(dot(normal, halfwayDir), 0.0), SHININESS);\n\n  vec3 ambient = light.ambient * u_Ambient;\n  vec3 diffuse = light.diffuse * diff * u_Diffuse;\n  vec3 specular = light.specular * spec * u_Specular;\n\n  return ambient + diffuse + specular;\n}\n\n\nvec3 calc_lighting(vec3 position, vec3 normal, vec3 viewDir) {\n  vec3 weight = vec3(0.0);\n  for (int i = 0; i < MAX_NUM_OF_DIRECTIONAL_LIGHTS; i++) {\n    if (i >= u_NumOfDirectionalLights) {\n      break;\n    }\n    weight += calc_directional_light(u_DirectionalLights[i], normal, viewDir);\n  }\n  return weight;\n}\n",fs:""}),this.registerModule("light",{vs:"#define ambientRatio 0.5\n#define diffuseRatio 0.3\n#define specularRatio 0.2\n\n\nfloat calc_lighting(vec4 pos) {\n\n    vec3 worldPos = vec3(pos * u_ModelMatrix);\n\n    vec3 worldNormal = a_Normal;\n      // //cal light weight\n    vec3 viewDir = normalize(u_CameraPosition - worldPos);\n\n    vec3 lightDir = normalize(vec3(1, -10.5, 12));\n\n    vec3 halfDir = normalize(viewDir+lightDir);\n      // //lambert\n    float lambert = dot(worldNormal, lightDir);\n        //specular\n    float specular = pow(max(0.0, dot(worldNormal, halfDir)), 32.0);\n        //sum to light weight\n    float lightWeight = ambientRatio + diffuseRatio * lambert + specularRatio * specular;\n\n    return lightWeight;\n}\n",fs:""}),this.registerModule("picking",{vs:'layout(location = 3) in vec3 a_PickingColor;\nout vec4 v_PickingResult;\n\n#pragma include "picking_uniforms"\n\n#define PICKING_NONE 0.0\n#define PICKING_ENCODE 1.0\n#define PICKING_HIGHLIGHT 2.0\n#define COLOR_SCALE 1. / 255.\n\n#define NORMAL 0.0\n#define HIGHLIGHT 1.0\n#define SELECT 2.0\n\nbool isVertexPicked(vec3 vertexColor) {\n  return distance(vertexColor,u_PickingColor.rgb) < 0.01;\n}\n\n// 判断当前点是否已经被 select 选中\nbool isVertexSelected(vec3 vertexColor) {\n  return distance(vertexColor,u_CurrentSelectedId.rgb) < 0.01;\n}\n\nvoid setPickingColor(vec3 pickingColor) {\n  if(u_shaderPick < 0.5) {\n    return;\n  }\n  // compares only in highlight stage\n\n  if(u_PickingStage == PICKING_HIGHLIGHT) {\n    if(isVertexPicked(pickingColor)) {\n       v_PickingResult = vec4(pickingColor.rgb * COLOR_SCALE,HIGHLIGHT);\n       return;\n    }\n    if(isVertexSelected(pickingColor)) {\n     v_PickingResult = vec4(u_CurrentSelectedId.rgb * COLOR_SCALE,SELECT);\n      return;\n    }\n\n  } else {\n      v_PickingResult= vec4(pickingColor.rgb * COLOR_SCALE,NORMAL);\n      return;\n  }\n\n  // // v_PickingResult.a = float((u_PickingStage == PICKING_HIGHLIGHT) && (isVertexPicked(pickingColor) || isVertexPicked(u_CurrentSelectedId)));\n\n  // // Stores the picking color so that the fragment shader can render it during picking\n  // v_PickingResult.rgb = pickingColor * COLOR_SCALE;\n}\n\nfloat setPickingSize(float x) {\n   return u_PickingStage == PICKING_ENCODE ? x + u_PickingBuffer : x;\n}\n\nfloat setPickingOrder(float z) {\n   bool selected = bool(v_PickingResult.a);\n   return selected ? z + 1. : 0.;\n}\n',fs:'\nin vec4 v_PickingResult;\n\n#pragma include "picking_uniforms"\n\n#define PICKING_NONE 0.0\n#define PICKING_ENCODE 1.0\n#define PICKING_HIGHLIGHT 2.0\n#define COLOR_SCALE 1. / 255.\n\n#define HIGHLIGHT 1.0\n#define SELECT 2.0\n\n/*\n * Returns highlight color if this item is selected.\n */\nvec4 filterHighlightColor(vec4 color, float weight) {\n  float activeType = v_PickingResult.a;\n  if(activeType > 0.0) {\n    vec4 highLightColor =  activeType > 1.5 ? u_SelectColor : u_HighlightColor;\n    highLightColor = highLightColor * COLOR_SCALE;\n    float highLightAlpha = highLightColor.a;\n    float highLightRatio = highLightAlpha / (highLightAlpha + color.a * (1.0 - highLightAlpha));\n    vec3 resultRGB = mix(color.rgb, highLightColor.rgb, highLightRatio);\n    return vec4(mix(resultRGB * weight, color.rgb, u_activeMix), color.a);\n  }\n  else {\n    return color;\n  }\n\n  \n}\n\n/*\n * Returns picking color if picking enabled else unmodified argument.\n */\nvec4 filterPickingColor(vec4 color) {\n  vec3 pickingColor = v_PickingResult.rgb;\n  if (u_PickingStage == PICKING_ENCODE && length(pickingColor) < 0.001) {\n    discard;\n  }\n  return u_PickingStage == PICKING_ENCODE ? vec4(pickingColor, step(0.001,color.a)): color;\n}\n\n/*\n * Returns picking color if picking is enabled if not\n * highlight color if this item is selected, otherwise unmodified argument.\n */\nvec4 filterColor(vec4 color) {\n  // 过滤多余的 shader 计算\n  // return color;\n  if(u_shaderPick < 0.5) {\n    return color; // 暂时去除 直接取消计算在选中时拖拽地图会有问题\n  } else {\n    return filterPickingColor(filterHighlightColor(color, 1.0));\n  }\n  \n}\n\nvec4 filterColorAlpha(vec4 color, float alpha) {\n  // 过滤多余的 shader 计算\n  // return color;\n  if(u_shaderPick < 0.5) {\n    return color; // 暂时去除 直接取消计算在选中时拖拽地图会有问题\n  } else {\n    return filterPickingColor(filterHighlightColor(color, alpha));\n  }\n}\n\n'}),this.registerModule("rotation_2d",{vs:"vec2 rotate_matrix(vec2 v, float a) {\n    float b = a / 180.0 * 3.1415926535897932384626433832795;\n    float s = sin(b);\n    float c = cos(b);\n    mat2 m = mat2(c, s, -s, c);\n    return m * v;\n}",fs:""})}},{key:"registerModule",value:function(e,t){t.vs=t.vs.replace(/\r\n/g,"\n"),t.fs=t.fs.replace(/\r\n/g,"\n");var n=t.vs,r=t.fs,i=t.uniforms,o=t.inject,a=Xu(n),s=a.content,u=a.uniforms,c=Xu(r),l=c.content,f=c.uniforms;this.rawContentCache[e]={fs:l,inject:o,uniforms:re(re(re({},u),f),i),vs:s}}},{key:"destroy",value:function(){this.moduleCache={},this.rawContentCache={}}},{key:"getModule",value:function(e){var t=this,n=this.rawContentCache[e].vs,r=this.rawContentCache[e].fs,i=this.rawContentCache[e].inject,o={};null!=i&&i["vs:#decl"]&&(n=(null==i?void 0:i["vs:#decl"])+n,o=Xu(null==i?void 0:i["vs:#decl"]).uniforms),null!=i&&i["vs:#main-start"]&&(n=n.replace(_h,(function(e){return e+(null==i?void 0:i["vs:#main-start"])}))),null!=i&&i["fs:#decl"]&&(r=(null==i?void 0:i["fs:#decl"])+r);var a=this.processModule(n,[],"vs"),s=a.content,u=a.includeList,c=this.processModule(r,[],"fs"),l=c.content,f=c.includeList,h="",d=lh(u.concat(f).concat(e)).reduce((function(e,n){return re(re({},e),t.rawContentCache[n].uniforms)}),re({},o));vh.test(l)||(h+=mh),h+=l;var p="";return vh.test(s)||(p+=mh),p+=s,this.moduleCache[e]={fs:h.trim(),uniforms:d,vs:p.trim()},this.moduleCache[e]}},{key:"processModule",value:function(e,t,n){var r=this;return{content:e.replace(gh,(function(e,i){var o=i.split(" ")[0].replace(/"/g,"");if(t.indexOf(o)>-1)return"";var a=r.rawContentCache[o][n];return t.push(o),r.processModule(a,t,n).content})),includeList:t}}},{key:"injectDefines",value:function(e){return Object.keys(e).reduce((function(t,n){return t+"#define ".concat(n.toUpperCase()," ").concat(e[n],";\n")}),"\n")}}])}(),Eh=function(){return c((function e(){f(this,e),ne(this,"shaderModuleService",void 0),ne(this,"rendererService",void 0),ne(this,"cameraService",void 0),ne(this,"mapService",void 0),ne(this,"interactionService",void 0),ne(this,"layerService",void 0),ne(this,"config",void 0)}),[{key:"getName",value:function(){return""}},{key:"getType",value:function(){return Fu.Normal}},{key:"init",value:function(e,t){this.config=t,this.rendererService=e.getContainer().rendererService,this.cameraService=e.getContainer().cameraService,this.mapService=e.getContainer().mapService,this.interactionService=e.getContainer().interactionService,this.layerService=e.getContainer().layerService,this.shaderModuleService=e.getContainer().shaderModuleService}},{key:"render",value:function(e){}}])}(),bh=function(e){function t(){return f(this,t),h(this,t,arguments)}return d(t,e),c(t,[{key:"getName",value:function(){return"clear"}},{key:"init",value:function(e,r){n(_(t.prototype),"init",this).call(this,e,r)}},{key:"render",value:function(){this.rendererService.clear({color:[0,0,0,0],depth:1,framebuffer:null})}}])}(Eh),Ah=function(){return c((function e(t){f(this,e),ne(this,"passes",[]),ne(this,"layer",void 0),ne(this,"renderFlag",void 0),ne(this,"width",0),ne(this,"height",0),this.postProcessor=t}),[{key:"setLayer",value:function(e){this.layer=e}},{key:"setRenderFlag",value:function(e){this.renderFlag=e}},{key:"getRenderFlag",value:function(){return this.renderFlag}},{key:"getPostProcessor",value:function(){return this.postProcessor}},{key:"render",value:function(){var e=this;return ie(i().mark((function t(){var n,r,o;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=y(e.passes),t.prev=1,n.s();case 3:if((r=n.n()).done){t.next=9;break}return o=r.value,t.next=7,o.render(e.layer);case 7:t.next=3;break;case 9:t.next=14;break;case 11:t.prev=11,t.t0=t.catch(1),n.e(t.t0);case 14:return t.prev=14,n.f(),t.finish(14);case 17:return t.next=19,e.postProcessor.render(e.layer);case 19:case"end":return t.stop()}}),t,null,[[1,11,14,17]])})))()}},{key:"resize",value:function(e,t){this.width===e&&this.height===t||(this.postProcessor.resize(e,t),this.width=e,this.height=t)}},{key:"add",value:function(e,t){e.getType()===Fu.PostProcessing?this.postProcessor.add(e,this.layer,t):(e.init(this.layer,t),this.passes.push(e))}},{key:"insert",value:function(e,t,n){e.init(this.layer,t),this.passes.splice(n,0,e)}},{key:"destroy",value:function(){this.passes.length=0}}])}(),xh=function(e){function t(){var e,n;f(this,t);for(var r=arguments.length,o=new Array(r),a=0;a<r;a++)o[a]=arguments[a];return e=h(this,t,[].concat(o)),n=e,ne(e,"pickingFBO",void 0),ne(e,"layer",void 0),ne(e,"width",0),ne(e,"height",0),ne(e,"alreadyInRendering",!1),ne(e,"pickFromPickingFBO",(function(t){var r=t.x,o=t.y,a=t.lngLat,s=t.type;if(e.layer.isVisible()&&e.layer.needPick(s)){var u,c=e.rendererService,l=c.getViewportSize,f=c.readPixelsAsync,h=c.useFramebuffer,d=l(),p=d.width,v=d.height,m=e.layer.getLayerConfig(),g=m.enableHighlight,_=m.enableSelect,y=r*ji,E=o*ji;if(!(y>p||y<0||E>v||E<0))h(e.pickingFBO,ie(i().mark((function e(){var t,c,l,h,d;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,f({x:Math.round(y),y:Math.round(v-(o+1)*ji),width:1,height:1,data:new Uint8Array(4),framebuffer:n.pickingFBO});case 2:0!==(u=e.sent)[0]||0!==u[1]||0!==u[2]?(c=Xt(u),l=n.layer.getSource().getFeatureById(c),h={x:r,y:o,type:s,lngLat:a,featureId:c,feature:l},l&&(n.layer.setCurrentPickId(c),n.triggerHoverOnLayer(h))):(d={x:r,y:o,lngLat:a,type:null===n.layer.getCurrentPickId()?"un"+s:"mouseout",featureId:null,feature:null},n.triggerHoverOnLayer(re(re({},d),{},{type:"unpick"})),n.triggerHoverOnLayer(d),n.layer.setCurrentPickId(null)),g&&n.highlightPickedFeature(u),_&&"click"===s&&(null===(t=u)||void 0===t?void 0:t.toString())!==[0,0,0,0].toString()&&n.selectFeature(u);case 6:case"end":return e.stop()}}),e)}))))}})),e}return d(t,e),c(t,[{key:"getType",value:function(){return Fu.Normal}},{key:"getName",value:function(){return"pixelPicking"}},{key:"init",value:function(e,r){n(_(t.prototype),"init",this).call(this,e,r),this.layer=e;var i=this.rendererService,o=i.createTexture2D,a=i.createFramebuffer,s=(0,i.getViewportSize)(),u=o({width:s.width,height:s.height,wrapS:Bu.CLAMP_TO_EDGE,wrapT:Bu.CLAMP_TO_EDGE,label:"Picking Texture"});this.pickingFBO=a({color:u}),this.interactionService.on(yc.Hover,this.pickFromPickingFBO),this.interactionService.on(yc.Select,this.selectFeatureHandle.bind(this)),this.interactionService.on(yc.Active,this.highlightFeatureHandle.bind(this))}},{key:"render",value:function(e){var t=this;if(!this.alreadyInRendering){var n=this.rendererService,r=n.getViewportSize,i=n.useFramebuffer,o=n.clear,a=r(),s=a.width,u=a.height;this.alreadyInRendering=!0,this.width===s&&this.height===u||(this.pickingFBO.resize({width:s,height:u}),this.width=s,this.height=u),i(this.pickingFBO,(function(){o({framebuffer:t.pickingFBO,color:[0,0,0,0],stencil:0,depth:1});var n=t.layer.multiPassRenderer.getRenderFlag();t.layer.multiPassRenderer.setRenderFlag(!1),e.hooks.beforePickingEncode.call(),e.render(),e.hooks.afterPickingEncode.call(),t.layer.multiPassRenderer.setRenderFlag(n),t.alreadyInRendering=!1}))}}},{key:"triggerHoverOnLayer",value:function(e){this.layer.emit(e.type,e)}},{key:"highlightPickedFeature",value:function(e){var t=a(e,3),n=t[0],r=t[1],i=t[2];this.layer.hooks.beforeHighlight.call([n,r,i]),this.layerService.renderLayers()}},{key:"selectFeature",value:function(e){var t=a(e,3),n=t[0],r=t[1],i=t[2];this.layer.hooks.beforeSelect.call([n,r,i]),this.layerService.renderLayers()}},{key:"selectFeatureHandle",value:function(e){var t=Wt(e.featureId);this.selectFeature(new Uint8Array(t))}},{key:"highlightFeatureHandle",value:function(e){var t=Wt(e.featureId);this.highlightPickedFeature(new Uint8Array(t))}}])}(Eh),Sh=function(){return c((function e(t){f(this,e),ne(this,"passes",[]),ne(this,"readFBO",void 0),ne(this,"writeFBO",void 0),this.rendererService=t,this.init()}),[{key:"getReadFBO",value:function(){return this.readFBO}},{key:"getWriteFBO",value:function(){return this.writeFBO}},{key:"getCurrentFBOTex",value:function(){var e=this.rendererService,t=e.getViewportSize,n=e.createTexture2D,r=t();return n({x:0,y:0,width:r.width,height:r.height,copy:!0})}},{key:"getReadFBOTex",value:function(){var e=this,t=this,n=this.rendererService.useFramebuffer;return new Promise((function(r){n(e.readFBO,ie(i().mark((function e(){return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:r(t.getCurrentFBOTex());case 1:case"end":return e.stop()}}),e)}))))}))}},{key:"renderBloomPass",value:function(e,t){var n=this;return ie(i().mark((function r(){var o,a;return i().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return r.next=2,n.getReadFBOTex();case 2:o=r.sent,a=0;case 4:if(!(a<4)){r.next=11;break}return r.next=7,t.render(e,o);case 7:n.swap(),a++,r.next=4;break;case 11:case"end":return r.stop()}}),r)})))()}},{key:"render",value:function(e){var t=this;return ie(i().mark((function n(){var r,o;return i().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:r=0;case 1:if(!(r<t.passes.length)){n.next=15;break}if((o=t.passes[r]).setRenderToScreen(t.isLastEnabledPass(r)),"bloom"!==o.getName()){n.next=9;break}return n.next=7,t.renderBloomPass(e,o);case 7:n.next=12;break;case 9:return n.next=11,o.render(e);case 11:r!==t.passes.length-1&&t.swap();case 12:r++,n.next=1;break;case 15:case"end":return n.stop()}}),n)})))()}},{key:"resize",value:function(e,t){this.readFBO.resize({width:e,height:t}),this.writeFBO.resize({width:e,height:t})}},{key:"add",value:function(e,t,n){e.init(t,n),this.passes.push(e)}},{key:"insert",value:function(e,t,n,r){e.init(n,r),this.passes.splice(t,0,e)}},{key:"getPostProcessingPassByName",value:function(e){return this.passes.find((function(t){return t.getName()===e}))}},{key:"init",value:function(){var e=this.rendererService,t=e.createFramebuffer,n=e.createTexture2D;this.readFBO=t({color:n({width:1,height:1,wrapS:Bu.CLAMP_TO_EDGE,wrapT:Bu.CLAMP_TO_EDGE})}),this.writeFBO=t({color:n({width:1,height:1,wrapS:Bu.CLAMP_TO_EDGE,wrapT:Bu.CLAMP_TO_EDGE})})}},{key:"isLastEnabledPass",value:function(e){for(var t=e+1;t<this.passes.length;t++)if(this.passes[t].isEnabled())return!1;return!0}},{key:"swap",value:function(){var e=this.readFBO;this.readFBO=this.writeFBO,this.writeFBO=e}}])}(),Th=function(e){function t(){return f(this,t),h(this,t,arguments)}return d(t,e),c(t,[{key:"getType",value:function(){return Fu.Normal}},{key:"getName",value:function(){return"render"}},{key:"init",value:function(e,r){n(_(t.prototype),"init",this).call(this,e,r)}},{key:"render",value:function(e){var t=this.rendererService,n=t.useFramebuffer,r=t.clear,i=e.multiPassRenderer.getPostProcessor().getReadFBO();n(i,(function(){r({color:[0,0,0,0],depth:1,stencil:0,framebuffer:i}),e.multiPassRenderer.setRenderFlag(!1),e.models.forEach((function(t){t.draw({uniforms:e.layerModel.getUninforms()})})),e.multiPassRenderer.setRenderFlag(!0)}))}}])}(Eh),Rh="varying vec2 v_UV;\n\nuniform sampler2D u_Texture;\n\nvoid main() {\n  gl_FragColor = vec4(texture2D(u_Texture, v_UV));\n}";function Ch(e,t){for(var n=0,r=1/t,i=e;i>0;)n+=r*(i%t),i=Math.floor(i/t),r/=t;return n}var Mh=1,wh=function(e){function t(e){var n;return f(this,t),n=h(this,t),ne(n,"haltonSequence",[]),ne(n,"accumulatingId",0),ne(n,"frame",0),ne(n,"timer",void 0),ne(n,"sampleRenderTarget",void 0),ne(n,"prevRenderTarget",void 0),ne(n,"outputRenderTarget",void 0),ne(n,"copyRenderTarget",void 0),ne(n,"blendModel",void 0),ne(n,"outputModel",void 0),ne(n,"copyModel",void 0),n.shaderModuleService=e,n}return d(t,e),c(t,[{key:"getType",value:function(){return Fu.Normal}},{key:"getName",value:function(){return"taa"}},{key:"init",value:function(e,r){n(_(t.prototype),"init",this).call(this,e,r);var i=this.rendererService,o=i.createFramebuffer,a=i.createTexture2D;this.sampleRenderTarget=o({color:a({width:1,height:1,wrapS:Bu.CLAMP_TO_EDGE,wrapT:Bu.CLAMP_TO_EDGE})}),this.prevRenderTarget=o({color:a({width:1,height:1,wrapS:Bu.CLAMP_TO_EDGE,wrapT:Bu.CLAMP_TO_EDGE})}),this.outputRenderTarget=o({color:a({width:1,height:1,wrapS:Bu.CLAMP_TO_EDGE,wrapT:Bu.CLAMP_TO_EDGE})}),this.copyRenderTarget=o({color:a({width:1,height:1,wrapS:Bu.CLAMP_TO_EDGE,wrapT:Bu.CLAMP_TO_EDGE})});for(var s=0;s<30;s++)this.haltonSequence.push([Ch(s,2),Ch(s,3)]);this.blendModel=this.createTriangleModel("blend-pass","uniform float u_opacity : 1.0;\nuniform float u_MixRatio : 0.5;\n\nuniform sampler2D u_Diffuse1;\nuniform sampler2D u_Diffuse2;\n\nvarying vec2 v_UV;\n\nvoid main() {\n  vec4 texel1 = texture2D(u_Diffuse1, v_UV);\n  vec4 texel2 = texture2D(u_Diffuse2, v_UV);\n  gl_FragColor = u_opacity * mix(texel1, texel2, u_MixRatio);\n}\n"),this.outputModel=this.createTriangleModel("copy-pass",Rh,{blend:{enable:!0,func:{srcRGB:Bu.ONE,dstRGB:Bu.ONE_MINUS_SRC_ALPHA,srcAlpha:Bu.ONE,dstAlpha:Bu.ONE_MINUS_SRC_ALPHA},equation:{rgb:Bu.FUNC_ADD,alpha:Bu.FUNC_ADD}}}),this.copyModel=this.createTriangleModel("copy-pass",Rh)}},{key:"render",value:function(e){var t=this,n=this.rendererService,r=n.clear,i=n.getViewportSize,o=n.useFramebuffer,a=i(),s=a.width,u=a.height;this.sampleRenderTarget.resize({width:s,height:u}),this.prevRenderTarget.resize({width:s,height:u}),this.outputRenderTarget.resize({width:s,height:u}),this.copyRenderTarget.resize({width:s,height:u}),this.resetFrame(),this.stopAccumulating();var c=e.multiPassRenderer.getPostProcessor().getReadFBO();o(c,(function(){r({color:[0,0,0,0],depth:1,stencil:0,framebuffer:c}),e.multiPassRenderer.setRenderFlag(!1),e.render(),e.multiPassRenderer.setRenderFlag(!0)}));var l=function n(r){t.accumulatingId&&r===t.accumulatingId&&(t.isFinished()||(t.doRender(e),window.requestAnimationFrame((function(){n(r)}))))};this.accumulatingId=Mh++,this.timer=window.setTimeout((function(){l(t.accumulatingId)}),50)}},{key:"doRender",value:function(e){var t=this,n=this.rendererService,r=n.clear,i=n.getViewportSize,o=n.useFramebuffer,a=i(),s=a.width,u=a.height,c=e.getLayerConfig().jitterScale,l=void 0===c?1:c,f=this.haltonSequence[this.frame%this.haltonSequence.length];this.cameraService.jitterProjectionMatrix((2*f[0]-1)/s*l,(2*f[1]-1)/u*l),e.multiPassRenderer.setRenderFlag(!1),e.hooks.beforeRender.call(),o(this.sampleRenderTarget,(function(){r({color:[0,0,0,0],depth:1,stencil:0,framebuffer:t.sampleRenderTarget}),e.render()})),e.hooks.afterRender.call(),e.multiPassRenderer.setRenderFlag(!0);var h=e.getLayerConfig();o(this.outputRenderTarget,(function(){t.blendModel.draw({uniforms:{u_opacity:h.opacity||1,u_MixRatio:0===t.frame?1:.9,u_Diffuse1:t.sampleRenderTarget,u_Diffuse2:0===t.frame?e.multiPassRenderer.getPostProcessor().getReadFBO():t.prevRenderTarget}})})),0===this.frame&&r({color:[0,0,0,0],depth:1,stencil:0,framebuffer:this.copyRenderTarget}),this.frame>=1&&(o(this.copyRenderTarget,(function(){t.outputModel.draw({uniforms:{u_Texture:t.outputRenderTarget}})})),o(e.multiPassRenderer.getPostProcessor().getReadFBO(),(function(){t.copyModel.draw({uniforms:{u_Texture:t.copyRenderTarget}})})),e.multiPassRenderer.getPostProcessor().render(e));var d=this.prevRenderTarget;this.prevRenderTarget=this.outputRenderTarget,this.outputRenderTarget=d,this.frame++,this.cameraService.clearJitterProjectionMatrix()}},{key:"isFinished",value:function(){return this.frame>=this.haltonSequence.length}},{key:"resetFrame",value:function(){this.frame=0}},{key:"stopAccumulating",value:function(){this.accumulatingId=0,window.clearTimeout(this.timer)}},{key:"createTriangleModel",value:function(e,t,n){this.shaderModuleService.registerModule(e,{vs:"attribute vec2 a_Position;\n\nvarying vec2 v_UV;\n\nvoid main() {\n  v_UV = 0.5 * (a_Position + 1.0);\n  gl_Position = vec4(a_Position, 0., 1.);\n}",fs:t});var r=this.shaderModuleService.getModule(e),i=r.vs,o=r.fs,a=r.uniforms,s=this.rendererService,u=s.createAttribute,c=s.createBuffer;return(0,s.createModel)(re({vs:i,fs:o,attributes:{a_Position:u({buffer:c({data:[-4,-4,4,-4,0,4],type:Bu.FLOAT}),size:2})},uniforms:re({},a),depth:{enable:!1},count:3},n))}}])}(Eh),Lh=Ni.isNil,Oh=function(e){function t(){return f(this,t),h(this,t,arguments)}return d(t,e),c(t,[{key:"setupShaders",value:function(){this.shaderModuleService.registerModule("blur-pass",{vs:"attribute vec2 a_Position;\n\nvarying vec2 v_UV;\n\nvoid main() {\n  v_UV = 0.5 * (a_Position + 1.0);\n  gl_Position = vec4(a_Position, 0., 1.);\n}",fs:"varying vec2 v_UV;\n\nuniform float u_BloomFinal: 0.0;\nuniform sampler2D u_Texture;\nuniform sampler2D u_Texture2;\n\nuniform vec2 u_ViewportSize: [1.0, 1.0];\nuniform float u_radius: 5.0;\nuniform float u_intensity: 0.3;\nuniform float u_baseRadio: 0.5;\n\n// https://github.com/Jam3/glsl-fast-gaussian-blur/blob/master/9.glsl\nvec4 blur9(sampler2D image, vec2 uv, vec2 resolution, vec2 direction) {\n  vec4 color = vec4(0.0);\n  vec2 off1 = vec2(1.3846153846) * direction;\n  vec2 off2 = vec2(3.2307692308) * direction;\n  color += texture2D(image, uv) * 0.2270270270;\n  color += texture2D(image, uv + (off1 / resolution)) * 0.3162162162;\n  color += texture2D(image, uv - (off1 / resolution)) * 0.3162162162;\n  color += texture2D(image, uv + (off2 / resolution)) * 0.0702702703;\n  color += texture2D(image, uv - (off2 / resolution)) * 0.0702702703;\n  return color;\n}\n\nfloat luminance(vec4 color) {\n  return  0.2125 * color.r + 0.7154 * color.g + 0.0721 * color.b;\n}\n\nvoid main() {\n  // vec4 baseColor = texture2D(u_Texture, v_UV);\n\n  float r = sqrt(u_radius);\n\n  vec4 c1 = blur9(u_Texture, v_UV, u_ViewportSize, vec2(u_radius, 0.0));\n  // c1 *= luminance(c1);\n  vec4 c2 = blur9(u_Texture, v_UV, u_ViewportSize, vec2(0.0, u_radius));\n  // c2 *= luminance(c2);\n  vec4 c3 = blur9(u_Texture, v_UV, u_ViewportSize, vec2(r, r));\n  // c3 *= luminance(c3);\n  vec4 c4 = blur9(u_Texture, v_UV, u_ViewportSize, vec2(r, -r));\n  // c4 *= luminance(c4);\n  vec4 inbloomColor = (c1 + c2 + c3 + c4) * 0.25;\n\n  // float lum = luminance(inbloomColor);\n  // inbloomColor.rgb *= lum;\n\n  if(u_BloomFinal > 0.0) {\n    vec4 baseColor = texture2D(u_Texture2, v_UV);\n    float baselum = luminance(baseColor);\n    gl_FragColor = mix(inbloomColor, baseColor, u_baseRadio);\n    if(baselum <= 0.2) {\n      gl_FragColor = inbloomColor * u_intensity;\n    }\n  } else {\n    gl_FragColor = inbloomColor;\n  }\n}"});var e=this.shaderModuleService.getModule("blur-pass"),t=e.vs,n=e.fs,r=e.uniforms,i=this.rendererService.getViewportSize(),o=i.width,a=i.height;return{vs:t,fs:n,uniforms:re(re({},r),{},{u_ViewportSize:[o,a]})}}},{key:"convertOptionsToUniforms",value:function(e){var t={};return Lh(e.bloomRadius)||(t.u_radius=e.bloomRadius),Lh(e.bloomIntensity)||(t.u_intensity=e.bloomIntensity),Lh(e.bloomBaseRadio)||(t.u_baseRadio=e.bloomBaseRadio),t}}])}(ju),kh=Ni.isNil,Nh=function(e){function t(){return f(this,t),h(this,t,arguments)}return d(t,e),c(t,[{key:"setupShaders",value:function(){this.shaderModuleService.registerModule("blur-pass",{vs:"attribute vec2 a_Position;\n\nvarying vec2 v_UV;\n\nvoid main() {\n  v_UV = 0.5 * (a_Position + 1.0);\n  gl_Position = vec4(a_Position, 0., 1.);\n}",fs:"varying vec2 v_UV;\n\nuniform sampler2D u_Texture;\n\nuniform vec2 u_ViewportSize: [1.0, 1.0];\nuniform vec2 u_BlurDir: [1.0, 0.0];\n\n// https://github.com/Jam3/glsl-fast-gaussian-blur/blob/master/9.glsl\nvec4 blur9(sampler2D image, vec2 uv, vec2 resolution, vec2 direction) {\n  vec4 color = vec4(0.0);\n  vec2 off1 = vec2(1.3846153846) * direction;\n  vec2 off2 = vec2(3.2307692308) * direction;\n  color += texture2D(image, uv) * 0.2270270270;\n  color += texture2D(image, uv + (off1 / resolution)) * 0.3162162162;\n  color += texture2D(image, uv - (off1 / resolution)) * 0.3162162162;\n  color += texture2D(image, uv + (off2 / resolution)) * 0.0702702703;\n  color += texture2D(image, uv - (off2 / resolution)) * 0.0702702703;\n  return color;\n}\n\nvoid main() {\n  gl_FragColor = blur9(u_Texture, v_UV, u_ViewportSize, u_BlurDir);\n}"});var e=this.shaderModuleService.getModule("blur-pass"),t=e.vs,n=e.fs,r=e.uniforms,i=this.rendererService.getViewportSize(),o=i.width,a=i.height;return{vs:t,fs:n,uniforms:re(re({},r),{},{u_ViewportSize:[o,a]})}}},{key:"convertOptionsToUniforms",value:function(e){var t={};return kh(e.blurRadius)||(t.u_BlurDir=[e.blurRadius,0]),t}}])}(ju),Ih=Ni.isNil,Ph=function(e){function t(){return f(this,t),h(this,t,arguments)}return d(t,e),c(t,[{key:"setupShaders",value:function(){this.shaderModuleService.registerModule("blur-pass",{vs:"attribute vec2 a_Position;\n\nvarying vec2 v_UV;\n\nvoid main() {\n  v_UV = 0.5 * (a_Position + 1.0);\n  gl_Position = vec4(a_Position, 0., 1.);\n}",fs:"varying vec2 v_UV;\n\nuniform sampler2D u_Texture;\n\nuniform vec2 u_ViewportSize: [1.0, 1.0];\nuniform vec2 u_BlurDir: [1.0, 0.0];\n\n// https://github.com/Jam3/glsl-fast-gaussian-blur/blob/master/9.glsl\nvec4 blur9(sampler2D image, vec2 uv, vec2 resolution, vec2 direction) {\n  vec4 color = vec4(0.0);\n  vec2 off1 = vec2(1.3846153846) * direction;\n  vec2 off2 = vec2(3.2307692308) * direction;\n  color += texture2D(image, uv) * 0.2270270270;\n  color += texture2D(image, uv + (off1 / resolution)) * 0.3162162162;\n  color += texture2D(image, uv - (off1 / resolution)) * 0.3162162162;\n  color += texture2D(image, uv + (off2 / resolution)) * 0.0702702703;\n  color += texture2D(image, uv - (off2 / resolution)) * 0.0702702703;\n  return color;\n}\n\nvoid main() {\n  gl_FragColor = blur9(u_Texture, v_UV, u_ViewportSize, u_BlurDir);\n}"});var e=this.shaderModuleService.getModule("blur-pass"),t=e.vs,n=e.fs,r=e.uniforms,i=this.rendererService.getViewportSize(),o=i.width,a=i.height;return{vs:t,fs:n,uniforms:re(re({},r),{},{u_ViewportSize:[o,a]})}}},{key:"convertOptionsToUniforms",value:function(e){var t={};return Ih(e.blurRadius)||(t.u_BlurDir=[0,e.blurRadius]),t}}])}(ju),Dh=function(e){function t(){return f(this,t),h(this,t,arguments)}return d(t,e),c(t,[{key:"setupShaders",value:function(){this.shaderModuleService.registerModule("colorhalftone-pass",{vs:"attribute vec2 a_Position;\n\nvarying vec2 v_UV;\n\nvoid main() {\n  v_UV = 0.5 * (a_Position + 1.0);\n  gl_Position = vec4(a_Position, 0., 1.);\n}",fs:'varying vec2 v_UV;\n\nuniform sampler2D u_Texture;\nuniform vec2 u_ViewportSize: [1.0, 1.0];\nuniform vec2 u_Center : [0.5, 0.5];\nuniform float u_Angle : 0;\nuniform float u_Size : 8;\n\n#pragma include "common"\n\nfloat scale = PI / u_Size;\n\nfloat pattern(float u_Angle, vec2 texSize, vec2 texCoord) {\n  float s = sin(u_Angle), c = cos(u_Angle);\n  vec2 tex = texCoord * texSize - u_Center * texSize;\n  vec2 point = vec2(\n    c * tex.x - s * tex.y,\n    s * tex.x + c * tex.y\n  ) * scale;\n  return (sin(point.x) * sin(point.y)) * 4.0;\n}\n\n// https://github.com/evanw/glfx.js/blob/master/src/filters/fun/colorhalftone.js\nvec4 colorHalftone_filterColor(vec4 color, vec2 texSize, vec2 texCoord) {\n  vec3 cmy = 1.0 - color.rgb;\n  float k = min(cmy.x, min(cmy.y, cmy.z));\n  cmy = (cmy - k) / (1.0 - k);\n  cmy = clamp(\n    cmy * 10.0 - 3.0 + vec3(\n      pattern(u_Angle + 0.26179, texSize, texCoord),\n      pattern(u_Angle + 1.30899, texSize, texCoord),\n      pattern(u_Angle, texSize, texCoord)\n    ),\n    0.0,\n    1.0\n  );\n  k = clamp(k * 10.0 - 5.0 + pattern(u_Angle + 0.78539, texSize, texCoord), 0.0, 1.0);\n  return vec4(1.0 - cmy - k, color.a);\n}\n\nvoid main() {\n  gl_FragColor = vec4(texture2D(u_Texture, v_UV));\n  gl_FragColor = colorHalftone_filterColor(gl_FragColor, u_ViewportSize, v_UV);\n}'});var e=this.shaderModuleService.getModule("colorhalftone-pass"),t=e.vs,n=e.fs,r=e.uniforms,i=this.rendererService.getViewportSize(),o=i.width,a=i.height;return{vs:t,fs:n,uniforms:re(re({},r),{},{u_ViewportSize:[o,a]})}}}])}(ju),Fh=function(e){function t(){return f(this,t),h(this,t,arguments)}return d(t,e),c(t,[{key:"setupShaders",value:function(){return this.shaderModuleService.registerModule("copy-pass",{vs:"attribute vec2 a_Position;\n\nvarying vec2 v_UV;\n\nvoid main() {\n  v_UV = 0.5 * (a_Position + 1.0);\n  gl_Position = vec4(a_Position, 0., 1.);\n}",fs:"varying vec2 v_UV;\n\nuniform sampler2D u_Texture;\n\nvoid main() {\n  gl_FragColor = vec4(texture2D(u_Texture, v_UV));\n}"}),this.shaderModuleService.getModule("copy-pass")}}])}(ju),Bh=function(e){function t(){return f(this,t),h(this,t,arguments)}return d(t,e),c(t,[{key:"setupShaders",value:function(){this.shaderModuleService.registerModule("hexagonalpixelate-pass",{vs:"attribute vec2 a_Position;\n\nvarying vec2 v_UV;\n\nvoid main() {\n  v_UV = 0.5 * (a_Position + 1.0);\n  gl_Position = vec4(a_Position, 0., 1.);\n}",fs:"varying vec2 v_UV;\n\nuniform sampler2D u_Texture;\nuniform vec2 u_ViewportSize: [1.0, 1.0];\nuniform vec2 u_Center : [0.5, 0.5];\nuniform float u_Scale : 10;\n\n// https://github.com/evanw/glfx.js/blob/master/src/filters/fun/hexagonalpixelate.js\nvec4 hexagonalPixelate_sampleColor(sampler2D texture, vec2 texSize, vec2 texCoord) {\n  vec2 tex = (texCoord * texSize - u_Center * texSize) / u_Scale;\n  tex.y /= 0.866025404;\n  tex.x -= tex.y * 0.5;\n  vec2 a;\n  if (tex.x + tex.y - floor(tex.x) - floor(tex.y) < 1.0) {\n    a = vec2(floor(tex.x), floor(tex.y));\n  }\n  else a = vec2(ceil(tex.x), ceil(tex.y));\n  vec2 b = vec2(ceil(tex.x), floor(tex.y));\n  vec2 c = vec2(floor(tex.x), ceil(tex.y));\n  vec3 TEX = vec3(tex.x, tex.y, 1.0 - tex.x - tex.y);\n  vec3 A = vec3(a.x, a.y, 1.0 - a.x - a.y);\n  vec3 B = vec3(b.x, b.y, 1.0 - b.x - b.y);\n  vec3 C = vec3(c.x, c.y, 1.0 - c.x - c.y);\n  float alen = length(TEX - A);\n  float blen = length(TEX - B);\n  float clen = length(TEX - C);\n  vec2 choice;\n  if (alen < blen) {\n    if (alen < clen) choice = a;\n    else choice = c;\n  } else {\n    if (blen < clen) choice = b;\n    else choice = c;\n  }\n  choice.x += choice.y * 0.5;\n  choice.y *= 0.866025404;\n  choice *= u_Scale / texSize;\n  return texture2D(texture, choice + u_Center);\n}\n\nvoid main() {\n  gl_FragColor = vec4(texture2D(u_Texture, v_UV));\n  gl_FragColor = hexagonalPixelate_sampleColor(u_Texture, u_ViewportSize, v_UV);\n}"});var e=this.shaderModuleService.getModule("hexagonalpixelate-pass"),t=e.vs,n=e.fs,r=e.uniforms,i=this.rendererService.getViewportSize(),o=i.width,a=i.height;return{vs:t,fs:n,uniforms:re(re({},r),{},{u_ViewportSize:[o,a]})}}}])}(ju),Uh=function(e){function t(){return f(this,t),h(this,t,arguments)}return d(t,e),c(t,[{key:"setupShaders",value:function(){this.shaderModuleService.registerModule("ink-pass",{vs:"attribute vec2 a_Position;\n\nvarying vec2 v_UV;\n\nvoid main() {\n  v_UV = 0.5 * (a_Position + 1.0);\n  gl_Position = vec4(a_Position, 0., 1.);\n}",fs:"varying vec2 v_UV;\n\nuniform sampler2D u_Texture;\nuniform vec2 u_ViewportSize: [1.0, 1.0];\nuniform float u_Strength : 0.6;\n\nvec4 ink_sampleColor(sampler2D texture, vec2 texSize, vec2 texCoord) {\n  vec2 dx = vec2(1.0 / texSize.x, 0.0);\n  vec2 dy = vec2(0.0, 1.0 / texSize.y);\n  vec4 color = texture2D(texture, texCoord);\n  float bigTotal = 0.0;\n  float smallTotal = 0.0;\n  vec3 bigAverage = vec3(0.0);\n  vec3 smallAverage = vec3(0.0);\n  for (float x = -2.0; x <= 2.0; x += 1.0) {\n    for (float y = -2.0; y <= 2.0; y += 1.0) {\n      vec3 sample = texture2D(texture, texCoord + dx * x + dy * y).rgb;\n      bigAverage += sample;\n      bigTotal += 1.0;\n      if (abs(x) + abs(y) < 2.0) {\n        smallAverage += sample;\n        smallTotal += 1.0;\n      }\n    }\n  }\n  vec3 edge = max(vec3(0.0), bigAverage / bigTotal - smallAverage / smallTotal);\n  float power = u_Strength * u_Strength * u_Strength * u_Strength * u_Strength;\n  return vec4(color.rgb - dot(edge, edge) * power * 100000.0, color.a);\n}\n\nvoid main() {\n  gl_FragColor = vec4(texture2D(u_Texture, v_UV));\n  gl_FragColor = ink_sampleColor(u_Texture, u_ViewportSize, v_UV);\n}"});var e=this.shaderModuleService.getModule("ink-pass"),t=e.vs,n=e.fs,r=e.uniforms,i=this.rendererService.getViewportSize(),o=i.width,a=i.height;return{vs:t,fs:n,uniforms:re(re({},r),{},{u_ViewportSize:[o,a]})}}}])}(ju),Gh=function(e){function t(){return f(this,t),h(this,t,arguments)}return d(t,e),c(t,[{key:"setupShaders",value:function(){return this.shaderModuleService.registerModule("noise-pass",{vs:"attribute vec2 a_Position;\n\nvarying vec2 v_UV;\n\nvoid main() {\n  v_UV = 0.5 * (a_Position + 1.0);\n  gl_Position = vec4(a_Position, 0., 1.);\n}",fs:"varying vec2 v_UV;\n\nuniform sampler2D u_Texture;\nuniform float u_Amount : 0.5;\n\nfloat rand(vec2 co) {\n  return fract(sin(dot(co.xy ,vec2(12.9898,78.233))) * 43758.5453);\n}\n\n// https://github.com/evanw/glfx.js/blob/master/src/filters/adjust/noise.js\nvec4 noise_filterColor(vec4 color, vec2 texCoord) {\n  float diff = (rand(texCoord) - 0.5) * u_Amount;\n  color.r += diff;\n  color.g += diff;\n  color.b += diff;\n  return color;\n}\n\nvoid main() {\n  gl_FragColor = vec4(texture2D(u_Texture, v_UV));\n  gl_FragColor = noise_filterColor(gl_FragColor, v_UV);\n}"}),this.shaderModuleService.getModule("noise-pass")}}])}(ju),zh=function(e){function t(){return f(this,t),h(this,t,arguments)}return d(t,e),c(t,[{key:"setupShaders",value:function(){return this.shaderModuleService.registerModule("sepia-pass",{vs:"attribute vec2 a_Position;\n\nvarying vec2 v_UV;\n\nvoid main() {\n  v_UV = 0.5 * (a_Position + 1.0);\n  gl_Position = vec4(a_Position, 0., 1.);\n}",fs:"varying vec2 v_UV;\n\nuniform sampler2D u_Texture;\n\nuniform float u_Amount : 0.5;\n\n// https://github.com/evanw/glfx.js/blob/master/src/filters/adjust/sepia.js\nvec4 sepia_filterColor(vec4 color) {\n  float r = color.r;\n  float g = color.g;\n  float b = color.b;\n  color.r =\n    min(1.0, (r * (1.0 - (0.607 * u_Amount))) + (g * (0.769 * u_Amount)) + (b * (0.189 * u_Amount)));\n  color.g = min(1.0, (r * 0.349 * u_Amount) + (g * (1.0 - (0.314 * u_Amount))) + (b * 0.168 * u_Amount));\n  color.b = min(1.0, (r * 0.272 * u_Amount) + (g * 0.534 * u_Amount) + (b * (1.0 - (0.869 * u_Amount))));\n  return color;\n}\n\nvoid main() {\n  gl_FragColor = vec4(texture2D(u_Texture, v_UV));\n  gl_FragColor = sepia_filterColor(gl_FragColor);\n}"}),this.shaderModuleService.getModule("sepia-pass")}}])}(ju),jh=new Sl,Vh=0;function Hh(e){var t=re({},e);return t.postProcessor=new Sh(t.rendererService),t.multiPassRenderer=new Ah(t.postProcessor),t.styleAttributeService=new Yl(t.rendererService),t}var Xh=["loaded","fontloaded","maploaded","resize","destroy","dragstart","dragging","dragend","dragcancel"],Wh=function(e){return e.IMAGE="image",e.CUSTOMIMAGE="customImage",e.ARRAYBUFFER="arraybuffer",e.RGB="rgb",e.TERRAINRGB="terrainRGB",e.CUSTOMRGB="customRGB",e.CUSTOMARRAYBUFFER="customArrayBuffer",e.CUSTOMTERRAINRGB="customTerrainRGB",e}({}),Yh=function(e,t,n){return new Promise((function(r,i){var o=function(e){try{s(n.next(e))}catch(t){i(t)}},a=function(e){try{s(n.throw(e))}catch(t){i(t)}},s=function(e){return e.done?r(e.value):Promise.resolve(e.value).then(o,a)};s((n=n.apply(e,t)).next())}))};function Zh(e,t){return Array.isArray(e)?"string"==typeof e[0]?e.map((function(e){return Fo(e,t)})):e.map((function(e){return{url:Fo(e.url,t),bands:e.bands||[0]}})):Fo(e,t)}function qh(e,t){e.xhrCancel=function(){t.map((function(e){e.abort()}))}}var Kh=Object.defineProperty,Qh=Object.defineProperties,$h=Object.getOwnPropertyDescriptors,Jh=Object.getOwnPropertySymbols,ed=Object.prototype.hasOwnProperty,td=Object.prototype.propertyIsEnumerable,nd=function(e,t,n){return t in e?Kh(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n},rd=function(e,t){for(var n in t||(t={}))ed.call(t,n)&&nd(e,n,t[n]);if(Jh){var r,i=y(Jh(t));try{for(i.s();!(r=i.n()).done;){n=r.value;td.call(t,n)&&nd(e,n,t[n])}}catch(o){i.e(o)}finally{i.f()}}return e},id=function(e,t){return Qh(e,$h(t))},od=function(e,t,n){return new Promise((function(r,i){var o=function(e){try{s(n.next(e))}catch(t){i(t)}},a=function(e){try{s(n.throw(e))}catch(t){i(t)}},s=function(e){return e.done?r(e.value):Promise.resolve(e.value).then(o,a)};s((n=n.apply(e,t)).next())}))},ad=function(e,t,n,r,o){return od(void 0,null,i().mark((function a(){var s,u,c,l,f,h;return i().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:if(a=t.url,!((s="string"==typeof a?[{url:a,bands:[0]}]:"string"==typeof a[0]?a.map((function(e){return{url:e,bands:[0]}})):a).length>1)){i.next=15;break}return i.next=4,sd(s,t);case 4:if(u=i.sent,c=u.rasterFiles,l=u.xhrList,f=u.errList,qh(e,l),!(f.length>0)){i.next=12;break}return n(f,null),i.abrupt("return");case 12:Du(c,r,o,n),i.next=17;break;case 15:h=ut(t,(function(e,t){if(e)n(e);else if(t){Du([{data:t,bands:s[0].bands}],r,o,n)}})),qh(e,[h]);case 17:case"end":return i.stop()}var a}),a)})))};function sd(e,t){return od(this,null,i().mark((function n(){var r,o,a,s,u,c,l,f,h,d,p;return i().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:r=[],o=[],a=[],s=0;case 4:if(!(s<e.length)){n.next=20;break}return u=e[s],c=id(rd({},t),{url:u.url}),l=u.bands,n.next=10,at(id(rd({},c),{type:"arrayBuffer"}));case 10:f=n.sent,h=f.err,d=f.data,p=f.xhr,h&&a.push(h),o.push(p),r.push({data:d,bands:l});case 17:s++,n.next=4;break;case 20:return n.abrupt("return",{rasterFiles:r,xhrList:o,errList:a});case 21:case"end":return n.stop()}}),n)})))}var ud=Object.defineProperty,cd=Object.defineProperties,ld=Object.getOwnPropertyDescriptors,fd=Object.getOwnPropertySymbols,hd=Object.prototype.hasOwnProperty,dd=Object.prototype.propertyIsEnumerable,pd=function(e,t,n){return t in e?ud(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n},vd=function(e,t){for(var n in t||(t={}))hd.call(t,n)&&pd(e,n,t[n]);if(fd){var r,i=y(fd(t));try{for(i.s();!(r=i.n()).done;){n=r.value;dd.call(t,n)&&pd(e,n,t[n])}}catch(o){i.e(o)}finally{i.f()}}return e},md=function(e,t){return cd(e,ld(t))},gd=function(e,t,n){return new Promise((function(r,i){var o=function(e){try{s(n.next(e))}catch(t){i(t)}},a=function(e){try{s(n.throw(e))}catch(t){i(t)}},s=function(e){return e.done?r(e.value):Promise.resolve(e.value).then(o,a)};s((n=n.apply(e,t)).next())}))},_d=function(e,t,n,r){return gd(void 0,null,i().mark((function o(){var a,s,u,c;return i().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return s=Array.isArray(e)?e[0]:e,r.wmtsOptions?(u=(null==r?void 0:r.getURLFromTemplate)||Bo,a=u(s,vd(vd({},t),r.wmtsOptions))):(c=(null==r?void 0:r.getURLFromTemplate)||Fo,a=c(s,t)),i.abrupt("return",new Promise((function(e,t){var i,o=dt(md(vd({},null==r?void 0:r.requestParameters),{url:a,type:(null==(i=null==r?void 0:r.requestParameters)?void 0:i.type)||"arrayBuffer"}),(function(n,r){n?t(n):r&&e(r)}),r.transformResponse);n.xhrCancel=function(){return o.cancel()}})));case 3:case"end":return i.stop()}}),o)})))},yd=function(){return{rasterData:new Uint8Array([0]),width:1,height:1}},Ed=Object.defineProperty,bd=Object.defineProperties,Ad=Object.getOwnPropertyDescriptors,xd=Object.getOwnPropertySymbols,Sd=Object.prototype.hasOwnProperty,Td=Object.prototype.propertyIsEnumerable,Rd=function(e,t,n){return t in e?Ed(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n},Cd=function(e,t){for(var n in t||(t={}))Sd.call(t,n)&&Rd(e,n,t[n]);if(xd){var r,i=y(xd(t));try{for(i.s();!(r=i.n()).done;){n=r.value;Td.call(t,n)&&Rd(e,n,t[n])}}catch(o){i.e(o)}finally{i.f()}}return e},Md={tileSize:256,minZoom:0,maxZoom:1/0,zoomOffset:0,warp:!0};Wh.ARRAYBUFFER,Wh.RGB;var wd=Object.defineProperty,Ld=Object.defineProperties,Od=Object.getOwnPropertyDescriptors,kd=Object.getOwnPropertySymbols,Nd=Object.prototype.hasOwnProperty,Id=Object.prototype.propertyIsEnumerable,Pd=function(e,t,n){return t in e?wd(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n},Dd=function(e,t){for(var n in t||(t={}))Nd.call(t,n)&&Pd(e,n,t[n]);if(kd){var r,i=y(kd(t));try{for(i.s();!(r=i.n()).done;){n=r.value;Id.call(t,n)&&Pd(e,n,t[n])}}catch(o){i.e(o)}finally{i.f()}}return e};var Fd=Object.defineProperty,Bd=Object.defineProperties,Ud=Object.getOwnPropertyDescriptors,Gd=Object.getOwnPropertySymbols,zd=Object.prototype.hasOwnProperty,jd=Object.prototype.propertyIsEnumerable,Vd=function(e,t,n){return t in e?Fd(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n},Hd=function(e,t){for(var n in t||(t={}))zd.call(t,n)&&Vd(e,n,t[n]);if(Gd){var r,i=y(Gd(t));try{for(i.s();!(r=i.n()).done;){n=r.value;jd.call(t,n)&&Vd(e,n,t[n])}}catch(o){i.e(o)}finally{i.f()}}return e},Xd=function(e,t){return Bd(e,Ud(t))};var Wd=Object.defineProperty,Yd=Object.defineProperties,Zd=Object.getOwnPropertyDescriptors,qd=Object.getOwnPropertySymbols,Kd=Object.prototype.hasOwnProperty,Qd=Object.prototype.propertyIsEnumerable,$d=function(e,t,n){return t in e?Wd(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n},Jd=function(e,t){for(var n in t||(t={}))Kd.call(t,n)&&$d(e,n,t[n]);if(qd){var r,i=y(qd(t));try{for(i.s();!(r=i.n()).done;){n=r.value;Qd.call(t,n)&&$d(e,n,t[n])}}catch(o){i.e(o)}finally{i.f()}}return e};var ep=Object.defineProperty,tp=Object.defineProperties,np=Object.getOwnPropertyDescriptors,rp=Object.getOwnPropertySymbols,ip=Object.prototype.hasOwnProperty,op=Object.prototype.propertyIsEnumerable,ap=function(e,t,n){return t in e?ep(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n},sp=function(e,t){for(var n in t||(t={}))ip.call(t,n)&&ap(e,n,t[n]);if(rp){var r,i=y(rp(t));try{for(i.s();!(r=i.n()).done;){n=r.value;op.call(t,n)&&ap(e,n,t[n])}}catch(o){i.e(o)}finally{i.f()}}return e},up={tileSize:256,minZoom:0,maxZoom:1/0,zoomOffset:0},cp=function(e){return t=void 0,n=null,r=i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",new Promise((function(t){var n=a(e.bounds,4),r=n[0],i=n[1],o=n[2],s=n[3];t({layers:{testTile:{features:[{type:"Feature",properties:{key:e.x+"/"+e.y+"/"+e.z,x:(r+o)/2,y:(i+s)/2},geometry:{type:"LineString",coordinates:[[o,s],[o,i],[r,i],[r,i]]}}]}}})})));case 1:case"end":return t.stop()}}),t)})),new Promise((function(e,i){var o=function(e){try{s(r.next(e))}catch(t){i(t)}},a=function(e){try{s(r.throw(e))}catch(t){i(t)}},s=function(t){return t.done?e(t.value):Promise.resolve(t.value).then(o,a)};s((r=r.apply(t,n)).next())}));var t,n,r};var lp={exports:{}};!function(e,t){e.exports=function(){function e(n,r,i,o,a,s){if(!(a-o<=i)){var u=o+a>>1;t(n,r,u,o,a,s%2),e(n,r,i,o,u-1,s+1),e(n,r,i,u+1,a,s+1)}}function t(e,r,i,o,a,s){for(;a>o;){if(a-o>600){var u=a-o+1,c=i-o+1,l=Math.log(u),f=.5*Math.exp(2*l/3),h=.5*Math.sqrt(l*f*(u-f)/u)*(c-u/2<0?-1:1);t(e,r,i,Math.max(o,Math.floor(i-c*f/u+h)),Math.min(a,Math.floor(i+(u-c)*f/u+h)),s)}var d=r[2*i+s],p=o,v=a;for(n(e,r,o,i),r[2*a+s]>d&&n(e,r,o,a);p<v;){for(n(e,r,p,v),p++,v--;r[2*p+s]<d;)p++;for(;r[2*v+s]>d;)v--}r[2*o+s]===d?n(e,r,o,v):n(e,r,++v,a),v<=i&&(o=v+1),i<=v&&(a=v-1)}}function n(e,t,n,i){r(e,n,i),r(t,2*n,2*i),r(t,2*n+1,2*i+1)}function r(e,t,n){var r=e[t];e[t]=e[n],e[n]=r}function i(e,t,n,r,i,o,a){for(var s,u,c=[0,e.length-1,0],l=[];c.length;){var f=c.pop(),h=c.pop(),d=c.pop();if(h-d<=a)for(var p=d;p<=h;p++)s=t[2*p],u=t[2*p+1],s>=n&&s<=i&&u>=r&&u<=o&&l.push(e[p]);else{var v=Math.floor((d+h)/2);s=t[2*v],u=t[2*v+1],s>=n&&s<=i&&u>=r&&u<=o&&l.push(e[v]);var m=(f+1)%2;(0===f?n<=s:r<=u)&&(c.push(d),c.push(v-1),c.push(m)),(0===f?i>=s:o>=u)&&(c.push(v+1),c.push(h),c.push(m))}}return l}function o(e,t,n,r,i,o){for(var s=[0,e.length-1,0],u=[],c=i*i;s.length;){var l=s.pop(),f=s.pop(),h=s.pop();if(f-h<=o)for(var d=h;d<=f;d++)a(t[2*d],t[2*d+1],n,r)<=c&&u.push(e[d]);else{var p=Math.floor((h+f)/2),v=t[2*p],m=t[2*p+1];a(v,m,n,r)<=c&&u.push(e[p]);var g=(l+1)%2;(0===l?n-i<=v:r-i<=m)&&(s.push(h),s.push(p-1),s.push(g)),(0===l?n+i>=v:r+i>=m)&&(s.push(p+1),s.push(f),s.push(g))}}return u}function a(e,t,n,r){var i=e-n,o=t-r;return i*i+o*o}var s=function(e){return e[0]},u=function(e){return e[1]},c=function(t,n,r,i,o){void 0===n&&(n=s),void 0===r&&(r=u),void 0===i&&(i=64),void 0===o&&(o=Float64Array),this.nodeSize=i,this.points=t;for(var a=t.length<65536?Uint16Array:Uint32Array,c=this.ids=new a(t.length),l=this.coords=new o(2*t.length),f=0;f<t.length;f++)c[f]=f,l[2*f]=n(t[f]),l[2*f+1]=r(t[f]);e(c,l,i,0,c.length-1,0)};c.prototype.range=function(e,t,n,r){return i(this.ids,this.coords,e,t,n,r,this.nodeSize)},c.prototype.within=function(e,t,n){return o(this.ids,this.coords,e,t,n,this.nodeSize)};var l={minZoom:0,maxZoom:16,minPoints:2,radius:40,extent:512,nodeSize:64,log:!1,generateId:!1,reduce:null,map:function(e){return e}},f=Math.fround||function(e){return function(t){return e[0]=+t,e[0]}}(new Float32Array(1)),h=function(e){this.options=b(Object.create(l),e),this.trees=new Array(this.options.maxZoom+1)};function d(e,t,n,r,i){return{x:f(e),y:f(t),zoom:1/0,id:n,parentId:-1,numPoints:r,properties:i}}function p(e,t){var n=e.geometry.coordinates,r=n[0],i=n[1];return{x:f(g(r)),y:f(_(i)),zoom:1/0,index:t,parentId:-1}}function v(e){return{type:"Feature",id:e.id,properties:m(e),geometry:{type:"Point",coordinates:[y(e.x),E(e.y)]}}}function m(e){var t=e.numPoints,n=t>=1e4?Math.round(t/1e3)+"k":t>=1e3?Math.round(t/100)/10+"k":t;return b(b({},e.properties),{cluster:!0,cluster_id:e.id,point_count:t,point_count_abbreviated:n})}function g(e){return e/360+.5}function _(e){var t=Math.sin(e*Math.PI/180),n=.5-.25*Math.log((1+t)/(1-t))/Math.PI;return n<0?0:n>1?1:n}function y(e){return 360*(e-.5)}function E(e){var t=(180-360*e)*Math.PI/180;return 360*Math.atan(Math.exp(t))/Math.PI-90}function b(e,t){for(var n in t)e[n]=t[n];return e}function A(e){return e.x}function x(e){return e.y}return h.prototype.load=function(e){var t=this.options,n=t.log,r=t.minZoom,i=t.maxZoom,o=t.nodeSize;n&&console.time("total time");var a="prepare "+e.length+" points";n&&console.time(a),this.points=e;for(var s=[],u=0;u<e.length;u++)e[u].geometry&&s.push(p(e[u],u));this.trees[i+1]=new c(s,A,x,o,Float32Array),n&&console.timeEnd(a);for(var l=i;l>=r;l--){var f=+Date.now();s=this._cluster(s,l),this.trees[l]=new c(s,A,x,o,Float32Array),n&&console.log("z%d: %d clusters in %dms",l,s.length,+Date.now()-f)}return n&&console.timeEnd("total time"),this},h.prototype.getClusters=function(e,t){var n=((e[0]+180)%360+360)%360-180,r=Math.max(-90,Math.min(90,e[1])),i=180===e[2]?180:((e[2]+180)%360+360)%360-180,o=Math.max(-90,Math.min(90,e[3]));if(e[2]-e[0]>=360)n=-180,i=180;else if(n>i){var a=this.getClusters([n,r,180,o],t),s=this.getClusters([-180,r,i,o],t);return a.concat(s)}for(var u=this.trees[this._limitZoom(t)],c=[],l=0,f=u.range(g(n),_(o),g(i),_(r));l<f.length;l+=1){var h=f[l],d=u.points[h];c.push(d.numPoints?v(d):this.points[d.index])}return c},h.prototype.getChildren=function(e){var t=this._getOriginId(e),n=this._getOriginZoom(e),r="No cluster with the specified id.",i=this.trees[n];if(!i)throw new Error(r);var o=i.points[t];if(!o)throw new Error(r);for(var a=this.options.radius/(this.options.extent*Math.pow(2,n-1)),s=[],u=0,c=i.within(o.x,o.y,a);u<c.length;u+=1){var l=c[u],f=i.points[l];f.parentId===e&&s.push(f.numPoints?v(f):this.points[f.index])}if(0===s.length)throw new Error(r);return s},h.prototype.getLeaves=function(e,t,n){t=t||10,n=n||0;var r=[];return this._appendLeaves(r,e,t,n,0),r},h.prototype.getTile=function(e,t,n){var r=this.trees[this._limitZoom(e)],i=Math.pow(2,e),o=this.options,a=o.extent,s=o.radius/a,u=(n-s)/i,c=(n+1+s)/i,l={features:[]};return this._addTileFeatures(r.range((t-s)/i,u,(t+1+s)/i,c),r.points,t,n,i,l),0===t&&this._addTileFeatures(r.range(1-s/i,u,1,c),r.points,i,n,i,l),t===i-1&&this._addTileFeatures(r.range(0,u,s/i,c),r.points,-1,n,i,l),l.features.length?l:null},h.prototype.getClusterExpansionZoom=function(e){for(var t=this._getOriginZoom(e)-1;t<=this.options.maxZoom;){var n=this.getChildren(e);if(t++,1!==n.length)break;e=n[0].properties.cluster_id}return t},h.prototype._appendLeaves=function(e,t,n,r,i){for(var o=0,a=this.getChildren(t);o<a.length;o+=1){var s=a[o],u=s.properties;if(u&&u.cluster?i+u.point_count<=r?i+=u.point_count:i=this._appendLeaves(e,u.cluster_id,n,r,i):i<r?i++:e.push(s),e.length===n)break}return i},h.prototype._addTileFeatures=function(e,t,n,r,i,o){for(var a=0,s=e;a<s.length;a+=1){var u=t[s[a]],c=u.numPoints,l=void 0,f=void 0,h=void 0;if(c)l=m(u),f=u.x,h=u.y;else{var d=this.points[u.index];l=d.properties,f=g(d.geometry.coordinates[0]),h=_(d.geometry.coordinates[1])}var p={type:1,geometry:[[Math.round(this.options.extent*(f*i-n)),Math.round(this.options.extent*(h*i-r))]],tags:l},v=void 0;c?v=u.id:this.options.generateId?v=u.index:this.points[u.index].id&&(v=this.points[u.index].id),void 0!==v&&(p.id=v),o.features.push(p)}},h.prototype._limitZoom=function(e){return Math.max(this.options.minZoom,Math.min(Math.floor(+e),this.options.maxZoom+1))},h.prototype._cluster=function(e,t){for(var n=[],r=this.options,i=r.radius,o=r.extent,a=r.reduce,s=r.minPoints,u=i/(o*Math.pow(2,t)),c=0;c<e.length;c++){var l=e[c];if(!(l.zoom<=t)){l.zoom=t;for(var f=this.trees[t+1],h=f.within(l.x,l.y,u),p=l.numPoints||1,v=p,m=0,g=h;m<g.length;m+=1){var _=g[m],y=f.points[_];y.zoom>t&&(v+=y.numPoints||1)}if(v>p&&v>=s){for(var E=l.x*p,b=l.y*p,A=a&&p>1?this._map(l,!0):null,x=(c<<5)+(t+1)+this.points.length,S=0,T=h;S<T.length;S+=1){var R=T[S],C=f.points[R];if(!(C.zoom<=t)){C.zoom=t;var M=C.numPoints||1;E+=C.x*M,b+=C.y*M,C.parentId=x,a&&(A||(A=this._map(l,!0)),a(A,this._map(C)))}}l.parentId=x,n.push(d(E/v,b/v,x,v,A))}else if(n.push(l),v>1)for(var w=0,L=h;w<L.length;w+=1){var O=L[w],k=f.points[O];k.zoom<=t||(k.zoom=t,n.push(k))}}}return n},h.prototype._getOriginId=function(e){return e-this.points.length>>5},h.prototype._getOriginZoom=function(e){return(e-this.points.length)%32},h.prototype._map=function(e,t){if(e.numPoints)return t?b({},e.properties):e.properties;var n=this.points[e.index].properties,r=this.options.map(n);return t&&r===n?b({},r):r},h}()}(lp);var fp=lp.exports,hp=Object.defineProperty,dp=Object.getOwnPropertySymbols,pp=Object.prototype.hasOwnProperty,vp=Object.prototype.propertyIsEnumerable,mp=function(e,t,n){return t in e?hp(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n},gp=function(e,t){for(var n in t||(t={}))pp.call(t,n)&&mp(e,n,t[n]);if(dp){var r,i=y(dp(t));try{for(i.s();!(r=i.n()).done;){n=r.value;vp.call(t,n)&&mp(e,n,t[n])}}catch(o){i.e(o)}finally{i.f()}}return e};function _p(e,t){var n=t.radius,r=void 0===n?40:n,i=t.maxZoom,o=void 0===i?18:i,a=t.minZoom,s=void 0===a?0:a,u=t.zoom,c=void 0===u?2:u;if(e.pointIndex){var l=e.pointIndex.getClusters(e.extent,Math.floor(c));return e.dataArray=l.map((function(e,t){return gp({coordinates:e.geometry.coordinates,_id:t+1},e.properties)})),e}var f=new fp({radius:r,minZoom:s,maxZoom:o}),h={type:"FeatureCollection",features:[]};return h.features=e.dataArray.map((function(e){return{type:"Feature",geometry:{type:"Point",coordinates:e.coordinates},properties:gp({},e)}})),f.load(h.features),f}function yp(e){if(0===e.length)return 0;for(var t,n=e[0],r=0,i=1;i<e.length;i++)t=n+1*e[i],Math.abs(n)>=Math.abs(e[i])?r+=n-t+e[i]:r+=e[i]-t+n,n=t;return n+1*r}var Ep={min:function(e){if(0===e.length)throw new Error("min requires at least one data point");for(var t=e[0],n=1;n<e.length;n++)e[n]<t&&(t=e[n]);return t},max:function(e){if(0===e.length)throw new Error("max requires at least one data point");for(var t=e[0],n=1;n<e.length;n++)e[n]>t&&(t=e[n]);return t},mean:function(e){if(0===e.length)throw new Error("mean requires at least one data point");return yp(e)/e.length},sum:yp},bp=Object.defineProperty,Ap=Object.getOwnPropertySymbols,xp=Object.prototype.hasOwnProperty,Sp=Object.prototype.propertyIsEnumerable,Tp=function(e,t,n){return t in e?bp(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n},Rp=function(e,t){for(var n in t||(t={}))xp.call(t,n)&&Tp(e,n,t[n]);if(Ap){var r,i=y(Ap(t));try{for(i.s();!(r=i.n()).done;){n=r.value;Sp.call(t,n)&&Tp(e,n,t[n])}}catch(o){i.e(o)}finally{i.f()}}return e},Cp=function(e,t,n){return new Promise((function(r,i){var o=function(e){try{s(n.next(e))}catch(t){i(t)}},a=function(e){try{s(n.throw(e))}catch(t){i(t)}},s=function(e){return e.done?r(e.value):Promise.resolve(e.value).then(o,a)};s((n=n.apply(e,t)).next())}))},Mp=Ni.cloneDeep,wp=Ni.isFunction,Lp=Ni.isString,Op=Ni.mergeWith;function kp(e,t){if(Array.isArray(t))return t}var Np=function(e){function t(e,n){var r;return f(this,t),(r=h(this,t)).type="source",r.isTile=!1,r.inited=!1,r.hooks={init:new Cf},r.parser={type:"geojson"},r.transforms=[],r.cluster=!1,r.clusterOptions={enable:!1,radius:40,maxZoom:20,zoom:-99,method:"count"},r.invalidExtent=!1,r.dataArrayChanged=!1,r.cfg={autoRender:!0},r.originData=e,r.initCfg(n),r.init().then((function(){r.inited=!0,r.emit("update",{type:"inited"})})),r}return d(t,e),c(t,[{key:"getSourceCfg",value:function(){return this.cfg}},{key:"getClusters",value:function(e){return this.clusterIndex.getClusters(this.caculClusterExtent(2),e)}},{key:"getClustersLeaves",value:function(e){return this.clusterIndex.getLeaves(e,1/0)}},{key:"getParserType",value:function(){return this.parser.type}},{key:"updateClusterData",value:function(e){var t=this,n=this.clusterOptions,r=n.method,i=void 0===r?"sum":r,o=n.field,a=this.clusterIndex.getClusters(this.caculClusterExtent(2),Math.floor(e));this.clusterOptions.zoom=e,a.forEach((function(e){e.id||(e.properties.point_count=1)})),(o||wp(i))&&(a=a.map((function(e){var n=e.id;if(n){var r,a=t.clusterIndex.getLeaves(n,1/0).map((function(e){return e.properties}));if(Lp(i)&&o){var s=function(e,t){return e.map((function(e){return 1*e[t]}))}(a,o);r=Ep[i](s)}wp(i)&&(r=i(a)),e.properties.stat=r}else e.properties.point_count=1;return e}))),this.data=we("geojson")({type:"FeatureCollection",features:a}),this.executeTrans()}},{key:"getFeatureById",value:function(e){var t=this.parser,n=t.type,r=void 0===n?"geojson":n,i=t.geometry;if("geojson"!==r||this.cluster)return"json"===r&&i?this.data.dataArray.find((function(t){return t._id===e})):e<this.data.dataArray.length?this.data.dataArray[e]:"null";var o=e<this.originData.features.length?this.originData.features[e]:"null",a=Mp(o);if((null==a?void 0:a.properties)&&(0!==this.transforms.length||this.dataArrayChanged)){var s=this.data.dataArray.find((function(t){return t._id===e}));a.properties=s}return a}},{key:"updateFeaturePropertiesById",value:function(e,t){this.data.dataArray=this.data.dataArray.map((function(n){return n._id===e?Rp(Rp({},n),t):n})),this.dataArrayChanged=!0,this.emit("update",{type:"update"})}},{key:"getFeatureId",value:function(e,t){var n=this.data.dataArray.find((function(n){return n[e]===t}));return null==n?void 0:n._id}},{key:"setData",value:function(e,t){var n=this;this.originData=e,this.dataArrayChanged=!1,this.initCfg(t),this.init().then((function(){n.emit("update",{type:"update"})}))}},{key:"reloadAllTile",value:function(){var e;null==(e=this.tileset)||e.reloadAll()}},{key:"reloadTilebyId",value:function(e,t,n){var r;null==(r=this.tileset)||r.reloadTileById(e,t,n)}},{key:"reloadTileByLnglat",value:function(e,t,n){var r;null==(r=this.tileset)||r.reloadTileByLnglat(e,t,n)}},{key:"getTileExtent",value:function(e,t){var n;return null==(n=this.tileset)?void 0:n.getTileExtent(e,t)}},{key:"getTileByZXY",value:function(e,t,n){var r;return null==(r=this.tileset)?void 0:r.getTileByZXY(e,t,n)}},{key:"reloadTileByExtent",value:function(e,t){var n;null==(n=this.tileset)||n.reloadTileByExtent(e,t)}},{key:"destroy",value:function(){var e;this.removeAllListeners(),this.originData=null,this.clusterIndex=null,this.data=null,null==(e=this.tileset)||e.destroy()}},{key:"processData",value:function(){return Cp(this,null,i().mark((function e(){var t=this;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",new Promise((function(e,n){try{t.excuteParser(),t.initCluster(),t.executeTrans(),e({})}catch(r){n(r)}})));case 1:case"end":return e.stop()}}),e)})))}},{key:"initCfg",value:function(e){this.cfg=Op(this.cfg,e,kp);var t=this.cfg;t&&(t.parser&&(this.parser=t.parser),t.transforms&&(this.transforms=t.transforms),this.cluster=t.cluster||!1,t.clusterOptions&&(this.cluster=!0,this.clusterOptions=Rp(Rp({},this.clusterOptions),t.clusterOptions)))}},{key:"init",value:function(){return Cp(this,null,i().mark((function e(){return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return this.inited=!1,e.next=3,this.processData();case 3:this.inited=!0;case 4:case"end":return e.stop()}}),e,this)})))}},{key:"excuteParser",value:function(){var e=this.parser,t=e.type||"geojson",n=we(t);this.data=n(this.originData,e),this.tileset=this.initTileset(),e.cancelExtent||(this.extent=Zi(this.data.dataArray),this.setCenter(this.extent),this.invalidExtent=this.extent[0]===this.extent[2]||this.extent[1]===this.extent[3])}},{key:"setCenter",value:function(e){this.center=[(e[0]+e[2])/2,(e[1]+e[3])/2],(isNaN(this.center[0])||isNaN(this.center[1]))&&(this.center=[108.92361111111111,34.54083333333333])}},{key:"initTileset",value:function(){var e=this.data.tilesetOptions;if(e)return this.isTile=!0,this.tileset?(this.tileset.updateOptions(e),this.tileset):new Po(Rp({},e))}},{key:"executeTrans",value:function(){var e=this;this.transforms.forEach((function(t){var n=function(e){return Ce[e]}(t.type)(e.data,t);Object.assign(e.data,n)}))}},{key:"initCluster",value:function(){if(this.cluster){var e=this.clusterOptions||{};this.clusterIndex=_p(this.data,e)}}},{key:"caculClusterExtent",value:function(e){var t=[[-1/0,-1/0],[1/0,1/0]];return this.invalidExtent||(t=Ji(to(this.extent),e)),t[0].concat(t[1])}}])}(lo.exports.EventEmitter);var Ip=6378e3;var Pp=Math.PI/3,Dp=[0,Pp,2*Pp,3*Pp,4*Pp,5*Pp];function Fp(e){return e[0]}function Bp(e){return e[1]}var Up=Object.defineProperty,Gp=Object.defineProperties,zp=Object.getOwnPropertyDescriptors,jp=Object.getOwnPropertySymbols,Vp=Object.prototype.hasOwnProperty,Hp=Object.prototype.propertyIsEnumerable,Xp=function(e,t,n){return t in e?Up(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n};var Wp=Object.defineProperty,Yp=Object.getOwnPropertySymbols,Zp=Object.prototype.hasOwnProperty,qp=Object.prototype.propertyIsEnumerable,Kp=function(e,t,n){return t in e?Wp(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n},Qp=function(e,t){for(var n in t||(t={}))Zp.call(t,n)&&Kp(e,n,t[n]);if(Yp){var r,i=y(Yp(t));try{for(i.s();!(r=i.n()).done;){n=r.value;qp.call(t,n)&&Kp(e,n,t[n])}}catch(o){i.e(o)}finally{i.f()}}return e};Le("rasterTile",(function(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(t=e,Array.isArray(t)&&0===t.length||!Array.isArray(t)&&"string"!=typeof t)throw new Error("tile server url is error");var r=(null==n?void 0:n.dataType)||Wh.IMAGE;r===Wh.RGB&&(r=Wh.ARRAYBUFFER);var o,a,s=(o=Cd(Cd({},Md),n),a={getTileData:function(t,o){switch(r){case Wh.IMAGE:return _d(e,t,o,n);case Wh.CUSTOMIMAGE:case Wh.CUSTOMTERRAINRGB:return function(e,t){return Yh(void 0,null,i().mark((function n(){return i().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.abrupt("return",new Promise((function(n,r){t({x:e.x,y:e.y,z:e.z},(function(e,t){var i,o;!e&&t?t instanceof ArrayBuffer?(i=t,o=function(e,t){e&&r(e),n(t)},"function"==typeof createImageBitmap?ht(i,o):ft(i,o)):t instanceof HTMLImageElement?n(t):r(e):r(e)}))})));case 1:case"end":return n.stop()}}),n)})))}(o,null==n?void 0:n.getCustomData);case Wh.ARRAYBUFFER:return function(e,t,n,r){return gd(void 0,null,i().mark((function o(){var a,s,u,c,l;return i().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return a=r.format,s=void 0===a?yd:a,u=r.operation,c=r.requestParameters,l=md(vd({},void 0===c?{}:c),{url:Zh(e,t)}),i.abrupt("return",new Promise((function(e,t){ad(n,l,(function(n,r){n?t(n):r&&e(r)}),s,u)})));case 3:case"end":return i.stop()}}),o)})))}(e,t,o,n);case Wh.CUSTOMARRAYBUFFER:case Wh.CUSTOMRGB:return function(e,t,n,r){return Yh(void 0,null,i().mark((function o(){return i().wrap((function(i){for(;;)switch(i.prev=i.next){case 0:return i.abrupt("return",new Promise((function(i,o){t({x:e.x,y:e.y,z:e.z},(function(e,t){e||0===t.length?o(e):t&&Du([{data:t,bands:[0]}],n,r,(function(e,t){e?o(e):t&&i(t)}))}))})));case 1:case"end":return i.stop()}}),o)})))}(o,null==n?void 0:n.getCustomData,(null==n?void 0:n.format)||yd,null==n?void 0:n.operation);default:return _d(e,t,o,n)}}},bd(o,Ad(a)));return{data:e,dataArray:[],tilesetOptions:s,isTile:!0}})),Le("mvt",(function(e,t){var n=Array.isArray(e)?e[0]:e,r=mu(vu(vu({},gu),t),{getTileData:function(e,r){return _u(n,e,r,null==t?void 0:t.requestParameters,null==t?void 0:t.getCustomData)}});return{data:n,dataArray:[],tilesetOptions:r,isTile:!0}})),Le("geojsonvt",(function(e,t){var n,r=function(e){var t={maxZoom:14,indexMaxZoom:5,indexMaxPoints:1e5,tolerance:3,extent:4096,buffer:64,lineMetrics:!1,promoteId:null,generateId:!0,debug:0};return void 0===e||void 0===e.geojsonvtOptions?t:Ha(Ha({},t),e.geojsonvtOptions)}(t),i=r.extent||4096,o=function(e,t){return new Ia(e,t)}(e,r);return{data:e,dataArray:[],tilesetOptions:(n=Ha(Ha({},Xa),t),Ba(n,Ua({getTileData:function(e,t){return qa(t,o,e,i)}}))),isTile:!0}})),Le("testTile",(function(e,t){var n;return{data:e,dataArray:[],tilesetOptions:(n=sp(sp({},up),t),tp(n,np({getTileData:function(e){return cp(e)}}))),isTile:!0}})),Le("geojson",(function(e,t){var n=[],r={};return e.features?(e.features=e.features.filter((function(e){var t=e.geometry;return null!=e&&t&&t.type&&t.coordinates&&t.coordinates.length>0})),0===(e=Ho(e)).features.length?{dataArray:[],featureKeys:r}:(We(e,(function(e,r){var i=function(e,t){return void 0===t?null:"number"==typeof(1*e.properties[t])?1*e.properties[t]:e.properties&&e.properties[t]?function(e){for(var t=e.toString(),n=5381,r=t.length;r;)n=33*n^t.charCodeAt(--r);return n>>>0}(e.properties[t]+"")%1000019:null}(e,null==t?void 0:t.featureId);null===i&&(i=r);var o,a=i,s=Ve(e),u=(o=function(e,t){for(var n in t||(t={}))aa.call(t,n)&&ua(e,n,t[n]);if(oa){var r,i=y(oa(t));try{for(i.s();!(r=i.n()).done;)n=r.value,sa.call(t,n)&&ua(e,n,t[n])}catch(o){i.e(o)}finally{i.f()}}return e}({},e.properties),ra(o,ia({coordinates:s,_id:a})));n.push(u)})),{dataArray:n,featureKeys:r})):(e.features=[],{dataArray:[]})})),Le("jsonTile",(function(e,t){return{dataArray:[],tilesetOptions:ps(ds({},t),{getTileData:function(n,r){return vs(e,r,null==t?void 0:t.requestParameters,t.getCustomData)}}),isTile:!0}})),Le("image",os),Le("csv",(function(e,t){return ta(Ue(e),t)})),Le("json",ta),Le("raster",(function(e,t){var n,r,i,o=t.extent,a=void 0===o?[121.168,30.2828,121.384,30.4219]:o,s=t.coordinates,u=t.width,c=t.height,l=t.min,f=t.max,h=t.format,d=t.operation;return void 0===h||Vo(e)?(n=Array.from(e),r=u,i=c):n=Iu(Array.isArray(e)?e:[e],h,d),{_id:1,dataArray:[{_id:1,data:n,width:r,height:i,min:l,max:f,coordinates:Xo(s,a)}]}})),Le("rasterRgb",(function(e,t){var n,r=t,i=r.extent,o=r.coordinates,a=r.min,s=r.max,u=r.width,c=r.height,l=r.format,f=r.operation,h=function(e,t){var n={};for(var r in e)Kd.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&qd){var i,o=y(qd(e));try{for(o.s();!(i=o.n()).done;)r=i.value,t.indexOf(r)<0&&Qd.call(e,r)&&(n[r]=e[r])}catch(a){o.e(a)}finally{o.f()}}return n}(r,["extent","coordinates","min","max","width","height","format","operation"]);n=void 0===l||Vo(e)?Array.from(e):Iu(Array.isArray(e)?e:[e],l,f);var d,p,v=Xo(o,i);return{_id:1,dataArray:[(d=Jd({_id:1,data:n,width:u,height:c},h),p={min:a,max:s,coordinates:v},Yd(d,Zd(p)))]}})),Le("rgb",(function(e,t){var n=t,r=n.extent,i=n.coordinates,o=n.width,s=n.height,u=function(e,t){var n={};for(var r in e)zd.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&Gd){var i,o=y(Gd(e));try{for(o.s();!(i=o.n()).done;)r=i.value,t.indexOf(r)<0&&jd.call(e,r)&&(n[r]=e[r])}catch(a){o.e(a)}finally{o.f()}}return n}(n,["extent","coordinates","width","height"]);e.length<3&&console.warn("RGB解析需要三个波段的数据");for(var c=a(u.bands||[0,1,2],3),l=c[0],f=c[1],h=c[2],d=[e[l],e[f],e[h]],p=[],v=a((null==u?void 0:u.countCut)||[2,98],2),m=v[0],g=v[1],_=(null==u?void 0:u.RMinMax)||xu(d[0],m,g),E=(null==u?void 0:u.GMinMax)||xu(d[1],m,g),b=(null==u?void 0:u.BMinMax)||xu(d[2],m,g),A=0;A<d[0].length;A++)p.push(Math.max(0,d[0][A]-_[0])),p.push(Math.max(0,d[1][A]-E[0])),p.push(Math.max(0,d[2][A]-b[0]));var x=Xo(i,r);return{_id:1,dataArray:[Xd(Hd({_id:1,data:p,width:o,height:s,rMinMax:_,gMinMax:E,bMinMax:b},u),{coordinates:x})]}})),Le("ndi",(function(e,t){var n=t,r=n.extent,i=void 0===r?[121.168,30.2828,121.384,30.4219]:r,o=n.coordinates,s=n.width,u=n.height,c=function(e,t){var n={};for(var r in e)Nd.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&kd){var i,o=y(kd(e));try{for(o.s();!(i=o.n()).done;)r=i.value,t.indexOf(r)<0&&Id.call(e,r)&&(n[r]=e[r])}catch(a){o.e(a)}finally{o.f()}}return n}(n,["extent","coordinates","width","height"]);e.length<2&&console.warn("RGB解析需要2个波段的数据");for(var l=a(c.bands||[0,1],2),f=l[0],h=l[1],d=[e[f],e[h]],p=[],v=0;v<d[0].length;v++)p.push((d[1][v]-d[0][v])/(d[1][v]+d[0][v]));var m,g,_=Xo(o,i);return{_id:1,dataArray:[(m=Dd({_id:1,data:p,width:s,height:u},c),g={coordinates:_},Ld(m,Od(g)))]}})),Oe("cluster",_p),Oe("filter",(function(e,t){var n=t.callback;return n&&(e.dataArray=e.dataArray.filter(n)),e})),Oe("join",(function(e,t){var n=t.sourceField,r=t.targetField,i=t.data,o={};return i.forEach((function(e){o[e[n]]=e})),e.dataArray=e.dataArray.map((function(e){var t=e[r];return Qp(Qp({},e),o[t])})),e})),Oe("map",(function(e,t){var n=t.callback;return n&&(e.dataArray=e.dataArray.map(n)),e})),Oe("grid",(function(e,t){var n=e.dataArray,r=t.size,i=void 0===r?10:r,o=i/(2*Math.PI*Ip)*(256<<20)/2,a=function(e,t){var n,r,i=1/0,o=-1/0,a=y(e);try{for(a.s();!(r=a.n()).done;){n=r.value.coordinates[1],Number.isFinite(n)&&(i=n<i?n:i,o=n>o?n:o)}}catch(g){a.e(g)}finally{a.f()}var s=function(e,t){var n=(i=e,i/Ip*(180/Math.PI)),r=function(e,t){return t/Ip*(180/Math.PI)/Math.cos(e*Math.PI/180)}(t,e);var i;return{yOffset:n,xOffset:r}}(t,(i+o)/2);if(s.xOffset<=0||s.yOffset<=0)return{gridHash:{},gridOffset:s};var u,c={},l=y(e);try{for(l.s();!(u=l.n()).done;){var f=u.value,h=f.coordinates[1],d=f.coordinates[0];if(Number.isFinite(h)&&Number.isFinite(d)){var p=Math.floor((h+90)/s.yOffset),v=Math.floor((d+180)/s.xOffset),m="".concat(p,"-").concat(v);c[m]=c[m]||{count:0,points:[]},c[m].count+=1,c[m].points.push(f)}}}catch(g){l.e(g)}finally{l.f()}return{gridHash:c,gridOffset:s}}(n,i),s=function(e,t,n){return Object.keys(e).reduce((function(r,i,o){var a=i.split("-"),s=parseInt(a[0],10),u=parseInt(a[1],10),c={};if(n.field&&n.method){var l=uo(e[i].points,n.field);c[n.method]=so[n.method](l)}return Object.assign(c,{_id:o,coordinates:Qi([t.xOffset*(u+.5)-180,t.yOffset*(s+.5)-90]),rawData:e[i].points,count:e[i].count}),r.push(c),r}),[])}(a.gridHash,a.gridOffset,t);return{yOffset:o,xOffset:o,radius:o,type:"grid",dataArray:s}})),Oe("hexagon",(function(e,t){var n=e.dataArray,r=t.size,i=void 0===r?10:r,s=t.method,u=void 0===s?"sum":s,c=i/(2*Math.PI*6378e3)*(256<<20)/2,l=n.map((function(e){var t,n=a(Qi(e.coordinates),2),r=n[0],i=n[1];return t=function(e,t){for(var n in t||(t={}))Vp.call(t,n)&&Xp(e,n,t[n]);if(jp){var r,i=y(jp(t));try{for(i.s();!(r=i.n()).done;)n=r.value,Hp.call(t,n)&&Xp(e,n,t[n])}catch(o){i.e(o)}finally{i.f()}}return e}({},e),Gp(t,zp({coordinates:[r,i]}))})),f=function(){var e,t,n,r=0,i=0,o=1,a=1,s=Fp,u=Bp;function c(e){var r,i={},o=[],a=e.length;for(r=0;r<a;++r)if(!isNaN(l=+s.call(null,c=e[r],r,e))&&!isNaN(f=+u.call(null,c,r,e))){var c,l,f,h=Math.round(f/=n),d=Math.round(l=l/t-(1&h)/2),p=f-h;if(3*Math.abs(p)>1){var v=l-d,m=d+(l<d?-1:1)/2,g=h+(f<h?-1:1),_=l-m,y=f-g;v*v+p*p>_*_+y*y&&(d=m+(1&h?1:-1)/2,h=g)}var E=d+"-"+h,b=i[E];b?b.push(c):(o.push(b=i[E]=[c]),b.x=(d+(1&h)/2)*t,b.y=h*n)}return o}function l(e){var t=0,n=0;return Dp.map((function(r){var i=Math.sin(r)*e,o=-Math.cos(r)*e,a=i-t,s=o-n;return t=i,n=o,[a,s]}))}return c.hexagon=function(t){return"m"+l(null==t?e:+t).join("l")+"z"},c.centers=function(){for(var s=[],u=Math.round(i/n),c=Math.round(r/t),l=u*n;l<a+e;l+=n,++u)for(var f=c*t+(1&u)*t/2;f<o+t/2;f+=t)s.push([f,l]);return s},c.mesh=function(){var t=l(e).slice(0,4).join("l");return c.centers().map((function(e){return"M"+e+"m"+t})).join("")},c.x=function(e){return arguments.length?(s=e,c):s},c.y=function(e){return arguments.length?(u=e,c):u},c.radius=function(r){return arguments.length?(t=2*(e=+r)*Math.sin(Pp),n=1.5*e,c):e},c.size=function(e){return arguments.length?(r=i=0,o=+e[0],a=+e[1],c):[o-r,a-i]},c.extent=function(e){return arguments.length?(r=+e[0][0],i=+e[0][1],o=+e[1][0],a=+e[1][1],c):[[r,i],[o,a]]},c.radius(1)}().radius(c).x((function(e){return e.coordinates[0]})).y((function(e){return e.coordinates[1]})),h={dataArray:f(l).map((function(e,n){if(t.field&&u){var r=uo(e,t.field);e[u]=so[u](r)}return o(o(o(o(o({},t.method,e[u]),"count",e.length),"rawData",e),"coordinates",[e.x,e.y]),"_id",n)})),radius:c,xOffset:c,yOffset:c,type:"hexagon"};return h}));var $p=Np;window._iconfont_svg_string_3580659='<svg><symbol id="l7-icon-area1" viewBox="0 0 1024 1024"><path d="M796.444444 56.888889a113.777778 113.777778 0 0 1 43.064889 219.136l38.798223 466.261333a113.777778 113.777778 0 1 1-133.518223 145.237334H279.210667a113.777778 113.777778 0 1 1-60.302223-137.272889L697.856 227.555556A113.777778 113.777778 0 0 1 796.444444 56.888889z m56.888889 750.933333a45.511111 45.511111 0 1 0 0 91.022222 45.511111 45.511111 0 0 0 0-91.022222z m-682.666666 0a45.511111 45.511111 0 1 0 0 91.022222 45.511111 45.511111 0 0 0 0-91.022222z m577.592889-534.072889L269.198222 796.444444c4.152889 7.168 7.509333 14.791111 10.012445 22.812445h465.578666a114.119111 114.119111 0 0 1 65.479111-71.224889l-38.798222-466.261333a112.924444 112.924444 0 0 1-23.210666-7.964445zM796.444444 125.155556a45.511111 45.511111 0 1 0 0 91.022222 45.511111 45.511111 0 0 0 0-91.022222z"  ></path></symbol><symbol id="l7-icon-area" viewBox="0 0 1024 1024"><path d="M796.444444 56.888889a113.777778 113.777778 0 0 1 43.008 219.136l38.855112 466.261333a113.777778 113.777778 0 0 1-16.497778 224.540445L853.333333 967.111111a113.777778 113.777778 0 0 1-108.544-79.644444H279.210667a113.834667 113.834667 0 0 1-100.067556 79.36L170.666667 967.111111a113.777778 113.777778 0 0 1-17.066667-226.304l30.492444-351.175111a113.777778 113.777778 0 0 1 34.986667-218.680889L227.555556 170.666667a113.777778 113.777778 0 0 1 99.896888 59.221333l355.84-71.395556a113.777778 113.777778 0 0 1 104.675556-101.262222L796.444444 56.888889z m56.888889 750.933333a45.511111 45.511111 0 1 0 0 91.022222 45.511111 45.511111 0 0 0 0-91.022222z m-682.666666 0a45.511111 45.511111 0 1 0 0 91.022222 45.511111 45.511111 0 0 0 0-91.022222z m526.051555-582.314666L340.650667 296.903111a113.891556 113.891556 0 0 1-88.462223 98.645333l-30.947555 355.84c27.477333 13.653333 48.64 38.115556 58.026667 67.754667h465.521777a114.119111 114.119111 0 0 1 65.536-71.168l-38.855111-466.261333a113.948444 113.948444 0 0 1-74.752-56.206222zM227.555556 238.933333a45.511111 45.511111 0 1 0 0 91.022223 45.511111 45.511111 0 0 0 0-91.022223z m568.888888-113.777777a45.511111 45.511111 0 1 0 0 91.022222 45.511111 45.511111 0 0 0 0-91.022222z"  ></path></symbol><symbol id="l7-icon-delete" viewBox="0 0 1024 1024"><path d="M705.422222 85.333333a34.133333 34.133333 0 0 1 34.133334 34.133334V227.555556h136.533333a34.133333 34.133333 0 0 1 0 68.266666h-25.543111l-24.348445 610.076445a34.133333 34.133333 0 0 1-34.133333 32.768H231.936a34.133333 34.133333 0 0 1-34.076444-32.768L173.340444 295.822222H147.911111a34.133333 34.133333 0 1 1 0-68.266666H284.444444V119.466667a34.133333 34.133333 0 0 1 34.133334-34.133334h386.844444zM241.720889 295.822222l22.983111 574.577778h494.535111l23.04-574.577778H241.720889zM671.288889 153.6H352.711111V227.555556h318.577778V153.6z"  ></path></symbol><symbol id="l7-icon-color" viewBox="0 0 1024 1024"><path d="M512 56.888889c9.841778 0 19.626667 0.341333 29.354667 0.910222 69.176889 4.437333 119.068444 62.577778 124.302222 131.072l0.455111 9.386667c0.739556 44.600889 15.303111 84.935111 44.999111 114.631111 27.022222 27.022222 62.805333 41.528889 102.570667 44.430222l12.060444 0.568889c72.476444 1.194667 135.793778 52.451556 140.458667 124.757333 1.137778 18.261333 1.251556 36.807111 0.170667 55.637334-13.198222 233.585778-211.399111 424.220444-445.326223 428.714666L512 967.111111a455.111111 455.111111 0 0 1-455.054222-464.156444c4.551111-233.927111 195.185778-432.128 428.771555-445.326223C494.535111 57.116444 503.296 56.888889 512 56.888889z m0 68.266667a385.706667 385.706667 0 0 0-22.414222 0.625777C291.726222 136.988444 129.080889 305.948444 125.155556 504.263111c-4.152889 212.366222 163.100444 387.185778 372.508444 394.353778l13.425778 0.227555 8.533333-0.113777c198.371556-3.811556 367.331556-166.456889 378.538667-364.373334a396.174222 396.174222 0 0 0-0.170667-47.331555c-1.991111-31.232-29.127111-56.604444-67.128889-60.472889l-8.248889-0.455111-14.051555-0.682667c-56.547556-4.209778-107.406222-25.884444-145.806222-64.284444-38.855111-38.798222-60.416-90.225778-64.284445-145.749334l-0.910222-21.333333c-2.901333-38.001778-28.785778-66.048-60.302222-68.096A433.891556 433.891556 0 0 0 512 125.155556zM438.044444 682.666667a68.266667 68.266667 0 1 1 0 136.533333 68.266667 68.266667 0 0 1 0-136.533333z m-170.666666-227.555556a68.266667 68.266667 0 1 1 0 136.533333 68.266667 68.266667 0 0 1 0-136.533333z m142.222222-227.555555a68.266667 68.266667 0 1 1 0 136.533333 68.266667 68.266667 0 0 1 0-136.533333z"  ></path></symbol><symbol id="l7-icon-base-map" viewBox="0 0 1024 1024"><path d="M923.761778 115.029333A34.133333 34.133333 0 0 1 967.111111 147.911111v624.128a34.133333 34.133333 0 0 1-22.186667 32.028445l-278.755555 103.992888a34.133333 34.133333 0 0 1-23.665778 0.056889L381.724444 812.714667a34.133333 34.133333 0 0 0-23.665777 0.113777L102.968889 908.060444a34.133333 34.133333 0 0 1-45.738667-26.965333L56.888889 876.088889V251.960889a34.133333 34.133333 0 0 1 22.186667-32.028445l278.755555-103.992888a34.133333 34.133333 0 0 1 20.992-0.967112l266.183111 72.988445a34.133333 34.133333 0 0 0 18.204445 0zM403.911111 192.625778v555.576889l216.177778 79.075555V251.960889l-216.177778-59.335111z m-68.266667 4.380444L125.155556 275.569778v551.310222l210.432-78.506667V197.006222zM898.844444 192.853333l-210.545777 58.936889v575.089778l210.545777-78.563556V192.853333z"  ></path></symbol><symbol id="l7-icon-dot" viewBox="0 0 1024 1024"><path d="M341.333333 739.555556a113.777778 113.777778 0 0 1 8.533334 227.271111L341.333333 967.111111a113.777778 113.777778 0 0 1-8.533333-227.271111L341.333333 739.555556z m0 68.266666a45.511111 45.511111 0 1 0 0 91.022222 45.511111 45.511111 0 0 0 0-91.022222zM910.222222 341.333333a113.777778 113.777778 0 0 1 8.533334 227.271111L910.222222 568.888889a113.777778 113.777778 0 0 1-8.533333-227.271111L910.222222 341.333333z m0 68.266667a45.511111 45.511111 0 1 0 0 91.022222 45.511111 45.511111 0 0 0 0-91.022222zM227.555556 56.888889a113.777778 113.777778 0 0 1 8.533333 227.271111L227.555556 284.444444a113.777778 113.777778 0 0 1-8.533334-227.271111L227.555556 56.888889z m0 68.266667a45.511111 45.511111 0 1 0 0 91.022222 45.511111 45.511111 0 0 0 0-91.022222z"  ></path></symbol><symbol id="l7-icon-display" viewBox="0 0 1024 1024"><path d="M512 170.666667c284.444444 0 455.111111 227.555556 455.111111 341.333333s-170.666667 341.333333-455.111111 341.333333-455.111111-227.555556-455.111111-341.333333 170.666667-341.333333 455.111111-341.333333z m0 68.266666C303.729778 238.933333 125.155556 401.237333 125.155556 512c0 110.762667 178.574222 273.066667 386.844444 273.066667s386.844444-162.304 386.844444-273.066667c0-110.762667-178.574222-273.066667-386.844444-273.066667zM512 341.333333a170.666667 170.666667 0 1 1 0 341.333334 170.666667 170.666667 0 0 1 0-341.333334z m0 68.266667a102.4 102.4 0 1 0 0 204.8 102.4 102.4 0 0 0 0-204.8z"  ></path></symbol><symbol id="l7-icon-enlarge" viewBox="0 0 1024 1024"><path d="M546.133333 147.911111l-0.056889 329.955556H876.088889a34.133333 34.133333 0 0 1 0 68.266666H546.076444v329.955556a34.133333 34.133333 0 0 1-68.266666 0V546.133333H147.911111a34.133333 34.133333 0 1 1 0-68.266666h329.898667V147.911111a34.133333 34.133333 0 0 1 68.266666 0z"  ></path></symbol><symbol id="l7-icon-export-picture" viewBox="0 0 1024 1024"><path d="M883.873684 161.684211a32.336842 32.336842 0 0 1 32.336842 32.336842v582.063158a32.336842 32.336842 0 0 1-32.336842 32.336842H86.231579a32.336842 32.336842 0 0 1-32.336842-32.336842V194.021053a32.336842 32.336842 0 0 1 32.336842-32.336842h797.642105z m-32.336842 64.673684H118.568421v517.389473h170.792421a32.175158 32.175158 0 0 1 0.431158-0.646736l3.772632-4.473264 330.320842-330.374736a32.336842 32.336842 0 0 1 38.588631-5.389474l4.473263 3.018105 184.589474 147.725474V226.357895z m-202.428631 248.131368L379.850105 743.747368H851.536842v-107.304421l-202.428631-161.953684zM323.368421 323.368421a107.789474 107.789474 0 1 1 0 215.578947 107.789474 107.789474 0 0 1 0-215.578947z m0 64.673684a43.115789 43.115789 0 1 0 0 86.231579 43.115789 43.115789 0 0 0 0-86.231579z"  ></path></symbol><symbol id="l7-icon-exit-fullscreen" viewBox="0 0 1024 1024"><path d="M841.955556 591.644444a34.133333 34.133333 0 0 1 5.518222 67.811556l-5.518222 0.455111h-133.745778l192 192.056889a34.133333 34.133333 0 0 1-38.343111 55.182222l-5.176889-2.958222-4.721778-3.982222L659.911111 708.266667V841.955556a34.133333 34.133333 0 0 1-28.615111 33.678222L625.777778 876.088889a34.133333 34.133333 0 0 1-33.678222-28.615111L591.644444 841.955556V625.777778a34.133333 34.133333 0 0 1 28.615112-33.678222L625.777778 591.644444h216.177778z m-443.733334 0a34.133333 34.133333 0 0 1 33.678222 28.615112L432.355556 625.777778v216.177778a34.133333 34.133333 0 0 1-67.811556 5.518222L364.088889 841.955556v-133.745778l-192.056889 192a34.133333 34.133333 0 0 1-52.224-43.52l3.982222-4.721778L315.847111 659.911111H182.044444a34.133333 34.133333 0 0 1-33.678222-28.615111L147.911111 625.777778a34.133333 34.133333 0 0 1 28.615111-33.678222L182.044444 591.644444H398.222222zM167.310222 119.808l4.721778 3.982222L364.088889 315.847111V182.044444a34.133333 34.133333 0 0 1 28.615111-33.678222L398.222222 147.911111a34.133333 34.133333 0 0 1 33.678222 28.615111L432.355556 182.044444V398.222222a34.133333 34.133333 0 0 1-28.615112 33.678222L398.222222 432.355556H182.044444a34.133333 34.133333 0 0 1-5.518222-67.811556L182.044444 364.088889h133.802667L123.790222 172.032a34.133333 34.133333 0 0 1 43.52-52.224z m732.899556 3.982222a34.133333 34.133333 0 0 1 3.982222 43.52l-3.982222 4.721778L708.266667 364.088889H841.955556a34.133333 34.133333 0 0 1 33.678222 28.615111L876.088889 398.222222a34.133333 34.133333 0 0 1-28.615111 33.678222L841.955556 432.355556H625.777778a34.133333 34.133333 0 0 1-33.678222-28.615112L591.644444 398.222222V182.044444a34.133333 34.133333 0 0 1 67.811556-5.518222l0.455111 5.518222v133.802667l192.056889-192.056889a34.133333 34.133333 0 0 1 48.241778 0z"  ></path></symbol><symbol id="l7-icon-line" viewBox="0 0 1024 1024"><path d="M853.333333 56.888889a113.777778 113.777778 0 0 1 8.533334 227.271111L853.333333 284.444444c-19.000889 0-36.864-4.664889-52.622222-12.856888l-529.123555 529.066666a113.777778 113.777778 0 0 1-92.387556 166.115556L170.666667 967.111111a113.777778 113.777778 0 0 1-8.533334-227.271111L170.666667 739.555556c19.000889 0 36.864 4.664889 52.622222 12.856888l529.123555-529.066666a113.777778 113.777778 0 0 1 92.387556-166.115556L853.333333 56.888889zM170.666667 807.822222a45.511111 45.511111 0 1 0 0 91.022222 45.511111 45.511111 0 0 0 0-91.022222z m682.666666-682.666666a45.511111 45.511111 0 1 0 0 91.022222 45.511111 45.511111 0 0 0 0-91.022222z"  ></path></symbol><symbol id="l7-icon-layer" viewBox="0 0 1024 1024"><path d="M767.089778 625.777778l180.167111 82.773333a34.133333 34.133333 0 0 1 4.892444 59.278222l-4.892444 2.730667-420.977778 193.422222a34.133333 34.133333 0 0 1-22.983111 1.991111l-5.575111-1.991111-420.977778-193.422222a34.133333 34.133333 0 0 1-4.892444-59.278222l4.892444-2.730667L256.853333 625.777778l81.749334 37.546666L172.771556 739.555556 512 895.374222 851.171556 739.555556l-165.831112-76.231112 81.749334-37.546666z m0-227.555556l180.167111 82.773334a34.133333 34.133333 0 0 1 4.892444 59.278222l-4.892444 2.730666-420.977778 193.422223a34.133333 34.133333 0 0 1-22.983111 1.991111l-5.575111-1.991111-420.977778-193.422223a34.133333 34.133333 0 0 1-4.892444-59.278222l4.892444-2.730666L256.853333 398.222222l81.749334 37.546667-165.831111 76.174222L512 667.818667l339.171556-155.875556-165.831112-76.174222L767.089778 398.222222zM497.720889 60.017778a34.133333 34.133333 0 0 1 28.558222 0l420.977778 193.422222a34.133333 34.133333 0 0 1 0 62.008889l-420.977778 193.422222a34.133333 34.133333 0 0 1-28.558222 0l-420.977778-193.422222a34.133333 34.133333 0 0 1 0-62.008889zM512 128.568889L172.771556 284.387556 512 440.263111l339.171556-155.875555L512 128.568889z"  ></path></symbol><symbol id="l7-icon-narrow" viewBox="0 0 1024 1024"><path d="M910.222222 512a34.133333 34.133333 0 0 1-34.133333 34.133333H147.911111a34.133333 34.133333 0 1 1 0-68.266666h728.177778a34.133333 34.133333 0 0 1 34.133333 34.133333z"  ></path></symbol><symbol id="l7-icon-fullscreen" viewBox="0 0 1024 1024"><path d="M645.176889 597.674667l4.721778 3.982222L841.955556 793.6l0.056888-133.688889a34.133333 34.133333 0 0 1 28.615112-33.678222L876.088889 625.777778a34.133333 34.133333 0 0 1 33.678222 28.615111L910.222222 659.911111v216.177778a34.133333 34.133333 0 0 1-28.615111 33.678222L876.088889 910.222222h-216.177778a34.133333 34.133333 0 0 1-5.518222-67.811555l5.518222-0.455111h133.745778l-192-192.056889a34.133333 34.133333 0 0 1 43.52-52.224z m-222.833778 3.982222a34.133333 34.133333 0 0 1 3.982222 43.52l-3.982222 4.721778L230.286222 841.955556H364.088889a34.133333 34.133333 0 0 1 33.678222 28.615111L398.222222 876.088889a34.133333 34.133333 0 0 1-28.615111 33.678222L364.088889 910.222222H147.911111a34.133333 34.133333 0 0 1-33.678222-28.615111L113.777778 876.088889v-216.177778a34.133333 34.133333 0 0 1 67.811555-5.518222l0.455111 5.518222-0.056888 133.745778 192.113777-192a34.133333 34.133333 0 0 1 48.241778 0zM364.088889 113.777778a34.133333 34.133333 0 0 1 5.518222 67.811555L364.088889 182.044444H230.343111l192 192.056889a34.133333 34.133333 0 0 1-43.52 52.224l-4.721778-3.982222-192.113777-192.056889L182.044444 364.088889a34.133333 34.133333 0 0 1-28.615111 33.678222L147.911111 398.222222a34.133333 34.133333 0 0 1-33.678222-28.615111L113.777778 364.088889V147.911111a34.133333 34.133333 0 0 1 28.615111-33.678222L147.911111 113.777778h216.177778z m512 0a34.133333 34.133333 0 0 1 33.678222 28.615111L910.222222 147.911111v216.177778a34.133333 34.133333 0 0 1-67.811555 5.518222L841.955556 364.088889l-0.056889-133.745778-192 192a34.133333 34.133333 0 0 1-52.224-43.52l3.982222-4.721778L793.6 182.044444H659.911111a34.133333 34.133333 0 0 1-33.678222-28.615111L625.777778 147.911111a34.133333 34.133333 0 0 1 28.615111-33.678222L659.911111 113.777778h216.177778z"  ></path></symbol><symbol id="l7-icon-hide" viewBox="0 0 1024 1024"><path d="M875.52 87.836444a34.133333 34.133333 0 0 1 7.281778 43.121778l-3.527111 5.006222-682.666667 796.444445a34.133333 34.133333 0 0 1-55.409778-39.367111l3.527111-5.006222 97.166223-113.379556C123.164444 697.969778 56.888889 582.940444 56.888889 512c0-113.777778 170.666667-341.333333 455.111111-341.333333a496.64 496.64 0 0 1 208.952889 45.112889l106.439111-124.188445a34.133333 34.133333 0 0 1 48.128-3.754667z m-38.684444 202.524445C921.031111 362.951111 967.111111 452.835556 967.111111 512c0 113.777778-170.666667 341.333333-455.111111 341.333333-50.631111 0-97.678222-7.224889-140.8-19.740444l50.232889-58.595556A417.393778 417.393778 0 0 0 512 785.066667c208.270222 0 386.844444-162.304 386.844444-273.066667 0-52.849778-40.675556-117.418667-105.813333-170.496l43.804445-51.2zM512 238.933333C303.729778 238.933333 125.155556 401.237333 125.155556 512c0 66.787556 64.853333 152.291556 162.133333 209.692444L377.173333 616.675556a170.666667 170.666667 0 0 1 217.713778-253.895112l78.620445-91.704888A432.924444 432.924444 0 0 0 512 238.933333z m166.684444 236.088889a170.666667 170.666667 0 0 1-177.664 207.303111l177.607112-207.303111zM512 409.6a102.4 102.4 0 0 0-88.746667 153.486222L548.864 416.426667A102.172444 102.172444 0 0 0 512 409.6z"  ></path></symbol><symbol id="l7-icon-rectangle" viewBox="0 0 1024 1024"><path d="M170.666667 56.888889a113.777778 113.777778 0 0 1 108.544 79.644444H853.333333a34.133333 34.133333 0 0 1 33.678223 28.615111L887.466667 170.666667v574.122666a113.777778 113.777778 0 1 1-142.677334 142.734223L170.666667 887.466667a34.133333 34.133333 0 0 1-33.678223-28.615111L136.533333 853.333333V279.210667A113.777778 113.777778 0 0 1 170.666667 56.888889z m682.666666 750.933333a45.511111 45.511111 0 1 0 0 91.022222 45.511111 45.511111 0 0 0 0-91.022222z m-34.133333-603.022222H279.210667a114.062222 114.062222 0 0 1-74.353778 74.410667L204.8 819.2h539.989333a114.062222 114.062222 0 0 1 74.410667-74.410667V204.8zM170.666667 125.155556a45.511111 45.511111 0 1 0 0 91.022222 45.511111 45.511111 0 0 0 0-91.022222z"  ></path></symbol><symbol id="l7-icon-ranging" viewBox="0 0 1024 1024"><path d="M723.171556 50.403556l250.424888 250.424888a31.061333 31.061333 0 0 1 0 43.918223L344.746667 973.596444a31.061333 31.061333 0 0 1-43.918223 0L50.403556 723.171556a31.061333 31.061333 0 0 1 0-43.918223L679.253333 50.403556a31.061333 31.061333 0 0 1 43.918223 0z m-21.959112 74.524444l-39.765333 39.822222 98.986667 98.872889a34.133333 34.133333 0 0 1-44.088889 51.882667l-4.209778-3.640889-98.929778-98.929778-63.886222 63.886222 62.179556 62.122667a34.133333 34.133333 0 0 1-44.088889 51.882667L563.2 387.242667 501.077333 325.063111 437.191111 388.949333l98.986667 98.929778a34.133333 34.133333 0 0 1-44.088889 51.882667l-4.209778-3.640889-98.929778-98.929778-63.886222 63.886222L387.242667 563.2a34.133333 34.133333 0 0 1-44.088889 51.882667l-4.209778-3.584-62.122667-62.179556-63.886222 63.886222 98.986667 98.929778a34.133333 34.133333 0 0 1-44.088889 51.882667l-4.209778-3.640889-98.929778-98.929778-39.765333 39.822222 197.802667 197.745778 576.284444-576.284444-197.802667-197.745778z"  ></path></symbol><symbol id="l7-icon-reposition" viewBox="0 0 1024 1024"><path d="M512 56.888889a34.133333 34.133333 0 0 1 34.133333 34.133333v24.177778A398.336 398.336 0 0 1 908.856889 477.866667h24.177778a34.133333 34.133333 0 0 1 0 68.266666h-24.177778A398.336 398.336 0 0 1 546.133333 908.856889L546.133333 932.977778a34.133333 34.133333 0 0 1-68.266666 0v-24.177778A398.336 398.336 0 0 1 115.2 546.133333L91.022222 546.133333a34.133333 34.133333 0 1 1 0-68.266666h24.177778A398.336 398.336 0 0 1 477.866667 115.2V91.022222A34.133333 34.133333 0 0 1 512 56.888889z m34.190222 126.862222L546.133333 193.422222a34.133333 34.133333 0 1 1-68.266666 0v-9.671111A330.069333 330.069333 0 0 0 183.751111 477.866667h9.671111a34.133333 34.133333 0 1 1 0 68.266666l-9.671111 0.056889A330.069333 330.069333 0 0 0 477.866667 840.248889V830.577778a34.133333 34.133333 0 0 1 68.266666 0l0.056889 9.671111A330.069333 330.069333 0 0 0 840.248889 546.133333L830.577778 546.133333a34.133333 34.133333 0 0 1 0-68.266666h9.671111A330.069333 330.069333 0 0 0 546.133333 183.751111zM512 341.333333a170.666667 170.666667 0 1 1 0 341.333334 170.666667 170.666667 0 0 1 0-341.333334z m0 68.266667a102.4 102.4 0 1 0 0 204.8 102.4 102.4 0 0 0 0-204.8z"  ></path></symbol><symbol id="l7-icon-round" viewBox="0 0 1024 1024"><path d="M512 56.888889a455.111111 455.111111 0 0 1 391.395556 687.502222 113.777778 113.777778 0 0 1-159.061334 158.890667A455.111111 455.111111 0 0 1 120.604444 279.608889 113.777778 113.777778 0 0 1 279.608889 120.604444 452.835556 452.835556 0 0 1 512 56.888889z m0 68.266667a384.910222 384.910222 0 0 0-191.715556 50.744888A113.777778 113.777778 0 0 1 175.957333 320.284444a386.844444 386.844444 0 0 0 527.815111 527.758223 113.777778 113.777778 0 0 1 144.270223-144.440889A386.844444 386.844444 0 0 0 512 125.155556z m299.406222 640.739555a45.511111 45.511111 0 1 0 0 91.022222 45.511111 45.511111 0 0 0 0-91.022222zM212.593778 167.082667a45.511111 45.511111 0 1 0 0 91.022222 45.511111 45.511111 0 0 0 0-91.022222z"  ></path></symbol><symbol id="l7-icon-guanbi" viewBox="0 0 1024 1024"><path d="M576 512l277.333333 277.333333-64 64-277.333333-277.333333L234.666667 853.333333 170.666667 789.333333l277.333333-277.333333L170.666667 234.666667 234.666667 170.666667l277.333333 277.333333L789.333333 170.666667 853.333333 234.666667 576 512z"  ></path></symbol></svg>',function(e){try{var t,n=(t=(t=document.getElementsByTagName("script"))[t.length-1]).getAttribute("data-injectcss");if(!(t=t.getAttribute("data-disable-injectsvg"))){var r,i,o,a,s;if(n&&!e.__iconfont__svg__cssinject__){e.__iconfont__svg__cssinject__=!0;try{document.write("<style>.svgfont {display: inline-block;width: 1em;height: 1em;fill: currentColor;vertical-align: -0.1em;font-size:16px;}</style>")}catch(t){console&&console.log(t)}}r=function(){var t,n=document.createElement("div");n.innerHTML=e._iconfont_svg_string_3580659,(n=n.getElementsByTagName("svg")[0])&&(n.setAttribute("aria-hidden","true"),n.style.position="absolute",n.style.width=0,n.style.height=0,n.style.overflow="hidden",(t=document.body).firstChild?function(e,t){t.parentNode.insertBefore(e,t)}(n,t.firstChild):t.appendChild(n))},document.addEventListener?~["complete","loaded","interactive"].indexOf(document.readyState)?setTimeout(r,0):(i=function(){document.removeEventListener("DOMContentLoaded",i,!1),r()},document.addEventListener("DOMContentLoaded",i,!1)):document.attachEvent&&(o=r,a=e.document,s=!1,l(),a.onreadystatechange=function(){"complete"==a.readyState&&(a.onreadystatechange=null,c())})}function c(){s||(s=!0,o())}function l(){try{a.documentElement.doScroll("left")}catch(t){return void setTimeout(l,50)}c()}}catch(u){}}(window);var Jp=function(e){function t(e){var n;return f(this,t),n=h(this,t),ne(n,"controlOption",void 0),ne(n,"container",void 0),ne(n,"isShow",void 0),ne(n,"sceneContainer",void 0),ne(n,"scene",void 0),ne(n,"mapsService",void 0),ne(n,"renderService",void 0),ne(n,"layerService",void 0),ne(n,"controlService",void 0),ne(n,"configService",void 0),t.controlCount++,n.controlOption=re(re({},n.getDefault(e)),e||{}),n}return d(t,e),c(t,[{key:"getOptions",value:function(){return this.controlOption}},{key:"setOptions",value:function(e){var t=this.getDefault(e);Object.entries(e).forEach((function(n){var r=a(n,2),i=r[0];void 0===r[1]&&(e[i]=t[i])})),"position"in e&&this.setPosition(e.position),"className"in e&&this.setClassName(e.className),"style"in e&&this.setStyle(e.style),this.controlOption=re(re({},this.controlOption),e)}},{key:"addTo",value:function(e){this.mapsService=e.mapService,this.renderService=e.rendererService,this.layerService=e.layerService,this.controlService=e.controlService,this.configService=e.globalConfigService,this.scene=e.sceneService,this.sceneContainer=e,this.isShow=!0,this.container=this.onAdd(),Bi(this.container,"l7-control");var t=this.controlOption,n=t.className,r=t.style;return n&&this.setClassName(n),r&&this.setStyle(r),this.insertContainer(),this.emit("add",this),this}},{key:"remove",value:function(){if(!this.mapsService)return this;Fi(this.container),this.onRemove(),this.emit("remove",this)}},{key:"onAdd",value:function(){return Di("div")}},{key:"onRemove",value:function(){}},{key:"show",value:function(){Ui(this.container,"l7-control--hide"),this.isShow=!0,this.emit("show",this)}},{key:"hide",value:function(){Bi(this.container,"l7-control--hide"),this.isShow=!1,this.emit("hide",this)}},{key:"getDefault",value:function(e){return{position:ec.TOPRIGHT,name:"".concat(t.controlCount)}}},{key:"getContainer",value:function(){return this.container}},{key:"getIsShow",value:function(){return this.isShow}},{key:"_refocusOnMap",value:function(e){if(this.mapsService&&e&&e.screenX>0&&e.screenY>0){var t=this.mapsService.getContainer();null!==t&&t.focus()}}},{key:"setPosition",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:ec.TOPLEFT,t=this.controlService;return t&&t.removeControl(this),this.controlOption.position=e,t&&t.addControl(this,this.sceneContainer),this}},{key:"setClassName",value:function(e){var t=this.container,n=this.controlOption.className;n&&Ui(t,n),e&&Bi(t,e)}},{key:"setStyle",value:function(e){var t=this.container;e?t.setAttribute("style",e):t.removeAttribute("style")}},{key:"insertContainer",value:function(){var e=this.controlOption.position,t=this.container;if(e instanceof Element)e.appendChild(t);else{var n=this.controlService.controlCorners[e];["bottomleft","bottomright","righttop","rightbottom"].includes(e)?n.insertBefore(t,n.firstChild):n.appendChild(t)}}},{key:"checkUpdateOption",value:function(e,t){return t.some((function(t){return t in e}))}}])}(fo);ne(Jp,"controlCount",0);var ev=function(e){function t(e,n){var r;return f(this,t),r=h(this,t),ne(r,"popperDOM",void 0),ne(r,"contentDOM",void 0),ne(r,"button",void 0),ne(r,"option",void 0),ne(r,"isShow",!1),ne(r,"content",void 0),ne(r,"timeout",null),ne(r,"show",(function(){return r.isShow||!r.contentDOM.innerHTML||(r.resetPopperPosition(),Ui(r.popperDOM,"l7-popper-hide"),r.isShow=!0,r.option.unique&&t.conflictPopperList.forEach((function(e){e!==r&&e.isShow&&e.hide()})),r.emit("show"),window.addEventListener("pointerdown",r.onPopperUnClick)),r})),ne(r,"hide",(function(){return r.isShow?(Bi(r.popperDOM,"l7-popper-hide"),r.isShow=!1,r.emit("hide"),window.removeEventListener("pointerdown",r.onPopperUnClick),r):r})),ne(r,"setHideTimeout",(function(){r.timeout||(r.timeout=window.setTimeout((function(){r.isShow&&(r.hide(),r.timeout=null)}),300))})),ne(r,"clearHideTimeout",(function(){r.timeout&&(window.clearTimeout(r.timeout),r.timeout=null)})),ne(r,"onBtnClick",(function(){r.isShow?r.hide():r.show()})),ne(r,"onPopperUnClick",(function(e){(function(e,t){for(var n,r=Array.isArray(t)?t:[t],i=e;i instanceof Element&&i!==window.document.body;){if(r.find((function(e){return null==i?void 0:i.matches(e)})))return i;i=null!=(n=null==i?void 0:i.parentElement)?n:null}})(e.target,[".l7-button-control",".l7-popper-content"])||r.hide()})),ne(r,"onBtnMouseLeave",(function(){r.setHideTimeout()})),ne(r,"onBtnMouseMove",(function(){r.clearHideTimeout(),r.isShow||r.show()})),r.button=e,r.option=n,r.init(),n.unique&&t.conflictPopperList.push(r),r}return d(t,e),c(t,[{key:"buttonRect",get:function(){return this.button.getBoundingClientRect()}},{key:"getPopperDOM",value:function(){return this.popperDOM}},{key:"getIsShow",value:function(){return this.isShow}},{key:"getContent",value:function(){return this.content}},{key:"setContent",value:function(e){"string"==typeof e?this.contentDOM.innerHTML=e:e instanceof HTMLElement&&(Vi(this.contentDOM),this.contentDOM.appendChild(e)),this.content=e}},{key:"init",value:function(){var e=this.option.trigger;this.popperDOM=this.createPopper(),"click"===e?this.button.addEventListener("click",this.onBtnClick):(this.button.addEventListener("mousemove",this.onBtnMouseMove),this.button.addEventListener("mouseleave",this.onBtnMouseLeave),this.popperDOM.addEventListener("mousemove",this.onBtnMouseMove),this.popperDOM.addEventListener("mouseleave",this.onBtnMouseLeave))}},{key:"destroy",value:function(){this.button.removeEventListener("click",this.onBtnClick),this.button.removeEventListener("mousemove",this.onBtnMouseMove),this.button.removeEventListener("mousemove",this.onBtnMouseLeave),this.popperDOM.removeEventListener("mousemove",this.onBtnMouseMove),this.popperDOM.removeEventListener("mouseleave",this.onBtnMouseLeave),Fi(this.popperDOM)}},{key:"resetPopperPosition",value:function(){var e,t,n={},r=this.option,i=r.container,o=r.offset,s=void 0===o?[0,0]:o,u=r.placement,c=a(s,2),l=c[0],f=c[1],h=this.button.getBoundingClientRect(),d=i.getBoundingClientRect(),p=(t=d,{left:(e=h).left-t.left,top:e.top-t.top,right:t.left+t.width-e.left-e.width,bottom:t.top+t.height-e.top-e.height}),v=p.left,m=p.right,g=p.top,_=p.bottom,y=!1,E=!1;/^(left|right)/.test(u)?(u.includes("left")?n.right="".concat(h.width+m,"px"):u.includes("right")&&(n.left="".concat(h.width+v,"px")),u.includes("start")?n.top="".concat(g,"px"):u.includes("end")?n.bottom="".concat(_,"px"):(n.top="".concat(g+h.height/2,"px"),E=!0,n.transform="translate(".concat(l,"px, calc(").concat(f,"px - 50%))"))):/^(top|bottom)/.test(u)&&(u.includes("top")?n.bottom="".concat(h.height+_,"px"):u.includes("bottom")&&(n.top="".concat(h.height+g,"px")),u.includes("start")?n.left="".concat(v,"px"):u.includes("end")?n.right="".concat(m,"px"):(n.left="".concat(v+h.width/2,"px"),y=!0,n.transform="translate(calc(".concat(l,"px - 50%), ").concat(f,"px)"))),n.transform="translate(calc(".concat(l,"px - ").concat(y?"50%":"0%","), calc(").concat(f,"px - ").concat(E?"50%":"0%",")");var b,A,x=u.split("-");x.length&&Bi(this.popperDOM,x.map((function(e){return"l7-popper-".concat(e)})).join(" ")),b=this.popperDOM,A=function(e){return Object.entries(e).map((function(e){var t=a(e,2),n=t[0],r=t[1];return"".concat(n,": ").concat(r)})).join(";")}(n),b.setAttribute("style","".concat(b.style.cssText).concat(A))}},{key:"createPopper",value:function(){var e=this.option,t=e.container,n=e.className,r=void 0===n?"":n,i=e.content,o=Di("div","l7-popper l7-popper-hide ".concat(r)),a=Di("div","l7-popper-content"),s=Di("div","l7-popper-arrow");return o.appendChild(a),o.appendChild(s),t.appendChild(o),this.popperDOM=o,this.contentDOM=a,i&&this.setContent(i),o}}])}(lo.exports.EventEmitter);ne(ev,"conflictPopperList",[]);var tv=[["requestFullscreen","exitFullscreen","fullscreenElement","fullscreenEnabled","fullscreenchange","fullscreenerror"],["webkitRequestFullscreen","webkitExitFullscreen","webkitFullscreenElement","webkitFullscreenEnabled","webkitfullscreenchange","webkitfullscreenerror"],["webkitRequestFullScreen","webkitCancelFullScreen","webkitCurrentFullScreenElement","webkitCancelFullScreen","webkitfullscreenchange","webkitfullscreenerror"],["mozRequestFullScreen","mozCancelFullScreen","mozFullScreenElement","mozFullScreenEnabled","mozfullscreenchange","mozfullscreenerror"],["msRequestFullscreen","msExitFullscreen","msFullscreenElement","msFullscreenEnabled","MSFullscreenChange","MSFullscreenError"]],nv=function(){if("undefined"==typeof document)return!1;for(var e=tv[0],t={},n=0,r=tv;n<r.length;n++){var i=r[n];if((null==i?void 0:i[1])in document){var o,s=y(i.entries());try{for(s.s();!(o=s.n()).done;){var u=a(o.value,2),c=u[0],l=u[1];t[e[c]]=l}}catch(f){s.e(f)}finally{s.f()}return t}}return!1}(),rv={change:nv.fullscreenchange,error:nv.fullscreenerror},iv={request:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:document.documentElement,t=arguments.length>1?arguments[1]:void 0;return new Promise((function(n,r){var i=function e(){iv.off("change",e),n()};iv.on("change",i);var o=e[nv.requestFullscreen](t);o instanceof Promise&&o.then(i).catch(r)}))},exit:function(){return new Promise((function(e,t){if(iv.isFullscreen){var n=function t(){iv.off("change",t),e()};iv.on("change",n);var r=document[nv.exitFullscreen]();r instanceof Promise&&r.then(n).catch(t)}else e()}))},toggle:function(e,t){return iv.isFullscreen?iv.exit():iv.request(e,t)},onchange:function(e){iv.on("change",e)},onerror:function(e){iv.on("error",e)},on:function(e,t){var n=rv[e];n&&document.addEventListener(n,t,!1)},off:function(e,t){var n=rv[e];n&&document.removeEventListener(n,t,!1)},raw:nv};Object.defineProperties(iv,{isFullscreen:{get:function(){return Boolean(document[nv.fullscreenElement])}},element:{enumerable:!0,get:function(){var e;return null!==(e=document[nv.fullscreenElement])&&void 0!==e?e:void 0}},isEnabled:{enumerable:!0,get:function(){return Boolean(document[nv.fullscreenEnabled])}}}),nv||(iv={isEnabled:!1});var ov=function(e){function t(){return f(this,t),h(this,t,arguments)}return d(t,e),c(t,[{key:"getDefault",value:function(){return{position:ec.BOTTOMLEFT,name:"logo",href:"https://l7.antv.antgroup.com/",img:"https://gw.alipayobjects.com/mdn/rms_816329/afts/img/A*GRb1TKp4HcMAAAAAAAAAAAAAARQnAQ"}}},{key:"onAdd",value:function(){var e=Di("div","l7-control-logo");return this.setLogoContent(e),e}},{key:"onRemove",value:function(){return null}},{key:"setOptions",value:function(e){n(_(t.prototype),"setOptions",this).call(this,e),this.checkUpdateOption(e,["img","href"])&&(Vi(this.container),this.setLogoContent(this.container))}},{key:"setLogoContent",value:function(e){var t=this.controlOption,n=t.href,r=t.img,i=Di("img");if(i.setAttribute("src",r),i.setAttribute("aria-label","AntV logo"),i.setAttribute("draggable","false"),n){var o=Di("a","l7-control-logo-link");o.target="_blank",o.href=n,o.rel="noopener nofollow",o.setAttribute("rel","noopener nofollow"),o.appendChild(i),e.appendChild(o)}else e.appendChild(i)}}])}(Jp),av=Ni.cloneDeep,sv=function(){return c((function e(){f(this,e),ne(this,"mapService",void 0),ne(this,"fontService",void 0)}),[{key:"apply",value:function(e,t){var n=this,r=t.styleAttributeService,o=t.mapService,a=t.fontService,s=this;this.mapService=o,this.fontService=a,e.hooks.init.tapPromise("DataMappingPlugin",ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:e.log(vc,xc.INIT),s.generateMaping(e,{styleAttributeService:r}),e.log(mc,xc.INIT);case 3:case"end":return t.stop()}}),t)})))),e.hooks.beforeRenderData.tapPromise("DataMappingPlugin",function(){var t=ie(i().mark((function t(n){var o;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n){t.next=2;break}return t.abrupt("return",n);case 2:return e.dataState.dataMappingNeedUpdate=!1,e.log(vc,xc.UPDATE),o=s.generateMaping(e,{styleAttributeService:r}),e.log(mc,xc.UPDATE),t.abrupt("return",o);case 7:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()),e.hooks.beforeRender.tap("DataMappingPlugin",(function(){var t=e.getSource();if(!e.layerModelNeedUpdate&&t&&t.inited){var i=r.getLayerStyleAttributes()||[],o=r.getLayerStyleAttribute("filter"),a=t.data.dataArray;if(!Array.isArray(a)||0!==a.length){var s=i.filter((function(e){return e.needRemapping})),u=a;if(null!=o&&o.needRemapping&&null!=o&&o.scale&&(u=a.filter((function(e){return n.applyAttributeMapping(o,e)[0]}))),s.length){var c=n.mapping(e,s,u,e.getEncodedData());e.setEncodedData(c)}}}}))}},{key:"generateMaping",value:function(e,t){var n=this,r=t.styleAttributeService,i=r.getLayerStyleAttributes()||[],o=r.getLayerStyleAttribute("filter"),a=e.getSource().data.dataArray,s=a;null!=o&&o.scale&&(s=a.filter((function(e){return n.applyAttributeMapping(o,e)[0]}))),s=e.processData(s);var u=this.mapping(e,i,s,void 0);return e.setEncodedData(u),e.emit("dataUpdate",null),!0}},{key:"mapping",value:function(e,t,n,r){var i=this,o=t.filter((function(e){return void 0!==e.scale})).filter((function(e){return"filter"!==e.name})),a=n.map((function(e,t){var n=r?r[t]:{},a=re({id:e._id,coordinates:e.coordinates},n);return o.forEach((function(t){var n=i.applyAttributeMapping(t,e);"color"!==t.name&&"stroke"!==t.name||(n=n.map((function(e){return Ht(e)}))),a[t.name]=Array.isArray(n)&&1===n.length?n[0]:n,"shape"===t.name&&(a.shape=i.fontService.getIconFontKey(a[t.name]))})),a}));return t.forEach((function(e){e.needRemapping=!1})),this.adjustData2Amap2Coordinates(a,e),this.adjustData2SimpleCoordinates(a),a}},{key:"adjustData2Amap2Coordinates",value:function(e,t){var n=this;if(e.length>0&&"GAODE2.x"===this.mapService.version){var r=t.coordCenter||t.getSource().center;e.filter((function(e){return!e.originCoordinates})).map((function(e){e.version="GAODE2.x",e.originCoordinates=av(e.coordinates),e.coordinates=n.mapService.coordToAMap2RelativeCoordinates(e.coordinates,r)}))}}},{key:"adjustData2SimpleCoordinates",value:function(e){var t=this;e.length>0&&"SIMPLE"===this.mapService.version&&e.map((function(e){e.simpleCoordinate||(e.coordinates=t.unProjectCoordinates(e.coordinates),e.simpleCoordinate=!0)}))}},{key:"unProjectCoordinates",value:function(e){var t=this;if("number"==typeof e[0])return this.mapService.simpleMapCoord.unproject(e);if(e[0]&&e[0][0]instanceof Array){var n=[];return e.map((function(e){var r=[];e.map((function(e){r.push(t.mapService.simpleMapCoord.unproject(e))})),n.push(r)})),n}var r=[];return e.map((function(e){r.push(t.mapService.simpleMapCoord.unproject(e))})),r}},{key:"applyAttributeMapping",value:function(e,t){var n;if(!e.scale)return[];var r=(null==e||null===(n=e.scale)||void 0===n?void 0:n.scalers)||[],i=[];return r.forEach((function(n){var r,o=n.field;(t.hasOwnProperty(o)||"variable"===(null===(r=e.scale)||void 0===r?void 0:r.type))&&i.push(t[o])})),e.mapping?e.mapping(i):[]}},{key:"getArrowPoints",value:function(e,t){var n=no([t[0]-e[0],t[1]-e[1]]);return[e[0]+1e-4*n[0],e[1]+1e-4*n[1]]}}])}(),uv=function(){return c((function e(){f(this,e),ne(this,"mapService",void 0)}),[{key:"apply",value:function(e){var t=this;this.mapService=e.getContainer().mapService,e.hooks.init.tapPromise("DataSourcePlugin",ie(i().mark((function n(){var r,o,a,s;return i().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(e.log(fc,xc.INIT),(r=e.getSource())||(o=e.sourceOption||e.defaultSourceConfig,a=o.data,s=o.options,r=new $p(a,s),e.setSource(r)),!r.inited){n.next=8;break}t.updateClusterData(e),e.log(hc,xc.INIT),n.next=10;break;case 8:return n.next=10,new Promise((function(n){r.on("update",(function(r){"inited"===r.type&&(t.updateClusterData(e),e.log(hc,xc.INIT)),n(null)}))}));case 10:case"end":return n.stop()}}),n)})))),e.hooks.beforeRenderData.tapPromise("DataSourcePlugin",ie(i().mark((function n(){var r,o,a;return i().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return r=t.updateClusterData(e),o=e.dataState.dataSourceNeedUpdate,e.dataState.dataSourceNeedUpdate=!1,a=r||o,n.abrupt("return",a);case 5:case"end":return n.stop()}}),n)}))))}},{key:"updateClusterData",value:function(e){if(e.isTileLayer||e.tileLayer||!e.getSource())return!1;var t=e.getSource(),n=t.cluster,r=t.clusterOptions.zoom,i=void 0===r?0:r,o=this.mapService.getZoom()-1,a=e.dataState.dataSourceNeedUpdate;return n&&a&&t.updateClusterData(Math.floor(o)),!!(n&&Math.abs(e.clusterZoom-o)>=1)&&(i!==Math.floor(o)&&t.updateClusterData(Math.floor(o)),e.clusterZoom=o,!0)}}])}();function cv(e,t){return e<t?-1:e>t?1:e>=t?0:NaN}function lv(e){var t;return 1===e.length&&(t=e,e=function(e,n){return cv(t(e),n)}),{left:function(t,n,r,i){for(null==r&&(r=0),null==i&&(i=t.length);r<i;){var o=r+i>>>1;e(t[o],n)<0?r=o+1:i=o}return r},right:function(t,n,r,i){for(null==r&&(r=0),null==i&&(i=t.length);r<i;){var o=r+i>>>1;e(t[o],n)>0?i=o:r=o+1}return r}}}var fv=lv(cv).right;function hv(e){return null===e?NaN:+e}function dv(e,t){var n,r,i,o=e.length,a=-1;if(null==t){for(;++a<o;)if(null!=(n=e[a])&&n>=n)for(r=i=n;++a<o;)null!=(n=e[a])&&(r>n&&(r=n),i<n&&(i=n))}else for(;++a<o;)if(null!=(n=t(e[a],a,e))&&n>=n)for(r=i=n;++a<o;)null!=(n=t(e[a],a,e))&&(r>n&&(r=n),i<n&&(i=n));return[r,i]}var pv=Math.sqrt(50),vv=Math.sqrt(10),mv=Math.sqrt(2);function gv(e,t,n){var r,i,o,a,s=-1;if(n=+n,(e=+e)===(t=+t)&&n>0)return[e];if((r=t<e)&&(i=e,e=t,t=i),0===(a=_v(e,t,n))||!isFinite(a))return[];if(a>0)for(e=Math.ceil(e/a),t=Math.floor(t/a),o=new Array(i=Math.ceil(t-e+1));++s<i;)o[s]=(e+s)*a;else for(e=Math.floor(e*a),t=Math.ceil(t*a),o=new Array(i=Math.ceil(e-t+1));++s<i;)o[s]=(e-s)/a;return r&&o.reverse(),o}function _v(e,t,n){var r=(t-e)/Math.max(0,n),i=Math.floor(Math.log(r)/Math.LN10),o=r/Math.pow(10,i);return i>=0?(o>=pv?10:o>=vv?5:o>=mv?2:1)*Math.pow(10,i):-Math.pow(10,-i)/(o>=pv?10:o>=vv?5:o>=mv?2:1)}function yv(e,t,n){var r=Math.abs(t-e)/Math.max(0,n),i=Math.pow(10,Math.floor(Math.log(r)/Math.LN10)),o=r/i;return o>=pv?i*=10:o>=vv?i*=5:o>=mv&&(i*=2),t<e?-i:i}function Ev(e,t,n){if(null==n&&(n=hv),r=e.length){if((t=+t)<=0||r<2)return+n(e[0],0,e);if(t>=1)return+n(e[r-1],r-1,e);var r,i=(r-1)*t,o=Math.floor(i),a=+n(e[o],o,e);return a+(+n(e[o+1],o+1,e)-a)*(i-o)}}function bv(e){return function(){return e}}function Av(e){return 1==(e=+e)?xv:function(t,n){return n-t?function(e,t,n){return e=Math.pow(e,n),t=Math.pow(t,n)-e,n=1/n,function(r){return Math.pow(e+r*t,n)}}(t,n,e):bv(isNaN(t)?n:t)}}function xv(e,t){var n=t-e;return n?function(e,t){return function(n){return e+n*t}}(e,n):bv(isNaN(e)?t:e)}var Sv=function e(t){var n=Av(t);function r(e,t){var r=n((e=Pt(e)).r,(t=Pt(t)).r),i=n(e.g,t.g),o=n(e.b,t.b),a=xv(e.opacity,t.opacity);return function(t){return e.r=r(t),e.g=i(t),e.b=o(t),e.opacity=a(t),e+""}}return r.gamma=e,r}(1);var Tv,Rv=(Tv=function(e){var t=e.length-1;return function(n){var r=n<=0?n=0:n>=1?(n=1,t-1):Math.floor(n*t),i=e[r],o=e[r+1],a=r>0?e[r-1]:2*i-o,s=r<t-1?e[r+2]:2*o-i;return function(e,t,n,r,i){var o=e*e,a=o*e;return((1-3*e+3*o-a)*t+(4-6*o+3*a)*n+(1+3*e+3*o-3*a)*r+a*i)/6}((n-r/t)*t,a,i,o,s)}},function(e){var t,n,r=e.length,i=new Array(r),o=new Array(r),a=new Array(r);for(t=0;t<r;++t)n=Pt(e[t]),i[t]=n.r||0,o[t]=n.g||0,a[t]=n.b||0;return i=Tv(i),o=Tv(o),a=Tv(a),n.opacity=1,function(e){return n.r=i(e),n.g=o(e),n.b=a(e),n+""}});function Cv(e,t){t||(t=[]);var n,r=e?Math.min(t.length,e.length):0,i=t.slice();return function(o){for(n=0;n<r;++n)i[n]=e[n]*(1-o)+t[n]*o;return i}}function Mv(e,t){var n,r=t?t.length:0,i=e?Math.min(r,e.length):0,o=new Array(i),a=new Array(r);for(n=0;n<i;++n)o[n]=Pv(e[n],t[n]);for(;n<r;++n)a[n]=t[n];return function(e){for(n=0;n<i;++n)a[n]=o[n](e);return a}}function wv(e,t){var n=new Date;return e=+e,t=+t,function(r){return n.setTime(e*(1-r)+t*r),n}}function Lv(e,t){return e=+e,t=+t,function(n){return e*(1-n)+t*n}}function Ov(e,t){var n,r={},i={};for(n in null!==e&&"object"===s(e)||(e={}),null!==t&&"object"===s(t)||(t={}),t)n in e?r[n]=Pv(e[n],t[n]):i[n]=t[n];return function(e){for(n in r)i[n]=r[n](e);return i}}var kv=/[-+]?(?:\d+\.?\d*|\.?\d+)(?:[eE][-+]?\d+)?/g,Nv=new RegExp(kv.source,"g");function Iv(e,t){var n,r,i,o=kv.lastIndex=Nv.lastIndex=0,a=-1,s=[],u=[];for(e+="",t+="";(n=kv.exec(e))&&(r=Nv.exec(t));)(i=r.index)>o&&(i=t.slice(o,i),s[a]?s[a]+=i:s[++a]=i),(n=n[0])===(r=r[0])?s[a]?s[a]+=r:s[++a]=r:(s[++a]=null,u.push({i:a,x:Lv(n,r)})),o=Nv.lastIndex;return o<t.length&&(i=t.slice(o),s[a]?s[a]+=i:s[++a]=i),s.length<2?u[0]?function(e){return function(t){return e(t)+""}}(u[0].x):function(e){return function(){return e}}(t):(t=u.length,function(e){for(var n,r=0;r<t;++r)s[(n=u[r]).i]=n.x(e);return s.join("")})}function Pv(e,t){var n,r,i=s(t);return null==t||"boolean"===i?bv(t):("number"===i?Lv:"string"===i?(n=kt(t))?(t=n,Sv):Iv:t instanceof kt?Sv:t instanceof Date?wv:(r=t,!ArrayBuffer.isView(r)||r instanceof DataView?Array.isArray(t)?Mv:"function"!=typeof t.valueOf&&"function"!=typeof t.toString||isNaN(t)?Ov:Lv:Cv))(e,t)}function Dv(e,t){return e=+e,t=+t,function(n){return Math.round(e*(1-n)+t*n)}}function Fv(e,t){switch(arguments.length){case 0:break;case 1:this.range(e);break;default:this.range(t).domain(e)}return this}function Bv(e,t){switch(arguments.length){case 0:break;case 1:this.interpolator(e);break;default:this.interpolator(t).domain(e)}return this}var Uv="$";function Gv(){}function zv(e,t){var n=new Gv;if(e instanceof Gv)e.each((function(e,t){n.set(t,e)}));else if(Array.isArray(e)){var r,i=-1,o=e.length;if(null==t)for(;++i<o;)n.set(i,e[i]);else for(;++i<o;)n.set(t(r=e[i],i,e),r)}else if(e)for(var a in e)n.set(a,e[a]);return n}function jv(){}Gv.prototype=zv.prototype={constructor:Gv,has:function(e){return Uv+e in this},get:function(e){return this[Uv+e]},set:function(e,t){return this[Uv+e]=t,this},remove:function(e){var t=Uv+e;return t in this&&delete this[t]},clear:function(){for(var e in this)e[0]===Uv&&delete this[e]},keys:function(){var e=[];for(var t in this)t[0]===Uv&&e.push(t.slice(1));return e},values:function(){var e=[];for(var t in this)t[0]===Uv&&e.push(this[t]);return e},entries:function(){var e=[];for(var t in this)t[0]===Uv&&e.push({key:t.slice(1),value:this[t]});return e},size:function(){var e=0;for(var t in this)t[0]===Uv&&++e;return e},empty:function(){for(var e in this)if(e[0]===Uv)return!1;return!0},each:function(e){for(var t in this)t[0]===Uv&&e(this[t],t.slice(1),this)}};var Vv=zv.prototype;jv.prototype={constructor:jv,has:Vv.has,add:function(e){return this[Uv+(e+="")]=e,this},remove:Vv.remove,clear:Vv.clear,values:Vv.keys,size:Vv.size,empty:Vv.empty,each:Vv.each};var Hv=Array.prototype,Xv=Hv.map,Wv=Hv.slice,Yv={name:"implicit"};function Zv(){var e=zv(),t=[],n=[],r=Yv;function i(i){var o=i+"",a=e.get(o);if(!a){if(r!==Yv)return r;e.set(o,a=t.push(i))}return n[(a-1)%n.length]}return i.domain=function(n){if(!arguments.length)return t.slice();t=[],e=zv();for(var r,o,a=-1,s=n.length;++a<s;)e.has(o=(r=n[a])+"")||e.set(o,t.push(r));return i},i.range=function(e){return arguments.length?(n=Wv.call(e),i):n.slice()},i.unknown=function(e){return arguments.length?(r=e,i):r},i.copy=function(){return Zv(t,n).unknown(r)},Fv.apply(i,arguments),i}function qv(e){return+e}var Kv=[0,1];function Qv(e){return e}function $v(e,t){return(t-=e=+e)?function(n){return(n-e)/t}:(n=isNaN(t)?NaN:.5,function(){return n});var n}function Jv(e){var t,n=e[0],r=e[e.length-1];return n>r&&(t=n,n=r,r=t),function(e){return Math.max(n,Math.min(r,e))}}function em(e,t,n){var r=e[0],i=e[1],o=t[0],a=t[1];return i<r?(r=$v(i,r),o=n(a,o)):(r=$v(r,i),o=n(o,a)),function(e){return o(r(e))}}function tm(e,t,n){var r=Math.min(e.length,t.length)-1,i=new Array(r),o=new Array(r),a=-1;for(e[r]<e[0]&&(e=e.slice().reverse(),t=t.slice().reverse());++a<r;)i[a]=$v(e[a],e[a+1]),o[a]=n(t[a],t[a+1]);return function(t){var n=fv(e,t,1,r)-1;return o[n](i[n](t))}}function nm(e,t){return t.domain(e.domain()).range(e.range()).interpolate(e.interpolate()).clamp(e.clamp()).unknown(e.unknown())}function rm(){var e,t,n,r,i,o,a=Kv,s=Kv,u=Pv,c=Qv;function l(){return r=Math.min(a.length,s.length)>2?tm:em,i=o=null,f}function f(t){return isNaN(t=+t)?n:(i||(i=r(a.map(e),s,u)))(e(c(t)))}return f.invert=function(n){return c(t((o||(o=r(s,a.map(e),Lv)))(n)))},f.domain=function(e){return arguments.length?(a=Xv.call(e,qv),c===Qv||(c=Jv(a)),l()):a.slice()},f.range=function(e){return arguments.length?(s=Wv.call(e),l()):s.slice()},f.rangeRound=function(e){return s=Wv.call(e),u=Dv,l()},f.clamp=function(e){return arguments.length?(c=e?Jv(a):Qv,f):c!==Qv},f.interpolate=function(e){return arguments.length?(u=e,l()):u},f.unknown=function(e){return arguments.length?(n=e,f):n},function(n,r){return e=n,t=r,l()}}function im(e,t){return rm()(e,t)}function om(e,t){if((n=(e=t?e.toExponential(t-1):e.toExponential()).indexOf("e"))<0)return null;var n,r=e.slice(0,n);return[r.length>1?r[0]+r.slice(2):r,+e.slice(n+1)]}function am(e){return(e=om(Math.abs(e)))?e[1]:NaN}var sm,um=/^(?:(.)?([<>=^]))?([+\-( ])?([$#])?(0)?(\d+)?(,)?(\.\d+)?(~)?([a-z%])?$/i;function cm(e){if(!(t=um.exec(e)))throw new Error("invalid format: "+e);var t;return new lm({fill:t[1],align:t[2],sign:t[3],symbol:t[4],zero:t[5],width:t[6],comma:t[7],precision:t[8]&&t[8].slice(1),trim:t[9],type:t[10]})}function lm(e){this.fill=void 0===e.fill?" ":e.fill+"",this.align=void 0===e.align?">":e.align+"",this.sign=void 0===e.sign?"-":e.sign+"",this.symbol=void 0===e.symbol?"":e.symbol+"",this.zero=!!e.zero,this.width=void 0===e.width?void 0:+e.width,this.comma=!!e.comma,this.precision=void 0===e.precision?void 0:+e.precision,this.trim=!!e.trim,this.type=void 0===e.type?"":e.type+""}function fm(e,t){var n=om(e,t);if(!n)return e+"";var r=n[0],i=n[1];return i<0?"0."+new Array(-i).join("0")+r:r.length>i+1?r.slice(0,i+1)+"."+r.slice(i+1):r+new Array(i-r.length+2).join("0")}cm.prototype=lm.prototype,lm.prototype.toString=function(){return this.fill+this.align+this.sign+this.symbol+(this.zero?"0":"")+(void 0===this.width?"":Math.max(1,0|this.width))+(this.comma?",":"")+(void 0===this.precision?"":"."+Math.max(0,0|this.precision))+(this.trim?"~":"")+this.type};var hm={"%":function(e,t){return(100*e).toFixed(t)},b:function(e){return Math.round(e).toString(2)},c:function(e){return e+""},d:function(e){return Math.abs(e=Math.round(e))>=1e21?e.toLocaleString("en").replace(/,/g,""):e.toString(10)},e:function(e,t){return e.toExponential(t)},f:function(e,t){return e.toFixed(t)},g:function(e,t){return e.toPrecision(t)},o:function(e){return Math.round(e).toString(8)},p:function(e,t){return fm(100*e,t)},r:fm,s:function(e,t){var n=om(e,t);if(!n)return e+"";var r=n[0],i=n[1],o=i-(sm=3*Math.max(-8,Math.min(8,Math.floor(i/3))))+1,a=r.length;return o===a?r:o>a?r+new Array(o-a+1).join("0"):o>0?r.slice(0,o)+"."+r.slice(o):"0."+new Array(1-o).join("0")+om(e,Math.max(0,t+o-1))[0]},X:function(e){return Math.round(e).toString(16).toUpperCase()},x:function(e){return Math.round(e).toString(16)}};function dm(e){return e}var pm,vm,mm,gm=Array.prototype.map,_m=["y","z","a","f","p","n","µ","m","","k","M","G","T","P","E","Z","Y"];function ym(e){var t,n,r=void 0===e.grouping||void 0===e.thousands?dm:(t=gm.call(e.grouping,Number),n=e.thousands+"",function(e,r){for(var i=e.length,o=[],a=0,s=t[0],u=0;i>0&&s>0&&(u+s+1>r&&(s=Math.max(1,r-u)),o.push(e.substring(i-=s,i+s)),!((u+=s+1)>r));)s=t[a=(a+1)%t.length];return o.reverse().join(n)}),i=void 0===e.currency?"":e.currency[0]+"",o=void 0===e.currency?"":e.currency[1]+"",a=void 0===e.decimal?".":e.decimal+"",s=void 0===e.numerals?dm:function(e){return function(t){return t.replace(/[0-9]/g,(function(t){return e[+t]}))}}(gm.call(e.numerals,String)),u=void 0===e.percent?"%":e.percent+"",c=void 0===e.minus?"-":e.minus+"",l=void 0===e.nan?"NaN":e.nan+"";function f(e){var t=(e=cm(e)).fill,n=e.align,f=e.sign,h=e.symbol,d=e.zero,p=e.width,v=e.comma,m=e.precision,g=e.trim,_=e.type;"n"===_?(v=!0,_="g"):hm[_]||(void 0===m&&(m=12),g=!0,_="g"),(d||"0"===t&&"="===n)&&(d=!0,t="0",n="=");var y="$"===h?i:"#"===h&&/[boxX]/.test(_)?"0"+_.toLowerCase():"",E="$"===h?o:/[%p]/.test(_)?u:"",b=hm[_],A=/[defgprs%]/.test(_);function x(e){var i,o,u,h=y,x=E;if("c"===_)x=b(e)+x,e="";else{var S=(e=+e)<0||1/e<0;if(e=isNaN(e)?l:b(Math.abs(e),m),g&&(e=function(e){e:for(var t,n=e.length,r=1,i=-1;r<n;++r)switch(e[r]){case".":i=t=r;break;case"0":0===i&&(i=r),t=r;break;default:if(!+e[r])break e;i>0&&(i=0)}return i>0?e.slice(0,i)+e.slice(t+1):e}(e)),S&&0==+e&&"+"!==f&&(S=!1),h=(S?"("===f?f:c:"-"===f||"("===f?"":f)+h,x=("s"===_?_m[8+sm/3]:"")+x+(S&&"("===f?")":""),A)for(i=-1,o=e.length;++i<o;)if(48>(u=e.charCodeAt(i))||u>57){x=(46===u?a+e.slice(i+1):e.slice(i))+x,e=e.slice(0,i);break}}v&&!d&&(e=r(e,1/0));var T=h.length+e.length+x.length,R=T<p?new Array(p-T+1).join(t):"";switch(v&&d&&(e=r(R+e,R.length?p-x.length:1/0),R=""),n){case"<":e=h+e+x+R;break;case"=":e=h+R+e+x;break;case"^":e=R.slice(0,T=R.length>>1)+h+e+x+R.slice(T);break;default:e=R+h+e+x}return s(e)}return m=void 0===m?6:/[gprs]/.test(_)?Math.max(1,Math.min(21,m)):Math.max(0,Math.min(20,m)),x.toString=function(){return e+""},x}return{format:f,formatPrefix:function(e,t){var n=f(((e=cm(e)).type="f",e)),r=3*Math.max(-8,Math.min(8,Math.floor(am(t)/3))),i=Math.pow(10,-r),o=_m[8+r/3];return function(e){return n(i*e)+o}}}}function Em(e,t,n,r){var i,o=yv(e,t,n);switch((r=cm(null==r?",f":r)).type){case"s":var a=Math.max(Math.abs(e),Math.abs(t));return null!=r.precision||isNaN(i=function(e,t){return Math.max(0,3*Math.max(-8,Math.min(8,Math.floor(am(t)/3)))-am(Math.abs(e)))}(o,a))||(r.precision=i),mm(r,a);case"":case"e":case"g":case"p":case"r":null!=r.precision||isNaN(i=function(e,t){return e=Math.abs(e),t=Math.abs(t)-e,Math.max(0,am(t)-am(e))+1}(o,Math.max(Math.abs(e),Math.abs(t))))||(r.precision=i-("e"===r.type));break;case"f":case"%":null!=r.precision||isNaN(i=function(e){return Math.max(0,-am(Math.abs(e)))}(o))||(r.precision=i-2*("%"===r.type))}return vm(r)}function bm(e){var t=e.domain;return e.ticks=function(e){var n=t();return gv(n[0],n[n.length-1],null==e?10:e)},e.tickFormat=function(e,n){var r=t();return Em(r[0],r[r.length-1],null==e?10:e,n)},e.nice=function(n){null==n&&(n=10);var r,i=t(),o=0,a=i.length-1,s=i[o],u=i[a];return u<s&&(r=s,s=u,u=r,r=o,o=a,a=r),(r=_v(s,u,n))>0?r=_v(s=Math.floor(s/r)*r,u=Math.ceil(u/r)*r,n):r<0&&(r=_v(s=Math.ceil(s*r)/r,u=Math.floor(u*r)/r,n)),r>0?(i[o]=Math.floor(s/r)*r,i[a]=Math.ceil(u/r)*r,t(i)):r<0&&(i[o]=Math.ceil(s*r)/r,i[a]=Math.floor(u*r)/r,t(i)),e},e}function Am(e,t){var n,r=0,i=(e=e.slice()).length-1,o=e[r],a=e[i];return a<o&&(n=r,r=i,i=n,n=o,o=a,a=n),e[r]=t.floor(o),e[i]=t.ceil(a),e}function xm(e){return Math.log(e)}function Sm(e){return Math.exp(e)}function Tm(e){return-Math.log(-e)}function Rm(e){return-Math.exp(-e)}function Cm(e){return isFinite(e)?+("1e"+e):e<0?0:e}function Mm(e){return function(t){return-e(-t)}}function wm(e){var t,n,r=e(xm,Sm),i=r.domain,o=10;function a(){return t=function(e){return e===Math.E?Math.log:10===e&&Math.log10||2===e&&Math.log2||(e=Math.log(e),function(t){return Math.log(t)/e})}(o),n=function(e){return 10===e?Cm:e===Math.E?Math.exp:function(t){return Math.pow(e,t)}}(o),i()[0]<0?(t=Mm(t),n=Mm(n),e(Tm,Rm)):e(xm,Sm),r}return r.base=function(e){return arguments.length?(o=+e,a()):o},r.domain=function(e){return arguments.length?(i(e),a()):i()},r.ticks=function(e){var r,a=i(),s=a[0],u=a[a.length-1];(r=u<s)&&(h=s,s=u,u=h);var c,l,f,h=t(s),d=t(u),p=null==e?10:+e,v=[];if(!(o%1)&&d-h<p){if(h=Math.round(h)-1,d=Math.round(d)+1,s>0){for(;h<d;++h)for(l=1,c=n(h);l<o;++l)if(!((f=c*l)<s)){if(f>u)break;v.push(f)}}else for(;h<d;++h)for(l=o-1,c=n(h);l>=1;--l)if(!((f=c*l)<s)){if(f>u)break;v.push(f)}}else v=gv(h,d,Math.min(d-h,p)).map(n);return r?v.reverse():v},r.tickFormat=function(e,i){if(null==i&&(i=10===o?".0e":","),"function"!=typeof i&&(i=vm(i)),e===1/0)return i;null==e&&(e=10);var a=Math.max(1,o*e/r.ticks().length);return function(e){var r=e/n(Math.round(t(e)));return r*o<o-.5&&(r*=o),r<=a?i(e):""}},r.nice=function(){return i(Am(i(),{floor:function(e){return n(Math.floor(t(e)))},ceil:function(e){return n(Math.ceil(t(e)))}}))},r}function Lm(e){return function(t){return t<0?-Math.pow(-t,e):Math.pow(t,e)}}function Om(e){return e<0?-Math.sqrt(-e):Math.sqrt(e)}function km(e){return e<0?-e*e:e*e}function Nm(e){var t=e(Qv,Qv),n=1;return t.exponent=function(t){return arguments.length?1===(n=+t)?e(Qv,Qv):.5===n?e(Om,km):e(Lm(n),Lm(1/n)):n},bm(t)}pm=ym({decimal:".",thousands:",",grouping:[3],currency:["$",""],minus:"-"}),vm=pm.format,mm=pm.formatPrefix;var Im=new Date,Pm=new Date;function Dm(e,t,n,r){function i(t){return e(t=0===arguments.length?new Date:new Date(+t)),t}return i.floor=function(t){return e(t=new Date(+t)),t},i.ceil=function(n){return e(n=new Date(n-1)),t(n,1),e(n),n},i.round=function(e){var t=i(e),n=i.ceil(e);return e-t<n-e?t:n},i.offset=function(e,n){return t(e=new Date(+e),null==n?1:Math.floor(n)),e},i.range=function(n,r,o){var a,s=[];if(n=i.ceil(n),o=null==o?1:Math.floor(o),!(n<r&&o>0))return s;do{s.push(a=new Date(+n)),t(n,o),e(n)}while(a<n&&n<r);return s},i.filter=function(n){return Dm((function(t){if(t>=t)for(;e(t),!n(t);)t.setTime(t-1)}),(function(e,r){if(e>=e)if(r<0)for(;++r<=0;)for(;t(e,-1),!n(e););else for(;--r>=0;)for(;t(e,1),!n(e););}))},n&&(i.count=function(t,r){return Im.setTime(+t),Pm.setTime(+r),e(Im),e(Pm),Math.floor(n(Im,Pm))},i.every=function(e){return e=Math.floor(e),isFinite(e)&&e>0?e>1?i.filter(r?function(t){return r(t)%e==0}:function(t){return i.count(0,t)%e==0}):i:null}),i}var Fm=Dm((function(){}),(function(e,t){e.setTime(+e+t)}),(function(e,t){return t-e}));Fm.every=function(e){return e=Math.floor(e),isFinite(e)&&e>0?e>1?Dm((function(t){t.setTime(Math.floor(t/e)*e)}),(function(t,n){t.setTime(+t+n*e)}),(function(t,n){return(n-t)/e})):Fm:null};var Bm=Fm;Fm.range;var Um=1e3,Gm=6e4,zm=36e5,jm=864e5,Vm=6048e5,Hm=Dm((function(e){e.setTime(e-e.getMilliseconds())}),(function(e,t){e.setTime(+e+t*Um)}),(function(e,t){return(t-e)/Um}),(function(e){return e.getUTCSeconds()})),Xm=Hm;Hm.range;var Wm=Dm((function(e){e.setTime(e-e.getMilliseconds()-e.getSeconds()*Um)}),(function(e,t){e.setTime(+e+t*Gm)}),(function(e,t){return(t-e)/Gm}),(function(e){return e.getMinutes()})),Ym=Wm;Wm.range;var Zm=Dm((function(e){e.setTime(e-e.getMilliseconds()-e.getSeconds()*Um-e.getMinutes()*Gm)}),(function(e,t){e.setTime(+e+t*zm)}),(function(e,t){return(t-e)/zm}),(function(e){return e.getHours()})),qm=Zm;Zm.range;var Km=Dm((function(e){e.setHours(0,0,0,0)}),(function(e,t){e.setDate(e.getDate()+t)}),(function(e,t){return(t-e-(t.getTimezoneOffset()-e.getTimezoneOffset())*Gm)/jm}),(function(e){return e.getDate()-1})),Qm=Km;function $m(e){return Dm((function(t){t.setDate(t.getDate()-(t.getDay()+7-e)%7),t.setHours(0,0,0,0)}),(function(e,t){e.setDate(e.getDate()+7*t)}),(function(e,t){return(t-e-(t.getTimezoneOffset()-e.getTimezoneOffset())*Gm)/Vm}))}Km.range;var Jm=$m(0),eg=$m(1),tg=$m(2),ng=$m(3),rg=$m(4),ig=$m(5),og=$m(6);Jm.range,eg.range,tg.range,ng.range,rg.range,ig.range,og.range;var ag=Dm((function(e){e.setDate(1),e.setHours(0,0,0,0)}),(function(e,t){e.setMonth(e.getMonth()+t)}),(function(e,t){return t.getMonth()-e.getMonth()+12*(t.getFullYear()-e.getFullYear())}),(function(e){return e.getMonth()})),sg=ag;ag.range;var ug=Dm((function(e){e.setMonth(0,1),e.setHours(0,0,0,0)}),(function(e,t){e.setFullYear(e.getFullYear()+t)}),(function(e,t){return t.getFullYear()-e.getFullYear()}),(function(e){return e.getFullYear()}));ug.every=function(e){return isFinite(e=Math.floor(e))&&e>0?Dm((function(t){t.setFullYear(Math.floor(t.getFullYear()/e)*e),t.setMonth(0,1),t.setHours(0,0,0,0)}),(function(t,n){t.setFullYear(t.getFullYear()+n*e)})):null};var cg=ug;ug.range;var lg=Dm((function(e){e.setUTCHours(0,0,0,0)}),(function(e,t){e.setUTCDate(e.getUTCDate()+t)}),(function(e,t){return(t-e)/jm}),(function(e){return e.getUTCDate()-1})),fg=lg;function hg(e){return Dm((function(t){t.setUTCDate(t.getUTCDate()-(t.getUTCDay()+7-e)%7),t.setUTCHours(0,0,0,0)}),(function(e,t){e.setUTCDate(e.getUTCDate()+7*t)}),(function(e,t){return(t-e)/Vm}))}lg.range;var dg=hg(0),pg=hg(1),vg=hg(2),mg=hg(3),gg=hg(4),_g=hg(5),yg=hg(6);dg.range,pg.range,vg.range,mg.range,gg.range,_g.range,yg.range;var Eg=Dm((function(e){e.setUTCMonth(0,1),e.setUTCHours(0,0,0,0)}),(function(e,t){e.setUTCFullYear(e.getUTCFullYear()+t)}),(function(e,t){return t.getUTCFullYear()-e.getUTCFullYear()}),(function(e){return e.getUTCFullYear()}));Eg.every=function(e){return isFinite(e=Math.floor(e))&&e>0?Dm((function(t){t.setUTCFullYear(Math.floor(t.getUTCFullYear()/e)*e),t.setUTCMonth(0,1),t.setUTCHours(0,0,0,0)}),(function(t,n){t.setUTCFullYear(t.getUTCFullYear()+n*e)})):null};var bg=Eg;function Ag(e){if(0<=e.y&&e.y<100){var t=new Date(-1,e.m,e.d,e.H,e.M,e.S,e.L);return t.setFullYear(e.y),t}return new Date(e.y,e.m,e.d,e.H,e.M,e.S,e.L)}function xg(e){if(0<=e.y&&e.y<100){var t=new Date(Date.UTC(-1,e.m,e.d,e.H,e.M,e.S,e.L));return t.setUTCFullYear(e.y),t}return new Date(Date.UTC(e.y,e.m,e.d,e.H,e.M,e.S,e.L))}function Sg(e,t,n){return{y:e,m:t,d:n,H:0,M:0,S:0,L:0}}Eg.range;var Tg,Rg,Cg={"-":"",_:" ",0:"0"},Mg=/^\s*\d+/,wg=/^%/,Lg=/[\\^$*+?|[\]().{}]/g;function Og(e,t,n){var r=e<0?"-":"",i=(r?-e:e)+"",o=i.length;return r+(o<n?new Array(n-o+1).join(t)+i:i)}function kg(e){return e.replace(Lg,"\\$&")}function Ng(e){return new RegExp("^(?:"+e.map(kg).join("|")+")","i")}function Ig(e){for(var t={},n=-1,r=e.length;++n<r;)t[e[n].toLowerCase()]=n;return t}function Pg(e,t,n){var r=Mg.exec(t.slice(n,n+1));return r?(e.w=+r[0],n+r[0].length):-1}function Dg(e,t,n){var r=Mg.exec(t.slice(n,n+1));return r?(e.u=+r[0],n+r[0].length):-1}function Fg(e,t,n){var r=Mg.exec(t.slice(n,n+2));return r?(e.U=+r[0],n+r[0].length):-1}function Bg(e,t,n){var r=Mg.exec(t.slice(n,n+2));return r?(e.V=+r[0],n+r[0].length):-1}function Ug(e,t,n){var r=Mg.exec(t.slice(n,n+2));return r?(e.W=+r[0],n+r[0].length):-1}function Gg(e,t,n){var r=Mg.exec(t.slice(n,n+4));return r?(e.y=+r[0],n+r[0].length):-1}function zg(e,t,n){var r=Mg.exec(t.slice(n,n+2));return r?(e.y=+r[0]+(+r[0]>68?1900:2e3),n+r[0].length):-1}function jg(e,t,n){var r=/^(Z)|([+-]\d\d)(?::?(\d\d))?/.exec(t.slice(n,n+6));return r?(e.Z=r[1]?0:-(r[2]+(r[3]||"00")),n+r[0].length):-1}function Vg(e,t,n){var r=Mg.exec(t.slice(n,n+1));return r?(e.q=3*r[0]-3,n+r[0].length):-1}function Hg(e,t,n){var r=Mg.exec(t.slice(n,n+2));return r?(e.m=r[0]-1,n+r[0].length):-1}function Xg(e,t,n){var r=Mg.exec(t.slice(n,n+2));return r?(e.d=+r[0],n+r[0].length):-1}function Wg(e,t,n){var r=Mg.exec(t.slice(n,n+3));return r?(e.m=0,e.d=+r[0],n+r[0].length):-1}function Yg(e,t,n){var r=Mg.exec(t.slice(n,n+2));return r?(e.H=+r[0],n+r[0].length):-1}function Zg(e,t,n){var r=Mg.exec(t.slice(n,n+2));return r?(e.M=+r[0],n+r[0].length):-1}function qg(e,t,n){var r=Mg.exec(t.slice(n,n+2));return r?(e.S=+r[0],n+r[0].length):-1}function Kg(e,t,n){var r=Mg.exec(t.slice(n,n+3));return r?(e.L=+r[0],n+r[0].length):-1}function Qg(e,t,n){var r=Mg.exec(t.slice(n,n+6));return r?(e.L=Math.floor(r[0]/1e3),n+r[0].length):-1}function $g(e,t,n){var r=wg.exec(t.slice(n,n+1));return r?n+r[0].length:-1}function Jg(e,t,n){var r=Mg.exec(t.slice(n));return r?(e.Q=+r[0],n+r[0].length):-1}function e_(e,t,n){var r=Mg.exec(t.slice(n));return r?(e.s=+r[0],n+r[0].length):-1}function t_(e,t){return Og(e.getDate(),t,2)}function n_(e,t){return Og(e.getHours(),t,2)}function r_(e,t){return Og(e.getHours()%12||12,t,2)}function i_(e,t){return Og(1+Qm.count(cg(e),e),t,3)}function o_(e,t){return Og(e.getMilliseconds(),t,3)}function a_(e,t){return o_(e,t)+"000"}function s_(e,t){return Og(e.getMonth()+1,t,2)}function u_(e,t){return Og(e.getMinutes(),t,2)}function c_(e,t){return Og(e.getSeconds(),t,2)}function l_(e){var t=e.getDay();return 0===t?7:t}function f_(e,t){return Og(Jm.count(cg(e)-1,e),t,2)}function h_(e){var t=e.getDay();return t>=4||0===t?rg(e):rg.ceil(e)}function d_(e,t){return e=h_(e),Og(rg.count(cg(e),e)+(4===cg(e).getDay()),t,2)}function p_(e){return e.getDay()}function v_(e,t){return Og(eg.count(cg(e)-1,e),t,2)}function m_(e,t){return Og(e.getFullYear()%100,t,2)}function g_(e,t){return Og((e=h_(e)).getFullYear()%100,t,2)}function __(e,t){return Og(e.getFullYear()%1e4,t,4)}function y_(e,t){var n=e.getDay();return Og((e=n>=4||0===n?rg(e):rg.ceil(e)).getFullYear()%1e4,t,4)}function E_(e){var t=e.getTimezoneOffset();return(t>0?"-":(t*=-1,"+"))+Og(t/60|0,"0",2)+Og(t%60,"0",2)}function b_(e,t){return Og(e.getUTCDate(),t,2)}function A_(e,t){return Og(e.getUTCHours(),t,2)}function x_(e,t){return Og(e.getUTCHours()%12||12,t,2)}function S_(e,t){return Og(1+fg.count(bg(e),e),t,3)}function T_(e,t){return Og(e.getUTCMilliseconds(),t,3)}function R_(e,t){return T_(e,t)+"000"}function C_(e,t){return Og(e.getUTCMonth()+1,t,2)}function M_(e,t){return Og(e.getUTCMinutes(),t,2)}function w_(e,t){return Og(e.getUTCSeconds(),t,2)}function L_(e){var t=e.getUTCDay();return 0===t?7:t}function O_(e,t){return Og(dg.count(bg(e)-1,e),t,2)}function k_(e){var t=e.getUTCDay();return t>=4||0===t?gg(e):gg.ceil(e)}function N_(e,t){return e=k_(e),Og(gg.count(bg(e),e)+(4===bg(e).getUTCDay()),t,2)}function I_(e){return e.getUTCDay()}function P_(e,t){return Og(pg.count(bg(e)-1,e),t,2)}function D_(e,t){return Og(e.getUTCFullYear()%100,t,2)}function F_(e,t){return Og((e=k_(e)).getUTCFullYear()%100,t,2)}function B_(e,t){return Og(e.getUTCFullYear()%1e4,t,4)}function U_(e,t){var n=e.getUTCDay();return Og((e=n>=4||0===n?gg(e):gg.ceil(e)).getUTCFullYear()%1e4,t,4)}function G_(){return"+0000"}function z_(){return"%"}function j_(e){return+e}function V_(e){return Math.floor(+e/1e3)}!function(e){Tg=function(e){var t=e.dateTime,n=e.date,r=e.time,i=e.periods,o=e.days,a=e.shortDays,s=e.months,u=e.shortMonths,c=Ng(i),l=Ig(i),f=Ng(o),h=Ig(o),d=Ng(a),p=Ig(a),v=Ng(s),m=Ig(s),g=Ng(u),_=Ig(u),y={a:function(e){return a[e.getDay()]},A:function(e){return o[e.getDay()]},b:function(e){return u[e.getMonth()]},B:function(e){return s[e.getMonth()]},c:null,d:t_,e:t_,f:a_,g:g_,G:y_,H:n_,I:r_,j:i_,L:o_,m:s_,M:u_,p:function(e){return i[+(e.getHours()>=12)]},q:function(e){return 1+~~(e.getMonth()/3)},Q:j_,s:V_,S:c_,u:l_,U:f_,V:d_,w:p_,W:v_,x:null,X:null,y:m_,Y:__,Z:E_,"%":z_},E={a:function(e){return a[e.getUTCDay()]},A:function(e){return o[e.getUTCDay()]},b:function(e){return u[e.getUTCMonth()]},B:function(e){return s[e.getUTCMonth()]},c:null,d:b_,e:b_,f:R_,g:F_,G:U_,H:A_,I:x_,j:S_,L:T_,m:C_,M:M_,p:function(e){return i[+(e.getUTCHours()>=12)]},q:function(e){return 1+~~(e.getUTCMonth()/3)},Q:j_,s:V_,S:w_,u:L_,U:O_,V:N_,w:I_,W:P_,x:null,X:null,y:D_,Y:B_,Z:G_,"%":z_},b={a:function(e,t,n){var r=d.exec(t.slice(n));return r?(e.w=p[r[0].toLowerCase()],n+r[0].length):-1},A:function(e,t,n){var r=f.exec(t.slice(n));return r?(e.w=h[r[0].toLowerCase()],n+r[0].length):-1},b:function(e,t,n){var r=g.exec(t.slice(n));return r?(e.m=_[r[0].toLowerCase()],n+r[0].length):-1},B:function(e,t,n){var r=v.exec(t.slice(n));return r?(e.m=m[r[0].toLowerCase()],n+r[0].length):-1},c:function(e,n,r){return S(e,t,n,r)},d:Xg,e:Xg,f:Qg,g:zg,G:Gg,H:Yg,I:Yg,j:Wg,L:Kg,m:Hg,M:Zg,p:function(e,t,n){var r=c.exec(t.slice(n));return r?(e.p=l[r[0].toLowerCase()],n+r[0].length):-1},q:Vg,Q:Jg,s:e_,S:qg,u:Dg,U:Fg,V:Bg,w:Pg,W:Ug,x:function(e,t,r){return S(e,n,t,r)},X:function(e,t,n){return S(e,r,t,n)},y:zg,Y:Gg,Z:jg,"%":$g};function A(e,t){return function(n){var r,i,o,a=[],s=-1,u=0,c=e.length;for(n instanceof Date||(n=new Date(+n));++s<c;)37===e.charCodeAt(s)&&(a.push(e.slice(u,s)),null!=(i=Cg[r=e.charAt(++s)])?r=e.charAt(++s):i="e"===r?" ":"0",(o=t[r])&&(r=o(n,i)),a.push(r),u=s+1);return a.push(e.slice(u,s)),a.join("")}}function x(e,t){return function(n){var r,i,o=Sg(1900,void 0,1);if(S(o,e,n+="",0)!=n.length)return null;if("Q"in o)return new Date(o.Q);if("s"in o)return new Date(1e3*o.s+("L"in o?o.L:0));if(t&&!("Z"in o)&&(o.Z=0),"p"in o&&(o.H=o.H%12+12*o.p),void 0===o.m&&(o.m="q"in o?o.q:0),"V"in o){if(o.V<1||o.V>53)return null;"w"in o||(o.w=1),"Z"in o?(i=(r=xg(Sg(o.y,0,1))).getUTCDay(),r=i>4||0===i?pg.ceil(r):pg(r),r=fg.offset(r,7*(o.V-1)),o.y=r.getUTCFullYear(),o.m=r.getUTCMonth(),o.d=r.getUTCDate()+(o.w+6)%7):(i=(r=Ag(Sg(o.y,0,1))).getDay(),r=i>4||0===i?eg.ceil(r):eg(r),r=Qm.offset(r,7*(o.V-1)),o.y=r.getFullYear(),o.m=r.getMonth(),o.d=r.getDate()+(o.w+6)%7)}else("W"in o||"U"in o)&&("w"in o||(o.w="u"in o?o.u%7:"W"in o?1:0),i="Z"in o?xg(Sg(o.y,0,1)).getUTCDay():Ag(Sg(o.y,0,1)).getDay(),o.m=0,o.d="W"in o?(o.w+6)%7+7*o.W-(i+5)%7:o.w+7*o.U-(i+6)%7);return"Z"in o?(o.H+=o.Z/100|0,o.M+=o.Z%100,xg(o)):Ag(o)}}function S(e,t,n,r){for(var i,o,a=0,s=t.length,u=n.length;a<s;){if(r>=u)return-1;if(37===(i=t.charCodeAt(a++))){if(i=t.charAt(a++),!(o=b[i in Cg?t.charAt(a++):i])||(r=o(e,n,r))<0)return-1}else if(i!=n.charCodeAt(r++))return-1}return r}return y.x=A(n,y),y.X=A(r,y),y.c=A(t,y),E.x=A(n,E),E.X=A(r,E),E.c=A(t,E),{format:function(e){var t=A(e+="",y);return t.toString=function(){return e},t},parse:function(e){var t=x(e+="",!1);return t.toString=function(){return e},t},utcFormat:function(e){var t=A(e+="",E);return t.toString=function(){return e},t},utcParse:function(e){var t=x(e+="",!0);return t.toString=function(){return e},t}}}(e),Rg=Tg.format,Tg.parse,Tg.utcFormat,Tg.utcParse}({dateTime:"%x, %X",date:"%-m/%-d/%Y",time:"%-I:%M:%S %p",periods:["AM","PM"],days:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],shortDays:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],months:["January","February","March","April","May","June","July","August","September","October","November","December"],shortMonths:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]});var H_=1e3,X_=60*H_,W_=60*X_,Y_=24*W_,Z_=7*Y_,q_=30*Y_,K_=365*Y_;function Q_(e){return new Date(e)}function $_(e){return e instanceof Date?+e:+new Date(+e)}function J_(e,t,n,r,i,o,a,s,u){var c=im(Qv,Qv),l=c.invert,f=c.domain,h=u(".%L"),d=u(":%S"),p=u("%I:%M"),v=u("%I %p"),m=u("%a %d"),g=u("%b %d"),_=u("%B"),y=u("%Y"),E=[[a,1,H_],[a,5,5*H_],[a,15,15*H_],[a,30,30*H_],[o,1,X_],[o,5,5*X_],[o,15,15*X_],[o,30,30*X_],[i,1,W_],[i,3,3*W_],[i,6,6*W_],[i,12,12*W_],[r,1,Y_],[r,2,2*Y_],[n,1,Z_],[t,1,q_],[t,3,3*q_],[e,1,K_]];function b(s){return(a(s)<s?h:o(s)<s?d:i(s)<s?p:r(s)<s?v:t(s)<s?n(s)<s?m:g:e(s)<s?_:y)(s)}function A(t,n,r,i){if(null==t&&(t=10),"number"==typeof t){var o=Math.abs(r-n)/t,a=lv((function(e){return e[2]})).right(E,o);a===E.length?(i=yv(n/K_,r/K_,t),t=e):a?(i=(a=E[o/E[a-1][2]<E[a][2]/o?a-1:a])[1],t=a[0]):(i=Math.max(yv(n,r,t),1),t=s)}return null==i?t:t.every(i)}return c.invert=function(e){return new Date(l(e))},c.domain=function(e){return arguments.length?f(Xv.call(e,$_)):f().map(Q_)},c.ticks=function(e,t){var n,r=f(),i=r[0],o=r[r.length-1],a=o<i;return a&&(n=i,i=o,o=n),n=(n=A(e,i,o,t))?n.range(i,o+1):[],a?n.reverse():n},c.tickFormat=function(e,t){return null==t?b:u(t)},c.nice=function(e,t){var n=f();return(e=A(e,n[0],n[n.length-1],t))?f(Am(n,e)):c},c.copy=function(){return nm(c,J_(e,t,n,r,i,o,a,s,u))},c}function ey(e,t){return t.domain(e.domain()).interpolator(e.interpolator()).clamp(e.clamp()).unknown(e.unknown())}var ty=Ni.isNil,ny=Ni.isString,ry=Ni.uniq,iy=/^(?:(?!0000)[0-9]{4}([-/.]+)(?:(?:0?[1-9]|1[0-2])\1(?:0?[1-9]|1[0-9]|2[0-8])|(?:0?[13-9]|1[0-2])\1(?:29|30)|(?:0?[13578]|1[02])\1(?:31))|(?:[0-9]{2}(?:0[48]|[2468][048]|[13579][26])|(?:0[48]|[2468][048]|[13579][26])00)([-/.]?)0?2\2(?:29))(\s+([01]|([01][0-9]|2[0-3])):([0-9]|[0-5][0-9]):([0-9]|[0-5][0-9]))?$/,oy=(o(o(o(o(o(o(o(o(o(o(u={},Sc.LINEAR,(function e(){var t=im(Qv,Qv);return t.copy=function(){return nm(t,e())},Fv.apply(t,arguments),bm(t)})),Sc.POWER,(function e(){var t=Nm(rm());return t.copy=function(){return nm(t,e()).exponent(t.exponent())},Fv.apply(t,arguments),t})),Sc.LOG,(function e(){var t=wm(rm()).domain([1,10]);return t.copy=function(){return nm(t,e()).base(t.base())},Fv.apply(t,arguments),t})),Sc.IDENTITY,(function e(t){var n,r=[];function i(e){return null==e?n:e}return i.invert=i,i.domain=i.range=function(e){return e?(r=e,e):r},i.unknown=function(e){return e?(n=e,e):n},i.copy=function(){return e().unknown(n)},i})),Sc.SEQUENTIAL,(function e(){var t=bm(function(){var e,t,n,r,i,o=0,a=1,s=Qv,u=!1;function c(t){return isNaN(t=+t)?i:s(0===n?.5:(t=(r(t)-e)*n,u?Math.max(0,Math.min(1,t)):t))}return c.domain=function(i){return arguments.length?(e=r(o=+i[0]),t=r(a=+i[1]),n=e===t?0:1/(t-e),c):[o,a]},c.clamp=function(e){return arguments.length?(u=!!e,c):u},c.interpolator=function(e){return arguments.length?(s=e,c):s},c.unknown=function(e){return arguments.length?(i=e,c):i},function(i){return r=i,e=i(o),t=i(a),n=e===t?0:1/(t-e),c}}()(Qv));return t.copy=function(){return ey(t,e())},Bv.apply(t,arguments)})),Sc.TIME,(function(){return Fv.apply(J_(cg,sg,Jm,Qm,qm,Ym,Xm,Bm,Rg).domain([new Date(2e3,0,1),new Date(2e3,0,2)]),arguments)})),Sc.QUANTILE,(function e(){var t,n=[],r=[],i=[];function o(){var e=0,t=Math.max(1,r.length);for(i=new Array(t-1);++e<t;)i[e-1]=Ev(n,e/t);return a}function a(e){return isNaN(e=+e)?t:r[fv(i,e)]}return a.invertExtent=function(e){var t=r.indexOf(e);return t<0?[NaN,NaN]:[t>0?i[t-1]:n[0],t<i.length?i[t]:n[n.length-1]]},a.domain=function(e){if(!arguments.length)return n.slice();n=[];for(var t,r=0,i=e.length;r<i;++r)null==(t=e[r])||isNaN(t=+t)||n.push(t);return n.sort(cv),o()},a.range=function(e){return arguments.length?(r=Wv.call(e),o()):r.slice()},a.unknown=function(e){return arguments.length?(t=e,a):t},a.quantiles=function(){return i.slice()},a.copy=function(){return e().domain(n).range(r).unknown(t)},Fv.apply(a,arguments)})),Sc.QUANTIZE,(function e(){var t,n=0,r=1,i=1,o=[.5],a=[0,1];function s(e){return e<=e?a[fv(o,e,0,i)]:t}function u(){var e=-1;for(o=new Array(i);++e<i;)o[e]=((e+1)*r-(e-i)*n)/(i+1);return s}return s.domain=function(e){return arguments.length?(n=+e[0],r=+e[1],u()):[n,r]},s.range=function(e){return arguments.length?(i=(a=Wv.call(e)).length-1,u()):a.slice()},s.invertExtent=function(e){var t=a.indexOf(e);return t<0?[NaN,NaN]:t<1?[n,o[0]]:t>=i?[o[i-1],r]:[o[t-1],o[t]]},s.unknown=function(e){return arguments.length?(t=e,s):s},s.thresholds=function(){return o.slice()},s.copy=function(){return e().domain([n,r]).range(a).unknown(t)},Fv.apply(bm(s),arguments)})),Sc.THRESHOLD,(function e(){var t,n=[.5],r=[0,1],i=1;function o(e){return e<=e?r[fv(n,e,0,i)]:t}return o.domain=function(e){return arguments.length?(n=Wv.call(e),i=Math.min(n.length,r.length-1),o):n.slice()},o.range=function(e){return arguments.length?(r=Wv.call(e),i=Math.min(n.length,r.length-1),o):r.slice()},o.invertExtent=function(e){var t=r.indexOf(e);return[n[t-1],n[t]]},o.unknown=function(e){return arguments.length?(t=e,o):t},o.copy=function(){return e().domain(n).range(r).unknown(t)},Fv.apply(o,arguments)})),Sc.CAT,Zv),o(u,Sc.DIVERGING,(function e(){var t=bm(function(){var e,t,n,r,i,o,a,s=0,u=.5,c=1,l=Qv,f=!1;function h(e){return isNaN(e=+e)?a:(e=.5+((e=+o(e))-t)*(e<t?r:i),l(f?Math.max(0,Math.min(1,e)):e))}return h.domain=function(a){return arguments.length?(e=o(s=+a[0]),t=o(u=+a[1]),n=o(c=+a[2]),r=e===t?0:.5/(t-e),i=t===n?0:.5/(n-t),h):[s,u,c]},h.clamp=function(e){return arguments.length?(f=!!e,h):f},h.interpolator=function(e){return arguments.length?(l=e,h):l},h.unknown=function(e){return arguments.length?(a=e,h):a},function(a){return o=a,e=a(s),t=a(u),n=a(c),r=e===t?0:.5/(t-e),i=t===n?0:.5/(n-t),h}}()(Qv));return t.copy=function(){return ey(t,e())},Bv.apply(t,arguments)}))),ay=function(){return c((function e(){f(this,e),ne(this,"scaleOptions",{})}),[{key:"apply",value:function(e,t){var n=this,r=t.styleAttributeService,o=this;e.hooks.init.tapPromise("FeatureScalePlugin",ie(i().mark((function t(){var n,a,s;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e.log(dc,xc.INIT),o.scaleOptions=e.getScaleOptions(),a=r.getLayerStyleAttributes(),s=null===(n=e.getSource())||void 0===n?void 0:n.data.dataArray,!Array.isArray(s)||0!==s.length){t.next=8;break}return t.abrupt("return");case 8:o.caculateScalesForAttributes(a||[],s);case 9:e.log(pc,xc.INIT);case 10:case"end":return t.stop()}}),t)})))),e.hooks.beforeRenderData.tapPromise("FeatureScalePlugin",function(){var t=ie(i().mark((function t(n){var a,s;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n){t.next=2;break}return t.abrupt("return",n);case 2:if(e.log(dc,xc.UPDATE),o.scaleOptions=e.getScaleOptions(),a=r.getLayerStyleAttributes(),s=e.getSource().data.dataArray,!Array.isArray(s)||0!==s.length){t.next=8;break}return t.abrupt("return",!0);case 8:return o.caculateScalesForAttributes(a||[],s),e.log(pc,xc.UPDATE),e.layerModelNeedUpdate=!0,t.abrupt("return",!0);case 12:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()),e.hooks.beforeRender.tap("FeatureScalePlugin",(function(){if(!e.layerModelNeedUpdate){n.scaleOptions=e.getScaleOptions();var t=r.getLayerStyleAttributes(),i=e.getSource().data.dataArray;if((!Array.isArray(i)||0!==i.length)&&t){var o=t.filter((function(e){return e.needRescale}));o.length&&n.caculateScalesForAttributes(o,i)}}}))}},{key:"isNumber",value:function(e){return!isNaN(parseFloat(e))&&isFinite(e)}},{key:"caculateScalesForAttributes",value:function(e,t){var n=this;e.forEach((function(e){if(e.scale){var r=e.scale,i=e.scale.field;r.names=n.parseFields(ty(i)?[]:i);var o=[];r.names.forEach((function(r){var i;o.push(n.createScale(r,e.name,null===(i=e.scale)||void 0===i?void 0:i.values,t))})),o.some((function(e){return e.type===Tc.VARIABLE}))?(r.type=Tc.VARIABLE,o.forEach((function(e){var t,n;if(!r.callback&&"text"!==r.values)switch(null===(t=e.option)||void 0===t?void 0:t.type){case Sc.LOG:case Sc.LINEAR:case Sc.POWER:if(r.values&&r.values.length>2){var i=e.scale.ticks(r.values.length);e.scale.domain(i)}r.values?e.scale.range(r.values):e.scale.range(e.option.domain);break;case Sc.QUANTILE:case Sc.QUANTIZE:case Sc.THRESHOLD:e.scale.range(r.values);break;case Sc.IDENTITY:break;case Sc.CAT:r.values?e.scale.range(r.values):e.scale.range(e.option.domain);break;case Sc.DIVERGING:case Sc.SEQUENTIAL:e.scale.interpolator(Rv(r.values))}"text"===r.values&&e.scale.range(null===(n=e.option)||void 0===n?void 0:n.domain)}))):(r.type=Tc.CONSTANT,r.defaultValues=o.map((function(e,t){return e.scale(r.names[t])}))),r.scalers=o.map((function(e){return{field:e.field,func:e.scale,option:e.option}})),e.needRescale=!1}}))}},{key:"parseFields",value:function(e){return Array.isArray(e)?e:ny(e)?e.split("*"):[e]}},{key:"createScale",value:function(e,t,n,r){var i,o,a=this.scaleOptions[t]&&(null===(i=this.scaleOptions[t])||void 0===i?void 0:i.field)===e?this.scaleOptions[t]:this.scaleOptions[e],s={field:e,scale:void 0,type:Tc.VARIABLE,option:a};if(!r||!r.length)return a&&a.type?s.scale=this.createDefaultScale(a):(s.scale=Zv([e]),s.type=Tc.CONSTANT),s;var u=null===(o=r.find((function(t){return!ty(t[e])})))||void 0===o?void 0:o[e];if(this.isNumber(e)||ty(u)&&!a)s.scale=Zv([e]),s.type=Tc.CONSTANT;else{var c=a&&a.type||this.getDefaultType(u);"text"===n&&(c=Sc.CAT),void 0===n&&(c=Sc.IDENTITY);var l=this.createScaleConfig(c,e,a,r);s.scale=this.createDefaultScale(l),s.option=l}return s}},{key:"getDefaultType",value:function(e){var t=Sc.LINEAR;return"string"==typeof e&&(t=iy.test(e)?Sc.TIME:Sc.CAT),t}},{key:"createScaleConfig",value:function(e,t,n,r){var i={type:e},o=[];if(e===Sc.QUANTILE){var a=new Map;null==r||r.forEach((function(e){a.set(e._id,e[t])})),o=Array.from(a.values())}else o=(null==r?void 0:r.map((function(e){return e[t]})))||[];if(null!=n&&n.domain)i.domain=null==n?void 0:n.domain;else if(e===Sc.CAT||e===Sc.IDENTITY)i.domain=ry(o);else if(e===Sc.QUANTILE)i.domain=o;else if(e===Sc.DIVERGING){var s=dv(o),u=void 0!==(null==n?void 0:n.neutral)?null==n?void 0:n.neutral:(s[0]+s[1])/2;i.domain=[s[0],u,s[1]]}else i.domain=dv(o);return re(re({},i),n)}},{key:"createDefaultScale",value:function(e){var t=e.type,n=e.domain,r=e.unknown,i=e.clamp,o=e.nice,a=oy[t]();return n&&a.domain&&a.domain(n),r&&a.unknown(r),void 0!==i&&a.clamp&&a.clamp(i),void 0!==o&&a.nice&&a.nice(o),a}}])}(),sy=function(){return c((function e(){f(this,e)}),[{key:"apply",value:function(e){e.hooks.beforeRender.tap("LayerAnimateStylePlugin",(function(){e.animateStatus&&e.models.forEach((function(t){t.addUniforms(re({},e.layerModel.getAnimateUniforms()))}))}))}}])}(),uy=function(){return c((function e(){f(this,e)}),[{key:"apply",value:function(e){e.hooks.afterInit.tap("LayerMaskPlugin",(function(){var t=e.getLayerConfig(),n=t.maskLayers,r=t.enableMask;!e.tileLayer&&n&&n.length>0&&e.updateLayerConfig({mask:r})}))}}])}(),cy=function(){return c((function e(){f(this,e)}),[{key:"build",value:function(e){return ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.prepareBuildModel(),t.next=3,e.buildModels();case 3:case"end":return t.stop()}}),t)})))()}},{key:"initLayerModel",value:function(e){var t=this;return ie(i().mark((function n(){return i().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,t.build(e);case 2:e.styleNeedUpdate=!1;case 3:case"end":return n.stop()}}),n)})))()}},{key:"prepareLayerModel",value:function(e){var t=this;return ie(i().mark((function n(){return i().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,t.build(e);case 2:e.styleNeedUpdate=!1;case 3:case"end":return n.stop()}}),n)})))()}},{key:"apply",value:function(e){var t=this;e.hooks.init.tapPromise("LayerModelPlugin",ie(i().mark((function n(){return i().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!e.getSource().isTile){n.next=3;break}return e.prepareBuildModel(),n.abrupt("return");case 3:return e.log(gc,xc.INIT),n.next=6,t.initLayerModel(e);case 6:e.log(_c,xc.INIT);case 7:case"end":return n.stop()}}),n)})))),e.hooks.beforeRenderData.tapPromise("LayerModelPlugin",function(){var n=ie(i().mark((function n(r){return i().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(r){n.next=2;break}return n.abrupt("return",!1);case 2:if(!e.getSource().isTile){n.next=4;break}return n.abrupt("return",!1);case 4:return e.log(gc,xc.UPDATE),n.next=7,t.prepareLayerModel(e);case 7:return e.log(_c,xc.UPDATE),n.abrupt("return",!0);case 9:case"end":return n.stop()}}),n)})));return function(e){return n.apply(this,arguments)}}())}}])}(),ly=function(){return c((function e(){f(this,e)}),[{key:"apply",value:function(e){e.hooks.afterInit.tap("LayerStylePlugin",(function(){var t=e.getLayerConfig(),n=t.autoFit,r=t.fitBoundsOptions;n&&e.fitBounds(r),e.styleNeedUpdate=!1}))}}])}(),fy=["type"],hy={directional:{lights:"u_DirectionalLights",num:"u_NumOfDirectionalLights"},spot:{lights:"u_SpotLights",num:"u_NumOfSpotLights"}},dy={type:"directional",direction:[1,10.5,12],ambient:[.2,.2,.2],diffuse:[.6,.6,.6],specular:[.1,.1,.1]},py={direction:[0,0,0],ambient:[0,0,0],diffuse:[0,0,0],specular:[0,0,0]},vy={position:[0,0,0],direction:[0,0,0],ambient:[0,0,0],diffuse:[0,0,0],specular:[0,0,0],constant:1,linear:0,quadratic:0,angle:14,exponent:40,blur:5};var gy=function(){return c((function e(){f(this,e)}),[{key:"apply",value:function(e){e.hooks.beforeRender.tap("LightingPlugin",(function(){e.getLayerConfig().enableLighting&&e.models.forEach((function(e){return e.addUniforms(re({},(n={u_DirectionalLights:new Array(3).fill(re({},py)),u_NumOfDirectionalLights:0,u_SpotLights:new Array(3).fill(re({},vy)),u_NumOfSpotLights:0},t&&t.length||(t=[dy]),t.forEach((function(e){var t=e.type,r=void 0===t?"directional":t,i=oe(e,fy),o=hy[r].lights,a=hy[r].num,s=n[a];n[o][s]=re(re({},n[o][s]),i),n[a]++})),n)));var t,n}))}))}}])}();function _y(e){return e.map((function(e){return"string"==typeof e&&(e=[e,{}]),e}))}function yy(e,t,n,r){var i=e.multiPassRenderer;return e.getLayerConfig().enableTAA?i.add(r("taa")):i.add(r("render")),_y(t).forEach((function(e){var t=a(e,2),r=t[0],o=t[1];i.add(n(r),o)})),i.add(n("copy")),i}var Ey=function(){return c((function e(){f(this,e),ne(this,"enabled",void 0)}),[{key:"apply",value:function(e,t){var n=this,r=t.rendererService,i=t.postProcessingPassFactory,o=t.normalPassFactory;e.hooks.init.tapPromise("MultiPassRendererPlugin",(function(){var t=e.getLayerConfig(),r=t.enableMultiPassRenderer,a=t.passes,s=void 0===a?[]:a;n.enabled=!!r&&!1!==e.getLayerConfig().enableMultiPassRenderer,n.enabled&&(e.multiPassRenderer=yy(e,s,i,o),e.multiPassRenderer.setRenderFlag(!0))})),e.hooks.beforeRender.tap("MultiPassRendererPlugin",(function(){if(n.enabled){var t=r.getViewportSize(),i=t.width,o=t.height;e.multiPassRenderer.resize(i,o)}}))}}])}(),by=function(e){return e[e.POSITION=0]="POSITION",e[e.COLOR=1]="COLOR",e[e.VERTEX_ID=2]="VERTEX_ID",e[e.PICKING_COLOR=3]="PICKING_COLOR",e[e.STROKE=4]="STROKE",e[e.OPACITY=5]="OPACITY",e[e.OFFSETS=6]="OFFSETS",e[e.ROTATION=7]="ROTATION",e[e.EXTRUSION_BASE=8]="EXTRUSION_BASE",e[e.SIZE=9]="SIZE",e[e.SHAPE=10]="SHAPE",e[e.EXTRUDE=11]="EXTRUDE",e[e.MAX=12]="MAX",e[e.NORMAL=13]="NORMAL",e[e.UV=14]="UV",e[e.LINEAR=15]="LINEAR",e}({});var Ay=Ni.isNumber,xy=1,Sy=2,Ty=function(){return c((function e(){f(this,e),ne(this,"pickingUniformMap",void 0)}),[{key:"pickOption2Array",value:function(){var e=[];return this.pickingUniformMap.forEach((function(t){Ay(t)?e.push(t):e.push.apply(e,r(t))})),e}},{key:"updatePickOption",value:function(e,t){var n=this;Object.keys(e).forEach((function(t){n.pickingUniformMap.set(t,e[t])}));var r=t.getLayerConfig().pickingBuffer||0,i=Number(t.getShaderPickStat());this.pickingUniformMap.set("u_PickingBuffer",r),this.pickingUniformMap.set("u_shaderPick",i),t.getPickingUniformBuffer().subData({offset:0,data:this.pickOption2Array()})}},{key:"apply",value:function(e,t){var n=this,r=t.styleAttributeService;this.pickingUniformMap=new Map([["u_HighlightColor",[1,0,0,1]],["u_SelectColor",[1,0,0,1]],["u_PickingColor",[0,0,0]],["u_PickingStage",0],["u_CurrentSelectedId",[0,0,0]],["u_PickingThreshold",10],["u_PickingBuffer",0],["u_shaderPick",0],["u_activeMix",0]]),e.hooks.init.tapPromise("PixelPickingPlugin",(function(){var t=e.getLayerConfig().enablePicking;r.registerStyleAttribute({name:"pickingColor",type:Rc.Attribute,descriptor:{name:"a_PickingColor",shaderLocation:by.PICKING_COLOR,buffer:{data:[],type:Bu.FLOAT},size:3,update:function(e){var n=e.id;return t?Wt(n):[0,0,0]}}})})),e.hooks.beforePickingEncode.tap("PixelPickingPlugin",(function(){e.getLayerConfig().enablePicking&&e.isVisible()&&(n.updatePickOption({u_PickingStage:xy},e),e.models.forEach((function(e){return e.addUniforms({u_PickingStage:xy})})))})),e.hooks.afterPickingEncode.tap("PixelPickingPlugin",(function(){e.getLayerConfig().enablePicking&&e.isVisible()&&(n.updatePickOption({u_PickingStage:Sy},e),e.models.forEach((function(e){return e.addUniforms({u_PickingStage:Sy})})))})),e.hooks.beforeHighlight.tap("PixelPickingPlugin",(function(t){var r=e.getLayerConfig(),i=r.highlightColor,o=r.activeMix,a=void 0===o?0:o,s="string"==typeof i?Ht(i):i||[1,0,0,1];e.updateLayerConfig({pickedFeatureID:Xt(new Uint8Array(t))});var u={u_PickingStage:Sy,u_PickingColor:t,u_HighlightColor:s.map((function(e){return 255*e})),u_activeMix:a};n.updatePickOption(u,e),e.models.forEach((function(e){return e.addUniforms(u)}))})),e.hooks.beforeSelect.tap("PixelPickingPlugin",(function(t){var r=e.getLayerConfig(),i=r.selectColor,o=r.selectMix,a=void 0===o?0:o,s="string"==typeof i?Ht(i):i||[1,0,0,1];e.updateLayerConfig({pickedFeatureID:Xt(new Uint8Array(t))});var u={u_PickingStage:Sy,u_PickingColor:t,u_HighlightColor:s.map((function(e){return 255*e})),u_activeMix:a,u_CurrentSelectedId:t,u_SelectColor:s.map((function(e){return 255*e}))};n.updatePickOption(u,e),e.models.forEach((function(e){return e.addUniforms(u)}))}))}}])}(),Ry=["mvt","geojsonvt","testTile"];var Cy=function(){return c((function e(){f(this,e)}),[{key:"apply",value:function(e,t){var n=this,r=t.styleAttributeService;e.hooks.init.tapPromise("RegisterStyleAttributePlugin",(function(){(function(e){var t=e.getSource();return Ry.includes(t.parser.type)})(e)||n.registerBuiltinAttributes(r,e)}))}},{key:"registerBuiltinAttributes",value:function(e,t){"MaskLayer"!==t.type?(this.registerPositionAttribute(e),this.registerColorAttribute(e),this.registerVertexIdAttribute(e)):this.registerPositionAttribute(e)}},{key:"registerPositionAttribute",value:function(e){e.registerStyleAttribute({name:"position",type:Rc.Attribute,descriptor:{name:"a_Position",shaderLocation:by.POSITION,buffer:{data:[],type:Bu.FLOAT},size:3,update:function(e,t,n){return 2===n.length?[n[0],n[1],0]:[n[0],n[1],n[2]]}}})}},{key:"registerColorAttribute",value:function(e){e.registerStyleAttribute({name:"color",type:Rc.Attribute,descriptor:{name:"a_Color",shaderLocation:by.COLOR,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:4,update:function(e){var t=e.color;return t&&t.length?t:[1,1,1,1]}}})}},{key:"registerVertexIdAttribute",value:function(e){e.registerStyleAttribute({name:"vertexId",type:Rc.Attribute,descriptor:{name:"a_vertexId",shaderLocation:by.VERTEX_ID,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:1,update:function(e,t){return[t]}}})}}])}(),My=function(){return c((function e(){f(this,e),ne(this,"cameraService",void 0),ne(this,"coordinateSystemService",void 0),ne(this,"rendererService",void 0),ne(this,"mapService",void 0),ne(this,"layerService",void 0)}),[{key:"apply",value:function(e,t){var n=this,i=t.rendererService,o=t.mapService,a=t.layerService,s=t.coordinateSystemService,u=t.cameraService;this.rendererService=i,this.mapService=o,this.layerService=a,this.coordinateSystemService=s,this.cameraService=u;var c,l=this.mapService.version,f=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],h=[0,0];this.rendererService.uniformBuffers[0]||(c=this.rendererService.createBuffer({data:new Float32Array(92),isUBO:!0}),this.rendererService.uniformBuffers[0]=c),e.hooks.beforeRender.tap("ShaderUniformPlugin",(function(){var t=e.getLayerConfig().tileOrigin;(n.coordinateSystemService.refresh(t),"GAODE2.x"===l)&&(n.setLayerCenter(e),f=n.mapService.map.customCoords.getMVPMatrix(),h=n.mapService.getCustomCoordCenter(),e.getLayerUniformBuffer().subData({offset:0,data:new Uint8Array(new Float32Array([].concat(r(f),r(h))).buffer)}));var i=n.rendererService.getViewportSize(),o=i.width,a=i.height,s=n.generateUBO(f,h,o,a),u=s.data,c=s.uniforms;n.layerService.alreadyInRendering&&n.rendererService.uniformBuffers[0]&&n.rendererService.uniformBuffers[0].subData({offset:0,data:u});"WebGL1"===n.rendererService.queryVerdorInfo()&&e.models.forEach((function(t){t.addUniforms(re(re({},c),{},{u_PickingBuffer:e.getLayerConfig().pickingBuffer||0,u_shaderPick:Number(e.getShaderPickStat())}))}))}))}},{key:"setLayerCenter",value:function(e){void 0===e.coordCenter&&(e.coordCenter=e.getSource().center),this.mapService.setCoordCenter&&this.mapService.setCoordCenter(e.coordCenter)}},{key:"generateUBO",value:function(e,t,n,i){var a,s=this.cameraService.getProjectionMatrix(),u=this.cameraService.getViewMatrix(),c=this.cameraService.getViewProjectionMatrix(),l=this.cameraService.getModelMatrix(),f=this.coordinateSystemService.getViewportCenterProjection(),h=this.coordinateSystemService.getPixelsPerDegree(),d=this.cameraService.getZoom(),p=this.coordinateSystemService.getPixelsPerDegree2(),v=this.cameraService.getZoomScale(),m=this.coordinateSystemService.getPixelsPerMeter(),g=this.coordinateSystemService.getCoordinateSystem(),_=this.cameraService.getCameraPosition(),y=window.devicePixelRatio,E=this.coordinateSystemService.getViewportCenter(),b=[n,i],A=this.cameraService.getFocalDistance();return{data:[].concat(r(u),r(s),r(c),r(l),r(f),r(h),[d],r(p),[v],r(m),[g],r(_),[y],r(E),b,[A,0,0,0]),uniforms:(a={},o(o(o(o(o(o(o(o(o(o(a,Yu,s),Zu,u),qu,c),Ku,d),Qu,v),$u,A),Ju,_),nc,g),rc,E),ic,f),o(o(o(o(o(o(o(o(a,oc,h),ac,p),sc,m),uc,e),"u_sceneCenterMercator",t),"u_ViewportSize",b),"u_ModelMatrix",l),"u_DevicePixelRatio",y))}}}])}(),wy=function(){return c((function e(){f(this,e)}),[{key:"apply",value:function(e){e.hooks.beforeRender.tap("UpdateModelPlugin",(function(){e.layerModel&&e.layerModel.needUpdate().then((function(t){t&&e.renderLayers()}))})),e.hooks.afterRender.tap("UpdateModelPlugin",(function(){e.layerModelNeedUpdate=!1}))}}])}(),Ly=function(){return c((function e(){f(this,e)}),[{key:"apply",value:function(e,t){var n=this,r=t.styleAttributeService;e.hooks.init.tapPromise("UpdateStyleAttributePlugin",(function(){n.initStyleAttribute(e,{styleAttributeService:r})})),e.hooks.beforeRender.tap("UpdateStyleAttributePlugin",(function(){e.layerModelNeedUpdate||e.inited&&n.updateStyleAttribute(e,{styleAttributeService:r})}))}},{key:"updateStyleAttribute",value:function(e,t){var n=t.styleAttributeService,r=n.getLayerStyleAttributes()||[],i=n.getLayerStyleAttribute("filter");if(i&&i.needRegenerateVertices)return e.layerModelNeedUpdate=!0,void r.forEach((function(e){return e.needRegenerateVertices=!1}));r.filter((function(e){return e.needRegenerateVertices})).forEach((function(t){n.updateAttributeByFeatureRange(t.name,e.getEncodedData(),t.featureRange.startIndex,t.featureRange.endIndex,e),t.needRegenerateVertices=!1}))}},{key:"initStyleAttribute",value:function(e,t){var n=t.styleAttributeService;(n.getLayerStyleAttributes()||[]).filter((function(e){return e.needRegenerateVertices})).forEach((function(t){n.updateAttributeByFeatureRange(t.name,e.getEncodedData(),t.featureRange.startIndex,t.featureRange.endIndex),t.needRegenerateVertices=!1}))}}])}();var Oy=o(o(o(o(o(o({},Ec.additive,{enable:!0,func:{srcRGB:Bu.ONE,dstRGB:Bu.ONE,srcAlpha:1,dstAlpha:1}}),Ec.none,{enable:!1}),Ec.normal,{enable:!0,func:{srcRGB:Bu.SRC_ALPHA,dstRGB:Bu.ONE_MINUS_SRC_ALPHA,srcAlpha:1,dstAlpha:1}}),Ec.subtractive,{enable:!0,func:{srcRGB:Bu.ONE,dstRGB:Bu.ONE,srcAlpha:Bu.ZERO,dstAlpha:Bu.ONE_MINUS_SRC_COLOR},equation:{rgb:Bu.FUNC_SUBTRACT,alpha:Bu.FUNC_SUBTRACT}}),Ec.max,{enable:!0,func:{srcRGB:Bu.ONE,dstRGB:Bu.ONE},equation:{rgb:Bu.MAX_EXT}}),Ec.min,{enable:!0,func:{srcRGB:Bu.ONE,dstRGB:Bu.ONE},equation:{rgb:Bu.MIN_EXT}}),ky=function(){return c((function e(t){f(this,e),ne(this,"layer",void 0),this.layer=t}),[{key:"pickRender",value:function(e){var t=this.layer.getContainer().layerService,n=this.layer;if(n.tileLayer)return n.tileLayer.pickRender(e);n.hooks.beforePickingEncode.call(),t.renderTileLayerMask(n),n.renderModels({ispick:!0}),n.hooks.afterPickingEncode.call()}},{key:"pick",value:function(e,t){var n=this;return ie(i().mark((function r(){var o,a;return i().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(o=n.layer.getContainer(),a=o.pickingService,"RasterLayer"!==e.type){r.next=4;break}return r.abrupt("return",n.pickRasterLayer(e,t));case 4:return n.pickRender(t),r.abrupt("return",a.pickFromPickingFBO(e,t));case 6:case"end":return r.stop()}}),r)})))()}},{key:"pickRasterLayer",value:function(e,t,n){var r,i,o,s,u,c,l=this.layer.getContainer(),f=l.pickingService,h=l.mapService,d=this.layer.getSource().extent,p=(r=t.lngLat,i=a(d,4),o=i[0],s=i[1],u=i[2],c=i[3],r.lng>o&&r.lng<=u&&r.lat>s&&r.lat<=c),v={x:t.x,y:t.y,type:t.type,lngLat:t.lngLat,target:t,rasterValue:null},m=n||e;if(p){var g=this.readRasterValue(e,d,h,t.x,t.y);return v.rasterValue=g,f.triggerHoverOnLayer(m,v),!0}return v.type="mousemove"===t.type?"mouseout":"un"+t.type,f.triggerHoverOnLayer(m,re(re({},v),{},{type:"unpick"})),f.triggerHoverOnLayer(m,v),!1}},{key:"readRasterValue",value:function(e,t,n,r,i){var o=e.getSource().data.dataArray[0],s=a(t,4),u=s[0],c=void 0===u?0:u,l=s[1],f=void 0===l?0:l,h=s[2],d=void 0===h?10:h,p=s[3],v=void 0===p?-10:p,m=n.lngLatToContainer([c,f]),g=n.lngLatToContainer([d,v]),_=g.x-m.x,y=m.y-g.y,E=[(r-m.x)/_,(i-g.y)/y],b=o.width||1,A=o.height||1,x=Math.floor(E[0]*b),S=Math.floor(E[1]*A),T=Math.max(0,S-1)*b+x;return o.data[T]}},{key:"selectFeature",value:function(e){var t=this.layer,n=a(e,3),r=n[0],i=n[1],o=n[2];t.hooks.beforeSelect.call([r,i,o])}},{key:"highlightPickedFeature",value:function(e){var t=a(e,3),n=t[0],r=t[1],i=t[2];this.layer.hooks.beforeHighlight.call([n,r,i])}},{key:"getFeatureById",value:function(e){return this.layer.getSource().getFeatureById(e)}}])}(),Ny=function(){return c((function e(t){f(this,e),ne(this,"layer",void 0),ne(this,"rendererService",void 0),ne(this,"colorTexture",void 0),ne(this,"key",void 0),this.layer=t;var n=this.layer.getContainer();this.rendererService=n.rendererService}),[{key:"getColorTexture",value:function(e,t){var n=this.getTextureKey(e,t);return this.key===n||(this.createColorTexture(e,t),this.key=n),this.colorTexture}},{key:"createColorTexture",value:function(e,t){var n=this.rendererService.createTexture2D,r=this.getColorRampBar(e,t),i=n({data:new Uint8Array(r.data),width:r.width,height:r.height,flipY:!1,unorm:!0});return this.colorTexture=i,i}},{key:"setColorTexture",value:function(e,t,n){this.key=this.getTextureKey(t,n),this.colorTexture=e}},{key:"destroy",value:function(){var e;null===(e=this.colorTexture)||void 0===e||e.destroy()}},{key:"getColorRampBar",value:function(e,t){switch(e.type){case"cat":return function(e){var t=window.document.createElement("canvas"),n=t.getContext("2d");t.width=256,t.height=1;var r=n.createImageData(256,1);return r.data.fill(0),e.positions.forEach((function(t,n){var i=Ht(e.colors[n]);r.data[4*t+0]=255*i[0],r.data[4*t+1]=255*i[1],r.data[4*t+2]=255*i[2],r.data[4*t+3]=255*i[3]})),t=null,n=null,r}(e);case"quantize":return function(e){var t=window.document.createElement("canvas"),n=t.getContext("2d");n.globalAlpha=1,t.width=256,t.height=1;for(var r=256/e.colors.length,i=0;i<e.colors.length;i++)n.beginPath(),n.lineWidth=2,n.strokeStyle=e.colors[i],n.moveTo(i*r,0),n.lineTo((i+1)*r,0),n.stroke();var o=n.getImageData(0,0,256,1).data,a=Yt(n,o);return t=null,n=null,a}(e);case"custom":return function(e,t){var n=window.document.createElement("canvas"),r=n.getContext("2d");r.globalAlpha=1,n.width=256,n.height=1;var i=t[1]-t[0];e.positions.length-e.colors.length!=1&&console.warn("positions 的数字个数应当比 colors 的样式多一个,poisitions 的首尾值一般为数据的最大最新值");for(var o=0;o<e.colors.length;o++)r.beginPath(),r.lineWidth=2,r.strokeStyle=e.colors[o],r.moveTo((e.positions[o]-t[0])/i*255,0),r.lineTo((e.positions[o+1]-t[0])/i*255,0),r.stroke();var a=r.getImageData(0,0,256,1).data,s=Yt(r,a);return n=null,r=null,s}(e,t);case"linear":return function(e,t){var n=window.document.createElement("canvas"),r=n.getContext("2d");n.width=256,n.height=1;for(var i=r.createLinearGradient(0,0,256,1),o=t[1]-t[0],a=0;a<e.colors.length;++a){var s=Math.max((e.positions[a]-t[0])/o,0);i.addColorStop(s,e.colors[a])}r.fillStyle=i,r.fillRect(0,0,256,1);var u=r.getImageData(0,0,256,1).data,c=Yt(r,u);return n=null,r=null,c}(e,t);default:return function(e){var t=window.document.createElement("canvas"),n=t.getContext("2d");t.width=256,t.height=1;for(var r,i=n.createLinearGradient(0,0,256,1),o=e.positions[0],a=e.positions[e.positions.length-1],s=0;s<e.colors.length;++s){var u=(e.positions[s]-o)/(a-o);i.addColorStop(u,e.colors[s])}return n.fillStyle=i,n.fillRect(0,0,256,1),r=new Uint8ClampedArray(n.getImageData(0,0,256,1).data),t=null,n=null,{data:r,width:256,height:1}}(e)}}},{key:"getTextureKey",value:function(e,t){var n;return"".concat(e.colors.join("_"),"_").concat(null==e||null===(n=e.positions)||void 0===n?void 0:n.join("_"),"_").concat(e.type,"_").concat(null==t?void 0:t.join("_"))}}])}(),Iy=["passes"],Py=["moduleName","vertexShader","fragmentShader","inject","triangulation","styleOption","pickingEnabled"],Dy=Ni.isEqual,Fy=Ni.isFunction,By=Ni.isNumber,Uy=Ni.isObject,Gy=Ni.isPlainObject,zy=Ni.isUndefined,jy=0,Vy=function(e){function t(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return f(this,t),e=h(this,t),ne(e,"id","".concat(jy++)),ne(e,"name","".concat(jy)),ne(e,"parent",void 0),ne(e,"coordCenter",void 0),ne(e,"type",void 0),ne(e,"visible",!0),ne(e,"zIndex",0),ne(e,"minZoom",void 0),ne(e,"maxZoom",void 0),ne(e,"inited",!1),ne(e,"layerModelNeedUpdate",!1),ne(e,"pickedFeatureID",null),ne(e,"selectedFeatureID",null),ne(e,"styleNeedUpdate",!1),ne(e,"rendering",void 0),ne(e,"forceRender",!1),ne(e,"clusterZoom",0),ne(e,"layerType",void 0),ne(e,"triangulation",void 0),ne(e,"layerPickService",void 0),ne(e,"textureService",void 0),ne(e,"defaultSourceConfig",{data:[],options:{parser:{type:"json"}}}),ne(e,"dataState",{dataSourceNeedUpdate:!1,dataMappingNeedUpdate:!1,filterNeedUpdate:!1,featureScaleNeedUpdate:!1,StyleAttrNeedUpdate:!1}),ne(e,"hooks",{init:new If,afterInit:new kf,beforeRender:new kf,beforeRenderData:new Pf,afterRender:new Cf,beforePickingEncode:new Cf,afterPickingEncode:new Cf,beforeHighlight:new Cf(["pickedColor"]),afterHighlight:new Cf,beforeSelect:new Cf(["pickedColor"]),afterSelect:new Cf,beforeDestroy:new Cf,afterDestroy:new Cf}),ne(e,"models",[]),ne(e,"multiPassRenderer",void 0),ne(e,"plugins",void 0),ne(e,"startInit",!1),ne(e,"sourceOption",void 0),ne(e,"layerModel",void 0),ne(e,"shapeOption",void 0),ne(e,"tileLayer",void 0),ne(e,"layerChildren",[]),ne(e,"masks",[]),ne(e,"configService",jh),ne(e,"styleAttributeService",void 0),ne(e,"layerSource",void 0),ne(e,"postProcessingPassFactory",void 0),ne(e,"animateOptions",{enable:!1}),ne(e,"container",void 0),ne(e,"encodedData",void 0),ne(e,"currentPickId",null),ne(e,"rawConfig",void 0),ne(e,"needUpdateConfig",void 0),ne(e,"encodeStyleAttribute",{}),ne(e,"enableShaderEncodeStyles",[]),ne(e,"enableDataEncodeStyles",[]),ne(e,"pendingStyleAttributes",[]),ne(e,"scaleOptions",{}),ne(e,"animateStartTime",void 0),ne(e,"animateStatus",!1),ne(e,"isDestroyed",!1),ne(e,"uniformBuffers",[]),ne(e,"encodeDataLength",0),ne(e,"sourceEvent",(function(){e.dataState.dataSourceNeedUpdate=!0;var t=e.getLayerConfig();t&&t.autoFit&&e.fitBounds(t.fitBoundsOptions),e.layerSource.getSourceCfg().autoRender&&setTimeout((function(){e.reRender()}),10)})),e.name=n.name||e.id,e.zIndex=n.zIndex||0,e.rawConfig=n,e.masks=n.maskLayers||[],e}return d(t,e),c(t,[{key:"shaderModuleService",get:function(){return this.container.shaderModuleService}},{key:"cameraService",get:function(){return this.container.cameraService}},{key:"coordinateService",get:function(){return this.container.coordinateSystemService}},{key:"iconService",get:function(){return this.container.iconService}},{key:"fontService",get:function(){return this.container.fontService}},{key:"pickingService",get:function(){return this.container.pickingService}},{key:"rendererService",get:function(){return this.container.rendererService}},{key:"layerService",get:function(){return this.container.layerService}},{key:"debugService",get:function(){return this.container.debugService}},{key:"interactionService",get:function(){return this.container.interactionService}},{key:"mapService",get:function(){return this.container.mapService}},{key:"normalPassFactory",get:function(){return this.container.normalPassFactory}},{key:"addMask",value:function(e){this.masks.push(e),this.updateLayerConfig({maskLayers:this.masks}),this.enableMask()}},{key:"removeMask",value:function(e){var t=this.masks.indexOf(e);t>-1&&this.masks.splice(t,1),this.updateLayerConfig({maskLayers:this.masks})}},{key:"disableMask",value:function(){this.updateLayerConfig({enableMask:!1})}},{key:"enableMask",value:function(){this.updateLayerConfig({enableMask:!0})}},{key:"addMaskLayer",value:function(e){this.masks.push(e)}},{key:"removeMaskLayer",value:function(e){var t=this.masks.indexOf(e);t>-1&&this.masks.splice(t,1),e.destroy()}},{key:"getAttribute",value:function(e){return this.styleAttributeService.getLayerStyleAttribute(e)}},{key:"getLayerConfig",value:function(){return this.configService.getLayerConfig(this.id)}},{key:"updateLayerConfig",value:function(e){var t=this;if(Object.keys(e).map((function(n){n in t.rawConfig&&(t.rawConfig[n]=e[n])})),this.startInit){var n=this.container.id;this.configService.setLayerConfig(n,this.id,re(re(re({},this.configService.getLayerConfig(this.id)),this.needUpdateConfig),e)),this.needUpdateConfig={}}else this.needUpdateConfig=re(re({},this.needUpdateConfig),e)}},{key:"setContainer",value:function(e){this.container=e}},{key:"getContainer",value:function(){return this.container}},{key:"addPlugin",value:function(e){return this.plugins.push(e),this}},{key:"init",value:function(){var e=this;return ie(i().mark((function t(){var n,r,o,a,s,u;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:n=e.container.id,e.startInit=!0,e.configService.setLayerConfig(n,e.id,e.rawConfig),e.layerType=e.rawConfig.layerType,r=e.getLayerConfig(),o=r.enableMultiPassRenderer,a=r.passes,o&&null!=a&&a.length&&a.length>0&&e.mapService.on("mapAfterFrameChange",(function(){e.renderLayers()})),e.postProcessingPassFactory=e.container.postProcessingPassFactory,e.styleAttributeService=e.container.styleAttributeService,o&&(e.multiPassRenderer=e.container.multiPassRenderer,e.multiPassRenderer.setLayer(e)),e.pendingStyleAttributes.forEach((function(t){var n=t.attributeName,r=t.attributeField,i=t.attributeValues,o=t.updateOptions;e.styleAttributeService.updateStyleAttribute(n,{scale:re({field:r},e.splitValuesAndCallbackInAttribute(i,r?void 0:e.getLayerConfig()[n]))},o)})),e.pendingStyleAttributes=[],e.plugins=[new uv,new Cy,new ay,new sv,new ly,new uy,new Ly,new wy,new Ey,new My,new sy,new gy,new Ty,new cy],s=y(e.plugins);try{for(s.s();!(u=s.n()).done;)u.value.apply(e,e.container)}catch(i){s.e(i)}finally{s.f()}return e.layerPickService=new ky(e),e.textureService=new Ny(e),e.log(cc),t.next=19,e.hooks.init.promise();case 19:e.log(lc),e.inited=!0,e.emit("inited",{target:e,type:"inited"}),e.emit("add",{target:e,type:"add"}),e.hooks.afterInit.call();case 24:case"end":return t.stop()}}),t)})))()}},{key:"log",value:function(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"init";if(!this.tileLayer&&!this.isTileLayer){var r="".concat(this.id,".").concat(n,".").concat(e),i={id:this.id,type:this.type};null===(t=this.debugService)||void 0===t||t.log(r,i)}}},{key:"updateModelData",value:function(e){e.attributes&&e.elements?this.models.map((function(t){t.updateAttributesAndElements(e.attributes,e.elements)})):console.warn("data error")}},{key:"setLayerPickService",value:function(e){this.layerPickService=e}},{key:"prepareBuildModel",value:function(){0!==Object.keys(this.needUpdateConfig||{}).length&&this.updateLayerConfig({});var e=this.getLayerConfig().animateOption;null!=e&&e.enable&&(this.layerService.startAnimate(),this.animateStatus=!0)}},{key:"color",value:function(e,t,n){return this.updateStyleAttribute("color",e,t,n),this}},{key:"texture",value:function(e,t,n){return this.updateStyleAttribute("texture",e,t,n),this}},{key:"rotate",value:function(e,t,n){return this.updateStyleAttribute("rotate",e,t,n),this}},{key:"size",value:function(e,t,n){return this.updateStyleAttribute("size",e,t,n),this}},{key:"filter",value:function(e,t,n){var r=this.updateStyleAttribute("filter",e,t,n);return this.dataState.dataSourceNeedUpdate=r&&this.inited,this}},{key:"shape",value:function(e,t,n){this.shapeOption={field:e,values:t};var r=this.updateStyleAttribute("shape",e,t,n);return this.dataState.dataSourceNeedUpdate=r&&this.inited,this}},{key:"label",value:function(e,t,n){return this.pendingStyleAttributes.push({attributeName:"label",attributeField:e,attributeValues:t,updateOptions:n}),this}},{key:"animate",value:function(e){var t={};return Uy(e)?(t.enable=!0,t=re(re({},t),e)):t.enable=e,this.updateLayerConfig({animateOption:t}),this}},{key:"source",value:function(e,t){return"source"===(null==e?void 0:e.type)?(this.setSource(e),this):(this.sourceOption={data:e,options:t},this.clusterZoom=0,this)}},{key:"setData",value:function(e,t){var n=this;return this.inited?(this.dataUpdatelog(),this.layerSource.setData(e,t)):this.on("inited",(function(){n.dataUpdatelog(),n.layerSource.setData(e,t)})),this}},{key:"dataUpdatelog",value:function(){var e=this;this.log(fc,xc.UPDATE),this.layerSource.once("update",(function(){e.log(hc,xc.UPDATE)}))}},{key:"style",value:function(e){var t=this,n=e.passes,r=oe(e,Iy);n&&_y(n).forEach((function(e){var n=t.multiPassRenderer.getPostProcessor().getPostProcessingPassByName(e[0]);n&&n.updateOptions(e[1])})),r.borderColor&&(r.stroke=r.borderColor),r.borderWidth&&(r.strokeWidth=r.borderWidth);var i=r;return Object.keys(r).forEach((function(e){var t=r[e];!Array.isArray(t)||2!==t.length||By(t[0])||By(t[1])||(i[e]={field:t[0],value:t[1]})})),this.encodeStyle(i),this.updateLayerConfig(i),this}},{key:"encodeStyle",value:function(e){var t=this;Object.keys(e).forEach((function(n){[].concat(r(t.enableShaderEncodeStyles),r(t.enableDataEncodeStyles)).includes(n)&&Gy(e[n])&&(e[n].field||e[n].value)&&!Dy(t.encodeStyleAttribute[n],e[n])?(t.encodeStyleAttribute[n]=e[n],t.updateStyleAttribute(n,e[n].field,e[n].value),t.inited&&(t.dataState.dataMappingNeedUpdate=!0)):t.encodeStyleAttribute[n]&&(delete t.encodeStyleAttribute[n],t.dataState.dataSourceNeedUpdate=!0)}))}},{key:"scale",value:function(e,t){var n=re({},this.scaleOptions);if(Uy(e)?this.scaleOptions=re(re({},this.scaleOptions),e):this.scaleOptions[e]=t,this.styleAttributeService&&!Dy(n,this.scaleOptions)){var r=Uy(e)?e:o({},e,t);this.styleAttributeService.updateScaleAttribute(r)}return this}},{key:"renderLayers",value:function(){this.rendering=!0,this.layerService.reRender(),this.rendering=!1}},{key:"prerender",value:function(){}},{key:"render",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.tileLayer?(this.tileLayer.render(),this):(this.layerService.beforeRenderData(this),this.encodeDataLength<=0&&!this.forceRender||this.renderModels(e),this)}},{key:"renderMultiPass",value:function(){var e=this;return ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!(e.encodeDataLength<=0)||e.forceRender){t.next=2;break}return t.abrupt("return");case 2:if(!e.multiPassRenderer||!e.multiPassRenderer.getRenderFlag()){t.next=7;break}return t.next=5,e.multiPassRenderer.render();case 5:t.next=8;break;case 7:e.multiPassRenderer,e.renderModels();case 8:case"end":return t.stop()}}),t)})))()}},{key:"active",value:function(e){var t={};return t.enableHighlight=!!Uy(e)||e,Uy(e)?(t.enableHighlight=!0,e.color&&(t.highlightColor=e.color),e.mix&&(t.activeMix=e.mix)):t.enableHighlight=!!e,this.updateLayerConfig(t),this}},{key:"setActive",value:function(e,t){var n=this;if(Uy(e)){var r=e.x,i=void 0===r?0:r,o=e.y,a=void 0===o?0:o;this.updateLayerConfig({highlightColor:Uy(t)?t.color:this.getLayerConfig().highlightColor,activeMix:Uy(t)?t.mix:this.getLayerConfig().activeMix}),this.pick({x:i,y:a})}else this.updateLayerConfig({pickedFeatureID:e,highlightColor:Uy(t)?t.color:this.getLayerConfig().highlightColor,activeMix:Uy(t)?t.mix:this.getLayerConfig().activeMix}),this.hooks.beforeHighlight.call(Wt(e)).then((function(){setTimeout((function(){n.reRender()}),1)}))}},{key:"select",value:function(e){var t={};return t.enableSelect=!!Uy(e)||e,Uy(e)?(t.enableSelect=!0,e.color&&(t.selectColor=e.color),e.mix&&(t.selectMix=e.mix)):t.enableSelect=!!e,this.updateLayerConfig(t),this}},{key:"setSelect",value:function(e,t){var n=this;if(Uy(e)){var r=e.x,i=void 0===r?0:r,o=e.y,a=void 0===o?0:o;this.updateLayerConfig({selectColor:Uy(t)?t.color:this.getLayerConfig().selectColor,selectMix:Uy(t)?t.mix:this.getLayerConfig().selectMix}),this.pick({x:i,y:a})}else this.updateLayerConfig({pickedFeatureID:e,selectColor:Uy(t)?t.color:this.getLayerConfig().selectColor,selectMix:Uy(t)?t.mix:this.getLayerConfig().selectMix}),this.hooks.beforeSelect.call(Wt(e)).then((function(){setTimeout((function(){n.reRender()}),1)}))}},{key:"setBlend",value:function(e){return this.updateLayerConfig({blend:e}),this.reRender(),this}},{key:"show",value:function(){return this.updateLayerConfig({visible:!0}),this.reRender(),this.emit("show"),this}},{key:"hide",value:function(){return this.updateLayerConfig({visible:!1}),this.reRender(),this.emit("hide"),this}},{key:"setIndex",value:function(e){return this.zIndex=e,this.layerService.updateLayerRenderList(),this.layerService.renderLayers(),this}},{key:"setCurrentPickId",value:function(e){this.currentPickId=e}},{key:"getCurrentPickId",value:function(){return this.currentPickId}},{key:"setCurrentSelectedId",value:function(e){this.selectedFeatureID=e}},{key:"getCurrentSelectedId",value:function(){return this.selectedFeatureID}},{key:"isVisible",value:function(){var e=this.mapService.getZoom(),t=this.getLayerConfig(),n=t.visible,r=t.minZoom,i=void 0===r?-1/0:r,o=t.maxZoom;return!!n&&e>=i&&e<(void 0===o?1/0:o)}},{key:"setMultiPass",value:function(e,t){if(this.updateLayerConfig({enableMultiPassRenderer:e}),t&&this.updateLayerConfig({passes:t}),e){var n=this.getLayerConfig().passes,r=void 0===n?[]:n;this.multiPassRenderer=yy(this,r,this.postProcessingPassFactory,this.normalPassFactory),this.multiPassRenderer.setRenderFlag(!0);var i=this.rendererService.getViewportSize(),o=i.width,a=i.height;this.multiPassRenderer.resize(o,a)}return this}},{key:"setMinZoom",value:function(e){return this.updateLayerConfig({minZoom:e}),this}},{key:"getMinZoom",value:function(){return this.getLayerConfig().minZoom}},{key:"getMaxZoom",value:function(){return this.getLayerConfig().maxZoom}},{key:"get",value:function(e){return this.getLayerConfig()[e]}},{key:"setMaxZoom",value:function(e){return this.updateLayerConfig({maxZoom:e}),this}},{key:"setAutoFit",value:function(e){return this.updateLayerConfig({autoFit:e}),this}},{key:"fitBounds",value:function(e){if(!this.inited)return this.updateLayerConfig({autoFit:!0}),this;var t=this.getSource().extent;return t.some((function(e){return Math.abs(e)===1/0}))||this.mapService.fitBounds([[t[0],t[1]],[t[2],t[3]]],e),this}},{key:"destroy",value:function(){var e,t,n,r,i,o=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.isDestroyed||(null===(e=this.layerModel)||void 0===e||e.uniformBuffers.forEach((function(e){e.destroy()})),this.layerChildren.map((function(e){return e.destroy(!1)})),this.layerChildren=[],this.getLayerConfig().maskfence&&(this.masks.map((function(e){return e.destroy(!1)})),this.masks=[]),this.hooks.beforeDestroy.call(),this.layerSource.off("update",this.sourceEvent),null===(t=this.multiPassRenderer)||void 0===t||t.destroy(),this.textureService.destroy(),this.styleAttributeService.clearAllAttributes(),this.hooks.afterDestroy.call(),null===(n=this.layerModel)||void 0===n||n.clearModels(o),null===(r=this.tileLayer)||void 0===r||r.destroy(),this.models=[],null===(i=this.debugService)||void 0===i||i.removeLog(this.id),this.emit("remove",{target:this,type:"remove"}),this.emit("destroy",{target:this,type:"destroy"}),this.removeAllListeners(),this.isDestroyed=!0)}},{key:"clear",value:function(){this.styleAttributeService.clearAllAttributes()}},{key:"clearModels",value:function(){var e;this.models.forEach((function(e){return e.destroy()})),null===(e=this.layerModel)||void 0===e||e.clearModels(),this.models=[]}},{key:"isDirty",value:function(){return!!(this.styleAttributeService.getLayerStyleAttributes()||[]).filter((function(e){return e.needRescale||e.needRemapping||e.needRegenerateVertices})).length}},{key:"setSource",value:function(e){var t=this;if(this.layerSource&&this.layerSource.off("update",this.sourceEvent),this.layerSource=e,this.clusterZoom=0,this.inited&&this.layerSource.cluster){var n=this.mapService.getZoom();this.layerSource.updateClusterData(n)}this.layerSource.inited&&this.sourceEvent(),this.layerSource.on("update",(function(e){var n=e.type;if(void 0===t.coordCenter){var r,i=t.layerSource.center;t.coordCenter=i,null!==(r=t.mapService)&&void 0!==r&&r.setCoordCenter&&t.mapService.setCoordCenter(i)}if("update"===n){if(t.tileLayer)return void t.tileLayer.reload();t.sourceEvent()}}))}},{key:"getSource",value:function(){return this.layerSource}},{key:"getScaleOptions",value:function(){return this.scaleOptions}},{key:"setEncodedData",value:function(e){this.encodedData=e,this.encodeDataLength=e.length}},{key:"getEncodedData",value:function(){return this.encodedData}},{key:"getScale",value:function(e){return this.styleAttributeService.getLayerAttributeScale(e)}},{key:"getLegend",value:function(e){var t,n,r,i=this.styleAttributeService.getLayerStyleAttribute(e);return{type:null===(n=((null==i||null===(t=i.scale)||void 0===t?void 0:t.scalers)||[])[0])||void 0===n||null===(n=n.option)||void 0===n?void 0:n.type,field:null==i||null===(r=i.scale)||void 0===r?void 0:r.field,items:this.getLegendItems(e)}}},{key:"getLegendItems",value:function(e){var t=this.styleAttributeService.getLayerAttributeScale(e);return t?t.invertExtent?t.range().map((function(n){return o({value:t.invertExtent(n)},e,n)})):t.ticks?t.ticks().map((function(n){return o({value:n},e,t(n))})):null!=t&&t.domain?t.domain().filter((function(e){return!zy(e)})).map((function(n){return o({value:n},e,t(n))})):[]:[]}},{key:"pick",value:function(e){var t=e.x,n=e.y;this.interactionService.triggerHover({x:t,y:n})}},{key:"boxSelect",value:function(e,t){this.pickingService.boxPickLayer(this,e,t)}},{key:"buildLayerModel",value:function(e){var t=this;return ie(i().mark((function n(){var o,a,s,u,c,l,f,h,d,p,v,m,g,_;return i().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return o=e.moduleName,a=e.vertexShader,s=e.fragmentShader,u=e.inject,c=e.triangulation,l=e.styleOption,f=e.pickingEnabled,h=void 0===f||f,d=oe(e,Py),t.shaderModuleService.registerModule(o,{vs:a,fs:s,inject:u}),p=t.shaderModuleService.getModule(o),v=p.vs,m=p.fs,g=p.uniforms,_=t.rendererService.createModel,n.abrupt("return",new Promise((function(e){var n=t.styleAttributeService.createAttributesAndIndices(t.encodedData,c,l,t),i=n.attributes,o=n.elements,a=n.count,s=[].concat(r(t.layerModel.uniformBuffers),r(t.rendererService.uniformBuffers),[t.getLayerUniformBuffer()]);h&&s.push(t.getPickingUniformBuffer());var u=re({attributes:i,uniforms:g,fs:m,vs:v,elements:o,blend:Oy[Ec.normal],uniformBuffers:s,textures:t.layerModel.textures},d);a&&(u.count=a),e(_(u))})));case 5:case"end":return n.stop()}}),n)})))()}},{key:"createAttributes",value:function(e){var t=e.triangulation;return this.styleAttributeService.createAttributes(this.encodedData,t).attributes}},{key:"getTime",value:function(){return this.layerService.clock.getDelta()}},{key:"setAnimateStartTime",value:function(){this.animateStartTime=this.layerService.clock.getElapsedTime()}},{key:"stopAnimate",value:function(){this.animateStatus&&(this.layerService.stopAnimate(),this.animateStatus=!1,this.updateLayerConfig({animateOption:{enable:!1}}))}},{key:"getLayerAnimateTime",value:function(){return this.layerService.clock.getElapsedTime()-this.animateStartTime}},{key:"needPick",value:function(e){var t=this.getLayerConfig(),n=t.enableHighlight,r=void 0===n||n,i=t.enableSelect,o=void 0===i||i,a=-1!==this.eventNames().indexOf(e)||-1!==this.eventNames().indexOf("un"+e);return"click"!==e&&"dblclick"!==e||!o||(a=!0),"mousemove"!==e||!r&&-1===this.eventNames().indexOf("mouseenter")&&-1===this.eventNames().indexOf("unmousemove")&&-1===this.eventNames().indexOf("mouseout")||(a=!0),this.isVisible()&&a}},{key:"buildModels",value:function(){return ie(i().mark((function e(){return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Method not implemented.");case 1:case"end":return e.stop()}}),e)})))()}},{key:"rebuildModels",value:function(){var e=this;return ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.buildModels();case 2:case"end":return t.stop()}}),t)})))()}},{key:"renderMulPass",value:function(e){return ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.render();case 2:case"end":return t.stop()}}),t)})))()}},{key:"renderModels",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.encodeDataLength<=0&&!this.forceRender?(this.clearModels(),this):(this.hooks.beforeRender.call(),this.models.forEach((function(n){n.draw({uniforms:e.layerModel.getUninforms(),blend:e.layerModel.getBlend(),stencil:e.layerModel.getStencil(t),textures:e.layerModel.textures},(null==t?void 0:t.ispick)||!1)})),this.hooks.afterRender.call(),this)}},{key:"updateStyleAttribute",value:function(e,t,n,r){var i=this.configService.getAttributeConfig(this.id)||{};return!Dy(i[e],{field:t,values:n})&&(-1!==["color","size","texture","rotate","filter","label","shape"].indexOf(e)&&this.configService.setAttributeConfig(this.id,o({},e,{field:t,values:n})),this.startInit?this.styleAttributeService.updateStyleAttribute(e,{scale:re({field:t},this.splitValuesAndCallbackInAttribute(n,this.getLayerConfig()[t]))},r):this.pendingStyleAttributes.push({attributeName:e,attributeField:t,attributeValues:n,updateOptions:r}),!0)}},{key:"getLayerAttributeConfig",value:function(){return this.configService.getAttributeConfig(this.id)}},{key:"getShaderPickStat",value:function(){return this.layerService.getShaderPickStat()}},{key:"setEarthTime",value:function(e){console.warn("empty fn")}},{key:"processData",value:function(e){return e}},{key:"getModelType",value:function(){throw new Error("Method not implemented.")}},{key:"getDefaultConfig",value:function(){return{}}},{key:"initLayerModels",value:function(){var e=this;return ie(i().mark((function t(){var n,r;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.models.forEach((function(e){return e.destroy()})),e.models=[],e.uniformBuffers.forEach((function(e){e.destroy()})),e.uniformBuffers=[],n=e.rendererService.createBuffer({data:new Float32Array(20).fill(0),isUBO:!0}),e.uniformBuffers.push(n),r=e.rendererService.createBuffer({data:new Float32Array(20).fill(0),isUBO:!0}),e.uniformBuffers.push(r),t.next=10,e.layerModel.initModels();case 10:e.models=t.sent;case 11:case"end":return t.stop()}}),t)})))()}},{key:"getLayerUniformBuffer",value:function(){return this.uniformBuffers[0]}},{key:"getPickingUniformBuffer",value:function(){return this.uniformBuffers[1]}},{key:"reRender",value:function(){this.inited&&this.layerService.reRender()}},{key:"splitValuesAndCallbackInAttribute",value:function(e){return{values:Fy(e)?void 0:e,callback:Fy(e)?e:void 0}}}])}(lo.exports.EventEmitter);function Hy(e){return e.maskOperation===Ac.OR?{enable:!0,mask:255,func:{cmp:Bu.ALWAYS,ref:1,mask:255},opFront:{fail:Bu.KEEP,zfail:Bu.REPLACE,zpass:Bu.REPLACE}}:{enable:!0,mask:255,func:{cmp:e.stencilType===bc.SINGLE||0===e.stencilIndex?Bu.ALWAYS:Bu.LESS,ref:e.stencilType===bc.SINGLE?1:0===e.stencilIndex?2:1,mask:255},opFront:{fail:Bu.KEEP,zfail:Bu.REPLACE,zpass:Bu.REPLACE}}}var Xy={opacity:1,stroke:[1,0,0,1],offsets:[0,0],rotation:0,extrusionBase:0,strokeOpacity:1,thetaOffset:.314},Wy={opacity:"float",stroke:"vec4",offsets:"vec2",textOffset:"vec2",rotation:"float",extrusionBase:"float",strokeOpacity:"float",thetaOffset:"float"};function Yy(e){return Math.max(4*Math.ceil(e/4),4)}var Zy={opacity:by.OPACITY,stroke:by.STROKE,offsets:by.OFFSETS,rotation:by.ROTATION,extrusionBase:by.EXTRUSION_BASE,thetaOffset:15},qy=function(){return c((function e(t){f(this,e),ne(this,"triangulation",void 0),ne(this,"uniformBuffers",[]),ne(this,"textures",[]),ne(this,"createTexture2D",void 0),ne(this,"preStyleAttribute",{}),ne(this,"encodeStyleAttribute",{}),ne(this,"layer",void 0),ne(this,"dataTexture",void 0),ne(this,"DATA_TEXTURE_WIDTH",void 0),ne(this,"dataTextureTest",void 0),ne(this,"configService",void 0),ne(this,"shaderModuleService",void 0),ne(this,"rendererService",void 0),ne(this,"iconService",void 0),ne(this,"fontService",void 0),ne(this,"styleAttributeService",void 0),ne(this,"mapService",void 0),ne(this,"cameraService",void 0),ne(this,"layerService",void 0),ne(this,"pickingService",void 0),ne(this,"attributeUnifoms",void 0),ne(this,"commonUnifoms",void 0),this.layer=t,this.configService=t.getContainer().globalConfigService,this.rendererService=t.getContainer().rendererService,this.pickingService=t.getContainer().pickingService,this.shaderModuleService=t.getContainer().shaderModuleService,this.styleAttributeService=t.getContainer().styleAttributeService,this.mapService=t.getContainer().mapService,this.iconService=t.getContainer().iconService,this.fontService=t.getContainer().fontService,this.cameraService=t.getContainer().cameraService,this.layerService=t.getContainer().layerService,this.registerStyleAttribute(),this.registerBuiltinAttributes(),this.startModelAnimate();var n=this.rendererService.createTexture2D;this.createTexture2D=n}),[{key:"getBlend",value:function(){var e=this.layer.getLayerConfig().blend;return Oy[Ec[void 0===e?"normal":e]]}},{key:"getStencil",value:function(e){var t=this.layer.getLayerConfig(),n=t.mask,r=void 0!==n&&n,i=t.maskInside,o=void 0===i||i,a=t.enableMask,s=t.maskOperation,u=void 0===s?Ac.AND:s;return"MaskLayer"===this.layer.type?Hy({isStencil:!0,stencilType:bc.SINGLE}):e.isStencil?Hy(re(re({},e),{},{maskOperation:u})):function(e,t){return{enable:e,mask:255,func:{cmp:Bu.EQUAL,ref:t?1:0,mask:1}}}(r||a&&0!==this.layer.masks.length||void 0!==this.layer.tileMask,o)}},{key:"getDefaultStyle",value:function(){return{}}},{key:"getUninforms",value:function(){var e=this.getCommonUniformsInfo(),t=this.getUniformsBufferInfo(this.getStyleAttribute());this.updateStyleUnifoms();var n=re(re({},t.uniformsOption),e.uniformsOption);return Object.keys(n).forEach((function(e){"boolean"==typeof n[e]&&(n[e]=n[e]?1:0)})),!this.rendererService.hasOwnProperty("device")&&this.textures&&1===this.textures.length&&(n.u_texture=this.textures[0]),n}},{key:"getAnimateUniforms",value:function(){return{}}},{key:"needUpdate",value:function(){return ie(i().mark((function e(){return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.abrupt("return",!1);case 1:case"end":return e.stop()}}),e)})))()}},{key:"buildModels",value:function(){return ie(i().mark((function e(){return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Method not implemented.");case 1:case"end":return e.stop()}}),e)})))()}},{key:"initModels",value:function(){return ie(i().mark((function e(){return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:throw new Error("Method not implemented.");case 1:case"end":return e.stop()}}),e)})))()}},{key:"clearModels",value:function(){}},{key:"getAttribute",value:function(){throw new Error("Method not implemented.")}},{key:"prerender",value:function(){}},{key:"render",value:function(e){throw new Error("Method not implemented.")}},{key:"registerBuiltinAttributes",value:function(){throw new Error("Method not implemented.")}},{key:"animateOption2Array",value:function(e){return[e.enable?0:1,e.duration||4,e.interval||.2,e.trailLength||.1]}},{key:"startModelAnimate",value:function(){this.layer.getLayerConfig().animateOption.enable&&this.layer.setAnimateStartTime()}},{key:"getInject",value:function(){var e=this.layer.encodeStyleAttribute,t="",n=[];this.layer.enableShaderEncodeStyles.forEach((function(r){e[r]?t+="#define USE_ATTRIBUTE_".concat(r.toUpperCase()," 0.0; \n\n"):n.push("  ".concat(Wy[r]," u_").concat(r,";")),t+="\n          #ifdef USE_ATTRIBUTE_".concat(r.toUpperCase(),"\n          layout(location = ").concat(Zy[r],") in ").concat(Wy[r]," a_").concat(r.charAt(0).toUpperCase()+r.slice(1),";\n        #endif\n\n        ")}));var r=n.length?"\nlayout(std140) uniform AttributeUniforms {\n".concat(n.join("\n"),"\n};\n    "):"";t+=r;var i="";return this.layer.enableShaderEncodeStyles.forEach((function(e){i+="\n\n    #ifdef USE_ATTRIBUTE_".concat(e.toUpperCase(),"\n      ").concat(Wy[e]," ").concat(e,"  = a_").concat(e.charAt(0).toUpperCase()+e.slice(1),";\n    #else\n      ").concat(Wy[e]," ").concat(e," = u_").concat(e,";\n    #endif\n\n    ")})),{"vs:#decl":t,"fs:#decl":r,"vs:#main-start":i}}},{key:"getStyleAttribute",value:function(){var e=this,t={};return this.layer.enableShaderEncodeStyles.forEach((function(n){if(!e.layer.encodeStyleAttribute[n]){var r=e.layer.getLayerConfig()[n],i=void 0===r?Xy[n]:r;"stroke"===n&&(i=Ht(i)),t["u_"+n]=i}})),t}},{key:"registerStyleAttribute",value:function(){var e=this;Object.keys(this.layer.encodeStyleAttribute).forEach((function(t){var n=function(e){switch(e){case"rotation":return{name:"Rotation",type:Rc.Attribute,descriptor:{name:"a_Rotation",shaderLocation:by.ROTATION,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:1,update:function(e){var t=e.rotation,n=void 0===t?0:t;return Array.isArray(n)?[n[0]]:[n]}}};case"stroke":return{name:"stroke",type:Rc.Attribute,descriptor:{name:"a_Stroke",shaderLocation:by.STROKE,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:4,update:function(e){var t=e.stroke;return void 0===t?[1,1,1,1]:t}}};case"opacity":return{name:"opacity",type:Rc.Attribute,descriptor:{name:"a_Opacity",shaderLocation:by.OPACITY,buffer:{usage:Bu.STATIC_DRAW,data:[],type:Bu.FLOAT},size:1,update:function(e){var t=e.opacity;return[void 0===t?1:t]}}};case"extrusionBase":return{name:"extrusionBase",type:Rc.Attribute,descriptor:{name:"a_ExtrusionBase",shaderLocation:by.EXTRUSION_BASE,buffer:{usage:Bu.STATIC_DRAW,data:[],type:Bu.FLOAT},size:1,update:function(e){var t=e.extrusionBase;return[void 0===t?0:t]}}};case"offsets":return{name:"offsets",type:Rc.Attribute,descriptor:{name:"a_Offsets",shaderLocation:by.OFFSETS,buffer:{usage:Bu.STATIC_DRAW,data:[],type:Bu.FLOAT},size:2,update:function(e){return e.offsets}}};case"thetaOffset":return{name:"thetaOffset",type:Rc.Attribute,descriptor:{name:"a_ThetaOffset",shaderLocation:15,buffer:{usage:Bu.STATIC_DRAW,data:[],type:Bu.FLOAT},size:1,update:function(e){var t=e.thetaOffset;return[void 0===t?1:t]}}};default:return}}(t);n&&(e.styleAttributeService.registerStyleAttribute(n),n.descriptor&&(n.descriptor.shaderLocation=Zy[t]))}))}},{key:"updateEncodeAttribute",value:function(e,t){this.encodeStyleAttribute[e]=t}},{key:"initUniformsBuffer",value:function(){var e=this.getUniformsBufferInfo(this.getStyleAttribute()),t=this.getCommonUniformsInfo();0!==e.uniformsLength&&(this.attributeUnifoms=this.rendererService.createBuffer({data:new Float32Array(Yy(e.uniformsLength)).fill(0),isUBO:!0}),this.uniformBuffers.push(this.attributeUnifoms)),0!==t.uniformsLength&&(this.commonUnifoms=this.rendererService.createBuffer({data:new Float32Array(Yy(t.uniformsLength)).fill(0),isUBO:!0}),this.uniformBuffers.push(this.commonUnifoms))}},{key:"getUniformsBufferInfo",value:function(e){var t=0,n=[];return Object.values(e).forEach((function(e){Array.isArray(e)?(n.push.apply(n,r(e)),t+=e.length):"number"==typeof e?(n.push(e),t+=1):"boolean"==typeof e&&(n.push(Number(e)),t+=1)})),{uniformsOption:e,uniformsLength:t,uniformsArray:n}}},{key:"getCommonUniformsInfo",value:function(){return{uniformsLength:0,uniformsArray:[],uniformsOption:{}}}},{key:"updateStyleUnifoms",value:function(){var e,t,n=this.getUniformsBufferInfo(this.getStyleAttribute()).uniformsArray,r=this.getCommonUniformsInfo().uniformsArray;null===(e=this.attributeUnifoms)||void 0===e||e.subData({offset:0,data:new Uint8Array(new Float32Array(n).buffer)}),null===(t=this.commonUnifoms)||void 0===t||t.subData({offset:0,data:new Uint8Array(new Float32Array(r).buffer)})}}])}(),Ky=function(e){return e.VERTICAL="vertical",e.HORIZONTAL="horizontal",e}({}),Qy=function(e){return e.NORMAL="normal",e.REPLACE="replace",e}({}),$y=function(e){return e[e.pixel=0]="pixel",e[e.meter=1]="meter",e}({}),Jy={exports:{}};function eE(e,t,n){n=n||2;var r,i,o,a,s,u,c,l=t&&t.length,f=l?t[0]*n:e.length,h=tE(e,0,f,n,!0),d=[];if(!h||h.next===h.prev)return d;if(l&&(h=function(e,t,n,r){var i,o,a,s=[];for(i=0,o=t.length;i<o;i++)(a=tE(e,t[i]*r,i<o-1?t[i+1]*r:e.length,r,!1))===a.next&&(a.steiner=!0),s.push(hE(a));for(s.sort(uE),i=0;i<s.length;i++)n=cE(s[i],n);return n}(e,t,h,n)),e.length>80*n){r=o=e[0],i=a=e[1];for(var p=n;p<f;p+=n)(s=e[p])<r&&(r=s),(u=e[p+1])<i&&(i=u),s>o&&(o=s),u>a&&(a=u);c=0!==(c=Math.max(o-r,a-i))?32767/c:0}return rE(h,d,n,r,i,c,0),d}function tE(e,t,n,r,i){var o,a;if(i===TE(e,t,n,r)>0)for(o=t;o<n;o+=r)a=AE(o,e[o],e[o+1],a);else for(o=n-r;o>=t;o-=r)a=AE(o,e[o],e[o+1],a);return a&&mE(a,a.next)&&(xE(a),a=a.next),a}function nE(e,t){if(!e)return e;t||(t=e);var n,r=e;do{if(n=!1,r.steiner||!mE(r,r.next)&&0!==vE(r.prev,r,r.next))r=r.next;else{if(xE(r),(r=t=r.prev)===r.next)break;n=!0}}while(n||r!==t);return t}function rE(e,t,n,r,i,o,a){if(e){!a&&o&&function(e,t,n,r){var i=e;do{0===i.z&&(i.z=fE(i.x,i.y,t,n,r)),i.prevZ=i.prev,i.nextZ=i.next,i=i.next}while(i!==e);i.prevZ.nextZ=null,i.prevZ=null,function(e){var t,n,r,i,o,a,s,u,c=1;do{for(n=e,e=null,o=null,a=0;n;){for(a++,r=n,s=0,t=0;t<c&&(s++,r=r.nextZ);t++);for(u=c;s>0||u>0&&r;)0!==s&&(0===u||!r||n.z<=r.z)?(i=n,n=n.nextZ,s--):(i=r,r=r.nextZ,u--),o?o.nextZ=i:e=i,i.prevZ=o,o=i;n=r}o.nextZ=null,c*=2}while(a>1)}(i)}(e,r,i,o);for(var s,u,c=e;e.prev!==e.next;)if(s=e.prev,u=e.next,o?oE(e,r,i,o):iE(e))t.push(s.i/n|0),t.push(e.i/n|0),t.push(u.i/n|0),xE(e),e=u.next,c=u.next;else if((e=u)===c){a?1===a?rE(e=aE(nE(e),t,n),t,n,r,i,o,2):2===a&&sE(e,t,n,r,i,o):rE(nE(e),t,n,r,i,o,1);break}}}function iE(e){var t=e.prev,n=e,r=e.next;if(vE(t,n,r)>=0)return!1;for(var i=t.x,o=n.x,a=r.x,s=t.y,u=n.y,c=r.y,l=i<o?i<a?i:a:o<a?o:a,f=s<u?s<c?s:c:u<c?u:c,h=i>o?i>a?i:a:o>a?o:a,d=s>u?s>c?s:c:u>c?u:c,p=r.next;p!==t;){if(p.x>=l&&p.x<=h&&p.y>=f&&p.y<=d&&dE(i,s,o,u,a,c,p.x,p.y)&&vE(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function oE(e,t,n,r){var i=e.prev,o=e,a=e.next;if(vE(i,o,a)>=0)return!1;for(var s=i.x,u=o.x,c=a.x,l=i.y,f=o.y,h=a.y,d=s<u?s<c?s:c:u<c?u:c,p=l<f?l<h?l:h:f<h?f:h,v=s>u?s>c?s:c:u>c?u:c,m=l>f?l>h?l:h:f>h?f:h,g=fE(d,p,t,n,r),_=fE(v,m,t,n,r),y=e.prevZ,E=e.nextZ;y&&y.z>=g&&E&&E.z<=_;){if(y.x>=d&&y.x<=v&&y.y>=p&&y.y<=m&&y!==i&&y!==a&&dE(s,l,u,f,c,h,y.x,y.y)&&vE(y.prev,y,y.next)>=0)return!1;if(y=y.prevZ,E.x>=d&&E.x<=v&&E.y>=p&&E.y<=m&&E!==i&&E!==a&&dE(s,l,u,f,c,h,E.x,E.y)&&vE(E.prev,E,E.next)>=0)return!1;E=E.nextZ}for(;y&&y.z>=g;){if(y.x>=d&&y.x<=v&&y.y>=p&&y.y<=m&&y!==i&&y!==a&&dE(s,l,u,f,c,h,y.x,y.y)&&vE(y.prev,y,y.next)>=0)return!1;y=y.prevZ}for(;E&&E.z<=_;){if(E.x>=d&&E.x<=v&&E.y>=p&&E.y<=m&&E!==i&&E!==a&&dE(s,l,u,f,c,h,E.x,E.y)&&vE(E.prev,E,E.next)>=0)return!1;E=E.nextZ}return!0}function aE(e,t,n){var r=e;do{var i=r.prev,o=r.next.next;!mE(i,o)&&gE(i,r,r.next,o)&&EE(i,o)&&EE(o,i)&&(t.push(i.i/n|0),t.push(r.i/n|0),t.push(o.i/n|0),xE(r),xE(r.next),r=e=o),r=r.next}while(r!==e);return nE(r)}function sE(e,t,n,r,i,o){var a=e;do{for(var s=a.next.next;s!==a.prev;){if(a.i!==s.i&&pE(a,s)){var u=bE(a,s);return a=nE(a,a.next),u=nE(u,u.next),rE(a,t,n,r,i,o,0),void rE(u,t,n,r,i,o,0)}s=s.next}a=a.next}while(a!==e)}function uE(e,t){return e.x-t.x}function cE(e,t){var n=function(e,t){var n,r=t,i=e.x,o=e.y,a=-1/0;do{if(o<=r.y&&o>=r.next.y&&r.next.y!==r.y){var s=r.x+(o-r.y)*(r.next.x-r.x)/(r.next.y-r.y);if(s<=i&&s>a&&(a=s,n=r.x<r.next.x?r:r.next,s===i))return n}r=r.next}while(r!==t);if(!n)return null;var u,c=n,l=n.x,f=n.y,h=1/0;r=n;do{i>=r.x&&r.x>=l&&i!==r.x&&dE(o<f?i:a,o,l,f,o<f?a:i,o,r.x,r.y)&&(u=Math.abs(o-r.y)/(i-r.x),EE(r,e)&&(u<h||u===h&&(r.x>n.x||r.x===n.x&&lE(n,r)))&&(n=r,h=u)),r=r.next}while(r!==c);return n}(e,t);if(!n)return t;var r=bE(n,e);return nE(r,r.next),nE(n,n.next)}function lE(e,t){return vE(e.prev,e,t.prev)<0&&vE(t.next,e,e.next)<0}function fE(e,t,n,r,i){return(e=1431655765&((e=858993459&((e=252645135&((e=16711935&((e=(e-n)*i|0)|e<<8))|e<<4))|e<<2))|e<<1))|(t=1431655765&((t=858993459&((t=252645135&((t=16711935&((t=(t-r)*i|0)|t<<8))|t<<4))|t<<2))|t<<1))<<1}function hE(e){var t=e,n=e;do{(t.x<n.x||t.x===n.x&&t.y<n.y)&&(n=t),t=t.next}while(t!==e);return n}function dE(e,t,n,r,i,o,a,s){return(i-a)*(t-s)>=(e-a)*(o-s)&&(e-a)*(r-s)>=(n-a)*(t-s)&&(n-a)*(o-s)>=(i-a)*(r-s)}function pE(e,t){return e.next.i!==t.i&&e.prev.i!==t.i&&!function(e,t){var n=e;do{if(n.i!==e.i&&n.next.i!==e.i&&n.i!==t.i&&n.next.i!==t.i&&gE(n,n.next,e,t))return!0;n=n.next}while(n!==e);return!1}(e,t)&&(EE(e,t)&&EE(t,e)&&function(e,t){var n=e,r=!1,i=(e.x+t.x)/2,o=(e.y+t.y)/2;do{n.y>o!=n.next.y>o&&n.next.y!==n.y&&i<(n.next.x-n.x)*(o-n.y)/(n.next.y-n.y)+n.x&&(r=!r),n=n.next}while(n!==e);return r}(e,t)&&(vE(e.prev,e,t.prev)||vE(e,t.prev,t))||mE(e,t)&&vE(e.prev,e,e.next)>0&&vE(t.prev,t,t.next)>0)}function vE(e,t,n){return(t.y-e.y)*(n.x-t.x)-(t.x-e.x)*(n.y-t.y)}function mE(e,t){return e.x===t.x&&e.y===t.y}function gE(e,t,n,r){var i=yE(vE(e,t,n)),o=yE(vE(e,t,r)),a=yE(vE(n,r,e)),s=yE(vE(n,r,t));return i!==o&&a!==s||(!(0!==i||!_E(e,n,t))||(!(0!==o||!_E(e,r,t))||(!(0!==a||!_E(n,e,r))||!(0!==s||!_E(n,t,r)))))}function _E(e,t,n){return t.x<=Math.max(e.x,n.x)&&t.x>=Math.min(e.x,n.x)&&t.y<=Math.max(e.y,n.y)&&t.y>=Math.min(e.y,n.y)}function yE(e){return e>0?1:e<0?-1:0}function EE(e,t){return vE(e.prev,e,e.next)<0?vE(e,t,e.next)>=0&&vE(e,e.prev,t)>=0:vE(e,t,e.prev)<0||vE(e,e.next,t)<0}function bE(e,t){var n=new SE(e.i,e.x,e.y),r=new SE(t.i,t.x,t.y),i=e.next,o=t.prev;return e.next=t,t.prev=e,n.next=i,i.prev=n,r.next=n,n.prev=r,o.next=r,r.prev=o,r}function AE(e,t,n,r){var i=new SE(e,t,n);return r?(i.next=r.next,i.prev=r,r.next.prev=i,r.next=i):(i.prev=i,i.next=i),i}function xE(e){e.next.prev=e.prev,e.prev.next=e.next,e.prevZ&&(e.prevZ.nextZ=e.nextZ),e.nextZ&&(e.nextZ.prevZ=e.prevZ)}function SE(e,t,n){this.i=e,this.x=t,this.y=n,this.prev=null,this.next=null,this.z=0,this.prevZ=null,this.nextZ=null,this.steiner=!1}function TE(e,t,n,r){for(var i=0,o=t,a=n-r;o<n;o+=r)i+=(e[a]-e[o])*(e[o+1]+e[a+1]),a=o;return i}Jy.exports=eE,Jy.exports.default=eE,eE.deviation=function(e,t,n,r){var i=t&&t.length,o=i?t[0]*n:e.length,a=Math.abs(TE(e,0,o,n));if(i)for(var s=0,u=t.length;s<u;s++){var c=t[s]*n,l=s<u-1?t[s+1]*n:e.length;a-=Math.abs(TE(e,c,l,n))}var f=0;for(s=0;s<r.length;s+=3){var h=r[s]*n,d=r[s+1]*n,p=r[s+2]*n;f+=Math.abs((e[h]-e[p])*(e[d+1]-e[h+1])-(e[h]-e[d])*(e[p+1]-e[h+1]))}return 0===a&&0===f?0:Math.abs((f-a)/a)},eE.flatten=function(e){for(var t=e[0][0].length,n={vertices:[],holes:[],dimensions:t},r=0,i=0;i<e.length;i++){for(var o=0;o<e[i].length;o++)for(var a=0;a<t;a++)n.vertices.push(e[i][o][a]);i>0&&(r+=e[i-1].length,n.holes.push(r))}return n};var RE=100;function CE(e){return e/180*Math.acos(-1)}function ME(e){var t=CE(e[0])+Math.PI/2,n=CE(e[1]),r=RE+.4*Math.random(),i=r*Math.cos(n)*Math.cos(t);return[r*Math.cos(n)*Math.sin(t),r*Math.sin(n),i]}var wE=sl();sl();var LE=sl(),OE=sl(),kE=sl();function NE(e,t,n,r,i){return ll(e,n,r),hl(e,e),[i/dl(t=ul(-e[1],e[0]),ul(-n[1],n[0])),t]}function IE(e,t){return function(e,t,n){return e[0]=t,e[1]=n,e}(e,-t[1],t[0])}function PE(e,t,n){return pl(e,t,n),hl(e,e),e}function DE(e,t){return e[0]===t[0]&&e[1]===t[1]}var FE=function(){return c((function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};f(this,e),ne(this,"complex",void 0),ne(this,"join",void 0),ne(this,"cap",void 0),ne(this,"miterLimit",void 0),ne(this,"thickness",void 0),ne(this,"normal",void 0),ne(this,"lastFlip",-1),ne(this,"miter",ul(0,0)),ne(this,"started",!1),ne(this,"dash",!1),ne(this,"totalDistance",0),ne(this,"currentIndex",0),this.join=t.join||"miter",this.cap=t.cap||"butt",this.miterLimit=t.miterLimit||10,this.thickness=t.thickness||1,this.dash=t.dash||!1,this.complex={positions:[],indices:[],normals:[],startIndex:0,indexes:[]}}),[{key:"simpleExtrude",value:function(e){var t=this.complex;if(e.length<=1)return t;this.lastFlip=-1,this.started=!1,this.normal=null,this.totalDistance=0;for(var n=e.length,r=t.startIndex,i=1;i<n;i++){var o=e[i-1],a=e[i],s=i<e.length-1?e[i+1]:null;r+=this.simpleSegment(t,r,o,a,s)}if(this.dash)for(var u=0;u<t.positions.length/6;u++)t.positions[6*u+5]=this.totalDistance;return t.startIndex=t.positions.length/6,t}},{key:"simpleExtrude_gaode2",value:function(e,t){var n=this.complex;if(e.length<=1)return n;this.lastFlip=-1,this.started=!1,this.normal=null,this.totalDistance=0;for(var i=e.length,o=n.startIndex,a=1;a<i;a++){var s,u,c,l=e[a-1];l.push(null!==(s=t[a-1][2])&&void 0!==s?s:0);var f=t[a-1],h=e[a];h.push(null!==(u=t[a][2])&&void 0!==u?u:0);var d=t[a],p=a<e.length-1?[].concat(r(e[a+1]),[null!==(c=t[a+1][2])&&void 0!==c?c:0]):null,v=a<t.length-1?t[a+1]:null;o+=this.simpleSegment(n,o,l,h,p,f,d,v)}if(this.dash)for(var m=0;m<n.positions.length/6;m++)n.positions[6*m+5]=this.totalDistance;return n.startIndex=n.positions.length/6,n}},{key:"extrude_gaode2",value:function(e,t){var n=this.complex;if(e.length<=1)return n;this.lastFlip=-1,this.started=!1,this.normal=null,this.totalDistance=0;for(var i=e.length,o=n.startIndex,a=1;a<i;a++){var s,u,c,l=e[a-1];l.push(null!==(s=t[a-1][2])&&void 0!==s?s:0);var f=t[a-1],h=e[a];h.push(null!==(u=t[a][2])&&void 0!==u?u:0);var d=t[a],p=a<e.length-1?[].concat(r(e[a+1]),[null!==(c=t[a+1][2])&&void 0!==c?c:0]):null,v=a<t.length-1?t[a+1]:null;o+=this.segment_gaode2(n,o,l,h,p,f,d,v)}if(this.dash)for(var m=0;m<n.positions.length/6;m++)n.positions[6*m+5]=this.totalDistance;return n.startIndex=n.positions.length/6,n}},{key:"extrude",value:function(e){var t=this.complex;if(e.length<=1)return t;this.lastFlip=-1,this.started=!1,this.normal=null,this.totalDistance=0;for(var n=e.length,r=t.startIndex,i=1;i<n;i++){var o=e[i-1],a=e[i],s=i<e.length-1?e[i+1]:null;r+=this.segment(t,r,o,a,s)}if(this.dash)for(var u=0;u<t.positions.length/6;u++)t.positions[6*u+5]=this.totalDistance;return t.startIndex=t.positions.length/6,t}},{key:"simpleSegment",value:function(e,t,n,i,o){var s=0,u=e.indices,c=e.positions,l=e.normals,f=Qi([i[0],i[1]]),h=Qi([n[0],n[1]]);PE(LE,f,h);var d=0;if(this.dash&&(d=this.lineSegmentDistance(f,h),this.totalDistance+=d),this.normal||(this.normal=sl(),IE(this.normal,LE)),this.started||(this.started=!0,this.extrusions(c,l,n,this.normal,this.thickness,this.totalDistance-d)),u.push(t+0,t+1,t+2),o){var p=Qi([o[0],o[1]]);DE(f,p)&&ll(p,f,hl(p,fl(p,f,h))),PE(OE,p,f);var v=a(NE(kE,sl(),LE,OE,this.thickness),2),m=v[0],g=v[1];dl(kE,this.normal);this.extrusions(c,l,i,g,m,this.totalDistance),u.push.apply(u,r(1===this.lastFlip?[t,t+2,t+3]:[t+2,t+1,t+3])),-1,cl(this.normal,g),s+=2,this.lastFlip=-1}else IE(this.normal,LE),this.extrusions(c,l,i,this.normal,this.thickness,this.totalDistance),u.push.apply(u,r(1===this.lastFlip?[t,t+2,t+3]:[t+2,t+1,t+3])),s+=2;return s}},{key:"segment_gaode2",value:function(e,t,n,i,o,s,u,c){var l=0,f=e.indices,h=e.positions,d=e.normals,p="square"===this.cap,v="bevel"===this.join,m=Qi([u[0],u[1]]),g=Qi([s[0],s[1]]);PE(LE,i,n);var _=0;if(this.dash&&(_=this.lineSegmentDistance(m,g),this.totalDistance+=_),this.normal||(this.normal=sl(),IE(this.normal,LE)),!this.started)if(this.started=!0,p){var y=sl(),E=sl();ll(y,this.normal,LE),ll(E,this.normal,LE),d.push(E[0],E[1],0),d.push(y[0],y[1],0),h.push(n[0],n[1],0|n[2],this.totalDistance-_,-this.thickness,0|n[2]),this.complex.indexes.push(this.currentIndex),h.push(n[0],n[1],0|n[2],this.totalDistance-_,this.thickness,0|n[2]),this.complex.indexes.push(this.currentIndex),this.currentIndex++}else this.extrusions(h,d,n,this.normal,this.thickness,this.totalDistance-_);if(f.push(t+0,t+1,t+2),o){DE(i,o)&&ll(o,i,hl(o,fl(o,i,n))),PE(OE,o,i);var b=a(NE(kE,sl(),LE,OE,this.thickness),2),A=b[0],x=b[1],S=dl(kE,this.normal)<0?-1:1,T=v;if(!T&&"miter"===this.join)A>this.miterLimit&&(T=!0);T?(d.push(this.normal[0],this.normal[1],0),d.push(x[0],x[1],0),h.push(i[0],i[1],0|i[2],this.totalDistance,-this.thickness*S,0|i[2]),this.complex.indexes.push(this.currentIndex),h.push(i[0],i[1],0|i[2],this.totalDistance,this.thickness*S,0|i[2]),this.complex.indexes.push(this.currentIndex),this.currentIndex++,f.push.apply(f,r(this.lastFlip!==-S?[t,t+2,t+3]:[t+2,t+1,t+3])),f.push(t+2,t+3,t+4),IE(wE,OE),cl(this.normal,wE),d.push(this.normal[0],this.normal[1],0),h.push(i[0],i[1],0|i[2],this.totalDistance,-this.thickness*S,0|i[2]),this.complex.indexes.push(this.currentIndex),this.currentIndex++,l+=3):(this.extrusions(h,d,i,x,A,this.totalDistance),f.push.apply(f,r(1===this.lastFlip?[t,t+2,t+3]:[t+2,t+1,t+3])),S=-1,cl(this.normal,x),l+=2),this.lastFlip=S}else{if(IE(this.normal,LE),p){var R=sl(),C=sl();pl(C,LE,this.normal),ll(R,LE,this.normal),d.push(C[0],C[1],0),d.push(R[0],R[1],0),h.push(i[0],i[1],0|i[2],this.totalDistance,this.thickness,0|i[2]),this.complex.indexes.push(this.currentIndex),h.push(i[0],i[1],0|i[2],this.totalDistance,this.thickness,0|i[2]),this.complex.indexes.push(this.currentIndex),this.currentIndex++}else this.extrusions(h,d,i,this.normal,this.thickness,this.totalDistance);f.push.apply(f,r(1===this.lastFlip?[t,t+2,t+3]:[t+2,t+1,t+3])),l+=2}return l}},{key:"segment",value:function(e,t,n,i,o){var s=0,u=e.indices,c=e.positions,l=e.normals,f="square"===this.cap,h="bevel"===this.join,d=Qi([i[0],i[1]]),p=Qi([n[0],n[1]]);PE(LE,d,p);var v=0;if(this.dash&&(v=this.lineSegmentDistance(d,p),this.totalDistance+=v),this.normal||(this.normal=sl(),IE(this.normal,LE)),!this.started)if(this.started=!0,f){var m=sl(),g=sl();ll(m,this.normal,LE),ll(g,this.normal,LE),l.push(g[0],g[1],0),l.push(m[0],m[1],0),c.push(n[0],n[1],0|n[2],this.totalDistance-v,-this.thickness,0|n[2]),this.complex.indexes.push(this.currentIndex),c.push(n[0],n[1],0|n[2],this.totalDistance-v,this.thickness,0|n[2]),this.complex.indexes.push(this.currentIndex),this.currentIndex++}else this.extrusions(c,l,n,this.normal,this.thickness,this.totalDistance-v);if(u.push(t+0,t+1,t+2),o){var _=Qi([o[0],o[1]]);DE(d,_)&&ll(_,d,hl(_,fl(_,d,p))),PE(OE,_,d);var y=a(NE(kE,sl(),LE,OE,this.thickness),2),E=y[0],b=y[1],A=dl(kE,this.normal)<0?-1:1,x=h;if(!x&&"miter"===this.join)E>this.miterLimit&&(x=!0);x?(l.push(this.normal[0],this.normal[1],0),l.push(b[0],b[1],0),c.push(i[0],i[1],0|i[2],this.totalDistance,-this.thickness*A,0|i[2]),this.complex.indexes.push(this.currentIndex),c.push(i[0],i[1],0|i[2],this.totalDistance,this.thickness*A,0|i[2]),this.complex.indexes.push(this.currentIndex),this.currentIndex++,u.push.apply(u,r(this.lastFlip!==-A?[t,t+2,t+3]:[t+2,t+1,t+3])),u.push(t+2,t+3,t+4),IE(wE,OE),cl(this.normal,wE),l.push(this.normal[0],this.normal[1],0),c.push(i[0],i[1],0|i[2],this.totalDistance,-this.thickness*A,0|i[2]),this.complex.indexes.push(this.currentIndex),this.currentIndex++,s+=3):(this.extrusions(c,l,i,b,E,this.totalDistance),u.push.apply(u,r(1===this.lastFlip?[t,t+2,t+3]:[t+2,t+1,t+3])),A=-1,cl(this.normal,b),s+=2),this.lastFlip=A}else{if(IE(this.normal,LE),f){var S=sl(),T=sl();pl(T,LE,this.normal),ll(S,LE,this.normal),l.push(T[0],T[1],0),l.push(S[0],S[1],0),c.push(i[0],i[1],0|i[2],this.totalDistance,this.thickness,0|i[2]),this.complex.indexes.push(this.currentIndex),c.push(i[0],i[1],0|i[2],this.totalDistance,this.thickness,0|i[2]),this.complex.indexes.push(this.currentIndex),this.currentIndex++}else this.extrusions(c,l,i,this.normal,this.thickness,this.totalDistance);u.push.apply(u,r(1===this.lastFlip?[t,t+2,t+3]:[t+2,t+1,t+3])),s+=2}return s}},{key:"extrusions",value:function(e,t,n,r,i,o){t.push(r[0],r[1],0),t.push(r[0],r[1],0),e.push(n[0],n[1],0|n[2],o,-i,0|n[2]),this.complex.indexes.push(this.currentIndex),e.push(n[0],n[1],0|n[2],o,i,0|n[2]),this.complex.indexes.push(this.currentIndex),this.currentIndex++}},{key:"lineSegmentDistance",value:function(e,t){var n=t[0]-e[0],r=t[1]-e[1];return Math.sqrt(n*n+r*r)}}])}();function BE(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=e[0][0],i=e[0][e[0].length-1];n[0]===i[0]&&n[1]===i[1]&&(e[0]=e[0].slice(0,e[0].length-1));for(var o=e[0].length,a=Jy.exports.flatten(e),s=a.vertices,u=a.dimensions,c=[],l=[],f=[],h=0;h<s.length/u;h++)c.push(s[h*u],s[h*u+1],1,-1,-1),f.push(0,0,1);var d=Jy.exports(a.vertices,a.holes,a.dimensions);l.push.apply(l,r(d));for(var p=function(){var e=a.vertices.slice(v*u,(v+1)*u),n=a.vertices.slice((v+1)*u,(v+2)*u);0===n.length&&(n=a.vertices.slice(0,u));var i=c.length/5;c.push(e[0],e[1],1,0,0,n[0],n[1],1,.1,0,e[0],e[1],0,0,.8,n[0],n[1],0,.1,.8);var o=function(e,t,n){var i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],o=Jc(),a=Jc(),s=Jc();i&&(e=Ki(e),t=Ki(t),n=Ki(n));var u=el.apply(void 0,r(e)),c=el.apply(void 0,r(t)),l=el.apply(void 0,r(n));il(o,l,c),il(a,u,c),f=s,h=o,d=a,p=h[0],v=h[1],m=h[2],g=d[0],_=d[1],y=d[2],f[0]=v*y-m*_,f[1]=m*g-p*y,f[2]=p*_-v*g;var f,h,d,p,v,m,g,_,y;var E=Jc();return tl(E,s),E}([n[0],n[1],1],[e[0],e[1],0],[e[0],e[1],1],t);f.push.apply(f,r(o).concat(r(o),r(o),r(o))),l.push.apply(l,r([1,2,0,3,2,1].map((function(e){return e+i}))))},v=0;v<o;v++)p();return{positions:c,index:l,normals:f}}var UE=function(e){return e.CYLINDER="cylinder",e.SQUARECOLUMN="squareColumn",e.TRIANGLECOLUMN="triangleColumn",e.HEXAGONCOLUMN="hexagonColumn",e.PENTAGONCOLUMN="pentagonColumn",e}({}),GE=function(e){return e.CIRCLE="circle",e.SQUARE="square",e.TRIANGLE="triangle",e.HEXAGON="hexagon",e.PENTAGON="pentagon",e}({});function zE(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=2*Math.PI/e,r=[],i=0;i<e;i++)r.push(n*i+t*Math.PI/12);return r.map((function(e){return[Math.sin(e+Math.PI/4),Math.cos(e+Math.PI/4),0]}))}function jE(){return zE(30)}function VE(){return zE(4)}function HE(){return zE(3)}function XE(){return zE(6,1)}function WE(){return zE(5)}var YE=o(o(o(o(o(o(o(o(o(o({},GE.CIRCLE,jE),GE.HEXAGON,XE),GE.TRIANGLE,HE),GE.SQUARE,VE),GE.PENTAGON,WE),UE.CYLINDER,jE),UE.HEXAGONCOLUMN,XE),UE.TRIANGLECOLUMN,HE),UE.SQUARECOLUMN,VE),UE.PENTAGONCOLUMN,WE),ZE={};function qE(e){var t=ro(e.coordinates);return{vertices:[].concat(r(t),r(t),r(t),r(t)),indices:[0,1,2,2,3,0],size:t.length}}function KE(e){var t=ME(ro(e.coordinates));return{vertices:[].concat(r(t),r(t),r(t),r(t)),indices:[0,1,2,2,3,0],size:t.length}}function QE(e){var t=function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(ZE&&ZE[e])return ZE[e];var n=YE[e]?YE[e]():YE.cylinder(),r=BE([n],t);return ZE[e]=r,r}(e.shape,!1);return{vertices:t.positions,indices:t.index,normals:t.normals,size:5}}function $E(e){var t=ro(e.coordinates);return{vertices:r(t),indices:[0],size:t.length}}function JE(e){var t=e.coordinates,n=e.originCoordinates,r=e.version,i=new FE({dash:!0,join:"bevel"});if("GAODE2.x"===r){var o=t;Array.isArray(o[0][0])||(o=[t]);var a=n;Array.isArray(a[0][0])||(a=[n]);for(var s=0;s<o.length;s++){var u=o[s],c=a[s];i.extrude_gaode2(u,c)}}else{var l=t;l[0]&&!Array.isArray(l[0][0])&&(l=[t]),l.forEach((function(e){i.extrude(e)}))}var f=i.complex;return{vertices:f.positions,indices:f.indices,normals:f.normals,indexes:f.indexes,size:6}}function eb(e){var t=e.coordinates,n=e.originCoordinates,r=[];if(!Array.isArray(t[0]))return{vertices:[],indices:[],normals:[],size:6,count:0};var i=function(e,t){var n=e,r=t||e;Array.isArray(n)&&Array.isArray(n[0])&&Array.isArray(n[0][0])&&(n=t.flat(),r=t.flat());var i=0;if(n.length<2)return{results:n,totalDistance:0};var o=[],a=nb(n[0],i);o.push(a);for(var s=1;s<n.length-1;s++){i+=tb(Qi(r[s-1]),Qi(r[s]));var u=nb(n[s],i);o.push(u),o.push(u)}return i+=tb(Qi(r[r.length-2]),Qi(r[r.length-1])),o.push(nb(n[n.length-1],i)),{results:o,totalDistance:i}}(t,n),o=i.results,a=i.totalDistance;return o.map((function(e){r.push(e[0],e[1],e[2],e[3],0,a)})),{vertices:r,indices:[],normals:[],size:6,count:o.length}}function tb(e,t){var n=t[0]-e[0],r=t[1]-e[1];return Math.sqrt(n*n+r*r)}function nb(e,t){return e.length<3&&e.push(0),void 0!==t&&e.push(t),e}function rb(e){var t=e.coordinates,n=Jy.exports.flatten(t),r=n.vertices,i=n.dimensions,o=n.holes;return{indices:Jy.exports(r,o,i),vertices:r,size:i}}function ib(e){var t=e.coordinates,n=Jy.exports.flatten(t),r=n.vertices,i=n.dimensions,o=n.holes;return{indices:Jy.exports(r,o,i),vertices:ob(r),size:i+4}}function ob(e){for(var t=[],n=function(e){for(var t=e[0],n=e[1],r=e[0],i=e[1],o=0,a=0,s=0,u=0;u<e.length;u+=2){var c=e[u],l=e[u+1];c&&l&&(t=Math.max(c,t),n=Math.max(l,n),r=Math.min(c,r),i=Math.min(l,i),o+=c,a+=l,s++)}return{center:[o/s,a/s],radius:Math.sqrt(Math.pow(t-r,2)+Math.pow(n-i,2))/2}}(e),i=n.center,o=n.radius,a=0;a<e.length;a+=2){var s=e[a],u=e[a+1];t.push.apply(t,[s,u,0].concat(r(i),[o]))}return t}function ab(e){var t=BE(e.coordinates,!0);return{vertices:t.positions,indices:t.index,normals:t.normals,size:5}}function sb(e){var t=e.coordinates;return{vertices:[].concat(r(t[0]),[0,0,0],r(t[1]),[0,1,0],r(t[2]),[0,1,1],r(t[3]),[0,0,1]),indices:[0,1,2,0,2,3],size:5}}function ub(e,t){for(var n=t.segmentNumber,i=void 0===n?30:n,o=e.coordinates,a=[],s=[],u=function(e){a.push(e,1,e,o[0][0],o[0][1],o[1][0],o[1][1],e,-1,e,o[0][0],o[0][1],o[1][0],o[1][1]),e!==i-1&&s.push.apply(s,r([0,1,2,1,3,2].map((function(t){return 2*e+t}))))},c=0;c<i;c++)u(c);return{vertices:a,indices:s,size:7}}var cb=function(e){function t(){var e;f(this,t);for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];return e=h(this,t,[].concat(r)),ne(e,"texture",void 0),e}return d(t,e),c(t,[{key:"getCommonUniformsInfo",value:function(){var e=this.layer.getLayerConfig(),t=e.opacity,n=e.brightness,r=e.contrast,i=e.saturation,o=e.gamma,a={u_opacity:Uo(t,1),u_brightness:Uo(n,1),u_contrast:Uo(r,1),u_saturation:Uo(i,1),u_gamma:Uo(o,1)};return this.textures=[this.texture],this.getUniformsBufferInfo(a)}},{key:"initModels",value:function(){var e=this;return ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.loadTexture();case 2:return t.abrupt("return",e.buildModels());case 3:case"end":return t.stop()}}),t)})))()}},{key:"clearModels",value:function(){var e;null===(e=this.texture)||void 0===e||e.destroy()}},{key:"loadTexture",value:function(){var e=this;return ie(i().mark((function t(){var n,r,o;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.rendererService.createTexture2D,e.texture=n({height:1,width:1}),r=e.layer.getSource(),t.next=5,r.data.images;case 5:o=t.sent,e.texture=n({data:o[0],width:o[0].width,height:o[0].height,mag:Bu.LINEAR,min:Bu.LINEAR});case 7:case"end":return t.stop()}}),t)})))()}},{key:"buildModels",value:function(){var e=this;return ie(i().mark((function t(){var n;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.initUniformsBuffer(),t.next=3,e.layer.buildLayerModel({moduleName:"rasterImage",vertexShader:'layout(location = 0) in vec3 a_Position;\nlayout(location = 14) in vec2 a_Uv;\n\nlayout(std140) uniform commonUniforms {\n    float u_opacity:1.0;\n    float u_brightness:1.0;\n    float u_contrast:1.0;\n    float u_saturation:1.0;\n    float u_gamma:1.0;\n};\n\nout vec2 v_texCoord;\n#pragma include "projection"\nvoid main() {\n   v_texCoord = a_Uv;\n   vec4 project_pos = project_position(vec4(a_Position, 1.0));\n   gl_Position = project_common_position_to_clipspace_v2(vec4(project_pos.xy,0., 1.0));\n \n}\n',fragmentShader:"uniform sampler2D u_texture;\nlayout(std140) uniform commonUniforms {\n    float u_opacity:1.0;\n    float u_brightness:1.0;\n    float u_contrast:1.0;\n    float u_saturation:1.0;\n    float u_gamma:1.0;\n};\n\nin vec2 v_texCoord;\nout vec4 outputColor;\nvec3 setContrast(vec3 rgb, float contrast) {\n  vec3 color = mix(vec3(0.5), rgb, contrast);\n  color = clamp(color, 0.0, 1.0);\n  return color;\n}\nvec3 setSaturation(vec3 rgb, float adjustment) {\n  const vec3 grayVector = vec3(0.2125, 0.7154, 0.0721);\n  vec3 intensity = vec3(dot(rgb, grayVector));\n  vec3 color = mix(intensity, rgb, adjustment);\n  color = clamp(color, 0.0, 1.0);\n  return color;\n}\nvoid main() {\n  vec4 color = texture(SAMPLER_2D(u_texture),vec2(v_texCoord.x,v_texCoord.y));\n  //brightness\n  color.rgb = mix(vec3(0.0, 0.0, 0.0), color.rgb, u_brightness);\n  //contrast\n  color.rgb = setContrast(color.rgb, u_contrast);\n  // saturation\n  color.rgb = setSaturation(color.rgb, u_saturation);\n  // gamma\n  color.rgb = pow(color.rgb, vec3(u_gamma));\n  outputColor = color;\n  outputColor.a *= u_opacity;\n  if(outputColor.a < 0.01)\n    discard;\n}\n",triangulation:sb,primitive:Bu.TRIANGLES,blend:{enable:!0},depth:{enable:!1},pickingEnabled:!1});case 3:return n=t.sent,t.abrupt("return",[n]);case 5:case"end":return t.stop()}}),t)})))()}},{key:"registerBuiltinAttributes",value:function(){this.styleAttributeService.registerStyleAttribute({name:"uv",type:Rc.Attribute,descriptor:{name:"a_Uv",shaderLocation:by.UV,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:2,update:function(e,t,n){return[n[3],n[4]]}}})}}])}(qy),lb={image:cb},fb=function(e){function t(){var e;f(this,t);for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];return e=h(this,t,[].concat(r)),ne(e,"type","ImageLayer"),e}return d(t,e),c(t,[{key:"buildModels",value:function(){var e=this;return ie(i().mark((function t(){var n;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.getModelType(),e.layerModel=new lb[n](e),t.next=4,e.initLayerModels();case 4:case"end":return t.stop()}}),t)})))()}},{key:"getDefaultConfig",value:function(){return{image:{}}[this.getModelType()]}},{key:"getModelType",value:function(){return"image"}}])}(Vy),hb={solid:0,dash:1},db=function(e){function t(){var e;f(this,t);for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];return e=h(this,t,[].concat(r)),ne(e,"texture",void 0),ne(e,"updateTexture",(function(){var t=e.rendererService.createTexture2D;if(e.texture)return e.texture.update({data:e.iconService.getCanvas()}),void e.layer.render();e.texture=t({data:e.iconService.getCanvas(),mag:Bu.NEAREST,min:Bu.NEAREST,premultiplyAlpha:!1,width:1024,height:e.iconService.canvasHeight||128}),e.textures=[e.texture]})),e}return d(t,e),c(t,[{key:"getCommonUniformsInfo",value:function(){var e=this.layer.getLayerConfig(),t=e.sourceColor,n=e.targetColor,r=e.textureBlend,i=void 0===r?"normal":r,o=e.lineType,a=void 0===o?"solid":o,s=e.dashArray,u=void 0===s?[10,5]:s,c=e.forward,l=void 0===c||c,f=e.lineTexture,h=void 0!==f&&f,d=e.iconStep,p=void 0===d?100:d,v=e.segmentNumber,m=void 0===v?30:v,g=this.layer.getLayerConfig().animateOption,_=u;"dash"!==a&&(_=[0,0]),2===_.length&&_.push(0,0);var y,E=0,b=[0,0,0,0],A=[0,0,0,0];(t&&n&&(b=Ht(t),A=Ht(n),E=1),this.rendererService.getDirty())&&(null===(y=this.texture)||void 0===y||y.bind());var x={u_animate:this.animateOption2Array(g),u_dash_array:_,u_sourceColor:b,u_targetColor:A,u_textSize:[1024,this.iconService.canvasHeight||128],segmentNumber:m,u_lineDir:l?1:-1,u_icon_step:p,u_line_texture:h?1:0,u_textureBlend:"normal"===i?0:1,u_blur:.9,u_line_type:hb[a||"solid"],u_time:this.layer.getLayerAnimateTime()||0,u_linearColor:E};return this.getUniformsBufferInfo(x)}},{key:"initModels",value:function(){var e=this;return ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.updateTexture(),e.iconService.on("imageUpdate",e.updateTexture),t.abrupt("return",e.buildModels());case 3:case"end":return t.stop()}}),t)})))()}},{key:"clearModels",value:function(){var e;null===(e=this.texture)||void 0===e||e.destroy(),this.iconService.off("imageUpdate",this.updateTexture)}},{key:"getShaders",value:function(){return{frag:'\n#define Animate 0.0\n#define LineTexture 1.0\nuniform sampler2D u_texture;\nlayout(std140) uniform commonUniorm {\n  vec4 u_animate: [ 1., 2., 1.0, 0.2 ];\n  vec4 u_dash_array;\n  vec4 u_sourceColor;\n  vec4 u_targetColor;\n  vec2 u_textSize;\n  float segmentNumber;\n  float u_lineDir: 1.0;\n  float u_icon_step: 100;\n  float u_line_texture: 0.0;\n  float u_textureBlend;\n  float u_blur : 0.9;\n  float u_line_type: 0.0;\n  float u_time;\n  float u_linearColor: 0.0;\n};\n\nin vec4 v_color;\nin vec2 v_iconMapUV;\nin vec4 v_lineData;\n//dash\nin vec4 v_dash_array;\nin float v_distance_ratio;\n\nout vec4 outputColor;\n#pragma include "picking"\n\nvoid main() {\n  if(u_dash_array!=vec4(0.0)){\n    float dashLength = mod(v_distance_ratio, v_dash_array.x + v_dash_array.y + v_dash_array.z + v_dash_array.w);\n    if(!(dashLength < v_dash_array.x || (dashLength > (v_dash_array.x + v_dash_array.y) && dashLength <  v_dash_array.x + v_dash_array.y + v_dash_array.z))) {\n      discard;\n    };\n  }\n  float animateSpeed = 0.0; // 运动速度\n  outputColor = v_color;\n  if(u_animate.x == Animate && u_line_texture != LineTexture) {\n      animateSpeed = u_time / u_animate.y;\n      float alpha =1.0 - fract( mod(1.0- v_lineData.b, u_animate.z)* (1.0/ u_animate.z) + u_time / u_animate.y);\n      alpha = (alpha + u_animate.w -1.0) / u_animate.w;\n      // alpha = smoothstep(0., 1., alpha);\n      alpha = clamp(alpha, 0.0, 1.0);\n      outputColor.a *= alpha;\n  }\n\n  // 当存在贴图时在底色上贴上贴图\n  if(u_line_texture == LineTexture) { // while load texture\n    float arcRadio = smoothstep( 0.0, 1.0, (v_lineData.r / segmentNumber));\n    // float arcRadio = smoothstep( 0.0, 1.0, d_distance_ratio);\n\n    float count = v_lineData.g; // 贴图在弧线上重复的数量\n\n    float time = 0.0;\n    if(u_animate.x == Animate) {\n      time = u_time / u_animate.y;\n    }\n    float redioCount = arcRadio * count;\n\n    float u = fract(redioCount - time);\n    float v = v_lineData.a; // 横向 v\n    vec2 uv= v_iconMapUV / u_textSize + vec2(u, v) / u_textSize * 64.;\n\n    vec4 pattern = texture(SAMPLER_2D(u_texture), uv);\n\n    if(u_animate.x == Animate) {\n      float currentPlane = floor(redioCount - time);\n      float textureStep = floor(count * u_animate.z);\n      float a = mod(currentPlane, textureStep);\n      if(a < textureStep - 1.0) {\n        pattern = vec4(0.0);\n      }\n    }\n\n    if(u_textureBlend == 0.0) { // normal\n      pattern.a = 0.0;\n      outputColor = filterColor(outputColor + pattern);\n    } else { // replace\n        pattern.a *= v_color.a;\n        if(outputColor.a <= 0.0) {\n          pattern.a = 0.0;\n        }\n        outputColor = filterColor(pattern);\n    }\n    \n  } else {\n     outputColor = filterColor(outputColor);\n  }\n}',vert:'#define Animate 0.0\n#define LineTexture 1.0\nlayout(location = 0) in vec3 a_Position;\nlayout(location = 1) in vec4 a_Color;\nlayout(location = 9) in float a_Size;\nlayout(location = 12) in vec4 a_Instance;\nlayout(location = 14) in vec2 a_iconMapUV;\n\nlayout(std140) uniform commonUniorm {\n  vec4 u_animate: [ 1., 2., 1.0, 0.2 ];\n  vec4 u_dash_array;\n  vec4 u_sourceColor;\n  vec4 u_targetColor;\n  vec2 u_textSize;\n  float segmentNumber;\n  float u_lineDir: 1.0;\n  float u_icon_step: 100;\n  float u_line_texture: 0.0;\n  float u_textureBlend;\n  float u_blur : 0.9;\n  float u_line_type: 0.0;\n  float u_time;\n  float u_linearColor: 0.0;\n};\nout vec4 v_color;\nout vec2 v_iconMapUV;\nout vec4 v_lineData;\n//dash\nout vec4 v_dash_array;\nout float v_distance_ratio;\n\n\n#pragma include "projection"\n#pragma include "project"\n#pragma include "picking"\n\nfloat bezier3(vec3 arr, float t) {\n  float ut = 1. - t;\n  return (arr.x * ut + arr.y * t) * ut + (arr.y * ut + arr.z * t) * t;\n}\nvec2 midPoint(vec2 source, vec2 target, float arcThetaOffset) {\n  vec2 center = target - source;\n  float r = length(center);\n  float theta = atan(center.y, center.x);\n  float thetaOffset = arcThetaOffset;\n  float r2 = r / 2.0 / cos(thetaOffset);\n  float theta2 = theta + thetaOffset;\n  vec2 mid = vec2(r2*cos(theta2) + source.x, r2*sin(theta2) + source.y);\n  if(u_lineDir == 1.0) { // 正向\n    return mid;\n  } else { // 逆向\n    // (mid + vmin)/2 = (s + t)/2\n    vec2 vmid = source + target - mid;\n    return vmid;\n  }\n  // return mid;\n}\nfloat getSegmentRatio(float index) {\n    // dash: index / (segmentNumber - 1.);\n    // normal: smoothstep(0.0, 1.0, index / (segmentNumber - 1.));\n    return smoothstep(0.0, 1.0, index / (segmentNumber - 1.));\n    //  return index / (segmentNumber - 1.);\n}\nvec2 interpolate (vec2 source, vec2 target, float t, float arcThetaOffset) {\n  // if the angularDist is PI, linear interpolation is applied. otherwise, use spherical interpolation\n  vec2 mid = midPoint(source, target, arcThetaOffset);\n  vec3 x = vec3(source.x, mid.x, target.x);\n  vec3 y = vec3(source.y, mid.y, target.y);\n  return vec2(bezier3(x ,t), bezier3(y,t));\n}\nvec2 getExtrusionOffset(vec2 line_clipspace, float offset_direction) {\n  // normalized direction of the line\n  vec2 dir_screenspace = normalize(line_clipspace);\n  // rotate by 90 degrees\n   dir_screenspace = vec2(-dir_screenspace.y, dir_screenspace.x);\n  vec2 offset = dir_screenspace * offset_direction * setPickingSize(a_Size) / 2.0;\n  return offset;\n}\nvec2 getNormal(vec2 line_clipspace, float offset_direction) {\n  // normalized direction of the line\n  vec2 dir_screenspace = normalize(line_clipspace);\n  // rotate by 90 degrees\n   dir_screenspace = vec2(-dir_screenspace.y, dir_screenspace.x);\n   return reverse_offset_normal(vec3(dir_screenspace,1.0)).xy * sign(offset_direction);\n}\n\nvoid main() {\n  //vs中计算渐变色\n  if(u_linearColor==1.0){\n    float d_segmentIndex = a_Position.x + 1.0; // 当前顶点在弧线中所处的分段位置\n    v_color = mix(u_sourceColor, u_targetColor, d_segmentIndex/segmentNumber);\n  }\n  else{\n    v_color = a_Color;\n  }\n  v_color.a = v_color.a * opacity;\n\n  vec2 source = a_Instance.rg;  // 起始点\n  vec2 target =  a_Instance.ba; // 终点\n\n\n\n  float segmentIndex = a_Position.x;\n  float segmentRatio = getSegmentRatio(segmentIndex);\n\n  //计算dashArray和distanceRatio 输出到片元\n  vec2 s = source;\n  vec2 t = target;\n  if(u_CoordinateSystem == COORDINATE_SYSTEM_P20_2) { // gaode2.x\n    s = unProjCustomCoord(source);\n    t = unProjCustomCoord(target);\n  }\n  float total_Distance = pixelDistance(s, t) / 2.0 * PI;\n  v_dash_array = pow(2.0, 20.0 - u_Zoom) * u_dash_array / total_Distance;\n  v_distance_ratio = segmentIndex / segmentNumber;\n\n  float indexDir = mix(-1.0, 1.0, step(segmentIndex, 0.0));\n  float nextSegmentRatio = getSegmentRatio(segmentIndex + indexDir);\n  float d_distance_ratio;\n  \n  if(u_animate.x == Animate) {\n      d_distance_ratio = segmentIndex / segmentNumber;\n      if(u_lineDir != 1.0) {\n        d_distance_ratio = 1.0 - d_distance_ratio;\n      }\n  }\n\n  v_lineData.b = d_distance_ratio;\n\n  vec4 curr = project_position(vec4(interpolate(source, target, segmentRatio, thetaOffset), 0.0, 1.0));\n  vec4 next = project_position(vec4(interpolate(source, target, nextSegmentRatio, thetaOffset), 0.0, 1.0));\n\n  \n  vec2 offset = project_pixel(getExtrusionOffset((next.xy - curr.xy) * indexDir, a_Position.y));\n\n\n  float d_segmentIndex = a_Position.x + 1.0; // 当前顶点在弧线中所处的分段位置\n  v_lineData.r = d_segmentIndex;\n\n  if(LineTexture == u_line_texture) { // 开启贴图模式\n\n    float arcDistrance = length(source - target); // 起始点和终点的距离\n    if(u_CoordinateSystem == COORDINATE_SYSTEM_P20) { // amap\n      arcDistrance *= 1000000.0;\n    }\n    if(u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT || u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSET) { // mapbox\n      // arcDistrance *= 8.0;\n      arcDistrance = project_pixel_allmap(arcDistrance);\n    }\n    v_iconMapUV = a_iconMapUV;\n\n    float pixelLen = project_pixel_texture(u_icon_step); // 贴图沿弧线方向的长度 - 随地图缩放改变\n    float texCount = floor(arcDistrance/pixelLen); // 贴图在弧线上重复的数量\n    v_lineData.g = texCount;\n\n    float lineOffsetWidth = length(offset + offset * sign(a_Position.y)); // 线横向偏移的距离\n    float linePixelSize = project_pixel(a_Size); // 定点位置偏移\n    v_lineData.a = lineOffsetWidth/linePixelSize; // 线图层贴图部分的 v 坐标值\n  }\n\n  gl_Position = project_common_position_to_clipspace_v2(vec4(curr.xy + offset, 0, 1.0));\n\n  setPickingColor(a_PickingColor);\n}\n',type:""}}},{key:"buildModels",value:function(){var e=this;return ie(i().mark((function t(){var n,r,o,a,s,u,c,l;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.initUniformsBuffer(),n=e.layer.getLayerConfig(),r=n.segmentNumber,o=void 0===r?30:r,a=e.getShaders(),s=a.frag,u=a.vert,c=a.type,t.next=5,e.layer.buildLayerModel({moduleName:"lineArc2d"+c,vertexShader:u,fragmentShader:s,inject:e.getInject(),triangulation:ub,depth:{enable:!1},styleOption:{segmentNumber:o}});case 5:return l=t.sent,t.abrupt("return",[l]);case 7:case"end":return t.stop()}}),t)})))()}},{key:"registerBuiltinAttributes",value:function(){var e=this;this.styleAttributeService.registerStyleAttribute({name:"size",type:Rc.Attribute,descriptor:{name:"a_Size",shaderLocation:by.SIZE,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:1,update:function(e){var t=e.size,n=void 0===t?1:t;return Array.isArray(n)?[n[0]]:[n]}}}),this.styleAttributeService.registerStyleAttribute({name:"instance",type:Rc.Attribute,descriptor:{name:"a_Instance",shaderLocation:12,buffer:{usage:Bu.STATIC_DRAW,data:[],type:Bu.FLOAT},size:4,update:function(e,t,n){return[n[3],n[4],n[5],n[6]]}}}),this.styleAttributeService.registerStyleAttribute({name:"uv",type:Rc.Attribute,descriptor:{name:"a_iconMapUV",shaderLocation:14,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:2,update:function(t){var n=e.iconService.getIconMap()[t.texture]||{x:0,y:0};return[n.x,n.y]}}})}}])}(qy),pb={solid:0,dash:1},vb=function(e){function t(){var e;f(this,t);for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];return e=h(this,t,[].concat(r)),ne(e,"texture",void 0),ne(e,"updateTexture",(function(){var t=e.rendererService.createTexture2D;if(e.texture)return e.texture.update({data:e.iconService.getCanvas()}),void e.layer.render();e.texture=t({data:e.iconService.getCanvas(),mag:Bu.NEAREST,min:Bu.NEAREST,premultiplyAlpha:!1,width:1024,height:e.iconService.canvasHeight||128}),e.textures=[e.texture]})),e}return d(t,e),c(t,[{key:"getCommonUniformsInfo",value:function(){var e=this.layer.getLayerConfig(),t=e.sourceColor,n=e.targetColor,r=e.textureBlend,i=void 0===r?"normal":r,o=e.lineType,a=void 0===o?"solid":o,s=e.dashArray,u=void 0===s?[10,5]:s,c=e.lineTexture,l=void 0!==c&&c,f=e.iconStep,h=void 0===f?100:f,d=e.segmentNumber,p=void 0===d?30:d,v=e.globalArcHeight,m=void 0===v?10:v,g=this.layer.getLayerConfig().animateOption;2===u.length&&u.push(0,0);var _,y=0,E=[0,0,0,0],b=[0,0,0,0];(t&&n&&(E=Ht(t),b=Ht(n),y=1),this.rendererService.getDirty())&&(null===(_=this.texture)||void 0===_||_.bind());var A={u_animate:this.animateOption2Array(g),u_dash_array:u,u_sourceColor:E,u_targetColor:b,u_textSize:[1024,this.iconService.canvasHeight||128],u_globel:"GLOBEL"===this.mapService.version?1:0,u_globel_radius:RE,u_global_height:m,segmentNumber:p,u_line_type:pb[a]||0,u_icon_step:h,u_line_texture:l?1:0,u_textureBlend:"normal"===i?0:1,u_time:this.layer.getLayerAnimateTime()||0,u_linearColor:y};return this.getUniformsBufferInfo(A)}},{key:"initModels",value:function(){var e=this;return ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.initUniformsBuffer(),e.updateTexture(),e.iconService.on("imageUpdate",e.updateTexture),t.abrupt("return",e.buildModels());case 4:case"end":return t.stop()}}),t)})))()}},{key:"clearModels",value:function(){var e;null===(e=this.texture)||void 0===e||e.destroy(),this.iconService.off("imageUpdate",this.updateTexture)}},{key:"getShaders",value:function(){return{frag:'#define LineTypeSolid 0.0\n#define LineTypeDash 1.0\n#define Animate 0.0\n#define LineTexture 1.0\n\nuniform sampler2D u_texture;\n\nlayout(std140) uniform commonUniorm {\n  vec4 u_animate: [ 1., 2., 1.0, 0.2 ];\n  vec4 u_dash_array: [10.0, 5., 0, 0];\n  vec4 u_sourceColor;\n  vec4 u_targetColor;\n  vec2 u_textSize;\n  float u_globel;\n  float u_globel_radius;\n  float u_global_height: 10;\n  float segmentNumber;\n  float u_line_type: 0.0;\n  float u_icon_step: 100;\n  float u_line_texture: 0.0;\n  float u_textureBlend;\n  float u_time;\n  float u_linearColor: 0.0;\n};\n\n// varying vec2 v_normal;\nin vec4 v_dash_array;\nin vec4 v_color;\nin vec4 v_line_data;\nin float v_segmentIndex;\nin vec2 v_iconMapUV;\n\nout vec4 outputColor;\n\n#pragma include "picking"\n\nvoid main() {\n  float animateSpeed = 0.0; // 运动速度\n  float d_distance_ratio = v_line_data.g; // 当前点位距离占线总长的比例\n  outputColor = v_color;\n\n  if(u_line_type == LineTypeDash) {\n    float flag = 0.;\n    float dashLength = mod(d_distance_ratio, v_dash_array.x + v_dash_array.y + v_dash_array.z + v_dash_array.w);\n    if(dashLength < v_dash_array.x || (dashLength > (v_dash_array.x + v_dash_array.y) && dashLength <  v_dash_array.x + v_dash_array.y + v_dash_array.z)) {\n      flag = 1.;\n    }\n    outputColor.a *=flag;\n  }\n\n  if(u_animate.x == Animate && u_line_texture != LineTexture) {\n      animateSpeed = u_time / u_animate.y;\n      float alpha =1.0 - fract( mod(1.0- d_distance_ratio, u_animate.z)* (1.0/ u_animate.z) + u_time / u_animate.y);\n\n      alpha = (alpha + u_animate.w -1.0) / u_animate.w;\n      // alpha = smoothstep(0., 1., alpha);\n      alpha = clamp(alpha, 0.0, 1.0);\n      outputColor.a *= alpha;\n\n      // u_animate \n      // x enable\n      // y duration\n      // z interval\n      // w trailLength\n  }\n\n  if(u_line_texture == LineTexture && u_line_type != LineTypeDash) { // while load texture\n    // float arcRadio = smoothstep( 0.0, 1.0, (v_segmentIndex / segmentNumber));\n    float arcRadio = v_segmentIndex / (segmentNumber - 1.0);\n    float count = v_line_data.b; // // 贴图在弧线上重复的数量\n\n    float time = 0.0;\n    if(u_animate.x == Animate) {\n      time = u_time / u_animate.y;\n    }\n    float redioCount = arcRadio * count;\n\n    float u = fract(redioCount - time);\n\n    float v = v_line_data.a;  // 线图层贴图部分的 v 坐标值\n    vec2 uv= v_iconMapUV / u_textSize + vec2(u, v) / u_textSize * 64.;\n    vec4 pattern = texture(SAMPLER_2D(u_texture), uv);\n\n    if(u_animate.x == Animate) {\n      float currentPlane = floor(redioCount - time);\n      float textureStep = floor(count * u_animate.z);\n      float a = mod(currentPlane, textureStep);\n      if(a < textureStep - 1.0) {\n        pattern = vec4(0.0);\n      }\n    }\n\n    if(u_textureBlend == 0.0) { // normal\n      pattern.a = 0.0;\n      outputColor = filterColor(outputColor + pattern);\n    } else { // replace\n        pattern.a *= v_color.a;\n        if(outputColor.a <= 0.0) {\n          pattern.a = 0.0;\n          discard;\n        } else {\n          outputColor = filterColor(pattern);\n        }\n    }\n\n  } else {\n    outputColor = filterColor(outputColor);\n  }\n}\n',vert:'#define LineTypeSolid 0.0\n#define LineTypeDash 1.0\n#define Animate 0.0\n#define LineTexture 1.0\nlayout(location = 0) in vec3 a_Position;\nlayout(location = 1) in vec4 a_Color;\nlayout(location = 9) in float a_Size;\nlayout(location = 12) in vec4 a_Instance;\nlayout(location = 14) in vec2 a_iconMapUV;\n\n\nlayout(std140) uniform commonUniorm {\n  vec4 u_animate: [ 1., 2., 1.0, 0.2 ];\n  vec4 u_dash_array: [10.0, 5., 0, 0];\n  vec4 u_sourceColor;\n  vec4 u_targetColor;\n  vec2 u_textSize;\n  float u_globel;\n  float u_globel_radius;\n  float u_global_height: 10;\n  float segmentNumber;\n  float u_line_type: 0.0;\n  float u_icon_step: 100;\n  float u_line_texture: 0.0;\n  float u_textureBlend;\n  float u_time;\n  float u_linearColor: 0.0;\n};\nout vec4 v_color;\nout vec4 v_dash_array;\nout float v_segmentIndex;\nout vec2 v_iconMapUV;\nout vec4 v_line_data;\n\n#pragma include "projection"\n#pragma include "project"\n#pragma include "picking"\n\nfloat maps (float value, float start1, float stop1, float start2, float stop2) {\n  return start2 + (stop2 - start2) * ((value - start1) / (stop1 - start1));\n}\n\nfloat getSegmentRatio(float index) {\n  return smoothstep(0.0, 1.0, index / (segmentNumber - 1.0));\n}\n\nfloat paraboloid(vec2 source, vec2 target, float ratio) {\n  vec2 x = mix(source, target, ratio);\n  vec2 center = mix(source, target, 0.5);\n  float dSourceCenter = distance(source, center);\n  float dXCenter = distance(x, center);\n  return (dSourceCenter + dXCenter) * (dSourceCenter - dXCenter);\n}\n\nvec3 getPos(vec2 source, vec2 target, float segmentRatio) {\n  float vertex_height = paraboloid(source, target, segmentRatio);\n\n  return vec3(\n    mix(source, target, segmentRatio),\n    sqrt(max(0.0, vertex_height))\n  );\n}\nvec2 getExtrusionOffset(vec2 line_clipspace, float offset_direction) {\n  // normalized direction of the line\n  vec2 dir_screenspace = normalize(line_clipspace);\n  // rotate by 90 degrees\n  dir_screenspace = vec2(-dir_screenspace.y, dir_screenspace.x);\n\n  vec2 offset = dir_screenspace * offset_direction * setPickingSize(a_Size) / 2.0;\n\n  return offset;\n}\nvec2 getNormal(vec2 line_clipspace, float offset_direction) {\n  // normalized direction of the line\n  vec2 dir_screenspace = normalize(line_clipspace);\n  // rotate by 90 degrees\n  dir_screenspace = vec2(-dir_screenspace.y, dir_screenspace.x);\n  return reverse_offset_normal(vec3(dir_screenspace,1.0)).xy * sign(offset_direction);\n}\n\nfloat torad(float deg) {\n  return (deg / 180.0) * acos(-1.0);\n}\n\nvec3 lglt2xyz(vec2 lnglat) {\n  float pi = 3.1415926;\n  // + Math.PI/2 是为了对齐坐标\n  float lng = torad(lnglat.x) + pi / 2.0;\n  float lat = torad(lnglat.y);\n\n  // 手动增加一些偏移，减轻面的冲突\n  float radius = u_globel_radius;\n\n  float z = radius * cos(lat) * cos(lng);\n  float x = radius * cos(lat) * sin(lng);\n  float y = radius * sin(lat);\n  return vec3(x, y, z);\n}\n\nvoid main() {\n  //vs中计算渐变色\n  if(u_linearColor==1.0){\n    float d_segmentIndex = a_Position.x + 1.0; // 当前顶点在弧线中所处的分段位置\n    v_color = mix(u_sourceColor, u_targetColor, d_segmentIndex/segmentNumber);\n  }\n  else{\n    v_color = a_Color;\n  }\n  v_color.a = v_color.a * opacity;\n  vec2 source = project_position(vec4(a_Instance.rg, 0, 0)).xy;\n  vec2 target = project_position(vec4(a_Instance.ba, 0, 0)).xy;\n  float segmentIndex = a_Position.x;\n  float segmentRatio = getSegmentRatio(segmentIndex);\n  float indexDir = mix(-1.0, 1.0, step(segmentIndex, 0.0));\n\n  float d_distance_ratio;\n   if(u_line_type == LineTypeDash) {\n    d_distance_ratio = segmentIndex / segmentNumber;\n    vec2 s = source;\n    vec2 t = target;\n    \n    if(u_CoordinateSystem == COORDINATE_SYSTEM_P20_2) { // gaode2.x\n      s = unProjCustomCoord(source);\n      t = unProjCustomCoord(target);\n    }\n    float total_Distance = pixelDistance(s, t) / 2.0 * PI;\n    v_dash_array = pow(2.0, 20.0 - u_Zoom) * u_dash_array / (total_Distance / segmentNumber * segmentIndex);\n  }\n    if(u_animate.x == Animate) {\n      d_distance_ratio = segmentIndex / segmentNumber;\n  }\n  v_line_data.g = d_distance_ratio; // 当前点位距离占线总长的比例\n\n  float nextSegmentRatio = getSegmentRatio(segmentIndex + indexDir);\n  vec3 curr = getPos(source, target, segmentRatio);\n  vec3 next = getPos(source, target, nextSegmentRatio);\n  vec2 offset = getExtrusionOffset((next.xy - curr.xy) * indexDir, a_Position.y);\n  // v_normal = getNormal((next.xy - curr.xy) * indexDir, a_Position.y);\n\n\n  v_segmentIndex = a_Position.x;\n  if(LineTexture == u_line_texture && u_line_type != LineTypeDash) { // 开启贴图模式  \n\n    float arcDistrance = length(source - target);\n    float pixelLen =  project_pixel_texture(u_icon_step);\n    v_line_data.b = floor(arcDistrance/pixelLen); // 贴图在弧线上重复的数量\n\n    vec2 projectOffset = project_pixel(offset);\n    float lineOffsetWidth = length(projectOffset + projectOffset * sign(a_Position.y)); // 线横向偏移的距离\n    float linePixelSize = project_pixel(a_Size);  // 定点位置偏移，按地图等级缩放后的距离\n    v_line_data.a = lineOffsetWidth/linePixelSize;  // 线图层贴图部分的 v 坐标值\n\n    v_iconMapUV = a_iconMapUV;\n  }\n\n\n  gl_Position = project_common_position_to_clipspace_v2(vec4(curr.xy + project_pixel(offset), curr.z * thetaOffset, 1.0));\n\n  // 地球模式\n  if(u_globel > 0.0) {\n    vec3 startLngLat = lglt2xyz(a_Instance.rg);\n    vec3 endLngLat = lglt2xyz(a_Instance.ba);\n    float globalRadius = length(startLngLat);\n\n    vec3 lineDir = normalize(endLngLat - startLngLat);\n    vec3 midPointDir = normalize((startLngLat + endLngLat)/2.0);\n\n    // 线的偏移\n    vec3 lnglatOffset = cross(lineDir, midPointDir) * a_Position.y;\n    // 计算起始点和终止点的距离\n    float lnglatLength = length(a_Instance.rg - a_Instance.ba)/50.0;\n    // 计算飞线各个节点相应的高度\n    float lineHeight = u_global_height * (-4.0*segmentRatio*segmentRatio + 4.0 * segmentRatio) * lnglatLength;\n    // 地球点位\n    vec3 globalPoint = normalize(mix(startLngLat, endLngLat, segmentRatio)) * (globalRadius + lineHeight) + lnglatOffset * a_Size;\n    \n    gl_Position = u_ViewProjectionMatrix * vec4(globalPoint, 1.0);\n  }\n \n\n  setPickingColor(a_PickingColor);\n}\n',type:""}}},{key:"buildModels",value:function(){var e=this;return ie(i().mark((function t(){var n,r,o,a,s,u,c,l;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.layer.getLayerConfig(),r=n.segmentNumber,o=void 0===r?30:r,a=e.getShaders(),s=a.frag,u=a.vert,c=a.type,t.next=4,e.layer.buildLayerModel({moduleName:"lineArc3d"+c,vertexShader:u,fragmentShader:s,inject:e.getInject(),triangulation:ub,styleOption:{segmentNumber:o}});case 4:return l=t.sent,t.abrupt("return",[l]);case 6:case"end":return t.stop()}}),t)})))()}},{key:"registerBuiltinAttributes",value:function(){var e=this;this.styleAttributeService.registerStyleAttribute({name:"size",type:Rc.Attribute,descriptor:{name:"a_Size",shaderLocation:by.SIZE,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:1,update:function(e){var t=e.size,n=void 0===t?1:t;return Array.isArray(n)?[n[0]]:[n]}}}),this.styleAttributeService.registerStyleAttribute({name:"instance",type:Rc.Attribute,descriptor:{name:"a_Instance",shaderLocation:12,buffer:{usage:Bu.STATIC_DRAW,data:[],type:Bu.FLOAT},size:4,update:function(e,t,n){return[n[3],n[4],n[5],n[6]]}}}),this.styleAttributeService.registerStyleAttribute({name:"uv",type:Rc.Attribute,descriptor:{name:"a_iconMapUV",shaderLocation:14,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:2,update:function(t){var n=e.iconService.getIconMap()[t.texture]||{x:0,y:0};return[n.x,n.y]}}})}}])}(qy),mb={circle:2,triangle:2,diamond:4,rect:2,classic:3,halfTriangle:2,none:0},gb=.5;function _b(e,t){var n="object"===s(e)?e.type:e,i="source"===t?1:-1,o="object"===s(e)?e:{};switch(n){case"circle":return function(e,t){var n=t.width,i=void 0===n?2:n,o=t.height,a=void 0===o?2:o,s=jE(),u=Jy.exports.flatten([s]),c=Jy.exports(u.vertices,u.holes,u.dimensions),l=s.map((function(t){return[t[0]*i*e,t[1]*a]})).flat();return{vertices:[].concat(r(l),r(l)),dimensions:2,indices:c.map((function(e){return e+s.length})),outLineIndices:c,normals:[].concat(r(s.map((function(t){return[t[1]*a,t[0]*i*e,1]})).flat()),r(new Array(3*s.length).fill(0)))}}(i,o);case"triangle":return function(e,t){var n=t.width,r=void 0===n?2:n,i=t.height,o=void 0===i?3:i;return{vertices:[0,0,1*e*r,1*o,1*e*r,-1*o,0,0,1*e*r,1*o,1*e*r,-1*o],outLineIndices:[0,1,2],indices:[3,4,5],normals:[0,-1.5*e,1,2,1*e,1,-2,1*e,1,0,0,0,0,0,0,0,0,0],dimensions:2}}(i,o);case"diamond":return function(e,t){var n=t.width,r=void 0===n?2:n,i=t.height,o=void 0===i?3:i;return{vertices:[0,0,1*r*e,.5*o,2*r*e,0,1*r*e,-.5*o,0,0,1*r*e,.5*o,2*r*e,0,1*r*e,-.5*o],dimensions:2,indices:[4,5,6,4,6,7],outLineIndices:[0,1,2,0,2,3],normals:[0,-e,1,1,0,1,0,-e,1,-1,-0,1,0,0,0,0,0,0,0,0,0,0,0,0]}}(i,o);case"rect":return function(e,t){var n=t.width,r=void 0===n?2:n,i=t.height,o=void 0===i?2:i;return{vertices:[0,o/2,e*r*1,o/2,e*r*1,-o/2,0,-o/2,0,o/2,e*r*1,o/2,e*r*1,-o/2,0,-o/2],dimensions:2,indices:[4,5,6,4,6,7],outLineIndices:[0,1,2,0,2,3],normals:[0,-e,1,1,0,1,0,-e,1,-1,-0,1,0,0,0,0,0,0,0,0,0,0,0,0]}}(i,o);case"classic":return function(e,t){var n=t.width,r=void 0===n?2:n,i=t.height,o=void 0===i?3:i;return{vertices:[0,0,2*e*r,1*o,1.5*e*r,0,2*e*r,-1*o,0,0,2*e*r,1*o,1.5*e*r,0,2*e*r,-1*o],dimensions:2,indices:[4,5,6,4,6,7],outLineIndices:[0,1,2,0,2,3],normals:[0,-e,1,1,0,1,0,-e,1,-1,-0,1,0,0,0,0,0,0,0,0,0,0,0,0]}}(i,o);case"halfTriangle":return function(e,t){var n=t.width,r=void 0===n?2:n,i=t.height,o=void 0===i?1:i;return{vertices:[0,gb*e,1*e*r,-(o+gb)*e,1*e*r,(o-gb)*e,0,gb*e,1*e*r,-(o+gb)*e,1*e*r,(o-gb)*e],indices:[3,4,5],outLineIndices:[0,1,2],normals:[1*e,-2*e,1,-2*e,1.5*e,1,1*e,1.5*e,1,0,0,0,0,0,0,0,0,0],dimensions:2}}(i,o);default:return{vertices:[],indices:[],normals:[],dimensions:2,outLineIndices:[],outLineNormals:[]}}}function yb(e,t){return t?function(e,t){var n=e.coordinates.flat(),i=t.target,o=void 0===i?"classic":i,a=t.source,u=Eb(_b(void 0===a?"circle":a,"source"),n,0,0),c=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2?arguments[2]:void 0,i="object"===s(n.source)?n.source.type:n.source,o="object"===s(n.target)?n.target.type:n.target,a=("object"===s(n.source)?n.source:{}).width,u=void 0===a?i?mb[i]:0:a,c=("object"===s(n.target)?n.target:{}).width,l=void 0===c?o?mb[o]:0:c;return{vertices:[0,gb,1*u].concat(r(e),[1,gb,-1*l],r(e),[1,-gb,-1*l],r(e),[0,-gb,1*u],r(e),[0,gb,1*u],r(e),[1,gb,-1*l],r(e),[1,-gb,-1*l],r(e),[0,-gb,1*u],r(e)),outLineIndices:[0,1,2,0,2,3].map((function(e){return e+t})),indices:[4,5,6,4,6,7].map((function(e){return e+t})),normals:[1,-1,1,1,1,1,-1,0,1,-1,0,1,0,0,0,0,0,0,0,0,0,0,0,0],dimensions:2}}(n,u.vertices.length/7,t),l=Eb(_b(o,"target"),n,1,u.vertices.length/7+c.vertices.length/7);return{vertices:[].concat(r(u.vertices),r(c.vertices),r(l.vertices)),indices:[].concat(r(u.outLineIndices),r(c.outLineIndices),r(l.outLineIndices),r(u.indices),r(c.indices),r(l.indices)),normals:[].concat(r(u.normals),r(c.normals),r(l.normals)),size:7}}(e,t):function(e){var t=e.coordinates.flat();return{vertices:[1,0,0].concat(r(t),[1,2,-3],r(t),[1,1,-3],r(t),[0,1,0],r(t),[0,0,0],r(t),[1,0,0],r(t),[1,2,-3],r(t),[1,1,-3],r(t),[0,1,0],r(t),[0,0,0],r(t)),normals:[-1,2,1,2,-1,1,1,-1,1,1,-1,1,-1,-1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],indices:[0,1,2,0,2,3,0,3,4,5,6,7,5,7,8,5,8,9],size:7}}(e)}function Eb(e,t){for(var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,o=[],a=e.vertices,s=e.indices,u=e.dimensions,c=e.outLineIndices,l=0;l<a.length;l+=u)o.push.apply(o,[n,a[l+1],a[l]].concat(r(t)));return re(re({},e),{},{vertices:o,indices:s.map((function(e){return e+i})),outLineIndices:c.map((function(e){return e+i}))})}var bb=function(e){function t(){return f(this,t),h(this,t,arguments)}return d(t,e),c(t,[{key:"getCommonUniformsInfo",value:function(){var e=this.layer.getLayerConfig(),t=e.gapWidth,n=void 0===t?2:t,r=e.strokeWidth,i=void 0===r?1:r,o=e.strokeOpacity,a={u_gap_width:n,u_stroke_width:i,u_stroke_opacity:void 0===o?1:o};return this.getUniformsBufferInfo(a)}},{key:"initModels",value:function(){var e=this;return ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.initUniformsBuffer(),t.abrupt("return",e.buildModels());case 2:case"end":return t.stop()}}),t)})))()}},{key:"buildModels",value:function(){var e=this;return ie(i().mark((function t(){var n;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.layer.buildLayerModel({moduleName:"flow_line",vertexShader:'layout(location = 0) in vec3 a_Position;\nlayout(location = 1) in vec4 a_Color;\nlayout(location = 9) in vec2 a_Size;\nlayout(location = 12) in vec4 a_Instance;\nlayout(location = 13) in vec3 a_Normal;\n\nlayout(std140) uniform commonUniorm {\n  float u_gap_width: 1.0;\n  float u_stroke_width: 1.0;\n  float u_stroke_opacity: 1.0;\n};\n\n#pragma include "projection"\n#pragma include "project"\n#pragma include "picking"\n\nout vec4 v_color;\n\nvec2 project_pixel_offset(vec2 offsets) {\n\n   vec2 data = project_pixel(offsets);\n   if(u_CoordinateSystem == COORDINATE_SYSTEM_P20_2) {\n    // P20_2 坐标系下，为了和 Web 墨卡托坐标系统一，zoom 默认减3\n    return data;\n  }\n\n  return vec2(data.x, -data.y);;\n}\n\nvec2 line_dir(vec2 target, vec2 source) {\n\n   if(u_CoordinateSystem == COORDINATE_SYSTEM_P20_2) {\n    // P20_2 坐标系下，为了和 Web 墨卡托坐标系统一，zoom 默认减3\n     return normalize(target - source);\n  }\n  return normalize(ProjectFlat(target) - ProjectFlat(source));\n}\n\nfloat flag_gap() {\n   if(u_CoordinateSystem == COORDINATE_SYSTEM_P20_2) {\n    // P20_2 坐标系下，为了和 Web 墨卡托坐标系统一，zoom 默认减3\n     return 1.;\n  }\n  return -1.;\n\n}\n\n\nvoid main() {\n\n// 透明度计算\n  vec2 source = a_Instance.rg;  // 起始点\n  vec2 target =  a_Instance.ba; // 终点\n  vec2 flowlineDir = line_dir(target,source);\n  vec2 perpendicularDir = vec2(-flowlineDir.y, flowlineDir.x); // mapbox || 高德\n   \n  vec2 position = mix(source, target, a_Position.x);\n  \n  float lengthCommon = length(project_position(vec4(target,0,1)) - project_position(vec4(source,0,1)));  //    \n  vec2 offsetDistances = a_Size.x * project_pixel_offset(vec2(a_Position.y, a_Position.z)); // Mapbox || 高德\n  vec2 limitedOffsetDistances = clamp(   \n   offsetDistances,\n   project_pixel(-lengthCommon*.2), project_pixel(lengthCommon*.2)\n  );\n\n\n  float startOffsetCommon = project_pixel(offsets[0]);\n  float endOffsetCommon = project_pixel(offsets[1]);\n  float endpointOffset = mix(\n    clamp(startOffsetCommon, 0.0, lengthCommon*.2),\n    -clamp(endOffsetCommon, 0.0, lengthCommon*.2),\n    a_Position.x\n  );\n\n  vec2 normalsCommon =  u_stroke_width * project_pixel_offset(vec2(a_Normal.x, a_Normal.y)); // mapbox || 高德\n\n  float gapCommon = flag_gap() * project_pixel(u_gap_width);\n  vec3 offsetCommon = vec3(\n    flowlineDir * (limitedOffsetDistances[1] + normalsCommon.y + endpointOffset * 1.05) -\n    perpendicularDir *  (limitedOffsetDistances[0] + gapCommon + normalsCommon.x),\n    0.0\n  );\n\n  vec4 project_pos = project_position(vec4(position.xy, 0, 1.0));\n\n  vec4 fillColor = vec4(a_Color.rgb, a_Color.a * opacity);\n  v_color = mix(fillColor, vec4(u_stroke.xyz, u_stroke.w * fillColor.w * u_stroke_opacity), a_Normal.z);\n\n  gl_Position = project_common_position_to_clipspace_v2(vec4(project_pos.xy +  offsetCommon.xy, 0., 1.0));\n\n\n\n  setPickingColor(a_PickingColor);\n}\n',fragmentShader:'// #extension GL_OES_standard_derivatives : enable\n\nin vec4 v_color;\nout vec4 outputColor;\n\n\n// line texture\n\n#pragma include "picking"\n\nvoid main() {\n  outputColor = v_color;\n  outputColor = filterColor(outputColor);\n}\n',inject:e.getInject(),triangulation:yb,styleOption:e.layer.getLayerConfig().symbol,primitive:Bu.TRIANGLES,depth:{enable:!1},pick:!1});case 2:return n=t.sent,t.abrupt("return",[n]);case 4:case"end":return t.stop()}}),t)})))()}},{key:"registerBuiltinAttributes",value:function(){this.styleAttributeService.registerStyleAttribute({name:"size",type:Rc.Attribute,descriptor:{name:"a_Size",shaderLocation:by.SIZE,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:2,update:function(e){var t=e.size,n=void 0===t?1:t;return Array.isArray(n)?[n[0],n[1]]:[n,0]}}}),this.styleAttributeService.registerStyleAttribute({name:"instance",type:Rc.Attribute,descriptor:{name:"a_Instance",shaderLocation:12,buffer:{usage:Bu.STATIC_DRAW,data:[],type:Bu.FLOAT},size:4,update:function(e,t,n){return[n[3],n[4],n[5],n[6]]}}}),this.styleAttributeService.registerStyleAttribute({name:"normal",type:Rc.Attribute,descriptor:{name:"a_Normal",shaderLocation:by.NORMAL,buffer:{usage:Bu.STATIC_DRAW,data:[],type:Bu.FLOAT},size:3,update:function(e,t,n,r,i){return i}}})}}])}(qy),Ab={solid:0,dash:1},xb=function(e){function t(){var e;f(this,t);for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];return e=h(this,t,[].concat(r)),ne(e,"texture",void 0),ne(e,"updateTexture",(function(){var t=e.rendererService.createTexture2D;if(e.texture)return e.texture.update({data:e.iconService.getCanvas()}),void e.layer.render();e.texture=t({data:e.iconService.getCanvas(),mag:Bu.NEAREST,min:Bu.NEAREST,premultiplyAlpha:!1,width:1024,height:e.iconService.canvasHeight||128}),e.textures=[e.texture]})),e}return d(t,e),c(t,[{key:"getCommonUniformsInfo",value:function(){var e,t=this.layer.getLayerConfig(),n=t.sourceColor,r=t.targetColor,i=t.textureBlend,o=void 0===i?"normal":i,a=t.lineType,s=void 0===a?"solid":a,u=t.dashArray,c=void 0===u?[10,5]:u,l=t.lineTexture,f=void 0!==l&&l,h=t.iconStep,d=void 0===h?100:h,p=t.segmentNumber,v=void 0===p?30:p,m=this.layer.getLayerConfig().animateOption;(2===c.length&&c.push(0,0),this.rendererService.getDirty())&&(null===(e=this.texture)||void 0===e||e.bind());var g=0,_=[0,0,0,0],y=[0,0,0,0];n&&r&&(_=Ht(n),y=Ht(r),g=1);var E=this.layer.getLayerAnimateTime();isNaN(E)&&(E=0);var b={u_animate:this.animateOption2Array(m),u_dash_array:c,u_sourceColor:_,u_targetColor:y,u_textSize:[1024,this.iconService.canvasHeight||128],segmentNumber:v,u_line_type:Ab[s]||0,u_icon_step:d,u_line_texture:f?1:0,u_textureBlend:"normal"===o?0:1,u_time:E,u_linearColor:g};return this.getUniformsBufferInfo(b)}},{key:"initModels",value:function(){var e=this;return ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.initUniformsBuffer(),e.updateTexture(),e.iconService.on("imageUpdate",e.updateTexture),t.abrupt("return",e.buildModels());case 4:case"end":return t.stop()}}),t)})))()}},{key:"clearModels",value:function(){var e;null===(e=this.texture)||void 0===e||e.destroy(),this.iconService.off("imageUpdate",this.updateTexture)}},{key:"buildModels",value:function(){var e=this;return ie(i().mark((function t(){var n,r,o,a;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.layer.getLayerConfig(),r=n.segmentNumber,o=void 0===r?30:r,t.next=3,e.layer.buildLayerModel({moduleName:"lineGreatCircle",vertexShader:'#define LineTypeSolid 0.0\n#define LineTypeDash 1.0\n#define Animate 0.0\n#define LineTexture 1.0\n\nlayout(location = 0) in vec3 a_Position;\nlayout(location = 1) in vec4 a_Color;\nlayout(location = 9) in float a_Size;\nlayout(location = 12) in vec4 a_Instance;\nlayout(location = 14) in vec2 a_iconMapUV;\n\nlayout(std140) uniform commonUniorm {\n  vec4 u_animate: [ 1., 2., 1.0, 0.2 ];\n  vec4 u_dash_array: [10.0, 5., 0, 0];\n  vec4 u_sourceColor;\n  vec4 u_targetColor;\n  vec2 u_textSize;\n  float segmentNumber;\n  float u_line_type: 0.0;\n  float u_icon_step: 100;\n  float u_line_texture: 0.0;\n  float u_textureBlend;\n  float u_time;\n  float u_linearColor: 0;\n};\n\nout vec4 v_dash_array;\nout vec4 v_color;\nout vec2 v_iconMapUV;\nout vec4 v_line_data;\nout float v_distance_ratio;\n\n#pragma include "projection"\n#pragma include "project"\n#pragma include "picking"\n\nfloat maps (float value, float start1, float stop1, float start2, float stop2) {\n  return start2 + (stop2 - start2) * ((value - start1) / (stop1 - start1));\n}\n\nfloat getSegmentRatio(float index) {\n  return index / (segmentNumber - 1.);\n}\n\nfloat paraboloid(vec2 source, vec2 target, float ratio) {\n  vec2 x = mix(source, target, ratio);\n  vec2 center = mix(source, target, 0.5);\n  float dSourceCenter = distance(source, center);\n  float dXCenter = distance(x, center);\n  return (dSourceCenter + dXCenter) * (dSourceCenter - dXCenter);\n}\n\nvec3 getPos(vec2 source, vec2 target, float segmentRatio) {\n  float vertex_height = paraboloid(source, target, segmentRatio);\n\n  return vec3(\n  mix(source, target, segmentRatio),\n  sqrt(max(0.0, vertex_height))\n  );\n}\nvec2 getExtrusionOffset(vec2 line_clipspace, float offset_direction) {\n  // normalized direction of the line\n  vec2 dir_screenspace = normalize(line_clipspace);\n  // rotate by 90 degrees\n   dir_screenspace = vec2(-dir_screenspace.y, dir_screenspace.x);\n  vec2 offset = dir_screenspace * offset_direction * setPickingSize(a_Size)/ 2.0;\n  return offset;\n}\nvec2 getNormal(vec2 line_clipspace, float offset_direction) {\n  // normalized direction of the line\n  vec2 dir_screenspace = normalize(line_clipspace);\n  // rotate by 90 degrees\n   dir_screenspace = vec2(-dir_screenspace.y, dir_screenspace.x);\n   return reverse_offset_normal(vec3(dir_screenspace,1.0)).xy * sign(offset_direction);\n}\nfloat getAngularDist (vec2 source, vec2 target) {\n  vec2 delta = source - target;\n  vec2 sin_half_delta = sin(delta / 2.0);\n  float a =\n    sin_half_delta.y * sin_half_delta.y +\n    cos(source.y) * cos(target.y) *\n    sin_half_delta.x * sin_half_delta.x;\n  return 2.0 * atan(sqrt(a), sqrt(1.0 - a));\n}\n\nvec2 midPoint(vec2 source, vec2 target) {\n  vec2 center = target - source;\n  float r = length(center);\n  float theta = atan(center.y, center.x);\n  float thetaOffset = 0.314;\n  float r2 = r / 2.0 / cos(thetaOffset);\n  float theta2 = theta + thetaOffset;\n  vec2 mid = vec2(r2*cos(theta2) + source.x, r2*sin(theta2) + source.y);\n  return mid;\n}\nfloat bezier3(vec3 arr, float t) {\n  float ut = 1. - t;\n  return (arr.x * ut + arr.y * t) * ut + (arr.y * ut + arr.z * t) * t;\n}\n\nvec2 interpolate (vec2 source, vec2 target, float angularDist, float t) {\n  // if the angularDist is PI, linear interpolation is applied. otherwise, use spherical interpolation\n  if(u_CoordinateSystem == COORDINATE_SYSTEM_P20_2) { // gaode2.x\n    vec2 mid = midPoint(source, target);\n    vec3 x = vec3(source.x, mid.x, target.x);\n    vec3 y = vec3(source.y, mid.y, target.y);\n    return vec2(bezier3(x ,t), bezier3(y,t));\n  }\n  else {\n    if(abs(angularDist - PI) < 0.001) {\n      return (1.0 - t) * source + t * target;\n    }\n    float a = sin((1.0 - t) * angularDist) / sin(angularDist);\n    float b = sin(t * angularDist) / sin(angularDist);\n    vec2 sin_source = sin(source);\n    vec2 cos_source = cos(source);\n    vec2 sin_target = sin(target);\n    vec2 cos_target = cos(target);\n    float x = a * cos_source.y * cos_source.x + b * cos_target.y * cos_target.x;\n    float y = a * cos_source.y * sin_source.x + b * cos_target.y * sin_target.x;\n    float z = a * sin_source.y + b * sin_target.y;\n    return vec2(atan(y, x), atan(z, sqrt(x * x + y * y)));\n  }\n}\n\nvoid main() {\n  v_color = a_Color;\n  v_color.a = v_color.a * opacity;\n  vec2 source = radians(a_Instance.rg);\n  vec2 target = radians(a_Instance.ba);\n  float angularDist = getAngularDist(source, target);\n  float segmentIndex = a_Position.x;\n  float segmentRatio = getSegmentRatio(segmentIndex);\n  float indexDir = mix(-1.0, 1.0, step(segmentIndex, 0.0));\n\n  if(u_line_type == LineTypeDash) {\n    v_distance_ratio = segmentIndex / segmentNumber;\n    vec2 s = source;\n    vec2 t = target;\n    \n    if(u_CoordinateSystem == COORDINATE_SYSTEM_P20_2) { // gaode2.x\n      s = unProjCustomCoord(source);\n      t = unProjCustomCoord(target);\n    }\n    float total_Distance = pixelDistance(s, t) / 2.0 * PI;\n    total_Distance = total_Distance*16.0; // total_Distance*16.0 调整默认的效果\n    v_dash_array = pow(2.0, 20.0 - u_Zoom) * u_dash_array / total_Distance;\n  }\n\n  if(u_animate.x == Animate) {\n      v_distance_ratio = segmentIndex / segmentNumber;\n  }\n\n  float nextSegmentRatio = getSegmentRatio(segmentIndex + indexDir);\n  v_distance_ratio = segmentIndex / segmentNumber;\n  vec4 curr = project_position(vec4(degrees(interpolate(source, target, angularDist, segmentRatio)), 0.0, 1.0));\n  vec4 next = project_position(vec4(degrees(interpolate(source, target, angularDist, nextSegmentRatio)), 0.0, 1.0));\n  // v_normal = getNormal((next.xy - curr.xy) * indexDir, a_Position.y);\n  vec2 offset = project_pixel(getExtrusionOffset((next.xy - curr.xy) * indexDir, a_Position.y));\n  //  vec4 project_pos = project_position(vec4(curr.xy, 0, 1.0));\n  // gl_Position = project_common_position_to_clipspace(vec4(curr.xy + offset, curr.z, 1.0));\n\n  v_line_data.g = a_Position.x; // 该顶点在弧线上的分段排序\n  if(LineTexture == u_line_texture) { // 开启贴图模式  \n    // float mapZoomScale = u_CoordinateSystem !== COORDINATE_SYSTEM_P20_2?10000000.0:1.0;\n    float d_arcDistrance = length(source - target);\n    if(u_CoordinateSystem == COORDINATE_SYSTEM_P20) { // amap\n      d_arcDistrance = d_arcDistrance * 1000000.0;\n    }\n    if(u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT || u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSET) { // mapbox\n      d_arcDistrance = project_pixel_allmap(d_arcDistrance);\n    }\n    float d_pixelLen = project_pixel(u_icon_step)/8.0;\n    v_line_data.b = floor(d_arcDistrance/d_pixelLen); // 贴图在弧线上重复的数量\n\n    float lineOffsetWidth = length(offset + offset * sign(a_Position.y)); // 线横向偏移的距离\n    float linePixelSize = project_pixel(a_Size);  // 定点位置偏移，按地图等级缩放后的距离\n    v_line_data.a = lineOffsetWidth/linePixelSize;  // 线图层贴图部分的 v 坐标值\n\n    v_iconMapUV = a_iconMapUV;\n  }\n\n  gl_Position = project_common_position_to_clipspace_v2(vec4(curr.xy + offset, 0, 1.0));\n  setPickingColor(a_PickingColor);\n}\n\n',fragmentShader:'#define LineTypeSolid 0.0\n#define LineTypeDash 1.0\n#define Animate 0.0\n#define LineTexture 1.0\n\nuniform sampler2D u_texture;\nlayout(std140) uniform commonUniorm {\n  vec4 u_animate: [ 1., 2., 1.0, 0.2 ];\n  vec4 u_dash_array: [10.0, 5., 0, 0];\n  vec4 u_sourceColor;\n  vec4 u_targetColor;\n  vec2 u_textSize;\n  float segmentNumber;\n  float u_line_type: 0.0;\n  float u_icon_step: 100;\n  float u_line_texture: 0.0;\n  float u_textureBlend;\n  float u_time;\n  float u_linearColor: 0;\n};\n\nin vec4 v_line_data;\nin vec2 v_iconMapUV;\nin vec4 v_dash_array;\nin float v_distance_ratio;\nin vec4 v_color;\n\nout vec4 outputColor;\n#pragma include "picking"\n#pragma include "project"\n#pragma include "projection"\n\nvoid main() {\n\n  float animateSpeed = 0.0;\n  float d_segmentIndex = v_line_data.g;\n  \n  // 设置弧线的底色\n  if(u_linearColor == 1.0) { // 使用渐变颜色\n    outputColor = mix(u_sourceColor, u_targetColor, d_segmentIndex/segmentNumber);\n    outputColor.a *= v_color.a;\n  } else { // 使用 color 方法传入的颜色\n    outputColor = v_color;\n  }\n\n  // float blur = 1.- smoothstep(u_blur, 1., length(v_normal.xy));\n  // float blur = smoothstep(1.0, u_blur, length(v_normal.xy));\n  if(u_line_type == LineTypeDash) {\n    float dashLength = mod(v_distance_ratio, v_dash_array.x + v_dash_array.y + v_dash_array.z + v_dash_array.w);\n    if(dashLength < v_dash_array.x || (dashLength > (v_dash_array.x + v_dash_array.y) && dashLength <  v_dash_array.x + v_dash_array.y + v_dash_array.z)) {\n      // 实线部分\n    } else {\n      // 虚线部分\n      discard;\n    };\n  }\n\n  // 设置弧线的动画模式\n  if(u_animate.x == Animate) {\n      animateSpeed = u_time / u_animate.y;\n      float alpha =1.0 - fract( mod(1.0- v_distance_ratio, u_animate.z)* (1.0/ u_animate.z) + u_time / u_animate.y);\n      alpha = (alpha + u_animate.w -1.0) / u_animate.w;\n      alpha = smoothstep(0., 1., alpha);\n      outputColor.a *= alpha;\n  }\n\n  // 设置弧线的贴图\n  if(LineTexture == u_line_texture && u_line_type != LineTypeDash) { \n    float arcRadio = smoothstep( 0.0, 1.0, (d_segmentIndex / (segmentNumber - 1.0)));\n    // float arcRadio = d_segmentIndex / (segmentNumber - 1.0);\n    float count = v_line_data.b; // 贴图在弧线上重复的数量\n    float u = fract(arcRadio * count - animateSpeed * count);\n    // float u = fract(arcRadio * count - animateSpeed);\n    if(u_animate.x == Animate) {\n      u = outputColor.a/v_color.a;\n    }\n\n    float v = v_line_data.a; // 线图层贴图部分的 v 坐标值\n\n    vec2 uv= v_iconMapUV / u_textSize + vec2(u, v) / u_textSize * 64.;\n    vec4 pattern = texture(SAMPLER_2D(u_texture), uv);\n    \n    // 设置贴图和底色的叠加模式\n    if(u_textureBlend == 0.0) { // normal\n      pattern.a = 0.0;\n      outputColor = filterColor(outputColor + pattern);\n    } else { // replace\n        pattern.a *= v_color.a;\n        if(outputColor.a <= 0.0) {\n          pattern.a = 0.0;\n        }\n        outputColor = filterColor(pattern);\n    }\n  } else {\n    outputColor = filterColor(outputColor);\n  }\n\n  // gl_FragColor = filterColor(gl_FragColor);\n}',triangulation:ub,styleOption:{segmentNumber:o},inject:e.getInject(),depth:{enable:!1}});case 3:return a=t.sent,t.abrupt("return",[a]);case 5:case"end":return t.stop()}}),t)})))()}},{key:"registerBuiltinAttributes",value:function(){var e=this;this.styleAttributeService.registerStyleAttribute({name:"size",type:Rc.Attribute,descriptor:{name:"a_Size",shaderLocation:by.SIZE,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:1,update:function(e){var t=e.size,n=void 0===t?1:t;return Array.isArray(n)?[n[0]]:[n]}}}),this.styleAttributeService.registerStyleAttribute({name:"instance",type:Rc.Attribute,descriptor:{name:"a_Instance",shaderLocation:12,buffer:{usage:Bu.STATIC_DRAW,data:[],type:Bu.FLOAT},size:4,update:function(e,t,n){return[n[3],n[4],n[5],n[6]]}}}),this.styleAttributeService.registerStyleAttribute({name:"uv",type:Rc.Attribute,descriptor:{name:"a_iconMapUV",shaderLocation:14,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:2,update:function(t){var n=e.iconService.getIconMap()[t.texture]||{x:0,y:0};return[n.x,n.y]}}})}}])}(qy),Sb=function(e){function t(){var e;f(this,t);for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];return e=h(this,t,[].concat(r)),ne(e,"textureEventFlag",!1),ne(e,"texture",e.createTexture2D({data:new Uint8Array([0,0,0,0]),width:1,height:1})),ne(e,"updateTexture",(function(){var t=e.rendererService.createTexture2D;if(0===e.textures.length&&(e.textures=[e.texture]),e.texture)return e.texture.update({data:e.iconService.getCanvas()}),void e.layer.render();e.texture=t({data:e.iconService.getCanvas(),mag:Bu.NEAREST,min:Bu.NEAREST,premultiplyAlpha:!1,width:1024,height:e.iconService.canvasHeight||128})})),e}return d(t,e),c(t,[{key:"getCommonUniformsInfo",value:function(){var e,t=this.layer.getLayerConfig(),n=t.sourceColor,r=t.targetColor,i=t.textureBlend,o=void 0===i?"normal":i,a=t.lineType,s=void 0===a?"solid":a,u=t.dashArray,c=void 0===u?[10,5,0,0]:u,l=t.lineTexture,f=void 0!==l&&l,h=t.iconStep,d=void 0===h?100:h,p=t.vertexHeightScale,v=void 0===p?20:p,m=t.strokeWidth,g=void 0===m?0:m,_=t.raisingHeight,y=void 0===_?0:_,E=t.heightfixed,b=void 0!==E&&E,A=t.linearDir,x=void 0===A?Ky.VERTICAL:A,S=t.blur,T=void 0===S?[1,1,1,0]:S,R=c;("dash"!==s&&(R=[0,0,0,0]),2===R.length&&R.push(0,0),this.rendererService.getDirty()&&this.texture)&&(null===(e=this.texture)||void 0===e||e.bind());var C=this.layer.getLayerConfig().animateOption,M=0,w=[0,0,0,0],L=[0,0,0,0];n&&r&&(w=Ht(n),L=Ht(r),M=1);var O={u_animate:this.animateOption2Array(C),u_dash_array:R,u_blur:T,u_sourceColor:w,u_targetColor:L,u_textSize:[1024,this.iconService.canvasHeight||128],u_icon_step:d,u_heightfixed:Number(b),u_vertexScale:v,u_raisingHeight:Number(y),u_strokeWidth:g,u_textureBlend:o===Qy.NORMAL?0:1,u_line_texture:f?1:0,u_linearDir:x===Ky.VERTICAL?1:0,u_linearColor:M,u_time:this.layer.getLayerAnimateTime()||0};return this.getUniformsBufferInfo(O)}},{key:"initModels",value:function(){var e=this;return ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.initUniformsBuffer(),e.textureEventFlag||(e.textureEventFlag=!0,e.updateTexture(),e.iconService.on("imageUpdate",e.updateTexture)),t.abrupt("return",e.buildModels());case 3:case"end":return t.stop()}}),t)})))()}},{key:"clearModels",value:function(){var e;null===(e=this.texture)||void 0===e||e.destroy(),this.iconService.off("imageUpdate",this.updateTexture)}},{key:"buildModels",value:function(){var e=this;return ie(i().mark((function t(){var n,r,o,a,s,u,c,l;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.layer.getLayerConfig(),r=n.depth,o=void 0!==r&&r,a=e.getShaders(),s=a.frag,u=a.vert,c=a.type,e.layer.triangulation=JE,t.next=5,e.layer.buildLayerModel({moduleName:"line"+c,vertexShader:u,fragmentShader:s,triangulation:JE,inject:e.getInject(),depth:{enable:o}});case 5:return l=t.sent,t.abrupt("return",[l]);case 7:case"end":return t.stop()}}),t)})))()}},{key:"getShaders",value:function(){return{frag:'// #extension GL_OES_standard_derivatives : enable\n#define Animate 0.0\n#define LineTexture 1.0\n\nuniform sampler2D u_texture;\nlayout(std140) uniform commonUniorm {\n  vec4 u_animate: [ 1., 2., 1.0, 0.2 ];\n  vec4 u_dash_array;\n  vec4 u_blur;\n  vec4 u_sourceColor;\n  vec4 u_targetColor;\n  vec2 u_textSize;\n  float u_icon_step: 100;\n  float u_heightfixed: 0.0;\n  float u_vertexScale: 1.0;\n  float u_raisingHeight: 0.0;\n  float u_strokeWidth: 0.0;\n  float u_textureBlend;\n  float u_line_texture;\n  float u_linearDir: 1.0;\n  float u_linearColor: 0;\n  float u_time;\n};\n\nin vec4 v_color;\nin vec4 v_stroke;\n// dash\nin vec4 v_dash_array;\nin float v_d_distance_ratio;\nin vec2 v_iconMapUV;\nin vec4 v_texture_data;\n\nout vec4 outputColor;\n#pragma include "picking"\n\n// [animate, duration, interval, trailLength],\nvoid main() {\n  if(u_dash_array!=vec4(0.0)){\n    float dashLength = mod(v_d_distance_ratio, v_dash_array.x + v_dash_array.y + v_dash_array.z + v_dash_array.w);\n    if(!(dashLength < v_dash_array.x || (dashLength > (v_dash_array.x + v_dash_array.y) && dashLength <  v_dash_array.x + v_dash_array.y + v_dash_array.z))) {\n      // 虚线部分\n      discard;\n    };\n  }\n  float animateSpeed = 0.0; // 运动速度\n  float d_distance_ratio = v_texture_data.r; // 当前点位距离占线总长的比例\n  if(u_linearDir < 1.0) {\n    d_distance_ratio = v_texture_data.a;\n  }\n  if(u_linearColor == 1.0) { // 使用渐变颜色\n    outputColor = mix(u_sourceColor, u_targetColor, d_distance_ratio);\n    outputColor.a *= v_color.a;\n  } else { // 使用 color 方法传入的颜色\n     outputColor = v_color;\n  }\n  // anti-alias\n  // float blur = 1.0 - smoothstep(u_blur, 1., length(v_normal.xy));\n  if(u_animate.x == Animate) {\n      animateSpeed = u_time / u_animate.y;\n       float alpha =1.0 - fract( mod(1.0- d_distance_ratio, u_animate.z)* (1.0/ u_animate.z) + animateSpeed);\n      alpha = (alpha + u_animate.w -1.0) / u_animate.w;\n      alpha = smoothstep(0., 1., alpha);\n      outputColor.a *= alpha;\n  }\n\n  if(u_line_texture == LineTexture) { // while load texture\n    float aDistance = v_texture_data.g;      // 当前顶点的距离\n    float d_texPixelLen = v_texture_data.b;  // 贴图的像素长度，根据地图层级缩放\n    float u = fract(mod(aDistance, d_texPixelLen)/d_texPixelLen - animateSpeed);\n    float v = v_texture_data.a;  // 线图层贴图部分的 v 坐标值\n\n    // v = max(smoothstep(0.95, 1.0, v), v);\n    vec2 uv= v_iconMapUV / u_textSize + vec2(u, v) / u_textSize * 64.;\n     vec4 pattern = texture(SAMPLER_2D(u_texture), uv);\n\n    if(u_textureBlend == 0.0) { // normal\n      pattern.a = 0.0;\n      outputColor += pattern;\n    } else { // replace\n        pattern.a *= v_color.a;\n        if(outputColor.a <= 0.0) {\n          pattern.a = 0.0;\n        }\n        outputColor = pattern;\n    }\n  } \n\n  float v = v_texture_data.a;\n  float strokeWidth = min(0.5, u_strokeWidth);\n  // 绘制 border\n  if(strokeWidth > 0.01) {\n    float borderOuterWidth = strokeWidth / 2.0;\n\n\n    if(v >= 1.0 - strokeWidth || v <= strokeWidth) {\n      if(v > strokeWidth) { // 外侧\n        float linear = smoothstep(0.0, 1.0, (v - (1.0 - strokeWidth))/strokeWidth);\n        //  float linear = step(0.0, (v - (1.0 - borderWidth))/borderWidth);\n        outputColor.rgb = mix(outputColor.rgb, v_stroke.rgb, linear);\n      } else if(v <= strokeWidth) {\n        float linear = smoothstep(0.0, 1.0, v/strokeWidth);\n        outputColor.rgb = mix(v_stroke.rgb, outputColor.rgb, linear);\n      }\n    }\n\n    if(v < borderOuterWidth) {\n      outputColor.a = mix(0.0, outputColor.a, v/borderOuterWidth);\n    } else if(v > 1.0 - borderOuterWidth) {\n      outputColor.a = mix(outputColor.a, 0.0, (v - (1.0 - borderOuterWidth))/borderOuterWidth);\n    }\n  }\n\n  // blur\n  float blurV = v_texture_data.a;\n  if(blurV < 0.5) {\n    outputColor.a *= mix(u_blur.r, u_blur.g, blurV/0.5);\n  } else {\n    outputColor.a *= mix(u_blur.g, u_blur.b, (blurV - 0.5)/0.5);\n  }\n  \n  outputColor = filterColor(outputColor);\n}\n',vert:'\n#define Animate 0.0\n\nlayout(location = 0) in vec3 a_Position;\nlayout(location = 1) in vec4 a_Color;\nlayout(location = 9) in vec2 a_Size;\nlayout(location = 10) in vec3 a_DistanceAndIndexAndMiter;\nlayout(location = 13) in vec4 a_Normal_Total_Distance;\nlayout(location = 14) in vec2 a_iconMapUV;\n\nlayout(std140) uniform commonUniorm {\n  vec4 u_animate: [ 1., 2., 1.0, 0.2 ];\n  vec4 u_dash_array;\n  vec4 u_blur;\n  vec4 u_sourceColor;\n  vec4 u_targetColor;\n  vec2 u_textSize;\n  float u_icon_step: 100;\n  float u_heightfixed: 0.0;\n  float u_vertexScale: 1.0;\n  float u_raisingHeight: 0.0;\n  float u_strokeWidth: 0.0;\n  float u_textureBlend;\n  float u_line_texture;\n  float u_linearDir: 1.0;\n  float u_linearColor: 0;\n  float u_time;\n};\n\n\nout vec4 v_color;\nout vec4 v_stroke;\n//dash\nout vec4 v_dash_array;\nout float v_d_distance_ratio;\n// texV 线图层 - 贴图部分的 v 坐标（线的宽度方向）\nout vec2 v_iconMapUV;\nout vec4 v_texture_data;\n\n#pragma include "projection"\n#pragma include "picking"\n\nvoid main() {\n  vec2 a_DistanceAndIndex = a_DistanceAndIndexAndMiter.xy;\n  float a_Miter = a_DistanceAndIndexAndMiter.z;\n  vec3 a_Normal = a_Normal_Total_Distance.xyz;\n  float a_Total_Distance = a_Normal_Total_Distance.w;\n  //dash输出\n  v_dash_array = pow(2.0, 20.0 - u_Zoom) * u_dash_array / a_Total_Distance;\n  v_d_distance_ratio = a_DistanceAndIndex.x / a_Total_Distance;\n\n  // cal style mapping - 数据纹理映射部分的计算\n  float d_texPixelLen;    // 贴图的像素长度，根据地图层级缩放\n  v_iconMapUV = a_iconMapUV;\n  d_texPixelLen = project_float_pixel(u_icon_step);\n  if(u_CoordinateSystem == COORDINATE_SYSTEM_P20_2) {\n    d_texPixelLen *= 10.0;\n  }\n\n  v_color = a_Color;\n  v_color.a *= opacity;\n  v_stroke = stroke;\n\n  vec3 size = a_Miter * setPickingSize(a_Size.x) * reverse_offset_normal(a_Normal);\n  \n  vec2 offset = project_pixel(size.xy);\n\n  float lineDistance = a_DistanceAndIndex.x;\n  float currentLinePointRatio = lineDistance / a_Total_Distance;\n \n\n  float lineOffsetWidth = length(offset + offset * sign(a_Miter)); // 线横向偏移的距离（向两侧偏移的和）\n  float linePixelSize = project_pixel(a_Size.x) * 2.0;  // 定点位置偏移，按地图等级缩放后的距离 单侧 * 2\n  float texV = lineOffsetWidth/linePixelSize; // 线图层贴图部分的 v 坐标值\n  \n  v_texture_data = vec4(currentLinePointRatio, lineDistance, d_texPixelLen, texV);\n  // 设置数据集的参数\n\n  vec4 project_pos = project_position(vec4(a_Position.xy, 0, 1.0));\n\n  // gl_Position = project_common_position_to_clipspace(vec4(project_pos.xy + offset, a_Size.y, 1.0));\n\n  float h = float(a_Position.z) * u_vertexScale; // 线顶点的高度 - 兼容不存在第三个数值的情况 vertex height\n  float lineHeight = a_Size.y; // size 第二个参数代表的高度 [linewidth, lineheight]\n\n  if(u_CoordinateSystem == COORDINATE_SYSTEM_P20_2) { // gaode2.x\n    lineHeight *= 0.2; // 保持和 amap/mapbox 一致的效果\n    h *= 0.2;\n    if(u_heightfixed < 1.0) {\n      lineHeight = project_pixel(a_Size.y);\n    }\n    gl_Position = u_Mvp * (vec4(project_pos.xy + offset, lineHeight + h + u_raisingHeight, 1.0));\n  } else {\n    // 兼容 mapbox 在线高度上的效果表现基本一致\n    if(u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT || u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSET) {\n      // mapbox\n      // 保持高度相对不变\n      float mapboxZoomScale = 4.0/pow(2.0, 21.0 - u_Zoom);\n      h *= mapboxZoomScale;\n      h += u_raisingHeight * mapboxZoomScale;\n      if(u_heightfixed > 0.0) {\n        lineHeight *= mapboxZoomScale;\n      }\n      \n    } else {\n      // amap\n      h += u_raisingHeight;\n      // lineHeight 顶点偏移高度\n      if(u_heightfixed < 1.0) {\n        lineHeight *= pow(2.0, 20.0 - u_Zoom);\n      }\n    }\n\n    gl_Position = project_common_position_to_clipspace(vec4(project_pos.xy + offset, lineHeight + h, 1.0));\n  }\n\n  setPickingColor(a_PickingColor);\n}\n',type:""}}},{key:"registerBuiltinAttributes",value:function(){var e=this;this.styleAttributeService.registerStyleAttribute({name:"distanceAndIndex",type:Rc.Attribute,descriptor:{name:"a_DistanceAndIndexAndMiter",shaderLocation:10,buffer:{usage:Bu.STATIC_DRAW,data:[],type:Bu.FLOAT},size:3,update:function(e,t,n,r,i,o){return void 0===o?[n[3],10,n[4]]:[n[3],o,n[4]]}}}),this.styleAttributeService.registerStyleAttribute({name:"size",type:Rc.Attribute,descriptor:{name:"a_Size",shaderLocation:by.SIZE,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:2,update:function(e){var t=e.size,n=void 0===t?1:t;return Array.isArray(n)?[n[0],n[1]]:[n,0]}}}),this.styleAttributeService.registerStyleAttribute({name:"normal_total_distance",type:Rc.Attribute,descriptor:{name:"a_Normal_Total_Distance",shaderLocation:by.NORMAL,buffer:{usage:Bu.STATIC_DRAW,data:[],type:Bu.FLOAT},size:4,update:function(e,t,n,i,o){return[].concat(r(o),[n[5]])}}}),this.styleAttributeService.registerStyleAttribute({name:"uv",type:Rc.Attribute,descriptor:{name:"a_iconMapUV",shaderLocation:by.UV,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:2,update:function(t){var n=e.iconService.getIconMap()[t.texture]||{x:0,y:0};return[n.x,n.y]}}})}}])}(qy),Tb=function(e){function t(){return f(this,t),h(this,t,arguments)}return d(t,e),c(t,[{key:"getCommonUniformsInfo",value:function(){var e=this.layer.getLayerConfig(),t=e.sourceColor,n=e.targetColor,r=e.lineType,i=void 0===r?"solid":r,o=e.dashArray,a=void 0===o?[10,5,0,0]:o,s=e.vertexHeightScale,u=void 0===s?20:s,c=a;"dash"!==i&&(c=[0,0,0,0]),2===c.length&&c.push(0,0);var l=0,f=[0,0,0,0],h=[0,0,0,0];t&&n&&(f=Ht(t),h=Ht(n),l=1);var d={u_sourceColor:f,u_targetColor:h,u_dash_array:c,u_vertexScale:u,u_linearColor:l};return this.getUniformsBufferInfo(d)}},{key:"initModels",value:function(){var e=this;return ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",e.buildModels());case 1:case"end":return t.stop()}}),t)})))()}},{key:"getShaders",value:function(){return{frag:"\nlayout(std140) uniform commonUniorm {\n  vec4 u_sourceColor;\n  vec4 u_targetColor;\n  vec4 u_dash_array;\n  float u_vertexScale: 1.0;\n  float u_linearColor: 0;\n};\nin float v_distanceScale;\nin vec4 v_color;\n//dash\nin vec4 v_dash_array;\n\nout vec4 outputColor;\nvoid main() {\n  if(u_dash_array!=vec4(0.0)){\n    float dashLength = mod(v_distanceScale, v_dash_array.x + v_dash_array.y + v_dash_array.z + v_dash_array.w);\n    if(!(dashLength < v_dash_array.x || (dashLength > (v_dash_array.x + v_dash_array.y) && dashLength <  v_dash_array.x + v_dash_array.y + v_dash_array.z))) {\n      // 虚线部分\n      discard;\n    };\n  }\n  if(u_linearColor==1.0){\n    outputColor = mix(u_sourceColor, u_targetColor, v_distanceScale);\n    outputColor.a *= v_color.a; // 全局透明度\n  }\n  else{\n    outputColor = v_color;\n  }\n}\n",vert:'layout(location = 0) in vec3 a_Position;\nlayout(location = 1) in vec4 a_Color;\nlayout(location = 9) in vec4 a_SizeDistanceAndTotalDistance;\n\nlayout(std140) uniform commonUniorm {\n  vec4 u_sourceColor;\n  vec4 u_targetColor;\n  vec4 u_dash_array;\n  float u_vertexScale: 1.0;\n  float u_linearColor: 0;\n};\n\n#pragma include "projection"\n#pragma include "picking"\n\nout vec4 v_color;\nout float v_distanceScale;\nout vec4 v_dash_array;\n\nvoid main() {\n  //dash输出\n  v_dash_array = pow(2.0, 20.0 - u_Zoom) * u_dash_array / a_SizeDistanceAndTotalDistance.a;\n\n  v_color = a_Color; \n  v_distanceScale = a_SizeDistanceAndTotalDistance.b / a_SizeDistanceAndTotalDistance.a;\n  v_color.a = v_color.a * opacity;\n  vec4 project_pos = project_position(vec4(a_Position.xy, 0, 1.0));\n\n  float h = float(a_Position.z) * u_vertexScale; // 线顶点的高度 - 兼容不存在第三个数值的情况\n\n  if(u_CoordinateSystem == COORDINATE_SYSTEM_P20_2) { // gaode2.x\n    gl_Position = u_Mvp * (vec4(project_pos.xy, project_pixel(a_SizeDistanceAndTotalDistance.y) + h * 0.2, 1.0));\n  } else {\n    float lineHeight = a_SizeDistanceAndTotalDistance.y;\n    // 兼容 mapbox 在线高度上的效果表现基本一致\n    if(u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT || u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSET) {\n      // 保持高度相对不变\n      h *= 2.0/pow(2.0, 20.0 - u_Zoom);\n    }\n\n    // amap1.x\n    if(u_CoordinateSystem == COORDINATE_SYSTEM_P20 || u_CoordinateSystem == COORDINATE_SYSTEM_P20_OFFSET) {\n      // 保持高度相对不变\n      lineHeight *= pow(2.0, 20.0 - u_Zoom);\n    }\n\n    gl_Position = project_common_position_to_clipspace(vec4(project_pos.xy, lineHeight + h, 1.0));\n    gl_PointSize = 10.0;\n  }\n}\n',type:"lineSimpleNormal"}}},{key:"buildModels",value:function(){var e=this;return ie(i().mark((function t(){var n,r,o,a,s;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.initUniformsBuffer(),n=e.getShaders(),r=n.frag,o=n.vert,a=n.type,t.next=4,e.layer.buildLayerModel({moduleName:a,vertexShader:o,fragmentShader:r,triangulation:eb,inject:e.getInject(),primitive:Bu.LINES,depth:{enable:!1},pick:!1});case 4:return s=t.sent,t.abrupt("return",[s]);case 6:case"end":return t.stop()}}),t)})))()}},{key:"registerBuiltinAttributes",value:function(){this.styleAttributeService.registerStyleAttribute({name:"sizeDistanceAndTotalDistance",type:Rc.Attribute,descriptor:{name:"a_SizeDistanceAndTotalDistance",shaderLocation:by.SIZE,buffer:{usage:Bu.STATIC_DRAW,data:[],type:Bu.FLOAT},size:4,update:function(e,t,n){var r=e.size,i=void 0===r?1:r,o=Array.isArray(i)?[i[0],i[1]]:[i,0];return[o[0],o[1],n[3],n[5]]}}})}}])}(qy),Rb=function(e){function t(){var e;f(this,t);for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];return e=h(this,t,[].concat(r)),ne(e,"texture",void 0),ne(e,"updateTexture",(function(){var t=e.rendererService.createTexture2D;if(e.texture)return e.texture.update({data:e.iconService.getCanvas()}),void e.layer.render();e.texture=t({data:e.iconService.getCanvas(),mag:Bu.NEAREST,min:Bu.NEAREST,premultiplyAlpha:!1,width:1024,height:e.iconService.canvasHeight||128}),e.textures=[e.texture]})),e}return d(t,e),c(t,[{key:"getCommonUniformsInfo",value:function(){var e,t=this.layer.getLayerConfig(),n=t.sourceColor,r=t.targetColor,i=t.textureBlend,o=void 0===i?"normal":i,a=t.heightfixed,s=void 0!==a&&a,u=t.lineTexture,c=void 0!==u&&u,l=t.iconStep,f=void 0===l?100:l,h=t.iconStepCount,d=void 0===h?1:h,p=this.layer.getLayerConfig().animateOption;this.rendererService.getDirty()&&(null===(e=this.texture)||void 0===e||e.bind());var v=0,m=[0,0,0,0],g=[0,0,0,0];n&&r&&(m=Ht(n),g=Ht(r),v=1);var _={u_animate:this.animateOption2Array(p),u_sourceColor:m,u_targetColor:g,u_textSize:[1024,this.iconService.canvasHeight||128],u_icon_step:f,u_heightfixed:Number(s),u_linearColor:v,u_line_texture:c?1:0,u_textureBlend:"normal"===o?0:1,u_iconStepCount:d,u_time:this.layer.getLayerAnimateTime()||0};return this.getUniformsBufferInfo(_)}},{key:"initModels",value:function(){var e=this;return ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.initUniformsBuffer(),e.updateTexture(),e.iconService.on("imageUpdate",e.updateTexture),t.abrupt("return",e.buildModels());case 4:case"end":return t.stop()}}),t)})))()}},{key:"clearModels",value:function(){var e;null===(e=this.texture)||void 0===e||e.destroy(),this.iconService.off("imageUpdate",this.updateTexture)}},{key:"buildModels",value:function(){var e=this;return ie(i().mark((function t(){var n;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.layer.buildLayerModel({moduleName:"lineWall",vertexShader:'#define Animate 0.0\nlayout(location = 0) in vec3 a_Position;\nlayout(location = 1) in vec4 a_Color;\nlayout(location = 9) in vec2 a_Size;\nlayout(location = 10) in float a_Miter;\nlayout(location = 11) in float a_Total_Distance;\nlayout(location = 12) in vec4 a_Instance;\nlayout(location = 13) in vec3 a_Normal;\nlayout(location = 14) in vec2 a_iconMapUV;\nlayout(location = 15) in float a_Distance;\n\n\nlayout(std140) uniform commonUniorm {\n  vec4 u_animate: [ 1., 2., 1.0, 0.2 ];\n  vec4 u_sourceColor;\n  vec4 u_targetColor;\n  vec2 u_textSize;\n  float u_icon_step: 100;\n  float u_heightfixed;\n  float u_linearColor: 0;\n  float u_line_texture;\n  float u_textureBlend;\n  float u_iconStepCount;\n  float u_time;\n};\n#pragma include "projection"\n#pragma include "light"\n#pragma include "picking"\n\n// texV 线图层 - 贴图部分的 v 坐标（线的宽度方向）\nout vec2 v_iconMapUV;\nout vec4 v_color;\nout float v_blur;\nout float v_radio;\nout vec4 v_dataset;\n\nvoid main() {\n\n\n  float d_distance_ratio; // 当前点位距离占线总长的比例\n  float d_texPixelLen;    // 贴图的像素长度，根据地图层级缩放\n\n  v_iconMapUV = a_iconMapUV;\n  if(u_heightfixed < 1.0) {     // 高度随 zoom 调整\n    d_texPixelLen = project_pixel(u_icon_step);\n  } else {\n    d_texPixelLen = u_icon_step;\n  }\n  if(u_CoordinateSystem == COORDINATE_SYSTEM_P20_2) {\n    d_texPixelLen *= 10.0;\n  }\n\n  if(u_animate.x == Animate || u_linearColor == 1.0) {\n      d_distance_ratio = a_Distance / a_Total_Distance;\n  }\n\n  float miter = (a_Miter + 1.0)/2.0;\n  // 设置数据集的参数\n  v_dataset[0] = d_distance_ratio; // 当前点位距离占线总长的比例\n  v_dataset[1] = a_Distance;       // 当前顶点的距离\n  v_dataset[2] = d_texPixelLen;    // 贴图的像素长度，根据地图层级缩放\n  v_dataset[3] = miter;          // 线图层贴图部分的 v 坐标值 0 - 1\n\n  vec4 project_pos = project_position(vec4(a_Position.xy, 0, 1.0));\n\n  float originSize = a_Size.x;  // 固定高度\n  if(u_heightfixed < 1.0) {    \n     originSize = project_float_meter(a_Size.x); // 高度随 zoom 调整\n  }\n\n\n  float wallHeight = originSize * miter;\n  float lightWeight = calc_lighting(vec4(project_pos.xy, wallHeight, 1.0));\n\n  v_blur = min(project_float_pixel(2.0) / originSize, 0.05);\n  v_color = vec4(a_Color.rgb * lightWeight, a_Color.w * opacity);\n\n  if(u_CoordinateSystem == COORDINATE_SYSTEM_P20_2) { // gaode2.x\n    gl_Position = u_Mvp * (vec4(project_pos.xy, wallHeight, 1.0));\n  } else {\n// 兼容 mapbox 在线高度上的效果表现基本一致\n    if(u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT || u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSET) {\n      // mapbox\n      // 保持高度相对不变\n      float mapboxZoomScale = 4.0 / pow(2.0, 21.0 - u_Zoom);\n      if(u_heightfixed > 0.0) {\n        wallHeight *= mapboxZoomScale;\n      }\n      \n    } else {\n      // lineHeight 顶点偏移高度\n      if(u_heightfixed < 1.0) {\n        wallHeight *= pow(2.0, 20.0 - u_Zoom);\n      }\n    }\n    gl_Position = project_common_position_to_clipspace(vec4(project_pos.xy, wallHeight, 1.0));\n  }\n\n  setPickingColor(a_PickingColor);\n}\n',fragmentShader:'#define Animate 0.0\n#define LineTexture 1.0\n\n// line texture\n\nuniform sampler2D u_texture;\nlayout(std140) uniform commonUniorm {\n  vec4 u_animate: [ 1., 2., 1.0, 0.2 ];\n  vec4 u_sourceColor;\n  vec4 u_targetColor;\n  vec2 u_textSize;\n  float u_icon_step: 100;\n  float u_heightfixed;\n  float u_linearColor: 0;\n  float u_line_texture;\n  float u_textureBlend;\n  float u_iconStepCount;\n  float u_time;\n};\nin vec2 v_iconMapUV;\nin float v_blur;\nin float v_radio;\nin vec4 v_color;\nin vec4 v_dataset;\n\nout vec4 outputColor;\n#pragma include "picking"\n\nvoid main() {\n  float animateSpeed = 0.0; // 运动速度\n  float d_distance_ratio = v_dataset.r; // 当前点位距离占线总长的比例\n  float v = v_dataset.a;\n\n  if(u_linearColor == 1.0) { // 使用渐变颜色\n    outputColor = mix(u_sourceColor, u_targetColor, v);\n  } else { // 使用 color 方法传入的颜色\n     outputColor = v_color;\n  }\n\n  outputColor.a *= v_color.a; // 全局透明度\n  if(u_animate.x == Animate) {\n      animateSpeed = u_time / u_animate.y;\n       float alpha =1.0 - fract( mod(1.0- d_distance_ratio, u_animate.z)* (1.0/ u_animate.z) + animateSpeed);\n      alpha = (alpha + u_animate.w -1.0) / u_animate.w;\n      alpha = smoothstep(0., 1., alpha);\n      outputColor.a *= alpha;\n  }\n\n  if(u_line_texture == LineTexture) { // while load texture\n    float aDistance = v_dataset.g;      // 当前顶点的距离\n    float d_texPixelLen = v_dataset.b;  // 贴图的像素长度，根据地图层级缩放\n    float u = fract(mod(aDistance, d_texPixelLen)/d_texPixelLen - animateSpeed);\n    float v = v_dataset.a;  // 线图层贴图部分的 v 坐标值\n\n    // 计算纹理间隔 start\n    float flag = 0.0;\n    if(u > 1.0/u_iconStepCount) {\n      flag = 1.0;\n    }\n    u = fract(u*u_iconStepCount);\n    // 计算纹理间隔 end\n\n    vec2 uv= v_iconMapUV / u_textSize + vec2(u, v) / u_textSize * 64.;\n    vec4 pattern = texture(SAMPLER_2D(u_texture), uv);\n\n    // Tip: 判断纹理间隔\n    if(flag > 0.0) {\n      pattern = vec4(0.0);\n    }\n\n    if(u_textureBlend == 0.0) { // normal\n      pattern.a = 0.0;\n      outputColor = filterColor(outputColor + pattern);\n    } else { // replace\n        pattern.a *= v_color.a;\n        if(outputColor.a <= 0.0) {\n          pattern.a = 0.0;\n        }\n        outputColor = filterColor(pattern);\n    }\n  }\n  \n\n  // blur - AA\n  if(v < v_blur) {\n    outputColor.a = mix(0.0, outputColor.a, v/v_blur);\n  } else if(v > 1.0 - v_blur) {\n    outputColor.a = mix(outputColor.a, 0.0, (v - (1.0 - v_blur))/v_blur);\n  }\n\n  outputColor = filterColor(outputColor);\n}\n',triangulation:JE,inject:e.getInject(),depth:{enable:!1},blend:e.getBlend()});case 2:return n=t.sent,t.abrupt("return",[n]);case 4:case"end":return t.stop()}}),t)})))()}},{key:"registerBuiltinAttributes",value:function(){var e=this;this.styleAttributeService.registerStyleAttribute({name:"distance",type:Rc.Attribute,descriptor:{name:"a_Distance",shaderLocation:15,buffer:{usage:Bu.STATIC_DRAW,data:[],type:Bu.FLOAT},size:1,update:function(e,t,n){return[n[3]]}}}),this.styleAttributeService.registerStyleAttribute({name:"total_distance",type:Rc.Attribute,descriptor:{name:"a_Total_Distance",shaderLocation:11,buffer:{usage:Bu.STATIC_DRAW,data:[],type:Bu.FLOAT},size:1,update:function(e,t,n){return[n[5]]}}}),this.styleAttributeService.registerStyleAttribute({name:"size",type:Rc.Attribute,descriptor:{name:"a_Size",shaderLocation:by.SIZE,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:2,update:function(e){var t=e.size,n=void 0===t?1:t;return Array.isArray(n)?[n[0],n[1]]:[n,0]}}}),this.styleAttributeService.registerStyleAttribute({name:"normal",type:Rc.Attribute,descriptor:{name:"a_Normal",shaderLocation:by.NORMAL,buffer:{usage:Bu.STATIC_DRAW,data:[],type:Bu.FLOAT},size:3,update:function(e,t,n,r,i){return i}}}),this.styleAttributeService.registerStyleAttribute({name:"miter",type:Rc.Attribute,descriptor:{name:"a_Miter",shaderLocation:10,buffer:{usage:Bu.STATIC_DRAW,data:[],type:Bu.FLOAT},size:1,update:function(e,t,n){return[n[4]]}}}),this.styleAttributeService.registerStyleAttribute({name:"uv",type:Rc.Attribute,descriptor:{name:"a_iconMapUV",shaderLocation:14,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:2,update:function(t){var n=e.iconService.getIconMap()[t.texture]||{x:0,y:0};return[n.x,n.y]}}})}}])}(qy),Cb={arc:db,arc3d:vb,greatcircle:xb,wall:Rb,line:Sb,simple:Tb,flowline:bb,earthArc3d:vb},Mb=function(e){function t(){var e;f(this,t);for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];return e=h(this,t,[].concat(r)),ne(e,"type","LineLayer"),ne(e,"enableShaderEncodeStyles",["stroke","offsets","opacity","thetaOffset"]),ne(e,"arrowInsertCount",0),ne(e,"defaultSourceConfig",{data:[{lng1:100,lat1:30,lng2:130,lat2:30}],options:{parser:{type:"json",x:"lng1",y:"lat1",x1:"lng2",y1:"lat2"}}}),e}return d(t,e),c(t,[{key:"buildModels",value:function(){var e=this;return ie(i().mark((function t(){var n;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.getModelType(),e.layerModel=new Cb[n](e),t.next=4,e.initLayerModels();case 4:case"end":return t.stop()}}),t)})))()}},{key:"getDefaultConfig",value:function(){return{line:{},linearline:{},simple:{},wall:{},arc3d:{blend:"additive"},arc:{blend:"additive"},greatcircle:{blend:"additive"},tileLine:{},earthArc3d:{},flowline:{},arrow:{}}[this.getModelType()]}},{key:"getModelType",value:function(){var e;if(this.layerType)return this.layerType;var t=this.styleAttributeService.getLayerStyleAttribute("shape");return(null==t||null===(e=t.scale)||void 0===e?void 0:e.field)||"line"}},{key:"processData",value:function(e){if("simple"!==this.getModelType())return e;var t=[];return e.map((function(e){if(Array.isArray(e.coordinates)&&Array.isArray(e.coordinates[0])&&Array.isArray(e.coordinates[0][0])){var n=re({},e);e.coordinates.map((function(e){t.push(re(re({},n),{},{coordinates:e}))}))}else t.push(e)})),t}}])}(Vy);function wb(e){var t=e.coordinates;return{vertices:r(t),indices:[0],size:t.length}}var Lb=function(e){function t(){return f(this,t),h(this,t,arguments)}return d(t,e),c(t,[{key:"getDefaultStyle",value:function(){return{blend:"additive"}}},{key:"getCommonUniformsInfo",value:function(){var e=this.layer.getLayerConfig(),t=e.blend,n=e.strokeOpacity,r=void 0===n?1:n,i=e.strokeWidth,o=void 0===i?0:i,a=e.stroke,s={u_stroke_color:Ht(void 0===a?"#fff":a),u_additive:"additive"===t?1:0,u_stroke_opacity:r,u_stroke_width:o};return this.getUniformsBufferInfo(s)}},{key:"initModels",value:function(){var e=this;return ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",e.buildModels());case 1:case"end":return t.stop()}}),t)})))()}},{key:"buildModels",value:function(){var e=this;return ie(i().mark((function t(){var n;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.layer.triangulation=wb,e.initUniformsBuffer(),t.next=4,e.layer.buildLayerModel({moduleName:"pointSimple",vertexShader:'\nlayout(location = 0) in vec3 a_Position;\nlayout(location = 1) in vec4 a_Color;\nlayout(location = 9) in float a_Size;\n\nlayout(std140) uniform commonUniorm {\n  vec4 u_stroke_color;\n  float u_additive;\n  float u_stroke_opacity;\n  float u_stroke_width;\n};\n\nout vec4 v_color;\nout float v_blur;\nout float v_innerRadius;\n\n#pragma include "projection"\n#pragma include "picking"\n#pragma include "project"\nvoid main() {\n  v_color = vec4(a_Color.xyz, a_Color.w * opacity);\n  v_blur = 1.0 - max(2.0/a_Size, 0.05);\n  v_innerRadius = max((a_Size - u_stroke_width) / a_Size, 0.0);\n  \n  vec2 offset = project_pixel(u_offsets);\n  \n  if(u_CoordinateSystem == COORDINATE_SYSTEM_P20_2) { // gaode2.x\n    gl_Position = u_Mvp * vec4(a_Position.xy + offset, a_Position.z, 1.0);\n  } else { // else\n    vec4 project_pos = project_position(vec4(a_Position, 1.0)) + vec4(a_Size / 2.,-a_Size /2.,0.,0.);\n    gl_Position = project_common_position_to_clipspace(vec4(vec2(project_pos.xy+offset),project_pos.z,project_pos.w));\n  }\n  \n  gl_PointSize = a_Size * 2.0 * u_DevicePixelRatio;\n  setPickingColor(a_PickingColor);\n}\n',fragmentShader:'\nlayout(std140) uniform commonUniorm {\n  vec4 u_stroke_color;\n  float u_additive;\n  float u_stroke_opacity;\n  float u_stroke_width;\n};\n\nin vec4 v_color;\nin float v_blur;\nin float v_innerRadius;\n\nout vec4 outputColor;\n\n#pragma include "picking"\nvoid main() {\n  vec2 center = vec2(0.5);\n\n  // Tip: 片元到中心点的距离 0 - 1\n  float fragmengTocenter = distance(center, gl_PointCoord) * 2.0;\n  // Tip: 片元的剪切成圆形\n  float circleClipOpacity = 1.0 - smoothstep(v_blur, 1.0, fragmengTocenter);\n\n\n  if(v_innerRadius < 0.99) {\n    // 当存在 stroke 且 stroke > 0.01\n    float blurWidth = (1.0 - v_blur)/2.0;\n    vec4 stroke = vec4(u_stroke_color.rgb, u_stroke_opacity);\n    if(fragmengTocenter > v_innerRadius + blurWidth) {\n      outputColor = stroke;\n    } else if(fragmengTocenter > v_innerRadius - blurWidth){\n      float mixR = (fragmengTocenter - (v_innerRadius - blurWidth)) / (blurWidth * 2.0);\n      outputColor = mix(v_color, stroke, mixR);\n    } else {\n      outputColor = v_color;\n    }\n  } else {\n    // 当不存在 stroke 或 stroke <= 0.01\n    outputColor = v_color;\n  }\n\n  outputColor = filterColor(outputColor);\n  \n  if(u_additive > 0.0) {\n    outputColor *= circleClipOpacity;\n  } else {\n    outputColor.a *= circleClipOpacity;\n  }\n\n}\n',inject:e.getInject(),triangulation:wb,depth:{enable:!1},primitive:Bu.POINTS});case 4:return n=t.sent,t.abrupt("return",[n]);case 6:case"end":return t.stop()}}),t)})))()}},{key:"registerBuiltinAttributes",value:function(){this.styleAttributeService.registerStyleAttribute({name:"size",type:Rc.Attribute,descriptor:{name:"a_Size",shaderLocation:by.SIZE,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:1,update:function(e){var t=e.size,n=void 0===t?1:t;return Array.isArray(n)?[n[0]]:[n]}}})}}])}(qy),Ob=Ni.isNumber,kb=function(e){function t(){var e;f(this,t);for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];return e=h(this,t,[].concat(r)),ne(e,"raiseCount",0),ne(e,"raiseRepeat",0),e}return d(t,e),c(t,[{key:"getCommonUniformsInfo",value:function(){var e=this.layer.getLayerConfig(),t=e.animateOption,n=void 0===t?{enable:!1,speed:.01,repeat:!1}:t,r=e.opacity,i=void 0===r?1:r,o=e.sourceColor,a=e.targetColor,s=e.pickLight,u=void 0!==s&&s,c=e.heightfixed,l=void 0===c||c,f=e.opacityLinear,h=void 0===f?{enable:!1,dir:"up"}:f,d=e.lightEnable,p=void 0===d||d,v=0,m=[0,0,0,0],g=[0,0,0,0];if(o&&a&&(m=Ht(o),g=Ht(a),v=1),this.raiseCount<1&&this.raiseRepeat>0&&n.enable){var _=n.speed,y=void 0===_?.01:_;this.raiseCount+=y,this.raiseCount>=1&&(this.raiseRepeat>1?(this.raiseCount=0,this.raiseRepeat--):this.raiseCount=1)}var E={u_sourceColor:m,u_targetColor:g,u_linearColor:v,u_pickLight:Number(u),u_heightfixed:Number(l),u_r:n.enable&&this.raiseRepeat>0?this.raiseCount:1,u_opacity:Ob(i)?i:1,u_opacitylinear:Number(h.enable),u_opacitylinear_dir:"up"===h.dir?1:0,u_lightEnable:Number(p)};return this.getUniformsBufferInfo(E)}},{key:"initModels",value:function(){var e=this;return ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.initUniformsBuffer(),t.abrupt("return",e.buildModels());case 2:case"end":return t.stop()}}),t)})))()}},{key:"buildModels",value:function(){var e=this;return ie(i().mark((function t(){var n,r,o,a;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.layer.getLayerConfig(),r=n.animateOption.repeat,o=void 0===r?1:r,e.raiseRepeat=o,t.next=4,e.layer.buildLayerModel({moduleName:"pointEarthExtrude",vertexShader:'precision highp float;\n\n#define pi 3.1415926535\n#define ambientRatio 0.5\n#define diffuseRatio 0.3\n#define specularRatio 0.2\n\n\nlayout(location = 0) in vec3 a_Position;\nlayout(location = 1) in vec4 a_Color;\nlayout(location = 9) in vec3 a_Size;\nlayout(location = 11) in vec3 a_Pos;\nlayout(location = 13) in vec3 a_Normal;\n\n\nlayout(std140) uniform commonUniform {\n  vec4 u_sourceColor;\n  vec4 u_targetColor;\n  float u_linearColor: 0;\n  float u_heightfixed: 0.0; // 默认不固定\n  float u_globel;\n  float u_r;\n  float u_pickLight: 0.0;\n  float u_opacitylinear: 0.0;\n  float u_opacitylinear_dir: 1.0;\n  float u_lightEnable: 1.0;\n};\n\nout vec4 v_color;\nout float v_lightWeight;\nout float v_barLinearZ;\n// 用于将在顶点着色器中计算好的样式值传递给片元\n\n\n#pragma include "projection"\n#pragma include "light"\n#pragma include "picking"\n\nfloat getYRadian(float x, float z) {\n  if(x > 0.0 && z > 0.0) {\n    return atan(x/z);\n  } else if(x > 0.0 && z <= 0.0){\n    return atan(-z/x) + pi/2.0;\n  } else if(x <= 0.0 && z <= 0.0) {\n    return  pi + atan(x/z); //atan(x/z) + \n  } else {\n    return atan(z/-x) + pi*3.0/2.0;\n  }\n}\n\nfloat getXRadian(float y, float r) {\n  return atan(y/r);\n}\n\nvoid main() {\n\n  // cal style mapping - 数据纹理映射部分的计算\n  vec3 size = a_Size * a_Position;\n\n  // a_Position.z 是在构建网格的时候传入的标准值 0 - 1，在插值器插值可以获取 0～1 线性渐变的值\n  v_barLinearZ =  a_Position.z;\n\n  vec3 offset = size; // 控制圆柱体的大小 - 从标准单位圆柱体进行偏移\n  if(u_heightfixed < 1.0) { // 圆柱体不固定高度\n    \n    if (u_CoordinateSystem == COORDINATE_SYSTEM_P20 || u_CoordinateSystem == COORDINATE_SYSTEM_P20_OFFSET) {\n      // P20 坐标系下，为了和 Web 墨卡托坐标系统一，zoom 默认减1\n      offset = offset * pow(2.0, (19.0 - u_Zoom));\n    }\n    if(u_CoordinateSystem == COORDINATE_SYSTEM_P20_2) {\n      // P20_2 坐标系下，为了和 Web 墨卡托坐标系统一，zoom 默认减3\n      offset = offset * pow(2.0, (19.0 - 3.0 - u_Zoom));\n    }\n  } else {// 圆柱体固定高度 （ 处理 mapbox ）\n    if(u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT || u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSET) {\n      offset *= 4.0/pow(2.0, 21.0 - u_Zoom);\n    }\n  }\n\n\n  vec4 project_pos = project_position(vec4(a_Pos.xy, 0., 1.0));\n\n  // u_r 控制圆柱的生长\n  vec4 pos = vec4(project_pos.xy + offset.xy, offset.z * u_r, 1.0);\n\n  // 圆柱光照效果\n  float lightWeight = 1.0;\n  if(u_lightEnable > 0.0) { // 取消三元表达式，增强健壮性\n    lightWeight = calc_lighting(pos);\n  }\n  v_lightWeight = lightWeight;\n  // 设置圆柱的底色\n  if(u_linearColor == 1.0) { // 使用渐变颜色\n    v_color = mix(u_sourceColor, u_targetColor, v_barLinearZ);\n    v_color.rgb *= lightWeight;\n  } else { // 使用 color 方法传入的颜色\n     v_color = a_Color;\n  }\n  v_color.a *= u_opacity;\n\n    \n  // 在地球模式下，将原本垂直于 xy 平面的圆柱调整姿态到适应圆的角度\n  //旋转矩阵mx，创建绕x轴旋转矩阵\n  float r = sqrt(a_Pos.z*a_Pos.z + a_Pos.x*a_Pos.x);\n  float xRadian = getXRadian(a_Pos.y, r);\n  float xcos = cos(xRadian);//求解旋转角度余弦值\n  float xsin = sin(xRadian);//求解旋转角度正弦值\n  mat4 mx = mat4(\n    1,0,0,0,  \n    0,xcos,-xsin,0,  \n    0,xsin,xcos,0,  \n    0,0,0,1);\n\n  //旋转矩阵my，创建绕y轴旋转矩阵\n  float yRadian = getYRadian(a_Pos.x, a_Pos.z);\n  float ycos = cos(yRadian);//求解旋转角度余弦值\n  float ysin = sin(yRadian);//求解旋转角度正弦值\n  mat4 my = mat4(\n    ycos,0,-ysin,0,  \n    0,1,0,0,  \n    ysin,0,ycos,0,  \n    0,0,0,1);\n\n  gl_Position = u_ViewProjectionMatrix * vec4(( my * mx *  vec4(a_Position * a_Size, 1.0)).xyz + a_Pos, 1.0);\n  \n\n  setPickingColor(a_PickingColor);\n}\n',fragmentShader:'precision highp float;\nin vec4 v_color;\n\n#pragma include "picking"\n\nlayout(std140) uniform commonUniform {\n  vec4 u_sourceColor;\n  vec4 u_targetColor;\n  float u_linearColor: 0;\n  float u_heightfixed: 0.0; // 默认不固定\n  float u_globel;\n  float u_r;\n  float u_pickLight: 0.0;\n  float u_opacitylinear: 0.0;\n  float u_opacitylinear_dir: 1.0;\n  float u_lightEnable: 1.0;\n};\nin float v_lightWeight;\nin float v_barLinearZ;\nout vec4 outputColor;\nvoid main() {\n\n   outputColor = v_color;\n\n  // 开启透明度渐变\n  if(u_opacitylinear > 0.0) {\n    outputColor.a *= u_opacitylinear_dir > 0.0 ? (1.0 - v_barLinearZ): v_barLinearZ;\n  }\n\n  // picking\n  if(u_pickLight > 0.0) {\n    outputColor = filterColorAlpha(outputColor, v_lightWeight);\n  } else {\n    outputColor = filterColor(outputColor);\n  }\n}\n',triangulation:QE,depth:{enable:!0},inject:e.getInject(),cull:{enable:!0,face:Qt(e.mapService.version)},blend:e.getBlend()});case 4:return a=t.sent,t.abrupt("return",[a]);case 6:case"end":return t.stop()}}),t)})))()}},{key:"registerBuiltinAttributes",value:function(){this.styleAttributeService.registerStyleAttribute({name:"size",type:Rc.Attribute,descriptor:{name:"a_Size",shaderLocation:by.SIZE,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:3,update:function(e){var t=e.size;if(t){var n=[];return Array.isArray(t)&&(n=2===t.length?[t[0],t[0],t[1]]:t),Array.isArray(t)||(n=[t,t,t]),n}return[2,2,2]}}}),this.styleAttributeService.registerStyleAttribute({name:"normal",type:Rc.Attribute,descriptor:{name:"a_Normal",shaderLocation:by.NORMAL,buffer:{usage:Bu.STATIC_DRAW,data:[],type:Bu.FLOAT},size:3,update:function(e,t,n,r,i){return i}}}),this.styleAttributeService.registerStyleAttribute({name:"pos",type:Rc.Attribute,descriptor:{name:"a_Pos",shaderLocation:15,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:3,update:function(e){var t=ro(e.coordinates);return ME([t[0],t[1]])}}})}}])}(qy),Nb=function(e){function t(){return f(this,t),h(this,t,arguments)}return d(t,e),c(t,[{key:"getCommonUniformsInfo",value:function(){var e=this.layer.getLayerConfig(),t=e.strokeOpacity,n=void 0===t?1:t,r=e.strokeWidth,i=void 0===r?0:r,o=e.blend,a=e.blur,s=void 0===a?0:a;this.layer.getLayerConfig();var u={u_additive:"additive"===o?1:0,u_stroke_opacity:n,u_stroke_width:i,u_blur:s};return this.getUniformsBufferInfo(u)}},{key:"initModels",value:function(){var e=this;return ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.initUniformsBuffer(),t.abrupt("return",e.buildModels());case 2:case"end":return t.stop()}}),t)})))()}},{key:"buildModels",value:function(){var e=this;return ie(i().mark((function t(){var n;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.layer.triangulation=KE,t.next=3,e.layer.buildLayerModel({moduleName:"pointEarthFill",vertexShader:'layout(location = 0) in vec3 a_Position;\nlayout(location = 1) in vec4 a_Color;\nlayout(location = 9) in float a_Size;\nlayout(location = 10) in float a_Shape;\nlayout(location = 11) in vec3 a_Extrude;\n\nlayout(std140) uniform commonUniform {\n  float u_additive;\n  float u_stroke_opacity : 1;\n  float u_stroke_width : 2;\n  float u_blur : 0.0;\n};\nout vec4 v_data;\nout vec4 v_color;\nout float v_radius;\n\n#pragma include "projection"\n#pragma include "picking"\n\n\nvoid main() {\n  vec3 extrude = a_Extrude;\n  float shape_type = a_Shape;\n  /*\n  *  setPickingSize 设置拾取大小\n  */\n  float newSize = setPickingSize(a_Size);\n  // float newSize = setPickingSize(a_Size) * 0.00001038445708445579;\n\n  // unpack color(vec2)\n  v_color = a_Color;\n\n  // radius(16-bit)\n  v_radius = newSize;\n\n  // anti-alias\n  //  float antialiased_blur = -max(u_blur, antialiasblur);\n  float antialiasblur = -max(2.0 / u_DevicePixelRatio / newSize, u_blur);\n\n  // TODP: /abs(extrude.x) 是为了兼容地球模式\n  v_data = vec4(extrude.x/abs(extrude.x), extrude.y/abs(extrude.y), antialiasblur,shape_type);\n\n  gl_Position = u_ViewProjectionMatrix * vec4(a_Position + extrude * newSize * 0.1 + vec3(u_offsets,0.0), 1.0);\n\n  setPickingColor(a_PickingColor);\n}',fragmentShader:"in vec4 v_data;\nin vec4 v_color;\nin float v_radius;\n\nlayout(std140) uniform commonUniform {\n  float u_additive;\n  float u_stroke_opacity : 1;\n  float u_stroke_width : 2;\n  float u_blur : 0.0;\n};\n#pragma include \"sdf_2d\"\n#pragma include \"picking\"\n\nout vec4 outputColor;\n\nvoid main() {\n  int shape = int(floor(v_data.w + 0.5));\n\n  vec4 strokeColor = u_stroke == vec4(0.0) ? v_color : u_stroke;\n\n  lowp float antialiasblur = v_data.z;\n  float r = v_radius / (v_radius + u_stroke_width);\n\n  float outer_df;\n  float inner_df;\n  // 'circle', 'triangle', 'square', 'pentagon', 'hexagon', 'octogon', 'hexagram', 'rhombus', 'vesica'\n  if (shape == 0) {\n    outer_df = sdCircle(v_data.xy, 1.0);\n    inner_df = sdCircle(v_data.xy, r);\n  } else if (shape == 1) {\n    outer_df = sdEquilateralTriangle(1.1 * v_data.xy);\n    inner_df = sdEquilateralTriangle(1.1 / r * v_data.xy);\n  } else if (shape == 2) {\n    outer_df = sdBox(v_data.xy, vec2(1.));\n    inner_df = sdBox(v_data.xy, vec2(r));\n  } else if (shape == 3) {\n    outer_df = sdPentagon(v_data.xy, 0.8);\n    inner_df = sdPentagon(v_data.xy, r * 0.8);\n  } else if (shape == 4) {\n    outer_df = sdHexagon(v_data.xy, 0.8);\n    inner_df = sdHexagon(v_data.xy, r * 0.8);\n  } else if (shape == 5) {\n    outer_df = sdOctogon(v_data.xy, 1.0);\n    inner_df = sdOctogon(v_data.xy, r);\n  } else if (shape == 6) {\n    outer_df = sdHexagram(v_data.xy, 0.52);\n    inner_df = sdHexagram(v_data.xy, r * 0.52);\n  } else if (shape == 7) {\n    outer_df = sdRhombus(v_data.xy, vec2(1.0));\n    inner_df = sdRhombus(v_data.xy, vec2(r));\n  } else if (shape == 8) {\n    outer_df = sdVesica(v_data.xy, 1.1, 0.8);\n    inner_df = sdVesica(v_data.xy, r * 1.1, r * 0.8);\n  }\n\n  if(outer_df > antialiasblur + 0.018) discard;\n\n  float opacity_t = smoothstep(0.0, antialiasblur, outer_df);\n\n  float color_t = u_stroke_width < 0.01 ? 0.0 : smoothstep(\n    antialiasblur,\n    0.0,\n    inner_df\n  );\n\n  if(u_stroke_width < 0.01) {\n    outputColor = vec4(v_color.rgb, v_color.a * u_opacity);\n  } else {\n    outputColor = mix(vec4(v_color.rgb, v_color.a * u_opacity), strokeColor * u_stroke_opacity, color_t);\n  }\n\n  if(u_additive > 0.0) {\n    outputColor *= opacity_t;\n    outputColor = filterColorAlpha(outputColor, outputColor.a);\n  } else {\n    outputColor.a *= opacity_t;\n    outputColor = filterColor(outputColor);\n  }\n}\n",triangulation:KE,inject:e.getInject(),depth:{enable:!0},blend:e.getBlend()});case 3:return n=t.sent,t.abrupt("return",[n]);case 5:case"end":return t.stop()}}),t)})))()}},{key:"animateOption2Array",value:function(e){return[e.enable?0:1,e.speed||1,e.rings||3,0]}},{key:"registerBuiltinAttributes",value:function(){var e=this;this.styleAttributeService.registerStyleAttribute({name:"extrude",type:Rc.Attribute,descriptor:{name:"a_Extrude",shaderLocation:by.EXTRUDE,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:3,update:function(e,t,n,i){var o=a(n,3),s=o[0],u=o[1],c=o[2],l=el(0,0,1),f=el(s,0,c),h=s>=0?rl(l,f):2*Math.PI-rl(l,f),d=2*Math.PI-Math.asin(u/100),p=jc();qc(p,p,h),Zc(p,p,d);var v=el(1,1,0);nl(v,v,p),tl(v,v);var m=el(-1,1,0);nl(m,m,p),tl(m,m);var g=el(-1,-1,0);nl(g,g,p),tl(g,g);var _=el(1,-1,0);nl(_,_,p),tl(_,_);var y=[].concat(r(v),r(m),r(g),r(_)),E=i%4*3;return[y[E],y[E+1],y[E+2]]}}}),this.styleAttributeService.registerStyleAttribute({name:"size",type:Rc.Attribute,descriptor:{name:"a_Size",shaderLocation:by.SIZE,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:1,update:function(e){var t=e.size,n=void 0===t?5:t;return Array.isArray(n)?[n[0]]:[n]}}}),this.styleAttributeService.registerStyleAttribute({name:"shape",type:Rc.Attribute,descriptor:{name:"a_Shape",shaderLocation:by.SHAPE,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:1,update:function(t){var n=t.shape,r=void 0===n?2:n;return[e.layer.getLayerConfig().shape2d.indexOf(r)]}}})}}])}(qy),Ib=function(e){function t(){var e;f(this,t);for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];return e=h(this,t,[].concat(r)),ne(e,"raiseCount",0),ne(e,"raiseRepeat",0),e}return d(t,e),c(t,[{key:"getCommonUniformsInfo",value:function(){var e=this.layer.getLayerConfig(),t=e.animateOption,n=void 0===t?{enable:!1,speed:.01,repeat:!1}:t,r=e.sourceColor,i=e.targetColor,o=e.pickLight,a=void 0!==o&&o,s=e.heightfixed,u=void 0!==s&&s,c=e.opacityLinear,l=void 0===c?{enable:!1,dir:"up"}:c,f=e.lightEnable,h=void 0===f||f,d=0,p=[0,0,0,0],v=[0,0,0,0];if(r&&i&&(p=Ht(r),v=Ht(i),d=1),this.raiseCount<1&&this.raiseRepeat>0&&n.enable){var m=n.speed,g=void 0===m?.01:m;this.raiseCount+=g,this.raiseCount>=1&&(this.raiseRepeat>1?(this.raiseCount=0,this.raiseRepeat--):this.raiseCount=1)}var _={u_pickLight:Number(a),u_heightfixed:Number(u),u_r:n.enable&&this.raiseRepeat>0?this.raiseCount:1,u_linearColor:d,u_sourceColor:p,u_targetColor:v,u_opacitylinear:Number(l.enable),u_opacitylinear_dir:"up"===l.dir?1:0,u_lightEnable:Number(h)};return this.getUniformsBufferInfo(_)}},{key:"initModels",value:function(){var e=this;return ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",e.buildModels());case 1:case"end":return t.stop()}}),t)})))()}},{key:"buildModels",value:function(){var e=this;return ie(i().mark((function t(){var n,r,o,a,s,u;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.layer.getLayerConfig(),r=n.depth,o=void 0===r||r,a=n.animateOption.repeat,s=void 0===a?1:a,e.raiseRepeat=s,e.initUniformsBuffer(),t.next=5,e.layer.buildLayerModel({moduleName:"pointExtrude",vertexShader:'#define pi 3.1415926535\n\nlayout(location = 0) in vec3 a_Position;\nlayout(location = 1) in vec4 a_Color;\nlayout(location = 9) in vec3 a_Size;\nlayout(location = 11) in vec3 a_Extrude;\nlayout(location = 13) in vec3 a_Normal;\n\nlayout(std140) uniform commonUniforms {\n  float u_pickLight;\n  float u_heightfixed;\n  float u_r;\n  float u_linearColor;\n  vec4 u_sourceColor;\n  vec4 u_targetColor;\n  float u_opacitylinear;\n  float u_opacitylinear_dir;\n  float u_lightEnable;\n};\nout vec4 v_color;\nout float v_lightWeight;\n\n#pragma include "projection"\n#pragma include "light"\n#pragma include "picking"\n\nfloat getYRadian(float x, float z) {\n  if(x > 0.0 && z > 0.0) {\n    return atan(x/z);\n  } else if(x > 0.0 && z <= 0.0){\n    return atan(-z/x) + pi/2.0;\n  } else if(x <= 0.0 && z <= 0.0) {\n    return  pi + atan(x/z); //atan(x/z) + \n  } else {\n    return atan(z/-x) + pi*3.0/2.0;\n  }\n}\n\nfloat getXRadian(float y, float r) {\n  return atan(y/r);\n}\n\nvoid main() {\n\n\n  vec3 size = a_Size * a_Position;\n\n  vec3 offset = size; // 控制圆柱体的大小 - 从标准单位圆柱体进行偏移\n\n  if(u_heightfixed < 1.0) { // 圆柱体不固定高度\n    \n    if (u_CoordinateSystem == COORDINATE_SYSTEM_P20 || u_CoordinateSystem == COORDINATE_SYSTEM_P20_OFFSET) {\n      // P20 坐标系下，为了和 Web 墨卡托坐标系统一，zoom 默认减1\n      offset = offset * pow(2.0, (19.0 - u_Zoom));\n    }\n    if(u_CoordinateSystem == COORDINATE_SYSTEM_P20_2) {\n      // P20_2 坐标系下，为了和 Web 墨卡托坐标系统一，zoom 默认减3\n      offset = offset * pow(2.0, (19.0 - 3.0 - u_Zoom));\n    }\n  } else {// 圆柱体固定高度 （ 处理 mapbox ）\n    if(u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT || u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSET) {\n      offset *= 4.0/pow(2.0, 21.0 - u_Zoom);\n    }\n  }\n\n\n  vec4 project_pos = project_position(vec4(a_Extrude.xy, 0., 1.0));\n\n  // u_r 控制圆柱的生长\n  vec4 pos = vec4(project_pos.xy + offset.xy, offset.z * u_r, 1.0);\n\n  // // 圆柱光照效果\n  float lightWeight = 1.0;\n\n  if(u_lightEnable > 0.0) { // 取消三元表达式，增强健壮性\n    lightWeight = calc_lighting(pos);\n  }\n\n  v_lightWeight = lightWeight;\n\n  v_color = a_Color;\n\n    // 设置圆柱的底色\n  if(u_linearColor == 1.0) { // 使用渐变颜色\n    v_color = mix(u_sourceColor, u_targetColor, a_Position.z);\n    v_color.a =  v_color.a * opacity;\n  } else {\n    v_color = vec4(a_Color.rgb * lightWeight, a_Color.w * opacity);\n  }\n\n    if(u_opacitylinear > 0.0) {\n    v_color.a *= u_opacitylinear_dir > 0.0 ? (1.0 - a_Position.z): a_Position.z;\n  }\n\n\n  gl_Position = project_common_position_to_clipspace_v2(pos);\n\n  setPickingColor(a_PickingColor);\n}\n',fragmentShader:'\nin vec4 v_color;\nin float v_lightWeight;\nout vec4 outputColor;\n\nlayout(std140) uniform commonUniforms {\n  float u_pickLight;\n  float u_heightfixed;\n  float u_r;\n  float u_linearColor;\n  vec4 u_sourceColor;\n  vec4 u_targetColor;\n  float u_opacitylinear;\n  float u_opacitylinear_dir;\n  float u_lightEnable;\n};\n\n#pragma include "scene_uniforms"\n#pragma include "picking"\n\nvoid main() {\n\n  outputColor = v_color;\n  // 开启透明度渐变\n  // picking\n  if(u_pickLight > 0.0) {\n    outputColor = filterColorAlpha(outputColor, v_lightWeight);\n  } else {\n    outputColor = filterColor(outputColor);\n  }\n}\n',triangulation:QE,inject:e.getInject(),cull:{enable:!0,face:Qt(e.mapService.version)},depth:{enable:o}});case 5:return u=t.sent,t.abrupt("return",[u]);case 7:case"end":return t.stop()}}),t)})))()}},{key:"registerBuiltinAttributes",value:function(){this.styleAttributeService.registerStyleAttribute({name:"size",type:Rc.Attribute,descriptor:{name:"a_Size",shaderLocation:by.SIZE,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:3,update:function(e){var t=e.size;if(t){var n=[];return Array.isArray(t)&&(n=2===t.length?[t[0],t[0],t[1]]:t),Array.isArray(t)||(n=[t,t,t]),n}return[2,2,2]}}}),this.styleAttributeService.registerStyleAttribute({name:"normal",type:Rc.Attribute,descriptor:{name:"a_Normal",shaderLocation:by.NORMAL,buffer:{usage:Bu.STATIC_DRAW,data:[],type:Bu.FLOAT},size:3,update:function(e,t,n,r,i){return i}}}),this.styleAttributeService.registerStyleAttribute({name:"extrude",type:Rc.Attribute,descriptor:{name:"a_Extrude",shaderLocation:by.EXTRUDE,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:3,update:function(e){var t=ro(e.coordinates);return[t[0],t[1],0]}}})}}])}(qy),Pb=function(e){function t(){return f(this,t),h(this,t,arguments)}return d(t,e),c(t,[{key:"getCommonUniformsInfo",value:function(){var e=this.layer.getLayerConfig(),t=e.strokeOpacity,n=void 0===t?1:t,r=e.strokeWidth,i=void 0===r?0:r,o=e.blend,a=e.blur,s=void 0===a?0:a,u=e.raisingHeight,c=void 0===u?0:u,l=e.heightfixed,f=void 0!==l&&l,h=e.unit,d=void 0===h?"pixel":h,p=this.getAnimateUniforms().u_time;isNaN(p)&&(p=-1);var v={u_blur_height_fixed:[s,Number(c),Number(f)],u_stroke_width:i,u_additive:"additive"===o?1:0,u_stroke_opacity:n,u_size_unit:$y[d],u_time:p,u_animate:this.getAnimateUniforms().u_animate};return this.getUniformsBufferInfo(v)}},{key:"getAnimateUniforms",value:function(){var e=this.layer.getLayerConfig().animateOption,t=void 0===e?{enable:!1}:e;return{u_animate:this.animateOption2Array(t),u_time:this.layer.getLayerAnimateTime()}}},{key:"getAttribute",value:function(){return this.styleAttributeService.createAttributesAndIndices(this.layer.getEncodedData(),qE)}},{key:"initModels",value:function(){var e=this;return ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",e.buildModels());case 1:case"end":return t.stop()}}),t)})))()}},{key:"buildModels",value:function(){var e=this;return ie(i().mark((function t(){var n,r,o,a,s;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.getShaders(),r=n.frag,o=n.vert,a=n.type,e.layer.triangulation=qE,e.initUniformsBuffer(),t.next=5,e.layer.buildLayerModel({moduleName:a,vertexShader:o,fragmentShader:r,inject:e.getInject(),triangulation:qE,depth:{enable:!1}});case 5:return s=t.sent,t.abrupt("return",[s]);case 7:case"end":return t.stop()}}),t)})))()}},{key:"getShaders",value:function(){return{frag:"\nlayout(std140) uniform commonUniforms {\n  vec3 u_blur_height_fixed;\n  float u_stroke_width;\n  float u_additive;\n  float u_stroke_opacity;\n  float u_size_unit;\n  float u_time;\n  vec4 u_animate;\n};\n\nin vec4 v_color;\nin vec4 v_stroke;\nin vec4 v_data;\nin float v_radius;\n\n#pragma include \"scene_uniforms\"\n#pragma include \"sdf_2d\"\n#pragma include \"picking\"\n\nout vec4 outputColor;\n\nvoid main() {\n  int shape = int(floor(v_data.w + 0.5));\n  lowp float antialiasblur = v_data.z;\n  float r = v_radius / (v_radius + u_stroke_width);\n\n  float outer_df;\n  float inner_df;\n  // 'circle', 'triangle', 'square', 'pentagon', 'hexagon', 'octogon', 'hexagram', 'rhombus', 'vesica'\n  if (shape == 0) {\n    outer_df = sdCircle(v_data.xy, 1.0);\n    inner_df = sdCircle(v_data.xy, r);\n  } else if (shape == 1) {\n    outer_df = sdEquilateralTriangle(1.1 * v_data.xy);\n    inner_df = sdEquilateralTriangle(1.1 / r * v_data.xy);\n  } else if (shape == 2) {\n    outer_df = sdBox(v_data.xy, vec2(1.));\n    inner_df = sdBox(v_data.xy, vec2(r));\n  } else if (shape == 3) {\n    outer_df = sdPentagon(v_data.xy, 0.8);\n    inner_df = sdPentagon(v_data.xy, r * 0.8);\n  } else if (shape == 4) {\n    outer_df = sdHexagon(v_data.xy, 0.8);\n    inner_df = sdHexagon(v_data.xy, r * 0.8);\n  } else if (shape == 5) {\n    outer_df = sdOctogon(v_data.xy, 1.0);\n    inner_df = sdOctogon(v_data.xy, r);\n  } else if (shape == 6) {\n    outer_df = sdHexagram(v_data.xy, 0.52);\n    inner_df = sdHexagram(v_data.xy, r * 0.52);\n  } else if (shape == 7) {\n    outer_df = sdRhombus(v_data.xy, vec2(1.0));\n    inner_df = sdRhombus(v_data.xy, vec2(r));\n  } else if (shape == 8) {\n    outer_df = sdVesica(v_data.xy, 1.1, 0.8);\n    inner_df = sdVesica(v_data.xy, r * 1.1, r * 0.8);\n  }\n\n  float opacity_t = smoothstep(0.0, antialiasblur, outer_df);\n\n  float color_t = u_stroke_width < 0.01 ? 0.0 : smoothstep(\n    antialiasblur,\n    0.0,\n    inner_df\n  );\n\n  float PI = 3.14159;\n  float N_RINGS = 3.0;\n  float FREQ = 1.0;\n\n  if(u_stroke_width < 0.01) {\n    outputColor = v_color;\n  } else {\n    outputColor = mix(v_color, v_stroke * u_stroke_opacity, color_t);\n  }\n  float intensity = 1.0;\n  if(u_time!=-1.0){\n    //wave相关逻辑\n    float d = length(v_data.xy);\n    if(d > 0.5) {\n      discard;\n    }\n    intensity = clamp(cos(d * PI), 0.0, 1.0) * clamp(cos(2.0 * PI * (d * 2.0 * u_animate.z - u_animate.y * u_time)), 0.0, 1.0);\n  }\n\n  if(u_additive > 0.0) {\n    outputColor *= opacity_t;\n    outputColor *= intensity;//wave\n    outputColor = filterColorAlpha(outputColor, outputColor.a);\n  } else {\n    outputColor.a *= opacity_t;\n    outputColor.a *= intensity;//wave \n    outputColor = filterColor(outputColor);\n  }\n   // 作为 mask 模板时需要丢弃透明的像素\n  if(outputColor.a < 0.01) {\n    discard;\n  } \n}\n",vert:'layout(location = 0) in vec3 a_Position;\nlayout(location = 1) in vec4 a_Color;\nlayout(location = 9) in float a_Size;\nlayout(location = 10) in float a_Shape;\nlayout(location = 11) in vec3 a_Extrude;\n\nlayout(std140) uniform commonUniforms {\n  vec3 u_blur_height_fixed;\n  float u_stroke_width;\n  float u_additive;\n  float u_stroke_opacity;\n  float u_size_unit;\n  float u_time;\n  vec4 u_animate;   \n};\n\nout vec4 v_color;\nout vec4 v_stroke;\nout vec4 v_data;\nout float v_radius;\n\n#pragma include "projection"\n#pragma include "picking"\n#pragma include "rotation_2d"\n\nvoid main() {\n  // 透明度计算\n   v_stroke = stroke;  \n  vec3 extrude = a_Extrude;\n  float shape_type = a_Shape;\n  /*\n  *  setPickingSize 设置拾取大小\n  *  u_meter2coord 在等面积大小的时候设置单位\n  */\n  float newSize = setPickingSize(a_Size);\n  // float newSize = setPickingSize(a_Size) * 0.00001038445708445579;\n\n\n\n  // unpack color(vec2)\n  v_color = vec4(a_Color.xyz, a_Color.w * opacity);\n\n  if(u_size_unit == 1.0) {\n    newSize = newSize  * u_PixelsPerMeter.z;\n  }\n\n   v_radius = newSize;\n\n  // anti-alias\n  //  float antialiased_blur = -max(u_blur, antialiasblur);\n  float antialiasblur = -max(2.0 / u_DevicePixelRatio / newSize, u_blur_height_fixed.x);\n\n  vec2 offset = (extrude.xy * (newSize + u_stroke_width) + u_offsets);\n  vec3 aPosition = a_Position;\n\n  offset = project_pixel(offset);\n  offset = rotate_matrix(offset,rotation);\n  \n  // TODP: /abs(extrude.x) 是为了兼容地球模式\n  v_data = vec4(extrude.x/abs(extrude.x), extrude.y/abs(extrude.y), antialiasblur,shape_type);\n\n\n  // vec4 project_pos = project_position(vec4(a_Position.xy, 0.0, 1.0));\n  vec4 project_pos = project_position(vec4(aPosition.xy, 0.0, 1.0));\n  // gl_Position = project_common_position_to_clipspace(vec4(project_pos.xy + offset, project_pixel(setPickingOrder(0.0)), 1.0));\n\n  float raisingHeight = u_blur_height_fixed.y;\n\n  if(u_blur_height_fixed.z < 1.0) { // false\n    raisingHeight = project_pixel(u_blur_height_fixed.y);\n  } else {\n     if(u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT || u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSET) {\n      float mapboxZoomScale = 4.0/pow(2.0, 21.0 - u_Zoom);\n      raisingHeight = u_blur_height_fixed.y * mapboxZoomScale;\n    }\n  }\n  \n  gl_Position = project_common_position_to_clipspace_v2(vec4(project_pos.xy + offset, raisingHeight, 1.0));\n\n  setPickingColor(a_PickingColor);\n}\n',type:"pointFill"}}},{key:"animateOption2Array",value:function(e){return[e.enable?0:1,e.speed||1,e.rings||3,0]}},{key:"registerBuiltinAttributes",value:function(){var e=this.layer.getLayerConfig().shape2d;this.styleAttributeService.registerStyleAttribute({name:"extrude",type:Rc.Attribute,descriptor:{name:"a_Extrude",shaderLocation:by.EXTRUDE,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:3,update:function(e,t,n,r){var i=[1,1,0,-1,1,0,-1,-1,0,1,-1,0],o=r%4*3;return[i[o],i[o+1],i[o+2]]}}}),this.styleAttributeService.registerStyleAttribute({name:"size",type:Rc.Attribute,descriptor:{name:"a_Size",shaderLocation:by.SIZE,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:1,update:function(e){var t=e.size,n=void 0===t?5:t;return Array.isArray(n)?[n[0]]:[n]}}}),this.styleAttributeService.registerStyleAttribute({name:"shape",type:Rc.Attribute,descriptor:{name:"a_Shape",shaderLocation:by.SHAPE,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:1,update:function(t){var n=t.shape,r=void 0===n?2:n;return[e.indexOf(r)]}}})}}])}(qy),Db=function(e){function t(){var e;f(this,t);for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];return e=h(this,t,[].concat(r)),ne(e,"meter2coord",1),ne(e,"texture",void 0),ne(e,"isMeter",!1),ne(e,"radian",0),ne(e,"updateTexture",(function(){var t=e.rendererService.createTexture2D;if(e.texture)return e.texture.update({data:e.iconService.getCanvas(),mag:"linear",min:"linear mipmap nearest",mipmap:!0}),void e.layerService.throttleRenderLayers();e.texture=t({data:e.iconService.getCanvas(),mag:Bu.LINEAR,min:Bu.LINEAR_MIPMAP_LINEAR,premultiplyAlpha:!1,width:1024,height:e.iconService.canvasHeight||128,mipmap:!0}),e.textures=[e.texture]})),e}return d(t,e),c(t,[{key:"getCommonUniformsInfo",value:function(){var e,t=this.layer.getLayerConfig(),n=t.raisingHeight,r=void 0===n?0:n,i=t.heightfixed,o=void 0!==i&&i,a=t.unit,s=void 0===a?"pixel":a;this.rendererService.getDirty()&&(null===(e=this.texture)||void 0===e||e.bind());var u={u_textSize:[1024,this.iconService.canvasHeight||128],u_heightfixed:Number(o),u_raisingHeight:Number(r),u_size_unit:$y[s]};return this.getUniformsBufferInfo(u)}},{key:"getAttribute",value:function(){return this.styleAttributeService.createAttributesAndIndices(this.layer.getEncodedData(),qE)}},{key:"initModels",value:function(){var e=this;return ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.iconService.on("imageUpdate",e.updateTexture),e.updateTexture(),t.abrupt("return",e.buildModels());case 3:case"end":return t.stop()}}),t)})))()}},{key:"buildModels",value:function(){var e=this;return ie(i().mark((function t(){var n;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.initUniformsBuffer(),t.next=3,e.layer.buildLayerModel({moduleName:"pointFillImage",vertexShader:'layout(location = 0) in vec3 a_Position;\nlayout(location = 1) in vec4 a_Color;\nlayout(location = 9) in float a_Size;\nlayout(location = 11) in vec3 a_Extrude;\nlayout(location = 14) in vec2 a_Uv;\n\nlayout(std140) uniform commonUniform {\n  vec2 u_textSize;\n  float u_heightfixed: 0.0;\n  float u_raisingHeight: 0.0;\n  float u_size_unit;\n};\n\nout vec2 v_uv;\nout vec2 v_Iconuv;\nout float v_opacity;\n\n\n#pragma include "projection"\n#pragma include "picking"\n#pragma include "rotation_2d"\n\nvoid main() {\n  vec3 extrude = a_Extrude;\n  v_uv = (a_Extrude.xy + 1.0)/2.0;\n  v_uv.y = 1.0 - v_uv.y;\n  v_Iconuv = a_Uv;\n  v_opacity = opacity;\n  float newSize = a_Size;\n  if(u_size_unit == 1.0) {\n    newSize = newSize  * u_PixelsPerMeter.z;\n  }\n  \n  // vec2 offset = (u_RotateMatrix * extrude.xy * (a_Size) + textrueOffsets);\n  vec2 offset = (extrude.xy * (newSize) + offsets);\n\n  offset = rotate_matrix(offset,rotation);\n\n  vec3 aPosition = a_Position;\n\n  offset = project_pixel(offset);\n\n  vec4 project_pos = project_position(vec4(aPosition.xy, 0.0, 1.0));\n  float raisingHeight = u_raisingHeight;\n  if(u_heightfixed < 1.0) { // height fixed\n    raisingHeight = project_pixel(u_raisingHeight);\n  } else {\n    if(u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT || u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSET) {\n      float mapboxZoomScale = 4.0/pow(2.0, 21.0 - u_Zoom);\n      raisingHeight = u_raisingHeight * mapboxZoomScale;\n    }\n  }\n\n  gl_Position = project_common_position_to_clipspace_v2(vec4(project_pos.xy + offset, 0.0, 1.0));\n\n  setPickingColor(a_PickingColor);\n}\n',fragmentShader:'in vec2 v_uv;// 本身的 uv 坐标\nin vec2 v_Iconuv;\nin float v_opacity;\nout vec4 outputColor;\n\nuniform sampler2D u_texture;\nlayout(std140) uniform commonUniform {\n  vec2 u_textSize;\n  float u_heightfixed: 0.0;\n  float u_raisingHeight: 0.0;\n  float u_size_unit;\n};\n\n#pragma include "scene_uniforms"\n#pragma include "sdf_2d"\n#pragma include "picking"\n\nvoid main() {\n  vec2 pos = v_Iconuv / u_textSize + v_uv / u_textSize * 64.;\n  outputColor = texture(SAMPLER_2D(u_texture), pos);\n  outputColor.a *= v_opacity;\n  outputColor = filterColor(outputColor);\n}\n',triangulation:qE,depth:{enable:!1},inject:e.getInject(),cull:{enable:!0,face:Qt(e.mapService.version)}});case 3:return n=t.sent,t.abrupt("return",[n]);case 5:case"end":return t.stop()}}),t)})))()}},{key:"clearModels",value:function(){var e;this.iconService.off("imageUpdate",this.updateTexture),null===(e=this.texture)||void 0===e||e.destroy()}},{key:"registerBuiltinAttributes",value:function(){var e=this;this.styleAttributeService.registerStyleAttribute({name:"uv",type:Rc.Attribute,descriptor:{name:"a_Uv",shaderLocation:by.UV,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:2,update:function(t){var n=e.iconService.getIconMap()[t.shape]||{x:-64,y:-64};return[n.x,n.y]}}}),this.styleAttributeService.registerStyleAttribute({name:"extrude",type:Rc.Attribute,descriptor:{name:"a_Extrude",shaderLocation:by.EXTRUDE,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:3,update:function(e,t,n,r){var i=[1,1,0,-1,1,0,-1,-1,0,1,-1,0],o=r%4*3;return[i[o],i[o+1],i[o+2]]}}}),this.styleAttributeService.registerStyleAttribute({name:"size",type:Rc.Attribute,descriptor:{name:"a_Size",shaderLocation:by.SIZE,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:1,update:function(e){var t=e.size,n=void 0===t?5:t;return Array.isArray(n)?[n[0]]:[n]}}})}}])}(qy),Fb=function(e){function t(){var e;f(this,t);for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];return e=h(this,t,[].concat(r)),ne(e,"texture",void 0),ne(e,"updateTexture",(function(){var t=e.rendererService.createTexture2D;if(e.texture)return e.texture.update({data:e.iconService.getCanvas(),mag:"linear",min:"linear mipmap nearest",mipmap:!0}),void setTimeout((function(){e.layerService.throttleRenderLayers()}));e.texture=t({data:e.iconService.getCanvas(),mag:Bu.LINEAR,min:Bu.LINEAR_MIPMAP_LINEAR,premultiplyAlpha:!1,width:1024,height:e.iconService.canvasHeight||128,mipmap:!0})})),e}return d(t,e),c(t,[{key:"getUninforms",value:function(){var e;this.rendererService.getDirty()&&(null===(e=this.texture)||void 0===e||e.bind());var t=this.getCommonUniformsInfo(),n=this.getUniformsBufferInfo(this.getStyleAttribute());return this.updateStyleUnifoms(),re(re({},t.uniformsOption),n.uniformsOption)}},{key:"getCommonUniformsInfo",value:function(){var e=this.layer.getLayerConfig(),t=e.raisingHeight,n=void 0===t?0:t,r=e.heightfixed,i=void 0!==r&&r,o={u_textSize:[1024,this.iconService.canvasHeight||128],u_raisingHeight:Number(n),u_heightfixed:Number(i),u_texture:this.texture};return this.textures=[this.texture],this.getUniformsBufferInfo(o)}},{key:"initModels",value:function(){var e=this;return ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.iconService.on("imageUpdate",e.updateTexture),e.updateTexture(),t.abrupt("return",e.buildModels());case 3:case"end":return t.stop()}}),t)})))()}},{key:"clearModels",value:function(){var e;null===(e=this.texture)||void 0===e||e.destroy(),this.iconService.off("imageUpdate",this.updateTexture)}},{key:"buildModels",value:function(){var e=this;return ie(i().mark((function t(){var n;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.initUniformsBuffer(),t.next=3,e.layer.buildLayerModel({moduleName:"pointImage",vertexShader:'layout(location = 0) in vec3 a_Position;\nlayout(location = 1) in vec4 a_Color;\nlayout(location = 9) in float a_Size;\nlayout(location = 14) in vec2 a_Uv;\n\nlayout(std140) uniform commonUniforms {\n  vec2 u_textSize;\n  float u_raisingHeight;\n  float u_heightfixed;\n};\n\nout vec4 v_color;\nout vec2 v_uv;\nout float v_opacity;\n\n#pragma include "projection"\n#pragma include "picking"\n\nvoid main() {\n\n  // cal style mapping - 数据纹理映射部分的计算\n  v_color = a_Color;\n  v_opacity = opacity;\n  v_uv = a_Uv;\n  vec4 project_pos = project_position(vec4(a_Position, 1.0));\n   \n  vec2 offset = project_pixel(offsets);\n\n  float raisingHeight = u_raisingHeight;\n  if(u_heightfixed < 1.0) { // false\n    raisingHeight = project_pixel(u_raisingHeight);\n  } else {\n     if(u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT || u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSET) {\n      float mapboxZoomScale = 4.0/pow(2.0, 21.0 - u_Zoom);\n      raisingHeight = u_raisingHeight * mapboxZoomScale;\n    }\n  }\n\n\n  gl_Position = project_common_position_to_clipspace_v2(vec4(project_pos.xy + offset, raisingHeight, 1.0));\n\n  gl_PointSize = a_Size * 2.0 * u_DevicePixelRatio;\n  setPickingColor(a_PickingColor);\n}\n',fragmentShader:'layout(std140) uniform commonUniforms {\n  vec2 u_textSize;\n  float u_raisingHeight;\n  float u_heightfixed;\n};\n\nuniform sampler2D u_texture;\n\nin vec4 v_color;\nin vec2 v_uv;\nin float v_opacity;\n\n#pragma include "picking"\n\nout vec4 outputColor;\n\nvoid main(){\n  vec2 pos = v_uv / u_textSize + gl_PointCoord / u_textSize * 64.;\n  vec4 textureColor;\n\n  // Y = 0.299R + 0.587G + 0.114B // 亮度提取\n  \n  textureColor = texture(SAMPLER_2D(u_texture), pos);\n\n  // Tip: 去除边缘部分 mipmap 导致的混合变暗\n  float fragmengTocenter = distance(vec2(0.5), gl_PointCoord);\n  if(fragmengTocenter >= 0.5) {\n        float luma = 0.299 * textureColor.r + 0.587 * textureColor.g + 0.114 * textureColor.b;\n        textureColor.a *= luma;\n  }\n  \n  if(all(lessThan(v_color, vec4(1.0+0.00001))) && all(greaterThan(v_color, vec4(1.0-0.00001))) || v_color==vec4(1.0)){\n        outputColor= textureColor;\n  }else {\n        outputColor= step(0.01, textureColor.z) * v_color;\n  }\n  outputColor.a *= v_opacity;\n  if (outputColor.a < 0.01) {\n      discard;\n  }\n  outputColor = filterColor(outputColor);\n}\n',triangulation:$E,inject:e.getInject(),depth:{enable:!1},primitive:Bu.POINTS});case 3:return n=t.sent,t.abrupt("return",[n]);case 5:case"end":return t.stop()}}),t)})))()}},{key:"registerBuiltinAttributes",value:function(){var e=this;this.styleAttributeService.registerStyleAttribute({name:"size",type:Rc.Attribute,descriptor:{name:"a_Size",shaderLocation:by.SIZE,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:1,update:function(e){var t=e.size,n=void 0===t?5:t;return Array.isArray(n)?[n[0]]:[n]}}}),this.styleAttributeService.registerStyleAttribute({name:"uv",type:Rc.Attribute,descriptor:{name:"a_Uv",shaderLocation:by.UV,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:2,update:function(t){var n=e.iconService.getIconMap()[t.shape]||{x:-64,y:-64};return[n.x,n.y]}}})}}])}(qy);function Bb(e){var t=e.coordinates;return{vertices:r(t),indices:[0],size:t.length}}var Ub=function(e){function t(){return f(this,t),h(this,t,arguments)}return d(t,e),c(t,[{key:"getDefaultStyle",value:function(){return{blend:"additive"}}},{key:"getCommonUniformsInfo",value:function(){return this.getUniformsBufferInfo({u_size_scale:.5})}},{key:"initModels",value:function(){var e=this;return ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",e.buildModels());case 1:case"end":return t.stop()}}),t)})))()}},{key:"buildModels",value:function(){var e=this;return ie(i().mark((function t(){var n;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.layer.triangulation=Bb,e.initUniformsBuffer(),t.next=4,e.layer.buildLayerModel({moduleName:"pointNormal",vertexShader:'layout(location = 0) in vec3 a_Position;\nlayout(location = 1) in vec4 a_Color;\nlayout(location = 9) in float a_Size;\n\nlayout(std140) uniform u_Common {\n  float u_size_scale;\n};\n\nout vec4 v_color;\n\n#pragma include "projection"\n#pragma include "project"\n\nvoid main() {\n  v_color = vec4(a_Color.xyz, a_Color.w * opacity);\n\n  if (u_CoordinateSystem == COORDINATE_SYSTEM_P20_2) { // gaode2.x\n    gl_Position = u_Mvp * vec4(a_Position, 1.0);\n  } else {\n    vec4 project_pos = project_position(vec4(a_Position, 1.0)) + vec4(a_Size / 2., -a_Size /2., 0., 0.);\n    gl_Position = project_common_position_to_clipspace(project_pos);\n  }\n\n  gl_PointSize = a_Size * u_size_scale *  2.0  * u_DevicePixelRatio;\n}\n',fragmentShader:"in vec4 v_color;\nout vec4 outputColor;\nvoid main() {\n  outputColor = v_color;\n}",triangulation:Bb,inject:e.getInject(),depth:{enable:!1},primitive:Bu.POINTS,pick:!1});case 4:return n=t.sent,t.abrupt("return",[n]);case 6:case"end":return t.stop()}}),t)})))()}},{key:"clearModels",value:function(){}},{key:"registerBuiltinAttributes",value:function(){this.styleAttributeService.registerStyleAttribute({name:"size",type:Rc.Attribute,descriptor:{name:"a_Size",shaderLocation:by.SIZE,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:1,update:function(e){var t=e.size,n=void 0===t?1:t;return Array.isArray(n)?[n[0]]:[n]}}})}}])}(qy),Gb=function(e){function t(){return f(this,t),h(this,t,arguments)}return d(t,e),c(t,[{key:"getCommonUniformsInfo",value:function(){var e=this.layer.getLayerConfig(),t=e.blend,n=e.speed,r=void 0===n?1:n,i=e.unit,o={u_additive:"additive"===t?1:0,u_size_unit:$y[void 0===i?"pixel":i],u_speed:r,u_time:this.layer.getLayerAnimateTime()};return this.getUniformsBufferInfo(o)}},{key:"getAnimateUniforms",value:function(){return{}}},{key:"getAttribute",value:function(){return this.styleAttributeService.createAttributesAndIndices(this.layer.getEncodedData(),qE)}},{key:"initModels",value:function(){var e=this;return ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",e.buildModels());case 1:case"end":return t.stop()}}),t)})))()}},{key:"buildModels",value:function(){var e=this;return ie(i().mark((function t(){var n;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.initUniformsBuffer(),t.next=3,e.layer.buildLayerModel({moduleName:"pointRadar",vertexShader:'layout(location = 0) in vec3 a_Position;\nlayout(location = 1) in vec4 a_Color;\nlayout(location = 9) in float a_Size;\nlayout(location = 11) in vec3 a_Extrude;\n\nlayout(std140) uniform commonUniorm {\n  float u_additive;\n  float u_size_unit;\n  float u_speed: 1.0;\n  float u_time;\n};\n\nout vec4 v_data;\nout vec4 v_color;\nout float v_radius;\nout vec2 v_extrude;\n\n#pragma include "projection"\n#pragma include "picking"\n\nvoid main() {\n  float newSize = setPickingSize(a_Size);\n\n  float time = u_time * u_speed;\n  mat2 rotateMatrix = mat2( \n    cos(time), sin(time), \n    -sin(time), cos(time)\n  );\n  v_extrude = rotateMatrix * a_Extrude.xy;\n\n  v_color = a_Color;\n  v_color.a *= opacity;\n\n  float blur = 0.0;\n  float antialiasblur = -max(2.0 / u_DevicePixelRatio / a_Size, blur);\n\n  if(u_size_unit == 1.) {\n    newSize = newSize  * u_PixelsPerMeter.z;\n  }\n  v_radius = newSize;\n\n  vec2 offset = (a_Extrude.xy * (newSize));\n  vec3 aPosition = a_Position;\n  \n  offset = project_pixel(offset);\n  \n  v_data = vec4(a_Extrude.x, a_Extrude.y, antialiasblur, -1.0);\n\n  vec4 project_pos = project_position(vec4(aPosition.xy, 0.0, 1.0));\n  gl_Position = project_common_position_to_clipspace_v2(vec4(project_pos.xy + offset, project_pixel(setPickingOrder(0.0)), 1.0));\n\n  setPickingColor(a_PickingColor);\n}\n',fragmentShader:'\nlayout(std140) uniform commonUniorm{\n  float u_additive;\n  float u_size_unit;\n  float u_speed: 1.0;\n  float u_time;\n};\nin vec4 v_data;\nin vec4 v_color;\nin float v_radius;\nin vec2 v_extrude;\n#pragma include "sdf_2d"\n#pragma include "picking"\n\nout vec4 outputColor;\n\nvoid main() {\n\n  lowp float antialiasblur = v_data.z;\n  float r = v_radius / (v_radius);\n\n  float outer_df = sdCircle(v_data.xy, 1.0);\n  float inner_df = sdCircle(v_data.xy, r);\n\n  float opacity_t = smoothstep(0.0, antialiasblur, outer_df);\n\n  outputColor = vec4(v_color.rgb, v_color.a);\n\n  if(u_additive > 0.0) {\n    outputColor *= opacity_t;\n  } else {\n    outputColor.a *= opacity_t;\n  }\n\n  if(outputColor.a > 0.0) {\n    outputColor = filterColor(outputColor);\n  }\n\n  vec2 extrude =  v_extrude;\n  vec2 dir = normalize(extrude);\n  vec2 baseDir = vec2(1.0, 0.0);\n  float pi = 3.14159265359;\n  float flag = sign(dir.y);\n  float rades = dot(dir, baseDir);\n  float radar_v = (flag - 1.0) * -0.5 * acos(rades)/pi;\n  // simple AA\n  if(radar_v > 0.99) {\n    radar_v = 1.0 - (radar_v - 0.99)/0.01;\n  }\n\n  outputColor.a *= radar_v;\n}\n',triangulation:qE,inject:e.getInject(),depth:{enable:!1}});case 3:return n=t.sent,t.abrupt("return",[n]);case 5:case"end":return t.stop()}}),t)})))()}},{key:"animateOption2Array",value:function(e){return[e.enable?0:1,e.speed||1,e.rings||3,0]}},{key:"registerBuiltinAttributes",value:function(){this.styleAttributeService.registerStyleAttribute({name:"extrude",type:Rc.Attribute,descriptor:{name:"a_Extrude",shaderLocation:by.EXTRUDE,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:3,update:function(e,t,n,r){var i=[1,1,0,-1,1,0,-1,-1,0,1,-1,0],o=r%4*3;return[i[o],i[o+1],i[o+2]]}}}),this.styleAttributeService.registerStyleAttribute({name:"size",type:Rc.Attribute,descriptor:{shaderLocation:by.SIZE,name:"a_Size",buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:1,update:function(e){var t=e.size,n=void 0===t?5:t;return Array.isArray(n)?[n[0]]:[n]}}})}}])}(qy),zb=function(){return c((function e(t,n,r){f(this,e),ne(this,"boxCells",[]),ne(this,"xCellCount",void 0),ne(this,"yCellCount",void 0),ne(this,"boxKeys",void 0),ne(this,"bboxes",void 0),ne(this,"width",void 0),ne(this,"height",void 0),ne(this,"xScale",void 0),ne(this,"yScale",void 0),ne(this,"boxUid",void 0);var i=this.boxCells;this.xCellCount=Math.ceil(t/r),this.yCellCount=Math.ceil(n/r);for(var o=0;o<this.xCellCount*this.yCellCount;o++)i.push([]);this.boxKeys=[],this.bboxes=[],this.width=t,this.height=n,this.xScale=this.xCellCount/t,this.yScale=this.yCellCount/n,this.boxUid=0}),[{key:"insert",value:function(e,t,n,r,i){this.forEachCell(t,n,r,i,this.insertBoxCell,this.boxUid++),this.boxKeys.push(e),this.bboxes.push(t),this.bboxes.push(n),this.bboxes.push(r),this.bboxes.push(i)}},{key:"query",value:function(e,t,n,r,i){return this.queryHitTest(e,t,n,r,!1,i)}},{key:"hitTest",value:function(e,t,n,r,i){return this.queryHitTest(e,t,n,r,!0,i)}},{key:"insertBoxCell",value:function(e,t,n,r,i,o){this.boxCells[i].push(o)}},{key:"queryHitTest",value:function(e,t,n,r,i,o){if(n<0||e>this.width||r<0||t>this.height)return!i&&[];var a=[];if(e<=0&&t<=0&&this.width<=n&&this.height<=r){if(i)return!0;for(var s=0;s<this.boxKeys.length;s++)a.push({key:this.boxKeys[s],x1:this.bboxes[4*s],y1:this.bboxes[4*s+1],x2:this.bboxes[4*s+2],y2:this.bboxes[4*s+3]});return o?a.filter(o):a}var u={hitTest:i,seenUids:{box:{},circle:{}}};return this.forEachCell(e,t,n,r,this.queryCell,a,u,o),i?a.length>0:a}},{key:"queryCell",value:function(e,t,n,r,i,o,a,s){var u=a.seenUids,c=this.boxCells[i];if(null!==c){var l,f=this.bboxes,h=y(c);try{for(h.s();!(l=h.n()).done;){var d=l.value;if(!u.box[d]){u.box[d]=!0;var p=4*d;if(e<=f[p+2]&&t<=f[p+3]&&n>=f[p+0]&&r>=f[p+1]&&(!s||s(this.boxKeys[d]))){if(a.hitTest)return o.push(!0),!0;o.push({key:this.boxKeys[d],x1:f[p],y1:f[p+1],x2:f[p+2],y2:f[p+3]})}}}}catch(v){h.e(v)}finally{h.f()}}return!1}},{key:"forEachCell",value:function(e,t,n,r,i,o,a,s){for(var u=this.convertToXCellCoord(e),c=this.convertToYCellCoord(t),l=this.convertToXCellCoord(n),f=this.convertToYCellCoord(r),h=u;h<=l;h++)for(var d=c;d<=f;d++){var p=this.xCellCount*d+h;if(i.call(this,e,t,n,r,p,o,a,s))return}}},{key:"convertToXCellCoord",value:function(e){return Math.max(0,Math.min(this.xCellCount-1,Math.floor(e*this.xScale)))}},{key:"convertToYCellCoord",value:function(e){return Math.max(0,Math.min(this.yCellCount-1,Math.floor(e*this.yScale)))}}])}(),jb=function(){return c((function e(t,n){f(this,e),ne(this,"width",void 0),ne(this,"height",void 0),ne(this,"grid",void 0),ne(this,"viewportPadding",100),ne(this,"screenRightBoundary",void 0),ne(this,"screenBottomBoundary",void 0),ne(this,"gridRightBoundary",void 0),ne(this,"gridBottomBoundary",void 0),this.width=t,this.height=n,this.viewportPadding=Math.max(t,n),this.grid=new zb(t+this.viewportPadding,n+this.viewportPadding,25),this.screenRightBoundary=t+this.viewportPadding,this.screenBottomBoundary=n+this.viewportPadding,this.gridRightBoundary=t+2*this.viewportPadding,this.gridBottomBoundary=n+2*this.viewportPadding}),[{key:"placeCollisionBox",value:function(e){var t=e.x1+e.anchorPointX+this.viewportPadding,n=e.y1+e.anchorPointY+this.viewportPadding,r=e.x2+e.anchorPointX+this.viewportPadding,i=e.y2+e.anchorPointY+this.viewportPadding;return!this.isInsideGrid(t,n,r,i)||this.grid.hitTest(t,n,r,i)?{box:[]}:{box:[t,n,r,i]}}},{key:"insertCollisionBox",value:function(e,t){var n={featureIndex:t};this.grid.insert(n,e[0],e[1],e[2],e[3])}},{key:"project",value:function(e,t,n){var i=function(e,t,n,r){var i=new zc(4);return i[0]=e,i[1]=t,i[2]=n,i[3]=r,i}(t,n,0,1),o=ol();return al(o,i,Vc.apply(void 0,r(e))),{x:(o[0]/o[3]+1)/2*this.width+this.viewportPadding,y:(-o[1]/o[3]+1)/2*this.height+this.viewportPadding}}},{key:"isInsideGrid",value:function(e,t,n,r){return n>=0&&e<this.gridRightBoundary&&r>=0&&t<this.gridBottomBoundary}}])}();function Vb(e){var t=.5,n=.5;switch(e){case"right":case"top-right":case"bottom-right":t=1;break;case"left":case"top-left":case"bottom-left":t=0;break;default:t=.5}switch(e){case"bottom":case"bottom-right":case"bottom-left":n=1;break;case"top":case"top-right":case"top-left":n=0;break;default:n=.5}return{horizontalAlign:t,verticalAlign:n}}function Hb(e,t,n,r,i){if(i){var o=e[r],a=o.glyph;if(a)for(var s=t[a].advance*o.scale,u=(e[r].x+s)*i,c=n;c<=r;c++)e[c].x-=u}}function Xb(e,t,n,r,i,o,a){var s,u=(t-n)*i,c=(-r*a+.5)*o,l=y(e);try{for(l.s();!(s=l.n()).done;){var f=s.value;f.x+=u,f.y+=c}}catch(h){l.e(h)}finally{l.f()}}function Wb(e,t,n,r,i,o){var a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:[0,0],s=arguments.length>7?arguments[7]:void 0,u=e.split("\n"),c=[],l={positionedGlyphs:c,top:a[1],bottom:a[1],left:a[0],right:a[0],lineCount:u.length,text:e};return s?function(e,t,n,r,i,o,a){var s=0,u=-8,c=0,l=e.positionedGlyphs,f="right"===o?1:"left"===o?0:.5,h=l.length;n.forEach((function(e){var n=t[e];if(n&&(l.push({glyph:e,x:n.advance/2,y:u+0,vertical:!1,scale:1,metrics:n}),s+=n.advance+a),l.length!==h){var i=s-a;c=Math.max(i,c),Hb(l,t,h,l.length-1,f)}s=0,u-=r+5}));var d=Vb(i),p=d.horizontalAlign,v=d.verticalAlign;Xb(l,f,p,v,c,r,n.length);var m=u- -8;e.top+=-v*m,e.bottom=e.top-m,e.left+=-p*c,e.right=e.left+c}(l,t,u,n,r,i,o):function(e,t,n,r,i,o,a){var s=0,u=-8,c=0,l=e.positionedGlyphs,f="right"===o?1:"left"===o?0:.5,h=l.length;n.forEach((function(e){if(e.split("").forEach((function(e){var n=t[e];n&&(l.push({glyph:e,x:s,y:u+0,vertical:!1,scale:1,metrics:n}),s+=n.advance+a)})),l.length!==h){var n=s-a;c=Math.max(n,c),Hb(l,t,h,l.length-1,f)}s=0,u-=r+5}));var d=Vb(i),p=d.horizontalAlign,v=d.verticalAlign;Xb(l,f,p,v,c,r,n.length);var m=u- -8;e.top+=-v*m,e.bottom=e.top-m,e.left+=-p*c,e.right=e.left+c}(l,t,u,n,r,i,o),!!c.length&&l}var Yb='#define SDF_PX 8.0\n#define EDGE_GAMMA 0.105\n#define FONT_SIZE 48.0\n\nuniform sampler2D u_sdf_map;\nlayout(std140) uniform commonUniforms {\n  vec4 u_stroke_color : [0.0, 0.0, 0.0, 0.0];\n  vec2 u_sdf_map_size;\n  float u_raisingHeight: 0.0;\n  float u_stroke_width : 2;\n  float u_gamma_scale : 0.5;\n  float u_halo_blur : 0.5;\n};\n\nin vec2 v_uv;\nin float v_gamma_scale;\nin vec4 v_color;\nin vec4 v_stroke_color;\nin float v_fontScale;\n\nout vec4 outputColor;\n\n#pragma include "picking"\nvoid main() {\n  // get style data mapping\n\n  // get sdf from atlas\n  float dist = texture(SAMPLER_2D(u_sdf_map), v_uv).a;\n\n  lowp float buff = (6.0 - u_stroke_width / v_fontScale) / SDF_PX;\n  highp float gamma = (u_halo_blur * 1.19 / SDF_PX + EDGE_GAMMA) / (v_fontScale * u_gamma_scale) / 1.0;\n\n  highp float gamma_scaled = gamma * v_gamma_scale;\n\n  highp float alpha = smoothstep(buff - gamma_scaled, buff + gamma_scaled, dist);\n\n  outputColor = mix(v_color, v_stroke_color, smoothstep(0., 0.5, 1.- dist));\n\n  outputColor.a *= alpha;\n   // 作为 mask 模板时需要丢弃透明的像素\n  if (outputColor.a < 0.01) {\n    discard;\n  }\n  outputColor = filterColor(outputColor);\n}\n',Zb='#define SDF_PX 8.0\n#define EDGE_GAMMA 0.105\n#define FONT_SIZE 24.0\n\nlayout(location = 0) in vec3 a_Position;\nlayout(location = 1) in vec4 a_Color;\nlayout(location = 9) in float a_Size;\nlayout(location = 10) in vec2 a_textOffsets;\nlayout(location = 14) in vec2 a_tex;\n\nlayout(std140) uniform commonUniforms {\n  vec4 u_stroke_color : [0.0, 0.0, 0.0, 0.0];\n  vec2 u_sdf_map_size;\n  float u_raisingHeight: 0.0;\n  float u_stroke_width : 2;\n  float u_gamma_scale : 0.5;\n  float u_halo_blur : 0.5;\n};\n\nout vec2 v_uv;\nout float v_gamma_scale;\nout vec4 v_color;\nout vec4 v_stroke_color;\nout float v_fontScale;\n\n#pragma include "projection"\n#pragma include "picking"\n#pragma include "rotation_2d"\n\nvoid main() {\n  // cal style mapping - 数据纹理映射部分的计算\n  \n  v_uv = a_tex / u_sdf_map_size;\n\n\n\n  v_color = vec4(a_Color.xyz, a_Color.w * opacity);\n  v_stroke_color = vec4(u_stroke_color.xyz, u_stroke_color.w * opacity);\n\n  // 文本缩放比例\n  float fontScale = a_Size / FONT_SIZE;\n  v_fontScale = fontScale;\n\n  vec4 project_pos = project_position(vec4(a_Position, 1.0));\n  // vec4 projected_position  = project_common_position_to_clipspace(vec4(project_pos.xyz, 1.0));\n\n  vec2 offset = rotate_matrix(a_textOffsets,rotation);\n  \n  // gl_Position = vec4(projected_position.xy / projected_position.w + rotation_matrix * a_textOffsets * fontScale / u_ViewportSize * 2.0 * u_DevicePixelRatio, 0.0, 1.0);\n\n  float raiseHeight = u_raisingHeight;\n  if(u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT || u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSET) {\n    float mapboxZoomScale = 4.0/pow(2.0, 21.0 - u_Zoom);\n    raiseHeight = u_raisingHeight * mapboxZoomScale;\n  }\n\n  vec4 projected_position = project_common_position_to_clipspace_v2(vec4(project_pos.xyz + vec3(0.0, 0.0, raiseHeight), 1.0));\n\n  gl_Position = vec4(\n    projected_position.xy / projected_position.w + offset * fontScale / u_ViewportSize * 2.0 * u_DevicePixelRatio, 0.0, 1.0);\n  v_gamma_scale = gl_Position.w;\n  setPickingColor(a_PickingColor);\n\n}\n',qb=Ni.isEqual;function Kb(e){var t=this,n=e.id,i=[],o=[];if(!t.glyphInfoMap||!t.glyphInfoMap[n])return{vertices:[],indices:[],size:7};var a=t.glyphInfoMap[n].centroid,s=2===a.length?[a[0],a[1],0]:a;return t.glyphInfoMap[n].glyphQuads.forEach((function(e,t){i.push.apply(i,r(s).concat([e.tex.x,e.tex.y+e.tex.height,e.tl.x,e.tl.y],r(s),[e.tex.x+e.tex.width,e.tex.y+e.tex.height,e.tr.x,e.tr.y],r(s),[e.tex.x+e.tex.width,e.tex.y,e.br.x,e.br.y],r(s),[e.tex.x,e.tex.y,e.bl.x,e.bl.y])),o.push(0+4*t,1+4*t,2+4*t,2+4*t,3+4*t,0+4*t)})),{vertices:i,indices:o,size:7}}var Qb=function(e){function t(){var e,n;f(this,t);for(var r=arguments.length,o=new Array(r),a=0;a<r;a++)o[a]=arguments[a];return e=h(this,t,[].concat(o)),n=e,ne(e,"glyphInfo",void 0),ne(e,"glyphInfoMap",{}),ne(e,"rawEncodeData",void 0),ne(e,"texture",void 0),ne(e,"currentZoom",-1),ne(e,"extent",void 0),ne(e,"textureHeight",0),ne(e,"textCount",0),ne(e,"preTextStyle",{}),ne(e,"mapping",ie(i().mark((function e(){return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return n.initGlyph(),n.updateTexture(),e.next=4,n.reBuildModel();case 4:case"end":return e.stop()}}),e)})))),e}return d(t,e),c(t,[{key:"getUninforms",value:function(){var e=this.getCommonUniformsInfo(),t=this.getUniformsBufferInfo(this.getStyleAttribute());return this.updateStyleUnifoms(),re(re(re({},e.uniformsOption),t.uniformsOption),{u_sdf_map:this.textures[0]})}},{key:"getCommonUniformsInfo",value:function(){var e=this.layer.getLayerConfig(),t=e.stroke,n=void 0===t?"#fff":t,r=e.strokeWidth,i=void 0===r?0:r,o=e.halo,a=void 0===o?.5:o,s=e.gamma,u=void 0===s?2:s,c=e.raisingHeight,l=void 0===c?0:c,f=this.getFontServiceMapping(),h=this.getFontServiceCanvas();f&&Object.keys(f).length!==this.textCount&&h&&(this.updateTexture(),this.textCount=Object.keys(f).length),this.preTextStyle=this.getTextStyle();var d={u_stroke_color:Ht(n),u_sdf_map_size:[(null==h?void 0:h.width)||1,(null==h?void 0:h.height)||1],u_raisingHeight:Number(l),u_stroke_width:i,u_gamma_scale:u,u_halo_blur:a};return this.getUniformsBufferInfo(d)}},{key:"initModels",value:function(){var e=this;return ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.bindEvent(),e.extent=e.textExtent(),e.rawEncodeData=e.layer.getEncodedData(),e.preTextStyle=e.getTextStyle(),e.initUniformsBuffer(),t.abrupt("return",e.buildModels());case 6:case"end":return t.stop()}}),t)})))()}},{key:"buildModels",value:function(){var e=this;return ie(i().mark((function t(){var n,r,o,a;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.layer.getLayerConfig(),r=n.textAllowOverlap,o=void 0!==r&&r,e.initGlyph(),e.updateTexture(),o||e.filterGlyphs(),t.next=6,e.layer.buildLayerModel({moduleName:"pointText",vertexShader:Zb,fragmentShader:Yb,inject:e.getInject(),triangulation:Kb.bind(e),depth:{enable:!1}});case 6:return a=t.sent,t.abrupt("return",[a]);case 8:case"end":return t.stop()}}),t)})))()}},{key:"needUpdate",value:function(){var e=this;return ie(i().mark((function t(){var n,r,o,a,s,u,c,l,f,h,d,p;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=e.getTextStyle(),r=n.textAllowOverlap,o=void 0!==r&&r,a=n.textAnchor,s=void 0===a?"center":a,u=n.textOffset,c=n.padding,l=n.fontFamily,f=n.fontWeight,qb(c,e.preTextStyle.padding)&&qb(u,e.preTextStyle.textOffset)&&qb(s,e.preTextStyle.textAnchor)&&qb(l,e.preTextStyle.fontFamily)&&qb(f,e.preTextStyle.fontWeight)){t.next=5;break}return t.next=4,e.mapping();case 4:case 13:return t.abrupt("return",!0);case 5:if(!o){t.next=7;break}return t.abrupt("return",!1);case 7:if(h=e.mapService.getZoom(),d=e.mapService.getBounds(),p=eo(e.extent,d),!(Math.abs(e.currentZoom-h)>.5)&&p&&o===e.preTextStyle.textAllowOverlap){t.next=14;break}return t.next=13,e.reBuildModel();case 14:return t.abrupt("return",!1);case 15:case"end":return t.stop()}}),t)})))()}},{key:"clearModels",value:function(){var e;null===(e=this.texture)||void 0===e||e.destroy(),this.layer.off("remapping",this.mapping)}},{key:"registerBuiltinAttributes",value:function(){this.styleAttributeService.registerStyleAttribute({name:"textOffsets",type:Rc.Attribute,descriptor:{shaderLocation:10,name:"a_textOffsets",buffer:{usage:Bu.STATIC_DRAW,data:[],type:Bu.FLOAT},size:2,update:function(e,t,n){return[n[5],n[6]]}}}),this.styleAttributeService.registerStyleAttribute({name:"textUv",type:Rc.Attribute,descriptor:{name:"a_tex",shaderLocation:by.UV,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:2,update:function(e,t,n){return[n[3],n[4]]}}}),this.styleAttributeService.registerStyleAttribute({name:"size",type:Rc.Attribute,descriptor:{name:"a_Size",shaderLocation:by.SIZE,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:1,update:function(e){var t=e.size,n=void 0===t?12:t;return Array.isArray(n)?[n[0]]:[n]}}})}},{key:"bindEvent",value:function(){this.layer.isTileLayer||this.layer.on("remapping",this.mapping)}},{key:"textExtent",value:function(){return Ji(this.mapService.getBounds(),.5)}},{key:"initTextFont",value:function(){var e=this.getTextStyle(),t=e.fontWeight,n=e.fontFamily,r=this.rawEncodeData,i=[];r.forEach((function(e){var t,n=e.shape,r=void 0===n?"":n,o=y(r=r.toString());try{for(o.s();!(t=o.n()).done;){var a=t.value;-1===i.indexOf(a)&&i.push(a)}}catch(s){o.e(s)}finally{o.f()}})),this.fontService.setFontOptions({characterSet:i,fontWeight:t,fontFamily:n,iconfont:!1})}},{key:"initIconFontTex",value:function(){var e=this.getTextStyle(),t=e.fontWeight,n=e.fontFamily,r=this.rawEncodeData,i=[];r.forEach((function(e){var t=e.shape,n=void 0===t?"":t;n="".concat(n),-1===i.indexOf(n)&&i.push(n)})),this.fontService.setFontOptions({characterSet:i,fontWeight:t,fontFamily:n,iconfont:!0})}},{key:"getTextStyle",value:function(){var e=this.layer.getLayerConfig(),t=e.fontWeight,n=void 0===t?"400":t,r=e.fontFamily,i=void 0===r?"sans-serif":r,o=e.textAllowOverlap,a=void 0!==o&&o,s=e.padding,u=void 0===s?[0,0]:s,c=e.textAnchor,l=void 0===c?"center":c,f=e.textOffset,h=void 0===f?[0,0]:f,d=e.opacity,p=void 0===d?1:d,v=e.strokeOpacity,m=void 0===v?1:v,g=e.strokeWidth,_=void 0===g?0:g,y=e.stroke;return{fontWeight:n,fontFamily:i,textAllowOverlap:a,padding:u,textAnchor:l,textOffset:h,opacity:p,strokeOpacity:m,strokeWidth:_,stroke:void 0===y?"#000":y}}},{key:"generateGlyphLayout",value:function(e){var t=this,n=this.getFontServiceMapping(),r=this.layer.getLayerConfig(),i=r.spacing,o=void 0===i?2:i,a=r.textAnchor,s=void 0===a?"center":a,u=r.textOffset,c=this.rawEncodeData;this.glyphInfo=c.map((function(r){var i=r.shape,a=void 0===i?"":i,c=r.id,l=r.size,f=void 0===l?1:l,h=r.textOffset?r.textOffset:u||[0,0],d=r.textAnchor?r.textAnchor:s||"center",p=Wb(a.toString(),n,f,d,"left",o,h,e),v=function(e){var t,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[0,0],r=arguments.length>2?arguments[2]:void 0,i=e.positionedGlyphs,o=[],a=y(void 0===i?[]:i);try{for(a.s();!(t=a.n()).done;){var s=t.value,u=s.metrics,c=u.advance*s.scale/2,l=r?[s.x+c,s.y]:[0,0],f=r?[0,0]:[s.x+c+n[0],s.y+n[1]],h=-4*s.scale-c+f[0],d=-4*s.scale+f[1],p=h+u.width*s.scale,v=d+u.height*s.scale,m={x:h,y:d},g={x:p,y:d},_={x:h,y:v},E={x:p,y:v};o.push({tl:m,tr:g,bl:_,br:E,tex:u,glyphOffset:l})}}catch(b){a.e(b)}finally{a.f()}return o}(p,h,!1);return r.shaping=p,r.glyphQuads=v,r.centroid=ro(r.coordinates),r.originCentroid="GAODE2.x"===r.version?ro(r.originCoordinates):r.originCentroid=r.centroid,t.glyphInfoMap[c]={shaping:p,glyphQuads:v,centroid:ro(r.coordinates)},r}))}},{key:"getFontServiceMapping",value:function(){var e=this.layer.getLayerConfig(),t=e.fontWeight,n=void 0===t?"400":t,r=e.fontFamily,i=void 0===r?"sans-serif":r;return this.fontService.getMappingByKey("".concat(i,"_").concat(n))}},{key:"getFontServiceCanvas",value:function(){var e=this.layer.getLayerConfig(),t=e.fontWeight,n=void 0===t?"400":t,r=e.fontFamily,i=void 0===r?"sans-serif":r;return this.fontService.getCanvasByKey("".concat(i,"_").concat(n))}},{key:"filterGlyphs",value:function(){var e=this,t=this.layer.getLayerConfig(),n=t.padding,r=void 0===n?[0,0]:n,i=t.textAllowOverlap;if(!(void 0!==i&&i)){this.glyphInfoMap={},this.currentZoom=this.mapService.getZoom(),this.extent=this.textExtent();var o=this.rendererService.getViewportSize(),a=o.width,s=o.height,u=new jb(a,s),c=this.glyphInfo.filter((function(t){var n=t.shaping,i=t.id,o=void 0===i?0:i,a="GAODE2.x"===t.version?t.originCentroid:t.centroid,s=t.size/16,c=e.mapService.lngLatToContainer(a),l=u.placeCollisionBox({x1:n.left*s-r[0],x2:n.right*s+r[0],y1:n.top*s-r[1],y2:n.bottom*s+r[1],anchorPointX:c.x,anchorPointY:c.y}).box;return!(!l||!l.length)&&(u.insertCollisionBox(l,o),!0)}));c.forEach((function(t){e.glyphInfoMap[t.id]=t}))}}},{key:"initGlyph",value:function(){var e=this.layer.getLayerConfig().iconfont,t=void 0!==e&&e;t?this.initIconFontTex():this.initTextFont(),this.generateGlyphLayout(t)}},{key:"updateTexture",value:function(){var e=this.rendererService.createTexture2D,t=this.getFontServiceCanvas();this.textureHeight=t.height,this.texture&&this.texture.destroy(),this.texture=e({data:t,mag:Bu.LINEAR,min:Bu.LINEAR,width:t.width,height:t.height}),this.textures=[this.texture]}},{key:"reBuildModel",value:function(){var e=this;return ie(i().mark((function t(){var n;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.filterGlyphs(),t.next=3,e.layer.buildLayerModel({moduleName:"pointText",vertexShader:Zb,fragmentShader:Yb,triangulation:Kb.bind(e),inject:e.getInject(),depth:{enable:!1}});case 3:n=t.sent,e.layer.models=[n];case 5:case"end":return t.stop()}}),t)})))()}}])}(qy),$b={fillImage:Db,fill:Pb,radar:Gb,image:Fb,normal:Ub,simplePoint:Lb,extrude:Ib,text:Qb,earthFill:Nb,earthExtrude:kb},Jb=function(e){function t(){var e;f(this,t);for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];return e=h(this,t,[].concat(r)),ne(e,"type","PointLayer"),ne(e,"enableShaderEncodeStyles",["stroke","offsets","opacity","rotation"]),ne(e,"enableDataEncodeStyles",["textOffset","textAnchor"]),ne(e,"defaultSourceConfig",{data:[],options:{parser:{type:"json",x:"lng",y:"lat"}}}),e}return d(t,e),c(t,[{key:"buildModels",value:function(){var e=this;return ie(i().mark((function t(){var n;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.getModelType(),e.layerModel&&e.layerModel.clearModels(),e.layerModel=new $b[n](e),t.next=5,e.initLayerModels();case 5:case"end":return t.stop()}}),t)})))()}},{key:"rebuildModels",value:function(){var e=this;return ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.buildModels();case 2:case"end":return t.stop()}}),t)})))()}},{key:"getModelTypeWillEmptyData",value:function(){if(this.shapeOption){var e=this.shapeOption,t=e.field,n=e.values,r=this.getLayerConfig().shape2d,i=this.iconService.getIconMap();if(t&&-1!==(null==r?void 0:r.indexOf(t)))return"fill";if("text"===n)return"text";if(n&&n instanceof Array){var o,a=y(n);try{for(a.s();!(o=a.n()).done;){var s=o.value;if("string"==typeof s&&i.hasOwnProperty(s))return"image"}}catch(u){a.e(u)}finally{a.f()}}}return"normal"}},{key:"getDefaultConfig",value:function(){return{fillImage:{},normal:{blend:"additive"},radar:{},simplePoint:{},fill:{blend:"normal"},extrude:{},image:{},text:{blend:"normal"},tile:{},tileText:{},earthFill:{},earthExtrude:{}}[this.getModelType()]}},{key:"getModelType",value:function(){var e=this.getEncodedData(),t=this.getLayerConfig(),n=t.shape2d,r=t.shape3d,i=t.billboard,o=void 0===i||i,a=this.iconService.getIconMap(),s=e.find((function(e){return e.hasOwnProperty("shape")}));if(s){var u=s.shape;return"dot"===u?"normal":"simple"===u?"simplePoint":"radar"===u?"radar":"fillImage"===this.layerType||!1===o?"fillImage":-1!==(null==n?void 0:n.indexOf(u))?"GLOBEL"===this.mapService.version?"earthFill":"fill":-1!==(null==r?void 0:r.indexOf(u))?"GLOBEL"===this.mapService.version?"earthExtrude":"extrude":a.hasOwnProperty(u)?"image":"text"}return this.getModelTypeWillEmptyData()}}])}(Vy);function eA(e){return tA.apply(this,arguments)}function tA(){return(tA=ie(i().mark((function e(t){var n,r,o;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!window.createImageBitmap){e.next=14;break}return e.next=3,fetch(t);case 3:return n=e.sent,e.t0=createImageBitmap,e.next=7,n.blob();case 7:return e.t1=e.sent,e.next=10,(0,e.t0)(e.t1);case 10:return r=e.sent,e.abrupt("return",r);case 14:return o=new window.Image,e.abrupt("return",new Promise((function(e){o.onload=function(){return e(o)},o.src=t,o.crossOrigin="Anonymous"})));case 16:case"end":return e.stop()}}),e)})))).apply(this,arguments)}var nA=function(e){function t(){var e;f(this,t);for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];return e=h(this,t,[].concat(r)),ne(e,"texture",void 0),e}return d(t,e),c(t,[{key:"getUninforms",value:function(){var e=this.getCommonUniformsInfo(),t=this.getUniformsBufferInfo(this.getStyleAttribute());return this.updateStyleUnifoms(),re(re({},e.uniformsOption),t.uniformsOption)}},{key:"getCommonUniformsInfo",value:function(){var e=this.layer.getLayerConfig(),t=e.mapTexture,n=e.heightfixed,r=void 0!==n&&n,i=e.raisingHeight,o=void 0===i?0:i,a=e.topsurface,s=void 0===a||a,u=e.sidesurface,c=void 0===u||u,l=e.sourceColor,f=e.targetColor,h=0,d=[1,1,1,1],p=[1,1,1,1];l&&f&&(d=Ht(l),p=Ht(f),h=1);var v={u_sourceColor:d,u_targetColor:p,u_linearColor:h,u_topsurface:Number(s),u_sidesurface:Number(c),u_heightfixed:Number(r),u_raisingHeight:Number(o)};return t&&this.texture&&(v.u_texture=this.texture,this.textures=[this.texture]),this.getUniformsBufferInfo(v)}},{key:"initModels",value:function(){var e=this;return ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.loadTexture();case 2:return t.abrupt("return",e.buildModels());case 3:case"end":return t.stop()}}),t)})))()}},{key:"buildModels",value:function(){var e=this;return ie(i().mark((function t(){var n,r,o,a,s;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.getShaders(),r=n.frag,o=n.vert,a=n.type,e.initUniformsBuffer(),t.next=4,e.layer.buildLayerModel({moduleName:a,vertexShader:o,fragmentShader:r,depth:{enable:!0},inject:e.getInject(),triangulation:ab});case 4:return s=t.sent,t.abrupt("return",[s]);case 6:case"end":return t.stop()}}),t)})))()}},{key:"getShaders",value:function(){var e=this.layer.getLayerConfig(),t=e.pickLight;return e.mapTexture?{frag:'uniform sampler2D u_texture;\n\nlayout(std140) uniform commonUniforms {\n  vec4 u_sourceColor;\n  vec4 u_targetColor;\n  float u_linearColor;\n  float u_topsurface;\n  float u_sidesurface;\n  float u_heightfixed; // 默认不固定\n  float u_raisingHeight;\n};\n\nin vec4 v_Color;\nin vec3 v_uvs;\nin vec2 v_texture_data;\n\n#pragma include "scene_uniforms"\n#pragma include "picking"\n\nout vec4 outputColor;\n\nvoid main() {\n  float opacity = u_opacity;\n  float isSide = v_texture_data.x;\n  float lightWeight = v_texture_data.y;\n  float topU = v_uvs[0];\n  float topV = 1.0 - v_uvs[1];\n  float sidey = v_uvs[2];\n\n  outputColor = texture(SAMPLER_2D(u_texture), vec2(topU, topV));\n  // Tip: 部分机型 GPU 计算精度兼容\n  if (isSide < 0.999) {// 是否是边缘\n    // side face\n    if (u_sidesurface < 1.0) {\n      discard;\n    }\n\n    if (u_linearColor == 1.0) {\n      vec4 linearColor = mix(u_targetColor, u_sourceColor, sidey);\n      linearColor.rgb *= lightWeight;\n      outputColor = linearColor;\n    } else {\n      outputColor = v_Color;\n    }\n  } else {\n     // top face\n    if (u_topsurface < 1.0) {\n      discard;\n    }\n  }\n  \n  outputColor.a *= opacity;\n  outputColor = filterColor(outputColor);\n}\n',vert:'layout(location = 0) in vec3 a_Position;\nlayout(location = 1) in vec4 a_Color;\nlayout(location = 9) in float a_Size;\nlayout(location = 13) in vec3 a_Normal;\nlayout(location = 14) in vec3 a_uvs;\n\n\nlayout(std140) uniform commonUniforms {\n  vec4 u_sourceColor;\n  vec4 u_targetColor;\n  float u_linearColor;\n  float u_topsurface;\n  float u_sidesurface;\n  float u_heightfixed; // 默认不固定\n  float u_raisingHeight;\n};\n\nout vec4 v_Color;\nout vec3 v_uvs;\nout vec2 v_texture_data;\n\n#pragma include "projection"\n#pragma include "light"\n#pragma include "picking"\n\nvoid main() {\n \n  vec4 pos = vec4(a_Position.xy, a_Position.z * a_Size, 1.0);\n  float lightWeight = calc_lighting(pos);\n  vec4 project_pos = project_position(pos);\n  v_uvs = a_uvs;\n  v_Color = a_Color;\n  v_Color.a *= opacity;\n   \n  v_texture_data = vec2(a_Position.z, lightWeight);\n\n  if(u_heightfixed > 0.0) { // 判断几何体是否固定高度\n    project_pos.z = a_Position.z * a_Size;\n    project_pos.z += u_raisingHeight;\n\n    if(u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT || u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSET) {\n      float mapboxZoomScale = 4.0/pow(2.0, 21.0 - u_Zoom);\n      project_pos.z *= mapboxZoomScale;\n      project_pos.z += u_raisingHeight * mapboxZoomScale;\n    }\n  }\n\n\n    gl_Position = project_common_position_to_clipspace_v2(vec4(project_pos.xyz, 1.0));\n\n\n\n  setPickingColor(a_PickingColor);\n}\n',type:"polygonExtrudeTexture"}:t?{frag:'\nlayout(std140) uniform commonUniforms {\n  vec4 u_sourceColor;\n  vec4 u_targetColor;\n  float u_linearColor;\n  float u_topsurface;\n  float u_sidesurface;\n  float u_heightfixed; // 默认不固定\n  float u_raisingHeight;\n};\n\nin vec4 v_Color;\nin vec3 v_uvs;\nin vec2 v_texture_data;\nout vec4 outputColor;\n\n#pragma include "scene_uniforms"\n#pragma include "picking"\n\nvoid main() {\n  float isSide =  v_texture_data.x;\n  float sidey = v_uvs[2];\n  float lightWeight = v_texture_data.y;\n\n  // Tip: 部分机型 GPU 计算精度兼容\n  if(isSide < 0.999) {\n    // side face\n    if(u_sidesurface < 1.0) {\n      discard;\n    }\n    \n    if( u_linearColor == 1.0) {\n      // side use linear\n      vec4 linearColor = mix(u_targetColor, u_sourceColor, sidey);\n      linearColor.rgb *= lightWeight;\n      outputColor = linearColor;\n    } else {\n      // side notuse linear\n       outputColor = v_Color;\n    }\n  } else {\n    // top face\n    if(u_topsurface < 1.0) {\n      discard;\n    }\n    outputColor = v_Color;\n  }\n\n  outputColor = filterColorAlpha(outputColor, lightWeight);\n}\n',vert:'layout(location = 0) in vec3 a_Position;\nlayout(location = 1) in vec4 a_Color;\nlayout(location = 9) in float a_Size;\nlayout(location = 13) in vec3 a_Normal;\nlayout(location = 14) in vec3 a_uvs;\n\n\nlayout(std140) uniform commonUniforms {\n  vec4 u_sourceColor;\n  vec4 u_targetColor;\n  float u_linearColor;\n  float u_topsurface;\n  float u_sidesurface;\n  float u_heightfixed; // 默认不固定\n  float u_raisingHeight;\n};\n\nout vec4 v_Color;\nout vec3 v_uvs;\nout vec2 v_texture_data;\n\n#pragma include "projection"\n#pragma include "light"\n#pragma include "picking"\n\nvoid main() {\n\n\n  v_uvs = a_uvs;\n  // cal style mapping - 数据纹理映射部分的计算\n  vec4 pos = vec4(a_Position.xy, a_Position.z * a_Size, 1.0);\n  vec4 project_pos = project_position(pos);\n\n  if(u_heightfixed > 0.0) { // 判断几何体是否固定高度\n    project_pos.z = a_Position.z * a_Size;\n    project_pos.z += u_raisingHeight;\n    if(u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT || u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSET) {\n      float mapboxZoomScale = 4.0/pow(2.0, 21.0 - u_Zoom);\n      project_pos.z *= mapboxZoomScale;\n      project_pos.z += u_raisingHeight * mapboxZoomScale;\n    }\n  }\n\n  gl_Position = project_common_position_to_clipspace_v2(vec4(project_pos.xyz, 1.0));\n  float lightWeight = calc_lighting(pos);\n  v_texture_data = vec2(a_Position.z,lightWeight);\n\n  v_Color = vec4(a_Color.rgb * lightWeight, a_Color.w * opacity);\n\n  setPickingColor(a_PickingColor);\n}\n',type:"polygonExtrudePickLight"}:{frag:'layout(std140) uniform commonUniforms {\n  vec4 u_sourceColor;\n  vec4 u_targetColor;\n  float u_linearColor;\n  float u_topsurface;\n  float u_sidesurface;\n  float u_heightfixed; // 默认不固定\n  float u_raisingHeight;\n};\n\nin vec4 v_Color;\n#pragma include "scene_uniforms"\n#pragma include "picking"\nout vec4 outputColor;\nvoid main() {\n\n     // top face\n    if(u_topsurface < 1.0) {\n      discard;\n    }\n\n    outputColor = v_Color;\n  \n  outputColor = filterColor(outputColor);\n}\n',vert:'layout(location = 0) in vec3 a_Position;\nlayout(location = 1) in vec4 a_Color;\nlayout(location = 9) in float a_Size;\nlayout(location = 13) in vec3 a_Normal;\nlayout(location = 14) in vec3 a_uvs;\n\nlayout(std140) uniform commonUniforms {\n  vec4 u_sourceColor;\n  vec4 u_targetColor;\n  float u_linearColor;\n  float u_topsurface;\n  float u_sidesurface;\n  float u_heightfixed; // 默认不固定\n  float u_raisingHeight;\n};\n\nout vec4 v_Color;\n\n#pragma include "projection"\n#pragma include "light"\n#pragma include "picking"\n\nvoid main() {\n \nfloat isSide = a_Position.z;\n float topU = a_uvs[0];\n float topV = 1.0 - a_uvs[1];\n float sidey = a_uvs[2];\n\n  vec4 pos = vec4(a_Position.xy, a_Position.z * a_Size, 1.0);\n  float lightWeight = calc_lighting(pos);\n\n  vec4 project_pos = project_position(pos);\n\n  if(u_heightfixed > 0.0) { // 判断几何体是否固定高度\n    project_pos.z = a_Position.z * a_Size;\n    project_pos.z += u_raisingHeight;\n\n    if(u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT || u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSET) {\n      float mapboxZoomScale = 4.0/pow(2.0, 21.0 - u_Zoom);\n      project_pos.z *= mapboxZoomScale;\n      project_pos.z += u_raisingHeight * mapboxZoomScale;\n    }\n  }\n\n\n gl_Position = project_common_position_to_clipspace_v2(vec4(project_pos.xyz, 1.0));\n\n  // Tip: 部分机型 GPU 计算精度兼容\n  if(isSide < 0.999) {\n    // side face\n    // if(u_sidesurface < 1.0) {\n    //   discard;\n    // }\n\n    if(u_linearColor == 1.0) {\n      vec4 linearColor = mix(u_targetColor, u_sourceColor, sidey);\n      linearColor.rgb *= lightWeight;\n      v_Color = linearColor;\n    } else {\n      v_Color = a_Color;\n    }\n\n  } else {\n    v_Color = a_Color;\n  }\n\n  v_Color = vec4(v_Color.rgb * lightWeight, v_Color.w * opacity);\n\n\n  setPickingColor(a_PickingColor);\n}\n',type:"polygonExtrude"}}},{key:"clearModels",value:function(){var e;null===(e=this.texture)||void 0===e||e.destroy(),this.textures=[]}},{key:"registerBuiltinAttributes",value:function(){var e=this.layer.getSource().extent,t=e,n=this.layer.coordCenter||this.layer.getSource().center,r=t[2]-t[0],i=t[3]-t[1];if("GAODE2.x"===this.mapService.version){var o=a(this.mapService.coordToAMap2RelativeCoordinates([e[0],e[1]],n),2),s=o[0],u=o[1],c=a(this.mapService.coordToAMap2RelativeCoordinates([e[2],e[3]],n),2),l=c[0],f=c[1];r=l-s,i=f-u,t=[s,u,l,f]}this.styleAttributeService.registerStyleAttribute({name:"uvs",type:Rc.Attribute,descriptor:{name:"a_uvs",shaderLocation:by.UV,buffer:{usage:Bu.STATIC_DRAW,data:[],type:Bu.FLOAT},size:3,update:function(e,n,o){var a=o[0],s=o[1];return[(a-t[0])/r,(s-t[1])/i,o[4]]}}}),this.styleAttributeService.registerStyleAttribute({name:"normal",type:Rc.Attribute,descriptor:{name:"a_Normal",shaderLocation:by.NORMAL,buffer:{usage:Bu.STATIC_DRAW,data:[],type:Bu.FLOAT},size:3,update:function(e,t,n,r,i){return i}}}),this.styleAttributeService.registerStyleAttribute({name:"size",type:Rc.Attribute,descriptor:{name:"a_Size",shaderLocation:by.SIZE,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:1,update:function(e){var t=e.size,n=void 0===t?10:t;return Array.isArray(n)?[n[0]]:[n]}}})}},{key:"loadTexture",value:function(){var e=this;return ie(i().mark((function t(){var n,r,o,a;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=e.layer.getLayerConfig(),r=n.mapTexture,o=e.rendererService.createTexture2D,e.texture=o({height:1,width:1}),!r){t.next=8;break}return t.next=6,eA(r);case 6:a=t.sent,e.texture=o({data:a,width:a.width,height:a.height,wrapS:Bu.CLAMP_TO_EDGE,wrapT:Bu.CLAMP_TO_EDGE,min:Bu.LINEAR,mag:Bu.LINEAR});case 8:case"end":return t.stop()}}),t)})))()}}])}(qy),rA=function(e){function t(){var e;f(this,t);for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];return e=h(this,t,[].concat(r)),ne(e,"texture",void 0),e}return d(t,e),c(t,[{key:"getUninforms",value:function(){var e=this.getCommonUniformsInfo(),t=this.getUniformsBufferInfo(this.getStyleAttribute());return this.updateStyleUnifoms(),re(re({},e.uniformsOption),t.uniformsOption)}},{key:"getCommonUniformsInfo",value:function(){return this.getUniformsBufferInfo({})}},{key:"initModels",value:function(){var e=this;return ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",e.buildModels());case 1:case"end":return t.stop()}}),t)})))()}},{key:"buildModels",value:function(){var e=this;return ie(i().mark((function t(){var n,r,o,a,s;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.getShaders(),r=n.frag,o=n.vert,a=n.type,e.initUniformsBuffer(),t.next=4,e.layer.buildLayerModel({moduleName:a,vertexShader:o,fragmentShader:r,inject:e.getInject(),triangulation:ab,depth:{enable:!0}});case 4:return s=t.sent,t.abrupt("return",[s]);case 6:case"end":return t.stop()}}),t)})))()}},{key:"getShaders",value:function(){return{frag:'\nin vec4 v_Color;\n#pragma include "scene_uniforms"\n#pragma include "picking"\nout vec4 outputColor;\nvoid main() {\n\n  outputColor = v_Color;\n  outputColor = filterColor(outputColor);\n}\n',vert:'layout(location = 0) in vec3 a_Position;\nlayout(location = 1) in vec4 a_Color;\nlayout(location = 9) in float a_Size;\nlayout(location = 13) in vec3 a_Normal;\n\nout vec4 v_Color;\n\n#pragma include "projection"\n#pragma include "light"\n#pragma include "picking"\n\nvoid main() {\n \n  vec4 pos = vec4(a_Position.xy, a_Position.z * a_Size + (1.0 - a_Position.z) * extrusionBase, 1.0);\n\n  vec4 project_pos = project_position(pos);\n   float lightWeight = calc_lighting(project_pos);\n  v_Color = a_Color;\n  v_Color = vec4(v_Color.rgb * lightWeight, v_Color.w * opacity);\n\n  gl_Position = project_common_position_to_clipspace_v2(vec4(project_pos.xyz, 1.0));\n\n  setPickingColor(a_PickingColor);\n}\n',type:"polygonExtrude"}}},{key:"clearModels",value:function(){var e;null===(e=this.texture)||void 0===e||e.destroy()}},{key:"registerBuiltinAttributes",value:function(){this.styleAttributeService.registerStyleAttribute({name:"normal",type:Rc.Attribute,descriptor:{name:"a_Normal",shaderLocation:by.NORMAL,buffer:{usage:Bu.STATIC_DRAW,data:[],type:Bu.FLOAT},size:3,update:function(e,t,n,r,i){return i}}}),this.styleAttributeService.registerStyleAttribute({name:"size",type:Rc.Attribute,descriptor:{name:"a_Size",shaderLocation:by.SIZE,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:1,update:function(e){var t=e.size,n=void 0===t?10:t;return Array.isArray(n)?[n[0]]:[n]}}})}}])}(qy),iA=function(e){function t(){return f(this,t),h(this,t,arguments)}return d(t,e),c(t,[{key:"getUninforms",value:function(){var e=this.getCommonUniformsInfo(),t=this.getUniformsBufferInfo(this.getStyleAttribute());return this.updateStyleUnifoms(),re(re({},e.uniformsOption),t.uniformsOption)}},{key:"getCommonUniformsInfo",value:function(){var e=this.layer.getLayerConfig(),t=e.raisingHeight,n=void 0===t?0:t,r=e.opacityLinear,i=void 0===r?{enable:!1,dir:"in"}:r,o={u_raisingHeight:Number(n),u_opacitylinear:Number(i.enable),u_dir:"in"===i.dir?1:0};return this.getUniformsBufferInfo(o)}},{key:"initModels",value:function(){var e=this;return ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",e.buildModels());case 1:case"end":return t.stop()}}),t)})))()}},{key:"buildModels",value:function(){var e=this;return ie(i().mark((function t(){var n,r,o,a,s,u;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.getModelParams(),r=n.frag,o=n.vert,a=n.triangulation,s=n.type,e.initUniformsBuffer(),e.layer.triangulation=a,t.next=5,e.layer.buildLayerModel({moduleName:s,vertexShader:o,fragmentShader:r,inject:e.getInject(),triangulation:a,primitive:Bu.TRIANGLES,depth:{enable:!1}});case 5:return u=t.sent,t.abrupt("return",[u]);case 7:case"end":return t.stop()}}),t)})))()}},{key:"registerBuiltinAttributes",value:function(){var e=this.layer.getLayerConfig().opacityLinear;(void 0===e?{enable:!1,dir:"in"}:e).enable&&this.styleAttributeService.registerStyleAttribute({name:"linear",type:Rc.Attribute,descriptor:{name:"a_linear",shaderLocation:by.LINEAR,buffer:{usage:Bu.STATIC_DRAW,data:[],type:Bu.FLOAT},size:3,update:function(e,t,n){return[n[3],n[4],n[5]]}}})}},{key:"getModelParams",value:function(){var e=this.layer.getLayerConfig().opacityLinear;return(void 0===e?{enable:!1}:e).enable?{frag:'\nlayout(std140) uniform commonUniforms {\n  float u_raisingHeight;\n  float u_opacitylinear;\n  float u_dir;\n};\n\nin vec4 v_color;\nin vec3 v_linear;\nin vec2 v_pos;\nout vec4 outputColor;\n#pragma include "scene_uniforms"\n#pragma include "picking"\n\nvoid main() {\n  outputColor = v_color;\n  if (u_opacitylinear > 0.0) {\n    outputColor.a *= u_dir == 1.0 ? 1.0 - length(v_pos - v_linear.xy)/v_linear.z : length(v_pos - v_linear.xy)/v_linear.z;\n  }\n  outputColor = filterColor(outputColor);\n}\n',vert:'layout(location = 0) in vec3 a_Position;\nlayout(location = 1) in vec4 a_Color;\nlayout(location = 15) in vec3 a_linear;\n\nlayout(std140) uniform commonUniforms {\n  float u_raisingHeight;\n  float u_opacitylinear;\n  float u_dir;\n};\n\nout vec4 v_color;\nout vec3 v_linear;\nout vec2 v_pos;\n\n#pragma include "projection"\n#pragma include "picking"\n\nvoid main() {\n  if (u_opacitylinear > 0.0) {\n    v_linear = a_linear;\n    v_pos = a_Position.xy;\n  }\n  v_color = vec4(a_Color.xyz, a_Color.w * opacity);\n  vec4 project_pos = project_position(vec4(a_Position, 1.0));\n  project_pos.z += u_raisingHeight;\n\n  if (u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT || u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSET) {\n    float mapboxZoomScale = 4.0/pow(2.0, 21.0 - u_Zoom);\n    project_pos.z *= mapboxZoomScale;\n    project_pos.z += u_raisingHeight * mapboxZoomScale;\n  }\n\n  gl_Position = project_common_position_to_clipspace_v2(vec4(project_pos.xyz, 1.0));\n  setPickingColor(a_PickingColor);\n}',type:"polygonLinear",triangulation:ib}:{frag:'in vec4 v_color;\n#pragma include "scene_uniforms"\n#pragma include "picking"\nout vec4 outputColor;\nvoid main() {\n  outputColor = v_color;\n  outputColor = filterColor(outputColor);\n}\n',vert:'layout(location = 0) in vec3 a_Position;\nlayout(location = 1) in vec4 a_Color;\n\nlayout(std140) uniform commonUniforms {\n  float u_raisingHeight;\n};\n\n\nout vec4 v_color;\n\n\n#pragma include "projection"\n#pragma include "picking"\n\nvoid main() {\n  // cal style mapping - 数据纹理映射部分的计算\n\n  // cal style mapping - 数据纹理映射部分的计算\n\n  v_color = vec4(a_Color.xyz, a_Color.w * opacity);\n  vec4 project_pos = project_position(vec4(a_Position, 1.0));\n  // gl_Position = project_common_position_to_clipspace(vec4(project_pos.xyz, 1.0));\n\n  project_pos.z += u_raisingHeight;\n\n  if(u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT || u_CoordinateSystem == COORDINATE_SYSTEM_LNGLAT_OFFSET) {\n    float mapboxZoomScale = 4.0/pow(2.0, 21.0 - u_Zoom);\n    project_pos.z *= mapboxZoomScale;\n    project_pos.z += u_raisingHeight * mapboxZoomScale;\n  }\n\n \n  gl_Position = project_common_position_to_clipspace_v2(vec4(project_pos.xyz, 1.0));\n\n  setPickingColor(a_PickingColor);\n}\n\n',type:"polygonFill",triangulation:rb}}}])}(qy),oA=function(e){function t(){var e;f(this,t);for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];return e=h(this,t,[].concat(r)),ne(e,"texture1",void 0),ne(e,"texture2",void 0),ne(e,"texture3",void 0),e}return d(t,e),c(t,[{key:"getUninforms",value:function(){var e=this.getCommonUniformsInfo(),t=this.getUniformsBufferInfo(this.getStyleAttribute());return this.updateStyleUnifoms(),re(re({},e.uniformsOption),t.uniformsOption)}},{key:"getCommonUniformsInfo",value:function(){var e=this.layer.getLayerConfig(),t=e.watercolor,n=void 0===t?"#6D99A8":t,r=e.watercolor2,i=void 0===r?"#0F121C":r,o={u_watercolor:Ht(n),u_watercolor2:Ht(i),u_time:this.layer.getLayerAnimateTime(),u_texture1:this.texture1,u_texture2:this.texture2,u_texture3:this.texture3};return this.textures=[this.texture1,this.texture2,this.texture3],this.getUniformsBufferInfo(o)}},{key:"getAnimateUniforms",value:function(){return{u_time:this.layer.getLayerAnimateTime()}}},{key:"initModels",value:function(){var e=this;return ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.loadTexture(),t.abrupt("return",e.buildModels());case 2:case"end":return t.stop()}}),t)})))()}},{key:"buildModels",value:function(){var e=this;return ie(i().mark((function t(){var n;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.initUniformsBuffer(),t.next=3,e.layer.buildLayerModel({moduleName:"polygonOcean",vertexShader:'layout(location = 0) in vec3 a_Position;\nlayout(location = 14) in vec2 a_uv;\n\nlayout(std140) uniform commonUniforms {\n  vec4 u_watercolor;\n  vec4 u_watercolor2;\n  float u_time;\n};\n\n\nout vec2 v_uv;\nout float v_opacity;\n\n#pragma include "projection"\n\nvoid main() {\n  v_uv = a_uv;\n  v_opacity = opacity;\n  vec4 project_pos = project_position(vec4(a_Position, 1.0));\n  gl_Position = project_common_position_to_clipspace_v2(vec4(project_pos.xyz, 1.0));\n}\n\n',fragmentShader:"\nlayout(std140) uniform commonUniforms {\n  vec4 u_watercolor;\n  vec4 u_watercolor2;\n  float u_time;\n};\n\nin vec2 v_uv;\nin float v_opacity;\nout vec4 outputColor;\n\nfloat coast2water_fadedepth = 0.10;\nfloat large_waveheight      = .750; // change to adjust the \"heavy\" waves\nfloat large_wavesize        = 3.4;  // factor to adjust the large wave size\nfloat small_waveheight      = 0.6;  // change to adjust the small random waves\nfloat small_wavesize        = 0.5;   // factor to ajust the small wave size\nfloat water_softlight_fact  = 15.;  // range [1..200] (should be << smaller than glossy-fact)\nfloat water_glossylight_fact= 120.; // range [1..200]\nfloat particle_amount       = 70.;\n\nvec3 water_specularcolor    = vec3(1.3, 1.3, 0.9);    // specular Color (RGB) of the water-highlights\n#define light                 vec3(-0., sin(u_time*0.5)*.5 + .35, 2.8) // position of the sun\n\nuniform sampler2D u_texture1;\nuniform sampler2D u_texture2;\nuniform sampler2D u_texture3;\n\n  \n\nfloat hash( float n ) {\n    return fract(sin(n)*43758.5453123);\n}\n\n// 2d noise function\nfloat noise1( in vec2 x ) {\n  vec2 p  = floor(x);\n  vec2 f  = smoothstep(0.0, 1.0, fract(x));\n  float n = p.x + p.y*57.0;\n  return mix(mix( hash(n+  0.0), hash(n+  1.0),f.x),\n    mix( hash(n+ 57.0), hash(n+ 58.0),f.x),f.y);\n}\n\nfloat noise(vec2 p) {\n    return texture(SAMPLER_2D(u_texture2),p*vec2(1./256.)).x;\n}\n\nvec4 highness(vec2 p) {\n    vec4 t = texture(SAMPLER_2D(u_texture1),fract(p));\n    float clipped = -2.0-smoothstep(3.,10.,t.a)*6.9-smoothstep(10.,100.,t.a)*89.9-smoothstep(0.,10000.,t.a)*10000.0;\n    return clamp(t, 0.0,3.0)+clamp(t/3.0-1.0, 0.0,1.0)+clamp(t/16.0-1.0, 0.0,1.0);\n}\n\nfloat height_map( vec2 p ) {\n    vec4 height=highness(p);\n    /*\n    height = -0.5+\n        0.5*smoothstep(-100.,0.,-height)+\n        2.75*smoothstep(0.,2.,height)+\n        1.75*smoothstep(2.,4.,height)+\n        2.75*smoothstep(4.,16.,height)+\n        1.5*smoothstep(16.,1000.,height);\n    */\n\n    mat2 m = mat2( 0.9563*1.4,  -0.2924*1.4,  0.2924*1.4,  0.9563*1.4 );\n    //p = p*6.;\n    float f = 0.6000*noise1( p ); p = m*p*1.1*6.;\n    f += 0.2500*noise( p ); p = m*p*1.32;\n    f += 0.1666*noise( p ); p = m*p*1.11;\n    f += 0.0834*noise( p ); p = m*p*1.12;\n    f += 0.0634*noise( p ); p = m*p*1.13;\n    f += 0.0444*noise( p ); p = m*p*1.14;\n    f += 0.0274*noise( p ); p = m*p*1.15;\n    f += 0.0134*noise( p ); p = m*p*1.16;\n    f += 0.0104*noise( p ); p = m*p*1.17;\n    f += 0.0084*noise( p );\n    f = .25*f+dot(height,vec4(-.03125,-.125,.25,.25))*.5;\n        const float FLAT_LEVEL = 0.92525;\n        //f = f*0.25+height*0.75;\n    if (f<FLAT_LEVEL)\n        f = f;\n    else\n        f = pow((f-FLAT_LEVEL)/(1.-FLAT_LEVEL), 2.)*(1.-FLAT_LEVEL)*2.0+FLAT_LEVEL; // makes a smooth coast-increase\n    return clamp(f, 0., 10.);\n}\n\nvec3 plasma_quintic( float x ) {\n    x = clamp( x, 0.0, 1.0);\n    vec4 x1 = vec4( 1.0, x, x * x, x * x * x ); // 1 x x2 x3\n    vec4 x2 = x1 * x1.w * x; // x4 x5 x6 x7\n    return vec3(\n        dot( x1.xyzw, vec4( +0.063861086, +1.992659096, -1.023901152, -0.490832805 ) ) + dot( x2.xy, vec2( +1.308442123, -0.914547012 ) ),\n        dot( x1.xyzw, vec4( +0.049718590, -0.791144343, +2.892305078, +0.811726816 ) ) + dot( x2.xy, vec2( -4.686502417, +2.717794514 ) ),\n        dot( x1.xyzw, vec4( +0.513275779, +1.580255060, -5.164414457, +4.559573646 ) ) + dot( x2.xy, vec2( -1.916810682, +0.570638854 ) ) );\n}\n\nvec4 color(vec2 p){\n    vec4 c1 = vec4(1.7,1.6,.9,1);\n    vec4 c2 = vec4(.2,.94,.1,1);\n    vec4 c3 = vec4(.3,.2,.0,1);\n    vec4 c4 = vec4(.99,.99,1.6,1);\n    vec4 v = highness(p);\n    float los = smoothstep(0.1,1.1,v.b);\n    float his = smoothstep(3.5,6.5,v.b);\n    float ces = smoothstep(1.,5.,v.a);\n    vec4 lo = mix(c1,c2,los);\n    vec4 hi = mix(c3,c4,his);\n    vec4 ce = mix(lo,hi,ces);\n\n    return vec4(plasma_quintic(ces),1).ragb;\n}\n\nvec3 terrain_map( vec2 p )\n{\n  return color(p).rgb*0.75+0.25*vec3(0.7, .55, .4)+texture(SAMPLER_2D(u_texture3), fract(p*5.)).rgb*.5; // test-terrain is simply 'sandstone'\n}\n\nconst mat2 m = mat2( 0.72, -1.60,  1.60,  0.72 );\n\nfloat water_map( vec2 p, float height ) {\n    vec2 p2 = p*large_wavesize;\n    vec2 shift1 = 0.001*vec2( u_time*160.0*2.0, u_time*120.0*2.0 );\n    vec2 shift2 = 0.001*vec2( u_time*190.0*2.0, -u_time*130.0*2.0 );\n\n    // coarse crossing 'ocean' waves...\n    float f = 0.6000*noise( p );\n    f += 0.2500*noise( p*m );\n    f += 0.1666*noise( p*m*m );\n    float wave = sin(p2.x*0.622+p2.y*0.622+shift2.x*4.269)*large_waveheight*f*height*height ;\n\n    p *= small_wavesize;\n    f = 0.;\n    float amp = 1.0, s = .5;\n    for (int i=0; i<9; i++)\n    { p = m*p*.947; f -= amp*abs(sin((noise( p+shift1*s )-.5)*2.)); amp = amp*.59; s*=-1.329; }\n    \n    return wave+f*small_waveheight;\n}\n\nfloat nautic(vec2 p) {\n    p *= 18.;\n    float f = 0.;\n    float amp = 1.0, s = .5;\n    for (int i=0; i<3; i++)\n    { p = m*p*1.2; f += amp*abs(smoothstep(0., 1., noise( p+u_time*s ))-.5); amp = amp*.5; s*=-1.227; }\n    return pow(1.-f, 5.);\n}\n\nfloat particles(vec2 p) {\n    p *= 200.;\n    float f = 0.;\n    float amp = 1.0, s = 1.5;\n    for (int i=0; i<3; i++)\n    { p = m*p*1.2; f += amp*noise( p+u_time*s ); amp = amp*.5; s*=-1.227; }\n    return pow(f*.35, 7.)*particle_amount;\n}\n\nfloat test_shadow( vec2 xy, float height) {\n    vec3 r0 = vec3(xy, height);\n    vec3 rd = normalize( light - r0 );\n    \n    float hit = 1.0;\n    float t   = 0.001;\n    for (int j=1; j<25; j++)\n    {\n        vec3 p = r0 + t*rd;\n        float h = height_map( p.xy );\n        float height_diff = p.z - h;\n        if (height_diff<0.0)\n        {\n            return 0.0;\n        }\n        t += 0.01+height_diff*.02;\n        hit = min(hit, 2.*height_diff/t); // soft shaddow   \n    }\n    return hit;\n}\n\nvec3 CalcTerrain(vec2 uv, float height) {\n    vec3 col = terrain_map( uv );\n    vec2 iResolution = vec2(512.);\n    float h1 = height_map(uv-vec2(0., 0.5)/ iResolution.xy);\n    float h2 = height_map(uv+vec2(0., 0.5)/ iResolution.xy);\n    float h3 = height_map(uv-vec2(0.5, 0.)/ iResolution.xy);\n    float h4 = height_map(uv+vec2(0.5, 0.)/ iResolution.xy);\n    vec3 norm = normalize(vec3(h3-h4, h1-h2, 1.));\n    vec3 r0 = vec3(uv, height);\n    vec3 rd = normalize( light - r0 );\n    float grad = dot(norm, rd);\n    col *= grad+pow(grad, 8.);\n    float terrainshade = test_shadow( uv, height );\n    col = mix(col*.25, col, terrainshade);\n    return col;\n}\n\n\nvoid main() {\n  vec3 watercolor = u_watercolor.rgb;\n  vec3 watercolor2 = u_watercolor2.rgb;\n  vec2 uv = v_uv;\n  float WATER_LEVEL = 0.84; // Water level (range: 0.0 - 2.0)\n  float deepwater_fadedepth   = 0.4 + coast2water_fadedepth;\n  float height = height_map( uv );\n  vec3 col;\n\n    float waveheight = clamp(WATER_LEVEL*3.-1.5, 0., 1.);\n    float level = WATER_LEVEL + .2*water_map(uv*15. + vec2(u_time*.1), waveheight);\n    if (height > level)\n    {\n        col = CalcTerrain(uv, height);\n    }\n    if (height <= level)\n    {\n        vec2 dif = vec2(.0, .01);\n        vec2 pos = uv*15. + vec2(u_time*.01);\n        float h1 = water_map(pos-dif,waveheight);\n        float h2 = water_map(pos+dif,waveheight);\n        float h3 = water_map(pos-dif.yx,waveheight);\n        float h4 = water_map(pos+dif.yx,waveheight);\n        vec3 normwater = normalize(vec3(h3-h4, h1-h2, .125)); // norm-vector of the 'bumpy' water-plane\n        uv += normwater.xy*.002*(level-height);\n        \n        col = CalcTerrain(uv, height);\n\n        float coastfade = clamp((level-height)/coast2water_fadedepth, 0., 1.);\n        float coastfade2= clamp((level-height)/deepwater_fadedepth, 0., 1.);\n        float intensity = col.r*.2126+col.g*.7152+col.b*.0722;\n        watercolor = mix(watercolor*intensity, watercolor2, smoothstep(0., 1., coastfade2));\n\n        vec3 r0 = vec3(uv, WATER_LEVEL);\n        vec3 rd = normalize( light - r0 ); // ray-direction to the light from water-position\n        float grad     = dot(normwater, rd); // dot-product of norm-vector and light-direction\n        float specular = pow(grad, water_softlight_fact);  // used for soft highlights                          \n        float specular2= pow(grad, water_glossylight_fact); // used for glossy highlights\n        float gradpos  = dot(vec3(0., 0., 1.), rd);\n        float specular1= smoothstep(0., 1., pow(gradpos, 5.));  // used for diffusity (some darker corona around light's specular reflections...)                          \n        float watershade  = test_shadow( uv, level );\n        watercolor *= 2.2+watershade;\n        watercolor += (.2+.8*watershade) * ((grad-1.0)*.5+specular) * .25;\n        watercolor /= (1.+specular1*1.25);\n        watercolor += watershade*specular2*water_specularcolor;\n        watercolor += watershade*coastfade*(1.-coastfade2)*(vec3(.5, .6, .7)*nautic(uv)+vec3(1., 1., 1.)*particles(uv));\n        \n        col = mix(col, watercolor, coastfade);\n    }\n    \n  outputColor = vec4(col, v_opacity);  \n}\n",inject:e.getInject(),triangulation:rb,primitive:Bu.TRIANGLES,depth:{enable:!1}});case 3:return n=t.sent,t.abrupt("return",[n]);case 5:case"end":return t.stop()}}),t)})))()}},{key:"clearModels",value:function(){var e,t,n;null===(e=this.texture1)||void 0===e||e.destroy(),null===(t=this.texture2)||void 0===t||t.destroy(),null===(n=this.texture3)||void 0===n||n.destroy()}},{key:"registerBuiltinAttributes",value:function(){var e=a(this.layer.getSource().extent,4),t=e[0],n=e[1],r=e[2],i=e[3],o=r-t,s=i-n;this.styleAttributeService.registerStyleAttribute({name:"oceanUv",type:Rc.Attribute,descriptor:{name:"a_uv",shaderLocation:by.UV,buffer:{usage:Bu.STATIC_DRAW,data:[],type:Bu.FLOAT},size:2,update:function(e,r,i,u){var c=a("GAODE2.x"===e.version?e.originCoordinates[0][u]:i,2),l=c[0],f=c[1];return[(l-t)/o,(f-n)/s]}}})}},{key:"loadTexture",value:function(){var e,t,n,r=this,i=this.rendererService.createTexture2D,o={height:0,width:0};function a(e){return i({data:e,width:e.width,height:e.height,wrapS:Bu.MIRRORED_REPEAT,wrapT:Bu.MIRRORED_REPEAT,min:Bu.LINEAR,mag:Bu.LINEAR})}this.texture1=i(o),this.texture2=i(o),this.texture3=i(o),e=function(e){r.texture1=a(e[0]),r.texture2=a(e[1]),r.texture3=a(e[2]),r.layerService.reRender()},t=0,n=[],["https://gw.alipayobjects.com/mdn/rms_816329/afts/img/A*EojwT4VzSiYAAAAAAAAAAAAAARQnAQ","https://gw.alipayobjects.com/mdn/rms_816329/afts/img/A*MJ22QbpuCzIAAAAAAAAAAAAAARQnAQ","https://gw.alipayobjects.com/mdn/rms_816329/afts/img/A*-z2HSIVDsHIAAAAAAAAAAAAAARQnAQ"].map((function(r){var i=new Image;i.crossOrigin="",i.src=r,n.push(i),i.onload=function(){3==++t&&e(n)}}))}}])}(qy),aA=function(e){function t(){var e;f(this,t);for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];return e=h(this,t,[].concat(r)),ne(e,"texture",void 0),e}return d(t,e),c(t,[{key:"getUninforms",value:function(){var e=this.getCommonUniformsInfo(),t=this.getUniformsBufferInfo(this.getStyleAttribute());return this.updateStyleUnifoms(),re(re({},e.uniformsOption),t.uniformsOption)}},{key:"getCommonUniformsInfo",value:function(){var e=this.layer.getLayerConfig().speed,t={u_speed:void 0===e?.5:e,u_time:this.layer.getLayerAnimateTime(),u_texture:this.texture};return this.textures=[this.texture],this.getUniformsBufferInfo(t)}},{key:"getAnimateUniforms",value:function(){return{u_time:this.layer.getLayerAnimateTime()}}},{key:"initModels",value:function(){var e=this;return ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.loadTexture(),t.abrupt("return",e.buildModels());case 2:case"end":return t.stop()}}),t)})))()}},{key:"buildModels",value:function(){var e=this;return ie(i().mark((function t(){var n;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.initUniformsBuffer(),t.next=3,e.layer.buildLayerModel({moduleName:"polygonWater",vertexShader:'layout(location = 0) in vec3 a_Position;\nlayout(location = 1) in vec4 a_Color;\nlayout(location = 14) in vec2 a_uv;\nlayout(std140) uniform commonUniforms {\n  float u_speed;\n  float u_time;\n};\nout vec4 v_Color;\nout vec2 v_uv;\n\n\n#pragma include "projection"\n\nvoid main() {\n  v_uv = a_uv;\n  v_Color = a_Color;\n  v_Color.a *= opacity;\n  vec4 project_pos = project_position(vec4(a_Position, 1.0));\n\n  gl_Position = project_common_position_to_clipspace_v2(vec4(project_pos.xyz, 1.0));\n}\n\n',fragmentShader:"uniform sampler2D u_texture;\nlayout(std140) uniform commonUniforms {\n  float u_speed;\n  float u_time;\n};\n\nout vec4 outputColor;\n\n\nin vec4 v_Color;\nin vec2 v_uv;\n\nfloat rand(vec2 n) { return 0.5 + 0.5 * fract(sin(dot(n.xy, vec2(12.9898, 78.233)))* 43758.5453); }\n\nfloat water(vec3 p) {\n  float t = u_time * u_speed;\n  p.z += t * 2.; p.x += t * 2.;\n  vec3 c1 = texture(SAMPLER_2D(u_texture), p.xz / 30.).xyz;\n  p.z += t * 3.; p.x += t * 0.52;\n  vec3 c2 = texture(SAMPLER_2D(u_texture), p.xz / 30.).xyz;\n  p.z += t * 4.; p.x += t * 0.8;\n  vec3 c3 = texture(SAMPLER_2D(u_texture), p.xz / 30.).xyz;\n  c1 += c2 - c3;\n  float z = (c1.x + c1.y + c1.z) / 3.;\n  return p.y + z / 4.;\n}\n\nfloat map(vec3 p) {\n  float d = 100.0;\n  d = water(p);\n  return d;\n}\n\nfloat intersect(vec3 ro, vec3 rd) {\n  float d = 0.0;\n  for (int i = 0; i <= 100; i++) {\n    float h = map(ro + rd * d);\n    if (h < 0.1) return  d;\n    d += h;\n  }\n  return 0.0;\n}\n\nvec3 norm(vec3 p) {\n  float eps = .1;\n  return normalize(vec3(\n    map(p + vec3(eps, 0, 0)) - map(p + vec3(-eps, 0, 0)),\n    map(p + vec3(0, eps, 0)) - map(p + vec3(0, -eps, 0)),\n    map(p + vec3(0, 0, eps)) - map(p + vec3(0, 0, -eps))\n  ));\n} \n\nfloat calSpc() {\n  vec3 l1 = normalize(vec3(1, 1, 1));\n  vec3 ro = vec3(-3, 20, -8);\n  vec3 rc = vec3(0, 0, 0);\n  vec3 ww = normalize(rc - ro);\n  vec3 uu = normalize(cross(vec3(0,1,0), ww));\n  vec3 vv = normalize(cross(rc - ro, uu));\n  vec3 rd = normalize(uu * v_uv.x + vv * v_uv.y + ww);\n  float d = intersect(ro, rd);\n  vec3 p = ro + rd * d;\n  vec3 n = norm(p);\n  float spc = pow(max(0.0, dot(reflect(l1, n), rd)), 30.0);\n  return spc;\n}\n\nvoid main() {\n\n  outputColor = v_Color;\n  float spc = calSpc();\n  outputColor += spc * 0.4;\n}\n",triangulation:rb,inject:e.getInject(),primitive:Bu.TRIANGLES,depth:{enable:!1},pickingEnabled:!1,diagnosticDerivativeUniformityEnabled:!1});case 3:return n=t.sent,t.abrupt("return",[n]);case 5:case"end":return t.stop()}}),t)})))()}},{key:"clearModels",value:function(){var e;null===(e=this.texture)||void 0===e||e.destroy()}},{key:"registerBuiltinAttributes",value:function(){var e=a(this.layer.getSource().extent,4),t=e[0],n=e[1],r=e[2],i=e[3],o=r-t,s=i-n;this.styleAttributeService.registerStyleAttribute({name:"waterUv",type:Rc.Attribute,descriptor:{name:"a_uv",shaderLocation:by.UV,buffer:{usage:Bu.STATIC_DRAW,data:[],type:Bu.FLOAT},size:2,update:function(e,r,i,u){var c=a("GAODE2.x"===e.version?e.originCoordinates[0][u]:i,2),l=c[0],f=c[1];return[(l-t)/o,(f-n)/s]}}})}},{key:"loadTexture",value:function(){var e=this,t=this.layer.getLayerConfig().waterTexture,n=this.rendererService.createTexture2D;this.texture=n({height:1,width:1});var r=new Image;r.crossOrigin="",t?(console.warn("L7 recommend：https://gw.alipayobjects.com/mdn/rms_816329/afts/img/A*EojwT4VzSiYAAAAAAAAAAAAAARQnAQ"),r.src=t):r.src="https://gw.alipayobjects.com/mdn/rms_816329/afts/img/A*EojwT4VzSiYAAAAAAAAAAAAAARQnAQ",r.onload=function(){e.texture=n({data:r,width:r.width,height:r.height,wrapS:Bu.MIRRORED_REPEAT,wrapT:Bu.MIRRORED_REPEAT,min:Bu.LINEAR,mag:Bu.LINEAR}),e.layerService.reRender()}}}])}(qy),sA={fill:iA,line:Sb,extrude:nA,text:Qb,point_fill:Pb,point_image:Fb,point_normal:Ub,point_extrude:Ib,water:aA,ocean:oA,extrusion:rA},uA=function(e){function t(){var e;f(this,t);for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];return e=h(this,t,[].concat(r)),ne(e,"type","PolygonLayer"),ne(e,"enableShaderEncodeStyles",["opacity","extrusionBase","rotation","offsets","stroke"]),e}return d(t,e),c(t,[{key:"buildModels",value:function(){var e=this;return ie(i().mark((function t(){var n;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.getModelType(),e.layerModel=new sA[n](e),t.next=4,e.initLayerModels();case 4:case"end":return t.stop()}}),t)})))()}},{key:"getModelType",value:function(){var e,t=this.styleAttributeService.getLayerStyleAttribute("shape"),n=null==t||null===(e=t.scale)||void 0===e?void 0:e.field;return"fill"!==n&&n?"extrude"===n?"extrude":"extrusion"===n?"extrusion":"water"===n?"water":"ocean"===n?"ocean":"line"===n?"line":this.getPointModelType():"fill"}},{key:"getPointModelType",value:function(){var e=this.getEncodedData(),t=this.getLayerConfig(),n=t.shape2d,r=t.shape3d,i=this.iconService.getIconMap(),o=e.find((function(e){return e.hasOwnProperty("shape")}));if(o){var a=o.shape;return"dot"===a?"point_normal":-1!==(null==n?void 0:n.indexOf(a))?"point_fill":-1!==(null==r?void 0:r.indexOf(a))?"point_extrude":i.hasOwnProperty(a)?"point_image":"text"}return"fill"}}])}(Vy),cA=function(e){function t(){var e;f(this,t);for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];return e=h(this,t,[].concat(r)),ne(e,"texture",void 0),ne(e,"colorTexture",void 0),e}return d(t,e),c(t,[{key:"getUninforms",value:function(){var e=this.getCommonUniformsInfo(),t=this.getUniformsBufferInfo(this.getStyleAttribute());return this.updateStyleUnifoms(),re(re({},e.uniformsOption),t.uniformsOption)}},{key:"getCommonUniformsInfo",value:function(){var e=this.layer.getLayerConfig(),t=e.opacity,n=void 0===t?1:t,r=e.clampLow,i=void 0===r||r,o=e.clampHigh,a=void 0===o||o,s=e.noDataValue,u=void 0===s?-9999999:s,c=e.domain,l=e.rampColors,f=c||Zt(l);this.colorTexture=this.layer.textureService.getColorTexture(l,f);var h={u_domain:f,u_opacity:n||1,u_noDataValue:u,u_clampLow:i?1:0,u_clampHigh:(void 0!==a?a:i)?1:0,u_rasterTexture:this.texture,u_colorTexture:this.colorTexture};return this.textures=[this.texture,this.colorTexture],this.getUniformsBufferInfo(h)}},{key:"getRasterData",value:function(e){return ie(i().mark((function t(){var n,r,o,a;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!Array.isArray(e.data)){t.next=4;break}return t.abrupt("return",{data:e.data,width:e.width,height:e.height});case 4:return t.next=6,e.data;case 6:return n=t.sent,r=n.rasterData,o=n.width,a=n.height,t.abrupt("return",{data:Array.from(r),width:o,height:a});case 11:case"end":return t.stop()}}),t)})))()}},{key:"initModels",value:function(){var e=this;return ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",e.buildModels());case 1:case"end":return t.stop()}}),t)})))()}},{key:"buildModels",value:function(){var e=this;return ie(i().mark((function t(){var n,r,o,a,s,u,c,l,f,h;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.initUniformsBuffer(),n=e.layer.getSource(),r=e.rendererService,o=r.createTexture2D,a=r.queryVerdorInfo,s=n.data.dataArray[0],t.next=6,e.getRasterData(s);case 6:return u=t.sent,c=u.data,l=u.width,f=u.height,e.texture=o({data:new Float32Array(c),width:l,height:f,format:"WebGL1"===a()?Bu.LUMINANCE:Bu.RED,type:Bu.FLOAT,alignment:1}),t.next=13,e.layer.buildLayerModel({moduleName:"rasterImageData",vertexShader:'\nlayout(location = 0) in vec3 a_Position;\nlayout(location = 14) in vec2 a_Uv;\n\nlayout(std140) uniform commonUniforms {\n  vec2 u_domain;\n  float u_opacity;\n  float u_noDataValue;\n  float u_clampLow;\n  float u_clampHigh;\n};\n\nout vec2 v_texCoord;\n\n#pragma include "projection"\n\nvoid main() {\n   v_texCoord = a_Uv;\n   vec4 project_pos = project_position(vec4(a_Position, 1.0));\n  gl_Position = project_common_position_to_clipspace_v2(vec4(project_pos.xy,0., 1.0));\n}\n',fragmentShader:"layout(std140) uniform commonUniforms {\n  vec2 u_domain;\n  float u_opacity;\n  float u_noDataValue;\n  float u_clampLow;\n  float u_clampHigh;\n};\n\nuniform sampler2D u_rasterTexture;\nuniform sampler2D u_colorTexture;\n\nin vec2 v_texCoord;\n\nbool isnan_emu(float x) { return (x > 0.0 || x < 0.0) ? x != x : x != 0.0; }\n\nout vec4 outputColor;\n\nvoid main() {\n  // Can use any component here since u_rasterTexture is under luminance format.\n  float value = texture(SAMPLER_2D(u_rasterTexture), vec2(v_texCoord.x, v_texCoord.y)).r;\n  if (value == u_noDataValue || isnan_emu(value)) {\n    discard;\n  } else if ((u_clampLow < 0.5 && value < u_domain[0]) || (u_clampHigh < 0.5 && value > u_domain[1])) {\n    discard;\n  } else {\n    float normalisedValue =(value - u_domain[0]) / (u_domain[1] - u_domain[0]);\n    vec4 color = texture(SAMPLER_2D(u_colorTexture), vec2(normalisedValue, 0));\n    \n    outputColor = color;\n    outputColor.a = outputColor.a * u_opacity ;\n    if (outputColor.a < 0.01)\n      discard;\n  }\n}\n",triangulation:sb,primitive:Bu.TRIANGLES,depth:{enable:!1},pickingEnabled:!1});case 13:return h=t.sent,t.abrupt("return",[h]);case 15:case"end":return t.stop()}}),t)})))()}},{key:"clearModels",value:function(){var e,t;null===(e=this.texture)||void 0===e||e.destroy(),null===(t=this.colorTexture)||void 0===t||t.destroy()}},{key:"registerBuiltinAttributes",value:function(){this.styleAttributeService.registerStyleAttribute({name:"uv",type:Rc.Attribute,descriptor:{shaderLocation:by.UV,name:"a_Uv",buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:2,update:function(e,t,n){return[n[3],n[4]]}}})}}])}(qy),lA=["data"],fA=["rasterData"],hA=function(e){function t(){var e;f(this,t);for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];return e=h(this,t,[].concat(r)),ne(e,"texture",void 0),ne(e,"dataOption",{}),e}return d(t,e),c(t,[{key:"getUninforms",value:function(){var e=this.getCommonUniformsInfo(),t=this.getUniformsBufferInfo(this.getStyleAttribute());return this.updateStyleUnifoms(),re(re({},e.uniformsOption),t.uniformsOption)}},{key:"getCommonUniformsInfo",value:function(){var e=this.layer.getLayerConfig(),t=e.opacity,n=void 0===t?1:t,r=e.noDataValue,i=void 0===r?0:r,o=this.dataOption,a=o.rMinMax,s=void 0===a?[0,255]:a,u=o.gMinMax,c=void 0===u?[0,255]:u,l=o.bMinMax,f={u_rminmax:s,u_gminmax:c,u_bminmax:void 0===l?[0,255]:l,u_opacity:n||1,u_noDataValue:i,u_texture:this.texture};return this.textures=[this.texture],this.getUniformsBufferInfo(f)}},{key:"getRasterData",value:function(e){var t=this;return ie(i().mark((function n(){var r,o,a,s,u;return i().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:if(!Array.isArray(e.data)){n.next=4;break}return r=e.data,o=oe(e,lA),t.dataOption=o,n.abrupt("return",re({data:r},o));case 4:return n.next=6,e.data;case 6:if(a=n.sent,s=a.rasterData,u=oe(a,fA),t.dataOption=u,!Array.isArray(s)){n.next=14;break}return n.abrupt("return",re({data:s},u));case 14:return n.abrupt("return",re({data:Array.from(s)},u));case 15:case"end":return n.stop()}}),n)})))()}},{key:"initModels",value:function(){var e=this;return ie(i().mark((function t(){var n,r,o,a,s,u,c,l;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.initUniformsBuffer(),n=e.layer.getSource(),r=e.rendererService.createTexture2D,o=n.data.dataArray[0],t.next=6,e.getRasterData(o);case 6:return a=t.sent,s=a.data,u=a.width,c=a.height,e.texture=r({data:new Float32Array(s),width:u,height:c,format:Bu.RGB,type:Bu.FLOAT}),t.next=13,e.layer.buildLayerModel({moduleName:"rasterImageDataRGBA",vertexShader:'\nlayout(location = 0) in vec3 a_Position;\nlayout(location = 14) in vec2 a_Uv;\n\nlayout(std140) uniform commonUniforms {\n vec2 u_rminmax;\n vec2 u_gminmax;\n vec2 u_bminmax;\n float u_opacity;\n float u_noDataValue;\n};\n\nout vec2 v_texCoord;\n\n#pragma include "projection"\n\nvoid main() {\n   v_texCoord = a_Uv;\n   vec4 project_pos = project_position(vec4(a_Position, 1.0));\n   gl_Position = project_common_position_to_clipspace_v2(vec4(project_pos.xy,0., 1.0));\n}\n',fragmentShader:"uniform sampler2D u_texture;\nlayout(std140) uniform commonUniforms {\n vec2 u_rminmax;\n vec2 u_gminmax;\n vec2 u_bminmax;\n float u_opacity;\n float u_noDataValue;\n};\n\nin vec2 v_texCoord;\n\nout vec4 outputColor;\n\nvoid main() {\n\n  vec3 rgb = texture(SAMPLER_2D(u_texture),vec2(v_texCoord.x,v_texCoord.y)).rgb;\n\n  if(rgb == vec3(u_noDataValue)) {\n    outputColor = vec4(0.0, 0, 0, 0.0);\n  } else {\n    outputColor = vec4(rgb.r / (u_rminmax.y -u_rminmax.x), rgb.g /(u_gminmax.y -u_gminmax.x), rgb.b/ (u_bminmax.y - u_bminmax.x), u_opacity);\n  }\n\n  if(outputColor.a < 0.01)\n    discard;\n \n}",triangulation:sb,primitive:Bu.TRIANGLES,depth:{enable:!1},pickingEnabled:!1});case 13:return l=t.sent,t.abrupt("return",[l]);case 15:case"end":return t.stop()}}),t)})))()}},{key:"buildModels",value:function(){var e=this;return ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",e.initModels());case 1:case"end":return t.stop()}}),t)})))()}},{key:"clearModels",value:function(){var e;null===(e=this.texture)||void 0===e||e.destroy()}},{key:"registerBuiltinAttributes",value:function(){this.styleAttributeService.registerStyleAttribute({name:"uv",type:Rc.Attribute,descriptor:{name:"a_Uv",shaderLocation:by.UV,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:2,update:function(e,t,n){return[n[3],n[4]]}}})}}])}(qy),dA=function(e){function t(){var e;f(this,t);for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];return e=h(this,t,[].concat(r)),ne(e,"texture",void 0),e}return d(t,e),c(t,[{key:"getCommonUniformsInfo",value:function(){var e=this.layer.getLayerConfig(),t=e.opacity,n=e.clampLow,r=void 0===n||n,i=e.clampHigh,o=void 0===i||i,a=e.noDataValue,s=void 0===a?-9999999:a,u=e.domain,c=e.rampColors,l=e.colorTexture,f=e.rScaler,h=void 0===f?6553.6:f,d=e.gScaler,p=void 0===d?25.6:d,v=e.bScaler,m=void 0===v?.1:v,g=e.offset,_=void 0===g?1e4:g,y=u||Zt(c),E=l;l?this.layer.textureService.setColorTexture(l,c,y):E=this.layer.textureService.getColorTexture(c,y);var b={u_unpack:[h,p,m,_],u_domain:y,u_opacity:t||1,u_noDataValue:s,u_clampLow:r,u_clampHigh:void 0!==o?o:r,u_texture:this.texture,u_colorTexture:E};return this.textures=[this.texture,E],this.getUniformsBufferInfo(b)}},{key:"initModels",value:function(){var e=this;return ie(i().mark((function t(){var n,r,o,a;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.initUniformsBuffer(),n=e.layer.getSource(),r=e.rendererService.createTexture2D,t.next=5,n.data.images;case 5:return o=t.sent,e.texture=r({data:o[0],width:o[0].width,height:o[0].height,min:Bu.LINEAR,mag:Bu.LINEAR}),t.next=9,e.layer.buildLayerModel({moduleName:"RasterTileDataImage",vertexShader:'layout(location = 0) in vec3 a_Position;\nlayout(location = 14) in vec2 a_Uv;\n\nlayout(std140) uniform commonUniforms {\n   vec4 u_unpack;\n   vec2 u_domain;\n   float u_opacity;\n   float u_noDataValue;\n   float u_clampLow;\n   float u_clampHigh;\n};\nout vec2 v_texCoord;\n#pragma include "projection"\n\nvoid main() {\n   v_texCoord = a_Uv;\n   vec4 project_pos = project_position(vec4(a_Position, 1.0));\n   gl_Position = project_common_position_to_clipspace_v2(vec4(project_pos.xy,0., 1.0));\n}\n',fragmentShader:"uniform sampler2D u_texture;\nuniform sampler2D u_colorTexture;\n\nlayout(std140) uniform commonUniforms {\n vec4 u_unpack;\n vec2 u_domain;\n float u_opacity;\n float u_noDataValue;\n float u_clampLow;\n float u_clampHigh;\n};\n\nin vec2 v_texCoord;\nout vec4 outputColor;\n\n\nfloat getElevation(vec2 coord, float bias) {\n    // Convert encoded elevation value to meters\n    vec4 data =  texture(SAMPLER_2D(u_texture), coord,bias) * 255.0;\n    data.a = -1.0;\n    return dot(data, u_unpack);\n}\n\nvec4 getColor(float value) {\n   float normalisedValue =(value- u_domain[0]) / (u_domain[1] - u_domain[0]);\n    vec2 coord = vec2(normalisedValue, 0);\n    return  texture(SAMPLER_2D(u_colorTexture), coord);\n}\n\nvoid main() {\n  float value = getElevation(v_texCoord,0.0);\n  if (value == u_noDataValue) {\n    outputColor = vec4(0.0, 0, 0, 0.0);\n  } else if ((u_clampLow < 0.5 && value < u_domain[0]) || (u_clampHigh < 0.5 && value > u_domain[1])) {\n     outputColor = vec4(0.0, 0, 0, 0.0);\n  } else {\n   \n    outputColor = getColor(value);\n    outputColor.a =  outputColor.a * u_opacity ;\n      if(outputColor.a < 0.01)\n      discard;\n  }\n}\n",triangulation:sb,primitive:Bu.TRIANGLES,depth:{enable:!1}});case 9:return a=t.sent,t.abrupt("return",[a]);case 11:case"end":return t.stop()}}),t)})))()}},{key:"clearModels",value:function(){var e;null===(e=this.texture)||void 0===e||e.destroy()}},{key:"buildModels",value:function(){var e=this;return ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",e.initModels());case 1:case"end":return t.stop()}}),t)})))()}},{key:"registerBuiltinAttributes",value:function(){this.styleAttributeService.registerStyleAttribute({name:"uv",type:Rc.Attribute,descriptor:{name:"a_Uv",shaderLocation:by.UV,buffer:{usage:Bu.DYNAMIC_DRAW,data:[],type:Bu.FLOAT},size:2,update:function(e,t,n){return[n[3],n[4]]}}})}}])}(qy),pA={raster:cA,rasterRgb:hA,raster3d:cA,rasterTerrainRgb:dA},vA=function(e){function t(){var e;f(this,t);for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];return e=h(this,t,[].concat(r)),ne(e,"type","RasterLayer"),e}return d(t,e),c(t,[{key:"buildModels",value:function(){var e=this;return ie(i().mark((function t(){var n;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.getModelType(),e.layerModel=new pA[n](e),t.next=4,e.initLayerModels();case 4:case"end":return t.stop()}}),t)})))()}},{key:"getDefaultConfig",value:function(){return{raster:{},rasterRgb:{},raster3d:{},rasterTerrainRgb:{}}[this.getModelType()]}},{key:"getModelType",value:function(){switch(this.layerSource.getParserType()){case"raster":default:return"raster";case"rasterRgb":case"rgb":return"rasterRgb";case"image":return"rasterTerrainRgb"}}},{key:"getLegend",value:function(e){return"color"!==e?{type:void 0,field:void 0,items:[]}:function(e,t){return{type:e.type,field:"value",items:e.positions.map((function(n,r){return o(o({},t,r>=e.colors.length?null:e.colors[r]),"value",n)}))}}(this.getLayerConfig().rampColors,e)}}])}(Vy),mA=function(){return c((function e(t){var n=t.rendererService,r=t.layerService,i=t.parent;f(this,e),ne(this,"tileResource",new Map),ne(this,"rendererService",void 0),ne(this,"layerService",void 0),ne(this,"parent",void 0),ne(this,"layerTiles",[]),this.rendererService=n,this.layerService=r,this.parent=i}),[{key:"tiles",get:function(){return this.layerTiles}},{key:"hasTile",value:function(e){return this.layerTiles.some((function(t){return t.key===e}))}},{key:"addTile",value:function(e){this.layerTiles.push(e)}},{key:"getTile",value:function(e){return this.layerTiles.find((function(t){return t.key===e}))}},{key:"getVisibleTileBylngLat",value:function(e){return this.layerTiles.find((function(t){return t.isLoaded&&t.visible&&t.lnglatInBounds(e)}))}},{key:"removeTile",value:function(e){var t=this.layerTiles.findIndex((function(t){return t.key===e})),n=this.layerTiles.splice(t,1);n[0]&&n[0].destroy()}},{key:"updateTileVisible",value:function(e){var t=this.getTile(e.key);if(e.isVisible)if(e.parent){var n=this.isChildrenLoaded(e.parent);null==t||t.updateVisible(n)}else null==t||t.updateVisible(!0);else if(e.parent){var r=this.isChildrenLoaded(e.parent);null==t||t.updateVisible(!r)}else null==t||t.updateVisible(!1)}},{key:"isParentLoaded",value:function(e){var t=e.parent;if(!t)return!0;var n=this.getTile(null==t?void 0:t.key);return!(null==n||!n.isLoaded)}},{key:"isChildrenLoaded",value:function(e){var t=this,n=null==e?void 0:e.children;return 0===n.length||n.every((function(e){var n=t.getTile(null==e?void 0:e.key);return!n||!0===(null==n?void 0:n.isLoaded)}))}},{key:"render",value:function(){var e=this;return ie(i().mark((function t(){var n,r;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.getRenderLayers(),r=n.map(function(){var t=ie(i().mark((function t(n){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,e.layerService.renderTileLayer(n);case 2:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()),t.next=4,Promise.all(r);case 4:case"end":return t.stop()}}),t)})))()}},{key:"getRenderLayers",value:function(){var e=this.layerTiles.filter((function(e){return e.visible&&e.isLoaded})),t=[];return e.map((function(e){return t.push.apply(t,r(e.getLayers()))})),t}},{key:"getLayers",value:function(){var e=this.layerTiles.filter((function(e){return e.isLoaded})),t=[];return e.map((function(e){return t.push.apply(t,r(e.getLayers()))})),t}},{key:"getTiles",value:function(){return this.layerTiles}},{key:"destroy",value:function(){this.layerTiles.forEach((function(e){return e.destroy()})),this.tileResource.clear()}}])}();
/**
             * splaytree v3.1.2
             * Fast Splay tree for Node and browser
             *
             * @author Alexander Milevski <info@w8r.name>
             * @license MIT
             * @preserve
             */
/*! *****************************************************************************
            Copyright (c) Microsoft Corporation. All rights reserved.
            Licensed under the Apache License, Version 2.0 (the "License"); you may not use
            this file except in compliance with the License. You may obtain a copy of the
            License at http://www.apache.org/licenses/LICENSE-2.0

            THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
            KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
            WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
            MERCHANTABLITY OR NON-INFRINGEMENT.

            See the Apache Version 2.0 License for specific language governing permissions
            and limitations under the License.
            ***************************************************************************** */
function gA(e,t){var n,r,i,o,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(o){return function(s){return function(o){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(i=2&o[0]?r.return:o[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,o[1])).done)return i;switch(r=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,r=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(i=a.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){a.label=o[1];break}if(6===o[0]&&a.label<i[1]){a.label=i[1],i=o;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(o);break}i[2]&&a.ops.pop(),a.trys.pop();continue}o=t.call(e,a)}catch(s){o=[6,s],r=0}finally{n=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,s])}}}var _A=function(e,t){this.next=null,this.key=e,this.data=t,this.left=null,this.right=null};function yA(e,t){return e>t?1:e<t?-1:0}function EA(e,t,n){for(var r=new _A(null,null),i=r,o=r;;){var a=n(e,t.key);if(a<0){if(null===t.left)break;if(n(e,t.left.key)<0){var s=t.left;if(t.left=s.right,s.right=t,null===(t=s).left)break}o.left=t,o=t,t=t.left}else{if(!(a>0))break;if(null===t.right)break;if(n(e,t.right.key)>0){s=t.right;if(t.right=s.left,s.left=t,null===(t=s).right)break}i.right=t,i=t,t=t.right}}return i.right=t.left,o.left=t.right,t.left=r.right,t.right=r.left,t}function bA(e,t,n,r){var i=new _A(e,t);if(null===n)return i.left=i.right=null,i;var o=r(e,(n=EA(e,n,r)).key);return o<0?(i.left=n.left,i.right=n,n.left=null):o>=0&&(i.right=n.right,i.left=n,n.right=null),i}function AA(e,t,n){var r=null,i=null;if(t){var o=n((t=EA(e,t,n)).key,e);0===o?(r=t.left,i=t.right):o<0?(i=t.right,t.right=null,r=t):(r=t.left,t.left=null,i=t)}return{left:r,right:i}}function xA(e,t,n,r,i){if(e){r(t+(n?"└── ":"├── ")+i(e)+"\n");var o=t+(n?"    ":"│   ");e.left&&xA(e.left,o,!1,r,i),e.right&&xA(e.right,o,!0,r,i)}}var SA=function(){function e(e){void 0===e&&(e=yA),this._root=null,this._size=0,this._comparator=e}return e.prototype.insert=function(e,t){return this._size++,this._root=bA(e,t,this._root,this._comparator)},e.prototype.add=function(e,t){var n=new _A(e,t);null===this._root&&(n.left=n.right=null,this._size++,this._root=n);var r=this._comparator,i=EA(e,this._root,r),o=r(e,i.key);return 0===o?this._root=i:(o<0?(n.left=i.left,n.right=i,i.left=null):o>0&&(n.right=i.right,n.left=i,i.right=null),this._size++,this._root=n),this._root},e.prototype.remove=function(e){this._root=this._remove(e,this._root,this._comparator)},e.prototype._remove=function(e,t,n){var r;return null===t?null:0===n(e,(t=EA(e,t,n)).key)?(null===t.left?r=t.right:(r=EA(e,t.left,n)).right=t.right,this._size--,r):t},e.prototype.pop=function(){var e=this._root;if(e){for(;e.left;)e=e.left;return this._root=EA(e.key,this._root,this._comparator),this._root=this._remove(e.key,this._root,this._comparator),{key:e.key,data:e.data}}return null},e.prototype.findStatic=function(e){for(var t=this._root,n=this._comparator;t;){var r=n(e,t.key);if(0===r)return t;t=r<0?t.left:t.right}return null},e.prototype.find=function(e){return this._root&&(this._root=EA(e,this._root,this._comparator),0!==this._comparator(e,this._root.key))?null:this._root},e.prototype.contains=function(e){for(var t=this._root,n=this._comparator;t;){var r=n(e,t.key);if(0===r)return!0;t=r<0?t.left:t.right}return!1},e.prototype.forEach=function(e,t){for(var n=this._root,r=[],i=!1;!i;)null!==n?(r.push(n),n=n.left):0!==r.length?(n=r.pop(),e.call(t,n),n=n.right):i=!0;return this},e.prototype.range=function(e,t,n,r){for(var i=[],o=this._comparator,a=this._root;0!==i.length||a;)if(a)i.push(a),a=a.left;else{if(o((a=i.pop()).key,t)>0)break;if(o(a.key,e)>=0&&n.call(r,a))return this;a=a.right}return this},e.prototype.keys=function(){var e=[];return this.forEach((function(t){var n=t.key;return e.push(n)})),e},e.prototype.values=function(){var e=[];return this.forEach((function(t){var n=t.data;return e.push(n)})),e},e.prototype.min=function(){return this._root?this.minNode(this._root).key:null},e.prototype.max=function(){return this._root?this.maxNode(this._root).key:null},e.prototype.minNode=function(e){if(void 0===e&&(e=this._root),e)for(;e.left;)e=e.left;return e},e.prototype.maxNode=function(e){if(void 0===e&&(e=this._root),e)for(;e.right;)e=e.right;return e},e.prototype.at=function(e){for(var t=this._root,n=!1,r=0,i=[];!n;)if(t)i.push(t),t=t.left;else if(i.length>0){if(t=i.pop(),r===e)return t;r++,t=t.right}else n=!0;return null},e.prototype.next=function(e){var t=this._root,n=null;if(e.right){for(n=e.right;n.left;)n=n.left;return n}for(var r=this._comparator;t;){var i=r(e.key,t.key);if(0===i)break;i<0?(n=t,t=t.left):t=t.right}return n},e.prototype.prev=function(e){var t=this._root,n=null;if(null!==e.left){for(n=e.left;n.right;)n=n.right;return n}for(var r=this._comparator;t;){var i=r(e.key,t.key);if(0===i)break;i<0?t=t.left:(n=t,t=t.right)}return n},e.prototype.clear=function(){return this._root=null,this._size=0,this},e.prototype.toList=function(){return function(e){var t=e,n=[],r=!1,i=new _A(null,null),o=i;for(;!r;)t?(n.push(t),t=t.left):n.length>0?t=(t=o=o.next=n.pop()).right:r=!0;return o.next=null,i.next}(this._root)},e.prototype.load=function(e,t,n){void 0===t&&(t=[]),void 0===n&&(n=!1);var r=e.length,i=this._comparator;if(n&&CA(e,t,0,r-1,i),null===this._root)this._root=TA(e,t,0,r),this._size=r;else{var o=function(e,t,n){var r=new _A(null,null),i=r,o=e,a=t;for(;null!==o&&null!==a;)n(o.key,a.key)<0?(i.next=o,o=o.next):(i.next=a,a=a.next),i=i.next;null!==o?i.next=o:null!==a&&(i.next=a);return r.next}(this.toList(),function(e,t){for(var n=new _A(null,null),r=n,i=0;i<e.length;i++)r=r.next=new _A(e[i],t[i]);return r.next=null,n.next}(e,t),i);r=this._size+r,this._root=RA({head:o},0,r)}return this},e.prototype.isEmpty=function(){return null===this._root},Object.defineProperty(e.prototype,"size",{get:function(){return this._size},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"root",{get:function(){return this._root},enumerable:!0,configurable:!0}),e.prototype.toString=function(e){void 0===e&&(e=function(e){return String(e.key)});var t=[];return xA(this._root,"",!0,(function(e){return t.push(e)}),e),t.join("")},e.prototype.update=function(e,t,n){var r=this._comparator,i=AA(e,this._root,r),o=i.left,a=i.right;r(e,t)<0?a=bA(t,n,a,r):o=bA(t,n,o,r),this._root=function(e,t,n){return null===t?e:(null===e||((t=EA(e.key,t,n)).left=e),t)}(o,a,r)},e.prototype.split=function(e){return AA(e,this._root,this._comparator)},e.prototype[Symbol.iterator]=function(){var e,t,n;return gA(this,(function(r){switch(r.label){case 0:e=this._root,t=[],n=!1,r.label=1;case 1:return n?[3,6]:null===e?[3,2]:(t.push(e),e=e.left,[3,5]);case 2:return 0===t.length?[3,4]:[4,e=t.pop()];case 3:return r.sent(),e=e.right,[3,5];case 4:n=!0,r.label=5;case 5:return[3,1];case 6:return[2]}}))},e}();function TA(e,t,n,r){var i=r-n;if(i>0){var o=n+Math.floor(i/2),a=e[o],s=t[o],u=new _A(a,s);return u.left=TA(e,t,n,o),u.right=TA(e,t,o+1,r),u}return null}function RA(e,t,n){var r=n-t;if(r>0){var i=t+Math.floor(r/2),o=RA(e,t,i),a=e.head;return a.left=o,e.head=e.head.next,a.right=RA(e,i+1,n),a}return null}function CA(e,t,n,r,i){if(!(n>=r)){for(var o=e[n+r>>1],a=n-1,s=r+1;;){do{a++}while(i(e[a],o)<0);do{s--}while(i(e[s],o)>0);if(a>=s)break;var u=e[a];e[a]=e[s],e[s]=u,u=t[a],t[a]=t[s],t[s]=u}CA(e,t,n,s,i),CA(e,t,s+1,r,i)}}var MA=function(e,t){return e.ll.x<=t.x&&t.x<=e.ur.x&&e.ll.y<=t.y&&t.y<=e.ur.y},wA=function(e,t){if(t.ur.x<e.ll.x||e.ur.x<t.ll.x||t.ur.y<e.ll.y||e.ur.y<t.ll.y)return null;var n=e.ll.x<t.ll.x?t.ll.x:e.ll.x,r=e.ur.x<t.ur.x?e.ur.x:t.ur.x;return{ll:{x:n,y:e.ll.y<t.ll.y?t.ll.y:e.ll.y},ur:{x:r,y:e.ur.y<t.ur.y?e.ur.y:t.ur.y}}},LA=Number.EPSILON;void 0===LA&&(LA=Math.pow(2,-52));var OA=LA*LA,kA=function(e,t){if(-LA<e&&e<LA&&-LA<t&&t<LA)return 0;var n=e-t;return n*n<OA*e*t?0:e<t?-1:1},NA=function(){return c((function e(){f(this,e),this.reset()}),[{key:"reset",value:function(){this.xRounder=new IA,this.yRounder=new IA}},{key:"round",value:function(e,t){return{x:this.xRounder.round(e),y:this.yRounder.round(t)}}}])}(),IA=function(){return c((function e(){f(this,e),this.tree=new SA,this.round(0)}),[{key:"round",value:function(e){var t=this.tree.add(e),n=this.tree.prev(t);if(null!==n&&0===kA(t.key,n.key))return this.tree.remove(e),n.key;var r=this.tree.next(t);return null!==r&&0===kA(t.key,r.key)?(this.tree.remove(e),r.key):e}}])}(),PA=new NA,DA=function(e,t){return e.x*t.y-e.y*t.x},FA=function(e,t){return e.x*t.x+e.y*t.y},BA=function(e,t,n){var r=Re(e.x,e.y,t.x,t.y,n.x,n.y);return r>0?-1:r<0?1:0},UA=function(e){return Math.sqrt(FA(e,e))},GA=function(e,t,n){var r={x:t.x-e.x,y:t.y-e.y},i={x:n.x-e.x,y:n.y-e.y};return FA(i,r)/UA(i)/UA(r)},zA=function(e,t,n){return 0===t.y?null:{x:e.x+t.x/t.y*(n-e.y),y:n}},jA=function(e,t,n){return 0===t.x?null:{x:n,y:e.y+t.y/t.x*(n-e.x)}},VA=function(){function e(t,n){f(this,e),void 0===t.events?t.events=[this]:t.events.push(this),this.point=t,this.isLeft=n}return c(e,[{key:"link",value:function(e){if(e.point===this.point)throw new Error("Tried to link already linked events");for(var t=e.point.events,n=0,r=t.length;n<r;n++){var i=t[n];this.point.events.push(i),i.point=this.point}this.checkForConsuming()}},{key:"checkForConsuming",value:function(){for(var e=this.point.events.length,t=0;t<e;t++){var n=this.point.events[t];if(void 0===n.segment.consumedBy)for(var r=t+1;r<e;r++){var i=this.point.events[r];void 0===i.consumedBy&&(n.otherSE.point.events===i.otherSE.point.events&&n.segment.consume(i.segment))}}}},{key:"getAvailableLinkedEvents",value:function(){for(var e=[],t=0,n=this.point.events.length;t<n;t++){var r=this.point.events[t];r!==this&&!r.segment.ringOut&&r.segment.isInResult()&&e.push(r)}return e}},{key:"getLeftmostComparator",value:function(e){var t=this,n=new Map,r=function(r){var i,o,a,s,u,c=r.otherSE;n.set(r,{sine:(i=t.point,o=e.point,a=c.point,s={x:o.x-i.x,y:o.y-i.y},u={x:a.x-i.x,y:a.y-i.y},DA(u,s)/UA(u)/UA(s)),cosine:GA(t.point,e.point,c.point)})};return function(e,t){n.has(e)||r(e),n.has(t)||r(t);var i=n.get(e),o=i.sine,a=i.cosine,s=n.get(t),u=s.sine,c=s.cosine;return o>=0&&u>=0?a<c?1:a>c?-1:0:o<0&&u<0?a<c?-1:a>c?1:0:u<o?-1:u>o?1:0}}}],[{key:"compare",value:function(t,n){var r=e.comparePoints(t.point,n.point);return 0!==r?r:(t.point!==n.point&&t.link(n),t.isLeft!==n.isLeft?t.isLeft?1:-1:XA.compare(t.segment,n.segment))}},{key:"comparePoints",value:function(e,t){return e.x<t.x?-1:e.x>t.x?1:e.y<t.y?-1:e.y>t.y?1:0}}])}(),HA=0,XA=function(){function e(t,n,r,i){f(this,e),this.id=++HA,this.leftSE=t,t.segment=this,t.otherSE=n,this.rightSE=n,n.segment=this,n.otherSE=t,this.rings=r,this.windings=i}return c(e,[{key:"replaceRightSE",value:function(e){this.rightSE=e,this.rightSE.segment=this,this.rightSE.otherSE=this.leftSE,this.leftSE.otherSE=this.rightSE}},{key:"bbox",value:function(){var e=this.leftSE.point.y,t=this.rightSE.point.y;return{ll:{x:this.leftSE.point.x,y:e<t?e:t},ur:{x:this.rightSE.point.x,y:e>t?e:t}}}},{key:"vector",value:function(){return{x:this.rightSE.point.x-this.leftSE.point.x,y:this.rightSE.point.y-this.leftSE.point.y}}},{key:"isAnEndpoint",value:function(e){return e.x===this.leftSE.point.x&&e.y===this.leftSE.point.y||e.x===this.rightSE.point.x&&e.y===this.rightSE.point.y}},{key:"comparePoint",value:function(e){if(this.isAnEndpoint(e))return 0;var t=this.leftSE.point,n=this.rightSE.point,r=this.vector();if(t.x===n.x)return e.x===t.x?0:e.x<t.x?1:-1;var i=(e.y-t.y)/r.y,o=t.x+i*r.x;if(e.x===o)return 0;var a=(e.x-t.x)/r.x,s=t.y+a*r.y;return e.y===s?0:e.y<s?-1:1}},{key:"getIntersection",value:function(e){var t=this.bbox(),n=e.bbox(),r=wA(t,n);if(null===r)return null;var i=this.leftSE.point,o=this.rightSE.point,a=e.leftSE.point,s=e.rightSE.point,u=MA(t,a)&&0===this.comparePoint(a),c=MA(n,i)&&0===e.comparePoint(i),l=MA(t,s)&&0===this.comparePoint(s),f=MA(n,o)&&0===e.comparePoint(o);if(c&&u)return f&&!l?o:!f&&l?s:null;if(c)return l&&i.x===s.x&&i.y===s.y?null:i;if(u)return f&&o.x===a.x&&o.y===a.y?null:a;if(f&&l)return null;if(f)return o;if(l)return s;var h=function(e,t,n,r){if(0===t.x)return jA(n,r,e.x);if(0===r.x)return jA(e,t,n.x);if(0===t.y)return zA(n,r,e.y);if(0===r.y)return zA(e,t,n.y);var i=DA(t,r);if(0==i)return null;var o={x:n.x-e.x,y:n.y-e.y},a=DA(o,t)/i,s=DA(o,r)/i;return{x:(e.x+s*t.x+(n.x+a*r.x))/2,y:(e.y+s*t.y+(n.y+a*r.y))/2}}(i,this.vector(),a,e.vector());return null===h?null:MA(r,h)?PA.round(h.x,h.y):null}},{key:"split",value:function(t){var n=[],r=void 0!==t.events,i=new VA(t,!0),o=new VA(t,!1),a=this.rightSE;this.replaceRightSE(o),n.push(o),n.push(i);var s=new e(i,a,this.rings.slice(),this.windings.slice());return VA.comparePoints(s.leftSE.point,s.rightSE.point)>0&&s.swapEvents(),VA.comparePoints(this.leftSE.point,this.rightSE.point)>0&&this.swapEvents(),r&&(i.checkForConsuming(),o.checkForConsuming()),n}},{key:"swapEvents",value:function(){var e=this.rightSE;this.rightSE=this.leftSE,this.leftSE=e,this.leftSE.isLeft=!0,this.rightSE.isLeft=!1;for(var t=0,n=this.windings.length;t<n;t++)this.windings[t]*=-1}},{key:"consume",value:function(t){for(var n=this,r=t;n.consumedBy;)n=n.consumedBy;for(;r.consumedBy;)r=r.consumedBy;var i=e.compare(n,r);if(0!==i){if(i>0){var o=n;n=r,r=o}if(n.prev===r){var a=n;n=r,r=a}for(var s=0,u=r.rings.length;s<u;s++){var c=r.rings[s],l=r.windings[s],f=n.rings.indexOf(c);-1===f?(n.rings.push(c),n.windings.push(l)):n.windings[f]+=l}r.rings=null,r.windings=null,r.consumedBy=n,r.leftSE.consumedBy=n.leftSE,r.rightSE.consumedBy=n.rightSE}}},{key:"prevInResult",value:function(){return void 0!==this._prevInResult||(this.prev?this.prev.isInResult()?this._prevInResult=this.prev:this._prevInResult=this.prev.prevInResult():this._prevInResult=null),this._prevInResult}},{key:"beforeState",value:function(){if(void 0!==this._beforeState)return this._beforeState;if(this.prev){var e=this.prev.consumedBy||this.prev;this._beforeState=e.afterState()}else this._beforeState={rings:[],windings:[],multiPolys:[]};return this._beforeState}},{key:"afterState",value:function(){if(void 0!==this._afterState)return this._afterState;var e=this.beforeState();this._afterState={rings:e.rings.slice(0),windings:e.windings.slice(0),multiPolys:[]};for(var t=this._afterState.rings,n=this._afterState.windings,r=this._afterState.multiPolys,i=0,o=this.rings.length;i<o;i++){var a=this.rings[i],s=this.windings[i],u=t.indexOf(a);-1===u?(t.push(a),n.push(s)):n[u]+=s}for(var c=[],l=[],f=0,h=t.length;f<h;f++)if(0!==n[f]){var d=t[f],p=d.poly;if(-1===l.indexOf(p))if(d.isExterior)c.push(p);else{-1===l.indexOf(p)&&l.push(p);var v=c.indexOf(d.poly);-1!==v&&c.splice(v,1)}}for(var m=0,g=c.length;m<g;m++){var _=c[m].multiPoly;-1===r.indexOf(_)&&r.push(_)}return this._afterState}},{key:"isInResult",value:function(){if(this.consumedBy)return!1;if(void 0!==this._isInResult)return this._isInResult;var e=this.beforeState().multiPolys,t=this.afterState().multiPolys;switch(tx.type){case"union":var n=0===e.length,r=0===t.length;this._isInResult=n!==r;break;case"intersection":var i,o;e.length<t.length?(i=e.length,o=t.length):(i=t.length,o=e.length),this._isInResult=o===tx.numMultiPolys&&i<o;break;case"xor":var a=Math.abs(e.length-t.length);this._isInResult=a%2==1;break;case"difference":var s=function(e){return 1===e.length&&e[0].isSubject};this._isInResult=s(e)!==s(t);break;default:throw new Error("Unrecognized operation type found ".concat(tx.type))}return this._isInResult}}],[{key:"compare",value:function(e,t){var n=e.leftSE.point.x,r=t.leftSE.point.x,i=e.rightSE.point.x,o=t.rightSE.point.x;if(o<n)return 1;if(i<r)return-1;var a=e.leftSE.point.y,s=t.leftSE.point.y,u=e.rightSE.point.y,c=t.rightSE.point.y;if(n<r){if(s<a&&s<u)return 1;if(s>a&&s>u)return-1;var l=e.comparePoint(t.leftSE.point);if(l<0)return 1;if(l>0)return-1;var f=t.comparePoint(e.rightSE.point);return 0!==f?f:-1}if(n>r){if(a<s&&a<c)return-1;if(a>s&&a>c)return 1;var h=t.comparePoint(e.leftSE.point);if(0!==h)return h;var d=e.comparePoint(t.rightSE.point);return d<0?1:d>0?-1:1}if(a<s)return-1;if(a>s)return 1;if(i<o){var p=t.comparePoint(e.rightSE.point);if(0!==p)return p}if(i>o){var v=e.comparePoint(t.rightSE.point);if(v<0)return 1;if(v>0)return-1}if(i!==o){var m=u-a,g=i-n,_=c-s,y=o-r;if(m>g&&_<y)return 1;if(m<g&&_>y)return-1}return i>o?1:i<o||u<c?-1:u>c?1:e.id<t.id?-1:e.id>t.id?1:0}},{key:"fromRing",value:function(t,n,r){var i,o,a,s=VA.comparePoints(t,n);if(s<0)i=t,o=n,a=1;else{if(!(s>0))throw new Error("Tried to create degenerate segment at [".concat(t.x,", ").concat(t.y,"]"));i=n,o=t,a=-1}return new e(new VA(i,!0),new VA(o,!1),[r],[a])}}])}(),WA=function(){return c((function e(t,n,r){if(f(this,e),!Array.isArray(t)||0===t.length)throw new Error("Input geometry is not a valid Polygon or MultiPolygon");if(this.poly=n,this.isExterior=r,this.segments=[],"number"!=typeof t[0][0]||"number"!=typeof t[0][1])throw new Error("Input geometry is not a valid Polygon or MultiPolygon");var i=PA.round(t[0][0],t[0][1]);this.bbox={ll:{x:i.x,y:i.y},ur:{x:i.x,y:i.y}};for(var o=i,a=1,s=t.length;a<s;a++){if("number"!=typeof t[a][0]||"number"!=typeof t[a][1])throw new Error("Input geometry is not a valid Polygon or MultiPolygon");var u=PA.round(t[a][0],t[a][1]);u.x===o.x&&u.y===o.y||(this.segments.push(XA.fromRing(o,u,this)),u.x<this.bbox.ll.x&&(this.bbox.ll.x=u.x),u.y<this.bbox.ll.y&&(this.bbox.ll.y=u.y),u.x>this.bbox.ur.x&&(this.bbox.ur.x=u.x),u.y>this.bbox.ur.y&&(this.bbox.ur.y=u.y),o=u)}i.x===o.x&&i.y===o.y||this.segments.push(XA.fromRing(o,i,this))}),[{key:"getSweepEvents",value:function(){for(var e=[],t=0,n=this.segments.length;t<n;t++){var r=this.segments[t];e.push(r.leftSE),e.push(r.rightSE)}return e}}])}(),YA=function(){return c((function e(t,n){if(f(this,e),!Array.isArray(t))throw new Error("Input geometry is not a valid Polygon or MultiPolygon");this.exteriorRing=new WA(t[0],this,!0),this.bbox={ll:{x:this.exteriorRing.bbox.ll.x,y:this.exteriorRing.bbox.ll.y},ur:{x:this.exteriorRing.bbox.ur.x,y:this.exteriorRing.bbox.ur.y}},this.interiorRings=[];for(var r=1,i=t.length;r<i;r++){var o=new WA(t[r],this,!1);o.bbox.ll.x<this.bbox.ll.x&&(this.bbox.ll.x=o.bbox.ll.x),o.bbox.ll.y<this.bbox.ll.y&&(this.bbox.ll.y=o.bbox.ll.y),o.bbox.ur.x>this.bbox.ur.x&&(this.bbox.ur.x=o.bbox.ur.x),o.bbox.ur.y>this.bbox.ur.y&&(this.bbox.ur.y=o.bbox.ur.y),this.interiorRings.push(o)}this.multiPoly=n}),[{key:"getSweepEvents",value:function(){for(var e=this.exteriorRing.getSweepEvents(),t=0,n=this.interiorRings.length;t<n;t++)for(var r=this.interiorRings[t].getSweepEvents(),i=0,o=r.length;i<o;i++)e.push(r[i]);return e}}])}(),ZA=function(){return c((function e(t,n){if(f(this,e),!Array.isArray(t))throw new Error("Input geometry is not a valid Polygon or MultiPolygon");try{"number"==typeof t[0][0][0]&&(t=[t])}catch(a){}this.polys=[],this.bbox={ll:{x:Number.POSITIVE_INFINITY,y:Number.POSITIVE_INFINITY},ur:{x:Number.NEGATIVE_INFINITY,y:Number.NEGATIVE_INFINITY}};for(var r=0,i=t.length;r<i;r++){var o=new YA(t[r],this);o.bbox.ll.x<this.bbox.ll.x&&(this.bbox.ll.x=o.bbox.ll.x),o.bbox.ll.y<this.bbox.ll.y&&(this.bbox.ll.y=o.bbox.ll.y),o.bbox.ur.x>this.bbox.ur.x&&(this.bbox.ur.x=o.bbox.ur.x),o.bbox.ur.y>this.bbox.ur.y&&(this.bbox.ur.y=o.bbox.ur.y),this.polys.push(o)}this.isSubject=n}),[{key:"getSweepEvents",value:function(){for(var e=[],t=0,n=this.polys.length;t<n;t++)for(var r=this.polys[t].getSweepEvents(),i=0,o=r.length;i<o;i++)e.push(r[i]);return e}}])}(),qA=function(){function e(t){f(this,e),this.events=t;for(var n=0,r=t.length;n<r;n++)t[n].segment.ringOut=this;this.poly=null}return c(e,[{key:"getGeom",value:function(){for(var e=this.events[0].point,t=[e],n=1,r=this.events.length-1;n<r;n++){var i=this.events[n].point,o=this.events[n+1].point;0!==BA(i,e,o)&&(t.push(i),e=i)}if(1===t.length)return null;var a=t[0],s=t[1];0===BA(a,e,s)&&t.shift(),t.push(t[0]);for(var u=this.isExteriorRing()?1:-1,c=this.isExteriorRing()?0:t.length-1,l=this.isExteriorRing()?t.length:-1,f=[],h=c;h!=l;h+=u)f.push([t[h].x,t[h].y]);return f}},{key:"isExteriorRing",value:function(){if(void 0===this._isExteriorRing){var e=this.enclosingRing();this._isExteriorRing=!e||!e.isExteriorRing()}return this._isExteriorRing}},{key:"enclosingRing",value:function(){return void 0===this._enclosingRing&&(this._enclosingRing=this._calcEnclosingRing()),this._enclosingRing}},{key:"_calcEnclosingRing",value:function(){for(var e=this.events[0],t=1,n=this.events.length;t<n;t++){var r=this.events[t];VA.compare(e,r)>0&&(e=r)}for(var i=e.segment.prevInResult(),o=i?i.prevInResult():null;;){if(!i)return null;if(!o)return i.ringOut;if(o.ringOut!==i.ringOut)return o.ringOut.enclosingRing()!==i.ringOut?i.ringOut:i.ringOut.enclosingRing();i=o.prevInResult(),o=i?i.prevInResult():null}}}],[{key:"factory",value:function(t){for(var n=[],r=0,i=t.length;r<i;r++){var o=t[r];if(o.isInResult()&&!o.ringOut){for(var a=null,s=o.leftSE,u=o.rightSE,c=[s],l=s.point,f=[];a=s,s=u,c.push(s),s.point!==l;)for(;;){var h=s.getAvailableLinkedEvents();if(0===h.length){var d=c[0].point,p=c[c.length-1].point;throw new Error("Unable to complete output ring starting at [".concat(d.x,",")+" ".concat(d.y,"]. Last matching segment found ends at")+" [".concat(p.x,", ").concat(p.y,"]."))}if(1===h.length){u=h[0].otherSE;break}for(var v=null,m=0,g=f.length;m<g;m++)if(f[m].point===s.point){v=m;break}if(null===v){f.push({index:c.length,point:s.point});var _=s.getLeftmostComparator(a);u=h.sort(_)[0].otherSE;break}var y=f.splice(v)[0],E=c.splice(y.index);E.unshift(E[0].otherSE),n.push(new e(E.reverse()))}n.push(new e(c))}}return n}}])}(),KA=function(){return c((function e(t){f(this,e),this.exteriorRing=t,t.poly=this,this.interiorRings=[]}),[{key:"addInterior",value:function(e){this.interiorRings.push(e),e.poly=this}},{key:"getGeom",value:function(){var e=[this.exteriorRing.getGeom()];if(null===e[0])return null;for(var t=0,n=this.interiorRings.length;t<n;t++){var r=this.interiorRings[t].getGeom();null!==r&&e.push(r)}return e}}])}(),QA=function(){return c((function e(t){f(this,e),this.rings=t,this.polys=this._composePolys(t)}),[{key:"getGeom",value:function(){for(var e=[],t=0,n=this.polys.length;t<n;t++){var r=this.polys[t].getGeom();null!==r&&e.push(r)}return e}},{key:"_composePolys",value:function(e){for(var t=[],n=0,r=e.length;n<r;n++){var i=e[n];if(!i.poly)if(i.isExteriorRing())t.push(new KA(i));else{var o=i.enclosingRing();o.poly||t.push(new KA(o)),o.poly.addInterior(i)}}return t}}])}(),$A=function(){return c((function e(t){f(this,e);var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:XA.compare;this.queue=t,this.tree=new SA(n),this.segments=[]}),[{key:"process",value:function(e){var t=e.segment,n=[];if(e.consumedBy)return e.isLeft?this.queue.remove(e.otherSE):this.tree.remove(t),n;var r=e.isLeft?this.tree.add(t):this.tree.find(t);if(!r)throw new Error("Unable to find segment #".concat(t.id," ")+"[".concat(t.leftSE.point.x,", ").concat(t.leftSE.point.y,"] -> ")+"[".concat(t.rightSE.point.x,", ").concat(t.rightSE.point.y,"] ")+"in SweepLine tree.");for(var i=r,o=r,a=void 0,s=void 0;void 0===a;)null===(i=this.tree.prev(i))?a=null:void 0===i.key.consumedBy&&(a=i.key);for(;void 0===s;)null===(o=this.tree.next(o))?s=null:void 0===o.key.consumedBy&&(s=o.key);if(e.isLeft){var u=null;if(a){var c=a.getIntersection(t);if(null!==c&&(t.isAnEndpoint(c)||(u=c),!a.isAnEndpoint(c)))for(var l=this._splitSafely(a,c),f=0,h=l.length;f<h;f++)n.push(l[f])}var d=null;if(s){var p=s.getIntersection(t);if(null!==p&&(t.isAnEndpoint(p)||(d=p),!s.isAnEndpoint(p)))for(var v=this._splitSafely(s,p),m=0,g=v.length;m<g;m++)n.push(v[m])}if(null!==u||null!==d){var _=null;if(null===u)_=d;else if(null===d)_=u;else{_=VA.comparePoints(u,d)<=0?u:d}this.queue.remove(t.rightSE),n.push(t.rightSE);for(var y=t.split(_),E=0,b=y.length;E<b;E++)n.push(y[E])}n.length>0?(this.tree.remove(t),n.push(e)):(this.segments.push(t),t.prev=a)}else{if(a&&s){var A=a.getIntersection(s);if(null!==A){if(!a.isAnEndpoint(A))for(var x=this._splitSafely(a,A),S=0,T=x.length;S<T;S++)n.push(x[S]);if(!s.isAnEndpoint(A))for(var R=this._splitSafely(s,A),C=0,M=R.length;C<M;C++)n.push(R[C])}}this.tree.remove(t)}return n}},{key:"_splitSafely",value:function(e,t){this.tree.remove(e);var n=e.rightSE;this.queue.remove(n);var r=e.split(t);return r.push(n),void 0===e.consumedBy&&this.tree.add(e),r}}])}(),JA="undefined"!=typeof process&&{}.POLYGON_CLIPPING_MAX_QUEUE_SIZE||1e6,ex="undefined"!=typeof process&&{}.POLYGON_CLIPPING_MAX_SWEEPLINE_SEGMENTS||1e6,tx=new(function(){return c((function e(){f(this,e)}),[{key:"run",value:function(e,t,n){tx.type=e,PA.reset();for(var r=[new ZA(t,!0)],i=0,o=n.length;i<o;i++)r.push(new ZA(n[i],!1));if(tx.numMultiPolys=r.length,"difference"===tx.type)for(var a=r[0],s=1;s<r.length;)null!==wA(r[s].bbox,a.bbox)?s++:r.splice(s,1);if("intersection"===tx.type)for(var u=0,c=r.length;u<c;u++)for(var l=r[u],f=u+1,h=r.length;f<h;f++)if(null===wA(l.bbox,r[f].bbox))return[];for(var d=new SA(VA.compare),p=0,v=r.length;p<v;p++)for(var m=r[p].getSweepEvents(),g=0,_=m.length;g<_;g++)if(d.insert(m[g]),d.size>JA)throw new Error("Infinite loop when putting segment endpoints in a priority queue (queue size too big).");for(var y=new $A(d),E=d.size,b=d.pop();b;){var A=b.key;if(d.size===E){var x=A.segment;throw new Error("Unable to pop() ".concat(A.isLeft?"left":"right"," SweepEvent ")+"[".concat(A.point.x,", ").concat(A.point.y,"] from segment #").concat(x.id," ")+"[".concat(x.leftSE.point.x,", ").concat(x.leftSE.point.y,"] -> ")+"[".concat(x.rightSE.point.x,", ").concat(x.rightSE.point.y,"] from queue."))}if(d.size>JA)throw new Error("Infinite loop when passing sweep line over endpoints (queue size too big).");if(y.segments.length>ex)throw new Error("Infinite loop when passing sweep line over endpoints (too many sweep line segments).");for(var S=y.process(A),T=0,R=S.length;T<R;T++){var C=S[T];void 0===C.consumedBy&&d.insert(C)}E=d.size,b=d.pop()}PA.reset();var M=qA.factory(y.segments);return new QA(M).getGeom()}}])}()),nx=function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),r=1;r<t;r++)n[r-1]=arguments[r];return tx.run("union",e,n)};function rx(e,t,n){void 0===n&&(n={});var r=He(e),i=He(t),o=nx(r.coordinates,i.coordinates);return 0===o.length?null:1===o.length?ze(o[0],n.properties):function(e,t,n){return void 0===n&&(n={}),Ge({type:"MultiPolygon",coordinates:e},t,n)}(o,n.properties)}var ix=function(){return c((function e(){f(this,e)}),[{key:"getCombineFeature",value:function(e){var t=null,n=e[0];return e.map((function(e){var n=ze(e.coordinates);t=null===t?n:rx(t,n)})),n&&(t.properties=re({},n)),t}}])}(),ox="select",ax="active",sx=function(){return c((function e(t){var n=t.layerService,r=t.tileLayerService,i=t.parent;f(this,e),ne(this,"layerService",void 0),ne(this,"tileLayerService",void 0),ne(this,"tileSourceService",void 0),ne(this,"parent",void 0),ne(this,"tilePickID",new Map),this.layerService=n,this.tileLayerService=r,this.parent=i,this.tileSourceService=new ix}),[{key:"pickRender",value:function(e){var t=this.tileLayerService.getVisibleTileBylngLat(e.lngLat);if(t){var n=t.getMainLayer();null==n||n.layerPickService.pickRender(e)}}},{key:"pick",value:function(e,t){var n=this;return ie(i().mark((function r(){var o,a,s,u;return i().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(o=n.parent.getContainer(),a=o.pickingService,"RasterLayer"!==e.type){r.next=8;break}if(!(s=n.tileLayerService.getVisibleTileBylngLat(t.lngLat))||void 0===s.getMainLayer()){r.next=7;break}return u=s.getMainLayer(),r.abrupt("return",u.layerPickService.pickRasterLayer(u,t,n.parent));case 7:return r.abrupt("return",!1);case 8:return n.pickRender(t),r.abrupt("return",a.pickFromPickingFBO(e,t));case 10:case"end":return r.stop()}}),r)})))()}},{key:"selectFeature",value:function(e){var t=a(e,3),n=t[0],r=t[1],i=t[2],o=this.color2PickId(n,r,i);this.tilePickID.set(ox,o),this.updateHighLight(n,r,i,ox)}},{key:"highlightPickedFeature",value:function(e){var t=a(e,3),n=t[0],r=t[1],i=t[2],o=this.color2PickId(n,r,i);this.tilePickID.set(ax,o),this.updateHighLight(n,r,i,ax)}},{key:"updateHighLight",value:function(e,t,n,r){this.tileLayerService.tiles.map((function(i){var o=i.getMainLayer();switch(r){case ox:null==o||o.hooks.beforeSelect.call([e,t,n]);break;case ax:null==o||o.hooks.beforeHighlight.call([e,t,n])}}))}},{key:"setPickState",value:function(){var e=this.tilePickID.get(ox),t=this.tilePickID.get(ax);if(e){var n=a(this.pickId2Color(e),3),r=n[0],i=n[1],o=n[2];this.updateHighLight(r,i,o,ox)}else if(t){var s=a(this.pickId2Color(t),3),u=s[0],c=s[1],l=s[2];this.updateHighLight(u,c,l,ax)}else;}},{key:"color2PickId",value:function(e,t,n){return Xt(new Uint8Array([e,t,n]))}},{key:"pickId2Color",value:function(e){return Wt(e)}},{key:"getFeatureById",value:function(e){var t=this.tileLayerService.getTiles().filter((function(e){return e.visible})),n=[];return t.forEach((function(t){n.push.apply(n,r(t.getFeatureById(e)))})),n}},{key:"pickRasterLayer",value:function(){return!1}}])}();var ux=function(e){function t(e,n){var r;return f(this,t),r=h(this,t),ne(r,"x",void 0),ne(r,"y",void 0),ne(r,"z",void 0),ne(r,"key",void 0),ne(r,"parent",void 0),ne(r,"sourceTile",void 0),ne(r,"visible",!0),ne(r,"layers",[]),ne(r,"isLoaded",!1),ne(r,"tileMaskLayers",[]),ne(r,"tileMask",void 0),r.parent=n,r.sourceTile=e,r.x=e.x,r.y=e.y,r.z=e.z,r.key="".concat(r.x,"_").concat(r.y,"_").concat(r.z),r}return d(t,e),c(t,[{key:"getLayers",value:function(){return this.layers}},{key:"styleUpdate",value:function(){}},{key:"lnglatInBounds",value:function(e){var t=a(this.sourceTile.bounds,4),n=t[0],r=t[1],i=t[2],o=t[3],s=e.lng,u=e.lat;return s>=n&&s<=i&&u>=r&&u<=o}},{key:"getLayerOptions",value:function(){var e,t,n=this.parent.getLayerConfig();return re(re({},n),{},{textAllowOverlap:!0,autoFit:!1,maskLayers:this.getMaskLayer(),tileMask:(t=this.parent.type,-1!==["PolygonLayer","LineLayer"].indexOf(t)),mask:n.mask||0!==(null===(e=n.maskLayers)||void 0===e?void 0:e.length)&&n.enableMask})}},{key:"getMaskLayer",value:function(){var e=this,t=this.parent.getLayerConfig().maskLayers,n=[];return null==t||t.forEach((function(t){if(!t.tileLayer)return n.push(t),t;var r=t.tileLayer.getTile(e.sourceTile.key),i=null==r?void 0:r.getLayers()[0];i&&n.push(i)})),n}},{key:"addTileMask",value:function(){var e=this;return ie(i().mark((function t(){var n,r,o;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=new uA({name:"mask",visible:!0,enablePicking:!1}).source({type:"FeatureCollection",features:[e.sourceTile.bboxPolygon]},{parser:{type:"geojson",featureId:"id"}}).shape("fill").color("#0f0").style({opacity:.5}),r=Hh(e.parent.container),n.setContainer(r),t.next=5,n.init();case 5:return e.tileMask=n,void 0!==(o=e.getMainLayer())&&(o.tileMask=n),t.abrupt("return",n);case 9:case"end":return t.stop()}}),t)})))()}},{key:"addMask",value:function(e,t){var n=this;return ie(i().mark((function r(){var o;return i().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:return o=Hh(n.parent.container),t.setContainer(o),r.next=4,t.init();case 4:e.addMask(t),n.tileMaskLayers.push(t);case 6:case"end":return r.stop()}}),r)})))()}},{key:"addLayer",value:function(e){var t=this;return ie(i().mark((function n(){var r;return i().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return e.isTileLayer=!0,r=Hh(t.parent.container),e.setContainer(r),t.layers.push(e),n.next=6,e.init();case 6:case"end":return n.stop()}}),n)})))()}},{key:"updateVisible",value:function(e){this.visible=e,this.updateOptions("visible",e)}},{key:"updateOptions",value:function(e,t){this.layers.forEach((function(n){n.updateLayerConfig(o({},e,t))}))}},{key:"getMainLayer",value:function(){return this.layers[0]}},{key:"getFeatures",value:function(e){return[]}},{key:"getFeatureById",value:function(e){return[]}},{key:"destroy",value:function(){var e;null===(e=this.tileMask)||void 0===e||e.destroy(),this.layers.forEach((function(e){return e.destroy()}))}}])}(lo.exports.EventEmitter),cx=function(e){function t(){return f(this,t),h(this,t,arguments)}return d(t,e),c(t,[{key:"initTileLayer",value:function(){var e=this;return ie(i().mark((function t(){var n,r,o,a;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.getSourceOption(),r=n.data.features[0].properties,o=(new Mb).source(n.data,n.options).size(1).shape("line").color("red"),a=new Jb({minZoom:e.z-1,maxZoom:e.z+1,textAllowOverlap:!0}).source([r],{parser:{type:"json",x:"x",y:"y"}}).size(20).color("red").shape(e.key).style({stroke:"#fff",strokeWidth:2}),t.next=6,e.addLayer(o);case 6:return t.next=8,e.addLayer(a);case 8:e.isLoaded=!0;case 9:case"end":return t.stop()}}),t)})))()}},{key:"getSourceOption",value:function(){var e=this.parent.getSource();return{data:{type:"FeatureCollection",features:this.sourceTile.data.layers.testTile.features},options:{parser:{type:"geojson"},transforms:e.transforms}}}}])}(ux),lx=function(e){function t(){return f(this,t),h(this,t,arguments)}return d(t,e),c(t,[{key:"initTileLayer",value:function(){var e=this;return ie(i().mark((function t(){var n,r,o,a;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.parent.getLayerAttributeConfig(),r=e.getLayerOptions(),o=e.getSourceOption(),a=new fb(re({},r)).source(o.data,o.options),n&&Object.keys(n).forEach((function(e){var t,r,i=e;a[i](null===(t=n[i])||void 0===t?void 0:t.field,null===(r=n[i])||void 0===r?void 0:r.values)})),t.next=7,e.addLayer(a);case 7:e.isLoaded=!0;case 8:case"end":return t.stop()}}),t)})))()}},{key:"getSourceOption",value:function(){var e=this.parent.getSource();return{data:this.sourceTile.data,options:{parser:{type:"image",extent:this.sourceTile.bounds},transforms:e.transforms}}}}])}(ux),fx=function(e){function t(){return f(this,t),h(this,t,arguments)}return d(t,e),c(t,[{key:"getUninforms",value:function(){var e=this.getCommonUniformsInfo(),t=this.getUniformsBufferInfo(this.getStyleAttribute());return this.updateStyleUnifoms(),re(re({},e.uniformsOption),t.uniformsOption)}},{key:"getCommonUniformsInfo",value:function(){var e=this.layer.getLayerConfig(),t=e.opacity,n=void 0===t?1:t,r=e.color,i={u_color:Ht(void 0===r?"#000":r),u_opacity:n||1};return this.getUniformsBufferInfo(i)}},{key:"initModels",value:function(){var e=this;return ie(i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",e.buildModels());case 1:case"end":return t.stop()}}),t)})))()}},{key:"buildModels",value:function(){var e=this;return ie(i().mark((function t(){var n;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e.initUniformsBuffer(),t.next=3,e.layer.buildLayerModel({moduleName:"mask",vertexShader:'layout(location = 0) in vec3 a_Position;\n\nlayout(std140) uniform commonUniorm {\n  vec4 u_color;\n  float u_opacity;\n};\n\n#pragma include "projection"\n\nvoid main() {\n  vec4 project_pos = project_position(vec4(a_Position, 1.0));\n\n  if(u_CoordinateSystem == COORDINATE_SYSTEM_P20_2) { // gaode2.x\n    gl_Position = u_Mvp * (vec4(project_pos.xyz, 1.0));\n  } else {\n    gl_Position = project_common_position_to_clipspace(vec4(project_pos.xyz, 1.0));\n  }\n}\n\n',fragmentShader:"layout(std140) uniform commonUniorm {\n  vec4 u_color;\n  float u_opacity;\n};\n\nout vec4 outputColor;\n\nvoid main() {\n  outputColor = u_color;\n  outputColor.a *= u_opacity;\n}\n",triangulation:rb,depth:{enable:!1},pick:!1});case 3:return n=t.sent,t.abrupt("return",[n]);case 5:case"end":return t.stop()}}),t)})))()}},{key:"clearModels",value:function(){(!(arguments.length>0&&void 0!==arguments[0])||arguments[0])&&this.layerService.clear()}},{key:"registerBuiltinAttributes",value:function(){return""}}])}(qy),hx={fill:fx},dx=function(e){function t(){var e;f(this,t);for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];return e=h(this,t,[].concat(r)),ne(e,"type","MaskLayer"),e}return d(t,e),c(t,[{key:"buildModels",value:function(){var e=this;return ie(i().mark((function t(){var n;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.getModelType(),e.layerModel=new hx[n](e),t.next=4,e.initLayerModels();case 4:case"end":return t.stop()}}),t)})))()}},{key:"getModelType",value:function(){return"fill"}}])}(Vy),px=function(e){function t(){return f(this,t),h(this,t,arguments)}return d(t,e),c(t,[{key:"initTileLayer",value:function(){var e=this;return ie(i().mark((function t(){var n,r,o,a;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.parent.getLayerAttributeConfig(),r=e.getLayerOptions(),o=e.getSourceOption(),a=new dx(re({},r)).source(o.data,o.options),n&&Object.keys(n).forEach((function(e){var t,r,i=e;a[i](null===(t=n[i])||void 0===t?void 0:t.field,null===(r=n[i])||void 0===r?void 0:r.values)})),t.next=7,e.addLayer(a);case 7:e.isLoaded=!0;case 8:case"end":return t.stop()}}),t)})))()}},{key:"getFeatures",value:function(e){return e?this.sourceTile.data.getTileData(e):[]}},{key:"getSourceOption",value:function(){var e=this.parent.getSource(),t=this.parent.getLayerConfig(),n=t.sourceLayer,r=t.featureId;return{data:{type:"FeatureCollection",features:this.getFeatures(n)},options:{parser:{type:"geojson",featureId:r},transforms:e.transforms}}}}])}(ux),vx=["rasterData"],mx=function(e){function t(){return f(this,t),h(this,t,arguments)}return d(t,e),c(t,[{key:"initTileLayer",value:function(){var e=this;return ie(i().mark((function t(){var n,r,o,a;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.parent.getLayerAttributeConfig(),r=e.getLayerOptions(),o=e.getSourceOption(),a=new vA(re({},r)).source(o.data,o.options),n&&Object.keys(n).forEach((function(e){var t,r,i=e;a[i](null===(t=n[i])||void 0===t?void 0:t.field,null===(r=n[i])||void 0===r?void 0:r.values)})),t.next=7,e.addLayer(a);case 7:e.isLoaded=!0;case 8:case"end":return t.stop()}}),t)})))()}},{key:"getSourceOption",value:function(){var e=this.parent.getSource(),t=this.sourceTile.data.data,n=t.rasterData,r=oe(t,vx);return{data:n,options:{parser:re({type:"rasterRgb",extent:this.sourceTile.bounds},r),transforms:e.transforms}}}}])}(ux),gx=function(e){function t(){return f(this,t),h(this,t,arguments)}return d(t,e),c(t,[{key:"initTileLayer",value:function(){var e=this;return ie(i().mark((function t(){var n,r,o,a;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.parent.getLayerAttributeConfig(),r=e.getLayerOptions(),o=e.getSourceOption(),a=new vA(re({},r)).source(o.data,o.options),n&&Object.keys(n).forEach((function(e){var t,r,i=e;a[i](null===(t=n[i])||void 0===t?void 0:t.field,null===(r=n[i])||void 0===r?void 0:r.values)})),t.next=7,e.addLayer(a);case 7:e.isLoaded=!0;case 8:case"end":return t.stop()}}),t)})))()}},{key:"getSourceOption",value:function(){var e=this.parent.getSource();return{data:this.sourceTile.data,options:{parser:{type:"image",extent:this.sourceTile.bounds},transforms:e.transforms}}}}])}(ux),_x=["rasterData"],yx={positions:[0,1],colors:["#000","#fff"]},Ex=function(e){function t(){var e;f(this,t);for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];return e=h(this,t,[].concat(r)),ne(e,"colorTexture",void 0),e}return d(t,e),c(t,[{key:"initTileLayer",value:function(){var e=this;return ie(i().mark((function t(){var n,r,o,a,s,u,c;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.parent.getLayerAttributeConfig(),r=e.getLayerOptions(),o=e.getSourceOption(),a=e.getLayerOptions(),s=a.rampColors,u=a.domain,e.colorTexture=e.parent.textureService.getColorTexture(s,u),c=new vA(re(re({},r),{},{colorTexture:e.colorTexture})).source(o.data,o.options),n&&Object.keys(n).forEach((function(e){var t,r,i=e;c[i](null===(t=n[i])||void 0===t?void 0:t.field,null===(r=n[i])||void 0===r?void 0:r.values)})),t.next=9,e.addLayer(c);case 9:e.isLoaded=!0;case 10:case"end":return t.stop()}}),t)})))()}},{key:"getSourceOption",value:function(){var e=this.parent.getSource(),t=this.sourceTile.data.data,n=t.rasterData,r=oe(t,_x);return{data:n,options:{parser:re({type:"raster",extent:this.sourceTile.bounds},r),transforms:e.transforms}}}},{key:"styleUpdate",value:function(){for(var e=this,t=arguments.length,n=new Array(t),r=0;r<t;r++)n[r]=arguments[r];var i=n.rampColors,o=void 0===i?yx:i,a=n.domain;this.colorTexture=this.parent.textureService.getColorTexture(o,a||Zt(o)),this.layers.forEach((function(t){return t.style({colorTexture:e.colorTexture})}))}},{key:"destroy",value:function(){this.layers.forEach((function(e){return e.destroy()}))}}])}(ux),bx=function(e){function t(){return f(this,t),h(this,t,arguments)}return d(t,e),c(t,[{key:"initTileLayer",value:function(){var e=this;return ie(i().mark((function t(){var n,r,o,a,s;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=e.parent.getLayerAttributeConfig(),r=e.getLayerOptions(),i=e.parent.type,o="PolygonLayer"===i?uA:"LineLayer"===i?Mb:Jb,a=e.getSourceOption()){t.next=8;break}return e.isLoaded=!0,e.emit("loaded"),t.abrupt("return");case 8:return s=new o(re({},r)).source(a.data,a.options),Object.keys(n).forEach((function(e){var t,r,i=e;s[i](null===(t=n[i])||void 0===t?void 0:t.field,null===(r=n[i])||void 0===r?void 0:r.values)})),t.next=12,e.addLayer(s);case 12:if(!r.tileMask){t.next=15;break}return t.next=15,e.addTileMask();case 15:e.setLayerMinMaxZoom(s),e.isLoaded=!0,e.emit("loaded");case 18:case"end":return t.stop()}var i}),t)})))()}},{key:"getSourceOption",value:function(){var e=this.parent.getSource(),t=this.parent.getLayerConfig(),n=t.sourceLayer,r=void 0===n?"defaultLayer":n,i=t.featureId,o=void 0===i?"id":i;return{data:{type:"FeatureCollection",features:this.getFeatures(r)},options:{parser:{type:"geojson",featureId:o},transforms:e.transforms}}}},{key:"setLayerMinMaxZoom",value:function(e){"text"===e.getModelType()&&e.updateLayerConfig({maxZoom:this.z+1,minZoom:this.z-1})}},{key:"getFeatures",value:function(e){return this.sourceTile.data.getTileData(e)}},{key:"getFeatureById",value:function(e){var t=this.getMainLayer();return t?t.getSource().data.dataArray.filter((function(t){return t._id===e})):[]}}])}(ux);function Ax(e){switch(e.type){case"PolygonLayer":case"LineLayer":case"PointLayer":return bx;case"TileDebugLayer":return cx;case"MaskLayer":return px;case"RasterLayer":switch(e.getSource().parser.dataType){case Wh.RGB:case Wh.CUSTOMRGB:return mx;case Wh.ARRAYBUFFER:case Wh.CUSTOMARRAYBUFFER:return Ex;case Wh.TERRAINRGB:case Wh.CUSTOMTERRAINRGB:return gx;default:return lx}default:return bx}}var xx=["shape","color","size","style","animate","filter","rotate","scale","setBlend","setSelect","setActive","disableMask","enableMask","addMask","removeMask"],Sx=Ni.debounce,Tx=function(){return c((function e(t){var n=this;f(this,e),ne(this,"parent",void 0),ne(this,"tileLayerService",void 0),ne(this,"mapService",void 0),ne(this,"layerService",void 0),ne(this,"rendererService",void 0),ne(this,"pickingService",void 0),ne(this,"tilePickService",void 0),ne(this,"tilesetManager",void 0),ne(this,"initedTileset",!1),ne(this,"lastViewStates",void 0),ne(this,"mapchange",(function(){var e;if(!1!==n.parent.isVisible()){var t=n.getCurrentView(),r=t.latLonBounds,i=t.zoom;if("GAODE1.x"===n.mapService.version){var o=n.parent.getLayerConfig().visible;i<2&&o?(n.parent.updateLayerConfig({visible:!1}),n.layerService.reRender()):i>=2&&!o&&(n.parent.updateLayerConfig({visible:!0}),n.layerService.reRender())}n.lastViewStates&&n.lastViewStates.zoom===i&&n.lastViewStates.latLonBounds.toString()===r.toString()||(n.lastViewStates={zoom:i,latLonBounds:r},null===(e=n.tilesetManager)||void 0===e||e.throttleUpdate(i,r))}})),ne(this,"viewchange",Sx(this.mapchange,24)),this.parent=t;var r=this.parent.getContainer();this.rendererService=r.rendererService,this.layerService=r.layerService,this.mapService=r.mapService,this.pickingService=r.pickingService,this.tileLayerService=new mA({rendererService:this.rendererService,layerService:this.layerService,parent:t}),this.tilePickService=new sx({tileLayerService:this.tileLayerService,layerService:this.layerService,parent:t}),this.parent.setLayerPickService(this.tilePickService),this.proxy(t),this.initTileSetManager()}),[{key:"initTileSetManager",value:function(){var e,t=this.parent.getSource();if(this.tilesetManager=t.tileset,this.initedTileset||(this.bindTilesetEvent(),this.initedTileset=!0),!1!==this.parent.isVisible()){var n=this.getCurrentView(),r=n.latLonBounds,i=n.zoom;null===(e=this.tilesetManager)||void 0===e||e.update(i,r)}}},{key:"getCurrentView",value:function(){var e=this.mapService.getBounds();return{latLonBounds:[e[0][0],e[0][1],e[1][0],e[1][1]],zoom:this.mapService.getZoom()}}},{key:"bindTilesetEvent",value:function(){var e=this;this.tilesetManager.on("tile-loaded",(function(e){})),this.tilesetManager.on("tile-unload",(function(t){e.tileUnLoad(t)})),this.tilesetManager.on("tile-error",(function(t,n){e.tileError(t)})),this.tilesetManager.on("tile-update",(function(){e.tileUpdate()})),this.mapService.on("zoomend",this.mapchange),this.mapService.on("moveend",this.viewchange)}},{key:"render",value:function(){this.tileLayerService.render()}},{key:"getLayers",value:function(){return this.tileLayerService.getLayers()}},{key:"getTiles",value:function(){return this.tileLayerService.getTiles()}},{key:"getTile",value:function(e){return this.tileLayerService.getTile(e)}},{key:"tileLoaded",value:function(e){}},{key:"tileError",value:function(e){console.warn("error:",e)}},{key:"destroy",value:function(){var e;this.mapService.off("zoomend",this.mapchange),this.mapService.off("moveend",this.viewchange),null===(e=this.tilesetManager)||void 0===e||e.destroy(),this.tileLayerService.destroy()}},{key:"reload",value:function(){var e;this.tilesetManager.clear();var t=this.getCurrentView(),n=t.latLonBounds,r=t.zoom;null===(e=this.tilesetManager)||void 0===e||e.update(r,n)}},{key:"tileUnLoad",value:function(e){this.tileLayerService.removeTile(e.key)}},{key:"tileUpdate",value:function(){var e=this;return ie(i().mark((function t(){var n,r,o;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e.tilesetManager){t.next=2;break}return t.abrupt("return");case 2:return n=e.parent.getMinZoom(),r=e.parent.getMaxZoom(),o=e.tilesetManager.tiles.filter((function(e){return e.isLoaded})).filter((function(e){return e.isVisibleChange})).filter((function(e){return e.data})).filter((function(e){return e.z>=n&&e.z<r})),t.next=7,Promise.all(o.map(function(){var t=ie(i().mark((function t(n){var r,o;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(e.tileLayerService.hasTile(n.key)){t.next=9;break}return r=Ax(e.parent),o=new r(n,e.parent),t.next=5,o.initTileLayer();case 5:e.tilePickService.setPickState(),0!==o.getLayers().length&&(e.tileLayerService.addTile(o),e.tileLayerService.updateTileVisible(n),e.layerService.reRender()),t.next=12;break;case 9:e.tileLayerService.updateTileVisible(n),e.tilePickService.setPickState(),e.layerService.reRender();case 12:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()));case 7:e.tilesetManager.isLoaded&&e.parent.emit("tiles-loaded",e.tilesetManager.currentTiles);case 8:case"end":return t.stop()}}),t)})))()}},{key:"setPickState",value:function(e){}},{key:"pickRender",value:function(e){this.tilePickService.pickRender(e)}},{key:"selectFeature",value:function(e){this.tilePickService.selectFeature(e)}},{key:"highlightPickedFeature",value:function(e){this.tilePickService.highlightPickedFeature(e)}},{key:"proxy",value:function(e){var t=this;xx.forEach((function(n){var r=e[n].bind(e);e[n]=function(){for(var i=arguments.length,o=new Array(i),a=0;a<i;a++)o[a]=arguments[a];return r.apply(void 0,o),t.getLayers().map((function(e){e[n].apply(e,o)})),"style"===n&&t.getTiles().forEach((function(e){return e.styleUpdate.apply(e,o)})),e}}))}}])}();!function(e,t){var n="undefined"!=typeof my&&!!my&&"function"==typeof my.showToast&&!0!==my.isFRM,r="undefined"!=typeof wx&&null!==wx&&(void 0!==wx.request||void 0!==wx.miniProgram);if(!n&&!r&&(t||(t=document),t)){var i=t.head||t.getElementsByTagName("head")[0];if(!i){i=t.createElement("head");var o=t.body||t.getElementsByTagName("body")[0];o?o.parentNode.insertBefore(i,o):t.documentElement.appendChild(i)}var a=t.createElement("style");a.type="text/css",a.styleSheet?a.styleSheet.cssText=e:a.appendChild(t.createTextNode(e)),i.appendChild(a)}}(".l7-marker-container {\n  position: absolute;\n  width: 100%;\n  height: 100%;\n  overflow: hidden;\n}\n.l7-marker {\n  position: absolute !important;\n  top: 0;\n  left: 0;\n  z-index: 5;\n  cursor: pointer;\n}\n.l7-marker-cluster {\n  width: 40px;\n  height: 40px;\n  background-color: rgba(181, 226, 140, 0.6);\n  background-clip: padding-box;\n  border-radius: 20px;\n}\n.l7-marker-cluster div {\n  width: 30px;\n  height: 30px;\n  margin-top: 5px;\n  margin-left: 5px;\n  font:\n    12px 'Helvetica Neue',\n    Arial,\n    Helvetica,\n    sans-serif;\n  text-align: center;\n  background-color: rgba(110, 204, 57, 0.6);\n  border-radius: 15px;\n}\n.l7-marker-cluster span {\n  line-height: 30px;\n}\n.l7-touch .l7-control-attribution,\n.l7-touch .l7-control-layers,\n.l7-touch .l7-bar {\n  box-shadow: none;\n}\n.l7-touch .l7-control-layers,\n.l7-touch .l7-bar {\n  background-clip: padding-box;\n  border: 2px solid rgba(0, 0, 0, 0.2);\n}\n.mapboxgl-ctrl-logo,\n.amap-logo {\n  display: none !important;\n}\n.l7-select-box {\n  border: 3px dashed gray;\n  border-radius: 2px;\n  position: absolute;\n  z-index: 999;\n  box-sizing: border-box;\n}\n.l7-control-container {\n  font:\n    12px/1.5 'Helvetica Neue',\n    Arial,\n    Helvetica,\n    sans-serif;\n}\n.l7-control-container .l7-control {\n  position: relative;\n  z-index: 999;\n  float: left;\n  clear: both;\n  color: #595959;\n  font-size: 12px;\n  pointer-events: visiblePainted;\n  /* IE 9-10 doesn't have auto */\n  pointer-events: auto;\n}\n.l7-control-container .l7-control.l7-control--hide {\n  display: none;\n}\n.l7-control-container .l7-top {\n  top: 0;\n  display: flex;\n  position: absolute;\n  z-index: 999;\n  pointer-events: none;\n}\n.l7-control-container .l7-top .l7-control:not(.l7-control--hide) {\n  margin-top: 8px;\n}\n.l7-control-container .l7-right {\n  right: 0;\n  display: flex;\n  position: absolute;\n  z-index: 999;\n  pointer-events: none;\n}\n.l7-control-container .l7-right .l7-control:not(.l7-control--hide) {\n  margin-right: 8px;\n}\n.l7-control-container .l7-bottom {\n  bottom: 0;\n  display: flex;\n  position: absolute;\n  z-index: 999;\n  pointer-events: none;\n}\n.l7-control-container .l7-bottom .l7-control:not(.l7-control--hide) {\n  margin-bottom: 8px;\n}\n.l7-control-container .l7-left {\n  left: 0;\n  display: flex;\n  position: absolute;\n  z-index: 999;\n  pointer-events: none;\n}\n.l7-control-container .l7-left .l7-control:not(.l7-control--hide) {\n  margin-left: 8px;\n}\n.l7-control-container .l7-center {\n  position: absolute;\n  display: flex;\n  justify-content: center;\n}\n.l7-control-container .l7-center.l7-top,\n.l7-control-container .l7-center.l7-bottom {\n  width: 100%;\n}\n.l7-control-container .l7-center.l7-left,\n.l7-control-container .l7-center.l7-right {\n  height: 100%;\n}\n.l7-control-container .l7-center .l7-control {\n  margin-right: 8px;\n  margin-bottom: 8px;\n}\n.l7-control-container .l7-row {\n  flex-direction: row;\n}\n.l7-control-container .l7-row.l7-top {\n  align-items: flex-start;\n}\n.l7-control-container .l7-row.l7-bottom {\n  align-items: flex-end;\n}\n.l7-control-container .l7-column {\n  flex-direction: column;\n}\n.l7-control-container .l7-column.l7-left {\n  align-items: flex-start;\n}\n.l7-control-container .l7-column.l7-right {\n  align-items: flex-end;\n}\n.l7-button-control {\n  min-width: 28px;\n  height: 28px;\n  background-color: #fff;\n  border-width: 0;\n  border-radius: 2px;\n  outline: 0;\n  cursor: pointer;\n  transition: all 0.2s;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  padding: 0 6px;\n  box-shadow: 0 0 20px 0 rgba(0, 0, 0, 0.15);\n  line-height: 16px;\n}\n.l7-button-control .l7-iconfont {\n  fill: #595959;\n  color: #595959;\n  width: 16px;\n  height: 16px;\n}\n.l7-button-control.l7-button-control--row {\n  padding: 0 16px 0 13px;\n}\n.l7-button-control.l7-button-control--row * + .l7-button-control__text {\n  margin-left: 8px;\n}\n.l7-button-control.l7-button-control--column {\n  height: 44px;\n  flex-direction: column;\n}\n.l7-button-control.l7-button-control--column .l7-iconfont {\n  margin-top: 3px;\n}\n.l7-button-control.l7-button-control--column .l7-button-control__text {\n  margin-top: 3px;\n  font-size: 10px;\n  -webkit-transform: scale(0.83333);\n          transform: scale(0.83333);\n}\n.l7-button-control:not(:disabled):hover {\n  background-color: #f3f3f3;\n}\n.l7-button-control:not(:disabled):active {\n  background-color: #f3f3f3;\n}\n.l7-button-control:disabled {\n  background-color: #fafafa;\n  color: #bdbdbd;\n  cursor: not-allowed;\n}\n.l7-button-control:disabled .l7-iconfont {\n  fill: #bdbdbd;\n  color: #bdbdbd;\n}\n.l7-button-control:disabled:hover {\n  background-color: #fafafa;\n}\n.l7-button-control:disabled:active {\n  background-color: #fafafa;\n}\n.l7-popper {\n  position: absolute;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  z-index: 5;\n  color: #595959;\n}\n.l7-popper.l7-popper-hide {\n  display: none;\n}\n.l7-popper .l7-popper-content {\n  min-height: 28px;\n  background: #fff;\n  border-radius: 2px;\n  box-shadow: 0 0 20px 0 rgba(0, 0, 0, 0.15);\n}\n.l7-popper .l7-popper-arrow {\n  width: 0;\n  height: 0;\n  border-width: 4px;\n  border-style: solid;\n  border-top-color: transparent;\n  border-bottom-color: transparent;\n  border-left-color: transparent;\n  border-right-color: transparent;\n  box-shadow: 0 0 20px 0 rgba(0, 0, 0, 0.15);\n}\n.l7-popper.l7-popper-left {\n  flex-direction: row;\n}\n.l7-popper.l7-popper-left .l7-popper-arrow {\n  border-left-color: #fff;\n  margin: 10px 0;\n}\n.l7-popper.l7-popper-right {\n  flex-direction: row-reverse;\n}\n.l7-popper.l7-popper-right .l7-popper-arrow {\n  border-right-color: #fff;\n  margin: 10px 0;\n}\n.l7-popper.l7-popper-top {\n  flex-direction: column;\n}\n.l7-popper.l7-popper-top .l7-popper-arrow {\n  border-top-color: #fff;\n  margin: 0 10px;\n}\n.l7-popper.l7-popper-bottom {\n  flex-direction: column-reverse;\n}\n.l7-popper.l7-popper-bottom .l7-popper-arrow {\n  border-bottom-color: #fff;\n  margin: 0 10px;\n}\n.l7-popper.l7-popper-start {\n  align-items: flex-start;\n}\n.l7-popper.l7-popper-end {\n  align-items: flex-end;\n}\n.l7-select-control--normal {\n  padding: 4px 0;\n}\n.l7-select-control--normal .l7-select-control-item {\n  display: flex;\n  align-items: center;\n  height: 24px;\n  padding: 0 16px;\n  font-size: 12px;\n  line-height: 24px;\n}\n.l7-select-control--normal .l7-select-control-item > * + * {\n  margin-left: 6px;\n}\n.l7-select-control--normal .l7-select-control-item input[type='checkbox'] {\n  width: 14px;\n  height: 14px;\n}\n.l7-select-control--normal .l7-select-control-item:hover {\n  background-color: #f3f3f3;\n}\n.l7-select-control--image {\n  display: flex;\n  flex-wrap: wrap;\n  align-items: flex-start;\n  box-sizing: content-box;\n  max-width: 460px;\n  max-height: 400px;\n  margin: 12px 0 0 12px;\n  overflow-x: hidden;\n  overflow-y: auto;\n}\n.l7-select-control--image .l7-select-control-item {\n  position: relative;\n  display: flex;\n  flex: 0 0 calc((100% - (12px + 9px) * 2) / 3);\n  flex-direction: column;\n  justify-content: center;\n  box-sizing: content-box;\n  margin-right: 12px;\n  margin-bottom: 12px;\n  overflow: hidden;\n  font-size: 12px;\n  border: 1px solid #fff;\n  border-radius: 2px;\n}\n.l7-select-control--image .l7-select-control-item img {\n  width: 100%;\n  height: 80px;\n}\n.l7-select-control--image .l7-select-control-item input[type='checkbox'] {\n  position: absolute;\n  top: 0;\n  right: 0;\n}\n.l7-select-control--image .l7-select-control-item .l7-select-control-item-row {\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  line-height: 26px;\n}\n.l7-select-control--image .l7-select-control-item .l7-select-control-item-row > * + * {\n  margin-left: 8px;\n}\n.l7-select-control--image .l7-select-control-item.l7-select-control-item-active {\n  border-color: #0370fe;\n}\n.l7-select-control-item {\n  cursor: pointer;\n}\n.l7-select-control-item input[type='checkbox'] {\n  margin: 0;\n  cursor: pointer;\n}\n.l7-select-control--multiple .l7-select-control-item:hover {\n  background-color: transparent;\n}\n.l7-control-logo {\n  width: 89px;\n  height: 16px;\n  -webkit-user-select: none;\n     -moz-user-select: none;\n      -ms-user-select: none;\n          user-select: none;\n}\n.l7-control-logo img {\n  height: 100%;\n  width: 100%;\n}\n.l7-control-logo .l7-control-logo-link {\n  display: block;\n  cursor: pointer;\n}\n.l7-control-logo .l7-control-logo-link img {\n  cursor: pointer;\n}\n.l7-control-mouse-location {\n  background-color: #fff;\n  border-radius: 2px;\n  box-shadow: 0 0 20px 0 rgba(0, 0, 0, 0.15);\n  padding: 2px 4px;\n  min-width: 130px;\n}\n.l7-control-zoom {\n  overflow: hidden;\n  border-radius: 2px;\n  box-shadow: 0 0 20px 0 rgba(0, 0, 0, 0.15);\n}\n.l7-control-zoom .l7-button-control {\n  font-size: 16px;\n  border-bottom: 1px solid #f0f0f0;\n  border-radius: 0;\n  box-shadow: 0 0 0;\n}\n.l7-control-zoom .l7-button-control .l7-iconfont {\n  width: 14px;\n  height: 14px;\n}\n.l7-control-zoom .l7-button-control:last-child {\n  border-bottom: 0;\n}\n.l7-control-zoom .l7-control-zoom__number {\n  color: #595959;\n  padding: 0;\n}\n.l7-control-zoom .l7-control-zoom__number:hover {\n  background-color: #fff;\n}\n.l7-control-scale {\n  display: flex;\n  flex-direction: column;\n}\n.l7-control-scale .l7-control-scale-line {\n  box-sizing: border-box;\n  padding: 2px 5px 1px;\n  overflow: hidden;\n  color: #595959;\n  font-size: 10px;\n  line-height: 1.1;\n  white-space: nowrap;\n  background: #fff;\n  border: 2px solid #000;\n  border-top: 0;\n  transition: width 0.1s;\n}\n.l7-control-scale .l7-control-scale-line + .l7-control-scale .l7-control-scale-line {\n  margin-top: -2px;\n  border-top: 2px solid #777;\n  border-bottom: none;\n}\n.l7-right .l7-control-scale {\n  display: flex;\n  align-items: flex-end;\n}\n.l7-right .l7-control-scale .l7-control-scale-line {\n  text-align: right;\n}\n.l7-popup {\n  position: absolute;\n  top: 0;\n  left: 0;\n  z-index: 5;\n  display: flex;\n  will-change: transform;\n  pointer-events: none;\n}\n.l7-popup.l7-popup-hide {\n  display: none;\n}\n.l7-popup .l7-popup-content {\n  position: relative;\n  padding: 16px;\n  font-size: 14px;\n  background: #fff;\n  border-radius: 3px;\n  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);\n}\n.l7-popup .l7-popup-content .l7-popup-content__title {\n  margin-bottom: 8px;\n  font-weight: bold;\n}\n.l7-popup .l7-popup-content .l7-popup-close-button,\n.l7-popup .l7-popup-content .l7-popup-content__title,\n.l7-popup .l7-popup-content .l7-popup-content__panel {\n  white-space: normal;\n  -webkit-user-select: text;\n     -moz-user-select: text;\n      -ms-user-select: text;\n          user-select: text;\n  pointer-events: initial;\n}\n.l7-popup .l7-popup-content .l7-popup-close-button {\n  position: absolute;\n  top: 0;\n  right: 0;\n  width: 18px;\n  height: 18px;\n  padding: 0;\n  font-size: 14px;\n  line-height: 18px;\n  text-align: center;\n  background-color: transparent;\n  border: 0;\n  border-radius: 0 3px 0 0;\n  cursor: pointer;\n}\n.l7-popup .l7-popup-tip {\n  position: relative;\n  z-index: 1;\n  width: 0;\n  height: 0;\n  border: 10px solid transparent;\n}\n.l7-popup.l7-popup-anchor-bottom,\n.l7-popup.l7-popup-anchor-bottom-left,\n.l7-popup.l7-popup-anchor-bottom-right {\n  flex-direction: column-reverse;\n}\n.l7-popup.l7-popup-anchor-bottom .l7-popup-tip,\n.l7-popup.l7-popup-anchor-bottom-left .l7-popup-tip,\n.l7-popup.l7-popup-anchor-bottom-right .l7-popup-tip {\n  bottom: 1px;\n}\n.l7-popup.l7-popup-anchor-top,\n.l7-popup.l7-popup-anchor-top-left,\n.l7-popup.l7-popup-anchor-top-right {\n  flex-direction: column;\n}\n.l7-popup.l7-popup-anchor-top .l7-popup-tip,\n.l7-popup.l7-popup-anchor-top-left .l7-popup-tip,\n.l7-popup.l7-popup-anchor-top-right .l7-popup-tip {\n  top: 1px;\n}\n.l7-popup.l7-popup-anchor-left {\n  flex-direction: row;\n}\n.l7-popup.l7-popup-anchor-right {\n  flex-direction: row-reverse;\n}\n.l7-popup-anchor-top .l7-popup-tip {\n  position: relative;\n  align-self: center;\n  border-top: none;\n  border-bottom-color: #fff;\n}\n.l7-popup-anchor-top-left .l7-popup-tip {\n  align-self: flex-start;\n  border-top: none;\n  border-bottom-color: #fff;\n  border-left: none;\n}\n.l7-popup-anchor-top-right .l7-popup-tip {\n  align-self: flex-end;\n  border-top: none;\n  border-right: none;\n  border-bottom-color: #fff;\n}\n.l7-popup-anchor-bottom .l7-popup-tip {\n  align-self: center;\n  border-top-color: #fff;\n  border-bottom: none;\n}\n.l7-popup-anchor-bottom-left .l7-popup-tip {\n  align-self: flex-start;\n  border-top-color: #fff;\n  border-bottom: none;\n  border-left: none;\n}\n.l7-popup-anchor-bottom-right .l7-popup-tip {\n  align-self: flex-end;\n  border-top-color: #fff;\n  border-right: none;\n  border-bottom: none;\n}\n.l7-popup-anchor-left .l7-popup-tip {\n  align-self: center;\n  border-right-color: #fff;\n  border-left: none;\n}\n.l7-popup-anchor-right .l7-popup-tip {\n  right: 1px;\n  align-self: center;\n  border-right: none;\n  border-left-color: #fff;\n}\n.l7-popup-anchor-top-left .l7-popup-content {\n  border-top-left-radius: 0;\n}\n.l7-popup-anchor-top-right .l7-popup-content {\n  border-top-right-radius: 0;\n}\n.l7-popup-anchor-bottom-left .l7-popup-content {\n  border-bottom-left-radius: 0;\n}\n.l7-popup-anchor-bottom-right .l7-popup-content {\n  border-bottom-right-radius: 0;\n}\n.l7-popup-track-pointer {\n  display: none;\n}\n.l7-popup-track-pointer * {\n  -webkit-user-select: none;\n     -moz-user-select: none;\n      -ms-user-select: none;\n          user-select: none;\n  pointer-events: none;\n}\n.l7-map:hover .l7-popup-track-pointer {\n  display: flex;\n}\n.l7-map:active .l7-popup-track-pointer {\n  display: none;\n}\n.l7-layer-popup__row {\n  font-size: 12px;\n}\n.l7-layer-popup__row + .l7-layer-popup__row {\n  margin-top: 4px;\n}\n.l7-control-swipe {\n  position: absolute;\n  top: 50%;\n  left: 50%;\n  z-index: 6;\n  -webkit-transform: translate(-50%, -50%);\n          transform: translate(-50%, -50%);\n  touch-action: none;\n}\n.l7-control-swipe_hide {\n  display: none;\n}\n.l7-control-swipe:before {\n  position: absolute;\n  top: -5000px;\n  bottom: -5000px;\n  left: 50%;\n  z-index: -1;\n  width: 4px;\n  background: #fff;\n  -webkit-transform: translate(-2px, 0);\n          transform: translate(-2px, 0);\n  content: '';\n}\n.l7-control-swipe.horizontal:before {\n  top: 50%;\n  right: -5000px;\n  bottom: auto;\n  left: -5000px;\n  width: auto;\n  height: 4px;\n}\n.l7-control-swipe__button {\n  display: block;\n  width: 28px;\n  height: 28px;\n  margin: 0;\n  padding: 0;\n  color: #595959;\n  font-weight: bold;\n  font-size: inherit;\n  text-align: center;\n  text-decoration: none;\n  background-color: #fff;\n  border: none;\n  border-radius: 2px;\n  outline: none;\n}\n.l7-control-swipe,\n.l7-control-swipe__button {\n  cursor: ew-resize;\n}\n.l7-control-swipe.horizontal,\n.l7-control-swipe.horizontal button {\n  cursor: ns-resize;\n}\n.l7-control-swipe:after,\n.l7-control-swipe__button:before,\n.l7-control-swipe__button:after {\n  position: absolute;\n  top: 25%;\n  bottom: 25%;\n  left: 50%;\n  width: 2px;\n  background: currentColor;\n  -webkit-transform: translate(-1px, 0);\n          transform: translate(-1px, 0);\n  content: '';\n}\n.l7-control-swipe__button:after {\n  -webkit-transform: translateX(4px);\n          transform: translateX(4px);\n}\n.l7-control-swipe__button:before {\n  -webkit-transform: translateX(-6px);\n          transform: translateX(-6px);\n}\n");var Rx=function(){return c((function e(t){f(this,e),ne(this,"configService",void 0),ne(this,"config",void 0),this.config=t}),[{key:"setContainer",value:function(e,t,n){this.configService=e.globalConfigService,e.mapConfig=re(re({},this.config),{},{id:t,canvas:n}),e.mapService=new(this.getServiceConstructor())(e)}},{key:"getServiceConstructor",value:function(){throw new Error("Method not implemented.")}}])}(),Cx={exports:{}};!function(e,t){e.exports=function(){function e(e){var r=[];return e.AMapUI&&r.push(t(e.AMapUI)),e.Loca&&r.push(n(e.Loca)),Promise.all(r)}function t(e){return new Promise((function(t,n){var i=[];if(e.plugins)for(var u=0;u<e.plugins.length;u+=1)-1==o.AMapUI.plugins.indexOf(e.plugins[u])&&i.push(e.plugins[u]);if(a.AMapUI===r.failed)n("前次请求 AMapUI 失败");else if(a.AMapUI===r.notload){a.AMapUI=r.loading,o.AMapUI.version=e.version||o.AMapUI.version,u=o.AMapUI.version;var c=document.body||document.head,l=document.createElement("script");l.type="text/javascript",l.src="https://webapi.amap.com/ui/"+u+"/main.js",l.onerror=function(e){a.AMapUI=r.failed,n("请求 AMapUI 失败")},l.onload=function(){if(a.AMapUI=r.loaded,i.length)window.AMapUI.loadUI(i,(function(){for(var e=0,n=i.length;e<n;e++){var r=i[e].split("/").slice(-1)[0];window.AMapUI[r]=arguments[e]}for(t();s.AMapUI.length;)s.AMapUI.splice(0,1)[0]()}));else for(t();s.AMapUI.length;)s.AMapUI.splice(0,1)[0]()},c.appendChild(l)}else a.AMapUI===r.loaded?e.version&&e.version!==o.AMapUI.version?n("不允许多个版本 AMapUI 混用"):i.length?window.AMapUI.loadUI(i,(function(){for(var e=0,n=i.length;e<n;e++){var r=i[e].split("/").slice(-1)[0];window.AMapUI[r]=arguments[e]}t()})):t():e.version&&e.version!==o.AMapUI.version?n("不允许多个版本 AMapUI 混用"):s.AMapUI.push((function(e){e?n(e):i.length?window.AMapUI.loadUI(i,(function(){for(var e=0,n=i.length;e<n;e++){var r=i[e].split("/").slice(-1)[0];window.AMapUI[r]=arguments[e]}t()})):t()}))}))}function n(e){return new Promise((function(t,n){if(a.Loca===r.failed)n("前次请求 Loca 失败");else if(a.Loca===r.notload){a.Loca=r.loading,o.Loca.version=e.version||o.Loca.version;var i=o.Loca.version,u=o.AMap.version.startsWith("2"),c=i.startsWith("2");if(u&&!c||!u&&c)n("JSAPI 与 Loca 版本不对应！！");else{u=o.key,c=document.body||document.head;var l=document.createElement("script");l.type="text/javascript",l.src="https://webapi.amap.com/loca?v="+i+"&key="+u,l.onerror=function(e){a.Loca=r.failed,n("请求 AMapUI 失败")},l.onload=function(){for(a.Loca=r.loaded,t();s.Loca.length;)s.Loca.splice(0,1)[0]()},c.appendChild(l)}}else a.Loca===r.loaded?e.version&&e.version!==o.Loca.version?n("不允许多个版本 Loca 混用"):t():e.version&&e.version!==o.Loca.version?n("不允许多个版本 Loca 混用"):s.Loca.push((function(e){e?n(e):n()}))}))}if(!window)throw Error("AMap JSAPI can only be used in Browser.");var r,i;(i=r||(r={})).notload="notload",i.loading="loading",i.loaded="loaded",i.failed="failed";var o={key:"",AMap:{version:"1.4.15",plugins:[]},AMapUI:{version:"1.1",plugins:[]},Loca:{version:"1.3.2"}},a={AMap:r.notload,AMapUI:r.notload,Loca:r.notload},s={AMap:[],AMapUI:[],Loca:[]},u=[],c=function(e){"function"==typeof e&&(a.AMap===r.loaded?e(window.AMap):u.push(e))};return{load:function(t){return new Promise((function(n,i){if(a.AMap==r.failed)i("");else if(a.AMap==r.notload){var s=t.key,l=t.version,f=t.plugins;s?(window.AMap&&"lbs.amap.com"!==location.host&&i("禁止多种API加载方式混用"),o.key=s,o.AMap.version=l||o.AMap.version,o.AMap.plugins=f||o.AMap.plugins,a.AMap=r.loading,l=document.body||document.head,window.___onAPILoaded=function(o){if(delete window.___onAPILoaded,o)a.AMap=r.failed,i(o);else for(a.AMap=r.loaded,e(t).then((function(){n(window.AMap)})).catch(i);u.length;)u.splice(0,1)[0]()},(f=document.createElement("script")).type="text/javascript",f.src="https://webapi.amap.com/maps?callback=___onAPILoaded&v="+o.AMap.version+"&key="+s+"&plugin="+o.AMap.plugins.join(","),f.onerror=function(e){a.AMap=r.failed,i(e)},l.appendChild(f)):i("请填写key")}else if(a.AMap==r.loaded)if(t.key&&t.key!==o.key)i("多个不一致的 key");else if(t.version&&t.version!==o.AMap.version)i("不允许多个版本 JSAPI 混用");else{if(s=[],t.plugins)for(l=0;l<t.plugins.length;l+=1)-1==o.AMap.plugins.indexOf(t.plugins[l])&&s.push(t.plugins[l]);s.length?window.AMap.plugin(s,(function(){e(t).then((function(){n(window.AMap)})).catch(i)})):e(t).then((function(){n(window.AMap)})).catch(i)}else if(t.key&&t.key!==o.key)i("多个不一致的 key");else if(t.version&&t.version!==o.AMap.version)i("不允许多个版本 JSAPI 混用");else{var h=[];if(t.plugins)for(l=0;l<t.plugins.length;l+=1)-1==o.AMap.plugins.indexOf(t.plugins[l])&&h.push(t.plugins[l]);c((function(){h.length?window.AMap.plugin(h,(function(){e(t).then((function(){n(window.AMap)})).catch(i)})):e(t).then((function(){n(window.AMap)})).catch(i)}))}}))},reset:function(){delete window.AMap,delete window.AMapUI,delete window.Loca,o={key:"",AMap:{version:"1.4.15",plugins:[]},AMapUI:{version:"1.1",plugins:[]},Loca:{version:"1.3.2"}},a={AMap:r.notload,AMapUI:r.notload,Loca:r.notload},s={AMap:[],AMapUI:[],Loca:[]}}}}()}(Cx);var Mx=Cx.exports;function Lx(e,t){var n,r,i,o=al([],t,e);return n=o,r=o,i=1/o[3],n[0]=r[0]*i,n[1]=r[1]*i,n[2]=r[2]*i,n[3]=r[3]*i,o}function Ox(e,t){if(!e)throw new Error(t||"viewport-mercator-project: assertion failed.")}var kx=Math.PI,Nx=kx/4,Ix=kx/180,Px=180/kx,Dx=4003e4,Fx=1.5;function Bx(e){return Math.pow(2,e)}function Ux(e,t){var n=ae(e,2),r=n[0],i=n[1];Ox(Number.isFinite(r)&&Number.isFinite(t)),Ox(Number.isFinite(i)&&i>=-90&&i<=90,"invalid latitude");var o=i*Ix;return[(t*=512)*(r*Ix+kx)/(2*kx),t*(kx-Math.log(Math.tan(Nx+.5*o)))/(2*kx)]}function Gx(e,t){var n=ae(e,2),r=n[0],i=n[1],o=r/(t*=512)*(2*kx)-kx,a=2*(Math.atan(Math.exp(kx-i/t*(2*kx)))-Nx);return[o*Px,a*Px]}function zx(e){var t=e.width,n=e.height,r=e.pitch,i=function(e){var t=e.width,n=e.height,r=e.altitude,i=void 0===r?Fx:r,o=e.pitch,a=void 0===o?0:o,s=e.nearZMultiplier,u=void 0===s?1:s,c=e.farZMultiplier,l=void 0===c?1:c,f=a*Ix,h=Math.atan(.5/i),d=Math.sin(h)*i/Math.sin(Math.PI/2-f-h),p=Math.cos(Math.PI/2-f)*d+i;return{fov:2*Math.atan(n/2/i),aspect:t/n,focalDistance:i,near:u,far:p*l}}({width:t,height:n,altitude:e.altitude,pitch:r,nearZMultiplier:e.nearZMultiplier,farZMultiplier:e.farZMultiplier}),o=i.fov,a=i.aspect,s=i.near,u=i.far;return Qc([],o,a,s,u)}function jx(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,r=ae(e,3),i=r[0],o=r[1],a=r[2];if(Ox(Number.isFinite(i)&&Number.isFinite(o),"invalid pixel coordinate"),Number.isFinite(a))return Lx(t,[i,o,a,1]);var s=Lx(t,[i,o,0,1]),u=Lx(t,[i,o,1,1]),c=s[2],l=u[2];return function(e,t,n,r){var i=t[0],o=t[1];return e[0]=i+r*(n[0]-i),e[1]=o+r*(n[1]-o),e}([],s,u,c===l?0:((n||0)-c)/(l-c))}var Vx=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],Hx=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=t.width,r=t.height,i=t.viewMatrix,o=void 0===i?Vx:i,a=t.projectionMatrix,s=void 0===a?Vx:a;ue(this,e),this.width=n||1,this.height=r||1,this.scale=1,this.pixelsPerMeter=1,this.viewMatrix=o,this.projectionMatrix=s;var u=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];Xc(u,u,this.projectionMatrix),Xc(u,u,this.viewMatrix),this.viewProjectionMatrix=u;var c=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];Yc(c,c,[this.width/2,-this.height/2,1]),Wc(c,c,[1,-1,0]),Xc(c,c,this.viewProjectionMatrix);var l=Hc([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],c);if(!l)throw new Error("Pixel project matrix not invertible");this.pixelProjectionMatrix=c,this.pixelUnprojectionMatrix=l,this.equals=this.equals.bind(this),this.project=this.project.bind(this),this.unproject=this.unproject.bind(this),this.projectPosition=this.projectPosition.bind(this),this.unprojectPosition=this.unprojectPosition.bind(this),this.projectFlat=this.projectFlat.bind(this),this.unprojectFlat=this.unprojectFlat.bind(this)}return se(e,[{key:"equals",value:function(t){return t instanceof e&&(t.width===this.width&&t.height===this.height&&$c(t.projectionMatrix,this.projectionMatrix)&&$c(t.viewMatrix,this.viewMatrix))}},{key:"project",value:function(e){var t=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}).topLeft,n=void 0===t||t,r=function(e,t){var n=ae(e,3),r=n[0],i=n[1],o=n[2],a=void 0===o?0:o;return Ox(Number.isFinite(r)&&Number.isFinite(i)&&Number.isFinite(a)),Lx(t,[r,i,a,1])}(this.projectPosition(e),this.pixelProjectionMatrix),i=ae(r,2),o=i[0],a=i[1],s=n?a:this.height-a;return 2===e.length?[o,s]:[o,s,r[2]]}},{key:"unproject",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.topLeft,r=void 0===n||n,i=t.targetZ,o=ae(e,3),a=o[0],s=o[1],u=o[2],c=r?s:this.height-s,l=i&&i*this.pixelsPerMeter,f=jx([a,c,u],this.pixelUnprojectionMatrix,l),h=this.unprojectPosition(f),d=ae(h,3),p=d[0],v=d[1],m=d[2];return Number.isFinite(u)?[p,v,m]:Number.isFinite(i)?[p,v,i]:[p,v]}},{key:"projectPosition",value:function(e){var t=this.projectFlat(e),n=ae(t,2);return[n[0],n[1],(e[2]||0)*this.pixelsPerMeter]}},{key:"unprojectPosition",value:function(e){var t=this.unprojectFlat(e),n=ae(t,2);return[n[0],n[1],(e[2]||0)/this.pixelsPerMeter]}},{key:"projectFlat",value:function(e){return arguments.length>1&&void 0!==arguments[1]||this.scale,e}},{key:"unprojectFlat",value:function(e){return arguments.length>1&&void 0!==arguments[1]||this.scale,e}}]),e}();function Xx(e){var t=e.width,n=e.height,r=e.bounds,i=e.minExtent,o=void 0===i?0:i,a=e.maxZoom,s=void 0===a?24:a,u=e.padding,c=void 0===u?0:u,l=e.offset,f=void 0===l?[0,0]:l,h=ae(r,2),d=ae(h[0],2),p=d[0],v=d[1],m=ae(h[1],2),g=m[0],_=m[1];if(Number.isFinite(c)){c={top:c,bottom:c,left:c,right:c}}else Ox(Number.isFinite(c.top)&&Number.isFinite(c.bottom)&&Number.isFinite(c.left)&&Number.isFinite(c.right));var y=new Wx({width:t,height:n,longitude:0,latitude:0,zoom:0}),E=y.project([p,_]),b=y.project([g,v]),A=[Math.max(Math.abs(b[0]-E[0]),o),Math.max(Math.abs(b[1]-E[1]),o)],x=[t-c.left-c.right-2*Math.abs(f[0]),n-c.top-c.bottom-2*Math.abs(f[1])];Ox(x[0]>0&&x[1]>0);var S=x[0]/A[0],T=x[1]/A[1],R=(c.right-c.left)/2/S,C=(c.bottom-c.top)/2/T,M=[(b[0]+E[0])/2+R,(b[1]+E[1])/2+C],w=y.unproject(M),L=y.zoom+Math.log2(Math.abs(Math.min(S,T)));return{longitude:w[0],latitude:w[1],zoom:Math.min(L,s)}}var Wx=function(e){function t(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=n.width,i=n.height,o=n.latitude,a=void 0===o?0:o,s=n.longitude,u=void 0===s?0:s,c=n.zoom,l=void 0===c?0:c,f=n.pitch,h=void 0===f?0:f,d=n.bearing,p=void 0===d?0:d,v=n.altitude,m=void 0===v?1.5:v,g=n.nearZMultiplier,_=n.farZMultiplier;ue(this,t),r=r||1,i=i||1;var y=Bx(l);m=Math.max(.75,m);var E=Ux([u,a],y);E[2]=0;var b=zx({width:r,height:i,pitch:h,bearing:p,altitude:m,nearZMultiplier:g||1/i,farZMultiplier:_||1.01}),A=function(e){var t,n,r=e.height,i=e.pitch,o=e.bearing,a=e.altitude,s=e.center,u=void 0===s?null:s,c=e.flipY,l=void 0!==c&&c,f=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];return Wc(f,f,[0,0,-a]),Yc(f,f,[1,1,1/r]),Zc(f,f,-i*Ix),Kc(f,f,o*Ix),l&&Yc(f,f,[1,-1,1]),u&&Wc(f,f,((t=[])[0]=-(n=u)[0],t[1]=-n[1],t[2]=-n[2],t)),f}({height:i,center:E,pitch:h,bearing:p,altitude:m,flipY:!0});return(e=J(this,ee(t).call(this,{width:r,height:i,viewMatrix:A,projectionMatrix:b}))).latitude=a,e.longitude=u,e.zoom=l,e.pitch=h,e.bearing=p,e.altitude=m,e.scale=y,e.center=E,e.pixelsPerMeter=function(e){var t=e.latitude,n=e.longitude,r=e.zoom,i=e.scale,o=e.highPrecision,a=void 0!==o&&o;i=void 0!==i?i:Bx(r),Ox(Number.isFinite(t)&&Number.isFinite(n)&&Number.isFinite(i));var s={},u=512*i,c=Math.cos(t*Ix),l=u/360,f=l/c,h=u/Dx/c;if(s.pixelsPerMeter=[h,-h,h],s.metersPerPixel=[1/h,-1/h,1/h],s.pixelsPerDegree=[l,-f,h],s.degreesPerPixel=[1/l,-1/f,1/h],a){var d=Ix*Math.tan(t*Ix)/c,p=l*d/2,v=u/Dx*d,m=v/f*h;s.pixelsPerDegree2=[0,-p,v],s.pixelsPerMeter2=[m,0,m]}return s}(te(te(e))).pixelsPerMeter[2],Object.freeze(te(te(e))),e}return $(t,e),se(t,[{key:"projectFlat",value:function(e){return Ux(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.scale)}},{key:"unprojectFlat",value:function(e){return Gx(e,arguments.length>1&&void 0!==arguments[1]?arguments[1]:this.scale)}},{key:"getMapCenterByLngLatPosition",value:function(e){var t,n,r=e.lngLat,i=jx(e.pos,this.pixelUnprojectionMatrix),o=ll([],Ux(r,this.scale),((t=[])[0]=-(n=i)[0],t[1]=-n[1],t));return Gx(ll([],this.center,o),this.scale)}},{key:"getLocationAtPoint",value:function(e){var t=e.lngLat,n=e.pos;return this.getMapCenterByLngLatPosition({lngLat:t,pos:n})}},{key:"fitBounds",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=this.width,i=this.height,o=Xx(Object.assign({width:r,height:i,bounds:e},n));return new t({width:r,height:i,longitude:o.longitude,latitude:o.latitude,zoom:o.zoom})}}]),t}(Hx),Yx=function(){return c((function e(){f(this,e),ne(this,"viewport",void 0)}),[{key:"syncWithMapCamera",value:function(e){var t=e.center,n=e.zoom,r=e.pitch,i=e.bearing,o=e.viewportHeight,a=e.viewportWidth,s=this.viewport?{width:this.viewport.width,height:this.viewport.height,longitude:this.viewport.center[0],latitude:this.viewport.center[1],zoom:this.viewport.zoom,pitch:this.viewport.pitch,bearing:this.viewport.bearing}:{};this.viewport=new Wx(re(re({},s),{},{width:a,height:o,longitude:t&&t[0],latitude:t&&t[1],zoom:n,pitch:r,bearing:i}))}},{key:"getZoom",value:function(){return this.viewport.zoom}},{key:"getZoomScale",value:function(){return Math.pow(2,this.getZoom())}},{key:"getCenter",value:function(){return[this.viewport.longitude,this.viewport.latitude]}},{key:"getProjectionMatrix",value:function(){return this.viewport.projectionMatrix}},{key:"getModelMatrix",value:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}},{key:"getViewMatrix",value:function(){return this.viewport.viewMatrix}},{key:"getViewMatrixUncentered",value:function(){return this.viewport.viewMatrixUncentered}},{key:"getViewProjectionMatrix",value:function(){return this.viewport.viewProjectionMatrix}},{key:"getViewProjectionMatrixUncentered",value:function(){return this.viewport.viewProjectionMatrix}},{key:"getFocalDistance",value:function(){return 1}},{key:"projectFlat",value:function(e,t){return this.viewport.projectFlat(e,t)}}])}(),Zx=function(){return c((function e(t){f(this,e),ne(this,"size",1e4),this.size=t||1e4}),[{key:"setSize",value:function(e){this.size=e}},{key:"getSize",value:function(){return[this.size,this.size]}},{key:"mercatorXfromLng",value:function(e){return(180+e)/360*this.size}},{key:"mercatorYfromLat",value:function(e){return(1-(180-180/Math.PI*Math.log(Math.tan(Math.PI/4+e*Math.PI/360)))/360)*this.size}},{key:"lngFromMercatorX",value:function(e){return e/this.size*360-180}},{key:"latFromMercatorY",value:function(e){var t=180-360*(1-e/this.size);return 360/Math.PI*Math.atan(Math.exp(t*Math.PI/180))-90}},{key:"project",value:function(e){return[this.mercatorXfromLng(e[0]),this.mercatorYfromLat(e[1])]}},{key:"unproject",value:function(e){return[this.lngFromMercatorX(e[0]),this.latFromMercatorY(e[1])]}}])}();function qx(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if("number"==typeof e)return{top:e,right:e,bottom:e,left:e};if(Array.isArray(e)){if(4===e.length)return{top:e[0],right:e[1],bottom:e[2],left:e[3]};if(2===e.length)return{top:e[0],right:e[1],bottom:e[0],left:e[1]}}return re(re({},{top:0,right:0,bottom:0,left:0}),e)}var Kx={normal:"amap://styles/normal",light:"amap://styles/c422f5c0cfced5be9fe3a83f05f28a68?isPublic=true",dark:"amap://styles/c9f1d10cae34f8ab05e425462c5a58d7?isPublic=true",blank:"amap://styles/07c17002b38775b32a7a76c66cf90e99?isPublic=true",fresh:"amap://styles/fresh",grey:"amap://styles/grey",graffiti:"amap://styles/graffiti",macaron:"amap://styles/macaron",darkblue:"amap://styles/darkblue",wine:"amap://styles/wine"},Qx=["id","style","minZoom","maxZoom","token","mapInstance","plugin"];!function(e,t){var n="undefined"!=typeof my&&!!my&&"function"==typeof my.showToast&&!0!==my.isFRM,r="undefined"!=typeof wx&&null!==wx&&(void 0!==wx.request||void 0!==wx.miniProgram);if(!n&&!r&&(t||(t=document),t)){var i=t.head||t.getElementsByTagName("head")[0];if(!i){i=t.createElement("head");var o=t.body||t.getElementsByTagName("body")[0];o?o.parentNode.insertBefore(i,o):t.documentElement.appendChild(i)}var a=t.createElement("style");a.type="text/css",a.styleSheet?a.styleSheet.cssText=e:a.appendChild(t.createTextNode(e)),i.appendChild(a)}}(".amap-logo {\n  display: none !important;\n}\n.amap-copyright {\n  display: none !important;\n}\n");var $x={"GAODE1.x":{contextmenu:"rightclick"},"GAODE2.x":{contextmenu:"rightclick",camerachange:"viewchange"}},Jx=0;window.forceWebGL=!0;var eS="15cd8a57710d40c9b7c0e3cc120f1200",tS=!1,nS=[],rS=function(){return c((function e(t){var n=this;f(this,e),ne(this,"version",io["GAODE1.x"]),ne(this,"simpleMapCoord",new Zx),ne(this,"map",void 0),ne(this,"bgColor","rgba(0, 0, 0, 0)"),ne(this,"configService",void 0),ne(this,"config",void 0),ne(this,"coordinateSystemService",void 0),ne(this,"eventEmitter",void 0),ne(this,"markerContainer",void 0),ne(this,"$mapContainer",void 0),ne(this,"cameraChangedCallback",void 0),ne(this,"handleCameraChanged",(function(e){var t=e.camera,r=t.fov,i=t.near,o=t.far,a=t.height,s=t.pitch,u=t.rotation,c=t.aspect,l=t.position,f=n.getCenter(),h=f.lng,d=f.lat;if(n.emit("mapchange"),n.cameraChangedCallback){n.viewport.syncWithMapCamera({aspect:c,bearing:360-u,far:o,fov:r,cameraHeight:a,near:i,pitch:s,zoom:n.map.getZoom()-1,center:[h,d],offsetOrigin:[l.x,l.y]});var p=n.config.offsetZoom,v=void 0===p?12:p;n.viewport.getZoom()>v?n.coordinateSystemService.setCoordinateSystem(tc.P20_OFFSET):n.coordinateSystemService.setCoordinateSystem(tc.P20),n.cameraChangedCallback(n.viewport)}})),this.config=t.mapConfig,this.configService=t.globalConfigService,this.coordinateSystemService=t.coordinateSystemService,this.eventEmitter=new lo.exports.EventEmitter}),[{key:"setBgColor",value:function(e){this.bgColor=e}},{key:"addMarkerContainer",value:function(){var e=this.map.getContainer();if(null!==e){var t=e.getElementsByClassName("amap-maps")[0];this.markerContainer=Di("div","l7-marker-container",t)}}},{key:"getMarkerContainer",value:function(){return this.markerContainer}},{key:"on",value:function(e,t){-1!==Cc.indexOf(e)?this.eventEmitter.on(e,t):this.map.on($x[this.version][e]||e,t)}},{key:"off",value:function(e,t){-1!==Cc.indexOf(e)?this.eventEmitter.off(e,t):this.map.off($x[this.version][e]||e,t)}},{key:"getContainer",value:function(){return this.map.getContainer()}},{key:"getMapCanvasContainer",value:function(){var e;return null===(e=this.map.getContainer())||void 0===e?void 0:e.getElementsByClassName("amap-maps")[0]}},{key:"getCanvasOverlays",value:function(){var e;return null===(e=this.$mapContainer)||void 0===e?void 0:e.querySelector(".amap-overlays")}},{key:"getSize",value:function(){var e=this.map.getSize();return[e.getWidth(),e.getHeight()]}},{key:"getType",value:function(){return"amap"}},{key:"getZoom",value:function(){return this.map.getZoom()-1}},{key:"setZoom",value:function(e){return this.map.setZoom(e+1)}},{key:"getCenter",value:function(e){if(null!=e&&e.padding){var t=this.getCenter(),n=qx(e.padding),r=this.lngLatToPixel([t.lng,t.lat]),i=[(n.right-n.left)/2,(n.bottom-n.top)/2];return this.pixelToLngLat([r.x-i[0],r.y-i[1]])}var o=this.map.getCenter();return{lng:o.getLng(),lat:o.getLat()}}},{key:"setCenter",value:function(e,t){if(null!=t&&t.padding){var n=qx(t.padding),r=this.lngLatToPixel(e),i=[(n.right-n.left)/2,(n.bottom-n.top)/2],o=this.pixelToLngLat([r.x+i[0],r.y+i[1]]);this.map.setCenter([o.lng,o.lat])}else this.map.setCenter(e)}},{key:"getPitch",value:function(){return this.map.getPitch()}},{key:"getRotation",value:function(){return 360-this.map.getRotation()}},{key:"getBounds",value:function(){var e=this.map.getBounds().toBounds(),t=e.getNorthEast(),n=e.getSouthWest(),r=this.getCenter(),i=r.lng>t.getLng()||r.lng<n.getLng()?180-t.getLng():t.getLng();return[[r.lng<n.getLng()?n.getLng()-180:n.getLng(),n.getLat()],[i,t.getLat()]]}},{key:"getMinZoom",value:function(){return this.map.get("zooms")[0]-1}},{key:"getMaxZoom",value:function(){return this.map.get("zooms")[1]-1}},{key:"setRotation",value:function(e){return this.map.setRotation(e)}},{key:"setPitch",value:function(e){return this.map.setPitch(e)}},{key:"zoomIn",value:function(){this.map.zoomIn()}},{key:"zoomOut",value:function(){this.map.zoomOut()}},{key:"panTo",value:function(e){this.map.panTo(e)}},{key:"panBy",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;this.map.panBy(e,t)}},{key:"fitBounds",value:function(e){this.map.setBounds(new AMap.Bounds([e[0][0],e[0][1],e[1][0],e[1][1]]))}},{key:"setZoomAndCenter",value:function(e,t){this.map.setZoomAndCenter(e+1,t)}},{key:"setMapStyle",value:function(e){this.map.setMapStyle(this.getMapStyleValue(e))}},{key:"setMapStatus",value:function(e){this.map.setStatus(e)}},{key:"getMapStyleConfig",value:function(){return Kx}},{key:"getMapStyleValue",value:function(e){return this.getMapStyleConfig()[e]||e}},{key:"getMapStyle",value:function(){return this.map.getMapStyle()}},{key:"pixelToLngLat",value:function(e){var t=this.map.pixelToLngLat(new AMap.Pixel(e[0],e[1]));return{lng:t.getLng(),lat:t.getLat()}}},{key:"lngLatToPixel",value:function(e){var t=this.map.lnglatToPixel(new AMap.LngLat(e[0],e[1]));return{x:t.getX(),y:t.getY()}}},{key:"containerToLngLat",value:function(e){var t=new AMap.Pixel(e[0],e[1]),n=this.map.containerToLngLat(t);return{lng:null==n?void 0:n.getLng(),lat:null==n?void 0:n.getLat()}}},{key:"lngLatToContainer",value:function(e){var t=new AMap.LngLat(e[0],e[1]),n=this.map.lngLatToContainer(t);return{x:n.getX(),y:n.getY()}}},{key:"lngLatToCoord",value:function(e){var t=this.map.lngLatToGeodeticCoord(e);return[t.x,-t.y]}},{key:"lngLatToMercator",value:function(e,t){return{x:0,y:0,z:0}}},{key:"getModelMatrix",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[1,1,1],i=this.viewport.projectFlat(e),o=jc();return Wc(o,o,el(i[0],i[1],t)),Yc(o,o,el(r[0],r[1],r[2])),Zc(o,o,n[0]),qc(o,o,n[1]),Kc(o,o,n[2]),o}},{key:"init",value:function(){var e=this;return ie(i().mark((function t(){var n,r,o,a,s,u,c,l,f,h,d,p,v,m;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.config,r=n.id,o=n.style,a=void 0===o?"light":o,s=n.minZoom,u=void 0===s?0:s,c=n.maxZoom,l=void 0===c?18:c,f=n.token,h=void 0===f?eS:f,d=n.mapInstance,p=n.plugin,v=void 0===p?[]:p,m=oe(n,Qx),t.next=3,new Promise((function(t){var n=function(){if(d)e.map=d,e.$mapContainer=e.map.getContainer(),setTimeout((function(){e.map.on("camerachange",e.handleCameraChanged),t()}),30);else{e.$mapContainer=e.creatMapContainer(r);var n=re({mapStyle:e.getMapStyleValue(a),zooms:[u,l],viewMode:"3D"},m);n.zoom&&(n.zoom+=1);var i=new AMap.Map(e.$mapContainer,n);i.on("camerachange",e.handleCameraChanged),i.on("camerachange",(function(){setTimeout((function(){return e.handleAfterMapChange()}))})),e.map=i,setTimeout((function(){t()}),10)}};tS||d?tS&&window.AMap||d?n():nS.push(n):(h===eS&&console.warn("%c".concat(e.configService.getSceneWarninfo("MapToken"),"!"),"color: #873bf4;font-weigh:900;font-size: 16px;"),tS=!0,v.push("Map3D"),Mx.load({key:h,version:"1.4.15",plugins:v}).then((function(){n(),nS.length&&(nS.forEach((function(e){return e()})),nS=[])})).catch((function(e){throw new Error(e)})))}));case 3:e.viewport=new Yx;case 4:case"end":return t.stop()}}),t)})))()}},{key:"meterToCoord",value:function(e,t){var n=AMap.GeometryUtil.distance(v(AMap.LngLat,r(e)),v(AMap.LngLat,r(t))),i=a(this.lngLatToCoord(e),2),o=i[0],s=i[1],u=a(this.lngLatToCoord(t),2),c=u[0],l=u[1];return Math.sqrt(Math.pow(o-c,2)+Math.pow(s-l,2))/n}},{key:"updateView",value:function(e){}},{key:"getOverlayContainer",value:function(){}},{key:"exportMap",value:function(e){var t,n=null===(t=this.getContainer())||void 0===t?void 0:t.getElementsByClassName("amap-layer")[0];return"jpg"===e?null==n?void 0:n.toDataURL("image/jpeg"):null==n?void 0:n.toDataURL("image/png")}},{key:"emit",value:function(e){for(var t,n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];(t=this.eventEmitter).emit.apply(t,[e].concat(r))}},{key:"once",value:function(e){for(var t,n=arguments.length,r=new Array(n>1?n-1:0),i=1;i<n;i++)r[i-1]=arguments[i];(t=this.eventEmitter).once.apply(t,[e].concat(r))}},{key:"destroy",value:function(){var e;null===(e=this.$mapContainer)||void 0===e||null===(e=e.parentNode)||void 0===e||e.removeChild(this.$mapContainer),delete window.initAMap;var t=document.getElementById("amap-script");t&&document.head.removeChild(t),this.map.destroy()}},{key:"getMapContainer",value:function(){return this.$mapContainer}},{key:"onCameraChanged",value:function(e){this.cameraChangedCallback=e}},{key:"handleAfterMapChange",value:function(){this.emit("mapAfterFrameChange")}},{key:"creatMapContainer",value:function(e){var t=e;"string"==typeof e&&(t=document.getElementById(e));var n=document.createElement("div");return n.style.cssText+="\n       position: absolute;\n       top: 0;\n       height: 100%;\n       width: 100%;\n     ",n.id="l7_amap_div"+Jx++,t.appendChild(n),n}}])}(),iS=function(){return c((function e(){f(this,e),ne(this,"projectionMatrix",jc()),ne(this,"viewMatrix",jc()),ne(this,"viewProjectionMatrix",jc()),ne(this,"ViewProjectionMatrixUncentered",jc()),ne(this,"viewUncenteredMatrix",jc()),ne(this,"zoom",void 0),ne(this,"center",void 0)}),[{key:"syncWithMapCamera",value:function(e){var t=e.zoom,n=void 0===t?1:t,i=e.center,o=void 0===i?[0,0]:i,a=e.offsetOrigin,s=void 0===a?[0,0]:a,u=e.cameraPosition,c=void 0===u?[0,0,0]:u,l=e.up,f=void 0===l?[0,1,0]:l,h=e.lookAt,d=void 0===h?[0,0,0]:h,p=e.aspect,v=void 0===p?1:p,m=e.near,g=void 0===m?.1:m,_=e.far,y=void 0===_?1e3:_,E=e.fov,b=void 0===E?45:E;this.zoom=n,this.center=o,Qc(this.projectionMatrix,b/180*Math.PI,v,g,y);var A,x,S=el.apply(void 0,r(c)),T=el.apply(void 0,r(d)),R=el.apply(void 0,r(f));!function(e,t,n,r){var i,o,a,s,u,c,l,f,h,d,p=t[0],v=t[1],m=t[2],g=r[0],_=r[1],y=r[2],E=n[0],b=n[1],A=n[2];Math.abs(p-E)<Gc&&Math.abs(v-b)<Gc&&Math.abs(m-A)<Gc?function(e){e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1}(e):(l=p-E,f=v-b,h=m-A,i=_*(h*=d=1/Math.hypot(l,f,h))-y*(f*=d),o=y*(l*=d)-g*h,a=g*f-_*l,(d=Math.hypot(i,o,a))?(i*=d=1/d,o*=d,a*=d):(i=0,o=0,a=0),s=f*a-h*o,u=h*i-l*a,c=l*o-f*i,(d=Math.hypot(s,u,c))?(s*=d=1/d,u*=d,c*=d):(s=0,u=0,c=0),e[0]=i,e[1]=s,e[2]=l,e[3]=0,e[4]=o,e[5]=u,e[6]=f,e[7]=0,e[8]=a,e[9]=c,e[10]=h,e[11]=0,e[12]=-(i*p+o*v+a*m),e[13]=-(s*p+u*v+c*m),e[14]=-(l*p+f*v+h*m),e[15]=1)}(this.viewMatrix,S,T,R),this.viewUncenteredMatrix=(A=this.viewMatrix,(x=new zc(16))[0]=A[0],x[1]=A[1],x[2]=A[2],x[3]=A[3],x[4]=A[4],x[5]=A[5],x[6]=A[6],x[7]=A[7],x[8]=A[8],x[9]=A[9],x[10]=A[10],x[11]=A[11],x[12]=A[12],x[13]=A[13],x[14]=A[14],x[15]=A[15],x),Wc(this.viewMatrix,this.viewMatrix,el(-s[0],s[1],0)),Xc(this.viewProjectionMatrix,this.projectionMatrix,this.viewMatrix),Xc(this.ViewProjectionMatrixUncentered,this.projectionMatrix,this.viewMatrix)}},{key:"getZoom",value:function(){return this.zoom}},{key:"getZoomScale",value:function(){return 1048576}},{key:"getCenter",value:function(){var e=a(this.center,2);return[e[0],e[1]]}},{key:"getProjectionMatrix",value:function(){return this.projectionMatrix}},{key:"getModelMatrix",value:function(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}},{key:"getViewMatrix",value:function(){return this.viewMatrix}},{key:"getViewMatrixUncentered",value:function(){return this.viewUncenteredMatrix}},{key:"getViewProjectionMatrix",value:function(){return this.viewProjectionMatrix}},{key:"getViewProjectionMatrixUncentered",value:function(){return this.ViewProjectionMatrixUncentered}},{key:"getFocalDistance",value:function(){return 1.2}},{key:"projectFlat",value:function(e){var t=85.0511287798,n=Math.max(Math.min(t,e[1]),-t),r=256<<20,i=Math.PI/180,o=e[0]*i,a=n*i;a=Math.log(Math.tan(Math.PI/4+a/2));return[o=r*(.5/Math.PI*o+.5)-215440491,a=-(r*(-.5/Math.PI*a+(i=.5))-106744817)]}}])}(),oS=["id","style","minZoom","maxZoom","token","mapInstance","plugin","version"];!function(e,t){var n="undefined"!=typeof my&&!!my&&"function"==typeof my.showToast&&!0!==my.isFRM,r="undefined"!=typeof wx&&null!==wx&&(void 0!==wx.request||void 0!==wx.miniProgram);if(!n&&!r&&(t||(t=document),t)){var i=t.head||t.getElementsByTagName("head")[0];if(!i){i=t.createElement("head");var o=t.body||t.getElementsByTagName("body")[0];o?o.parentNode.insertBefore(i,o):t.documentElement.appendChild(i)}var a=t.createElement("style");a.type="text/css",a.styleSheet?a.styleSheet.cssText=e:a.appendChild(t.createTextNode(e)),i.appendChild(a)}}(".amap-logo {\n  display: none !important;\n}\n.amap-copyright {\n  display: none !important;\n}\n.amap-overlays {\n  z-index: 3 !important;\n}\n");var aS=[108.92361,34.54083];window.forceWebGL=!0;var sS="f59bcf249433f8b05caaee19f349b3d7",uS=function(e){function t(){var e;f(this,t);for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];return e=h(this,t,[].concat(r)),ne(e,"version","GAODE2.x"),ne(e,"sceneCenter",void 0),ne(e,"sceneCenterMercator",void 0),ne(e,"viewport",void 0),ne(e,"handleViewChanged",(function(t){var n=e.map.customCoords.getCameraParams(),r=n.fov,i=n.near,o=n.far,a=n.aspect,s=n.position,u=n.lookAt,c=n.up;e.emit("mapchange");var l=e.map.customCoords.getCenter();e.cameraChangedCallback&&(e.viewport.syncWithMapCamera({aspect:a,far:o,fov:r,cameraPosition:s,lookAt:u,up:c,near:i,zoom:e.map.getZoom()-1,center:l,offsetOrigin:[s[0],s[1]]}),e.coordinateSystemService.setCoordinateSystem(tc.P20_2),e.cameraChangedCallback(e.viewport))})),e}return d(t,e),c(t,[{key:"setCustomCoordCenter",value:function(e){this.sceneCenter=e,this.sceneCenterMercator=$i.apply(void 0,r(e))}},{key:"getCustomCoordCenter",value:function(){return this.sceneCenterMercator}},{key:"lngLatToCoordByLayer",value:function(e,t){var n=t||this.sceneCenterMercator,r=this._sub($i(e[0],e[1]),n);return e[2]&&r.push(e[2]),r}},{key:"coordToAMap2RelativeCoordinates",value:function(e,t){var n=this,r=$i(t[0],t[1]);return"number"==typeof e[0]?this.lngLatToCoordByLayer(e,r):e.map((function(e){return Array.isArray(e)&&"number"==typeof e[0]?n.lngLatToCoordByLayer(e,r):e.map((function(e){return n.lngLatToCoordByLayer(e,r)}))}))}},{key:"setCoordCenter",value:function(e){this.map.customCoords.setCenter(e||aS),this.setCustomCoordCenter(e||aS)}},{key:"lngLatToCoord",value:function(e){return this.sceneCenter||(this.map.customCoords.setCenter(e),this.setCustomCoordCenter(e)),this._sub($i(e[0],e[1]),this.sceneCenterMercator)}},{key:"lngLatToCoords",value:function(e){var t=this;return e.map((function(e){return"number"==typeof e[0]?t.lngLatToCoord(e):e.map((function(e){return t.lngLatToCoord(e)}))}))}},{key:"addMarkerContainer",value:function(){if(this.map){var e=this.map.getContainer();if(null!==e){var t=e.getElementsByClassName("amap-maps")[0];t.style.zIndex="auto",this.markerContainer=Di("div","l7-marker-container2",t)}}}},{key:"updateView",value:function(e){}},{key:"getOverlayContainer",value:function(){}},{key:"getType",value:function(){return"amap2"}},{key:"getBounds",value:function(){var e=this.map.getBounds(),t=e.getNorthEast(),n=e.getSouthWest(),r=this.getCenter(),i=r.lng>t.getLng()||r.lng<n.getLng()?180-t.getLng():t.getLng();return[[r.lng<n.getLng()?n.getLng()-180:n.getLng(),n.getLat()],[i,t.getLat()]]}},{key:"getMinZoom",value:function(){return this.map.getZooms()[0]-1}},{key:"getMaxZoom",value:function(){return this.map.getZooms()[1]-1}},{key:"lngLatToContainer",value:function(e){var t=this.map.lngLatToContainer(e);return{x:t.getX(),y:t.getY()}}},{key:"lngLatToPixel",value:function(e){var t=this.map.lngLatToPixel(new AMap.LngLat(e[0],e[1]));return{x:t.getX(),y:t.getY()}}},{key:"getModelMatrix",value:function(e,t,n){var r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[1,1,1],i=this.map.customCoords.lngLatToCoord(e),o=jc();return Wc(o,o,el(i[0],i[1],t)),Yc(o,o,el(r[0],r[1],r[2])),Zc(o,o,n[0]),qc(o,o,n[1]),Kc(o,o,n[2]),o}},{key:"init",value:function(){var e=this;return ie(i().mark((function t(){var n,r,o,a,s,u,c,l,f,h,d,p,v,m,g,_,y,E,b,A,x;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(n=e.config,r=n.id,o=n.style,a=void 0===o?"light":o,s=n.minZoom,u=void 0===s?0:s,c=n.maxZoom,l=void 0===c?24:c,f=n.token,h=void 0===f?sS:f,d=n.mapInstance,p=n.plugin,v=void 0===p?[]:p,m=n.version,void 0===m?"2.0":m,g=oe(n,oS),e.viewport=new iS,window.AMap||d){t.next=6;break}return v.push("Map3D"),t.next=6,Mx.load({key:h,version:"2.0",plugins:v});case 6:d?(e.map=d,e.$mapContainer=e.map.getContainer(),y=e.map.getCenter(),null===(_=e.map.customCoords)||void 0===_||_.setCenter([y.lng,y.lat]),e.setCustomCoordCenter([y.lng,y.lat]),e.map.on("viewchange",e.handleViewChanged)):(e.$mapContainer=e.creatMapContainer(r),(b=re({mapStyle:e.getMapStyleValue(a),zooms:[u,l],viewMode:"3D"},g)).zoom&&(b.zoom+=1),h===sS&&(window._AMapSecurityConfig={securityJsCode:"2653011adeb04230b3a26cc9a780a800"},console.warn("%c".concat(e.configService.getSceneWarninfo("MapToken"),"!"),"color: #873bf4;font-weigh:900;font-size: 16px;")),A=new AMap.Map(e.$mapContainer,b),e.map=A,x=A.getCenter(),null===(E=e.map.customCoords)||void 0===E||E.setCenter([x.lng,x.lat]),e.setCustomCoordCenter([x.lng,x.lat]),A.on("viewchange",e.handleViewChanged)),e.initViewPort();case 8:case"end":return t.stop()}}),t)})))()}},{key:"getMapContainer",value:function(){return this.$mapContainer}},{key:"onCameraChanged",value:function(e){this.cameraChangedCallback=e}},{key:"initViewPort",value:function(){var e,t=(null===(e=this.map.customCoords)||void 0===e?void 0:e.getCameraParams())||{},n=t.fov,r=t.near,i=t.far,o=t.aspect,a=t.position,s=t.lookAt,u=t.up;this.emit("mapchange");var c=this.map.customCoords.getCenter(),l=this.map.getZoom();this.cameraChangedCallback&&(this.viewport.syncWithMapCamera({aspect:o,far:i,fov:n,cameraPosition:a,lookAt:s,near:r,up:u,zoom:l-1,center:c,offsetOrigin:[a[0],a[1]]}),this.coordinateSystemService.setCoordinateSystem(tc.P20_2),this.cameraChangedCallback(this.viewport))}},{key:"_sub",value:function(e,t){var n=[0,0];return n[0]=e[0]-t[0],n[1]=e[1]-t[1],n}}])}(rS),cS=function(e){function t(){return f(this,t),h(this,t,arguments)}return d(t,e),c(t,[{key:"getServiceConstructor",value:function(){return uS}}])}(Rx),lS=function(e){return null==e},fS={}.toString,hS=function(e,t){return fS.call(e)==="[object "+t+"]"},dS=function(e,t,n){return e<t?t:e>n?n:e},pS=function(e){return hS(e,"Number")},vS=function(e,t){return vS=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},vS(e,t)};function mS(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function n(){this.constructor=e}vS(e,t),e.prototype=null===t?Object.create(t):(n.prototype=t.prototype,new n)}var gS=function(){return gS=Object.assign||function(e){for(var t,n=1,r=arguments.length;n<r;n++)for(var i in t=arguments[n])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},gS.apply(this,arguments)};function _S(e,t,n,r){return new(n||(n=Promise))((function(i,o){function a(e){try{u(r.next(e))}catch(t){o(t)}}function s(e){try{u(r.throw(e))}catch(t){o(t)}}function u(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(a,s)}u((r=r.apply(e,t||[])).next())}))}function yS(e,t){var n,r,i,o,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:s(0),throw:s(1),return:s(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function s(s){return function(u){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;o&&(o=0,s[0]&&(a=0)),a;)try{if(n=1,r&&(i=2&s[0]?r.return:s[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,s[1])).done)return i;switch(r=0,i&&(s=[2&s[0],i.value]),s[0]){case 0:case 1:i=s;break;case 4:return a.label++,{value:s[1],done:!1};case 5:a.label++,r=s[1],s=[0];continue;case 7:s=a.ops.pop(),a.trys.pop();continue;default:if(!(i=a.trys,(i=i.length>0&&i[i.length-1])||6!==s[0]&&2!==s[0])){a=0;continue}if(3===s[0]&&(!i||s[1]>i[0]&&s[1]<i[3])){a.label=s[1];break}if(6===s[0]&&a.label<i[1]){a.label=i[1],i=s;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(s);break}i[2]&&a.ops.pop(),a.trys.pop();continue}s=t.call(e,a)}catch(u){s=[6,u],r=0}finally{n=i=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,u])}}}function ES(e){var t="function"==typeof Symbol&&Symbol.iterator,n=t&&e[t],r=0;if(n)return n.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}function bS(e,t){var n="function"==typeof Symbol&&e[Symbol.iterator];if(!n)return e;var r,i,o=n.call(e),a=[];try{for(;(void 0===t||t-- >0)&&!(r=o.next()).done;)a.push(r.value)}catch(s){i={error:s}}finally{try{r&&!r.done&&(n=o.return)&&n.call(o)}finally{if(i)throw i.error}}return a}function AS(e,t,n){if(n||2===arguments.length)for(var r,i=0,o=t.length;i<o;i++)!r&&i in t||(r||(r=Array.prototype.slice.call(t,0,i)),r[i]=t[i]);return e.concat(r||Array.prototype.slice.call(t))}"function"==typeof SuppressedError&&SuppressedError;var xS={exports:{}};!function(e){var t=Object.prototype.hasOwnProperty,n="~";function r(){}function i(e,t,n){this.fn=e,this.context=t,this.once=n||!1}function o(e,t,r,o,a){if("function"!=typeof r)throw new TypeError("The listener must be a function");var s=new i(r,o||e,a),u=n?n+t:t;return e._events[u]?e._events[u].fn?e._events[u]=[e._events[u],s]:e._events[u].push(s):(e._events[u]=s,e._eventsCount++),e}function a(e,t){0==--e._eventsCount?e._events=new r:delete e._events[t]}function s(){this._events=new r,this._eventsCount=0}Object.create&&(r.prototype=Object.create(null),(new r).__proto__||(n=!1)),s.prototype.eventNames=function(){var e,r,i=[];if(0===this._eventsCount)return i;for(r in e=this._events)t.call(e,r)&&i.push(n?r.slice(1):r);return Object.getOwnPropertySymbols?i.concat(Object.getOwnPropertySymbols(e)):i},s.prototype.listeners=function(e){var t=n?n+e:e,r=this._events[t];if(!r)return[];if(r.fn)return[r.fn];for(var i=0,o=r.length,a=new Array(o);i<o;i++)a[i]=r[i].fn;return a},s.prototype.listenerCount=function(e){var t=n?n+e:e,r=this._events[t];return r?r.fn?1:r.length:0},s.prototype.emit=function(e,t,r,i,o,a){var s=n?n+e:e;if(!this._events[s])return!1;var u,c,l=this._events[s],f=arguments.length;if(l.fn){switch(l.once&&this.removeListener(e,l.fn,void 0,!0),f){case 1:return l.fn.call(l.context),!0;case 2:return l.fn.call(l.context,t),!0;case 3:return l.fn.call(l.context,t,r),!0;case 4:return l.fn.call(l.context,t,r,i),!0;case 5:return l.fn.call(l.context,t,r,i,o),!0;case 6:return l.fn.call(l.context,t,r,i,o,a),!0}for(c=1,u=new Array(f-1);c<f;c++)u[c-1]=arguments[c];l.fn.apply(l.context,u)}else{var h,d=l.length;for(c=0;c<d;c++)switch(l[c].once&&this.removeListener(e,l[c].fn,void 0,!0),f){case 1:l[c].fn.call(l[c].context);break;case 2:l[c].fn.call(l[c].context,t);break;case 3:l[c].fn.call(l[c].context,t,r);break;case 4:l[c].fn.call(l[c].context,t,r,i);break;default:if(!u)for(h=1,u=new Array(f-1);h<f;h++)u[h-1]=arguments[h];l[c].fn.apply(l[c].context,u)}}return!0},s.prototype.on=function(e,t,n){return o(this,e,t,n,!1)},s.prototype.once=function(e,t,n){return o(this,e,t,n,!0)},s.prototype.removeListener=function(e,t,r,i){var o=n?n+e:e;if(!this._events[o])return this;if(!t)return a(this,o),this;var s=this._events[o];if(s.fn)s.fn!==t||i&&!s.once||r&&s.context!==r||a(this,o);else{for(var u=0,c=[],l=s.length;u<l;u++)(s[u].fn!==t||i&&!s[u].once||r&&s[u].context!==r)&&c.push(s[u]);c.length?this._events[o]=1===c.length?c[0]:c:a(this,o)}return this},s.prototype.removeAllListeners=function(e){var t;return e?(t=n?n+e:e,this._events[t]&&a(this,t)):(this._events=new r,this._eventsCount=0),this},s.prototype.off=s.prototype.removeListener,s.prototype.addListener=s.prototype.on,s.prefixed=n,s.EventEmitter=s,e.exports=s}(xS);var SS,TS,RS,CS,MS,wS,LS,OS,kS,NS,IS,PS,DS,FS,BS,US,GS,zS,jS,VS,HS,XS,WS,YS,ZS,qS,KS,QS=xS.exports;function $S(e,t,n){return e<<16|t<<8|n}function JS(e){return e>>>8&255}function eT(e){return e>>>16&255}function tT(e){return 255&e}function nT(e){switch(e){case YS.F32:case YS.U32:case YS.S32:return 4;case YS.U16:case YS.S16:case YS.F16:return 2;case YS.U8:case YS.S8:return 1;default:throw new Error("whoops")}}function rT(e){return nT(eT(e))}function iT(e){var t=tT(e);if(t&qS.Depth)return VS.Depth;if(t&qS.Normalized)return VS.Float;var n=eT(e);if(n===YS.F16||n===YS.F32)return VS.Float;if(n===YS.U8||n===YS.U16||n===YS.U32)return VS.Uint;if(n===YS.S8||n===YS.S16||n===YS.S32)return VS.Sint;throw new Error("whoops")}function oT(e,t){if(void 0===t&&(t=""),!e)throw new Error("Assert fail: ".concat(t))}function aT(e){if(null!=e)return e;throw new Error("Missing object")}function sT(e,t){return e.r===t.r&&e.g===t.g&&e.b===t.b&&e.a===t.a}function uT(e,t){e.r=t.r,e.g=t.g,e.b=t.b,e.a=t.a}function cT(e){return{r:e.r,g:e.g,b:e.b,a:e.a}}function lT(e,t,n,r){return void 0===r&&(r=1),{r:e,g:t,b:n,a:r}}!function(e){e[e.DEPTH_BUFFER_BIT=256]="DEPTH_BUFFER_BIT",e[e.STENCIL_BUFFER_BIT=1024]="STENCIL_BUFFER_BIT",e[e.COLOR_BUFFER_BIT=16384]="COLOR_BUFFER_BIT",e[e.POINTS=0]="POINTS",e[e.LINES=1]="LINES",e[e.LINE_LOOP=2]="LINE_LOOP",e[e.LINE_STRIP=3]="LINE_STRIP",e[e.TRIANGLES=4]="TRIANGLES",e[e.TRIANGLE_STRIP=5]="TRIANGLE_STRIP",e[e.TRIANGLE_FAN=6]="TRIANGLE_FAN",e[e.ZERO=0]="ZERO",e[e.ONE=1]="ONE",e[e.SRC_COLOR=768]="SRC_COLOR",e[e.ONE_MINUS_SRC_COLOR=769]="ONE_MINUS_SRC_COLOR",e[e.SRC_ALPHA=770]="SRC_ALPHA",e[e.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",e[e.DST_ALPHA=772]="DST_ALPHA",e[e.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",e[e.DST_COLOR=774]="DST_COLOR",e[e.ONE_MINUS_DST_COLOR=775]="ONE_MINUS_DST_COLOR",e[e.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE",e[e.CONSTANT_COLOR=32769]="CONSTANT_COLOR",e[e.ONE_MINUS_CONSTANT_COLOR=32770]="ONE_MINUS_CONSTANT_COLOR",e[e.CONSTANT_ALPHA=32771]="CONSTANT_ALPHA",e[e.ONE_MINUS_CONSTANT_ALPHA=32772]="ONE_MINUS_CONSTANT_ALPHA",e[e.FUNC_ADD=32774]="FUNC_ADD",e[e.FUNC_SUBTRACT=32778]="FUNC_SUBTRACT",e[e.FUNC_REVERSE_SUBTRACT=32779]="FUNC_REVERSE_SUBTRACT",e[e.BLEND_EQUATION=32777]="BLEND_EQUATION",e[e.BLEND_EQUATION_RGB=32777]="BLEND_EQUATION_RGB",e[e.BLEND_EQUATION_ALPHA=34877]="BLEND_EQUATION_ALPHA",e[e.BLEND_DST_RGB=32968]="BLEND_DST_RGB",e[e.BLEND_SRC_RGB=32969]="BLEND_SRC_RGB",e[e.BLEND_DST_ALPHA=32970]="BLEND_DST_ALPHA",e[e.BLEND_SRC_ALPHA=32971]="BLEND_SRC_ALPHA",e[e.BLEND_COLOR=32773]="BLEND_COLOR",e[e.ARRAY_BUFFER_BINDING=34964]="ARRAY_BUFFER_BINDING",e[e.ELEMENT_ARRAY_BUFFER_BINDING=34965]="ELEMENT_ARRAY_BUFFER_BINDING",e[e.LINE_WIDTH=2849]="LINE_WIDTH",e[e.ALIASED_POINT_SIZE_RANGE=33901]="ALIASED_POINT_SIZE_RANGE",e[e.ALIASED_LINE_WIDTH_RANGE=33902]="ALIASED_LINE_WIDTH_RANGE",e[e.CULL_FACE_MODE=2885]="CULL_FACE_MODE",e[e.FRONT_FACE=2886]="FRONT_FACE",e[e.DEPTH_RANGE=2928]="DEPTH_RANGE",e[e.DEPTH_WRITEMASK=2930]="DEPTH_WRITEMASK",e[e.DEPTH_CLEAR_VALUE=2931]="DEPTH_CLEAR_VALUE",e[e.DEPTH_FUNC=2932]="DEPTH_FUNC",e[e.STENCIL_CLEAR_VALUE=2961]="STENCIL_CLEAR_VALUE",e[e.STENCIL_FUNC=2962]="STENCIL_FUNC",e[e.STENCIL_FAIL=2964]="STENCIL_FAIL",e[e.STENCIL_PASS_DEPTH_FAIL=2965]="STENCIL_PASS_DEPTH_FAIL",e[e.STENCIL_PASS_DEPTH_PASS=2966]="STENCIL_PASS_DEPTH_PASS",e[e.STENCIL_REF=2967]="STENCIL_REF",e[e.STENCIL_VALUE_MASK=2963]="STENCIL_VALUE_MASK",e[e.STENCIL_WRITEMASK=2968]="STENCIL_WRITEMASK",e[e.STENCIL_BACK_FUNC=34816]="STENCIL_BACK_FUNC",e[e.STENCIL_BACK_FAIL=34817]="STENCIL_BACK_FAIL",e[e.STENCIL_BACK_PASS_DEPTH_FAIL=34818]="STENCIL_BACK_PASS_DEPTH_FAIL",e[e.STENCIL_BACK_PASS_DEPTH_PASS=34819]="STENCIL_BACK_PASS_DEPTH_PASS",e[e.STENCIL_BACK_REF=36003]="STENCIL_BACK_REF",e[e.STENCIL_BACK_VALUE_MASK=36004]="STENCIL_BACK_VALUE_MASK",e[e.STENCIL_BACK_WRITEMASK=36005]="STENCIL_BACK_WRITEMASK",e[e.VIEWPORT=2978]="VIEWPORT",e[e.SCISSOR_BOX=3088]="SCISSOR_BOX",e[e.COLOR_CLEAR_VALUE=3106]="COLOR_CLEAR_VALUE",e[e.COLOR_WRITEMASK=3107]="COLOR_WRITEMASK",e[e.UNPACK_ALIGNMENT=3317]="UNPACK_ALIGNMENT",e[e.PACK_ALIGNMENT=3333]="PACK_ALIGNMENT",e[e.MAX_TEXTURE_SIZE=3379]="MAX_TEXTURE_SIZE",e[e.MAX_VIEWPORT_DIMS=3386]="MAX_VIEWPORT_DIMS",e[e.SUBPIXEL_BITS=3408]="SUBPIXEL_BITS",e[e.RED_BITS=3410]="RED_BITS",e[e.GREEN_BITS=3411]="GREEN_BITS",e[e.BLUE_BITS=3412]="BLUE_BITS",e[e.ALPHA_BITS=3413]="ALPHA_BITS",e[e.DEPTH_BITS=3414]="DEPTH_BITS",e[e.STENCIL_BITS=3415]="STENCIL_BITS",e[e.POLYGON_OFFSET_UNITS=10752]="POLYGON_OFFSET_UNITS",e[e.POLYGON_OFFSET_FACTOR=32824]="POLYGON_OFFSET_FACTOR",e[e.TEXTURE_BINDING_2D=32873]="TEXTURE_BINDING_2D",e[e.SAMPLE_BUFFERS=32936]="SAMPLE_BUFFERS",e[e.SAMPLES=32937]="SAMPLES",e[e.SAMPLE_COVERAGE_VALUE=32938]="SAMPLE_COVERAGE_VALUE",e[e.SAMPLE_COVERAGE_INVERT=32939]="SAMPLE_COVERAGE_INVERT",e[e.COMPRESSED_TEXTURE_FORMATS=34467]="COMPRESSED_TEXTURE_FORMATS",e[e.VENDOR=7936]="VENDOR",e[e.RENDERER=7937]="RENDERER",e[e.VERSION=7938]="VERSION",e[e.IMPLEMENTATION_COLOR_READ_TYPE=35738]="IMPLEMENTATION_COLOR_READ_TYPE",e[e.IMPLEMENTATION_COLOR_READ_FORMAT=35739]="IMPLEMENTATION_COLOR_READ_FORMAT",e[e.BROWSER_DEFAULT_WEBGL=37444]="BROWSER_DEFAULT_WEBGL",e[e.STATIC_DRAW=35044]="STATIC_DRAW",e[e.STREAM_DRAW=35040]="STREAM_DRAW",e[e.DYNAMIC_DRAW=35048]="DYNAMIC_DRAW",e[e.ARRAY_BUFFER=34962]="ARRAY_BUFFER",e[e.ELEMENT_ARRAY_BUFFER=34963]="ELEMENT_ARRAY_BUFFER",e[e.BUFFER_SIZE=34660]="BUFFER_SIZE",e[e.BUFFER_USAGE=34661]="BUFFER_USAGE",e[e.CURRENT_VERTEX_ATTRIB=34342]="CURRENT_VERTEX_ATTRIB",e[e.VERTEX_ATTRIB_ARRAY_ENABLED=34338]="VERTEX_ATTRIB_ARRAY_ENABLED",e[e.VERTEX_ATTRIB_ARRAY_SIZE=34339]="VERTEX_ATTRIB_ARRAY_SIZE",e[e.VERTEX_ATTRIB_ARRAY_STRIDE=34340]="VERTEX_ATTRIB_ARRAY_STRIDE",e[e.VERTEX_ATTRIB_ARRAY_TYPE=34341]="VERTEX_ATTRIB_ARRAY_TYPE",e[e.VERTEX_ATTRIB_ARRAY_NORMALIZED=34922]="VERTEX_ATTRIB_ARRAY_NORMALIZED",e[e.VERTEX_ATTRIB_ARRAY_POINTER=34373]="VERTEX_ATTRIB_ARRAY_POINTER",e[e.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING=34975]="VERTEX_ATTRIB_ARRAY_BUFFER_BINDING",e[e.CULL_FACE=2884]="CULL_FACE",e[e.FRONT=1028]="FRONT",e[e.BACK=1029]="BACK",e[e.FRONT_AND_BACK=1032]="FRONT_AND_BACK",e[e.BLEND=3042]="BLEND",e[e.DEPTH_TEST=2929]="DEPTH_TEST",e[e.DITHER=3024]="DITHER",e[e.POLYGON_OFFSET_FILL=32823]="POLYGON_OFFSET_FILL",e[e.SAMPLE_ALPHA_TO_COVERAGE=32926]="SAMPLE_ALPHA_TO_COVERAGE",e[e.SAMPLE_COVERAGE=32928]="SAMPLE_COVERAGE",e[e.SCISSOR_TEST=3089]="SCISSOR_TEST",e[e.STENCIL_TEST=2960]="STENCIL_TEST",e[e.NO_ERROR=0]="NO_ERROR",e[e.INVALID_ENUM=1280]="INVALID_ENUM",e[e.INVALID_VALUE=1281]="INVALID_VALUE",e[e.INVALID_OPERATION=1282]="INVALID_OPERATION",e[e.OUT_OF_MEMORY=1285]="OUT_OF_MEMORY",e[e.CONTEXT_LOST_WEBGL=37442]="CONTEXT_LOST_WEBGL",e[e.CW=2304]="CW",e[e.CCW=2305]="CCW",e[e.DONT_CARE=4352]="DONT_CARE",e[e.FASTEST=4353]="FASTEST",e[e.NICEST=4354]="NICEST",e[e.GENERATE_MIPMAP_HINT=33170]="GENERATE_MIPMAP_HINT",e[e.BYTE=5120]="BYTE",e[e.UNSIGNED_BYTE=5121]="UNSIGNED_BYTE",e[e.SHORT=5122]="SHORT",e[e.UNSIGNED_SHORT=5123]="UNSIGNED_SHORT",e[e.INT=5124]="INT",e[e.UNSIGNED_INT=5125]="UNSIGNED_INT",e[e.FLOAT=5126]="FLOAT",e[e.DOUBLE=5130]="DOUBLE",e[e.DEPTH_COMPONENT=6402]="DEPTH_COMPONENT",e[e.ALPHA=6406]="ALPHA",e[e.RGB=6407]="RGB",e[e.RGBA=6408]="RGBA",e[e.LUMINANCE=6409]="LUMINANCE",e[e.LUMINANCE_ALPHA=6410]="LUMINANCE_ALPHA",e[e.UNSIGNED_SHORT_4_4_4_4=32819]="UNSIGNED_SHORT_4_4_4_4",e[e.UNSIGNED_SHORT_5_5_5_1=32820]="UNSIGNED_SHORT_5_5_5_1",e[e.UNSIGNED_SHORT_5_6_5=33635]="UNSIGNED_SHORT_5_6_5",e[e.FRAGMENT_SHADER=35632]="FRAGMENT_SHADER",e[e.VERTEX_SHADER=35633]="VERTEX_SHADER",e[e.COMPILE_STATUS=35713]="COMPILE_STATUS",e[e.DELETE_STATUS=35712]="DELETE_STATUS",e[e.LINK_STATUS=35714]="LINK_STATUS",e[e.VALIDATE_STATUS=35715]="VALIDATE_STATUS",e[e.ATTACHED_SHADERS=35717]="ATTACHED_SHADERS",e[e.ACTIVE_ATTRIBUTES=35721]="ACTIVE_ATTRIBUTES",e[e.ACTIVE_UNIFORMS=35718]="ACTIVE_UNIFORMS",e[e.MAX_VERTEX_ATTRIBS=34921]="MAX_VERTEX_ATTRIBS",e[e.MAX_VERTEX_UNIFORM_VECTORS=36347]="MAX_VERTEX_UNIFORM_VECTORS",e[e.MAX_VARYING_VECTORS=36348]="MAX_VARYING_VECTORS",e[e.MAX_COMBINED_TEXTURE_IMAGE_UNITS=35661]="MAX_COMBINED_TEXTURE_IMAGE_UNITS",e[e.MAX_VERTEX_TEXTURE_IMAGE_UNITS=35660]="MAX_VERTEX_TEXTURE_IMAGE_UNITS",e[e.MAX_TEXTURE_IMAGE_UNITS=34930]="MAX_TEXTURE_IMAGE_UNITS",e[e.MAX_FRAGMENT_UNIFORM_VECTORS=36349]="MAX_FRAGMENT_UNIFORM_VECTORS",e[e.SHADER_TYPE=35663]="SHADER_TYPE",e[e.SHADING_LANGUAGE_VERSION=35724]="SHADING_LANGUAGE_VERSION",e[e.CURRENT_PROGRAM=35725]="CURRENT_PROGRAM",e[e.NEVER=512]="NEVER",e[e.ALWAYS=519]="ALWAYS",e[e.LESS=513]="LESS",e[e.EQUAL=514]="EQUAL",e[e.LEQUAL=515]="LEQUAL",e[e.GREATER=516]="GREATER",e[e.GEQUAL=518]="GEQUAL",e[e.NOTEQUAL=517]="NOTEQUAL",e[e.KEEP=7680]="KEEP",e[e.REPLACE=7681]="REPLACE",e[e.INCR=7682]="INCR",e[e.DECR=7683]="DECR",e[e.INVERT=5386]="INVERT",e[e.INCR_WRAP=34055]="INCR_WRAP",e[e.DECR_WRAP=34056]="DECR_WRAP",e[e.NEAREST=9728]="NEAREST",e[e.LINEAR=9729]="LINEAR",e[e.NEAREST_MIPMAP_NEAREST=9984]="NEAREST_MIPMAP_NEAREST",e[e.LINEAR_MIPMAP_NEAREST=9985]="LINEAR_MIPMAP_NEAREST",e[e.NEAREST_MIPMAP_LINEAR=9986]="NEAREST_MIPMAP_LINEAR",e[e.LINEAR_MIPMAP_LINEAR=9987]="LINEAR_MIPMAP_LINEAR",e[e.TEXTURE_MAG_FILTER=10240]="TEXTURE_MAG_FILTER",e[e.TEXTURE_MIN_FILTER=10241]="TEXTURE_MIN_FILTER",e[e.TEXTURE_WRAP_S=10242]="TEXTURE_WRAP_S",e[e.TEXTURE_WRAP_T=10243]="TEXTURE_WRAP_T",e[e.TEXTURE_2D=3553]="TEXTURE_2D",e[e.TEXTURE=5890]="TEXTURE",e[e.TEXTURE_CUBE_MAP=34067]="TEXTURE_CUBE_MAP",e[e.TEXTURE_BINDING_CUBE_MAP=34068]="TEXTURE_BINDING_CUBE_MAP",e[e.TEXTURE_CUBE_MAP_POSITIVE_X=34069]="TEXTURE_CUBE_MAP_POSITIVE_X",e[e.TEXTURE_CUBE_MAP_NEGATIVE_X=34070]="TEXTURE_CUBE_MAP_NEGATIVE_X",e[e.TEXTURE_CUBE_MAP_POSITIVE_Y=34071]="TEXTURE_CUBE_MAP_POSITIVE_Y",e[e.TEXTURE_CUBE_MAP_NEGATIVE_Y=34072]="TEXTURE_CUBE_MAP_NEGATIVE_Y",e[e.TEXTURE_CUBE_MAP_POSITIVE_Z=34073]="TEXTURE_CUBE_MAP_POSITIVE_Z",e[e.TEXTURE_CUBE_MAP_NEGATIVE_Z=34074]="TEXTURE_CUBE_MAP_NEGATIVE_Z",e[e.MAX_CUBE_MAP_TEXTURE_SIZE=34076]="MAX_CUBE_MAP_TEXTURE_SIZE",e[e.TEXTURE0=33984]="TEXTURE0",e[e.ACTIVE_TEXTURE=34016]="ACTIVE_TEXTURE",e[e.REPEAT=10497]="REPEAT",e[e.CLAMP_TO_EDGE=33071]="CLAMP_TO_EDGE",e[e.MIRRORED_REPEAT=33648]="MIRRORED_REPEAT",e[e.TEXTURE_WIDTH=4096]="TEXTURE_WIDTH",e[e.TEXTURE_HEIGHT=4097]="TEXTURE_HEIGHT",e[e.FLOAT_VEC2=35664]="FLOAT_VEC2",e[e.FLOAT_VEC3=35665]="FLOAT_VEC3",e[e.FLOAT_VEC4=35666]="FLOAT_VEC4",e[e.INT_VEC2=35667]="INT_VEC2",e[e.INT_VEC3=35668]="INT_VEC3",e[e.INT_VEC4=35669]="INT_VEC4",e[e.BOOL=35670]="BOOL",e[e.BOOL_VEC2=35671]="BOOL_VEC2",e[e.BOOL_VEC3=35672]="BOOL_VEC3",e[e.BOOL_VEC4=35673]="BOOL_VEC4",e[e.FLOAT_MAT2=35674]="FLOAT_MAT2",e[e.FLOAT_MAT3=35675]="FLOAT_MAT3",e[e.FLOAT_MAT4=35676]="FLOAT_MAT4",e[e.SAMPLER_2D=35678]="SAMPLER_2D",e[e.SAMPLER_CUBE=35680]="SAMPLER_CUBE",e[e.LOW_FLOAT=36336]="LOW_FLOAT",e[e.MEDIUM_FLOAT=36337]="MEDIUM_FLOAT",e[e.HIGH_FLOAT=36338]="HIGH_FLOAT",e[e.LOW_INT=36339]="LOW_INT",e[e.MEDIUM_INT=36340]="MEDIUM_INT",e[e.HIGH_INT=36341]="HIGH_INT",e[e.FRAMEBUFFER=36160]="FRAMEBUFFER",e[e.RENDERBUFFER=36161]="RENDERBUFFER",e[e.RGBA4=32854]="RGBA4",e[e.RGB5_A1=32855]="RGB5_A1",e[e.RGB565=36194]="RGB565",e[e.DEPTH_COMPONENT16=33189]="DEPTH_COMPONENT16",e[e.STENCIL_INDEX=6401]="STENCIL_INDEX",e[e.STENCIL_INDEX8=36168]="STENCIL_INDEX8",e[e.DEPTH_STENCIL=34041]="DEPTH_STENCIL",e[e.RENDERBUFFER_WIDTH=36162]="RENDERBUFFER_WIDTH",e[e.RENDERBUFFER_HEIGHT=36163]="RENDERBUFFER_HEIGHT",e[e.RENDERBUFFER_INTERNAL_FORMAT=36164]="RENDERBUFFER_INTERNAL_FORMAT",e[e.RENDERBUFFER_RED_SIZE=36176]="RENDERBUFFER_RED_SIZE",e[e.RENDERBUFFER_GREEN_SIZE=36177]="RENDERBUFFER_GREEN_SIZE",e[e.RENDERBUFFER_BLUE_SIZE=36178]="RENDERBUFFER_BLUE_SIZE",e[e.RENDERBUFFER_ALPHA_SIZE=36179]="RENDERBUFFER_ALPHA_SIZE",e[e.RENDERBUFFER_DEPTH_SIZE=36180]="RENDERBUFFER_DEPTH_SIZE",e[e.RENDERBUFFER_STENCIL_SIZE=36181]="RENDERBUFFER_STENCIL_SIZE",e[e.FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE=36048]="FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE",e[e.FRAMEBUFFER_ATTACHMENT_OBJECT_NAME=36049]="FRAMEBUFFER_ATTACHMENT_OBJECT_NAME",e[e.FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL=36050]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL",e[e.FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE=36051]="FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE",e[e.COLOR_ATTACHMENT0=36064]="COLOR_ATTACHMENT0",e[e.DEPTH_ATTACHMENT=36096]="DEPTH_ATTACHMENT",e[e.STENCIL_ATTACHMENT=36128]="STENCIL_ATTACHMENT",e[e.DEPTH_STENCIL_ATTACHMENT=33306]="DEPTH_STENCIL_ATTACHMENT",e[e.NONE=0]="NONE",e[e.FRAMEBUFFER_COMPLETE=36053]="FRAMEBUFFER_COMPLETE",e[e.FRAMEBUFFER_INCOMPLETE_ATTACHMENT=36054]="FRAMEBUFFER_INCOMPLETE_ATTACHMENT",e[e.FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT=36055]="FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT",e[e.FRAMEBUFFER_INCOMPLETE_DIMENSIONS=36057]="FRAMEBUFFER_INCOMPLETE_DIMENSIONS",e[e.FRAMEBUFFER_UNSUPPORTED=36061]="FRAMEBUFFER_UNSUPPORTED",e[e.FRAMEBUFFER_BINDING=36006]="FRAMEBUFFER_BINDING",e[e.RENDERBUFFER_BINDING=36007]="RENDERBUFFER_BINDING",e[e.READ_FRAMEBUFFER=36008]="READ_FRAMEBUFFER",e[e.DRAW_FRAMEBUFFER=36009]="DRAW_FRAMEBUFFER",e[e.MAX_RENDERBUFFER_SIZE=34024]="MAX_RENDERBUFFER_SIZE",e[e.INVALID_FRAMEBUFFER_OPERATION=1286]="INVALID_FRAMEBUFFER_OPERATION",e[e.UNPACK_FLIP_Y_WEBGL=37440]="UNPACK_FLIP_Y_WEBGL",e[e.UNPACK_PREMULTIPLY_ALPHA_WEBGL=37441]="UNPACK_PREMULTIPLY_ALPHA_WEBGL",e[e.UNPACK_COLORSPACE_CONVERSION_WEBGL=37443]="UNPACK_COLORSPACE_CONVERSION_WEBGL",e[e.READ_BUFFER=3074]="READ_BUFFER",e[e.UNPACK_ROW_LENGTH=3314]="UNPACK_ROW_LENGTH",e[e.UNPACK_SKIP_ROWS=3315]="UNPACK_SKIP_ROWS",e[e.UNPACK_SKIP_PIXELS=3316]="UNPACK_SKIP_PIXELS",e[e.PACK_ROW_LENGTH=3330]="PACK_ROW_LENGTH",e[e.PACK_SKIP_ROWS=3331]="PACK_SKIP_ROWS",e[e.PACK_SKIP_PIXELS=3332]="PACK_SKIP_PIXELS",e[e.TEXTURE_BINDING_3D=32874]="TEXTURE_BINDING_3D",e[e.UNPACK_SKIP_IMAGES=32877]="UNPACK_SKIP_IMAGES",e[e.UNPACK_IMAGE_HEIGHT=32878]="UNPACK_IMAGE_HEIGHT",e[e.MAX_3D_TEXTURE_SIZE=32883]="MAX_3D_TEXTURE_SIZE",e[e.MAX_ELEMENTS_VERTICES=33e3]="MAX_ELEMENTS_VERTICES",e[e.MAX_ELEMENTS_INDICES=33001]="MAX_ELEMENTS_INDICES",e[e.MAX_TEXTURE_LOD_BIAS=34045]="MAX_TEXTURE_LOD_BIAS",e[e.MAX_FRAGMENT_UNIFORM_COMPONENTS=35657]="MAX_FRAGMENT_UNIFORM_COMPONENTS",e[e.MAX_VERTEX_UNIFORM_COMPONENTS=35658]="MAX_VERTEX_UNIFORM_COMPONENTS",e[e.MAX_ARRAY_TEXTURE_LAYERS=35071]="MAX_ARRAY_TEXTURE_LAYERS",e[e.MIN_PROGRAM_TEXEL_OFFSET=35076]="MIN_PROGRAM_TEXEL_OFFSET",e[e.MAX_PROGRAM_TEXEL_OFFSET=35077]="MAX_PROGRAM_TEXEL_OFFSET",e[e.MAX_VARYING_COMPONENTS=35659]="MAX_VARYING_COMPONENTS",e[e.FRAGMENT_SHADER_DERIVATIVE_HINT=35723]="FRAGMENT_SHADER_DERIVATIVE_HINT",e[e.RASTERIZER_DISCARD=35977]="RASTERIZER_DISCARD",e[e.VERTEX_ARRAY_BINDING=34229]="VERTEX_ARRAY_BINDING",e[e.MAX_VERTEX_OUTPUT_COMPONENTS=37154]="MAX_VERTEX_OUTPUT_COMPONENTS",e[e.MAX_FRAGMENT_INPUT_COMPONENTS=37157]="MAX_FRAGMENT_INPUT_COMPONENTS",e[e.MAX_SERVER_WAIT_TIMEOUT=37137]="MAX_SERVER_WAIT_TIMEOUT",e[e.MAX_ELEMENT_INDEX=36203]="MAX_ELEMENT_INDEX",e[e.RED=6403]="RED",e[e.RGB8=32849]="RGB8",e[e.RGBA8=32856]="RGBA8",e[e.RGB10_A2=32857]="RGB10_A2",e[e.TEXTURE_3D=32879]="TEXTURE_3D",e[e.TEXTURE_WRAP_R=32882]="TEXTURE_WRAP_R",e[e.TEXTURE_MIN_LOD=33082]="TEXTURE_MIN_LOD",e[e.TEXTURE_MAX_LOD=33083]="TEXTURE_MAX_LOD",e[e.TEXTURE_BASE_LEVEL=33084]="TEXTURE_BASE_LEVEL",e[e.TEXTURE_MAX_LEVEL=33085]="TEXTURE_MAX_LEVEL",e[e.TEXTURE_COMPARE_MODE=34892]="TEXTURE_COMPARE_MODE",e[e.TEXTURE_COMPARE_FUNC=34893]="TEXTURE_COMPARE_FUNC",e[e.SRGB=35904]="SRGB",e[e.SRGB8=35905]="SRGB8",e[e.SRGB8_ALPHA8=35907]="SRGB8_ALPHA8",e[e.COMPARE_REF_TO_TEXTURE=34894]="COMPARE_REF_TO_TEXTURE",e[e.RGBA32F=34836]="RGBA32F",e[e.RGB32F=34837]="RGB32F",e[e.RGBA16F=34842]="RGBA16F",e[e.RGB16F=34843]="RGB16F",e[e.TEXTURE_2D_ARRAY=35866]="TEXTURE_2D_ARRAY",e[e.TEXTURE_BINDING_2D_ARRAY=35869]="TEXTURE_BINDING_2D_ARRAY",e[e.R11F_G11F_B10F=35898]="R11F_G11F_B10F",e[e.RGB9_E5=35901]="RGB9_E5",e[e.RGBA32UI=36208]="RGBA32UI",e[e.RGB32UI=36209]="RGB32UI",e[e.RGBA16UI=36214]="RGBA16UI",e[e.RGB16UI=36215]="RGB16UI",e[e.RGBA8UI=36220]="RGBA8UI",e[e.RGB8UI=36221]="RGB8UI",e[e.RGBA32I=36226]="RGBA32I",e[e.RGB32I=36227]="RGB32I",e[e.RGBA16I=36232]="RGBA16I",e[e.RGB16I=36233]="RGB16I",e[e.RGBA8I=36238]="RGBA8I",e[e.RGB8I=36239]="RGB8I",e[e.RED_INTEGER=36244]="RED_INTEGER",e[e.RGB_INTEGER=36248]="RGB_INTEGER",e[e.RGBA_INTEGER=36249]="RGBA_INTEGER",e[e.R8=33321]="R8",e[e.RG8=33323]="RG8",e[e.R16F=33325]="R16F",e[e.R32F=33326]="R32F",e[e.RG16F=33327]="RG16F",e[e.RG32F=33328]="RG32F",e[e.R8I=33329]="R8I",e[e.R8UI=33330]="R8UI",e[e.R16I=33331]="R16I",e[e.R16UI=33332]="R16UI",e[e.R32I=33333]="R32I",e[e.R32UI=33334]="R32UI",e[e.RG8I=33335]="RG8I",e[e.RG8UI=33336]="RG8UI",e[e.RG16I=33337]="RG16I",e[e.RG16UI=33338]="RG16UI",e[e.RG32I=33339]="RG32I",e[e.RG32UI=33340]="RG32UI",e[e.R8_SNORM=36756]="R8_SNORM",e[e.RG8_SNORM=36757]="RG8_SNORM",e[e.RGB8_SNORM=36758]="RGB8_SNORM",e[e.RGBA8_SNORM=36759]="RGBA8_SNORM",e[e.RGB10_A2UI=36975]="RGB10_A2UI",e[e.TEXTURE_IMMUTABLE_FORMAT=37167]="TEXTURE_IMMUTABLE_FORMAT",e[e.TEXTURE_IMMUTABLE_LEVELS=33503]="TEXTURE_IMMUTABLE_LEVELS",e[e.UNSIGNED_INT_2_10_10_10_REV=33640]="UNSIGNED_INT_2_10_10_10_REV",e[e.UNSIGNED_INT_10F_11F_11F_REV=35899]="UNSIGNED_INT_10F_11F_11F_REV",e[e.UNSIGNED_INT_5_9_9_9_REV=35902]="UNSIGNED_INT_5_9_9_9_REV",e[e.FLOAT_32_UNSIGNED_INT_24_8_REV=36269]="FLOAT_32_UNSIGNED_INT_24_8_REV",e[e.UNSIGNED_INT_24_8=34042]="UNSIGNED_INT_24_8",e[e.HALF_FLOAT=5131]="HALF_FLOAT",e[e.RG=33319]="RG",e[e.RG_INTEGER=33320]="RG_INTEGER",e[e.INT_2_10_10_10_REV=36255]="INT_2_10_10_10_REV",e[e.CURRENT_QUERY=34917]="CURRENT_QUERY",e[e.QUERY_RESULT=34918]="QUERY_RESULT",e[e.QUERY_RESULT_AVAILABLE=34919]="QUERY_RESULT_AVAILABLE",e[e.ANY_SAMPLES_PASSED=35887]="ANY_SAMPLES_PASSED",e[e.ANY_SAMPLES_PASSED_CONSERVATIVE=36202]="ANY_SAMPLES_PASSED_CONSERVATIVE",e[e.MAX_DRAW_BUFFERS=34852]="MAX_DRAW_BUFFERS",e[e.DRAW_BUFFER0=34853]="DRAW_BUFFER0",e[e.DRAW_BUFFER1=34854]="DRAW_BUFFER1",e[e.DRAW_BUFFER2=34855]="DRAW_BUFFER2",e[e.DRAW_BUFFER3=34856]="DRAW_BUFFER3",e[e.DRAW_BUFFER4=34857]="DRAW_BUFFER4",e[e.DRAW_BUFFER5=34858]="DRAW_BUFFER5",e[e.DRAW_BUFFER6=34859]="DRAW_BUFFER6",e[e.DRAW_BUFFER7=34860]="DRAW_BUFFER7",e[e.DRAW_BUFFER8=34861]="DRAW_BUFFER8",e[e.DRAW_BUFFER9=34862]="DRAW_BUFFER9",e[e.DRAW_BUFFER10=34863]="DRAW_BUFFER10",e[e.DRAW_BUFFER11=34864]="DRAW_BUFFER11",e[e.DRAW_BUFFER12=34865]="DRAW_BUFFER12",e[e.DRAW_BUFFER13=34866]="DRAW_BUFFER13",e[e.DRAW_BUFFER14=34867]="DRAW_BUFFER14",e[e.DRAW_BUFFER15=34868]="DRAW_BUFFER15",e[e.MAX_COLOR_ATTACHMENTS=36063]="MAX_COLOR_ATTACHMENTS",e[e.COLOR_ATTACHMENT1=36065]="COLOR_ATTACHMENT1",e[e.COLOR_ATTACHMENT2=36066]="COLOR_ATTACHMENT2",e[e.COLOR_ATTACHMENT3=36067]="COLOR_ATTACHMENT3",e[e.COLOR_ATTACHMENT4=36068]="COLOR_ATTACHMENT4",e[e.COLOR_ATTACHMENT5=36069]="COLOR_ATTACHMENT5",e[e.COLOR_ATTACHMENT6=36070]="COLOR_ATTACHMENT6",e[e.COLOR_ATTACHMENT7=36071]="COLOR_ATTACHMENT7",e[e.COLOR_ATTACHMENT8=36072]="COLOR_ATTACHMENT8",e[e.COLOR_ATTACHMENT9=36073]="COLOR_ATTACHMENT9",e[e.COLOR_ATTACHMENT10=36074]="COLOR_ATTACHMENT10",e[e.COLOR_ATTACHMENT11=36075]="COLOR_ATTACHMENT11",e[e.COLOR_ATTACHMENT12=36076]="COLOR_ATTACHMENT12",e[e.COLOR_ATTACHMENT13=36077]="COLOR_ATTACHMENT13",e[e.COLOR_ATTACHMENT14=36078]="COLOR_ATTACHMENT14",e[e.COLOR_ATTACHMENT15=36079]="COLOR_ATTACHMENT15",e[e.SAMPLER_3D=35679]="SAMPLER_3D",e[e.SAMPLER_2D_SHADOW=35682]="SAMPLER_2D_SHADOW",e[e.SAMPLER_2D_ARRAY=36289]="SAMPLER_2D_ARRAY",e[e.SAMPLER_2D_ARRAY_SHADOW=36292]="SAMPLER_2D_ARRAY_SHADOW",e[e.SAMPLER_CUBE_SHADOW=36293]="SAMPLER_CUBE_SHADOW",e[e.INT_SAMPLER_2D=36298]="INT_SAMPLER_2D",e[e.INT_SAMPLER_3D=36299]="INT_SAMPLER_3D",e[e.INT_SAMPLER_CUBE=36300]="INT_SAMPLER_CUBE",e[e.INT_SAMPLER_2D_ARRAY=36303]="INT_SAMPLER_2D_ARRAY",e[e.UNSIGNED_INT_SAMPLER_2D=36306]="UNSIGNED_INT_SAMPLER_2D",e[e.UNSIGNED_INT_SAMPLER_3D=36307]="UNSIGNED_INT_SAMPLER_3D",e[e.UNSIGNED_INT_SAMPLER_CUBE=36308]="UNSIGNED_INT_SAMPLER_CUBE",e[e.UNSIGNED_INT_SAMPLER_2D_ARRAY=36311]="UNSIGNED_INT_SAMPLER_2D_ARRAY",e[e.MAX_SAMPLES=36183]="MAX_SAMPLES",e[e.SAMPLER_BINDING=35097]="SAMPLER_BINDING",e[e.PIXEL_PACK_BUFFER=35051]="PIXEL_PACK_BUFFER",e[e.PIXEL_UNPACK_BUFFER=35052]="PIXEL_UNPACK_BUFFER",e[e.PIXEL_PACK_BUFFER_BINDING=35053]="PIXEL_PACK_BUFFER_BINDING",e[e.PIXEL_UNPACK_BUFFER_BINDING=35055]="PIXEL_UNPACK_BUFFER_BINDING",e[e.COPY_READ_BUFFER=36662]="COPY_READ_BUFFER",e[e.COPY_WRITE_BUFFER=36663]="COPY_WRITE_BUFFER",e[e.COPY_READ_BUFFER_BINDING=36662]="COPY_READ_BUFFER_BINDING",e[e.COPY_WRITE_BUFFER_BINDING=36663]="COPY_WRITE_BUFFER_BINDING",e[e.FLOAT_MAT2x3=35685]="FLOAT_MAT2x3",e[e.FLOAT_MAT2x4=35686]="FLOAT_MAT2x4",e[e.FLOAT_MAT3x2=35687]="FLOAT_MAT3x2",e[e.FLOAT_MAT3x4=35688]="FLOAT_MAT3x4",e[e.FLOAT_MAT4x2=35689]="FLOAT_MAT4x2",e[e.FLOAT_MAT4x3=35690]="FLOAT_MAT4x3",e[e.UNSIGNED_INT_VEC2=36294]="UNSIGNED_INT_VEC2",e[e.UNSIGNED_INT_VEC3=36295]="UNSIGNED_INT_VEC3",e[e.UNSIGNED_INT_VEC4=36296]="UNSIGNED_INT_VEC4",e[e.UNSIGNED_NORMALIZED=35863]="UNSIGNED_NORMALIZED",e[e.SIGNED_NORMALIZED=36764]="SIGNED_NORMALIZED",e[e.VERTEX_ATTRIB_ARRAY_INTEGER=35069]="VERTEX_ATTRIB_ARRAY_INTEGER",e[e.VERTEX_ATTRIB_ARRAY_DIVISOR=35070]="VERTEX_ATTRIB_ARRAY_DIVISOR",e[e.TRANSFORM_FEEDBACK_BUFFER_MODE=35967]="TRANSFORM_FEEDBACK_BUFFER_MODE",e[e.MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS=35968]="MAX_TRANSFORM_FEEDBACK_SEPARATE_COMPONENTS",e[e.TRANSFORM_FEEDBACK_VARYINGS=35971]="TRANSFORM_FEEDBACK_VARYINGS",e[e.TRANSFORM_FEEDBACK_BUFFER_START=35972]="TRANSFORM_FEEDBACK_BUFFER_START",e[e.TRANSFORM_FEEDBACK_BUFFER_SIZE=35973]="TRANSFORM_FEEDBACK_BUFFER_SIZE",e[e.TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN=35976]="TRANSFORM_FEEDBACK_PRIMITIVES_WRITTEN",e[e.MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS=35978]="MAX_TRANSFORM_FEEDBACK_INTERLEAVED_COMPONENTS",e[e.MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS=35979]="MAX_TRANSFORM_FEEDBACK_SEPARATE_ATTRIBS",e[e.INTERLEAVED_ATTRIBS=35980]="INTERLEAVED_ATTRIBS",e[e.SEPARATE_ATTRIBS=35981]="SEPARATE_ATTRIBS",e[e.TRANSFORM_FEEDBACK_BUFFER=35982]="TRANSFORM_FEEDBACK_BUFFER",e[e.TRANSFORM_FEEDBACK_BUFFER_BINDING=35983]="TRANSFORM_FEEDBACK_BUFFER_BINDING",e[e.TRANSFORM_FEEDBACK=36386]="TRANSFORM_FEEDBACK",e[e.TRANSFORM_FEEDBACK_PAUSED=36387]="TRANSFORM_FEEDBACK_PAUSED",e[e.TRANSFORM_FEEDBACK_ACTIVE=36388]="TRANSFORM_FEEDBACK_ACTIVE",e[e.TRANSFORM_FEEDBACK_BINDING=36389]="TRANSFORM_FEEDBACK_BINDING",e[e.FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING=33296]="FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING",e[e.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE",e[e.FRAMEBUFFER_ATTACHMENT_RED_SIZE=33298]="FRAMEBUFFER_ATTACHMENT_RED_SIZE",e[e.FRAMEBUFFER_ATTACHMENT_GREEN_SIZE=33299]="FRAMEBUFFER_ATTACHMENT_GREEN_SIZE",e[e.FRAMEBUFFER_ATTACHMENT_BLUE_SIZE=33300]="FRAMEBUFFER_ATTACHMENT_BLUE_SIZE",e[e.FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE=33301]="FRAMEBUFFER_ATTACHMENT_ALPHA_SIZE",e[e.FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE=33302]="FRAMEBUFFER_ATTACHMENT_DEPTH_SIZE",e[e.FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE=33303]="FRAMEBUFFER_ATTACHMENT_STENCIL_SIZE",e[e.FRAMEBUFFER_DEFAULT=33304]="FRAMEBUFFER_DEFAULT",e[e.DEPTH24_STENCIL8=35056]="DEPTH24_STENCIL8",e[e.DRAW_FRAMEBUFFER_BINDING=36006]="DRAW_FRAMEBUFFER_BINDING",e[e.READ_FRAMEBUFFER_BINDING=36010]="READ_FRAMEBUFFER_BINDING",e[e.RENDERBUFFER_SAMPLES=36011]="RENDERBUFFER_SAMPLES",e[e.FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER=36052]="FRAMEBUFFER_ATTACHMENT_TEXTURE_LAYER",e[e.FRAMEBUFFER_INCOMPLETE_MULTISAMPLE=36182]="FRAMEBUFFER_INCOMPLETE_MULTISAMPLE",e[e.UNIFORM_BUFFER=35345]="UNIFORM_BUFFER",e[e.UNIFORM_BUFFER_BINDING=35368]="UNIFORM_BUFFER_BINDING",e[e.UNIFORM_BUFFER_START=35369]="UNIFORM_BUFFER_START",e[e.UNIFORM_BUFFER_SIZE=35370]="UNIFORM_BUFFER_SIZE",e[e.MAX_VERTEX_UNIFORM_BLOCKS=35371]="MAX_VERTEX_UNIFORM_BLOCKS",e[e.MAX_FRAGMENT_UNIFORM_BLOCKS=35373]="MAX_FRAGMENT_UNIFORM_BLOCKS",e[e.MAX_COMBINED_UNIFORM_BLOCKS=35374]="MAX_COMBINED_UNIFORM_BLOCKS",e[e.MAX_UNIFORM_BUFFER_BINDINGS=35375]="MAX_UNIFORM_BUFFER_BINDINGS",e[e.MAX_UNIFORM_BLOCK_SIZE=35376]="MAX_UNIFORM_BLOCK_SIZE",e[e.MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS=35377]="MAX_COMBINED_VERTEX_UNIFORM_COMPONENTS",e[e.MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS=35379]="MAX_COMBINED_FRAGMENT_UNIFORM_COMPONENTS",e[e.UNIFORM_BUFFER_OFFSET_ALIGNMENT=35380]="UNIFORM_BUFFER_OFFSET_ALIGNMENT",e[e.ACTIVE_UNIFORM_BLOCKS=35382]="ACTIVE_UNIFORM_BLOCKS",e[e.UNIFORM_TYPE=35383]="UNIFORM_TYPE",e[e.UNIFORM_SIZE=35384]="UNIFORM_SIZE",e[e.UNIFORM_BLOCK_INDEX=35386]="UNIFORM_BLOCK_INDEX",e[e.UNIFORM_OFFSET=35387]="UNIFORM_OFFSET",e[e.UNIFORM_ARRAY_STRIDE=35388]="UNIFORM_ARRAY_STRIDE",e[e.UNIFORM_MATRIX_STRIDE=35389]="UNIFORM_MATRIX_STRIDE",e[e.UNIFORM_IS_ROW_MAJOR=35390]="UNIFORM_IS_ROW_MAJOR",e[e.UNIFORM_BLOCK_BINDING=35391]="UNIFORM_BLOCK_BINDING",e[e.UNIFORM_BLOCK_DATA_SIZE=35392]="UNIFORM_BLOCK_DATA_SIZE",e[e.UNIFORM_BLOCK_ACTIVE_UNIFORMS=35394]="UNIFORM_BLOCK_ACTIVE_UNIFORMS",e[e.UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES=35395]="UNIFORM_BLOCK_ACTIVE_UNIFORM_INDICES",e[e.UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER=35396]="UNIFORM_BLOCK_REFERENCED_BY_VERTEX_SHADER",e[e.UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER=35398]="UNIFORM_BLOCK_REFERENCED_BY_FRAGMENT_SHADER",e[e.OBJECT_TYPE=37138]="OBJECT_TYPE",e[e.SYNC_CONDITION=37139]="SYNC_CONDITION",e[e.SYNC_STATUS=37140]="SYNC_STATUS",e[e.SYNC_FLAGS=37141]="SYNC_FLAGS",e[e.SYNC_FENCE=37142]="SYNC_FENCE",e[e.SYNC_GPU_COMMANDS_COMPLETE=37143]="SYNC_GPU_COMMANDS_COMPLETE",e[e.UNSIGNALED=37144]="UNSIGNALED",e[e.SIGNALED=37145]="SIGNALED",e[e.ALREADY_SIGNALED=37146]="ALREADY_SIGNALED",e[e.TIMEOUT_EXPIRED=37147]="TIMEOUT_EXPIRED",e[e.CONDITION_SATISFIED=37148]="CONDITION_SATISFIED",e[e.WAIT_FAILED=37149]="WAIT_FAILED",e[e.SYNC_FLUSH_COMMANDS_BIT=1]="SYNC_FLUSH_COMMANDS_BIT",e[e.COLOR=6144]="COLOR",e[e.DEPTH=6145]="DEPTH",e[e.STENCIL=6146]="STENCIL",e[e.MIN=32775]="MIN",e[e.MAX=32776]="MAX",e[e.DEPTH_COMPONENT24=33190]="DEPTH_COMPONENT24",e[e.STREAM_READ=35041]="STREAM_READ",e[e.STREAM_COPY=35042]="STREAM_COPY",e[e.STATIC_READ=35045]="STATIC_READ",e[e.STATIC_COPY=35046]="STATIC_COPY",e[e.DYNAMIC_READ=35049]="DYNAMIC_READ",e[e.DYNAMIC_COPY=35050]="DYNAMIC_COPY",e[e.DEPTH_COMPONENT32F=36012]="DEPTH_COMPONENT32F",e[e.DEPTH32F_STENCIL8=36013]="DEPTH32F_STENCIL8",e[e.INVALID_INDEX=4294967295]="INVALID_INDEX",e[e.TIMEOUT_IGNORED=-1]="TIMEOUT_IGNORED",e[e.MAX_CLIENT_WAIT_TIMEOUT_WEBGL=37447]="MAX_CLIENT_WAIT_TIMEOUT_WEBGL",e[e.VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE=35070]="VERTEX_ATTRIB_ARRAY_DIVISOR_ANGLE",e[e.UNMASKED_VENDOR_WEBGL=37445]="UNMASKED_VENDOR_WEBGL",e[e.UNMASKED_RENDERER_WEBGL=37446]="UNMASKED_RENDERER_WEBGL",e[e.MAX_TEXTURE_MAX_ANISOTROPY_EXT=34047]="MAX_TEXTURE_MAX_ANISOTROPY_EXT",e[e.TEXTURE_MAX_ANISOTROPY_EXT=34046]="TEXTURE_MAX_ANISOTROPY_EXT",e[e.COMPRESSED_RGB_S3TC_DXT1_EXT=33776]="COMPRESSED_RGB_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT1_EXT=33777]="COMPRESSED_RGBA_S3TC_DXT1_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT3_EXT=33778]="COMPRESSED_RGBA_S3TC_DXT3_EXT",e[e.COMPRESSED_RGBA_S3TC_DXT5_EXT=33779]="COMPRESSED_RGBA_S3TC_DXT5_EXT",e[e.COMPRESSED_R11_EAC=37488]="COMPRESSED_R11_EAC",e[e.COMPRESSED_SIGNED_R11_EAC=37489]="COMPRESSED_SIGNED_R11_EAC",e[e.COMPRESSED_RG11_EAC=37490]="COMPRESSED_RG11_EAC",e[e.COMPRESSED_SIGNED_RG11_EAC=37491]="COMPRESSED_SIGNED_RG11_EAC",e[e.COMPRESSED_RGB8_ETC2=37492]="COMPRESSED_RGB8_ETC2",e[e.COMPRESSED_RGBA8_ETC2_EAC=37493]="COMPRESSED_RGBA8_ETC2_EAC",e[e.COMPRESSED_SRGB8_ETC2=37494]="COMPRESSED_SRGB8_ETC2",e[e.COMPRESSED_SRGB8_ALPHA8_ETC2_EAC=37495]="COMPRESSED_SRGB8_ALPHA8_ETC2_EAC",e[e.COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2=37496]="COMPRESSED_RGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2=37497]="COMPRESSED_SRGB8_PUNCHTHROUGH_ALPHA1_ETC2",e[e.COMPRESSED_RGB_PVRTC_4BPPV1_IMG=35840]="COMPRESSED_RGB_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG=35842]="COMPRESSED_RGBA_PVRTC_4BPPV1_IMG",e[e.COMPRESSED_RGB_PVRTC_2BPPV1_IMG=35841]="COMPRESSED_RGB_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG=35843]="COMPRESSED_RGBA_PVRTC_2BPPV1_IMG",e[e.COMPRESSED_RGB_ETC1_WEBGL=36196]="COMPRESSED_RGB_ETC1_WEBGL",e[e.COMPRESSED_RGB_ATC_WEBGL=35986]="COMPRESSED_RGB_ATC_WEBGL",e[e.COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL=35986]="COMPRESSED_RGBA_ATC_EXPLICIT_ALPHA_WEBGL",e[e.COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL=34798]="COMPRESSED_RGBA_ATC_INTERPOLATED_ALPHA_WEBGL",e[e.UNSIGNED_INT_24_8_WEBGL=34042]="UNSIGNED_INT_24_8_WEBGL",e[e.HALF_FLOAT_OES=36193]="HALF_FLOAT_OES",e[e.RGBA32F_EXT=34836]="RGBA32F_EXT",e[e.RGB32F_EXT=34837]="RGB32F_EXT",e[e.FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT=33297]="FRAMEBUFFER_ATTACHMENT_COMPONENT_TYPE_EXT",e[e.UNSIGNED_NORMALIZED_EXT=35863]="UNSIGNED_NORMALIZED_EXT",e[e.MIN_EXT=32775]="MIN_EXT",e[e.MAX_EXT=32776]="MAX_EXT",e[e.SRGB_EXT=35904]="SRGB_EXT",e[e.SRGB_ALPHA_EXT=35906]="SRGB_ALPHA_EXT",e[e.SRGB8_ALPHA8_EXT=35907]="SRGB8_ALPHA8_EXT",e[e.FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING_EXT=33296]="FRAMEBUFFER_ATTACHMENT_COLOR_ENCODING_EXT",e[e.FRAGMENT_SHADER_DERIVATIVE_HINT_OES=35723]="FRAGMENT_SHADER_DERIVATIVE_HINT_OES",e[e.COLOR_ATTACHMENT0_WEBGL=36064]="COLOR_ATTACHMENT0_WEBGL",e[e.COLOR_ATTACHMENT1_WEBGL=36065]="COLOR_ATTACHMENT1_WEBGL",e[e.COLOR_ATTACHMENT2_WEBGL=36066]="COLOR_ATTACHMENT2_WEBGL",e[e.COLOR_ATTACHMENT3_WEBGL=36067]="COLOR_ATTACHMENT3_WEBGL",e[e.COLOR_ATTACHMENT4_WEBGL=36068]="COLOR_ATTACHMENT4_WEBGL",e[e.COLOR_ATTACHMENT5_WEBGL=36069]="COLOR_ATTACHMENT5_WEBGL",e[e.COLOR_ATTACHMENT6_WEBGL=36070]="COLOR_ATTACHMENT6_WEBGL",e[e.COLOR_ATTACHMENT7_WEBGL=36071]="COLOR_ATTACHMENT7_WEBGL",e[e.COLOR_ATTACHMENT8_WEBGL=36072]="COLOR_ATTACHMENT8_WEBGL",e[e.COLOR_ATTACHMENT9_WEBGL=36073]="COLOR_ATTACHMENT9_WEBGL",e[e.COLOR_ATTACHMENT10_WEBGL=36074]="COLOR_ATTACHMENT10_WEBGL",e[e.COLOR_ATTACHMENT11_WEBGL=36075]="COLOR_ATTACHMENT11_WEBGL",e[e.COLOR_ATTACHMENT12_WEBGL=36076]="COLOR_ATTACHMENT12_WEBGL",e[e.COLOR_ATTACHMENT13_WEBGL=36077]="COLOR_ATTACHMENT13_WEBGL",e[e.COLOR_ATTACHMENT14_WEBGL=36078]="COLOR_ATTACHMENT14_WEBGL",e[e.COLOR_ATTACHMENT15_WEBGL=36079]="COLOR_ATTACHMENT15_WEBGL",e[e.DRAW_BUFFER0_WEBGL=34853]="DRAW_BUFFER0_WEBGL",e[e.DRAW_BUFFER1_WEBGL=34854]="DRAW_BUFFER1_WEBGL",e[e.DRAW_BUFFER2_WEBGL=34855]="DRAW_BUFFER2_WEBGL",e[e.DRAW_BUFFER3_WEBGL=34856]="DRAW_BUFFER3_WEBGL",e[e.DRAW_BUFFER4_WEBGL=34857]="DRAW_BUFFER4_WEBGL",e[e.DRAW_BUFFER5_WEBGL=34858]="DRAW_BUFFER5_WEBGL",e[e.DRAW_BUFFER6_WEBGL=34859]="DRAW_BUFFER6_WEBGL",e[e.DRAW_BUFFER7_WEBGL=34860]="DRAW_BUFFER7_WEBGL",e[e.DRAW_BUFFER8_WEBGL=34861]="DRAW_BUFFER8_WEBGL",e[e.DRAW_BUFFER9_WEBGL=34862]="DRAW_BUFFER9_WEBGL",e[e.DRAW_BUFFER10_WEBGL=34863]="DRAW_BUFFER10_WEBGL",e[e.DRAW_BUFFER11_WEBGL=34864]="DRAW_BUFFER11_WEBGL",e[e.DRAW_BUFFER12_WEBGL=34865]="DRAW_BUFFER12_WEBGL",e[e.DRAW_BUFFER13_WEBGL=34866]="DRAW_BUFFER13_WEBGL",e[e.DRAW_BUFFER14_WEBGL=34867]="DRAW_BUFFER14_WEBGL",e[e.DRAW_BUFFER15_WEBGL=34868]="DRAW_BUFFER15_WEBGL",e[e.MAX_COLOR_ATTACHMENTS_WEBGL=36063]="MAX_COLOR_ATTACHMENTS_WEBGL",e[e.MAX_DRAW_BUFFERS_WEBGL=34852]="MAX_DRAW_BUFFERS_WEBGL",e[e.VERTEX_ARRAY_BINDING_OES=34229]="VERTEX_ARRAY_BINDING_OES",e[e.QUERY_COUNTER_BITS_EXT=34916]="QUERY_COUNTER_BITS_EXT",e[e.CURRENT_QUERY_EXT=34917]="CURRENT_QUERY_EXT",e[e.QUERY_RESULT_EXT=34918]="QUERY_RESULT_EXT",e[e.QUERY_RESULT_AVAILABLE_EXT=34919]="QUERY_RESULT_AVAILABLE_EXT",e[e.TIME_ELAPSED_EXT=35007]="TIME_ELAPSED_EXT",e[e.TIMESTAMP_EXT=36392]="TIMESTAMP_EXT",e[e.GPU_DISJOINT_EXT=36795]="GPU_DISJOINT_EXT"}(SS||(SS={})),function(e){e[e.Buffer=0]="Buffer",e[e.Texture=1]="Texture",e[e.RenderTarget=2]="RenderTarget",e[e.Sampler=3]="Sampler",e[e.Program=4]="Program",e[e.Bindings=5]="Bindings",e[e.InputLayout=6]="InputLayout",e[e.RenderPipeline=7]="RenderPipeline",e[e.ComputePipeline=8]="ComputePipeline",e[e.Readback=9]="Readback",e[e.QueryPool=10]="QueryPool",e[e.RenderBundle=11]="RenderBundle"}(TS||(TS={})),function(e){e[e.NEVER=512]="NEVER",e[e.LESS=513]="LESS",e[e.EQUAL=514]="EQUAL",e[e.LEQUAL=515]="LEQUAL",e[e.GREATER=516]="GREATER",e[e.NOTEQUAL=517]="NOTEQUAL",e[e.GEQUAL=518]="GEQUAL",e[e.ALWAYS=519]="ALWAYS"}(RS||(RS={})),function(e){e[e.CCW=2305]="CCW",e[e.CW=2304]="CW"}(CS||(CS={})),function(e){e[e.NONE=0]="NONE",e[e.FRONT=1]="FRONT",e[e.BACK=2]="BACK",e[e.FRONT_AND_BACK=3]="FRONT_AND_BACK"}(MS||(MS={})),function(e){e[e.ZERO=0]="ZERO",e[e.ONE=1]="ONE",e[e.SRC=768]="SRC",e[e.ONE_MINUS_SRC=769]="ONE_MINUS_SRC",e[e.DST=774]="DST",e[e.ONE_MINUS_DST=775]="ONE_MINUS_DST",e[e.SRC_ALPHA=770]="SRC_ALPHA",e[e.ONE_MINUS_SRC_ALPHA=771]="ONE_MINUS_SRC_ALPHA",e[e.DST_ALPHA=772]="DST_ALPHA",e[e.ONE_MINUS_DST_ALPHA=773]="ONE_MINUS_DST_ALPHA",e[e.CONST=32769]="CONST",e[e.ONE_MINUS_CONSTANT=32770]="ONE_MINUS_CONSTANT",e[e.SRC_ALPHA_SATURATE=776]="SRC_ALPHA_SATURATE"}(wS||(wS={})),function(e){e[e.ADD=32774]="ADD",e[e.SUBSTRACT=32778]="SUBSTRACT",e[e.REVERSE_SUBSTRACT=32779]="REVERSE_SUBSTRACT",e[e.MIN=32775]="MIN",e[e.MAX=32776]="MAX"}(LS||(LS={})),function(e){e[e.CLAMP_TO_EDGE=0]="CLAMP_TO_EDGE",e[e.REPEAT=1]="REPEAT",e[e.MIRRORED_REPEAT=2]="MIRRORED_REPEAT"}(OS||(OS={})),function(e){e[e.POINT=0]="POINT",e[e.BILINEAR=1]="BILINEAR"}(kS||(kS={})),function(e){e[e.NO_MIP=0]="NO_MIP",e[e.NEAREST=1]="NEAREST",e[e.LINEAR=2]="LINEAR"}(NS||(NS={})),function(e){e[e.POINTS=0]="POINTS",e[e.TRIANGLES=1]="TRIANGLES",e[e.TRIANGLE_STRIP=2]="TRIANGLE_STRIP",e[e.LINES=3]="LINES",e[e.LINE_STRIP=4]="LINE_STRIP"}(IS||(IS={})),function(e){e[e.MAP_READ=1]="MAP_READ",e[e.MAP_WRITE=2]="MAP_WRITE",e[e.COPY_SRC=4]="COPY_SRC",e[e.COPY_DST=8]="COPY_DST",e[e.INDEX=16]="INDEX",e[e.VERTEX=32]="VERTEX",e[e.UNIFORM=64]="UNIFORM",e[e.STORAGE=128]="STORAGE",e[e.INDIRECT=256]="INDIRECT",e[e.QUERY_RESOLVE=512]="QUERY_RESOLVE"}(PS||(PS={})),function(e){e[e.STATIC=1]="STATIC",e[e.DYNAMIC=2]="DYNAMIC"}(DS||(DS={})),function(e){e[e.VERTEX=1]="VERTEX",e[e.INSTANCE=2]="INSTANCE"}(FS||(FS={})),function(e){e.LOADED="loaded"}(BS||(BS={})),function(e){e[e.TEXTURE_2D=0]="TEXTURE_2D",e[e.TEXTURE_2D_ARRAY=1]="TEXTURE_2D_ARRAY",e[e.TEXTURE_3D=2]="TEXTURE_3D",e[e.TEXTURE_CUBE_MAP=3]="TEXTURE_CUBE_MAP"}(US||(US={})),function(e){e[e.SAMPLED=1]="SAMPLED",e[e.RENDER_TARGET=2]="RENDER_TARGET",e[e.STORAGE=4]="STORAGE"}(GS||(GS={})),function(e){e[e.NONE=0]="NONE",e[e.RED=1]="RED",e[e.GREEN=2]="GREEN",e[e.BLUE=4]="BLUE",e[e.ALPHA=8]="ALPHA",e[e.RGB=7]="RGB",e[e.ALL=15]="ALL"}(zS||(zS={})),function(e){e[e.KEEP=7680]="KEEP",e[e.ZERO=0]="ZERO",e[e.REPLACE=7681]="REPLACE",e[e.INVERT=5386]="INVERT",e[e.INCREMENT_CLAMP=7682]="INCREMENT_CLAMP",e[e.DECREMENT_CLAMP=7683]="DECREMENT_CLAMP",e[e.INCREMENT_WRAP=34055]="INCREMENT_WRAP",e[e.DECREMENT_WRAP=34056]="DECREMENT_WRAP"}(jS||(jS={})),function(e){e[e.Float=0]="Float",e[e.UnfilterableFloat=1]="UnfilterableFloat",e[e.Uint=2]="Uint",e[e.Sint=3]="Sint",e[e.Depth=4]="Depth"}(VS||(VS={})),function(e){e[e.LOWER_LEFT=0]="LOWER_LEFT",e[e.UPPER_LEFT=1]="UPPER_LEFT"}(HS||(HS={})),function(e){e[e.NEGATIVE_ONE=0]="NEGATIVE_ONE",e[e.ZERO=1]="ZERO"}(XS||(XS={})),function(e){e[e.OcclusionConservative=0]="OcclusionConservative"}(WS||(WS={})),function(e){e[e.U8=1]="U8",e[e.U16=2]="U16",e[e.U32=3]="U32",e[e.S8=4]="S8",e[e.S16=5]="S16",e[e.S32=6]="S32",e[e.F16=7]="F16",e[e.F32=8]="F32",e[e.BC1=65]="BC1",e[e.BC2=66]="BC2",e[e.BC3=67]="BC3",e[e.BC4_UNORM=68]="BC4_UNORM",e[e.BC4_SNORM=69]="BC4_SNORM",e[e.BC5_UNORM=70]="BC5_UNORM",e[e.BC5_SNORM=71]="BC5_SNORM",e[e.U16_PACKED_5551=97]="U16_PACKED_5551",e[e.U16_PACKED_565=98]="U16_PACKED_565",e[e.D24=129]="D24",e[e.D32F=130]="D32F",e[e.D24S8=131]="D24S8",e[e.D32FS8=132]="D32FS8"}(YS||(YS={})),function(e){e[e.R=1]="R",e[e.RG=2]="RG",e[e.RGB=3]="RGB",e[e.RGBA=4]="RGBA",e[e.A=5]="A"}(ZS||(ZS={})),function(e){e[e.None=0]="None",e[e.Normalized=1]="Normalized",e[e.sRGB=2]="sRGB",e[e.Depth=4]="Depth",e[e.Stencil=8]="Stencil",e[e.RenderTarget=16]="RenderTarget",e[e.Luminance=32]="Luminance"}(qS||(qS={})),function(e){e[e.ALPHA=$S(YS.U8,ZS.A,qS.None)]="ALPHA",e[e.U8_LUMINANCE=$S(YS.U8,ZS.A,qS.Luminance)]="U8_LUMINANCE",e[e.F16_LUMINANCE=$S(YS.F16,ZS.A,qS.Luminance)]="F16_LUMINANCE",e[e.F32_LUMINANCE=$S(YS.F32,ZS.A,qS.Luminance)]="F32_LUMINANCE",e[e.F16_R=$S(YS.F16,ZS.R,qS.None)]="F16_R",e[e.F16_RG=$S(YS.F16,ZS.RG,qS.None)]="F16_RG",e[e.F16_RGB=$S(YS.F16,ZS.RGB,qS.None)]="F16_RGB",e[e.F16_RGBA=$S(YS.F16,ZS.RGBA,qS.None)]="F16_RGBA",e[e.F32_R=$S(YS.F32,ZS.R,qS.None)]="F32_R",e[e.F32_RG=$S(YS.F32,ZS.RG,qS.None)]="F32_RG",e[e.F32_RGB=$S(YS.F32,ZS.RGB,qS.None)]="F32_RGB",e[e.F32_RGBA=$S(YS.F32,ZS.RGBA,qS.None)]="F32_RGBA",e[e.U8_R=$S(YS.U8,ZS.R,qS.None)]="U8_R",e[e.U8_R_NORM=$S(YS.U8,ZS.R,qS.Normalized)]="U8_R_NORM",e[e.U8_RG=$S(YS.U8,ZS.RG,qS.None)]="U8_RG",e[e.U8_RG_NORM=$S(YS.U8,ZS.RG,qS.Normalized)]="U8_RG_NORM",e[e.U8_RGB=$S(YS.U8,ZS.RGB,qS.None)]="U8_RGB",e[e.U8_RGB_NORM=$S(YS.U8,ZS.RGB,qS.Normalized)]="U8_RGB_NORM",e[e.U8_RGB_SRGB=$S(YS.U8,ZS.RGB,qS.sRGB|qS.Normalized)]="U8_RGB_SRGB",e[e.U8_RGBA=$S(YS.U8,ZS.RGBA,qS.None)]="U8_RGBA",e[e.U8_RGBA_NORM=$S(YS.U8,ZS.RGBA,qS.Normalized)]="U8_RGBA_NORM",e[e.U8_RGBA_SRGB=$S(YS.U8,ZS.RGBA,qS.sRGB|qS.Normalized)]="U8_RGBA_SRGB",e[e.U16_R=$S(YS.U16,ZS.R,qS.None)]="U16_R",e[e.U16_R_NORM=$S(YS.U16,ZS.R,qS.Normalized)]="U16_R_NORM",e[e.U16_RG_NORM=$S(YS.U16,ZS.RG,qS.Normalized)]="U16_RG_NORM",e[e.U16_RGBA_NORM=$S(YS.U16,ZS.RGBA,qS.Normalized)]="U16_RGBA_NORM",e[e.U16_RGBA=$S(YS.U16,ZS.RGBA,qS.None)]="U16_RGBA",e[e.U16_RGB=$S(YS.U16,ZS.RGB,qS.None)]="U16_RGB",e[e.U16_RG=$S(YS.U16,ZS.RG,qS.None)]="U16_RG",e[e.U32_R=$S(YS.U32,ZS.R,qS.None)]="U32_R",e[e.U32_RG=$S(YS.U32,ZS.RG,qS.None)]="U32_RG",e[e.U32_RGB=$S(YS.U32,ZS.RGB,qS.None)]="U32_RGB",e[e.U32_RGBA=$S(YS.U32,ZS.RGBA,qS.None)]="U32_RGBA",e[e.S8_R=$S(YS.S8,ZS.R,qS.None)]="S8_R",e[e.S8_R_NORM=$S(YS.S8,ZS.R,qS.Normalized)]="S8_R_NORM",e[e.S8_RG_NORM=$S(YS.S8,ZS.RG,qS.Normalized)]="S8_RG_NORM",e[e.S8_RGB_NORM=$S(YS.S8,ZS.RGB,qS.Normalized)]="S8_RGB_NORM",e[e.S8_RGBA_NORM=$S(YS.S8,ZS.RGBA,qS.Normalized)]="S8_RGBA_NORM",e[e.S16_R=$S(YS.S16,ZS.R,qS.None)]="S16_R",e[e.S16_RG=$S(YS.S16,ZS.RG,qS.None)]="S16_RG",e[e.S16_RG_NORM=$S(YS.S16,ZS.RG,qS.Normalized)]="S16_RG_NORM",e[e.S16_RGB_NORM=$S(YS.S16,ZS.RGB,qS.Normalized)]="S16_RGB_NORM",e[e.S16_RGBA=$S(YS.S16,ZS.RGBA,qS.None)]="S16_RGBA",e[e.S16_RGBA_NORM=$S(YS.S16,ZS.RGBA,qS.Normalized)]="S16_RGBA_NORM",e[e.S32_R=$S(YS.S32,ZS.R,qS.None)]="S32_R",e[e.S32_RG=$S(YS.S32,ZS.RG,qS.None)]="S32_RG",e[e.S32_RGB=$S(YS.S32,ZS.RGB,qS.None)]="S32_RGB",e[e.S32_RGBA=$S(YS.S32,ZS.RGBA,qS.None)]="S32_RGBA",e[e.U16_RGBA_5551=$S(YS.U16_PACKED_5551,ZS.RGBA,qS.Normalized)]="U16_RGBA_5551",e[e.U16_RGB_565=$S(YS.U16_PACKED_565,ZS.RGB,qS.Normalized)]="U16_RGB_565",e[e.BC1=$S(YS.BC1,ZS.RGBA,qS.Normalized)]="BC1",e[e.BC1_SRGB=$S(YS.BC1,ZS.RGBA,qS.Normalized|qS.sRGB)]="BC1_SRGB",e[e.BC2=$S(YS.BC2,ZS.RGBA,qS.Normalized)]="BC2",e[e.BC2_SRGB=$S(YS.BC2,ZS.RGBA,qS.Normalized|qS.sRGB)]="BC2_SRGB",e[e.BC3=$S(YS.BC3,ZS.RGBA,qS.Normalized)]="BC3",e[e.BC3_SRGB=$S(YS.BC3,ZS.RGBA,qS.Normalized|qS.sRGB)]="BC3_SRGB",e[e.BC4_UNORM=$S(YS.BC4_UNORM,ZS.R,qS.Normalized)]="BC4_UNORM",e[e.BC4_SNORM=$S(YS.BC4_SNORM,ZS.R,qS.Normalized)]="BC4_SNORM",e[e.BC5_UNORM=$S(YS.BC5_UNORM,ZS.RG,qS.Normalized)]="BC5_UNORM",e[e.BC5_SNORM=$S(YS.BC5_SNORM,ZS.RG,qS.Normalized)]="BC5_SNORM",e[e.D24=$S(YS.D24,ZS.R,qS.Depth)]="D24",e[e.D24_S8=$S(YS.D24S8,ZS.RG,qS.Depth|qS.Stencil)]="D24_S8",e[e.D32F=$S(YS.D32F,ZS.R,qS.Depth)]="D32F",e[e.D32F_S8=$S(YS.D32FS8,ZS.RG,qS.Depth|qS.Stencil)]="D32F_S8",e[e.U8_RGB_RT=$S(YS.U8,ZS.RGB,qS.RenderTarget|qS.Normalized)]="U8_RGB_RT",e[e.U8_RGBA_RT=$S(YS.U8,ZS.RGBA,qS.RenderTarget|qS.Normalized)]="U8_RGBA_RT",e[e.U8_RGBA_RT_SRGB=$S(YS.U8,ZS.RGBA,qS.RenderTarget|qS.Normalized|qS.sRGB)]="U8_RGBA_RT_SRGB"}(KS||(KS={}));var fT=lT(0,0,0,0);lT(0,0,0,1);var hT=lT(1,1,1,0);function dT(e){return!(!e||e&e-1)}function pT(e,t){return null!=e?e:t}function vT(e,t){var n=t-1;return e+n&~n}function mT(e,t){e.blendDstFactor=t.blendDstFactor,e.blendSrcFactor=t.blendSrcFactor,e.blendMode=t.blendMode}function gT(e,t){return void 0===e&&(e={}),e.compare=t.compare,e.depthFailOp=t.depthFailOp,e.passOp=t.passOp,e.failOp=t.failOp,e.mask=t.mask,e}function _T(e,t){return void 0===e&&(e={rgbBlendState:{},alphaBlendState:{},channelWriteMask:0}),mT(e.rgbBlendState,t.rgbBlendState),mT(e.alphaBlendState,t.alphaBlendState),e.channelWriteMask=t.channelWriteMask,e}function yT(e,t){e.length!==t.length&&(e.length=t.length);for(var n=0;n<t.length;n++)e[n]=_T(e[n],t[n])}function ET(e){var t=Object.assign({},e);return t.attachmentsState=[],yT(t.attachmentsState,e.attachmentsState),t.blendConstant=t.blendConstant&&cT(t.blendConstant),t.stencilFront=gT(void 0,e.stencilFront),t.stencilBack=gT(void 0,e.stencilBack),t}lT(1,1,1,1);var bT={blendMode:LS.ADD,blendSrcFactor:wS.ONE,blendDstFactor:wS.ZERO},AT={attachmentsState:[{channelWriteMask:zS.ALL,rgbBlendState:bT,alphaBlendState:bT}],blendConstant:cT(fT),depthWrite:!0,depthCompare:RS.LEQUAL,stencilWrite:!1,stencilFront:{compare:RS.ALWAYS,passOp:jS.KEEP,depthFailOp:jS.KEEP,failOp:jS.KEEP},stencilBack:{compare:RS.ALWAYS,passOp:jS.KEEP,depthFailOp:jS.KEEP,failOp:jS.KEEP},cullMode:MS.NONE,frontFace:CS.CCW,polygonOffset:!1};!function(e,t){void 0===e&&(e=null),void 0===t&&(t=AT);var n=ET(t);null!==e&&function(e,t){void 0!==t.attachmentsState&&yT(e.attachmentsState,t.attachmentsState),e.blendConstant&&t.blendConstant&&uT(e.blendConstant,t.blendConstant),e.depthCompare=pT(t.depthCompare,e.depthCompare),e.depthWrite=pT(t.depthWrite,e.depthWrite),e.stencilWrite=pT(t.stencilWrite,e.stencilWrite),e.stencilFront&&t.stencilFront&&gT(e.stencilFront,t.stencilFront),e.stencilBack&&t.stencilBack&&gT(e.stencilBack,t.stencilBack),e.cullMode=pT(t.cullMode,e.cullMode),e.frontFace=pT(t.frontFace,e.frontFace),e.polygonOffset=pT(t.polygonOffset,e.polygonOffset)}(n,e)}({depthCompare:RS.ALWAYS,depthWrite:!1},AT);var xT,ST={texture:null,sampler:null,formatKind:VS.Float,dimension:US.TEXTURE_2D};function TT(e,t,n){if(e.length!==t.length)return!1;for(var r=0;r<e.length;r++)if(!n(e[r],t[r]))return!1;return!0}function RT(e,t){for(var n=Array(e.length),r=0;r<e.length;r++)n[r]=t(e[r]);return n}function CT(e,t){return e.texture===t.texture&&e.binding===t.binding}function MT(e,t){return e.buffer===t.buffer&&e.size===t.size&&e.binding===t.binding&&e.offset===t.offset}function wT(e,t){return null===e?null===t:null!==t&&(e.sampler===t.sampler&&e.texture===t.texture&&e.dimension===t.dimension&&e.formatKind===t.formatKind&&e.comparison===t.comparison)}function LT(e,t){return e.samplerBindings=e.samplerBindings||[],e.uniformBufferBindings=e.uniformBufferBindings||[],e.storageBufferBindings=e.storageBufferBindings||[],e.storageTextureBindings=e.storageTextureBindings||[],t.samplerBindings=t.samplerBindings||[],t.uniformBufferBindings=t.uniformBufferBindings||[],t.storageBufferBindings=t.storageBufferBindings||[],t.storageTextureBindings=t.storageTextureBindings||[],e.samplerBindings.length===t.samplerBindings.length&&(!!TT(e.samplerBindings,t.samplerBindings,wT)&&(!!TT(e.uniformBufferBindings,t.uniformBufferBindings,MT)&&(!!TT(e.storageBufferBindings,t.storageBufferBindings,MT)&&!!TT(e.storageTextureBindings,t.storageTextureBindings,CT))))}function OT(e,t){return e.blendMode==t.blendMode&&e.blendSrcFactor===t.blendSrcFactor&&e.blendDstFactor===t.blendDstFactor}function kT(e,t){return!!OT(e.rgbBlendState,t.rgbBlendState)&&(!!OT(e.alphaBlendState,t.alphaBlendState)&&e.channelWriteMask===t.channelWriteMask)}function NT(e,t){return e.compare==t.compare&&e.depthFailOp===t.depthFailOp&&e.failOp===t.failOp&&e.passOp===t.passOp&&e.mask===t.mask}function IT(e,t){return e.id===t.id}function PT(e,t){return e===t}function DT(e,t){return e.topology===t.topology&&(e.inputLayout===t.inputLayout&&(e.sampleCount===t.sampleCount&&(!(e.megaStateDescriptor&&t.megaStateDescriptor&&!function(e,t){return!(!TT(e.attachmentsState,t.attachmentsState,kT)||e.blendConstant&&t.blendConstant&&!sT(e.blendConstant,t.blendConstant)||e.stencilFront&&t.stencilFront&&!NT(e.stencilFront,t.stencilFront)||e.stencilBack&&t.stencilBack&&!NT(e.stencilBack,t.stencilBack)||e.depthCompare!==t.depthCompare||e.depthWrite!==t.depthWrite||e.stencilWrite!==t.stencilWrite||e.cullMode!==t.cullMode||e.frontFace!==t.frontFace||e.polygonOffset!==t.polygonOffset)}(e.megaStateDescriptor,t.megaStateDescriptor))&&(!!IT(e.program,t.program)&&(!!TT(e.colorAttachmentFormats,t.colorAttachmentFormats,PT)&&e.depthStencilAttachmentFormat===t.depthStencilAttachmentFormat)))))}function FT(e,t){return e.offset===t.offset&&e.shaderLocation===t.shaderLocation&&e.format===t.format&&e.divisor===t.divisor}function BT(e,t){return lS(e)?lS(t):!lS(t)&&(e.arrayStride===t.arrayStride&&e.stepMode===t.stepMode&&TT(e.attributes,t.attributes,FT))}function UT(e,t){return e.indexBufferFormat===t.indexBufferFormat&&(!!TT(e.vertexBufferDescriptors,t.vertexBufferDescriptors,BT)&&!!IT(e.program,t.program))}function GT(e){return{sampler:e.sampler,texture:e.texture,dimension:e.dimension,formatKind:e.formatKind,comparison:e.comparison}}function zT(e){var t=e.buffer,n=e.size;return{binding:e.binding,buffer:t,offset:e.offset,size:n}}function jT(e){return{binding:e.binding,texture:e.texture}}function VT(e){return{shaderLocation:e.shaderLocation,format:e.format,offset:e.offset,divisor:e.divisor}}function HT(e){return lS(e)?e:{arrayStride:e.arrayStride,stepMode:e.stepMode,attributes:RT(e.attributes,VT)}}var XT=/([^[]*)(\[[0-9]+\])?/;function WT(e){if("]"!==e[e.length-1])return{name:e,length:1,isArray:!1};var t=e.match(XT);if(!t||t.length<2)throw new Error("Failed to parse GLSL uniform name ".concat(e));return{name:t[1],length:Number(t[2])||1,isArray:Boolean(t[2])}}function YT(){var e=null;return function(t,n,r){var i=e!==r;return i&&(t.uniform1i(n,r),e=r),i}}function ZT(e,t,n,r){var i=null,o=null;return function(a,s,u){var c=t(u,n),l=c.length,f=!1;if(null===i)i=new Float32Array(l),o=l,f=!0;else{oT(o===l,"Uniform length cannot change.");for(var h=0;h<l;++h)if(c[h]!==i[h]){f=!0;break}}return f&&(r(a,e,s,c),i.set(c)),f}}function qT(e,t,n,r){e[t](n,r)}function KT(e,t,n,r){e[t](n,!1,r)}var QT={},$T={},JT={},eR=[0];function tR(e,t,n,r){1===t&&"boolean"==typeof e&&(e=e?1:0),Number.isFinite(e)&&(eR[0]=e,e=eR);var i=e.length;if(e instanceof n)return e;var o=r[i];o||(o=new n(i),r[i]=o);for(var a=0;a<i;a++)o[a]=e[a];return o}function nR(e,t){return tR(e,t,Float32Array,QT)}function rR(e,t){return tR(e,t,Int32Array,$T)}function iR(e,t){return tR(e,t,Uint32Array,JT)}var oR=((xT={})[SS.FLOAT]=ZT.bind(null,"uniform1fv",nR,1,qT),xT[SS.FLOAT_VEC2]=ZT.bind(null,"uniform2fv",nR,2,qT),xT[SS.FLOAT_VEC3]=ZT.bind(null,"uniform3fv",nR,3,qT),xT[SS.FLOAT_VEC4]=ZT.bind(null,"uniform4fv",nR,4,qT),xT[SS.INT]=ZT.bind(null,"uniform1iv",rR,1,qT),xT[SS.INT_VEC2]=ZT.bind(null,"uniform2iv",rR,2,qT),xT[SS.INT_VEC3]=ZT.bind(null,"uniform3iv",rR,3,qT),xT[SS.INT_VEC4]=ZT.bind(null,"uniform4iv",rR,4,qT),xT[SS.BOOL]=ZT.bind(null,"uniform1iv",rR,1,qT),xT[SS.BOOL_VEC2]=ZT.bind(null,"uniform2iv",rR,2,qT),xT[SS.BOOL_VEC3]=ZT.bind(null,"uniform3iv",rR,3,qT),xT[SS.BOOL_VEC4]=ZT.bind(null,"uniform4iv",rR,4,qT),xT[SS.FLOAT_MAT2]=ZT.bind(null,"uniformMatrix2fv",nR,4,KT),xT[SS.FLOAT_MAT3]=ZT.bind(null,"uniformMatrix3fv",nR,9,KT),xT[SS.FLOAT_MAT4]=ZT.bind(null,"uniformMatrix4fv",nR,16,KT),xT[SS.UNSIGNED_INT]=ZT.bind(null,"uniform1uiv",iR,1,qT),xT[SS.UNSIGNED_INT_VEC2]=ZT.bind(null,"uniform2uiv",iR,2,qT),xT[SS.UNSIGNED_INT_VEC3]=ZT.bind(null,"uniform3uiv",iR,3,qT),xT[SS.UNSIGNED_INT_VEC4]=ZT.bind(null,"uniform4uiv",iR,4,qT),xT[SS.FLOAT_MAT2x3]=ZT.bind(null,"uniformMatrix2x3fv",nR,6,KT),xT[SS.FLOAT_MAT2x4]=ZT.bind(null,"uniformMatrix2x4fv",nR,8,KT),xT[SS.FLOAT_MAT3x2]=ZT.bind(null,"uniformMatrix3x2fv",nR,6,KT),xT[SS.FLOAT_MAT3x4]=ZT.bind(null,"uniformMatrix3x4fv",nR,12,KT),xT[SS.FLOAT_MAT4x2]=ZT.bind(null,"uniformMatrix4x2fv",nR,8,KT),xT[SS.FLOAT_MAT4x3]=ZT.bind(null,"uniformMatrix4x3fv",nR,12,KT),xT[SS.SAMPLER_2D]=YT,xT[SS.SAMPLER_CUBE]=YT,xT[SS.SAMPLER_3D]=YT,xT[SS.SAMPLER_2D_SHADOW]=YT,xT[SS.SAMPLER_2D_ARRAY]=YT,xT[SS.SAMPLER_2D_ARRAY_SHADOW]=YT,xT[SS.SAMPLER_CUBE_SHADOW]=YT,xT[SS.INT_SAMPLER_2D]=YT,xT[SS.INT_SAMPLER_3D]=YT,xT[SS.INT_SAMPLER_CUBE]=YT,xT[SS.INT_SAMPLER_2D_ARRAY]=YT,xT[SS.UNSIGNED_INT_SAMPLER_2D]=YT,xT[SS.UNSIGNED_INT_SAMPLER_3D]=YT,xT[SS.UNSIGNED_INT_SAMPLER_CUBE]=YT,xT[SS.UNSIGNED_INT_SAMPLER_2D_ARRAY]=YT,xT);function aR(e,t,n){var r=oR[n.type];if(!r)throw new Error("Unknown GLSL uniform type ".concat(n.type));return r().bind(null,e,t)}var sR={"[object Int8Array]":5120,"[object Int16Array]":5122,"[object Int32Array]":5124,"[object Uint8Array]":5121,"[object Uint8ClampedArray]":5121,"[object Uint16Array]":5123,"[object Uint32Array]":5125,"[object Float32Array]":5126,"[object Float64Array]":5121,"[object ArrayBuffer]":5121};function uR(e,t){return"#define ".concat(e," ").concat(t)}function cR(e){if(void 0===e)return null;var t=/binding\s*=\s*(\d+)/.exec(e);if(null!==t){var n=parseInt(t[1],10);if(!Number.isNaN(n))return n}return null}function lR(e){return[e,""]}function fR(e,t,n,r,i){var o;void 0===r&&(r=null),void 0===i&&(i=!0);var a="#version 100"===e.glslVersion,s="frag"===t&&(null===(o=n.match(/^\s*layout\(location\s*=\s*\d*\)\s*out\s+vec4\s*(.*);$/gm))||void 0===o?void 0:o.length)>1,u=n.replace("\r\n","\n").split("\n").map((function(e){return e.replace(/[/][/].*$/,"")})).filter((function(e){return!(!e||/^\s+$/.test(e))})),c="";null!==r&&(c=Object.keys(r).map((function(e){return uR(e,r[e])})).join("\n"));var l=u.find((function(e){return e.startsWith("precision")}))||"precision mediump float;",f=i?u.filter((function(e){return!e.startsWith("precision")})).join("\n"):u.join("\n"),h="";if(e.viewportOrigin===HS.UPPER_LEFT&&(h+="".concat(uR("VIEWPORT_ORIGIN_TL","1"),"\n")),e.clipSpaceNearZ===XS.ZERO&&(h+="".concat(uR("CLIPSPACE_NEAR_ZERO","1"),"\n")),e.explicitBindingLocations){var d=0,p=0,v=0;f=f.replace(/^\s*(layout\((.*)\))?\s*uniform(.+{)$/gm,(function(e,t,n,r){var i=n?"".concat(n,", "):"";return"layout(".concat(i,"set = ").concat(d,", binding = ").concat(p++,") uniform ").concat(r)})),d++,p=0,oT(e.separateSamplerTextures),f=f.replace(/^\s*(layout\((.*)\))?\s*uniform sampler(\w+) (.*);/gm,(function(e,n,r,i,o){var a=cR(r);null===a&&(a=p++);var s=bS(lR(i),2),u=s[0],c=s[1];return"frag"===t?"\nlayout(set = ".concat(d,", binding = ").concat(2*a+0,") uniform texture").concat(u," T_").concat(o,";\nlayout(set = ").concat(d,", binding = ").concat(2*a+1,") uniform sampler").concat(c," S_").concat(o,";").trim():""})),f=f.replace("frag"===t?/^\s*\b(varying|in)\b/gm:/^\s*\b(varying|out)\b/gm,(function(e,t){return"layout(location = ".concat(v++,") ").concat(t)})),h+="".concat(uR("gl_VertexID","gl_VertexIndex"),"\n"),h+="".concat(uR("gl_InstanceID","gl_InstanceIndex"),"\n"),l=l.replace(/^precision (.*) sampler(.*);$/gm,"")}else{var m=0;f=f.replace(/^\s*(layout\((.*)\))?\s*uniform sampler(\w+) (.*);/gm,(function(e,t,n,r,i){var o=cR(n);return null===o&&(o=m++),"uniform sampler".concat(r," ").concat(i,"; // BINDING=").concat(o)}))}if(f=(f=(f=f.replace(/\bPU_SAMPLER_(\w+)\((.*?)\)/g,(function(e,t,n){return"SAMPLER_".concat(t,"(P_").concat(n,")")}))).replace(/\bPF_SAMPLER_(\w+)\((.*?)\)/g,(function(e,t,n){return"PP_SAMPLER_".concat(t,"(P_").concat(n,")")}))).replace(/\bPU_TEXTURE\((.*?)\)/g,(function(e,t){return"TEXTURE(P_".concat(t,")")})),e.separateSamplerTextures)f=f.replace(/\bPD_SAMPLER_(\w+)\((.*?)\)/g,(function(e,t,n){var r=bS(lR(t),2),i=r[0],o=r[1];return"texture".concat(i," T_P_").concat(n,", sampler").concat(o," S_P_").concat(n)})),f=(f=(f=f.replace(/\bPP_SAMPLER_(\w+)\((.*?)\)/g,(function(e,t,n){return"T_".concat(n,", S_").concat(n)}))).replace(/\bSAMPLER_(\w+)\((.*?)\)/g,(function(e,t,n){return"sampler".concat(t,"(T_").concat(n,", S_").concat(n,")")}))).replace(/\bTEXTURE\((.*?)\)/g,(function(e,t){return"T_".concat(t)}));else{var g=[];f=(f=(f=f.replace(/\bPD_SAMPLER_(\w+)\((.*?)\)/g,(function(e,t,n){return"sampler".concat(t," P_").concat(n)}))).replace(/\bPP_SAMPLER_(\w+)\((.*?)\)/g,(function(e,t,n){return n}))).replace(/\bSAMPLER_(\w+)\((.*?)\)/g,(function(e,t,n){return g.push([n,t]),n})),a&&g.forEach((function(e){var t=bS(e,2),n=t[0],r=t[1];f=f.replace(new RegExp("texture\\(".concat(n),"g"),(function(){return"texture".concat(r,"(").concat(n)}))})),f=f.replace(/\bTEXTURE\((.*?)\)/g,(function(e,t){return t}))}var _="".concat(a?"":e.glslVersion,"\n").concat(a&&s?"#extension GL_EXT_draw_buffers : require\n":"","\n").concat(a&&"frag"===t?"#extension GL_OES_standard_derivatives : enable\n":"").concat(i?l:"","\n").concat(h||"").concat(c?c+"\n":"","\n").concat(f,"\n").trim();if(e.explicitBindingLocations&&"frag"===t&&(_=_.replace(/^\b(out)\b/g,(function(e,t){return"layout(location = 0) ".concat(t)}))),a){if("frag"===t&&(_=_.replace(/^\s*in\s+(\S+)\s*(.*);$/gm,(function(e,t,n){return"varying ".concat(t," ").concat(n,";\n")}))),"vert"===t&&(_=(_=_.replace(/^\s*out\s+(\S+)\s*(.*);$/gm,(function(e,t,n){return"varying ".concat(t," ").concat(n,";\n")}))).replace(/^\s*layout\(location\s*=\s*\S*\)\s*in\s+(\S+)\s*(.*);$/gm,(function(e,t,n){return"attribute ".concat(t," ").concat(n,";\n")}))),_=_.replace(/\s*uniform\s*.*\s*{((?:\s*.*\s*)*?)};/g,(function(e,t){return t.trim().replace(/^.*$/gm,(function(e){var t=e.trim();return t.startsWith("#")?t:e?"uniform ".concat(t):""}))})),"frag"===t)if(s){var y=[],E=(_=_.replace(/^\s*layout\(location\s*=\s*\d*\)\s*out\s+vec4\s*(.*);$/gm,(function(e,t){return y.push(t),"vec4 ".concat(t,";\n")}))).lastIndexOf("}");_=_.substring(0,E)+"\n    ".concat(y.map((function(e,t){return"gl_FragData[".concat(t,"] = ").concat(e,";\n    ")})).join("\n"))+_.substring(E)}else{var b;if(_=_.replace(/^\s*out\s+(\S+)\s*(.*);$/gm,(function(e,t,n){return b=n,"".concat(t," ").concat(n,";\n")})),b){E=_.lastIndexOf("}");_=_.substring(0,E)+"\n  gl_FragColor = vec4(".concat(b,");\n")+_.substring(E)}}_=_.replace(/^\s*layout\((.*)\)/gm,"")}return _}var hR=function(e){function t(t){var n=t.id,r=t.device,i=e.call(this)||this;return i.id=n,i.device=r,null!==i.device.resourceCreationTracker&&i.device.resourceCreationTracker.trackResourceCreated(i),i}return mS(t,e),t.prototype.destroy=function(){null!==this.device.resourceCreationTracker&&this.device.resourceCreationTracker.trackResourceDestroyed(this)},t}(QS),dR=function(e){function t(t){var n=t.id,r=t.device,i=t.descriptor,o=e.call(this,{id:n,device:r})||this;o.type=TS.Bindings;var a=i.uniformBufferBindings,s=i.samplerBindings;return o.uniformBufferBindings=a||[],o.samplerBindings=s||[],o.bindingLayouts=o.createBindingLayouts(),o}return mS(t,e),t.prototype.createBindingLayouts=function(){var e=0,t=0,n=[],r=this.uniformBufferBindings.length,i=this.samplerBindings.length;return n.push({firstUniformBuffer:e,numUniformBuffers:r,firstSampler:t,numSamplers:i}),{numUniformBuffers:e+=r,numSamplers:t+=i,bindingLayoutTables:n}},t}(hR);function pR(e){return"undefined"!=typeof WebGL2RenderingContext&&e instanceof WebGL2RenderingContext||Boolean(e&&2===e._version)}function vR(e){switch(eT(e)){case YS.BC1:case YS.BC2:case YS.BC3:case YS.BC4_UNORM:case YS.BC4_SNORM:case YS.BC5_UNORM:case YS.BC5_SNORM:return!0;default:return!1}}function mR(e){if(tT(e)&qS.Normalized)return!1;var t=eT(e);return t===YS.S8||t===YS.S16||t===YS.S32||(t===YS.U8||t===YS.U16||t===YS.U32)}function gR(e){return e&PS.INDEX?SS.ELEMENT_ARRAY_BUFFER:e&PS.VERTEX?SS.ARRAY_BUFFER:e&PS.UNIFORM?SS.UNIFORM_BUFFER:void 0}function _R(e){var t=eT(e),n=JS(e),r=tT(e),i=function(e){switch(e){case YS.U8:return SS.UNSIGNED_BYTE;case YS.U16:return SS.UNSIGNED_SHORT;case YS.U32:return SS.UNSIGNED_INT;case YS.S8:return SS.BYTE;case YS.S16:return SS.SHORT;case YS.S32:return SS.INT;case YS.F16:return SS.HALF_FLOAT;case YS.F32:return SS.FLOAT;default:throw new Error("whoops")}}(t),o=function(e){switch(e){case ZS.R:return 1;case ZS.RG:return 2;case ZS.RGB:return 3;case ZS.RGBA:return 4;default:return 1}}(n);return{size:o,type:i,normalized:!!(r&qS.Normalized)}}function yR(e){switch(e){case OS.CLAMP_TO_EDGE:return SS.CLAMP_TO_EDGE;case OS.REPEAT:return SS.REPEAT;case OS.MIRRORED_REPEAT:return SS.MIRRORED_REPEAT;default:throw new Error("whoops")}}function ER(e,t){if(t===NS.LINEAR&&e===kS.BILINEAR)return SS.LINEAR_MIPMAP_LINEAR;if(t===NS.LINEAR&&e===kS.POINT)return SS.NEAREST_MIPMAP_LINEAR;if(t===NS.NEAREST&&e===kS.BILINEAR)return SS.LINEAR_MIPMAP_NEAREST;if(t===NS.NEAREST&&e===kS.POINT)return SS.NEAREST_MIPMAP_NEAREST;if(t===NS.NO_MIP&&e===kS.BILINEAR)return SS.LINEAR;if(t===NS.NO_MIP&&e===kS.POINT)return SS.NEAREST;throw new Error("Unknown texture filter mode")}function bR(e,t){void 0===t&&(t=0);var n=e;return n.gl_buffer_pages[t/n.pageByteSize|0]}function AR(e){return e.gl_texture}function xR(e){return e.gl_sampler}function SR(e,t){e.name=t,e.__SPECTOR_Metadata={name:t}}function TR(e,t){for(var n=[];;){var r=t.exec(e);if(!r)break;n.push(r)}return n}function RR(e){return e.blendMode==LS.ADD&&e.blendSrcFactor==wS.ONE&&e.blendDstFactor===wS.ZERO}function CR(e){if(e===US.TEXTURE_2D)return SS.TEXTURE_2D;if(e===US.TEXTURE_2D_ARRAY)return SS.TEXTURE_2D_ARRAY;if(e===US.TEXTURE_CUBE_MAP)return SS.TEXTURE_CUBE_MAP;if(e===US.TEXTURE_3D)return SS.TEXTURE_3D;throw new Error("whoops")}function MR(e,t,n,r){return e%n==0&&t%r==0}var wR,LR=function(e){function t(t){var n=t.id,r=t.device,i=t.descriptor,o=e.call(this,{id:n,device:r})||this;o.type=TS.Buffer;var a=i.viewOrSize,s=i.usage,u=i.hint,c=void 0===u?DS.STATIC:u,l=r.uniformBufferMaxPageByteSize,f=r.gl,h=s&PS.UNIFORM;h||(pR(f)?f.bindVertexArray(null):r.OES_vertex_array_object.bindVertexArrayOES(null));var d,p=pS(a)?vT(a,4):vT(a.byteLength,4);if(o.gl_buffer_pages=[],h){for(var v=p;v>0;)o.gl_buffer_pages.push(o.createBufferPage(Math.min(v,l),s,c)),v-=l;d=l}else o.gl_buffer_pages.push(o.createBufferPage(p,s,c)),d=p;return o.pageByteSize=d,o.byteSize=p,o.usage=s,o.gl_target=gR(s),pS(a)||o.setSubData(0,new Uint8Array(a.buffer)),h||(pR(f)?f.bindVertexArray(o.device.currentBoundVAO):r.OES_vertex_array_object.bindVertexArrayOES(o.device.currentBoundVAO)),o}return mS(t,e),t.prototype.setSubData=function(e,t,n,r){void 0===n&&(n=0),void 0===r&&(r=t.byteLength-n);for(var i=this.device.gl,o=this.pageByteSize,a=e+r,s=e,u=e%o;s<a;){var c=pR(i)?i.COPY_WRITE_BUFFER:this.gl_target,l=bR(this,s);if(l.ubo)return;i.bindBuffer(c,l),pR(i)?i.bufferSubData(c,u,t,n,Math.min(a-s,o)):i.bufferSubData(c,u,t),s+=o,u=0,n+=o,this.device.debugGroupStatisticsBufferUpload()}},t.prototype.destroy=function(){e.prototype.destroy.call(this);for(var t=0;t<this.gl_buffer_pages.length;t++)this.gl_buffer_pages[t].ubo||this.device.gl.deleteBuffer(this.gl_buffer_pages[t]);this.gl_buffer_pages=[]},t.prototype.createBufferPage=function(e,t,n){var r=this.device.gl,i=t&PS.UNIFORM;if(!pR(r)&&i)return{ubo:!0};var o=this.device.ensureResourceExists(r.createBuffer()),a=gR(t),s=function(e){switch(e){case DS.STATIC:return SS.STATIC_DRAW;case DS.DYNAMIC:return SS.DYNAMIC_DRAW}}(n);return r.bindBuffer(a,o),r.bufferData(a,e,s),o},t}(hR),OR=function(e){function t(t){var n,r,i,o,a,s=t.id,u=t.device,c=t.descriptor,l=e.call(this,{id:s,device:u})||this;l.type=TS.InputLayout;var f=c.vertexBufferDescriptors,h=c.indexBufferFormat,d=c.program;oT(h===KS.U16_R||h===KS.U32_R||null===h);var p=null!==h?function(e){switch(e){case KS.U8_R:return SS.UNSIGNED_BYTE;case KS.U16_R:return SS.UNSIGNED_SHORT;case KS.U32_R:return SS.UNSIGNED_INT;default:throw new Error("whoops")}}(h):null,v=null!==h?rT(h):null,m=l.device.gl,g=l.device.ensureResourceExists(pR(m)?m.createVertexArray():u.OES_vertex_array_object.createVertexArrayOES());pR(m)?m.bindVertexArray(g):u.OES_vertex_array_object.bindVertexArrayOES(g),m.bindBuffer(m.ARRAY_BUFFER,bR(l.device.fallbackVertexBuffer));try{for(var _=ES(c.vertexBufferDescriptors),y=_.next();!y.done;y=_.next()){var E=y.value,b=E.stepMode,A=E.attributes;try{for(var x=(i=void 0,ES(A)),S=x.next();!S.done;S=x.next()){var T=S.value,R=T.shaderLocation,C=T.format,M=T.divisor,w=void 0===M?1:M,L=pR(m)?R:null===(a=d.attributes[R])||void 0===a?void 0:a.location,O=_R(C);if(T.vertexFormat=O,!lS(L)){mR(C);var k=O.size,N=O.type,I=O.normalized;m.vertexAttribPointer(L,k,N,I,0,0),b===FS.INSTANCE&&(pR(m)?m.vertexAttribDivisor(L,w):u.ANGLE_instanced_arrays.vertexAttribDivisorANGLE(L,w)),m.enableVertexAttribArray(L)}}}catch(P){i={error:P}}finally{try{S&&!S.done&&(o=x.return)&&o.call(x)}finally{if(i)throw i.error}}}}catch(D){n={error:D}}finally{try{y&&!y.done&&(r=_.return)&&r.call(_)}finally{if(n)throw n.error}}return pR(m)?m.bindVertexArray(null):u.OES_vertex_array_object.bindVertexArrayOES(null),l.vertexBufferDescriptors=f,l.vao=g,l.indexBufferFormat=h,l.indexBufferType=p,l.indexBufferCompByteSize=v,l.program=d,l}return mS(t,e),t.prototype.destroy=function(){e.prototype.destroy.call(this),this.device.currentBoundVAO===this.vao&&(pR(this.device.gl)?(this.device.gl.bindVertexArray(null),this.device.gl.deleteVertexArray(this.vao)):(this.device.OES_vertex_array_object.bindVertexArrayOES(null),this.device.OES_vertex_array_object.deleteVertexArrayOES(this.vao)),this.device.currentBoundVAO=null)},t}(hR),kR=function(e){function t(t){var n=t.id,r=t.device,i=t.descriptor,o=t.fake,a=e.call(this,{id:n,device:r})||this;a.type=TS.Texture,i=gS({dimension:US.TEXTURE_2D,depthOrArrayLayers:1,mipLevelCount:1},i);var s,u,c=a.device.gl,l=a.clampmipLevelCount(i);if(a.immutable=i.usage===GS.RENDER_TARGET,a.pixelStore=i.pixelStore,a.format=i.format,a.dimension=i.dimension,a.formatKind=iT(i.format),a.width=i.width,a.height=i.height,a.depthOrArrayLayers=i.depthOrArrayLayers,a.mipmaps=l>=1,!o){u=a.device.ensureResourceExists(c.createTexture());var f=a.device.translateTextureType(i.format),h=a.device.translateTextureInternalFormat(i.format);if(a.device.setActiveTexture(c.TEXTURE0),a.device.currentTextures[0]=null,a.preprocessImage(),i.dimension===US.TEXTURE_2D){if(s=SS.TEXTURE_2D,c.bindTexture(s,u),a.immutable)if(pR(c))c.texStorage2D(s,l,h,i.width,i.height);else{var d=(h===SS.DEPTH_COMPONENT||a.isNPOT(),0);(a.format!==KS.D32F&&a.format!==KS.D24_S8||pR(c)||r.WEBGL_depth_texture)&&(c.texImage2D(s,d,h,i.width,i.height,0,h,f,null),a.mipmaps&&(a.mipmaps=!1,c.texParameteri(SS.TEXTURE_2D,SS.TEXTURE_MIN_FILTER,SS.LINEAR),c.texParameteri(SS.TEXTURE_2D,SS.TEXTURE_WRAP_S,SS.CLAMP_TO_EDGE),c.texParameteri(SS.TEXTURE_2D,SS.TEXTURE_WRAP_T,SS.CLAMP_TO_EDGE)))}oT(1===i.depthOrArrayLayers)}else if(i.dimension===US.TEXTURE_2D_ARRAY)s=SS.TEXTURE_2D_ARRAY,c.bindTexture(s,u),a.immutable&&pR(c)&&c.texStorage3D(s,l,h,i.width,i.height,i.depthOrArrayLayers);else if(i.dimension===US.TEXTURE_3D)s=SS.TEXTURE_3D,c.bindTexture(s,u),a.immutable&&pR(c)&&c.texStorage3D(s,l,h,i.width,i.height,i.depthOrArrayLayers);else{if(i.dimension!==US.TEXTURE_CUBE_MAP)throw new Error("whoops");s=SS.TEXTURE_CUBE_MAP,c.bindTexture(s,u),a.immutable&&pR(c)&&c.texStorage2D(s,l,h,i.width,i.height),oT(6===i.depthOrArrayLayers)}}return a.gl_texture=u,a.gl_target=s,a.mipLevelCount=l,a}return mS(t,e),t.prototype.setImageData=function(e,t){void 0===t&&(t=0);var n=this.device.gl;vR(this.format);var r,i=this.gl_target===SS.TEXTURE_3D||this.gl_target===SS.TEXTURE_2D_ARRAY,o=this.gl_target===SS.TEXTURE_CUBE_MAP,a=(r=e[0],Object.prototype.toString.call(r)in sR);this.device.setActiveTexture(n.TEXTURE0),this.device.currentTextures[0]=null;var s,u,c=e[0];a?(s=this.width,u=this.height):(s=c.width,u=c.height,this.width=s,this.height=u),n.bindTexture(this.gl_target,this.gl_texture);var l=this.device.translateTextureFormat(this.format),f=pR(n)?this.device.translateInternalTextureFormat(this.format):l,h=this.device.translateTextureType(this.format);this.preprocessImage();for(var d=0;d<this.depthOrArrayLayers;d++){var p=e[d],v=this.gl_target;o&&(v=SS.TEXTURE_CUBE_MAP_POSITIVE_X+d%6),this.immutable?n.texSubImage2D(v,t,0,0,s,u,l,h,p):pR(n)?i?n.texImage3D(v,t,f,s,u,this.depthOrArrayLayers,0,l,h,p):n.texImage2D(v,t,f,s,u,0,l,h,p):a?n.texImage2D(v,t,l,s,u,0,l,h,p):n.texImage2D(v,t,l,l,h,p)}this.mipmaps&&this.generateMipmap(i)},t.prototype.destroy=function(){e.prototype.destroy.call(this),this.device.gl.deleteTexture(AR(this))},t.prototype.clampmipLevelCount=function(e){if(e.dimension===US.TEXTURE_2D_ARRAY&&e.depthOrArrayLayers>1&&eT(e.format)===YS.BC1)for(var t=e.width,n=e.height,r=0;r<e.mipLevelCount;r++){if(t<=2||n<=2)return r-1;t=Math.max(t/2|0,1),n=Math.max(n/2|0,1)}return e.mipLevelCount},t.prototype.preprocessImage=function(){var e=this.device.gl;this.pixelStore&&(this.pixelStore.unpackFlipY&&e.pixelStorei(SS.UNPACK_FLIP_Y_WEBGL,!0),this.pixelStore.packAlignment&&e.pixelStorei(SS.PACK_ALIGNMENT,this.pixelStore.packAlignment),this.pixelStore.unpackAlignment&&e.pixelStorei(SS.UNPACK_ALIGNMENT,this.pixelStore.unpackAlignment))},t.prototype.generateMipmap=function(e){void 0===e&&(e=!1);var t=this.device.gl;return!pR(t)&&this.isNPOT()||this.gl_texture&&this.gl_target&&(t.bindTexture(this.gl_target,this.gl_texture),e?(t.texParameteri(this.gl_target,SS.TEXTURE_BASE_LEVEL,0),t.texParameteri(this.gl_target,SS.TEXTURE_MAX_LEVEL,Math.log2(this.width)),t.texParameteri(this.gl_target,SS.TEXTURE_MIN_FILTER,SS.LINEAR_MIPMAP_LINEAR),t.texParameteri(this.gl_target,SS.TEXTURE_MAG_FILTER,SS.LINEAR)):t.texParameteri(SS.TEXTURE_2D,SS.TEXTURE_MIN_FILTER,SS.NEAREST_MIPMAP_LINEAR),t.generateMipmap(this.gl_target),t.bindTexture(this.gl_target,null)),this},t.prototype.isNPOT=function(){return!pR(this.device.gl)&&(!dT(this.width)||!dT(this.height))},t}(hR),NR=function(e){function t(t){var n=t.id,r=t.device,i=t.descriptor,o=e.call(this,{id:n,device:r})||this;o.type=TS.RenderTarget,o.gl_renderbuffer=null,o.texture=null;var a=o.device.gl,s=i.format,u=i.width,c=i.height,l=i.sampleCount,f=void 0===l?1:l,h=i.texture,d=!1;if(s!==KS.D32F&&s!==KS.D24_S8||!h||pR(a)||r.WEBGL_depth_texture||(h.destroy(),o.texture=null,d=!0),!d&&h)o.texture=h;else{o.gl_renderbuffer=o.device.ensureResourceExists(a.createRenderbuffer()),a.bindRenderbuffer(a.RENDERBUFFER,o.gl_renderbuffer);var p=o.device.translateTextureInternalFormat(s,!0);pR(a)&&f>1?a.renderbufferStorageMultisample(SS.RENDERBUFFER,f,p,u,c):a.renderbufferStorage(SS.RENDERBUFFER,p,u,c)}return o.format=s,o.width=u,o.height=c,o.sampleCount=f,o}return mS(t,e),t.prototype.destroy=function(){e.prototype.destroy.call(this),null!==this.gl_renderbuffer&&this.device.gl.deleteRenderbuffer(this.gl_renderbuffer),this.texture&&this.texture.destroy()},t}(hR);!function(e){e[e.NeedsCompile=0]="NeedsCompile",e[e.Compiling=1]="Compiling",e[e.NeedsBind=2]="NeedsBind",e[e.ReadyToUse=3]="ReadyToUse"}(wR||(wR={}));var IR,PR=function(e){function t(t,n){var r=t.id,i=t.device,o=t.descriptor,a=e.call(this,{id:r,device:i})||this;a.rawVertexGLSL=n,a.type=TS.Program,a.uniformSetters={},a.attributes=[];var s=a.device.gl;return a.descriptor=o,a.gl_program=a.device.ensureResourceExists(s.createProgram()),a.gl_shader_vert=null,a.gl_shader_frag=null,a.compileState=wR.NeedsCompile,a.tryCompileProgram(),a}return mS(t,e),t.prototype.destroy=function(){e.prototype.destroy.call(this),this.device.gl.deleteProgram(this.gl_program),this.device.gl.deleteShader(this.gl_shader_vert),this.device.gl.deleteShader(this.gl_shader_frag)},t.prototype.tryCompileProgram=function(){oT(this.compileState===wR.NeedsCompile);var e=this.descriptor,t=e.vertex,n=e.fragment,r=this.device.gl;(null==t?void 0:t.glsl)&&(null==n?void 0:n.glsl)&&(this.gl_shader_vert=this.compileShader(t.postprocess?t.postprocess(t.glsl):t.glsl,r.VERTEX_SHADER),this.gl_shader_frag=this.compileShader(n.postprocess?n.postprocess(n.glsl):n.glsl,r.FRAGMENT_SHADER),r.attachShader(this.gl_program,this.gl_shader_vert),r.attachShader(this.gl_program,this.gl_shader_frag),r.linkProgram(this.gl_program),this.compileState=wR.Compiling,pR(r)||(this.readUniformLocationsFromLinkedProgram(),this.readAttributesFromLinkedProgram()))},t.prototype.readAttributesFromLinkedProgram=function(){for(var e,t=this.device.gl,n=t.getProgramParameter(this.gl_program,t.ACTIVE_ATTRIBUTES),r=function(e){var t={};return e.replace(/^\s*#define\s*(\S*)\s*(\S*)\s*$/gm,(function(e,n,r){var i=Number(r);return t[n]=isNaN(i)?r:i,""})),t}(this.descriptor.vertex.glsl),i=function(e,t){var n=[];return e.replace(/^\s*layout\(location\s*=\s*(\S*)\)\s*in\s+\S+\s*(.*);$/gm,(function(e,r,i){var o=Number(r);return n.push({location:isNaN(o)?t[r]:o,name:i}),""})),n}(this.rawVertexGLSL,r),o=function(n){var r=t.getActiveAttrib(a.gl_program,n),o=r.name,s=r.type,u=r.size,c=t.getAttribLocation(a.gl_program,o),l=null===(e=i.find((function(e){return e.name===o})))||void 0===e?void 0:e.location;c>=0&&!lS(l)&&(a.attributes[l]={name:o,location:c,type:s,size:u})},a=this,s=0;s<n;s++)o(s)},t.prototype.readUniformLocationsFromLinkedProgram=function(){for(var e=this.device.gl,t=e.getProgramParameter(this.gl_program,e.ACTIVE_UNIFORMS),n=0;n<t;n++){var r=e.getActiveUniform(this.gl_program,n),i=WT(r.name).name,o=e.getUniformLocation(this.gl_program,i);if(this.uniformSetters[i]=aR(e,o,r),r&&r.size>1)for(var a=0;a<r.size;a++)o=e.getUniformLocation(this.gl_program,"".concat(i,"[").concat(a,"]")),this.uniformSetters["".concat(i,"[").concat(a,"]")]=aR(e,o,r)}},t.prototype.compileShader=function(e,t){var n=this.device.gl,r=this.device.ensureResourceExists(n.createShader(t));return n.shaderSource(r,e),n.compileShader(r),r},t.prototype.setUniformsLegacy=function(e){void 0===e&&(e={});var t=this.device.gl;if(!pR(t)){var n=!1;for(var r in e){n||(t.useProgram(this.gl_program),n=!0);var i=e[r],o=this.uniformSetters[r];if(o){var a=i;a instanceof kR&&(a=a.textureIndex),o(a)}}}return this},t}(hR),DR=function(e){function t(t){var n=t.id,r=t.device,i=t.descriptor,o=e.call(this,{id:n,device:r})||this;o.type=TS.QueryPool;var a=o.device.gl;if(pR(a)){var s=i.elemCount,u=i.type;o.gl_query=function(e,t){for(var n=new Array(e),r=0;r<e;r++)n[r]=t();return n}(s,(function(){return o.device.ensureResourceExists(a.createQuery())})),o.gl_query_type=function(e){if(e===WS.OcclusionConservative)return SS.ANY_SAMPLES_PASSED_CONSERVATIVE;throw new Error("whoops")}(u)}return o}return mS(t,e),t.prototype.queryResultOcclusion=function(e){var t=this.device.gl;if(pR(t)){var n=this.gl_query[e];return t.getQueryParameter(n,t.QUERY_RESULT_AVAILABLE)?!!t.getQueryParameter(n,t.QUERY_RESULT):null}return null},t.prototype.destroy=function(){e.prototype.destroy.call(this);var t=this.device.gl;if(pR(t))for(var n=0;n<this.gl_query.length;n++)t.deleteQuery(this.gl_query[n])},t}(hR),FR=function(e){function t(t){var n=t.id,r=t.device,i=e.call(this,{id:n,device:r})||this;return i.type=TS.Readback,i.gl_pbo=null,i.gl_sync=null,i}return mS(t,e),t.prototype.clientWaitAsync=function(e,t,n){void 0===t&&(t=0),void 0===n&&(n=10);var r=this.device.gl;return new Promise((function(i,o){!function a(){var s=r.clientWaitSync(e,t,0);s!=r.WAIT_FAILED?s!=r.TIMEOUT_EXPIRED?i():setTimeout(a,dS(n,0,r.MAX_CLIENT_WAIT_TIMEOUT_WEBGL)):o()}()}))},t.prototype.getBufferSubDataAsync=function(e,t,n,r,i,o){return _S(this,void 0,void 0,(function(){var a;return yS(this,(function(s){switch(s.label){case 0:return pR(a=this.device.gl)?(this.gl_sync=a.fenceSync(a.SYNC_GPU_COMMANDS_COMPLETE,0),a.flush(),[4,this.clientWaitAsync(this.gl_sync,0,10)]):[3,2];case 1:return s.sent(),a.bindBuffer(e,t),a.getBufferSubData(e,n,r,i,o),a.bindBuffer(e,null),[2,r];case 2:return[2]}}))}))},t.prototype.readTexture=function(e,t,n,r,i,o,a,s){return void 0===a&&(a=0),void 0===s&&(s=o.byteLength||0),_S(this,void 0,void 0,(function(){var u,c,l,f,h;return yS(this,(function(d){var p;return u=this.device.gl,c=e,l=this.device.translateTextureFormat(c.format),f=this.device.translateTextureType(c.format),p=c.format,h=nT(eT(p))*JS(p),pR(u)?(this.gl_pbo=this.device.ensureResourceExists(u.createBuffer()),u.bindBuffer(u.PIXEL_PACK_BUFFER,this.gl_pbo),u.bufferData(u.PIXEL_PACK_BUFFER,s,u.STREAM_READ),u.bindBuffer(u.PIXEL_PACK_BUFFER,null),u.bindFramebuffer(SS.READ_FRAMEBUFFER,this.device.readbackFramebuffer),u.framebufferTexture2D(SS.READ_FRAMEBUFFER,SS.COLOR_ATTACHMENT0,SS.TEXTURE_2D,c.gl_texture,0),u.bindBuffer(u.PIXEL_PACK_BUFFER,this.gl_pbo),u.readPixels(t,n,r,i,l,f,a*h),u.bindBuffer(u.PIXEL_PACK_BUFFER,null),[2,this.getBufferSubDataAsync(u.PIXEL_PACK_BUFFER,this.gl_pbo,0,o,a,0)]):[2,this.readTextureSync(e,t,n,r,i,o,a,s)]}))}))},t.prototype.readTextureSync=function(e,t,n,r,i,o,a,s){void 0===s&&(s=o.byteLength||0);var u=this.device.gl,c=e,l=this.device.translateTextureType(c.format);return u.bindFramebuffer(SS.FRAMEBUFFER,this.device.readbackFramebuffer),u.framebufferTexture2D(SS.FRAMEBUFFER,SS.COLOR_ATTACHMENT0,SS.TEXTURE_2D,c.gl_texture,0),u.pixelStorei(u.PACK_ALIGNMENT,4),u.readPixels(t,n,r,i,u.RGBA,l,o),o},t.prototype.readBuffer=function(e,t,n,r,i){return _S(this,void 0,void 0,(function(){var o;return yS(this,(function(a){return pR(o=this.device.gl)?[2,this.getBufferSubDataAsync(o.ARRAY_BUFFER,bR(e,t),t,n,r,i)]:[2,Promise.reject()]}))}))},t.prototype.destroy=function(){e.prototype.destroy.call(this),pR(this.device.gl)&&(null!==this.gl_sync&&this.device.gl.deleteSync(this.gl_sync),null!==this.gl_pbo&&this.device.gl.deleteBuffer(this.gl_pbo))},t}(hR),BR=function(e){function t(t){var n,r,i=t.id,o=t.device,a=t.descriptor,s=e.call(this,{id:i,device:o})||this;return s.type=TS.RenderPipeline,s.drawMode=function(e){switch(e){case IS.TRIANGLES:return SS.TRIANGLES;case IS.POINTS:return SS.POINTS;case IS.TRIANGLE_STRIP:return SS.TRIANGLE_STRIP;case IS.LINES:return SS.LINES;case IS.LINE_STRIP:return SS.LINE_STRIP;default:throw new Error("Unknown primitive topology mode")}}(null!==(n=a.topology)&&void 0!==n?n:IS.TRIANGLES),s.program=a.program,s.inputLayout=a.inputLayout,s.megaState=gS(gS({},ET(AT)),a.megaStateDescriptor),s.colorAttachmentFormats=a.colorAttachmentFormats.slice(),s.depthStencilAttachmentFormat=a.depthStencilAttachmentFormat,s.sampleCount=null!==(r=a.sampleCount)&&void 0!==r?r:1,s}return mS(t,e),t}(hR),UR=function(e){function t(t){var n=t.id,r=t.device,i=t.descriptor,o=e.call(this,{id:n,device:r})||this;return o.type=TS.ComputePipeline,o.descriptor=i,o}return mS(t,e),t}(hR),GR=function(){function e(){this.liveObjects=new Set,this.creationStacks=new Map,this.deletionStacks=new Map}return e.prototype.trackResourceCreated=function(e){this.creationStacks.set(e,(new Error).stack),this.liveObjects.add(e)},e.prototype.trackResourceDestroyed=function(e){this.deletionStacks.has(e)&&console.warn("Object double freed:",e,"\n\nCreation stack: ",this.creationStacks.get(e),"\n\nDeletion stack: ",this.deletionStacks.get(e),"\n\nThis stack: ",(new Error).stack),this.deletionStacks.set(e,(new Error).stack),this.liveObjects.delete(e)},e.prototype.checkForLeaks=function(){var e,t;try{for(var n=ES(this.liveObjects.values()),r=n.next();!r.done;r=n.next()){var i=r.value;console.warn("Object leaked:",i,"Creation stack:",this.creationStacks.get(i))}}catch(o){e={error:o}}finally{try{r&&!r.done&&(t=n.return)&&t.call(n)}finally{if(e)throw e.error}}},e.prototype.setResourceLeakCheck=function(e,t){t?this.liveObjects.add(e):this.liveObjects.delete(e)},e}(),zR=function(e){function t(t){var n,r,i=t.id,o=t.device,a=t.descriptor,s=e.call(this,{id:i,device:o})||this;s.type=TS.Sampler;var u=s.device.gl;if(pR(u)){var c=s.device.ensureResourceExists(u.createSampler());u.samplerParameteri(c,SS.TEXTURE_WRAP_S,yR(a.addressModeU)),u.samplerParameteri(c,SS.TEXTURE_WRAP_T,yR(a.addressModeV)),u.samplerParameteri(c,SS.TEXTURE_WRAP_R,yR(null!==(n=a.addressModeW)&&void 0!==n?n:a.addressModeU)),u.samplerParameteri(c,SS.TEXTURE_MIN_FILTER,ER(a.minFilter,a.mipmapFilter)),u.samplerParameteri(c,SS.TEXTURE_MAG_FILTER,ER(a.magFilter,NS.NO_MIP)),void 0!==a.lodMinClamp&&u.samplerParameterf(c,SS.TEXTURE_MIN_LOD,a.lodMinClamp),void 0!==a.lodMaxClamp&&u.samplerParameterf(c,SS.TEXTURE_MAX_LOD,a.lodMaxClamp),void 0!==a.compareFunction&&(u.samplerParameteri(c,u.TEXTURE_COMPARE_MODE,u.COMPARE_REF_TO_TEXTURE),u.samplerParameteri(c,u.TEXTURE_COMPARE_FUNC,a.compareFunction));var l=null!==(r=a.maxAnisotropy)&&void 0!==r?r:1;l>1&&null!==s.device.EXT_texture_filter_anisotropic&&(oT(a.minFilter===kS.BILINEAR&&a.magFilter===kS.BILINEAR&&a.mipmapFilter===NS.LINEAR),u.samplerParameterf(c,s.device.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,l)),s.gl_sampler=c}else s.descriptor=a;return s}return mS(t,e),t.prototype.setTextureParameters=function(e,t,n){var r,i=this.device.gl,o=this.descriptor;this.isNPOT(t,n)?i.texParameteri(SS.TEXTURE_2D,SS.TEXTURE_MIN_FILTER,SS.LINEAR):i.texParameteri(e,SS.TEXTURE_MIN_FILTER,ER(o.minFilter,o.mipmapFilter)),i.texParameteri(SS.TEXTURE_2D,SS.TEXTURE_WRAP_S,yR(o.addressModeU)),i.texParameteri(SS.TEXTURE_2D,SS.TEXTURE_WRAP_T,yR(o.addressModeV)),i.texParameteri(e,SS.TEXTURE_MAG_FILTER,ER(o.magFilter,NS.NO_MIP));var a=null!==(r=o.maxAnisotropy)&&void 0!==r?r:1;a>1&&null!==this.device.EXT_texture_filter_anisotropic&&(oT(o.minFilter===kS.BILINEAR&&o.magFilter===kS.BILINEAR&&o.mipmapFilter===NS.LINEAR),i.texParameteri(e,this.device.EXT_texture_filter_anisotropic.TEXTURE_MAX_ANISOTROPY_EXT,a))},t.prototype.destroy=function(){e.prototype.destroy.call(this),pR(this.device.gl)&&this.device.gl.deleteSampler(xR(this))},t.prototype.isNPOT=function(e,t){return!dT(e)||!dT(t)},t}(hR),jR=function(){function e(){}return e.prototype.dispatchWorkgroups=function(e,t,n){},e.prototype.dispatchWorkgroupsIndirect=function(e,t){},e.prototype.setPipeline=function(e){},e.prototype.setBindings=function(e){},e.prototype.pushDebugGroup=function(e){},e.prototype.popDebugGroup=function(){},e.prototype.insertDebugMarker=function(e){},e}(),VR=function(e){function t(){var t=null!==e&&e.apply(this,arguments)||this;return t.type=TS.RenderBundle,t.commands=[],t}return mS(t,e),t.prototype.push=function(e){this.commands.push(e)},t.prototype.replay=function(){this.commands.forEach((function(e){return e()}))},t}(hR),HR=/uniform(?:\s+)(\w+)(?:\s?){([^]*?)}/g,XR=function(){function e(e,t){void 0===t&&(t={}),this.shaderDebug=!1,this.OES_vertex_array_object=null,this.ANGLE_instanced_arrays=null,this.OES_texture_float=null,this.OES_draw_buffers_indexed=null,this.WEBGL_draw_buffers=null,this.WEBGL_depth_texture=null,this.WEBGL_color_buffer_float=null,this.EXT_color_buffer_half_float=null,this.WEBGL_compressed_texture_s3tc=null,this.WEBGL_compressed_texture_s3tc_srgb=null,this.EXT_texture_compression_rgtc=null,this.EXT_texture_filter_anisotropic=null,this.KHR_parallel_shader_compile=null,this.EXT_texture_norm16=null,this.EXT_color_buffer_float=null,this.OES_texture_float_linear=null,this.OES_texture_half_float_linear=null,this.scTexture=null,this.scPlatformFramebuffer=null,this.currentActiveTexture=null,this.currentBoundVAO=null,this.currentProgram=null,this.resourceCreationTracker=null,this.resourceUniqueId=0,this.currentColorAttachments=[],this.currentColorAttachmentLevels=[],this.currentColorResolveTos=[],this.currentColorResolveToLevels=[],this.currentSampleCount=-1,this.currentIndexBufferByteOffset=null,this.currentMegaState=ET(AT),this.currentSamplers=[],this.currentTextures=[],this.currentUniformBuffers=[],this.currentUniformBufferByteOffsets=[],this.currentUniformBufferByteSizes=[],this.currentScissorEnabled=!1,this.currentStencilRef=null,this.currentRenderPassDescriptor=null,this.currentRenderPassDescriptorStack=[],this.debugGroupStack=[],this.resolveColorAttachmentsChanged=!1,this.resolveDepthStencilAttachmentsChanged=!1,this.explicitBindingLocations=!1,this.separateSamplerTextures=!1,this.viewportOrigin=HS.LOWER_LEFT,this.clipSpaceNearZ=XS.NEGATIVE_ONE,this.supportMRT=!1,this.inBlitRenderPass=!1,this.supportedSampleCounts=[],this.occlusionQueriesRecommended=!1,this.computeShadersSupported=!1,this.gl=e,this.contextAttributes=aT(e.getContextAttributes()),pR(e)?(this.EXT_texture_norm16=e.getExtension("EXT_texture_norm16"),this.EXT_color_buffer_float=e.getExtension("EXT_color_buffer_float")):(this.OES_vertex_array_object=e.getExtension("OES_vertex_array_object"),this.ANGLE_instanced_arrays=e.getExtension("ANGLE_instanced_arrays"),this.OES_texture_float=e.getExtension("OES_texture_float"),this.WEBGL_draw_buffers=e.getExtension("WEBGL_draw_buffers"),this.WEBGL_depth_texture=e.getExtension("WEBGL_depth_texture"),this.WEBGL_color_buffer_float=e.getExtension("WEBGL_color_buffer_float"),this.EXT_color_buffer_half_float=e.getExtension("EXT_color_buffer_half_float"),e.getExtension("EXT_frag_depth"),e.getExtension("OES_element_index_uint"),e.getExtension("OES_standard_derivatives")),this.WEBGL_compressed_texture_s3tc=e.getExtension("WEBGL_compressed_texture_s3tc"),this.WEBGL_compressed_texture_s3tc_srgb=e.getExtension("WEBGL_compressed_texture_s3tc_srgb"),this.EXT_texture_compression_rgtc=e.getExtension("EXT_texture_compression_rgtc"),this.EXT_texture_filter_anisotropic=e.getExtension("EXT_texture_filter_anisotropic"),this.EXT_texture_norm16=e.getExtension("EXT_texture_norm16"),this.OES_texture_float_linear=e.getExtension("OES_texture_float_linear"),this.OES_texture_half_float_linear=e.getExtension("OES_texture_half_float_linear"),this.KHR_parallel_shader_compile=e.getExtension("KHR_parallel_shader_compile"),pR(e)?(this.platformString="WebGL2",this.glslVersion="#version 300 es"):(this.platformString="WebGL1",this.glslVersion="#version 100"),this.scTexture=new kR({id:this.getNextUniqueId(),device:this,descriptor:{width:0,height:0,depthOrArrayLayers:1,dimension:US.TEXTURE_2D,mipLevelCount:1,usage:GS.RENDER_TARGET,format:!1===this.contextAttributes.alpha?KS.U8_RGB_RT:KS.U8_RGBA_RT},fake:!0}),this.scTexture.formatKind=VS.Float,this.scTexture.gl_target=null,this.scTexture.gl_texture=null,this.resolveColorReadFramebuffer=this.ensureResourceExists(e.createFramebuffer()),this.resolveColorDrawFramebuffer=this.ensureResourceExists(e.createFramebuffer()),this.resolveDepthStencilReadFramebuffer=this.ensureResourceExists(e.createFramebuffer()),this.resolveDepthStencilDrawFramebuffer=this.ensureResourceExists(e.createFramebuffer()),this.renderPassDrawFramebuffer=this.ensureResourceExists(e.createFramebuffer()),this.readbackFramebuffer=this.ensureResourceExists(e.createFramebuffer()),this.fallbackTexture2D=this.createFallbackTexture(US.TEXTURE_2D,VS.Float),this.fallbackTexture2DDepth=this.createFallbackTexture(US.TEXTURE_2D,VS.Depth),this.fallbackVertexBuffer=this.createBuffer({viewOrSize:1,usage:PS.VERTEX,hint:DS.STATIC}),pR(e)&&(this.fallbackTexture2DArray=this.createFallbackTexture(US.TEXTURE_2D_ARRAY,VS.Float),this.fallbackTexture3D=this.createFallbackTexture(US.TEXTURE_3D,VS.Float),this.fallbackTextureCube=this.createFallbackTexture(US.TEXTURE_CUBE_MAP,VS.Float)),this.currentMegaState.depthCompare=RS.LESS,this.currentMegaState.depthWrite=!1,this.currentMegaState.attachmentsState[0].channelWriteMask=zS.ALL,e.enable(e.DEPTH_TEST),e.enable(e.STENCIL_TEST),this.checkLimits(),t.shaderDebug&&(this.shaderDebug=!0),t.trackResources&&(this.resourceCreationTracker=new GR)}return e.prototype.destroy=function(){this.blitBindings&&this.blitBindings.destroy(),this.blitInputLayout&&this.blitInputLayout.destroy(),this.blitRenderPipeline&&this.blitRenderPipeline.destroy(),this.blitVertexBuffer&&this.blitVertexBuffer.destroy(),this.blitProgram&&this.blitProgram.destroy()},e.prototype.createFallbackTexture=function(e,t){var n=e===US.TEXTURE_CUBE_MAP?6:1,r=t===VS.Depth?KS.D32F:KS.U8_RGBA_NORM,i=this.createTexture({dimension:e,format:r,usage:GS.SAMPLED,width:1,height:1,depthOrArrayLayers:n,mipLevelCount:1});return t===VS.Float&&i.setImageData([new Uint8Array(4*n)]),AR(i)},e.prototype.getNextUniqueId=function(){return++this.resourceUniqueId},e.prototype.checkLimits=function(){var e=this.gl;if(this.maxVertexAttribs=e.getParameter(SS.MAX_VERTEX_ATTRIBS),pR(e)){this.uniformBufferMaxPageByteSize=Math.min(e.getParameter(SS.MAX_UNIFORM_BLOCK_SIZE),65536),this.uniformBufferWordAlignment=e.getParameter(e.UNIFORM_BUFFER_OFFSET_ALIGNMENT)/4;var t=e.getInternalformatParameter(e.RENDERBUFFER,e.DEPTH32F_STENCIL8,e.SAMPLES);this.supportedSampleCounts=t?AS([],bS(t),!1):[],this.occlusionQueriesRecommended=!0}else this.uniformBufferWordAlignment=64,this.uniformBufferMaxPageByteSize=65536;this.uniformBufferMaxPageWordSize=this.uniformBufferMaxPageByteSize/4,this.supportedSampleCounts.includes(1)||this.supportedSampleCounts.push(1),this.supportedSampleCounts.sort((function(e,t){return e-t}))},e.prototype.configureSwapChain=function(e,t,n){var r,i=this.scTexture;i.width=e,i.height=t,this.scPlatformFramebuffer=void 0===(r=n)?null:r},e.prototype.getDevice=function(){return this},e.prototype.getCanvas=function(){return this.gl.canvas},e.prototype.getOnscreenTexture=function(){return this.scTexture},e.prototype.beginFrame=function(){},e.prototype.endFrame=function(){},e.prototype.translateTextureInternalFormat=function(e,t){switch(void 0===t&&(t=!1),e){case KS.ALPHA:return SS.ALPHA;case KS.U8_LUMINANCE:case KS.F16_LUMINANCE:case KS.F32_LUMINANCE:return SS.LUMINANCE;case KS.F16_R:return SS.R16F;case KS.F16_RG:return SS.RG16F;case KS.F16_RGB:return SS.RGB16F;case KS.F16_RGBA:return SS.RGBA16F;case KS.F32_R:return SS.R32F;case KS.F32_RG:return SS.RG32F;case KS.F32_RGB:return SS.RGB32F;case KS.F32_RGBA:return pR(this.gl)?SS.RGBA32F:t?this.WEBGL_color_buffer_float.RGBA32F_EXT:SS.RGBA;case KS.U8_R_NORM:return SS.R8;case KS.U8_RG_NORM:return SS.RG8;case KS.U8_RGB_NORM:case KS.U8_RGB_RT:return SS.RGB8;case KS.U8_RGB_SRGB:return SS.SRGB8;case KS.U8_RGBA_NORM:case KS.U8_RGBA_RT:return pR(this.gl)?SS.RGBA8:t?SS.RGBA4:SS.RGBA;case KS.U8_RGBA:return SS.RGBA;case KS.U8_RGBA_SRGB:case KS.U8_RGBA_RT_SRGB:return SS.SRGB8_ALPHA8;case KS.U16_R:return SS.R16UI;case KS.U16_R_NORM:return this.EXT_texture_norm16.R16_EXT;case KS.U16_RG_NORM:return this.EXT_texture_norm16.RG16_EXT;case KS.U16_RGBA_NORM:return this.EXT_texture_norm16.RGBA16_EXT;case KS.U16_RGBA_5551:return SS.RGB5_A1;case KS.U16_RGB_565:return SS.RGB565;case KS.U32_R:return SS.R32UI;case KS.S8_RGBA_NORM:return SS.RGBA8_SNORM;case KS.S8_RG_NORM:return SS.RG8_SNORM;case KS.BC1:return this.WEBGL_compressed_texture_s3tc.COMPRESSED_RGBA_S3TC_DXT1_EXT;case KS.BC1_SRGB:return this.WEBGL_compressed_texture_s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT1_EXT;case KS.BC2:return this.WEBGL_compressed_texture_s3tc.COMPRESSED_RGBA_S3TC_DXT3_EXT;case KS.BC2_SRGB:return this.WEBGL_compressed_texture_s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT3_EXT;case KS.BC3:return this.WEBGL_compressed_texture_s3tc.COMPRESSED_RGBA_S3TC_DXT5_EXT;case KS.BC3_SRGB:return this.WEBGL_compressed_texture_s3tc_srgb.COMPRESSED_SRGB_ALPHA_S3TC_DXT5_EXT;case KS.BC4_UNORM:return this.EXT_texture_compression_rgtc.COMPRESSED_RED_RGTC1_EXT;case KS.BC4_SNORM:return this.EXT_texture_compression_rgtc.COMPRESSED_SIGNED_RED_RGTC1_EXT;case KS.BC5_UNORM:return this.EXT_texture_compression_rgtc.COMPRESSED_RED_GREEN_RGTC2_EXT;case KS.BC5_SNORM:return this.EXT_texture_compression_rgtc.COMPRESSED_SIGNED_RED_GREEN_RGTC2_EXT;case KS.D32F_S8:return pR(this.gl)?SS.DEPTH32F_STENCIL8:this.WEBGL_depth_texture?SS.DEPTH_STENCIL:SS.DEPTH_COMPONENT16;case KS.D24_S8:return pR(this.gl)?SS.DEPTH24_STENCIL8:this.WEBGL_depth_texture?SS.DEPTH_STENCIL:SS.DEPTH_COMPONENT16;case KS.D32F:return pR(this.gl)?SS.DEPTH_COMPONENT32F:this.WEBGL_depth_texture?SS.DEPTH_COMPONENT:SS.DEPTH_COMPONENT16;case KS.D24:return pR(this.gl)?SS.DEPTH_COMPONENT24:this.WEBGL_depth_texture?SS.DEPTH_COMPONENT:SS.DEPTH_COMPONENT16;default:throw new Error("whoops")}},e.prototype.translateTextureType=function(e){switch(eT(e)){case YS.U8:return SS.UNSIGNED_BYTE;case YS.U16:return SS.UNSIGNED_SHORT;case YS.U32:return SS.UNSIGNED_INT;case YS.S8:return SS.BYTE;case YS.F16:return SS.HALF_FLOAT;case YS.F32:return SS.FLOAT;case YS.U16_PACKED_5551:return SS.UNSIGNED_SHORT_5_5_5_1;case YS.D32F:return pR(this.gl)?SS.FLOAT:this.WEBGL_depth_texture?SS.UNSIGNED_INT:SS.UNSIGNED_BYTE;case YS.D24:return pR(this.gl)?SS.UNSIGNED_INT_24_8:this.WEBGL_depth_texture?SS.UNSIGNED_SHORT:SS.UNSIGNED_BYTE;case YS.D24S8:return pR(this.gl)?SS.UNSIGNED_INT_24_8:this.WEBGL_depth_texture?SS.UNSIGNED_INT_24_8_WEBGL:SS.UNSIGNED_BYTE;case YS.D32FS8:return SS.FLOAT_32_UNSIGNED_INT_24_8_REV;default:throw new Error("whoops")}},e.prototype.translateInternalTextureFormat=function(e){switch(e){case KS.F32_R:return SS.R32F;case KS.F32_RG:return SS.RG32F;case KS.F32_RGB:return SS.RGB32F;case KS.F32_RGBA:return SS.RGBA32F;case KS.F16_R:return SS.R16F;case KS.F16_RG:return SS.RG16F;case KS.F16_RGB:return SS.RGB16F;case KS.F16_RGBA:return SS.RGBA16F}return this.translateTextureFormat(e)},e.prototype.translateTextureFormat=function(e){if(vR(e)||e===KS.F32_LUMINANCE||e===KS.U8_LUMINANCE)return this.translateTextureInternalFormat(e);var t=pR(this.gl)||!pR(this.gl)&&!!this.WEBGL_depth_texture;switch(e){case KS.D24_S8:case KS.D32F_S8:return t?SS.DEPTH_STENCIL:SS.RGBA;case KS.D24:case KS.D32F:return t?SS.DEPTH_COMPONENT:SS.RGBA}var n=mR(e);switch(JS(e)){case ZS.A:return SS.ALPHA;case ZS.R:return n?SS.RED_INTEGER:SS.RED;case ZS.RG:return n?SS.RG_INTEGER:SS.RG;case ZS.RGB:return n?SS.RGB_INTEGER:SS.RGB;case ZS.RGBA:return SS.RGBA}},e.prototype.setActiveTexture=function(e){this.currentActiveTexture!==e&&(this.gl.activeTexture(e),this.currentActiveTexture=e)},e.prototype.bindVAO=function(e){this.currentBoundVAO!==e&&(pR(this.gl)?this.gl.bindVertexArray(e):this.OES_vertex_array_object.bindVertexArrayOES(e),this.currentBoundVAO=e)},e.prototype.programCompiled=function(e){oT(e.compileState!==wR.NeedsCompile),e.compileState===wR.Compiling&&(e.compileState=wR.NeedsBind,this.shaderDebug&&this.checkProgramCompilationForErrors(e))},e.prototype.useProgram=function(e){this.currentProgram!==e&&(this.programCompiled(e),this.gl.useProgram(e.gl_program),this.currentProgram=e)},e.prototype.ensureResourceExists=function(e){if(null===e){var t=this.gl.getError();throw new Error("Created resource is null; GL error encountered: ".concat(t))}return e},e.prototype.createBuffer=function(e){return new LR({id:this.getNextUniqueId(),device:this,descriptor:e})},e.prototype.createTexture=function(e){return new kR({id:this.getNextUniqueId(),device:this,descriptor:e})},e.prototype.createSampler=function(e){return new zR({id:this.getNextUniqueId(),device:this,descriptor:e})},e.prototype.createRenderTarget=function(e){return new NR({id:this.getNextUniqueId(),device:this,descriptor:e})},e.prototype.createRenderTargetFromTexture=function(e){var t=e,n=t.format,r=t.width,i=t.height;return oT(1===t.mipLevelCount),this.createRenderTarget({format:n,width:r,height:i,sampleCount:1,texture:e})},e.prototype.createProgram=function(e){var t,n,r,i=null===(t=e.vertex)||void 0===t?void 0:t.glsl;return(null===(n=e.vertex)||void 0===n?void 0:n.glsl)&&(e.vertex.glsl=fR(this.queryVendorInfo(),"vert",e.vertex.glsl)),(null===(r=e.fragment)||void 0===r?void 0:r.glsl)&&(e.fragment.glsl=fR(this.queryVendorInfo(),"frag",e.fragment.glsl)),this.createProgramSimple(e,i)},e.prototype.createProgramSimple=function(e,t){return new PR({id:this.getNextUniqueId(),device:this,descriptor:e},t)},e.prototype.createBindings=function(e){return new dR({id:this.getNextUniqueId(),device:this,descriptor:e})},e.prototype.createInputLayout=function(e){return new OR({id:this.getNextUniqueId(),device:this,descriptor:e})},e.prototype.createRenderPipeline=function(e){return new BR({id:this.getNextUniqueId(),device:this,descriptor:e})},e.prototype.createComputePass=function(){return new jR},e.prototype.createComputePipeline=function(e){return new UR({id:this.getNextUniqueId(),device:this,descriptor:e})},e.prototype.createReadback=function(){return new FR({id:this.getNextUniqueId(),device:this})},e.prototype.createQueryPool=function(e,t){return new DR({id:this.getNextUniqueId(),device:this,descriptor:{type:e,elemCount:t}})},e.prototype.formatRenderPassDescriptor=function(e){var t,n,r,i,o,a,s=e.colorAttachment;e.depthClearValue=null!==(t=e.depthClearValue)&&void 0!==t?t:"load",e.stencilClearValue=null!==(n=e.stencilClearValue)&&void 0!==n?n:"load";for(var u=0;u<s.length;u++)e.colorAttachmentLevel||(e.colorAttachmentLevel=[]),e.colorAttachmentLevel[u]=null!==(r=e.colorAttachmentLevel[u])&&void 0!==r?r:0,e.colorResolveToLevel||(e.colorResolveToLevel=[]),e.colorResolveToLevel[u]=null!==(i=e.colorResolveToLevel[u])&&void 0!==i?i:0,e.colorClearColor||(e.colorClearColor=[]),e.colorClearColor[u]=null!==(o=e.colorClearColor[u])&&void 0!==o?o:"load",e.colorStore||(e.colorStore=[]),e.colorStore[u]=null!==(a=e.colorStore[u])&&void 0!==a&&a},e.prototype.createRenderBundle=function(){return new VR({id:this.getNextUniqueId(),device:this})},e.prototype.beginBundle=function(e){this.renderBundle=e},e.prototype.endBundle=function(){this.renderBundle=void 0},e.prototype.executeBundles=function(e){e.forEach((function(e){e.replay()}))},e.prototype.createRenderPass=function(e){null!==this.currentRenderPassDescriptor&&this.currentRenderPassDescriptorStack.push(this.currentRenderPassDescriptor),this.currentRenderPassDescriptor=e,this.formatRenderPassDescriptor(e);var t=e.colorAttachment,n=e.colorAttachmentLevel,r=e.colorClearColor,i=e.colorResolveTo,o=e.colorResolveToLevel,a=e.depthStencilAttachment,s=e.depthClearValue,u=e.stencilClearValue,c=e.depthStencilResolveTo;this.setRenderPassParametersBegin(t.length);for(var l=0;l<t.length;l++)this.setRenderPassParametersColor(l,t[l],n[l],i[l],o[l]);this.setRenderPassParametersDepthStencil(a,c),this.validateCurrentAttachments();for(l=0;l<t.length;l++){var f=r[l];"load"!==f&&this.setRenderPassParametersClearColor(l,f.r,f.g,f.b,f.a)}return this.setRenderPassParametersClearDepthStencil(s,u),this},e.prototype.submitPass=function(e){oT(null!==this.currentRenderPassDescriptor),this.endPass(),this.currentRenderPassDescriptorStack.length?this.currentRenderPassDescriptor=this.currentRenderPassDescriptorStack.pop():this.currentRenderPassDescriptor=null},e.prototype.copySubTexture2D=function(e,t,n,r,i,o){var a=this.gl,s=e,u=r;if(oT(1===u.mipLevelCount),oT(1===s.mipLevelCount),pR(a))s===this.scTexture?a.bindFramebuffer(a.DRAW_FRAMEBUFFER,this.scPlatformFramebuffer):(a.bindFramebuffer(a.DRAW_FRAMEBUFFER,this.resolveColorDrawFramebuffer),this.bindFramebufferAttachment(a.DRAW_FRAMEBUFFER,a.COLOR_ATTACHMENT0,s,0)),a.bindFramebuffer(a.READ_FRAMEBUFFER,this.resolveColorReadFramebuffer),this.bindFramebufferAttachment(a.READ_FRAMEBUFFER,a.COLOR_ATTACHMENT0,u,0),a.blitFramebuffer(i,o,i+u.width,o+u.height,t,n,t+u.width,n+u.height,a.COLOR_BUFFER_BIT,a.LINEAR),a.bindFramebuffer(a.READ_FRAMEBUFFER,null),a.bindFramebuffer(a.DRAW_FRAMEBUFFER,null);else if(s===this.scTexture){var c=this.createRenderTargetFromTexture(r);this.submitBlitRenderPass(c,s)}},e.prototype.queryLimits=function(){return this},e.prototype.queryTextureFormatSupported=function(e,t,n){switch(e){case KS.BC1_SRGB:case KS.BC2_SRGB:case KS.BC3_SRGB:return null!==this.WEBGL_compressed_texture_s3tc_srgb&&MR(t,n,4,4);case KS.BC1:case KS.BC2:case KS.BC3:return null!==this.WEBGL_compressed_texture_s3tc&&MR(t,n,4,4);case KS.BC4_UNORM:case KS.BC4_SNORM:case KS.BC5_UNORM:case KS.BC5_SNORM:return null!==this.EXT_texture_compression_rgtc&&MR(t,n,4,4);case KS.U16_R_NORM:case KS.U16_RG_NORM:case KS.U16_RGBA_NORM:return null!==this.EXT_texture_norm16;case KS.F32_R:case KS.F32_RG:case KS.F32_RGB:case KS.F32_RGBA:return null!==this.OES_texture_float_linear;case KS.F16_R:case KS.F16_RG:case KS.F16_RGB:case KS.F16_RGBA:return null!==this.OES_texture_half_float_linear;default:return!0}},e.prototype.queryProgramReady=function(e){var t=this.gl;if(e.compileState===wR.NeedsCompile)throw new Error("whoops");if(e.compileState===wR.Compiling){var n=void 0;return(n=null===this.KHR_parallel_shader_compile||t.getProgramParameter(e.gl_program,this.KHR_parallel_shader_compile.COMPLETION_STATUS_KHR))&&this.programCompiled(e),n}return e.compileState===wR.NeedsBind||e.compileState===wR.ReadyToUse},e.prototype.queryPlatformAvailable=function(){return this.gl.isContextLost()},e.prototype.queryVendorInfo=function(){return this},e.prototype.queryRenderPass=function(e){return this.currentRenderPassDescriptor},e.prototype.queryRenderTarget=function(e){return e},e.prototype.setResourceName=function(e,t){if(e.name=t,e.type===TS.Buffer)for(var n=e.gl_buffer_pages,r=0;r<n.length;r++)SR(n[r],"".concat(t," Page ").concat(r));else if(e.type===TS.Texture)SR(AR(e),t);else if(e.type===TS.Sampler)SR(xR(e),t);else if(e.type===TS.RenderTarget){var i=e.gl_renderbuffer;null!==i&&SR(i,t)}else e.type===TS.InputLayout&&SR(e.vao,t)},e.prototype.setResourceLeakCheck=function(e,t){null!==this.resourceCreationTracker&&this.resourceCreationTracker.setResourceLeakCheck(e,t)},e.prototype.checkForLeaks=function(){null!==this.resourceCreationTracker&&this.resourceCreationTracker.checkForLeaks()},e.prototype.pushDebugGroup=function(e){},e.prototype.popDebugGroup=function(){},e.prototype.insertDebugMarker=function(e){},e.prototype.programPatched=function(e,t){oT(this.shaderDebug)},e.prototype.getBufferData=function(e,t,n){void 0===n&&(n=0);var r=this.gl;pR(r)&&(r.bindBuffer(r.COPY_READ_BUFFER,bR(e,4*n)),r.getBufferSubData(r.COPY_READ_BUFFER,4*n,t))},e.prototype.debugGroupStatisticsDrawCall=function(e){void 0===e&&(e=1);for(var t=this.debugGroupStack.length-1;t>=0;t--)this.debugGroupStack[t].drawCallCount+=e},e.prototype.debugGroupStatisticsBufferUpload=function(e){void 0===e&&(e=1);for(var t=this.debugGroupStack.length-1;t>=0;t--)this.debugGroupStack[t].bufferUploadCount+=e},e.prototype.debugGroupStatisticsTextureBind=function(e){void 0===e&&(e=1);for(var t=this.debugGroupStack.length-1;t>=0;t--)this.debugGroupStack[t].textureBindCount+=e},e.prototype.debugGroupStatisticsTriangles=function(e){for(var t=this.debugGroupStack.length-1;t>=0;t--)this.debugGroupStack[t].triangleCount+=e},e.prototype.reportShaderError=function(e,t){var n=this.gl,r=n.getShaderParameter(e,n.COMPILE_STATUS);if(!r){console.error(function(e,t){return void 0===t&&(t=1),e.split("\n").map((function(e,n){return"".concat(function(e,t,n){for(void 0===n&&(n="0");e.length<t;)e="".concat(n).concat(e);return e}(""+(t+n),4," "),"  ").concat(e)})).join("\n")}(t));var i=n.getExtension("WEBGL_debug_shaders");i&&console.error(i.getTranslatedShaderSource(e)),console.error(n.getShaderInfoLog(e))}return r},e.prototype.checkProgramCompilationForErrors=function(e){var t=this.gl,n=e.gl_program;if(!t.getProgramParameter(n,t.LINK_STATUS)){var r=e.descriptor;if(!this.reportShaderError(e.gl_shader_vert,r.vertex.glsl))return;if(!this.reportShaderError(e.gl_shader_frag,r.fragment.glsl))return;console.error(t.getProgramInfoLog(e.gl_program))}},e.prototype.bindFramebufferAttachment=function(e,t,n,r){var i=this.gl;if(lS(n))i.framebufferRenderbuffer(e,t,i.RENDERBUFFER,null);else if(n.type===TS.RenderTarget)null!==n.gl_renderbuffer?i.framebufferRenderbuffer(e,t,i.RENDERBUFFER,n.gl_renderbuffer):null!==n.texture&&i.framebufferTexture2D(e,t,SS.TEXTURE_2D,AR(n.texture),r);else if(n.type===TS.Texture){var o=AR(n);n.dimension===US.TEXTURE_2D?i.framebufferTexture2D(e,t,SS.TEXTURE_2D,o,r):pR(i)&&(n.dimension,US.TEXTURE_2D_ARRAY)}},e.prototype.bindFramebufferDepthStencilAttachment=function(e,t){var n=this.gl,r=lS(t)?qS.Depth|qS.Stencil:tT(t.format),i=!!(r&qS.Depth),o=!!(r&qS.Stencil);i&&o?pR(this.gl)||!pR(this.gl)&&!!this.WEBGL_depth_texture?this.bindFramebufferAttachment(e,n.DEPTH_STENCIL_ATTACHMENT,t,0):this.bindFramebufferAttachment(e,n.DEPTH_ATTACHMENT,t,0):i?(this.bindFramebufferAttachment(e,n.DEPTH_ATTACHMENT,t,0),this.bindFramebufferAttachment(e,n.STENCIL_ATTACHMENT,null,0)):o&&(this.bindFramebufferAttachment(e,n.STENCIL_ATTACHMENT,t,0),this.bindFramebufferAttachment(e,n.DEPTH_ATTACHMENT,null,0))},e.prototype.validateCurrentAttachments=function(){for(var e=-1,t=-1,n=-1,r=0;r<this.currentColorAttachments.length;r++){var i=this.currentColorAttachments[r];null!==i&&(-1===e?(e=i.sampleCount,t=i.width,n=i.height):(oT(e===i.sampleCount),oT(t===i.width),oT(n===i.height)))}this.currentDepthStencilAttachment&&(-1===e?e=this.currentDepthStencilAttachment.sampleCount:(oT(e===this.currentDepthStencilAttachment.sampleCount),oT(t===this.currentDepthStencilAttachment.width),oT(n===this.currentDepthStencilAttachment.height))),this.currentSampleCount=e},e.prototype.setRenderPassParametersBegin=function(e){var t=this.gl;if(pR(t)?t.bindFramebuffer(SS.DRAW_FRAMEBUFFER,this.renderPassDrawFramebuffer):this.inBlitRenderPass||t.bindFramebuffer(SS.FRAMEBUFFER,this.renderPassDrawFramebuffer),pR(t)?t.drawBuffers([SS.COLOR_ATTACHMENT0,SS.COLOR_ATTACHMENT1,SS.COLOR_ATTACHMENT2,SS.COLOR_ATTACHMENT3]):!this.inBlitRenderPass&&this.WEBGL_draw_buffers&&this.WEBGL_draw_buffers.drawBuffersWEBGL([SS.COLOR_ATTACHMENT0_WEBGL,SS.COLOR_ATTACHMENT1_WEBGL,SS.COLOR_ATTACHMENT2_WEBGL,SS.COLOR_ATTACHMENT3_WEBGL]),!this.inBlitRenderPass)for(var n=e;n<this.currentColorAttachments.length;n++){var r=pR(t)?SS.DRAW_FRAMEBUFFER:SS.FRAMEBUFFER,i=pR(t)?SS.COLOR_ATTACHMENT0:SS.COLOR_ATTACHMENT0_WEBGL;t.framebufferRenderbuffer(r,i+n,SS.RENDERBUFFER,null),t.framebufferTexture2D(r,i+n,SS.TEXTURE_2D,null,0)}this.currentColorAttachments.length=e},e.prototype.setRenderPassParametersColor=function(e,t,n,r,i){var o=pR(this.gl);this.currentColorAttachments[e]===t&&this.currentColorAttachmentLevels[e]===n||(this.currentColorAttachments[e]=t,this.currentColorAttachmentLevels[e]=n,(o||!o&&this.WEBGL_draw_buffers)&&this.bindFramebufferAttachment(o?SS.DRAW_FRAMEBUFFER:SS.FRAMEBUFFER,(o?SS.COLOR_ATTACHMENT0:SS.COLOR_ATTACHMENT0_WEBGL)+e,t,n),this.resolveColorAttachmentsChanged=!0),this.currentColorResolveTos[e]===r&&this.currentColorResolveToLevels[e]===i||(this.currentColorResolveTos[e]=r,this.currentColorResolveToLevels[e]=i,null!==r&&(this.resolveColorAttachmentsChanged=!0))},e.prototype.setRenderPassParametersDepthStencil=function(e,t){var n=this.gl;this.currentDepthStencilAttachment!==e&&(this.currentDepthStencilAttachment=e,this.inBlitRenderPass||this.bindFramebufferDepthStencilAttachment(pR(n)?SS.DRAW_FRAMEBUFFER:SS.FRAMEBUFFER,this.currentDepthStencilAttachment),this.resolveDepthStencilAttachmentsChanged=!0),this.currentDepthStencilResolveTo!==t&&(this.currentDepthStencilResolveTo=t,t&&(this.resolveDepthStencilAttachmentsChanged=!0))},e.prototype.setRenderPassParametersClearColor=function(e,t,n,r,i){var o,a=this.gl;null!==this.OES_draw_buffers_indexed?(o=this.currentMegaState.attachmentsState[e])&&o.channelWriteMask!==zS.ALL&&(this.OES_draw_buffers_indexed.colorMaskiOES(e,!0,!0,!0,!0),o.channelWriteMask=zS.ALL):(o=this.currentMegaState.attachmentsState[0])&&o.channelWriteMask!==zS.ALL&&(a.colorMask(!0,!0,!0,!0),o.channelWriteMask=zS.ALL);this.setScissorRectEnabled(!1),pR(a)?a.clearBufferfv(a.COLOR,e,[t,n,r,i]):(a.clearColor(t,n,r,i),a.clear(a.COLOR_BUFFER_BIT))},e.prototype.setRenderPassParametersClearDepthStencil=function(e,t){void 0===e&&(e="load"),void 0===t&&(t="load");var n=this.gl;"load"!==e&&(oT(!!this.currentDepthStencilAttachment),this.currentMegaState.depthWrite||(n.depthMask(!0),this.currentMegaState.depthWrite=!0),pR(n)?n.clearBufferfv(n.DEPTH,0,[e]):(n.clearDepth(e),n.clear(n.DEPTH_BUFFER_BIT))),"load"!==t&&(oT(!!this.currentDepthStencilAttachment),this.currentMegaState.stencilWrite||(n.enable(n.STENCIL_TEST),n.stencilMask(255),this.currentMegaState.stencilWrite=!0),pR(n)?n.clearBufferiv(n.STENCIL,0,[t]):(n.clearStencil(t),n.clear(n.STENCIL_BUFFER_BIT)))},e.prototype.setBindings=function(e){var t,n=this;if(this.renderBundle)this.renderBundle.push((function(){return n.setBindings(e)}));else{var r=this.gl,i=e,o=i.uniformBufferBindings,a=i.samplerBindings,s=i.bindingLayouts;oT(0<s.bindingLayoutTables.length);var u=s.bindingLayoutTables[0];oT(o.length>=u.numUniformBuffers),oT(a.length>=u.numSamplers);for(var c=0;c<o.length;c++){if(0!==(m=o[c]).size){var l=u.firstUniformBuffer+c,f=m.buffer,h=m.offset||0,d=m.size||f.byteSize;if(f!==this.currentUniformBuffers[l]||h!==this.currentUniformBufferByteOffsets[l]||d!==this.currentUniformBufferByteSizes[l]){var p=h%f.pageByteSize,v=f.gl_buffer_pages[h/f.pageByteSize|0];oT(p+d<=f.pageByteSize),pR(r)&&r.bindBufferRange(r.UNIFORM_BUFFER,l,v,p,d),this.currentUniformBuffers[l]=f,this.currentUniformBufferByteOffsets[l]=h,this.currentUniformBufferByteSizes[l]=d}}}for(c=0;c<u.numSamplers;c++){var m=a[c],g=u.firstSampler+c,_=null!==m&&null!==m.sampler?xR(m.sampler):null,y=null!==m&&null!==m.texture?AR(m.texture):null;if(this.currentSamplers[g]!==_&&(pR(r)&&r.bindSampler(g,_),this.currentSamplers[g]=_),this.currentTextures[g]!==y){if(this.setActiveTexture(r.TEXTURE0+g),null!==y){var E=aT(m).texture,b=E.gl_target,A=E.width,x=E.height;m.texture.textureIndex=g,r.bindTexture(b,y),pR(r)||null===(t=m.sampler)||void 0===t||t.setTextureParameters(b,A,x),this.debugGroupStatisticsTextureBind()}else{var S=gS(gS({},m),ST),T=S.dimension,R=S.formatKind;b=CR(T);r.bindTexture(b,this.getFallbackTexture(gS({gl_target:b,formatKind:R},S)))}this.currentTextures[g]=y}}}},e.prototype.setViewport=function(e,t,n,r){this.gl.viewport(e,t,n,r)},e.prototype.setScissorRect=function(e,t,n,r){var i=this.gl;this.setScissorRectEnabled(!0),i.scissor(e,t,n,r)},e.prototype.applyAttachmentStateIndexed=function(e,t,n){var r=this.gl,i=this.OES_draw_buffers_indexed;t.channelWriteMask!==n.channelWriteMask&&(i.colorMaskiOES(e,!!(n.channelWriteMask&zS.RED),!!(n.channelWriteMask&zS.GREEN),!!(n.channelWriteMask&zS.BLUE),!!(n.channelWriteMask&zS.ALPHA)),t.channelWriteMask=n.channelWriteMask);var o=t.rgbBlendState.blendMode!==n.rgbBlendState.blendMode||t.alphaBlendState.blendMode!==n.alphaBlendState.blendMode,a=t.rgbBlendState.blendSrcFactor!==n.rgbBlendState.blendSrcFactor||t.alphaBlendState.blendSrcFactor!==n.alphaBlendState.blendSrcFactor||t.rgbBlendState.blendDstFactor!==n.rgbBlendState.blendDstFactor||t.alphaBlendState.blendDstFactor!==n.alphaBlendState.blendDstFactor;(a||o)&&(RR(t.rgbBlendState)&&RR(t.alphaBlendState)?i.enableiOES(e,r.BLEND):RR(n.rgbBlendState)&&RR(n.alphaBlendState)&&i.disableiOES(e,r.BLEND)),o&&(i.blendEquationSeparateiOES(e,n.rgbBlendState.blendMode,n.alphaBlendState.blendMode),t.rgbBlendState.blendMode=n.rgbBlendState.blendMode,t.alphaBlendState.blendMode=n.alphaBlendState.blendMode),a&&(i.blendFuncSeparateiOES(e,n.rgbBlendState.blendSrcFactor,n.rgbBlendState.blendDstFactor,n.alphaBlendState.blendSrcFactor,n.alphaBlendState.blendDstFactor),t.rgbBlendState.blendSrcFactor=n.rgbBlendState.blendSrcFactor,t.alphaBlendState.blendSrcFactor=n.alphaBlendState.blendSrcFactor,t.rgbBlendState.blendDstFactor=n.rgbBlendState.blendDstFactor,t.alphaBlendState.blendDstFactor=n.alphaBlendState.blendDstFactor)},e.prototype.applyAttachmentState=function(e,t){var n=this.gl;e.channelWriteMask!==t.channelWriteMask&&(n.colorMask(!!(t.channelWriteMask&zS.RED),!!(t.channelWriteMask&zS.GREEN),!!(t.channelWriteMask&zS.BLUE),!!(t.channelWriteMask&zS.ALPHA)),e.channelWriteMask=t.channelWriteMask);var r=e.rgbBlendState.blendMode!==t.rgbBlendState.blendMode||e.alphaBlendState.blendMode!==t.alphaBlendState.blendMode,i=e.rgbBlendState.blendSrcFactor!==t.rgbBlendState.blendSrcFactor||e.alphaBlendState.blendSrcFactor!==t.alphaBlendState.blendSrcFactor||e.rgbBlendState.blendDstFactor!==t.rgbBlendState.blendDstFactor||e.alphaBlendState.blendDstFactor!==t.alphaBlendState.blendDstFactor;(i||r)&&(RR(e.rgbBlendState)&&RR(e.alphaBlendState)?n.enable(n.BLEND):RR(t.rgbBlendState)&&RR(t.alphaBlendState)&&n.disable(n.BLEND)),r&&(n.blendEquationSeparate(t.rgbBlendState.blendMode,t.alphaBlendState.blendMode),e.rgbBlendState.blendMode=t.rgbBlendState.blendMode,e.alphaBlendState.blendMode=t.alphaBlendState.blendMode),i&&(n.blendFuncSeparate(t.rgbBlendState.blendSrcFactor,t.rgbBlendState.blendDstFactor,t.alphaBlendState.blendSrcFactor,t.alphaBlendState.blendDstFactor),e.rgbBlendState.blendSrcFactor=t.rgbBlendState.blendSrcFactor,e.alphaBlendState.blendSrcFactor=t.alphaBlendState.blendSrcFactor,e.rgbBlendState.blendDstFactor=t.rgbBlendState.blendDstFactor,e.alphaBlendState.blendDstFactor=t.alphaBlendState.blendDstFactor)},e.prototype.setMegaState=function(e){var t=this.gl,n=this.currentMegaState;if(null!==this.OES_draw_buffers_indexed)for(var r=0;r<e.attachmentsState.length;r++)this.applyAttachmentStateIndexed(r,n.attachmentsState[0],e.attachmentsState[0]);else oT(1===e.attachmentsState.length),this.applyAttachmentState(n.attachmentsState[0],e.attachmentsState[0]);if(sT(n.blendConstant,e.blendConstant)||(t.blendColor(e.blendConstant.r,e.blendConstant.g,e.blendConstant.b,e.blendConstant.a),uT(n.blendConstant,e.blendConstant)),n.depthCompare!==e.depthCompare&&(t.depthFunc(e.depthCompare),n.depthCompare=e.depthCompare),!!n.depthWrite!=!!e.depthWrite&&(t.depthMask(e.depthWrite),n.depthWrite=e.depthWrite),!!n.stencilWrite!=!!e.stencilWrite&&(t.stencilMask(e.stencilWrite?255:0),n.stencilWrite=e.stencilWrite),!NT(n.stencilFront,e.stencilFront)){var i=e.stencilFront,o=i.passOp,a=i.failOp,s=i.depthFailOp,u=i.compare;n.stencilFront.passOp===o&&n.stencilFront.failOp===a&&n.stencilFront.depthFailOp===s||(t.stencilOpSeparate(t.FRONT,a,s,o),n.stencilFront.passOp=o,n.stencilFront.failOp=a,n.stencilFront.depthFailOp=s),n.stencilFront.compare!==u&&(this.setStencilReference(0),n.stencilFront.compare=u)}if(!NT(n.stencilBack,e.stencilBack)){var c=e.stencilBack;o=c.passOp,a=c.failOp,s=c.depthFailOp,u=c.compare;n.stencilBack.passOp===o&&n.stencilBack.failOp===a&&n.stencilBack.depthFailOp===s||(t.stencilOpSeparate(t.BACK,a,s,o),n.stencilBack.passOp=o,n.stencilBack.failOp=a,n.stencilBack.depthFailOp=s),n.stencilBack.compare!==u&&(this.setStencilReference(0),n.stencilBack.compare=u)}n.stencilFront.mask===e.stencilFront.mask&&n.stencilBack.mask===e.stencilBack.mask||(n.stencilFront.mask=e.stencilFront.mask,n.stencilBack.mask=e.stencilBack.mask,this.applyStencil()),n.cullMode!==e.cullMode&&(n.cullMode===MS.NONE?t.enable(t.CULL_FACE):e.cullMode===MS.NONE&&t.disable(t.CULL_FACE),e.cullMode===MS.BACK?t.cullFace(t.BACK):e.cullMode===MS.FRONT?t.cullFace(t.FRONT):e.cullMode===MS.FRONT_AND_BACK&&t.cullFace(t.FRONT_AND_BACK),n.cullMode=e.cullMode),n.frontFace!==e.frontFace&&(t.frontFace(e.frontFace),n.frontFace=e.frontFace),n.polygonOffset!==e.polygonOffset&&(e.polygonOffset?(t.polygonOffset(1,1),t.enable(t.POLYGON_OFFSET_FILL)):t.disable(t.POLYGON_OFFSET_FILL),n.polygonOffset=e.polygonOffset)},e.prototype.validatePipelineFormats=function(e){for(var t=0;t<this.currentColorAttachments.length;t++)this.currentColorAttachments[t];this.currentDepthStencilAttachment&&oT(this.currentDepthStencilAttachment.format===e.depthStencilAttachmentFormat),-1!==this.currentSampleCount&&oT(this.currentSampleCount===e.sampleCount)},e.prototype.setPipeline=function(e){var t=this;if(this.renderBundle)this.renderBundle.push((function(){return t.setPipeline(e)}));else{this.currentPipeline=e,this.validatePipelineFormats(this.currentPipeline),this.setMegaState(this.currentPipeline.megaState);var n=this.currentPipeline.program;if(this.useProgram(n),n.compileState===wR.NeedsBind){var r=this.gl,i=n.gl_program,o=n.descriptor,a=TR(o.vertex.glsl,HR);if(pR(r))for(var s=0;s<a.length;s++){var u=bS(a[s],2)[1],c=r.getUniformBlockIndex(i,u);-1!==c&&4294967295!==c&&r.uniformBlockBinding(i,c,s)}var l=TR(o.fragment.glsl,/^uniform .*sampler\S+ (\w+);\s* \/\/ BINDING=(\d+)$/gm);for(s=0;s<l.length;s++){var f=bS(l[s],3),h=f[1],d=f[2],p=r.getUniformLocation(i,h);r.uniform1i(p,parseInt(d))}n.compileState=wR.ReadyToUse}}},e.prototype.setVertexInput=function(e,t,n){var r,i,o,a=this;if(this.renderBundle)this.renderBundle.push((function(){return a.setVertexInput(e,t,n)}));else if(null!==e){oT(this.currentPipeline.inputLayout===e);var s=e;this.bindVAO(s.vao);for(var u=this.gl,c=0;c<s.vertexBufferDescriptors.length;c++){var l=s.vertexBufferDescriptors[c],f=l.arrayStride,h=l.attributes;try{for(var d=(r=void 0,ES(h)),p=d.next();!p.done;p=d.next()){var v=p.value,m=v.shaderLocation,g=v.offset,_=pR(u)?m:null===(o=s.program.attributes[m])||void 0===o?void 0:o.location;if(!lS(_)){var y=t[c];if(null===y)continue;var E=v.vertexFormat;u.bindBuffer(u.ARRAY_BUFFER,bR(y.buffer));var b=(y.offset||0)+g;u.vertexAttribPointer(_,E.size,E.type,E.normalized,f,b)}}}catch(x){r={error:x}}finally{try{p&&!p.done&&(i=d.return)&&i.call(d)}finally{if(r)throw r.error}}}if(oT(null!==n==(null!==s.indexBufferFormat)),null!==n){var A=n.buffer;oT(A.usage===PS.INDEX),u.bindBuffer(u.ELEMENT_ARRAY_BUFFER,bR(A)),this.currentIndexBufferByteOffset=n.offset||0}else this.currentIndexBufferByteOffset=null}else oT(null===this.currentPipeline.inputLayout),oT(null===n),this.bindVAO(null),this.currentIndexBufferByteOffset=0},e.prototype.setStencilReference=function(e){this.currentStencilRef!==e&&(this.currentStencilRef=e,this.applyStencil())},e.prototype.draw=function(e,t,n,r){var i,o=this;if(this.renderBundle)this.renderBundle.push((function(){return o.draw(e,t,n,r)}));else{var a=this.gl,s=this.currentPipeline;if(t){var u=[s.drawMode,n||0,e,t];pR(a)?a.drawArraysInstanced.apply(a,AS([],bS(u),!1)):(i=this.ANGLE_instanced_arrays).drawArraysInstancedANGLE.apply(i,AS([],bS(u),!1))}else a.drawArrays(s.drawMode,n,e);this.debugGroupStatisticsDrawCall(),this.debugGroupStatisticsTriangles(e/3*Math.max(t,1))}},e.prototype.drawIndexed=function(e,t,n,r,i){var o,a=this;if(this.renderBundle)this.renderBundle.push((function(){return a.drawIndexed(e,t,n,r,i)}));else{var s=this.gl,u=this.currentPipeline,c=aT(u.inputLayout),l=aT(this.currentIndexBufferByteOffset)+n*c.indexBufferCompByteSize;if(t){var f=[u.drawMode,e,c.indexBufferType,l,t];pR(s)?s.drawElementsInstanced.apply(s,AS([],bS(f),!1)):(o=this.ANGLE_instanced_arrays).drawElementsInstancedANGLE.apply(o,AS([],bS(f),!1))}else s.drawElements(u.drawMode,e,c.indexBufferType,l);this.debugGroupStatisticsDrawCall(),this.debugGroupStatisticsTriangles(e/3*Math.max(t,1))}},e.prototype.drawIndirect=function(e,t){},e.prototype.drawIndexedIndirect=function(e,t){},e.prototype.beginOcclusionQuery=function(e){var t=this.gl;if(pR(t)){var n=this.currentRenderPassDescriptor.occlusionQueryPool;t.beginQuery(n.gl_query_type,n.gl_query[e])}},e.prototype.endOcclusionQuery=function(){var e=this.gl;if(pR(e)){var t=this.currentRenderPassDescriptor.occlusionQueryPool;e.endQuery(t.gl_query_type)}},e.prototype.pipelineQueryReady=function(e){var t=e;return this.queryProgramReady(t.program)},e.prototype.pipelineForceReady=function(e){},e.prototype.endPass=function(){for(var e=this.gl,t=pR(e),n=!1,r=0;r<this.currentColorAttachments.length;r++){var i=this.currentColorAttachments[r];if(null!==i){var o=this.currentColorResolveTos[r],a=!1;null!==o&&(oT(i.width===o.width&&i.height===o.height),this.setScissorRectEnabled(!1),t&&e.bindFramebuffer(e.READ_FRAMEBUFFER,this.resolveColorReadFramebuffer),this.resolveColorAttachmentsChanged&&t&&this.bindFramebufferAttachment(e.READ_FRAMEBUFFER,e.COLOR_ATTACHMENT0,i,this.currentColorAttachmentLevels[r]),a=!0,o===this.scTexture?e.bindFramebuffer(t?SS.DRAW_FRAMEBUFFER:SS.FRAMEBUFFER,this.scPlatformFramebuffer):(e.bindFramebuffer(t?SS.DRAW_FRAMEBUFFER:SS.FRAMEBUFFER,this.resolveColorDrawFramebuffer),this.resolveColorAttachmentsChanged&&e.framebufferTexture2D(t?SS.DRAW_FRAMEBUFFER:SS.FRAMEBUFFER,e.COLOR_ATTACHMENT0,e.TEXTURE_2D,o.gl_texture,this.currentColorResolveToLevels[r])),t?(e.blitFramebuffer(0,0,i.width,i.height,0,0,o.width,o.height,e.COLOR_BUFFER_BIT,e.LINEAR),e.bindFramebuffer(e.DRAW_FRAMEBUFFER,null)):this.submitBlitRenderPass(i,o),n=!0),this.currentRenderPassDescriptor.colorStore[r]||a||(e.bindFramebuffer(t?SS.READ_FRAMEBUFFER:SS.FRAMEBUFFER,this.resolveColorReadFramebuffer),this.resolveColorAttachmentsChanged&&this.bindFramebufferAttachment(t?SS.READ_FRAMEBUFFER:SS.FRAMEBUFFER,e.COLOR_ATTACHMENT0,i,this.currentColorAttachmentLevels[r])),e.bindFramebuffer(t?SS.READ_FRAMEBUFFER:SS.FRAMEBUFFER,null)}}this.resolveColorAttachmentsChanged=!1;var s=this.currentDepthStencilAttachment;if(s){var u=this.currentDepthStencilResolveTo;a=!1;u&&(oT(s.width===u.width&&s.height===u.height),this.setScissorRectEnabled(!1),e.bindFramebuffer(t?SS.READ_FRAMEBUFFER:SS.FRAMEBUFFER,this.resolveDepthStencilReadFramebuffer),e.bindFramebuffer(t?SS.DRAW_FRAMEBUFFER:SS.FRAMEBUFFER,this.resolveDepthStencilDrawFramebuffer),this.resolveDepthStencilAttachmentsChanged&&(this.bindFramebufferDepthStencilAttachment(t?SS.READ_FRAMEBUFFER:SS.FRAMEBUFFER,s),this.bindFramebufferDepthStencilAttachment(t?SS.DRAW_FRAMEBUFFER:SS.FRAMEBUFFER,u)),a=!0,t&&e.blitFramebuffer(0,0,s.width,s.height,0,0,u.width,u.height,e.DEPTH_BUFFER_BIT,e.NEAREST),e.bindFramebuffer(t?SS.DRAW_FRAMEBUFFER:SS.FRAMEBUFFER,null),n=!0),this.currentRenderPassDescriptor.depthStencilStore||(a||(e.bindFramebuffer(t?SS.READ_FRAMEBUFFER:SS.FRAMEBUFFER,this.resolveDepthStencilReadFramebuffer),this.resolveDepthStencilAttachmentsChanged&&this.bindFramebufferDepthStencilAttachment(t?SS.READ_FRAMEBUFFER:SS.FRAMEBUFFER,s),a=!0),t&&e.invalidateFramebuffer(e.READ_FRAMEBUFFER,[e.DEPTH_STENCIL_ATTACHMENT])),a&&e.bindFramebuffer(t?SS.READ_FRAMEBUFFER:SS.FRAMEBUFFER,null),this.resolveDepthStencilAttachmentsChanged=!1}n||e.bindFramebuffer(t?SS.DRAW_FRAMEBUFFER:SS.FRAMEBUFFER,null)},e.prototype.setScissorRectEnabled=function(e){if(this.currentScissorEnabled!==e){var t=this.gl;e?t.enable(t.SCISSOR_TEST):t.disable(t.SCISSOR_TEST),this.currentScissorEnabled=e}},e.prototype.applyStencil=function(){lS(this.currentStencilRef)||(this.gl.stencilFuncSeparate(SS.FRONT,this.currentMegaState.stencilFront.compare,this.currentStencilRef,this.currentMegaState.stencilFront.mask||255),this.gl.stencilFuncSeparate(SS.BACK,this.currentMegaState.stencilBack.compare,this.currentStencilRef,this.currentMegaState.stencilBack.mask||255))},e.prototype.getFallbackTexture=function(e){var t=e.gl_target,n=e.formatKind;if(t===SS.TEXTURE_2D)return n===VS.Depth?this.fallbackTexture2DDepth:this.fallbackTexture2D;if(t===SS.TEXTURE_2D_ARRAY)return this.fallbackTexture2DArray;if(t===SS.TEXTURE_3D)return this.fallbackTexture3D;if(t===SS.TEXTURE_CUBE_MAP)return this.fallbackTextureCube;throw new Error("whoops")},e.prototype.submitBlitRenderPass=function(e,t){this.blitRenderPipeline||(this.blitProgram=this.createProgram({vertex:{glsl:"layout(location = 0) in vec2 a_Position;\nout vec2 v_TexCoord;\nvoid main() {\n  v_TexCoord = 0.5 * (a_Position + 1.0);\n  gl_Position = vec4(a_Position, 0., 1.);\n\n  #ifdef VIEWPORT_ORIGIN_TL\n    v_TexCoord.y = 1.0 - v_TexCoord.y;\n  #endif\n}"},fragment:{glsl:"uniform sampler2D u_Texture;\nin vec2 v_TexCoord;\nout vec4 outputColor;\nvoid main() {\n  outputColor = texture(SAMPLER_2D(u_Texture), v_TexCoord);\n}"}}),this.blitVertexBuffer=this.createBuffer({usage:PS.VERTEX|PS.COPY_DST,viewOrSize:new Float32Array([-4,-4,4,-4,0,4])}),this.blitInputLayout=this.createInputLayout({vertexBufferDescriptors:[{arrayStride:8,stepMode:FS.VERTEX,attributes:[{format:KS.F32_RG,offset:0,shaderLocation:0}]}],indexBufferFormat:null,program:this.blitProgram}),this.blitRenderPipeline=this.createRenderPipeline({topology:IS.TRIANGLES,sampleCount:1,program:this.blitProgram,colorAttachmentFormats:[KS.U8_RGBA_RT],depthStencilAttachmentFormat:null,inputLayout:this.blitInputLayout,megaStateDescriptor:ET(AT)}),this.blitBindings=this.createBindings({samplerBindings:[{sampler:null,texture:e.texture}],uniformBufferBindings:[]}),this.blitProgram.setUniformsLegacy({u_Texture:e}));var n=this.currentRenderPassDescriptor;this.currentRenderPassDescriptor=null,this.inBlitRenderPass=!0;var r=this.createRenderPass({colorAttachment:[e],colorResolveTo:[t],colorClearColor:[hT]}),i=this.getCanvas(),o=i.width,a=i.height;r.setPipeline(this.blitRenderPipeline),r.setBindings(this.blitBindings),r.setVertexInput(this.blitInputLayout,[{buffer:this.blitVertexBuffer}],null),r.setViewport(0,0,o,a),this.gl.disable(this.gl.BLEND),r.draw(3,0),this.gl.enable(this.gl.BLEND),this.currentRenderPassDescriptor=n,this.inBlitRenderPass=!1},e}(),WR=function(){function e(e){this.pluginOptions=e}return e.prototype.createSwapChain=function(e){return _S(this,void 0,void 0,(function(){var t,n,r,i,o,a,s,u,c,l,f,h,d;return yS(this,(function(p){return t=this.pluginOptions,n=t.targets,r=t.xrCompatible,i=t.antialias,o=void 0!==i&&i,a=t.preserveDrawingBuffer,s=void 0!==a&&a,u=t.premultipliedAlpha,c=void 0===u||u,l=t.shaderDebug,f=t.trackResources,h={antialias:o,preserveDrawingBuffer:s,stencil:!0,premultipliedAlpha:c,xrCompatible:r},this.handleContextEvents(e),n.includes("webgl2")&&(d=e.getContext("webgl2",h)||e.getContext("experimental-webgl2",h)),!d&&n.includes("webgl1")&&(d=e.getContext("webgl",h)||e.getContext("experimental-webgl",h)),[2,new XR(d,{shaderDebug:l,trackResources:f})]}))}))},e.prototype.handleContextEvents=function(e){var t=this.pluginOptions,n=t.onContextLost,r=t.onContextRestored,i=t.onContextCreationError;i&&e.addEventListener("webglcontextcreationerror",i,!1),n&&e.addEventListener("webglcontextlost",n,!1),r&&e.addEventListener("webglcontextrestored",r,!1)},e}(),YR="undefined"!=typeof TextDecoder?new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0}):{decode:function(){throw Error("TextDecoder not available")}};"undefined"!=typeof TextDecoder&&YR.decode();var ZR=null;function qR(){return null!==ZR&&0!==ZR.byteLength||(ZR=new Uint8Array(IR.memory.buffer)),ZR}function KR(e,t){return e>>>=0,YR.decode(qR().subarray(e,e+t))}var QR=new Array(128).fill(void 0);QR.push(void 0,null,!0,!1);var $R=QR.length;function JR(e){return QR[e]}function eC(e){var t=JR(e);return function(e){e<132||(QR[e]=$R,$R=e)}(e),t}var tC=0,nC="undefined"!=typeof TextEncoder?new TextEncoder("utf-8"):{encode:function(){throw Error("TextEncoder not available")}},rC="function"==typeof nC.encodeInto?function(e,t){return nC.encodeInto(e,t)}:function(e,t){var n=nC.encode(e);return t.set(n),{read:e.length,written:n.length}};function iC(e,t,n){if(void 0===n){var r=nC.encode(e),i=t(r.length,1)>>>0;return qR().subarray(i,i+r.length).set(r),tC=r.length,i}for(var o=e.length,a=t(o,1)>>>0,s=qR(),u=0;u<o;u++){var c=e.charCodeAt(u);if(c>127)break;s[a+u]=c}if(u!==o){0!==u&&(e=e.slice(u)),a=n(a,o,o=u+3*e.length,1)>>>0;var l=qR().subarray(a+u,a+o);u+=rC(e,l).written}return tC=u,a}var oC=null;function aC(){return null!==oC&&0!==oC.byteLength||(oC=new Int32Array(IR.memory.buffer)),oC}function sC(e,t,n){var r,i;try{var o=IR.__wbindgen_add_to_stack_pointer(-16),a=iC(e,IR.__wbindgen_malloc,IR.__wbindgen_realloc),s=tC,u=iC(t,IR.__wbindgen_malloc,IR.__wbindgen_realloc),c=tC;IR.glsl_compile(o,a,s,u,c,n);var l=aC()[o/4+0],f=aC()[o/4+1];return r=l,i=f,KR(l,f)}finally{IR.__wbindgen_add_to_stack_pointer(16),IR.__wbindgen_free(r,i,1)}}var uC,cC,lC=function(){function e(){f(this,e);var t=IR.wgslcomposer_new();return e.__wrap(t)}return c(e,[{key:"__destroy_into_raw",value:function(){var e=this.__wbg_ptr;return this.__wbg_ptr=0,e}},{key:"free",value:function(){var e=this.__destroy_into_raw();IR.__wbg_wgslcomposer_free(e)}},{key:"load_composable",value:function(e){var t=iC(e,IR.__wbindgen_malloc,IR.__wbindgen_realloc),n=tC;IR.wgslcomposer_load_composable(this.__wbg_ptr,t,n)}},{key:"wgsl_compile",value:function(e){var t,n;try{var r=IR.__wbindgen_add_to_stack_pointer(-16),i=iC(e,IR.__wbindgen_malloc,IR.__wbindgen_realloc),o=tC;IR.wgslcomposer_wgsl_compile(r,this.__wbg_ptr,i,o);var a=aC()[r/4+0],s=aC()[r/4+1];return t=a,n=s,KR(a,s)}finally{IR.__wbindgen_add_to_stack_pointer(16),IR.__wbindgen_free(t,n,1)}}}],[{key:"__wrap",value:function(t){t>>>=0;var n=Object.create(e.prototype);return n.__wbg_ptr=t,n}}])}();function fC(e,t){return hC.apply(this,arguments)}function hC(){return hC=t(i().mark((function e(t,n){var r,o;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!("function"==typeof Response&&t instanceof Response)){e.next=23;break}if("function"!=typeof WebAssembly.instantiateStreaming){e.next=15;break}return e.prev=2,e.next=5,WebAssembly.instantiateStreaming(t,n);case 5:case 20:return e.abrupt("return",e.sent);case 8:if(e.prev=8,e.t0=e.catch(2),"application/wasm"==t.headers.get("Content-Type")){e.next=14;break}console.warn("`WebAssembly.instantiateStreaming` failed because your server does not serve wasm with `application/wasm` MIME type. Falling back to `WebAssembly.instantiate` which is slower. Original error:\n",e.t0),e.next=15;break;case 14:throw e.t0;case 15:return e.next=17,t.arrayBuffer();case 17:return r=e.sent,e.next=20,WebAssembly.instantiate(r,n);case 23:return e.next=25,WebAssembly.instantiate(t,n);case 25:if(!((o=e.sent)instanceof WebAssembly.Instance)){e.next=30;break}return e.abrupt("return",{instance:o,module:t});case 30:return e.abrupt("return",o);case 31:case"end":return e.stop()}}),e,null,[[2,8]])}))),hC.apply(this,arguments)}function dC(){var e={wbg:{}};return e.wbg.__wbindgen_string_new=function(e,t){return function(e){$R===QR.length&&QR.push(QR.length+1);var t=$R;return $R=QR[t],QR[t]=e,t}(KR(e,t))},e.wbg.__wbindgen_object_drop_ref=function(e){eC(e)},e.wbg.__wbg_log_1d3ae0273d8f4f8a=function(e){console.log(JR(e))},e.wbg.__wbg_log_576ca876af0d4a77=function(e,t){console.log(JR(e),JR(t))},e.wbg.__wbindgen_throw=function(e,t){throw new Error(KR(e,t))},e}function pC(e,t){return IR=e.exports,vC.__wbindgen_wasm_module=t,oC=null,ZR=null,IR}function vC(e){return mC.apply(this,arguments)}function mC(){return mC=t(i().mark((function e(t){var n,r,o,a;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(void 0===IR){e.next=2;break}return e.abrupt("return",IR);case 2:return n=dC(),("string"==typeof t||"function"==typeof Request&&t instanceof Request||"function"==typeof URL&&t instanceof URL)&&(t=fetch(t)),e.t0=fC,e.next=7,t;case 7:return e.t1=e.sent,e.t2=n,e.next=11,(0,e.t0)(e.t1,e.t2);case 11:return r=e.sent,o=r.instance,a=r.module,e.abrupt("return",pC(o,a));case 15:case"end":return e.stop()}}),e)}))),mC.apply(this,arguments)}function gC(e){if(e===KS.U8_R_NORM)return"r8unorm";if(e===KS.S8_R_NORM)return"r8snorm";if(e===KS.U8_RG_NORM)return"rg8unorm";if(e===KS.S8_RG_NORM)return"rg8snorm";if(e===KS.U32_R)return"r32uint";if(e===KS.S32_R)return"r32sint";if(e===KS.F32_R)return"r32float";if(e===KS.U16_RG)return"rg16uint";if(e===KS.S16_RG)return"rg16sint";if(e===KS.F16_RG)return"rg16float";if(e===KS.U8_RGBA_RT)return"bgra8unorm";if(e===KS.U8_RGBA_RT_SRGB)return"bgra8unorm-srgb";if(e===KS.U8_RGBA_NORM)return"rgba8unorm";if(e===KS.U8_RGBA_SRGB)return"rgba8unorm-srgb";if(e===KS.S8_RGBA_NORM)return"rgba8snorm";if(e===KS.U32_RG)return"rg32uint";if(e===KS.S32_RG)return"rg32sint";if(e===KS.F32_RG)return"rg32float";if(e===KS.U16_RGBA)return"rgba16uint";if(e===KS.S16_RGBA)return"rgba16sint";if(e===KS.F16_RGBA)return"rgba16float";if(e===KS.F32_RGBA)return"rgba32float";if(e===KS.U32_RGBA)return"rgba32uint";if(e===KS.S32_RGBA)return"rgba32sint";if(e===KS.D24)return"depth24plus";if(e===KS.D24_S8)return"depth24plus-stencil8";if(e===KS.D32F)return"depth32float";if(e===KS.D32F_S8)return"depth32float-stencil8";if(e===KS.BC1)return"bc1-rgba-unorm";if(e===KS.BC1_SRGB)return"bc1-rgba-unorm-srgb";if(e===KS.BC2)return"bc2-rgba-unorm";if(e===KS.BC2_SRGB)return"bc2-rgba-unorm-srgb";if(e===KS.BC3)return"bc3-rgba-unorm";if(e===KS.BC3_SRGB)return"bc3-rgba-unorm-srgb";if(e===KS.BC4_SNORM)return"bc4-r-snorm";if(e===KS.BC4_UNORM)return"bc4-r-unorm";if(e===KS.BC5_SNORM)return"bc5-rg-snorm";if(e===KS.BC5_UNORM)return"bc5-rg-unorm";throw"whoops"}function _C(e){if(e===US.TEXTURE_2D)return"2d";if(e===US.TEXTURE_CUBE_MAP)return"cube";if(e===US.TEXTURE_2D_ARRAY)return"2d-array";if(e===US.TEXTURE_3D)return"3d";throw new Error("whoops")}function yC(e){if(e===OS.CLAMP_TO_EDGE)return"clamp-to-edge";if(e===OS.REPEAT)return"repeat";if(e===OS.MIRRORED_REPEAT)return"mirror-repeat";throw new Error("whoops")}function EC(e){if(e===kS.BILINEAR)return"linear";if(e===kS.POINT)return"nearest";throw new Error("whoops")}function bC(e){if(e===NS.LINEAR)return"linear";if(e===NS.NEAREST)return"nearest";if(e===NS.NO_MIP)return"nearest";throw new Error("whoops")}function AC(e){return e.gpuBuffer}function xC(e){if(e===WS.OcclusionConservative)return"occlusion";throw new Error("whoops")}function SC(e){switch(e){case IS.TRIANGLES:return"triangle-list";case IS.POINTS:return"point-list";case IS.TRIANGLE_STRIP:return"triangle-strip";case IS.LINES:return"line-list";case IS.LINE_STRIP:return"line-strip";default:throw new Error("Unknown primitive topology mode")}}function TC(e){if(e===MS.NONE)return"none";if(e===MS.FRONT)return"front";if(e===MS.BACK)return"back";throw new Error("whoops")}function RC(e){if(e===CS.CCW)return"ccw";if(e===CS.CW)return"cw";throw new Error("whoops")}function CC(e){if(e===wS.ZERO)return"zero";if(e===wS.ONE)return"one";if(e===wS.SRC)return"src";if(e===wS.ONE_MINUS_SRC)return"one-minus-src";if(e===wS.DST)return"dst";if(e===wS.ONE_MINUS_DST)return"one-minus-dst";if(e===wS.SRC_ALPHA)return"src-alpha";if(e===wS.ONE_MINUS_SRC_ALPHA)return"one-minus-src-alpha";if(e===wS.DST_ALPHA)return"dst-alpha";if(e===wS.ONE_MINUS_DST_ALPHA)return"one-minus-dst-alpha";if(e===wS.CONST)return"constant";if(e===wS.ONE_MINUS_CONSTANT)return"one-minus-constant";if(e===wS.SRC_ALPHA_SATURATE)return"src-alpha-saturated";throw new Error("whoops")}function MC(e){if(e===LS.ADD)return"add";if(e===LS.SUBSTRACT)return"subtract";if(e===LS.REVERSE_SUBSTRACT)return"reverse-subtract";if(e===LS.MIN)return"min";if(e===LS.MAX)return"max";throw new Error("whoops")}function wC(e){return{operation:MC(e.blendMode),srcFactor:CC(e.blendSrcFactor),dstFactor:CC(e.blendDstFactor)}}function LC(e){return e.blendMode===LS.ADD&&e.blendSrcFactor===wS.ONE&&e.blendDstFactor===wS.ZERO}function OC(e){return LC(e.rgbBlendState)&&LC(e.alphaBlendState)?void 0:{color:wC(e.rgbBlendState),alpha:wC(e.alphaBlendState)}}function kC(e,t){return t.attachmentsState.map((function(t,n){return function(e,t){return{format:gC(t),blend:OC(e),writeMask:e.channelWriteMask}}(t,e[n])}))}function NC(e){if(e===RS.NEVER)return"never";if(e===RS.LESS)return"less";if(e===RS.EQUAL)return"equal";if(e===RS.LEQUAL)return"less-equal";if(e===RS.GREATER)return"greater";if(e===RS.NOTEQUAL)return"not-equal";if(e===RS.GEQUAL)return"greater-equal";if(e===RS.ALWAYS)return"always";throw new Error("whoops")}function IC(e){if(e===jS.KEEP)return"keep";if(e===jS.REPLACE)return"replace";if(e===jS.ZERO)return"zero";if(e===jS.DECREMENT_CLAMP)return"decrement-clamp";if(e===jS.DECREMENT_WRAP)return"decrement-wrap";if(e===jS.INCREMENT_CLAMP)return"increment-clamp";if(e===jS.INCREMENT_WRAP)return"increment-wrap";if(e===jS.INVERT)return"invert";throw new Error("whoops")}function PC(e){if(e===FS.VERTEX)return"vertex";if(e===FS.INSTANCE)return"instance";throw new Error("whoops")}function DC(e){if(e===KS.U8_R)return"uint8x2";if(e===KS.U8_RG)return"uint8x2";if(e===KS.U8_RGB)return"uint8x4";if(e===KS.U8_RGBA)return"uint8x4";if(e===KS.U8_RG_NORM)return"unorm8x2";if(e===KS.U8_RGBA_NORM)return"unorm8x4";if(e===KS.S8_RGB_NORM)return"snorm8x4";if(e===KS.S8_RGBA_NORM)return"snorm8x4";if(e===KS.U16_RG_NORM)return"unorm16x2";if(e===KS.U16_RGBA_NORM)return"unorm16x4";if(e===KS.S16_RG_NORM)return"snorm16x2";if(e===KS.S16_RGBA_NORM)return"snorm16x4";if(e===KS.S16_RG)return"uint16x2";if(e===KS.F16_RG)return"float16x2";if(e===KS.F16_RGBA)return"float16x4";if(e===KS.F32_R)return"float32";if(e===KS.F32_RG)return"float32x2";if(e===KS.F32_RGB)return"float32x3";if(e===KS.F32_RGBA)return"float32x4";throw"whoops"}function FC(e,t,n,r){switch(void 0===n&&(n=!1),e){case KS.S8_R:case KS.S8_R_NORM:case KS.S8_RG_NORM:case KS.S8_RGB_NORM:case KS.S8_RGBA_NORM:var i=(ArrayBuffer,new Int8Array(t));return r&&i.set(new Int8Array(r)),i;case KS.U8_R:case KS.U8_R_NORM:case KS.U8_RG:case KS.U8_RG_NORM:case KS.U8_RGB:case KS.U8_RGB_NORM:case KS.U8_RGB_SRGB:case KS.U8_RGBA:case KS.U8_RGBA_NORM:case KS.U8_RGBA_SRGB:var o=(ArrayBuffer,new Uint8Array(t));return r&&o.set(new Uint8Array(r)),o;case KS.S16_R:case KS.S16_RG:case KS.S16_RG_NORM:case KS.S16_RGB_NORM:case KS.S16_RGBA:case KS.S16_RGBA_NORM:var a=t instanceof ArrayBuffer?new Int16Array(t):new Int16Array(n?t/2:t);return r&&a.set(new Int16Array(r)),a;case KS.U16_R:case KS.U16_RGB:case KS.U16_RGBA_5551:case KS.U16_RGBA_NORM:case KS.U16_RG_NORM:case KS.U16_R_NORM:var s=t instanceof ArrayBuffer?new Uint16Array(t):new Uint16Array(n?t/2:t);return r&&s.set(new Uint16Array(r)),s;case KS.S32_R:var u=t instanceof ArrayBuffer?new Int32Array(t):new Int32Array(n?t/4:t);return r&&u.set(new Int32Array(r)),u;case KS.U32_R:case KS.U32_RG:var c=t instanceof ArrayBuffer?new Uint32Array(t):new Uint32Array(n?t/4:t);return r&&c.set(new Uint32Array(r)),c;case KS.F32_R:case KS.F32_RG:case KS.F32_RGB:case KS.F32_RGBA:var l=t instanceof ArrayBuffer?new Float32Array(t):new Float32Array(n?t/4:t);return r&&l.set(new Float32Array(r)),l}var f=(ArrayBuffer,new Uint8Array(t));return r&&f.set(new Uint8Array(r)),f}function BC(e){switch(e){case"r8unorm":case"r8snorm":case"r8uint":case"r8sint":return{width:1,height:1,length:1};case"r16uint":case"r16sint":case"r16float":case"rg8unorm":case"rg8snorm":case"rg8uint":case"rg8sint":case"depth16unorm":return{width:1,height:1,length:2};case"r32uint":case"r32sint":case"r32float":case"rg16uint":case"rg16sint":case"rg16float":case"rgba8unorm":case"rgba8unorm-srgb":case"rgba8snorm":case"rgba8uint":case"rgba8sint":case"bgra8unorm":case"bgra8unorm-srgb":case"rgb9e5ufloat":case"rgb10a2unorm":case"rg11b10ufloat":case"depth32float":default:return{width:1,height:1,length:4};case"rg32uint":case"rg32sint":case"rg32float":case"rgba16uint":case"rgba16sint":case"rgba16float":return{width:1,height:1,length:8};case"rgba32uint":case"rgba32sint":case"rgba32float":return{width:1,height:1,length:16};case"stencil8":throw new Error("No fixed size for Stencil8 format!");case"depth24plus":throw new Error("No fixed size for Depth24Plus format!");case"depth24plus-stencil8":throw new Error("No fixed size for Depth24PlusStencil8 format!");case"depth32float-stencil8":return{width:1,height:1,length:5};case"bc7-rgba-unorm":case"bc7-rgba-unorm-srgb":case"bc6h-rgb-ufloat":case"bc6h-rgb-float":case"bc2-rgba-unorm":case"bc2-rgba-unorm-srgb":case"bc3-rgba-unorm":case"bc3-rgba-unorm-srgb":case"bc5-rg-unorm":case"bc5-rg-snorm":return{width:4,height:4,length:16};case"bc4-r-unorm":case"bc4-r-snorm":case"bc1-rgba-unorm":case"bc1-rgba-unorm-srgb":return{width:4,height:4,length:8}}}!function(e){e[e.COPY_SRC=1]="COPY_SRC",e[e.COPY_DST=2]="COPY_DST",e[e.TEXTURE_BINDING=4]="TEXTURE_BINDING",e[e.STORAGE_BINDING=8]="STORAGE_BINDING",e[e.STORAGE=8]="STORAGE",e[e.RENDER_ATTACHMENT=16]="RENDER_ATTACHMENT"}(uC||(uC={})),function(e){e[e.READ=1]="READ",e[e.WRITE=2]="WRITE"}(cC||(cC={}));var UC=function(e){function t(t){var n=t.id,r=t.device,i=e.call(this)||this;return i.id=n,i.device=r,i}return mS(t,e),t.prototype.destroy=function(){},t}(QS),GC=function(e){function t(t){var n,r,i=t.id,o=t.device,a=t.descriptor,s=e.call(this,{id:i,device:o})||this;s.type=TS.Bindings;var u=a.pipeline;oT(!!u);var c=a.uniformBufferBindings,l=a.storageBufferBindings,f=a.samplerBindings,h=a.storageTextureBindings;s.numUniformBuffers=(null==c?void 0:c.length)||0;var d=[[],[],[],[]],p=0;if(c&&c.length)for(var v=0;v<c.length;v++){var m=a.uniformBufferBindings[v],g=m.binding,_=m.size,y=m.offset,E={buffer:AC(m.buffer),offset:null!=y?y:0,size:_};d[0].push({binding:null!=g?g:p++,resource:E})}if(f&&f.length){p=0;for(v=0;v<f.length;v++){var b=gS(gS({},f[v]),ST),A=null!==(g=a.samplerBindings[v]).texture?g.texture:s.device.getFallbackTexture(b);b.dimension=A.dimension,b.formatKind=iT(A.format);var x=A.gpuTextureView;if(d[1].push({binding:null!==(n=g.textureBinding)&&void 0!==n?n:p++,resource:x}),-1!==g.samplerBinding){var S=null!==g.sampler?g.sampler:s.device.getFallbackSampler(b),T=S.gpuSampler;d[1].push({binding:null!==(r=g.samplerBinding)&&void 0!==r?r:p++,resource:T})}}}if(l&&l.length){p=0;for(v=0;v<l.length;v++){var R=a.storageBufferBindings[v];g=R.binding,_=R.size,y=R.offset,E={buffer:AC(R.buffer),offset:null!=y?y:0,size:_};d[2].push({binding:null!=g?g:p++,resource:E})}}if(h&&h.length){p=0;for(v=0;v<h.length;v++){var C=a.storageTextureBindings[v];g=C.binding,x=(A=C.texture).gpuTextureView;d[3].push({binding:null!=g?g:p++,resource:x})}}var M=d.findLastIndex((function(e){return!!e.length}));return s.gpuBindGroup=d.map((function(e,t){return t<=M&&s.device.device.createBindGroup({layout:u.getBindGroupLayout(t),entries:e})})),s}return mS(t,e),t}(UC),zC=function(e){function t(t){var n=t.id,r=t.device,i=t.descriptor,o=e.call(this,{id:n,device:r})||this;o.type=TS.Buffer;var a=i.usage,s=i.viewOrSize,u=!!(a&PS.MAP_READ);o.usage=function(e){var t=0;return e&PS.INDEX&&(t|=GPUBufferUsage.INDEX),e&PS.VERTEX&&(t|=GPUBufferUsage.VERTEX),e&PS.UNIFORM&&(t|=GPUBufferUsage.UNIFORM),e&PS.STORAGE&&(t|=GPUBufferUsage.STORAGE),e&PS.COPY_SRC&&(t|=GPUBufferUsage.COPY_SRC),e&PS.INDIRECT&&(t|=GPUBufferUsage.INDIRECT),t|GPUBufferUsage.COPY_DST}(a),u&&(o.usage=PS.MAP_READ|PS.COPY_DST);var c=!pS(s);(o.view=pS(s)?null:s,o.size=pS(s)?vT(s,4):vT(s.byteLength,4),pS(s))?o.gpuBuffer=o.device.device.createBuffer({usage:o.usage,size:o.size,mappedAtCreation:!!u&&c}):(o.gpuBuffer=o.device.device.createBuffer({usage:o.usage,size:o.size,mappedAtCreation:!0}),new(s&&s.constructor||Float32Array)(o.gpuBuffer.getMappedRange()).set(s),o.gpuBuffer.unmap());return o}return mS(t,e),t.prototype.setSubData=function(e,t,n,r){void 0===n&&(n=0),void 0===r&&(r=0);var i=this.gpuBuffer;r=r||t.byteLength,r=Math.min(r,this.size-e);var o=t.byteOffset+n,a=o+r,s=r+3&-4;if(s!==r){var u=new Uint8Array(t.buffer.slice(o,a));(t=new Uint8Array(s)).set(u),n=0,o=0,a=s,r=s}for(var c=15728640,l=0;a-(o+l)>c;)this.device.device.queue.writeBuffer(i,e+l,t.buffer,o+l,c),l+=c;this.device.device.queue.writeBuffer(i,e+l,t.buffer,o+l,r-l)},t.prototype.destroy=function(){e.prototype.destroy.call(this),this.gpuBuffer.destroy()},t}(UC),jC=function(){function e(){this.gpuComputePassEncoder=null}return e.prototype.dispatchWorkgroups=function(e,t,n){this.gpuComputePassEncoder.dispatchWorkgroups(e,t,n)},e.prototype.dispatchWorkgroupsIndirect=function(e,t){this.gpuComputePassEncoder.dispatchWorkgroupsIndirect(e.gpuBuffer,t)},e.prototype.finish=function(){this.gpuComputePassEncoder.end(),this.gpuComputePassEncoder=null,this.frameCommandEncoder=null},e.prototype.beginComputePass=function(e){oT(null===this.gpuComputePassEncoder),this.frameCommandEncoder=e,this.gpuComputePassEncoder=this.frameCommandEncoder.beginComputePass(this.gpuComputePassDescriptor)},e.prototype.setPipeline=function(e){var t=aT(e.gpuComputePipeline);this.gpuComputePassEncoder.setPipeline(t)},e.prototype.setBindings=function(e){var t=this,n=e;n.gpuBindGroup.forEach((function(e,r){e&&t.gpuComputePassEncoder.setBindGroup(r,n.gpuBindGroup[r])}))},e.prototype.pushDebugGroup=function(e){this.gpuComputePassEncoder.pushDebugGroup(e)},e.prototype.popDebugGroup=function(){this.gpuComputePassEncoder.popDebugGroup()},e.prototype.insertDebugMarker=function(e){this.gpuComputePassEncoder.insertDebugMarker(e)},e}(),VC=function(e){function t(t){var n=t.id,r=t.device,i=t.descriptor,o=e.call(this,{id:n,device:r})||this;o.type=TS.ComputePipeline,o.gpuComputePipeline=null,o.descriptor=i;var a=i.program.computeStage;if(null===a)return o;var s={layout:"auto",compute:gS({},a)};return o.gpuComputePipeline=o.device.device.createComputePipeline(s),void 0!==o.name&&(o.gpuComputePipeline.label=o.name),o}return mS(t,e),t.prototype.getBindGroupLayout=function(e){return this.gpuComputePipeline.getBindGroupLayout(e)},t}(UC),HC=function(e){function t(t){var n,r,i,o,a=t.id,s=t.device,u=t.descriptor,c=e.call(this,{id:a,device:s})||this;c.type=TS.InputLayout;var l=[];try{for(var f=ES(u.vertexBufferDescriptors),h=f.next();!h.done;h=f.next()){var d=h.value,p=d.arrayStride,v=d.stepMode,m=d.attributes;l.push({arrayStride:p,stepMode:PC(v),attributes:[]});try{for(var g=(i=void 0,ES(m)),_=g.next();!_.done;_=g.next()){var y=_.value,E=y.shaderLocation,b=y.format,A=y.offset;l[l.length-1].attributes.push({shaderLocation:E,format:DC(b),offset:A})}}catch(x){i={error:x}}finally{try{_&&!_.done&&(o=g.return)&&o.call(g)}finally{if(i)throw i.error}}}}catch(S){n={error:S}}finally{try{h&&!h.done&&(r=f.return)&&r.call(f)}finally{if(n)throw n.error}}return c.indexFormat=function(e){if(null!==e){if(e===KS.U16_R)return"uint16";if(e===KS.U32_R)return"uint32";throw new Error("whoops")}}(u.indexBufferFormat),c.buffers=l,c}return mS(t,e),t}(UC),XC=function(e){function t(t){var n=t.id,r=t.device,i=t.descriptor,o=e.call(this,{id:n,device:r})||this;return o.type=TS.Program,o.vertexStage=null,o.fragmentStage=null,o.computeStage=null,o.descriptor=i,i.vertex&&(o.vertexStage=o.createShaderStage(i.vertex,"vertex")),i.fragment&&(o.fragmentStage=o.createShaderStage(i.fragment,"fragment")),i.compute&&(o.computeStage=o.createShaderStage(i.compute,"compute")),o}return mS(t,e),t.prototype.setUniformsLegacy=function(e){},t.prototype.createShaderStage=function(e,t){var n,r,i=e.glsl,o=e.wgsl,a=e.entryPoint,s=e.postprocess,u=o;if(!u)try{u=this.device.glsl_compile(i,t,!1)}catch(h){throw console.error(h,i),new Error("whoops")}var c=function(e){if(!u.includes(e))return"continue";u=(u=u.replace("var T_".concat(e,": texture_2d<f32>;"),"var T_".concat(e,": texture_depth_2d;"))).replace(new RegExp("textureSample\\(T_".concat(e,"(.*)\\);$"),"gm"),(function(t,n){return"vec4<f32>(textureSample(T_".concat(e).concat(n,"), 0.0, 0.0, 0.0);")}))};try{for(var l=ES(["u_TextureFramebufferDepth"]),f=l.next();!f.done;f=l.next()){c(f.value)}}catch(d){n={error:d}}finally{try{f&&!f.done&&(r=l.return)&&r.call(l)}finally{if(n)throw n.error}}return s&&(u=s(u)),{module:this.device.device.createShaderModule({code:u}),entryPoint:a||"main"}},t}(UC),WC=function(e){function t(t){var n=t.id,r=t.device,i=t.descriptor,o=e.call(this,{id:n,device:r})||this;o.type=TS.QueryPool;var a=i.elemCount,s=i.type;return o.querySet=o.device.device.createQuerySet({type:xC(s),count:a}),o.resolveBuffer=o.device.device.createBuffer({size:8*a,usage:GPUBufferUsage.QUERY_RESOLVE|GPUBufferUsage.COPY_SRC}),o.cpuBuffer=o.device.device.createBuffer({size:8*a,usage:GPUBufferUsage.COPY_DST|GPUBufferUsage.MAP_READ}),o.results=null,o}return mS(t,e),t.prototype.queryResultOcclusion=function(e){return null===this.results?null:this.results[e]!==BigInt(0)},t.prototype.destroy=function(){e.prototype.destroy.call(this),this.querySet.destroy(),this.resolveBuffer.destroy(),this.cpuBuffer.destroy()},t}(UC),YC=function(e){function t(t){var n=t.id,r=t.device,i=e.call(this,{id:n,device:r})||this;return i.type=TS.Readback,i}return mS(t,e),t.prototype.readTexture=function(e,t,n,r,i,o,a,s){return void 0===a&&(a=0),_S(this,void 0,void 0,(function(){var s,u,c,l,f,h,d;return yS(this,(function(p){return 0,u=BC((s=e).gpuTextureformat),c=Math.ceil(r/u.width)*u.length,l=256*Math.ceil(c/256),f=l*i,h=this.device.createBuffer({usage:PS.STORAGE|PS.MAP_READ|PS.COPY_DST,hint:DS.STATIC,viewOrSize:f}),(d=this.device.device.createCommandEncoder()).copyTextureToBuffer({texture:s.gpuTexture,mipLevel:0,origin:{x:t,y:n,z:Math.max(0,0)}},{buffer:h.gpuBuffer,offset:0,bytesPerRow:l},{width:r,height:i,depthOrArrayLayers:1}),this.device.device.queue.submit([d.finish()]),[2,this.readBuffer(h,0,o.byteLength===f?o:null,a,f,s.format,!0,!1,c,l,i)]}))}))},t.prototype.readTextureSync=function(e,t,n,r,i,o,a,s){throw new Error("ERROR_MSG_METHOD_NOT_IMPLEMENTED")},t.prototype.readBuffer=function(e,t,n,r,i,o,a,s,u,c,l){var f=this;void 0===t&&(t=0),void 0===n&&(n=null),void 0===i&&(i=0),void 0===o&&(o=KS.U8_RGB),void 0===a&&(a=!1),void 0===u&&(u=0),void 0===c&&(c=0),void 0===l&&(l=0);var h=e,d=i||h.size,p=n||h.view,v=p&&p.constructor&&p.constructor.BYTES_PER_ELEMENT||rT(o),m=h;if(!(h.usage&PS.MAP_READ&&h.usage&PS.COPY_DST)){var g=this.device.device.createCommandEncoder();m=this.device.createBuffer({usage:PS.STORAGE|PS.MAP_READ|PS.COPY_DST,hint:DS.STATIC,viewOrSize:d}),g.copyBufferToBuffer(h.gpuBuffer,t,m.gpuBuffer,0,d),this.device.device.queue.submit([g.finish()])}return new Promise((function(e,n){m.gpuBuffer.mapAsync(cC.READ,t,d).then((function(){var n=m.gpuBuffer.getMappedRange(t,d),r=p;if(a)r=null===r?FC(o,d,!0,n):FC(o,r.buffer,void 0,n);else if(null===r)switch(v){case 1:(r=new Uint8Array(d)).set(new Uint8Array(n));break;case 2:r=f.getHalfFloatAsFloatRGBAArrayBuffer(d/2,n);break;case 4:(r=new Float32Array(d/4)).set(new Float32Array(n))}else switch(v){case 1:(r=new Uint8Array(r.buffer)).set(new Uint8Array(n));break;case 2:r=f.getHalfFloatAsFloatRGBAArrayBuffer(d/2,n,p);break;case 4:var i=p&&p.constructor||Float32Array;(r=new i(r.buffer)).set(new i(n))}if(u!==c){1!==v||a||(u*=2,c*=2);for(var s=new Uint8Array(r.buffer),h=u,g=0,_=1;_<l;++_){g=_*c;for(var y=0;y<u;++y)s[h++]=s[g++]}r=0===v||a?new Uint8Array(s.buffer,0,h):new Float32Array(s.buffer,0,h/4)}m.gpuBuffer.unmap(),e(r)}),(function(e){return n(e)}))}))},t.prototype.getHalfFloatAsFloatRGBAArrayBuffer=function(e,t,n){n||(n=new Float32Array(e));for(var r,i,o,a,s=new Uint16Array(t);e--;)n[e]=(r=s[e],i=void 0,o=void 0,a=void 0,i=(32768&r)>>15,a=1023&r,0===(o=(31744&r)>>10)?(i?-1:1)*Math.pow(2,-14)*(a/Math.pow(2,10)):31==o?a?NaN:1/0*(i?-1:1):(i?-1:1)*Math.pow(2,o-15)*(1+a/Math.pow(2,10)));return n},t}(UC),ZC=function(){function e(e){this.device=e,this.gpuRenderPassEncoder=null,this.gfxColorAttachment=[],this.gfxColorAttachmentLevel=[],this.gfxColorResolveTo=[],this.gfxColorResolveToLevel=[],this.gfxDepthStencilAttachment=null,this.gfxDepthStencilResolveTo=null,this.gpuColorAttachments=[],this.gpuDepthStencilAttachment={view:null,depthLoadOp:"load",depthStoreOp:"store",stencilLoadOp:"load",stencilStoreOp:"store"},this.gpuRenderPassDescriptor={colorAttachments:this.gpuColorAttachments,depthStencilAttachment:this.gpuDepthStencilAttachment}}return e.prototype.getEncoder=function(){var e;return(null===(e=this.renderBundle)||void 0===e?void 0:e.renderBundleEncoder)||this.gpuRenderPassEncoder},e.prototype.getTextureView=function(e,t){return oT(t<e.mipLevelCount),1===e.mipLevelCount?e.gpuTextureView:e.gpuTexture.createView({baseMipLevel:t,mipLevelCount:1})},e.prototype.setRenderPassDescriptor=function(e){var t,n,r,i,o,a;this.descriptor=e,this.gpuRenderPassDescriptor.colorAttachments=this.gpuColorAttachments;var s=e.colorAttachment.length;this.gfxColorAttachment.length=s,this.gfxColorResolveTo.length=s;for(var u=0;u<e.colorAttachment.length;u++){var c=e.colorAttachment[u],l=e.colorResolveTo[u];if(null===c&&null!==l&&(c=l,l=null),this.gfxColorAttachment[u]=c,this.gfxColorResolveTo[u]=l,this.gfxColorAttachmentLevel[u]=(null===(t=e.colorAttachmentLevel)||void 0===t?void 0:t[u])||0,this.gfxColorResolveToLevel[u]=(null===(n=e.colorResolveToLevel)||void 0===n?void 0:n[u])||0,null===c){this.gpuColorAttachments.length=u,this.gfxColorAttachment.length=u,this.gfxColorResolveTo.length=u;break}void 0===this.gpuColorAttachments[u]&&(this.gpuColorAttachments[u]={}),(h=this.gpuColorAttachments[u]).view=this.getTextureView(c,(null===(r=this.gfxColorAttachmentLevel)||void 0===r?void 0:r[u])||0);var f=null!==(o=null===(i=e.colorClearColor)||void 0===i?void 0:i[u])&&void 0!==o?o:"load";"load"===f?h.loadOp="load":(h.loadOp="clear",h.clearValue=f),h.storeOp=(null===(a=e.colorStore)||void 0===a?void 0:a[u])?"store":"discard",h.resolveTarget=void 0,null!==l&&(c.sampleCount>1?h.resolveTarget=this.getTextureView(l,this.gfxColorResolveToLevel[u]):h.storeOp="store")}if(this.gfxDepthStencilAttachment=e.depthStencilAttachment,this.gfxDepthStencilResolveTo=e.depthStencilResolveTo,e.depthStencilAttachment){var h,d=e.depthStencilAttachment;(h=this.gpuDepthStencilAttachment).view=d.gpuTextureView,!!(tT(d.format)&qS.Depth)?("load"===e.depthClearValue?h.depthLoadOp="load":(h.depthLoadOp="clear",h.depthClearValue=e.depthClearValue),e.depthStencilStore||null!==this.gfxDepthStencilResolveTo?h.depthStoreOp="store":h.depthStoreOp="discard"):(h.depthLoadOp=void 0,h.depthStoreOp=void 0),!!(tT(d.format)&qS.Stencil)?("load"===e.stencilClearValue?h.stencilLoadOp="load":(h.stencilLoadOp="clear",h.stencilClearValue=e.stencilClearValue),e.depthStencilStore||null!==this.gfxDepthStencilResolveTo?h.stencilStoreOp="store":h.stencilStoreOp="discard"):(h.stencilLoadOp=void 0,h.stencilStoreOp=void 0),this.gpuRenderPassDescriptor.depthStencilAttachment=this.gpuDepthStencilAttachment}else this.gpuRenderPassDescriptor.depthStencilAttachment=void 0;this.gpuRenderPassDescriptor.occlusionQuerySet=lS(e.occlusionQueryPool)?void 0:e.occlusionQueryPool.querySet},e.prototype.beginRenderPass=function(e,t){oT(null===this.gpuRenderPassEncoder),this.setRenderPassDescriptor(t),this.frameCommandEncoder=e,this.gpuRenderPassEncoder=this.frameCommandEncoder.beginRenderPass(this.gpuRenderPassDescriptor)},e.prototype.flipY=function(e,t){return this.device.swapChainHeight-e-t},e.prototype.setViewport=function(e,t,n,r,i,o){void 0===i&&(i=0),void 0===o&&(o=1),this.gpuRenderPassEncoder.setViewport(e,this.flipY(t,r),n,r,i,o)},e.prototype.setScissorRect=function(e,t,n,r){this.gpuRenderPassEncoder.setScissorRect(e,this.flipY(t,r),n,r)},e.prototype.setPipeline=function(e){var t=aT(e.gpuRenderPipeline);this.getEncoder().setPipeline(t)},e.prototype.setVertexInput=function(e,t,n){if(null!==e){var r=this.getEncoder(),i=e;null!==n&&r.setIndexBuffer(AC(n.buffer),aT(i.indexFormat),n.offset);for(var o=0;o<t.length;o++){var a=t[o];null!==a&&r.setVertexBuffer(o,AC(a.buffer),a.offset)}}},e.prototype.setBindings=function(e){var t=e,n=this.getEncoder();t.gpuBindGroup.forEach((function(e,r){e&&n.setBindGroup(r,t.gpuBindGroup[r])}))},e.prototype.setStencilReference=function(e){this.gpuRenderPassEncoder.setStencilReference(e)},e.prototype.draw=function(e,t,n,r){this.getEncoder().draw(e,t,n,r)},e.prototype.drawIndexed=function(e,t,n,r,i){this.getEncoder().drawIndexed(e,t,n,r,i)},e.prototype.drawIndirect=function(e,t){this.getEncoder().drawIndirect(AC(e),t)},e.prototype.drawIndexedIndirect=function(e,t){this.getEncoder().drawIndexedIndirect(AC(e),t)},e.prototype.beginOcclusionQuery=function(e){this.gpuRenderPassEncoder.beginOcclusionQuery(e)},e.prototype.endOcclusionQuery=function(){this.gpuRenderPassEncoder.endOcclusionQuery()},e.prototype.pushDebugGroup=function(e){this.gpuRenderPassEncoder.pushDebugGroup(e)},e.prototype.popDebugGroup=function(){this.gpuRenderPassEncoder.popDebugGroup()},e.prototype.insertDebugMarker=function(e){this.gpuRenderPassEncoder.insertDebugMarker(e)},e.prototype.beginBundle=function(e){this.renderBundle=e},e.prototype.endBundle=function(){this.renderBundle.finish()},e.prototype.executeBundles=function(e){this.gpuRenderPassEncoder.executeBundles(e.map((function(e){return e.renderBundle})))},e.prototype.finish=function(){var e;null===(e=this.gpuRenderPassEncoder)||void 0===e||e.end(),this.gpuRenderPassEncoder=null;for(var t=0;t<this.gfxColorAttachment.length;t++){var n=this.gfxColorAttachment[t],r=this.gfxColorResolveTo[t];null!==n&&null!==r&&1===n.sampleCount&&this.copyAttachment(r,this.gfxColorAttachmentLevel[t],n,this.gfxColorResolveToLevel[t])}this.gfxDepthStencilAttachment&&this.gfxDepthStencilResolveTo&&(this.gfxDepthStencilAttachment.sampleCount>1||this.copyAttachment(this.gfxDepthStencilResolveTo,0,this.gfxDepthStencilAttachment,0)),this.frameCommandEncoder=null},e.prototype.copyAttachment=function(e,t,n,r){oT(1===n.sampleCount);var i={texture:n.gpuTexture,mipLevel:r},o={texture:e.gpuTexture,mipLevel:t};oT(n.width>>>r==e.width>>>t),oT(n.height>>>r==e.height>>>t),oT(!!(n.usage&uC.COPY_SRC)),oT(!!(e.usage&uC.COPY_DST)),this.frameCommandEncoder.copyTextureToTexture(i,o,[e.width,e.height,1])},e}(),qC=function(e){function t(t){var n=t.id,r=t.device,i=t.descriptor,o=e.call(this,{id:n,device:r})||this;return o.type=TS.RenderPipeline,o.isCreatingAsync=!1,o.gpuRenderPipeline=null,o.descriptor=i,o.device.createRenderPipelineInternal(o,!1),o}return mS(t,e),t.prototype.getBindGroupLayout=function(e){return this.gpuRenderPipeline.getBindGroupLayout(e)},t}(UC),KC=function(e){function t(t){var n,r,i=t.id,o=t.device,a=t.descriptor,s=e.call(this,{id:i,device:o})||this;s.type=TS.Sampler;var u=a.lodMinClamp,c=a.mipmapFilter===NS.NO_MIP?a.lodMinClamp:a.lodMaxClamp,l=null!==(n=a.maxAnisotropy)&&void 0!==n?n:1;return l>1&&oT(a.minFilter===kS.BILINEAR&&a.magFilter===kS.BILINEAR&&a.mipmapFilter===NS.LINEAR),s.gpuSampler=s.device.device.createSampler({addressModeU:yC(a.addressModeU),addressModeV:yC(a.addressModeV),addressModeW:yC(null!==(r=a.addressModeW)&&void 0!==r?r:a.addressModeU),lodMinClamp:u,lodMaxClamp:c,minFilter:EC(a.minFilter),magFilter:EC(a.magFilter),mipmapFilter:bC(a.mipmapFilter),compare:void 0!==a.compareFunction?NC(a.compareFunction):void 0,maxAnisotropy:l}),s}return mS(t,e),t}(UC),QC=function(e){function t(t){var n=t.id,r=t.device,i=t.descriptor,o=t.skipCreate,a=t.sampleCount,s=e.call(this,{id:n,device:r})||this;s.type=TS.Texture,s.flipY=!1;var u=i.format,c=i.dimension,l=i.width,f=i.height,h=i.depthOrArrayLayers,d=i.mipLevelCount,p=i.usage,v=i.pixelStore;return s.flipY=!!(null==v?void 0:v.unpackFlipY),s.device.createTextureShared({format:u,dimension:null!=c?c:US.TEXTURE_2D,width:l,height:f,depthOrArrayLayers:null!=h?h:1,mipLevelCount:null!=d?d:1,usage:p,sampleCount:null!=a?a:1},s,o),s}return mS(t,e),t.prototype.textureFromImageBitmapOrCanvas=function(e,t,n){for(var r=t[0].width,i=t[0].height,o={size:{width:r,height:i,depthOrArrayLayers:n},format:"rgba8unorm",usage:GPUTextureUsage.TEXTURE_BINDING|GPUTextureUsage.COPY_DST|GPUTextureUsage.RENDER_ATTACHMENT},a=e.createTexture(o),s=0;s<t.length;s++)e.queue.copyExternalImageToTexture({source:t[s],flipY:this.flipY},{texture:a,origin:[0,0,s]},[r,i]);return[a,r,i]},t.prototype.isImageBitmapOrCanvases=function(e){var t=e[0];return t instanceof ImageBitmap||t instanceof HTMLCanvasElement||t instanceof OffscreenCanvas},t.prototype.isVideo=function(e){return e[0]instanceof HTMLVideoElement},t.prototype.setImageData=function(e,t){var n,r,i,o,a=this,s=this.device.device;if(this.isImageBitmapOrCanvases(e))r=(n=bS(this.textureFromImageBitmapOrCanvas(s,e,this.depthOrArrayLayers),3))[0],i=n[1],o=n[2];else if(this.isVideo(e))r=s.importExternalTexture({source:e[0]});else{var u=BC(this.gpuTextureformat),c=Math.ceil(this.width/u.width)*u.length;e.forEach((function(e){s.queue.writeTexture({texture:a.gpuTexture},e,{bytesPerRow:c},{width:a.width,height:a.height})}))}this.width=i,this.height=o,r&&(this.gpuTexture=r),this.gpuTextureView=this.gpuTexture.createView({dimension:_C(this.dimension)})},t.prototype.destroy=function(){e.prototype.destroy.call(this),this.gpuTexture.destroy()},t}(UC),$C=function(e){function t(t){var n=t.id,r=t.device,i=e.call(this,{id:n,device:r})||this;return i.type=TS.RenderBundle,i.renderBundleEncoder=i.device.device.createRenderBundleEncoder({colorFormats:[i.device.swapChainFormat]}),i}return mS(t,e),t.prototype.finish=function(){this.renderBundle=this.renderBundleEncoder.finish()},t}(UC),JC=function(){function e(e,t,n,r,i,o){this.swapChainWidth=0,this.swapChainHeight=0,this.swapChainTextureUsage=uC.RENDER_ATTACHMENT|uC.COPY_DST,this._resourceUniqueId=0,this.renderPassPool=[],this.computePassPool=[],this.frameCommandEncoderPool=[],this.featureTextureCompressionBC=!1,this.platformString="WebGPU",this.glslVersion="#version 440",this.explicitBindingLocations=!0,this.separateSamplerTextures=!0,this.viewportOrigin=HS.UPPER_LEFT,this.clipSpaceNearZ=XS.ZERO,this.supportsSyncPipelineCompilation=!1,this.supportMRT=!0,this.device=t,this.canvas=n,this.canvasContext=r,this.glsl_compile=i,this.WGSLComposer=o,this.fallbackTexture2D=this.createFallbackTexture(US.TEXTURE_2D,VS.Float),this.setResourceName(this.fallbackTexture2D,"Fallback Texture2D"),this.fallbackTexture2DDepth=this.createFallbackTexture(US.TEXTURE_2D,VS.Depth),this.setResourceName(this.fallbackTexture2DDepth,"Fallback Depth Texture2D"),this.fallbackTexture2DArray=this.createFallbackTexture(US.TEXTURE_2D_ARRAY,VS.Float),this.setResourceName(this.fallbackTexture2DArray,"Fallback Texture2DArray"),this.fallbackTexture3D=this.createFallbackTexture(US.TEXTURE_3D,VS.Float),this.setResourceName(this.fallbackTexture3D,"Fallback Texture3D"),this.fallbackTextureCube=this.createFallbackTexture(US.TEXTURE_CUBE_MAP,VS.Float),this.setResourceName(this.fallbackTextureCube,"Fallback TextureCube"),this.fallbackSamplerFiltering=this.createSampler({addressModeU:OS.REPEAT,addressModeV:OS.REPEAT,minFilter:kS.POINT,magFilter:kS.POINT,mipmapFilter:NS.NEAREST}),this.setResourceName(this.fallbackSamplerFiltering,"Fallback Sampler Filtering"),this.fallbackSamplerComparison=this.createSampler({addressModeU:OS.REPEAT,addressModeV:OS.REPEAT,minFilter:kS.POINT,magFilter:kS.POINT,mipmapFilter:NS.NEAREST,compareFunction:RS.ALWAYS}),this.setResourceName(this.fallbackSamplerComparison,"Fallback Sampler Comparison Filtering"),this.device.features&&(this.featureTextureCompressionBC=this.device.features.has("texture-compression-bc")),this.device.onuncapturederror=function(e){console.error(e.error)},this.swapChainFormat=navigator.gpu.getPreferredCanvasFormat(),this.canvasContext.configure({device:this.device,format:this.swapChainFormat,usage:this.swapChainTextureUsage,alphaMode:"premultiplied"})}return e.prototype.destroy=function(){},e.prototype.configureSwapChain=function(e,t){this.swapChainWidth===e&&this.swapChainHeight===t||(this.swapChainWidth=e,this.swapChainHeight=t)},e.prototype.getOnscreenTexture=function(){var e=this.canvasContext.getCurrentTexture(),t=e.createView(),n=new QC({id:0,device:this,descriptor:{format:KS.U8_RGBA_RT,width:this.swapChainWidth,height:this.swapChainHeight,depthOrArrayLayers:0,dimension:US.TEXTURE_2D,mipLevelCount:1,usage:this.swapChainTextureUsage},skipCreate:!0});return n.depthOrArrayLayers=1,n.sampleCount=1,n.gpuTexture=e,n.gpuTextureView=t,n.name="Onscreen",this.setResourceName(n,"Onscreen Texture"),n},e.prototype.getDevice=function(){return this},e.prototype.getCanvas=function(){return this.canvas},e.prototype.beginFrame=function(){oT(0===this.frameCommandEncoderPool.length)},e.prototype.endFrame=function(){oT(this.frameCommandEncoderPool.every((function(e){return null!==e}))),this.device.queue.submit(this.frameCommandEncoderPool.map((function(e){return e.finish()}))),this.frameCommandEncoderPool=[]},e.prototype.getNextUniqueId=function(){return++this._resourceUniqueId},e.prototype.createBuffer=function(e){return new zC({id:this.getNextUniqueId(),device:this,descriptor:e})},e.prototype.createTexture=function(e){return new QC({id:this.getNextUniqueId(),device:this,descriptor:e})},e.prototype.createSampler=function(e){return new KC({id:this.getNextUniqueId(),device:this,descriptor:e})},e.prototype.createRenderTarget=function(e){var t=new QC({id:this.getNextUniqueId(),device:this,descriptor:gS(gS({},e),{dimension:US.TEXTURE_2D,mipLevelCount:1,depthOrArrayLayers:1,usage:GS.RENDER_TARGET}),sampleCount:e.sampleCount});return t.depthOrArrayLayers=1,t.type=TS.RenderTarget,t},e.prototype.createRenderTargetFromTexture=function(e){var t=e,n=t.format,r=t.width,i=t.height,o=t.depthOrArrayLayers,a=t.sampleCount,s=t.mipLevelCount,u=t.gpuTexture,c=t.gpuTextureView,l=t.usage;oT(!!(l&uC.RENDER_ATTACHMENT));var f=new QC({id:this.getNextUniqueId(),device:this,descriptor:{format:n,width:r,height:i,depthOrArrayLayers:o,dimension:US.TEXTURE_2D,mipLevelCount:s,usage:l},skipCreate:!0});return f.depthOrArrayLayers=o,f.sampleCount=a,f.gpuTexture=u,f.gpuTextureView=c,f},e.prototype.createProgram=function(e){var t,n;return(null===(t=e.vertex)||void 0===t?void 0:t.glsl)&&(e.vertex.glsl=fR(this.queryVendorInfo(),"vert",e.vertex.glsl)),(null===(n=e.fragment)||void 0===n?void 0:n.glsl)&&(e.fragment.glsl=fR(this.queryVendorInfo(),"frag",e.fragment.glsl)),new XC({id:this.getNextUniqueId(),device:this,descriptor:e})},e.prototype.createProgramSimple=function(e){return new XC({id:this.getNextUniqueId(),device:this,descriptor:e})},e.prototype.createTextureShared=function(e,t,n){var r={width:e.width,height:e.height,depthOrArrayLayers:e.depthOrArrayLayers},i=e.mipLevelCount,o=gC(e.format),a=function(e){if(e===US.TEXTURE_2D)return"2d";if(e===US.TEXTURE_CUBE_MAP)return"2d";if(e===US.TEXTURE_2D_ARRAY)return"2d";if(e===US.TEXTURE_3D)return"3d";throw new Error("whoops")}(e.dimension),s=function(e){var t=0;return e&GS.SAMPLED&&(t|=uC.TEXTURE_BINDING|uC.COPY_DST|uC.COPY_SRC),e&GS.STORAGE&&(t|=uC.TEXTURE_BINDING|uC.STORAGE_BINDING|uC.COPY_SRC|uC.COPY_DST),e&GS.RENDER_TARGET&&(t|=uC.RENDER_ATTACHMENT|uC.TEXTURE_BINDING|uC.COPY_SRC|uC.COPY_DST),t}(e.usage);if(t.gpuTextureformat=o,t.dimension=e.dimension,t.format=e.format,t.width=e.width,t.height=e.height,t.depthOrArrayLayers=e.depthOrArrayLayers,t.mipLevelCount=i,t.usage=s,t.sampleCount=e.sampleCount,!n){var u=this.device.createTexture({size:r,mipLevelCount:i,format:o,dimension:a,sampleCount:e.sampleCount,usage:s}),c=u.createView();t.gpuTexture=u,t.gpuTextureView=c}},e.prototype.getFallbackSampler=function(e){return e.formatKind===VS.Depth&&e.comparison?this.fallbackSamplerComparison:this.fallbackSamplerFiltering},e.prototype.getFallbackTexture=function(e){var t=e.dimension,n=e.formatKind;if(t===US.TEXTURE_2D)return n===VS.Depth?this.fallbackTexture2DDepth:this.fallbackTexture2D;if(t===US.TEXTURE_2D_ARRAY)return this.fallbackTexture2DArray;if(t===US.TEXTURE_3D)return this.fallbackTexture3D;if(t===US.TEXTURE_CUBE_MAP)return this.fallbackTextureCube;throw new Error("whoops")},e.prototype.createFallbackTexture=function(e,t){var n=e===US.TEXTURE_CUBE_MAP?6:1,r=t===VS.Float?KS.U8_RGBA_NORM:KS.D24;return this.createTexture({dimension:e,format:r,usage:GS.SAMPLED,width:1,height:1,depthOrArrayLayers:n,mipLevelCount:1})},e.prototype.createBindings=function(e){return new GC({id:this.getNextUniqueId(),device:this,descriptor:e})},e.prototype.createInputLayout=function(e){return new HC({id:this.getNextUniqueId(),device:this,descriptor:e})},e.prototype.createComputePipeline=function(e){return new VC({id:this.getNextUniqueId(),device:this,descriptor:e})},e.prototype.createRenderPipeline=function(e){return new qC({id:this.getNextUniqueId(),device:this,descriptor:gS({},e)})},e.prototype.createQueryPool=function(e,t){return new WC({id:this.getNextUniqueId(),device:this,descriptor:{type:e,elemCount:t}})},e.prototype.createRenderPipelineInternal=function(e,t){var n;if(null===e.gpuRenderPipeline){var r=e.descriptor,i=r.program,o=i.vertexStage,a=i.fragmentStage;if(null!==o&&null!==a){var s=r.megaStateDescriptor||{},u=s.stencilBack,c=s.stencilFront,l=function(e,t){var n={};for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&t.indexOf(r)<0&&(n[r]=e[r]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(r=Object.getOwnPropertySymbols(e);i<r.length;i++)t.indexOf(r[i])<0&&Object.prototype.propertyIsEnumerable.call(e,r[i])&&(n[r[i]]=e[r[i]])}return n}(s,["stencilBack","stencilFront"]),f=ET(AT);r.megaStateDescriptor=gS(gS(gS({},f),{stencilBack:gS(gS({},f.stencilBack),u),stencilFront:gS(gS({},f.stencilFront),c)}),l);var h=r.megaStateDescriptor.attachmentsState[0];r.colorAttachmentFormats.forEach((function(e,t){r.megaStateDescriptor.attachmentsState[t]||(r.megaStateDescriptor.attachmentsState[t]=_T(void 0,h))}));var d,p,v=(d=null!==(n=r.topology)&&void 0!==n?n:IS.TRIANGLES,p=r.megaStateDescriptor,{topology:SC(d),cullMode:TC(p.cullMode),frontFace:RC(p.frontFace)}),m=kC(r.colorAttachmentFormats,r.megaStateDescriptor),g=function(e,t){if(!lS(e))return{format:gC(e),depthWriteEnabled:!!t.depthWrite,depthCompare:NC(t.depthCompare),depthBias:t.polygonOffset?1:0,depthBiasSlopeScale:t.polygonOffset?1:0,stencilFront:{compare:NC(t.stencilFront.compare),passOp:IC(t.stencilFront.passOp),failOp:IC(t.stencilFront.failOp),depthFailOp:IC(t.stencilFront.depthFailOp)},stencilBack:{compare:NC(t.stencilBack.compare),passOp:IC(t.stencilBack.passOp),failOp:IC(t.stencilBack.failOp),depthFailOp:IC(t.stencilBack.depthFailOp)},stencilReadMask:4294967295,stencilWriteMask:4294967295}}(r.depthStencilAttachmentFormat,r.megaStateDescriptor),_=void 0;null!==r.inputLayout&&(_=r.inputLayout.buffers);var y=r.sampleCount,E={layout:"auto",vertex:gS(gS({},o),{buffers:_}),primitive:v,depthStencil:g,multisample:{count:y},fragment:gS(gS({},a),{targets:m})};e.gpuRenderPipeline=this.device.createRenderPipeline(E)}}},e.prototype.createReadback=function(){return new YC({id:this.getNextUniqueId(),device:this})},e.prototype.createRenderBundle=function(){return new $C({id:this.getNextUniqueId(),device:this})},e.prototype.createRenderPass=function(e){var t=this.renderPassPool.pop();void 0===t&&(t=new ZC(this));var n=this.frameCommandEncoderPool.pop();return void 0===n&&(n=this.device.createCommandEncoder()),t.beginRenderPass(n,e),t},e.prototype.createComputePass=function(){var e=this.computePassPool.pop();void 0===e&&(e=new jC);var t=this.frameCommandEncoderPool.pop();return void 0===t&&(t=this.device.createCommandEncoder()),e.beginComputePass(t),e},e.prototype.submitPass=function(e){var t=e;t instanceof ZC?(this.frameCommandEncoderPool.push(t.frameCommandEncoder),t.finish(),this.renderPassPool.push(t)):t instanceof jC&&(this.frameCommandEncoderPool.push(t.frameCommandEncoder),t.finish(),this.computePassPool.push(t))},e.prototype.copySubTexture2D=function(e,t,n,r,i,o,a){var s=this.device.createCommandEncoder(),u=e,c=r,l={texture:c.gpuTexture,origin:[i,o,0],mipLevel:0,aspect:"all"},f={texture:u.gpuTexture,origin:[t,n,0],mipLevel:0,aspect:"all"};oT(!!(c.usage&uC.COPY_SRC)),oT(!!(u.usage&uC.COPY_DST)),s.copyTextureToTexture(l,f,[c.width,c.height,a||1]),this.device.queue.submit([s.finish()])},e.prototype.queryLimits=function(){return{uniformBufferMaxPageWordSize:this.device.limits.maxUniformBufferBindingSize>>>2,uniformBufferWordAlignment:this.device.limits.minUniformBufferOffsetAlignment>>>2,supportedSampleCounts:[1],occlusionQueriesRecommended:!0,computeShadersSupported:!0}},e.prototype.queryTextureFormatSupported=function(e,t,n){if(function(e){switch(eT(e)){case YS.BC1:case YS.BC2:case YS.BC3:case YS.BC4_SNORM:case YS.BC4_UNORM:case YS.BC5_SNORM:case YS.BC5_UNORM:return!0;default:return!1}}(e)){if(!this.featureTextureCompressionBC)return!1;var r=function(e){switch(eT(e)){case YS.BC1:case YS.BC2:case YS.BC3:case YS.BC4_SNORM:case YS.BC4_UNORM:case YS.BC5_SNORM:case YS.BC5_UNORM:return 4;default:return 1}}(e);return t%r==0&&n%r==0&&this.featureTextureCompressionBC}switch(e){case KS.U16_RGBA_NORM:case KS.F32_RGBA:return!1}return!0},e.prototype.queryPlatformAvailable=function(){return!0},e.prototype.queryVendorInfo=function(){return this},e.prototype.queryRenderPass=function(e){return e.descriptor},e.prototype.queryRenderTarget=function(e){return e},e.prototype.setResourceName=function(e,t){if(e.name=t,e.type===TS.Buffer)(n=e).gpuBuffer.label=t;else if(e.type===TS.Texture){(n=e).gpuTexture.label=t,n.gpuTextureView.label=t}else if(e.type===TS.RenderTarget){(n=e).gpuTexture.label=t,n.gpuTextureView.label=t}else if(e.type===TS.Sampler){(n=e).gpuSampler.label=t}else if(e.type===TS.RenderPipeline){var n;null!==(n=e).gpuRenderPipeline&&(n.gpuRenderPipeline.label=t)}},e.prototype.setResourceLeakCheck=function(e,t){},e.prototype.checkForLeaks=function(){},e.prototype.programPatched=function(e){},e.prototype.pipelineQueryReady=function(e){return null!==e.gpuRenderPipeline},e.prototype.pipelineForceReady=function(e){var t=e;this.createRenderPipelineInternal(t,!1)},e}(),eM=function(){function e(e){this.pluginOptions=e}return e.prototype.createSwapChain=function(e){return _S(this,void 0,void 0,(function(){var t,n,r,i,o,a,s;return yS(this,(function(u){switch(u.label){case 0:if(void 0===globalThis.navigator.gpu)return[2,null];t=null,u.label=1;case 1:return u.trys.push([1,3,,4]),n=this.pluginOptions.xrCompatible,[4,globalThis.navigator.gpu.requestAdapter({xrCompatible:n})];case 2:return t=u.sent(),[3,4];case 3:return r=u.sent(),console.log(r),[3,4];case 4:return null===t?[2,null]:(i=["depth32float-stencil8","texture-compression-bc","float32-filterable"].filter((function(e){return t.features.has(e)})),[4,t.requestDevice({requiredFeatures:i})]);case 5:if((o=u.sent())&&(a=this.pluginOptions.onContextLost,o.lost.then((function(){a&&a()}))),null===o)return[2,null];if(!(s=e.getContext("webgpu")))return[2,null];u.label=6;case 6:return u.trys.push([6,8,,9]),[4,vC(this.pluginOptions.shaderCompilerPath)];case 7:case 8:return u.sent(),[3,9];case 9:return[2,new JC(t,o,e,s,sC,lC&&new lC)]}}))}))},e}(),tM=function(){return c((function e(t,n){f(this,e);var r=n.buffer,i=n.offset,o=n.stride,a=n.normalized,s=n.size,u=n.divisor,c=n.shaderLocation;this.buffer=r,this.attribute={shaderLocation:c,buffer:r.get(),offset:i||0,stride:o||0,normalized:a||!1,divisor:u||0},s&&(this.attribute.size=s)}),[{key:"get",value:function(){return this.buffer}},{key:"updateBuffer",value:function(e){this.buffer.subData(e)}},{key:"destroy",value:function(){this.buffer.destroy()}}])}(),nM=o(o(o(o(o(o({},Bu.FLOAT,Float32Array),Bu.UNSIGNED_BYTE,Uint8Array),Bu.SHORT,Int16Array),Bu.UNSIGNED_SHORT,Uint16Array),Bu.INT,Int32Array),Bu.UNSIGNED_INT,Uint32Array),rM=o(o(o(o(o(o(o({},Bu.POINTS,IS.POINTS),Bu.LINES,IS.LINES),Bu.LINE_LOOP,IS.LINES),Bu.LINE_STRIP,IS.LINE_STRIP),Bu.TRIANGLES,IS.TRIANGLES),Bu.TRIANGLE_FAN,IS.TRIANGLES),Bu.TRIANGLE_STRIP,IS.TRIANGLE_STRIP),iM=o(o(o(o({},1,KS.F32_R),2,KS.F32_RG),3,KS.F32_RGB),4,KS.F32_RGBA),oM=o(o(o({},Bu.STATIC_DRAW,DS.STATIC),Bu.DYNAMIC_DRAW,DS.DYNAMIC),Bu.STREAM_DRAW,DS.DYNAMIC),aM=o(o(o({},Bu.REPEAT,OS.REPEAT),Bu.CLAMP_TO_EDGE,OS.CLAMP_TO_EDGE),Bu.MIRRORED_REPEAT,OS.MIRRORED_REPEAT),sM=o(o(o(o(o(o(o(o({},Bu.NEVER,RS.NEVER),Bu.ALWAYS,RS.ALWAYS),Bu.LESS,RS.LESS),Bu.LEQUAL,RS.LEQUAL),Bu.GREATER,RS.GREATER),Bu.GEQUAL,RS.GEQUAL),Bu.EQUAL,RS.EQUAL),Bu.NOTEQUAL,RS.NOTEQUAL),uM=o(o({},Bu.FRONT,MS.FRONT),Bu.BACK,MS.BACK),cM=o(o(o(o(o({},Bu.FUNC_ADD,LS.ADD),Bu.MIN_EXT,LS.MIN),Bu.MAX_EXT,LS.MAX),Bu.FUNC_SUBTRACT,LS.SUBSTRACT),Bu.FUNC_REVERSE_SUBTRACT,LS.REVERSE_SUBSTRACT),lM=(o(o(o(o(o(o(o(o(o(o(de={},Bu.ZERO,wS.ZERO),Bu.ONE,wS.ONE),Bu.SRC_COLOR,wS.SRC),Bu.ONE_MINUS_SRC_COLOR,wS.ONE_MINUS_SRC),Bu.SRC_ALPHA,wS.SRC_ALPHA),Bu.ONE_MINUS_SRC_ALPHA,wS.ONE_MINUS_SRC_ALPHA),Bu.DST_COLOR,wS.DST),Bu.ONE_MINUS_DST_COLOR,wS.ONE_MINUS_DST),Bu.DST_ALPHA,wS.DST_ALPHA),Bu.ONE_MINUS_DST_ALPHA,wS.ONE_MINUS_DST_ALPHA),o(o(o(o(o(de,Bu.CONSTANT_COLOR,wS.CONST),Bu.ONE_MINUS_CONSTANT_COLOR,wS.ONE_MINUS_CONSTANT),Bu.CONSTANT_ALPHA,wS.CONST),Bu.ONE_MINUS_CONSTANT_ALPHA,wS.ONE_MINUS_CONSTANT),Bu.SRC_ALPHA_SATURATE,wS.SRC_ALPHA_SATURATE)),fM=o(o(o(o(o(o(o(o({},Bu.REPLACE,jS.REPLACE),Bu.KEEP,jS.KEEP),Bu.ZERO,jS.ZERO),Bu.INVERT,jS.INVERT),Bu.INCR,jS.INCREMENT_CLAMP),Bu.DECR,jS.DECREMENT_CLAMP),Bu.INCR_WRAP,jS.INCREMENT_WRAP),Bu.DECR_WRAP,jS.DECREMENT_WRAP),hM=o(o(o(o(o(o(o(o({},Bu.ALWAYS,RS.ALWAYS),Bu.EQUAL,RS.EQUAL),Bu.GEQUAL,RS.GEQUAL),Bu.GREATER,RS.GREATER),Bu.LEQUAL,RS.LEQUAL),Bu.LESS,RS.LESS),Bu.NEVER,RS.NEVER),Bu.NOTEQUAL,RS.NOTEQUAL),dM={"[object Int8Array]":5120,"[object Int16Array]":5122,"[object Int32Array]":5124,"[object Uint8Array]":5121,"[object Uint8ClampedArray]":5121,"[object Uint16Array]":5123,"[object Uint32Array]":5125,"[object Float32Array]":5126,"[object Float64Array]":5121,"[object ArrayBuffer]":5121};function pM(e){return Object.prototype.toString.call(e)in dM}var vM=function(){return c((function e(t,n){f(this,e),this.isDestroyed=!1;var r,i=n.data,o=n.usage,a=n.type,s=n.isUBO,u=n.label;r=pM(i)?i:new nM[this.type||Bu.FLOAT](i),this.type=a,this.size=r.byteLength,this.buffer=t.createBuffer({viewOrSize:r,usage:s?PS.UNIFORM:PS.VERTEX,hint:oM[o||Bu.STATIC_DRAW]}),u&&t.setResourceName(this.buffer,u)}),[{key:"get",value:function(){return this.buffer}},{key:"destroy",value:function(){this.isDestroyed||this.buffer.destroy(),this.isDestroyed=!0}},{key:"subData",value:function(e){var t,n=e.data,r=e.offset;t=pM(n)?n:new nM[this.type||Bu.FLOAT](n),this.buffer.setSubData(r,new Uint8Array(t.buffer))}}])}();function mM(e){return e+=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,e+=e<<10,(e+=e>>>6)>>>0}function gM(e){return e+=e<<3,e^=e>>>11,(e+=e<<15)>>>0}function _M(){return 0}var yM=c((function e(){f(this,e),this.keys=[],this.values=[]})),EM=function(){return c((function e(t,n){f(this,e),this.keyEqualFunc=t,this.keyHashFunc=n,this.buckets=new Map}),[{key:"findBucketIndex",value:function(e,t){for(var n=0;n<e.keys.length;n++)if(this.keyEqualFunc(t,e.keys[n]))return n;return-1}},{key:"findBucket",value:function(e){var t=this.keyHashFunc(e);return this.buckets.get(t)}},{key:"get",value:function(e){var t=this.findBucket(e);if(void 0===t)return null;var n=this.findBucketIndex(t,e);return n<0?null:t.values[n]}},{key:"add",value:function(e,t){var n=this.keyHashFunc(e);void 0===this.buckets.get(n)&&this.buckets.set(n,new yM);var r=this.buckets.get(n);r.keys.push(e),r.values.push(t)}},{key:"delete",value:function(e){var t=this.findBucket(e);if(void 0!==t){var n=this.findBucketIndex(t,e);-1!==n&&(t.keys.splice(n,1),t.values.splice(n,1))}}},{key:"clear",value:function(){this.buckets.clear()}},{key:"size",value:function(){var e,t=0,n=y(this.buckets.values());try{for(n.s();!(e=n.n()).done;){t+=e.value.values.length}}catch(r){n.e(r)}finally{n.f()}return t}},{key:"values",value:i().mark((function e(){var t,n,r,o;return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:t=y(this.buckets.values()),e.prev=1,t.s();case 3:if((n=t.n()).done){e.next=14;break}r=n.value,o=r.values.length-1;case 6:if(!(o>=0)){e.next=12;break}return e.next=9,r.values[o];case 9:o--,e.next=6;break;case 12:e.next=3;break;case 14:e.next=19;break;case 16:e.prev=16,e.t0=e.catch(1),t.e(e.t0);case 19:return e.prev=19,t.f(),e.finish(19);case 22:case"end":return e.stop()}}),e,this,[[1,16,19,22]])}))}])}();function bM(e,t){return e=mM(e,t.blendMode),e=mM(e,t.blendSrcFactor),e=mM(e,t.blendDstFactor)}function AM(e,t){return e=bM(e,t.rgbBlendState),e=mM(e=bM(e,t.alphaBlendState),t.channelWriteMask)}function xM(e,t){for(var n,r,i,o,a,s,u,c,l=0;l<t.attachmentsState.length;l++)e=AM(e,t.attachmentsState[l]);return e=function(e,t){return mM(e,t.r<<24|t.g<<16|t.b<<8|t.a)}(e,t.blendConstant||fT),e=mM(e,t.depthCompare),e=mM(e,t.depthWrite?1:0),e=mM(e,null==(n=t.stencilFront)?void 0:n.compare),e=mM(e,null==(r=t.stencilFront)?void 0:r.passOp),e=mM(e,null==(i=t.stencilFront)?void 0:i.failOp),e=mM(e,null==(o=t.stencilFront)?void 0:o.depthFailOp),e=mM(e,null==(a=t.stencilBack)?void 0:a.compare),e=mM(e,null==(s=t.stencilBack)?void 0:s.passOp),e=mM(e,null==(u=t.stencilBack)?void 0:u.failOp),e=mM(e,null==(c=t.stencilBack)?void 0:c.depthFailOp),e=mM(e,t.stencilWrite?1:0),e=mM(e,t.cullMode),e=mM(e,t.frontFace?1:0),e=mM(e,t.polygonOffset?1:0)}function SM(e){var t=0;t=mM(t,e.program.id),null!==e.inputLayout&&(t=mM(t,e.inputLayout.id)),t=xM(t,e.megaStateDescriptor);for(var n=0;n<e.colorAttachmentFormats.length;n++)t=mM(t,e.colorAttachmentFormats[n]||0);return gM(t=mM(t,e.depthStencilAttachmentFormat||0))}function TM(e){var t=0;if(e.samplerBindings)for(var n=0;n<e.samplerBindings.length;n++){var r=e.samplerBindings[n];null!==r&&null!==r.texture&&(t=mM(t,r.texture.id))}if(e.uniformBufferBindings)for(var i=0;i<e.uniformBufferBindings.length;i++){var o=e.uniformBufferBindings[i];null!==o&&null!==o.buffer&&(t=mM(t,o.buffer.id),t=mM(t,o.binding),t=mM(t,o.offset),t=mM(t,o.size))}if(e.storageBufferBindings)for(var a=0;a<e.storageBufferBindings.length;a++){var s=e.storageBufferBindings[a];null!==s&&null!==s.buffer&&(t=mM(t,s.buffer.id),t=mM(t,s.binding),t=mM(t,s.offset),t=mM(t,s.size))}if(e.storageTextureBindings)for(var u=0;u<e.storageTextureBindings.length;u++){var c=e.storageTextureBindings[u];null!==c&&null!==c.texture&&(t=mM(t,c.texture.id),t=mM(t,c.binding))}return gM(t)}function RM(e,t){var n,r,i,o;return(null==(n=e.vertex)?void 0:n.glsl)===(null==(r=t.vertex)?void 0:r.glsl)&&(null==(i=e.fragment)?void 0:i.glsl)===(null==(o=t.fragment)?void 0:o.glsl)}var CM=function(){return c((function e(t){f(this,e),this.device=t,this.bindingsCache=new EM(LT,TM),this.renderPipelinesCache=new EM(DT,SM),this.inputLayoutsCache=new EM(UT,_M),this.programCache=new EM(RM,_M)}),[{key:"createBindings",value:function(e){var t,n,r=this.bindingsCache.get(e);if(null===r){var i={samplerBindings:(n=e).samplerBindings&&RT(n.samplerBindings,GT),uniformBufferBindings:n.uniformBufferBindings&&RT(n.uniformBufferBindings,zT),storageBufferBindings:n.storageBufferBindings&&RT(n.storageBufferBindings,zT),storageTextureBindings:n.storageTextureBindings&&RT(n.storageTextureBindings,jT),pipeline:n.pipeline};i.uniformBufferBindings=null==(t=i.uniformBufferBindings)?void 0:t.filter((function(e){var t=e.size;return t&&t>0})),r=this.device.createBindings(i),this.bindingsCache.add(i,r)}return r}},{key:"createRenderPipeline",value:function(e){var t,n,r,i,o=this.renderPipelinesCache.get(e);if(null===o){var a=(n=(t=e).inputLayout,r=t.program,i=t.topology,{inputLayout:n,megaStateDescriptor:t.megaStateDescriptor&&ET(t.megaStateDescriptor),program:r,topology:i,colorAttachmentFormats:t.colorAttachmentFormats.slice(),depthStencilAttachmentFormat:t.depthStencilAttachmentFormat,sampleCount:t.sampleCount});a.colorAttachmentFormats=a.colorAttachmentFormats.filter((function(e){return e})),o=this.device.createRenderPipeline(a),this.renderPipelinesCache.add(a,o)}return o}},{key:"createInputLayout",value:function(e){e.vertexBufferDescriptors=e.vertexBufferDescriptors.filter((function(e){return!!e}));var t,n=this.inputLayoutsCache.get(e);if(null===n){var r={vertexBufferDescriptors:RT((t=e).vertexBufferDescriptors,HT),indexBufferFormat:t.indexBufferFormat,program:t.program};n=this.device.createInputLayout(r),this.inputLayoutsCache.add(r,n)}return n}},{key:"createProgram",value:function(e){var t=this.programCache.get(e);if(null===t){var n=function(e){var t,n;return{vertex:{glsl:null==(t=e.vertex)?void 0:t.glsl},fragment:{glsl:null==(n=e.fragment)?void 0:n.glsl}}}(e);t=this.device.createProgram(e),this.programCache.add(n,t)}return t}},{key:"destroy",value:function(){var e,t=y(this.bindingsCache.values());try{for(t.s();!(e=t.n()).done;){e.value.destroy()}}catch(u){t.e(u)}finally{t.f()}var n,r=y(this.renderPipelinesCache.values());try{for(r.s();!(n=r.n()).done;){n.value.destroy()}}catch(u){r.e(u)}finally{r.f()}var i,o=y(this.inputLayoutsCache.values());try{for(o.s();!(i=o.n()).done;){i.value.destroy()}}catch(u){o.e(u)}finally{o.f()}var a,s=y(this.programCache.values());try{for(s.s();!(a=s.n()).done;){a.value.destroy()}}catch(u){s.e(u)}finally{s.f()}this.bindingsCache.clear(),this.renderPipelinesCache.clear(),this.inputLayoutsCache.clear(),this.programCache.clear()}}])}(),MM=function(){return c((function e(t,n){f(this,e);var r,i=n.data,o=n.type,a=n.count,s=void 0===a?0:a;r=pM(i)?i:new nM[this.type||Bu.UNSIGNED_INT](i),this.type=o,this.count=s,this.indexBuffer=t.createBuffer({viewOrSize:r,usage:PS.INDEX})}),[{key:"get",value:function(){return this.indexBuffer}},{key:"subData",value:function(e){var t,n=e.data;t=pM(n)?n:new nM[this.type||Bu.UNSIGNED_INT](n),this.indexBuffer.setSubData(0,new Uint8Array(t.buffer))}},{key:"destroy",value:function(){this.indexBuffer.destroy()}}])}();function wM(e){return!(!e||!e.texture)}var LM=function(){return c((function e(t,n){f(this,e),this.device=t,this.options=n,this.isDestroy=!1;var r=n.wrapS,i=void 0===r?Bu.CLAMP_TO_EDGE:r,o=n.wrapT,a=void 0===o?Bu.CLAMP_TO_EDGE:o,s=n.aniso,u=n.mag,c=void 0===u?Bu.NEAREST:u,l=n.min,h=void 0===l?Bu.NEAREST:l;this.createTexture(n),this.sampler=t.createSampler({addressModeU:aM[i],addressModeV:aM[a],minFilter:h===Bu.NEAREST?kS.POINT:kS.BILINEAR,magFilter:c===Bu.NEAREST?kS.POINT:kS.BILINEAR,mipmapFilter:NS.NO_MIP,maxAnisotropy:s})}),[{key:"createTexture",value:function(e){var t=e.type,n=void 0===t?Bu.UNSIGNED_BYTE:t,r=e.width,i=e.height,o=e.flipY,a=void 0!==o&&o,s=e.format,u=void 0===s?Bu.RGBA:s,c=e.alignment,l=void 0===c?1:c,f=e.usage,h=void 0===f?Fl.SAMPLED:f,d=e.unorm,p=void 0!==d&&d,v=e.label,m=e.data;this.width=r,this.height=i;var g=KS.U8_RGBA_RT;if(n===Bu.UNSIGNED_BYTE&&u===Bu.RGBA)g=p?KS.U8_RGBA_NORM:KS.U8_RGBA_RT;else if(n===Bu.UNSIGNED_BYTE&&u===Bu.LUMINANCE)g=KS.U8_LUMINANCE;else if(n===Bu.FLOAT&&u===Bu.RGB)"WebGPU"===this.device.queryVendorInfo().platformString?(m&&(m=function(e,t){for(var n=e.length,r=n+Math.ceil(n/3),i=new Float32Array(r),o=0;o<r;o+=4)i[o]=e[o/4*3],i[o+1]=e[o/4*3+1],i[o+2]=e[o/4*3+2],i[o+3]=t;return i}(m,0)),g=KS.F32_RGBA):g=KS.F32_RGB;else if(n===Bu.FLOAT&&u===Bu.RGBA)g=KS.F32_RGBA;else{if(n!==Bu.FLOAT||u!==Bu.RED)throw new Error("create texture error, type: ".concat(n,", format: ").concat(u));g=KS.F32_R}this.texture=this.device.createTexture({format:g,width:r,height:i,usage:h===Fl.SAMPLED?GS.SAMPLED:GS.RENDER_TARGET,pixelStore:{unpackFlipY:a,packAlignment:l},mipLevelCount:1}),v&&this.device.setResourceName(this.texture,v),m&&this.texture.setImageData([m])}},{key:"get",value:function(){return this.texture}},{key:"update",value:function(e){var t=e.data;this.texture.setImageData([t])}},{key:"bind",value:function(){}},{key:"resize",value:function(e){var t=e.width,n=e.height;this.width===t&&this.height===n||this.destroy(),this.options.width=t,this.options.height=n,this.createTexture(this.options),this.isDestroy=!1}},{key:"getSize",value:function(){return[this.width,this.height]}},{key:"destroy",value:function(){var e;this.isDestroy||this.texture.destroyed||null==(e=this.texture)||e.destroy(),this.isDestroy=!0}}])}(),OM=function(){return c((function e(t,n){f(this,e),this.device=t,this.options=n,this.createColorRenderTarget(),this.createDepthRenderTarget()}),[{key:"createColorRenderTarget",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.options,n=t.width,r=t.height,i=t.color;i&&(wM(i)?(e&&i.resize({width:n,height:r}),this.colorTexture=i.get(),this.colorRenderTarget=this.device.createRenderTargetFromTexture(this.colorTexture),this.width=i.width,this.height=i.height):n&&r&&(this.colorTexture=this.device.createTexture({format:KS.U8_RGBA_RT,usage:GS.RENDER_TARGET,width:n,height:r}),this.colorRenderTarget=this.device.createRenderTargetFromTexture(this.colorTexture),this.width=n,this.height=r))}},{key:"createDepthRenderTarget",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.options,n=t.width,r=t.height,i=t.depth;i&&(wM(i)?(e&&i.resize({width:n,height:r}),this.depthTexture=i.get(),this.depthRenderTarget=this.device.createRenderTargetFromTexture(this.depthTexture),this.width=i.width,this.height=i.height):n&&r&&(this.depthTexture=this.device.createTexture({format:KS.D24_S8,usage:GS.RENDER_TARGET,width:n,height:r}),this.depthRenderTarget=this.device.createRenderTargetFromTexture(this.depthTexture),this.width=n,this.height=r))}},{key:"get",value:function(){return this.colorRenderTarget}},{key:"destroy",value:function(){var e,t;null==(e=this.colorRenderTarget)||e.destroy(),null==(t=this.depthRenderTarget)||t.destroy()}},{key:"resize",value:function(e){var t=e.width,n=e.height;this.width===t&&this.height===n||(this.destroy(),this.colorTexture.destroyed=!0,this.depthTexture.destroyed=!0,this.options.width=t,this.options.height=n,this.createColorRenderTarget(!0),this.createDepthRenderTarget(!0))}}])}(),kM=Object.defineProperty,NM=Object.defineProperties,IM=Object.getOwnPropertyDescriptors,PM=Object.getOwnPropertySymbols,DM=Object.prototype.hasOwnProperty,FM=Object.prototype.propertyIsEnumerable,BM=function(e,t,n){return t in e?kM(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n},UM=function(e,t){for(var n in t||(t={}))DM.call(t,n)&&BM(e,n,t[n]);if(PM){var r,i=y(PM(t));try{for(i.s();!(r=i.n()).done;){n=r.value;FM.call(t,n)&&BM(e,n,t[n])}}catch(o){i.e(o)}finally{i.f()}}return e},GM=Ni.isPlainObject,zM=Ni.isTypedArray,jM=function(){return c((function e(t,n,r){var i=this;f(this,e),this.device=t,this.options=n,this.service=r,this.destroyed=!1,this.uniforms={},this.vertexBuffers=[];var o=n.vs,a=n.fs,s=n.attributes,u=n.uniforms,c=n.count,l=n.elements,h=n.diagnosticDerivativeUniformityEnabled;this.options=n;var d=h?"":this.service.viewportOrigin===HS.UPPER_LEFT?"diagnostic(off,derivative_uniformity);":"";this.program=r.renderCache.createProgram({vertex:{glsl:o},fragment:{glsl:a,postprocess:function(e){return d+e}}}),u&&(this.uniforms=this.extractUniforms(u));var p=[],v=0;Object.keys(s).forEach((function(e){var t=s[e],n=t.get();i.vertexBuffers.push(n.get());var r=t.attribute,o=r.offset,a=void 0===o?0:o,u=r.stride,c=void 0===u?0:u,l=r.size,f=void 0===l?1:l,h=r.divisor,d=void 0===h?0:h,m=r.shaderLocation,g=void 0===m?0:m;p.push({arrayStride:c||4*f,stepMode:FS.VERTEX,attributes:[{format:iM[f],shaderLocation:g,offset:a,divisor:d}]}),v=n.size/f})),c||(this.options.count=v),l&&(this.indexBuffer=l.get());var m=r.renderCache.createInputLayout({vertexBufferDescriptors:p,indexBufferFormat:l?KS.U32_R:null,program:this.program});this.inputLayout=m,this.pipeline=this.createPipeline(n)}),[{key:"createPipeline",value:function(e,t){var n=e.primitive,r=void 0===n?Bu.TRIANGLES:n,i=e.depth,o=e.cull,a=e.blend,s=e.stencil,u=this.initDepthDrawParams({depth:i}),c=!(!u||!u.enable),l=this.initCullDrawParams({cull:o}),f=!(!l||!l.enable),h=this.getBlendDrawParams({blend:a}),d=!(!h||!h.enable),p=this.getStencilDrawParams({stencil:s}),v=!(!p||!p.enable);return this.device.createRenderPipeline({inputLayout:this.inputLayout,program:this.program,topology:rM[r],colorAttachmentFormats:[KS.U8_RGBA_RT],depthStencilAttachmentFormat:KS.D24_S8,megaStateDescriptor:{attachmentsState:[t?{channelWriteMask:zS.ALL,rgbBlendState:{blendMode:LS.ADD,blendSrcFactor:wS.ONE,blendDstFactor:wS.ZERO},alphaBlendState:{blendMode:LS.ADD,blendSrcFactor:wS.ONE,blendDstFactor:wS.ZERO}}:{channelWriteMask:v&&p.opFront.zpass===jS.REPLACE?zS.NONE:zS.ALL,rgbBlendState:{blendMode:d&&h.equation.rgb||LS.ADD,blendSrcFactor:d&&h.func.srcRGB||wS.SRC_ALPHA,blendDstFactor:d&&h.func.dstRGB||wS.ONE_MINUS_SRC_ALPHA},alphaBlendState:{blendMode:d&&h.equation.alpha||LS.ADD,blendSrcFactor:d&&h.func.srcAlpha||wS.ONE,blendDstFactor:d&&h.func.dstAlpha||wS.ONE}}],blendConstant:d?fT:void 0,depthWrite:c,depthCompare:c&&u.func||RS.LESS,cullMode:f&&l.face||MS.NONE,stencilWrite:v,stencilFront:{compare:v?p.func.cmp:RS.ALWAYS,passOp:p.opFront.zpass,failOp:p.opFront.fail,depthFailOp:p.opFront.zfail,mask:p.opFront.mask},stencilBack:{compare:v?p.func.cmp:RS.ALWAYS,passOp:p.opBack.zpass,failOp:p.opBack.fail,depthFailOp:p.opBack.zfail,mask:p.opBack.mask}}})}},{key:"updateAttributesAndElements",value:function(){}},{key:"updateAttributes",value:function(){}},{key:"addUniforms",value:function(e){this.uniforms=UM(UM({},this.uniforms),this.extractUniforms(e))}},{key:"draw",value:function(e,t){var n=this,r=UM(UM({},this.options),e),i=r.count,o=void 0===i?0:i,a=r.instances,s=r.elements,u=r.uniforms,c=void 0===u?{}:u,l=r.uniformBuffers,f=r.textures;this.uniforms=UM(UM({},this.uniforms),this.extractUniforms(c));var h=this.service,d=h.renderPass,p=h.currentFramebuffer,v=h.width,m=h.height,g=h.renderCache;this.pipeline=this.createPipeline(r,t);var _=this.service.device,y=_.swapChainHeight;if(_.swapChainHeight=(null==p?void 0:p.height)||m,d.setViewport(0,0,(null==p?void 0:p.width)||v,(null==p?void 0:p.height)||m),_.swapChainHeight=y,d.setPipeline(this.pipeline),d.setStencilReference(1),d.setVertexInput(this.inputLayout,this.vertexBuffers.map((function(e){return{buffer:e}})),s?{buffer:this.indexBuffer,offset:0}:null),l&&(this.bindings=g.createBindings({pipeline:this.pipeline,uniformBufferBindings:l.map((function(e,t){var n=e;return{binding:t,buffer:n.get(),size:n.size}})),samplerBindings:null==f?void 0:f.map((function(e){return{texture:e.texture,sampler:e.sampler}}))})),this.bindings&&(d.setBindings(this.bindings),Object.keys(this.uniforms).forEach((function(e){var t=n.uniforms[e];t instanceof LM?n.uniforms[e]=t.get():t instanceof OM&&(n.uniforms[e]=t.get().texture)})),this.program.setUniformsLegacy(this.uniforms)),s){var E=s.count;0===E?d.draw(o,a):d.drawIndexed(E,a)}else d.draw(o,a)}},{key:"destroy",value:function(){var e,t,n;this.program.destroy(),null==(e=this.vertexBuffers)||e.forEach((function(e){return e.destroy()})),null==(t=this.indexBuffer)||t.destroy(),null==(n=this.bindings)||n.destroy(),this.inputLayout.destroy(),this.pipeline.destroy(),this.destroyed=!0}},{key:"initDepthDrawParams",value:function(e){var t=e.depth;if(t)return{enable:void 0===t.enable||!!t.enable,mask:void 0===t.mask||!!t.mask,func:sM[t.func||Bu.LESS],range:t.range||[0,1]}}},{key:"getBlendDrawParams",value:function(e){var t=e.blend||{},n=t.enable,r=t.func,i=t.equation,o=t.color,a=void 0===o?[0,0,0,0]:o;return{enable:!!n,func:{srcRGB:lM[r&&r.srcRGB||Bu.SRC_ALPHA],srcAlpha:lM[r&&r.srcAlpha||Bu.SRC_ALPHA],dstRGB:lM[r&&r.dstRGB||Bu.ONE_MINUS_SRC_ALPHA],dstAlpha:lM[r&&r.dstAlpha||Bu.ONE_MINUS_SRC_ALPHA]},equation:{rgb:cM[i&&i.rgb||Bu.FUNC_ADD],alpha:cM[i&&i.alpha||Bu.FUNC_ADD]},color:a}}},{key:"getStencilDrawParams",value:function(e){var t,n,r=e.stencil||{},i=r.enable,o=r.mask,a=void 0===o?4294967295:o,s=r.func,u=void 0===s?{cmp:Bu.ALWAYS,ref:0,mask:4294967295}:s,c=r.opFront,l=void 0===c?{fail:Bu.KEEP,zfail:Bu.KEEP,zpass:Bu.KEEP}:c,f=r.opBack,h=void 0===f?{fail:Bu.KEEP,zfail:Bu.KEEP,zpass:Bu.KEEP}:f;return{enable:!!i,mask:a,func:(t=UM({},u),n={cmp:hM[u.cmp]},NM(t,IM(n))),opFront:{fail:fM[l.fail],zfail:fM[l.zfail],zpass:fM[l.zpass],mask:u.mask},opBack:{fail:fM[h.fail],zfail:fM[h.zfail],zpass:fM[h.zpass],mask:u.mask}}}},{key:"initCullDrawParams",value:function(e){var t=e.cull;if(t){var n=t.enable,r=t.face,i=void 0===r?Bu.BACK:r;return{enable:!!n,face:uM[i]}}}},{key:"extractUniforms",value:function(e){var t=this,n={};return Object.keys(e).forEach((function(r){t.extractUniformsRecursively(r,e[r],n,"")})),n}},{key:"extractUniformsRecursively",value:function(e,t,n,r){var i=this;null===t||"number"==typeof t||"boolean"==typeof t||Array.isArray(t)&&"number"==typeof t[0]||zM(t)||""===t||"resize"in t?n["".concat(r&&r+".").concat(e)]=t:(GM(t)&&Object.keys(t).forEach((function(o){i.extractUniformsRecursively(o,t[o],n,"".concat(r&&r+".").concat(e))})),Array.isArray(t)&&t.forEach((function(t,o){Object.keys(t).forEach((function(a){i.extractUniformsRecursively(a,t[a],n,"".concat(r&&r+".").concat(e,"[").concat(o,"]"))}))})))}}])}();function VM(e){return"undefined"!=typeof WebGL2RenderingContext&&e instanceof WebGL2RenderingContext||Boolean(e&&2===e._version)}var HM=function(e,t,n){return new Promise((function(r,i){var o=function(e){try{s(n.next(e))}catch(t){i(t)}},a=function(e){try{s(n.throw(e))}catch(t){i(t)}},s=function(e){return e.done?r(e.value):Promise.resolve(e.value).then(o,a)};s((n=n.apply(e,t)).next())}))},XM=Ni.isUndefined,WM=function(){return c((function e(){var t=this;f(this,e),this.uniformBuffers=[],this.queryVerdorInfo=function(){return t.device.queryVendorInfo().platformString},this.createModel=function(e){return new jM(t.device,e,t)},this.createAttribute=function(e){return new tM(t.device,e)},this.createBuffer=function(e){return new vM(t.device,e)},this.createElements=function(e){return new MM(t.device,e)},this.createTexture2D=function(e){return new LM(t.device,e)},this.createFramebuffer=function(e){return new OM(t.device,e)},this.useFramebuffer=function(e,n){t.currentFramebuffer=e,t.beginFrame(),n(),t.endFrame(),t.currentFramebuffer=null},this.useFramebufferAsync=function(e,n){return HM(t,null,i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.currentFramebuffer=e,this.preRenderPass=this.renderPass,this.beginFrame(),t.next=5,n();case 5:this.endFrame(),this.currentFramebuffer=null,this.renderPass=this.preRenderPass;case 8:case"end":return t.stop()}}),t,this)})))},this.clear=function(e){var n=e.color,r=e.depth,i=e.stencil,o=e.framebuffer,a=void 0===o?null:o;if(a)a.clearOptions={color:n,depth:r,stencil:i};else{var s=t.queryVerdorInfo();if("WebGL1"===s){var u=t.getGLContext();XM(i)?XM(r)||(u.clearDepth(r),u.clear(u.DEPTH_BUFFER_BIT)):(u.clearStencil(i),u.clear(u.STENCIL_BUFFER_BIT))}else if("WebGL2"===s){var c=t.getGLContext();XM(i)?XM(r)||c.clearBufferfv(c.DEPTH,0,[r]):c.clearBufferiv(c.STENCIL,0,[i])}}},this.viewport=function(e){var n=e.width,r=e.height;t.swapChain.configureSwapChain(n,r),t.createMainColorDepthRT(n,r),t.width=n,t.height=r},this.readPixels=function(e){var n=e.framebuffer,r=e.x,i=e.y,o=e.width,a=e.height,s=t.device.createReadback(),u=n.colorTexture,c=s.readTextureSync(u,r,t.viewportOrigin===HS.LOWER_LEFT?i:t.height-i,o,a,new Uint8Array(o*a*4));return s.destroy(),c},this.readPixelsAsync=function(e){return HM(t,null,i().mark((function t(){var n,r,o,a,s,u,c,l,f,h;return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return n=e.framebuffer,r=e.x,o=e.y,a=e.width,s=e.height,u=this.device.createReadback(),c=n.colorTexture,t.next=5,u.readTexture(c,r,this.viewportOrigin===HS.LOWER_LEFT?o:this.height-o,a,s,new Uint8Array(a*s*4));case 5:if(l=t.sent,this.viewportOrigin!==HS.LOWER_LEFT)for(f=0;f<l.length;f+=4)h=l[f],l[f]=l[f+2],l[f+2]=h;return u.destroy(),t.abrupt("return",l);case 9:case"end":return t.stop()}}),t,this)})))},this.getViewportSize=function(){return{width:t.width,height:t.height}},this.getContainer=function(){var e;return null==(e=t.canvas)?void 0:e.parentElement},this.getCanvas=function(){return t.canvas},this.getGLContext=function(){return t.device.gl},this.destroy=function(){var e;t.canvas=null,null==(e=t.uniformBuffers)||e.forEach((function(e){e.destroy()})),t.device.destroy(),t.renderCache.destroy()}}),[{key:"init",value:function(e,t){return HM(this,null,i().mark((function n(){var r,o,a,s,u;return i().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return r=t.enableWebGPU,o=t.shaderCompilerPath,this.canvas=e,a=r?new eM({shaderCompilerPath:o}):new WR({targets:["webgl2","webgl1"],onContextLost:function(e){console.warn("context lost",e)},onContextCreationError:function(e){console.warn("context creation error",e)},onContextRestored:function(e){console.warn("context restored",e)}}),n.next=5,a.createSwapChain(e);case 5:(s=n.sent).configureSwapChain(e.width,e.height),this.device=s.getDevice(),this.swapChain=s,this.renderCache=new CM(this.device),this.currentFramebuffer=null,this.viewportOrigin=this.device.queryVendorInfo().viewportOrigin,u=this.device.gl,this.extensionObject={OES_texture_float:!VM(u)&&this.device.OES_texture_float},this.createMainColorDepthRT(e.width,e.height);case 15:case"end":return n.stop()}}),n,this)})))}},{key:"createMainColorDepthRT",value:function(e,t){this.mainColorRT&&this.mainColorRT.destroy(),this.mainDepthRT&&this.mainDepthRT.destroy(),this.mainColorRT=this.device.createRenderTargetFromTexture(this.device.createTexture({format:KS.U8_RGBA_RT,width:e,height:t,usage:GS.RENDER_TARGET})),this.mainDepthRT=this.device.createRenderTargetFromTexture(this.device.createTexture({format:KS.D24_S8,width:e,height:t,usage:GS.RENDER_TARGET}))}},{key:"beginFrame",value:function(){this.device.beginFrame();var e=this.currentFramebuffer,t=this.swapChain,n=this.mainColorRT,r=this.mainDepthRT,i=e?e.colorRenderTarget:n,o=e?null:t.getOnscreenTexture(),a=e?e.depthRenderTarget:r,s=(null==e?void 0:e.clearOptions)||{},u=s.color,c=void 0===u?[0,0,0,0]:u,l=s.depth,f=void 0===l?1:l,h=s.stencil,d=void 0===h?0:h,p=i?lT(255*c[0],255*c[1],255*c[2],c[3]):fT,v=a?f:void 0,m=a?d:void 0,g=this.device.createRenderPass({colorAttachment:[i],colorResolveTo:[o],colorClearColor:[p],colorStore:[!0],depthStencilAttachment:a,depthClearValue:v,stencilClearValue:m});this.renderPass=g}},{key:"endFrame",value:function(){this.device.submitPass(this.renderPass),this.device.endFrame()}},{key:"getPointSizeRange",value:function(){var e=this.device.gl;return e.getParameter(e.ALIASED_POINT_SIZE_RANGE)}},{key:"testExtension",value:function(e){return!!this.getGLContext().getExtension(e)}},{key:"setState",value:function(){}},{key:"setBaseState",value:function(){}},{key:"setCustomLayerDefaults",value:function(){}},{key:"setDirty",value:function(e){this.isDirty=e}},{key:"getDirty",value:function(){return this.isDirty}}])}(),YM={exports:{}};!function(e,t){e.exports=function(){var e=function(e){return e instanceof Uint8Array||e instanceof Uint16Array||e instanceof Uint32Array||e instanceof Int8Array||e instanceof Int16Array||e instanceof Int32Array||e instanceof Float32Array||e instanceof Float64Array||e instanceof Uint8ClampedArray},t=function(e,t){for(var n=Object.keys(t),r=0;r<n.length;++r)e[n[r]]=t[n[r]];return e},n="\n";function r(e){return"undefined"!=typeof atob?atob(e):"base64:"+e}function i(e){var t=new Error("(regl) "+e);throw console.error(t),t}function o(e,t){e||i(t)}function a(e){return e?": "+e:""}function u(e,t,n){e in t||i("unknown parameter ("+e+")"+a(n)+". possible values: "+Object.keys(t).join())}function c(t,n){e(t)||i("invalid parameter type"+a(n)+". must be a typed array")}function l(e,t){switch(t){case"number":return"number"==typeof e;case"object":return"object"===s(e);case"string":return"string"==typeof e;case"boolean":return"boolean"==typeof e;case"function":return"function"==typeof e;case"undefined":return void 0===e;case"symbol":return"symbol"===s(e)}}function f(e,t,n){l(e,t)||i("invalid parameter type"+a(n)+". expected "+t+", got "+s(e))}function h(e,t){e>=0&&(0|e)===e||i("invalid parameter type, ("+e+")"+a(t)+". must be a nonnegative integer")}function d(e,t,n){t.indexOf(e)<0&&i("invalid value"+a(n)+". must be one of: "+t)}var p=["gl","canvas","container","attributes","pixelRatio","extensions","optionalExtensions","profile","onDone"];function v(e){Object.keys(e).forEach((function(e){p.indexOf(e)<0&&i('invalid regl constructor argument "'+e+'". must be one of '+p)}))}function m(e,t){for(e+="";e.length<t;)e=" "+e;return e}function g(){this.name="unknown",this.lines=[],this.index={},this.hasErrors=!1}function _(e,t){this.number=e,this.line=t,this.errors=[]}function y(e,t,n){this.file=e,this.line=t,this.message=n}function E(){var e=new Error,t=(e.stack||e).toString(),n=/compileProcedure.*\n\s*at.*\((.*)\)/.exec(t);if(n)return n[1];var r=/compileProcedure.*\n\s*at\s+(.*)(\n|$)/.exec(t);return r?r[1]:"unknown"}function b(){var e=new Error,t=(e.stack||e).toString(),n=/at REGLCommand.*\n\s+at.*\((.*)\)/.exec(t);if(n)return n[1];var r=/at REGLCommand.*\n\s+at\s+(.*)\n/.exec(t);return r?r[1]:"unknown"}function A(e,t){var n=e.split("\n"),i=1,o=0,a={unknown:new g,0:new g};a.unknown.name=a[0].name=t||E(),a.unknown.lines.push(new _(0,""));for(var s=0;s<n.length;++s){var u=n[s],c=/^\s*#\s*(\w+)\s+(.+)\s*$/.exec(u);if(c)switch(c[1]){case"line":var l=/(\d+)(\s+\d+)?/.exec(c[2]);l&&(i=0|l[1],l[2]&&((o=0|l[2])in a||(a[o]=new g)));break;case"define":var f=/SHADER_NAME(_B64)?\s+(.*)$/.exec(c[2]);f&&(a[o].name=f[1]?r(f[2]):f[2])}a[o].lines.push(new _(i++,u))}return Object.keys(a).forEach((function(e){var t=a[e];t.lines.forEach((function(e){t.index[e.number]=e}))})),a}function x(e){var t=[];return e.split("\n").forEach((function(e){if(!(e.length<5)){var n=/^ERROR:\s+(\d+):(\d+):\s*(.*)$/.exec(e);n?t.push(new y(0|n[1],0|n[2],n[3].trim())):e.length>0&&t.push(new y("unknown",0,e))}})),t}function S(e,t){t.forEach((function(t){var n=e[t.file];if(n){var r=n.index[t.line];if(r)return r.errors.push(t),void(n.hasErrors=!0)}e.unknown.hasErrors=!0,e.unknown.lines[0].errors.push(t)}))}function T(e,t,r,i,a){if(!e.getShaderParameter(t,e.COMPILE_STATUS)){var s=e.getShaderInfoLog(t),u=i===e.FRAGMENT_SHADER?"fragment":"vertex";k(r,"string",u+" shader source must be a string",a);var c=A(r,a),l=x(s);S(c,l),Object.keys(c).forEach((function(e){var t=c[e];if(t.hasErrors){var r=[""],i=[""];o("file number "+e+": "+t.name+"\n","color:red;text-decoration:underline;font-weight:bold"),t.lines.forEach((function(e){if(e.errors.length>0){o(m(e.number,4)+"|  ","background-color:yellow; font-weight:bold"),o(e.line+n,"color:red; background-color:yellow; font-weight:bold");var t=0;e.errors.forEach((function(r){var i=r.message,a=/^\s*'(.*)'\s*:\s*(.*)$/.exec(i);if(a){var s=a[1];i=a[2],"assign"===s&&(s="="),t=Math.max(e.line.indexOf(s,t),0)}else t=0;o(m("| ",6)),o(m("^^^",t+3)+n,"font-weight:bold"),o(m("| ",6)),o(i+n,"font-weight:bold")})),o(m("| ",6)+n)}else o(m(e.number,4)+"|  "),o(e.line+n,"color:red")})),"undefined"==typeof document||window.chrome?console.log(r.join("")):(i[0]=r.join("%c"),console.log.apply(console,i))}function o(e,t){r.push(e),i.push(t||"")}})),o.raise("Error compiling "+u+" shader, "+c[0].name)}}function R(e,t,r,i,a){if(!e.getProgramParameter(t,e.LINK_STATUS)){var s=e.getProgramInfoLog(t),u=A(r,a),c='Error linking program with vertex shader, "'+A(i,a)[0].name+'", and fragment shader "'+u[0].name+'"';"undefined"!=typeof document?console.log("%c"+c+n+"%c"+s,"color:red;text-decoration:underline;font-weight:bold","color:red"):console.log(c+n+s),o.raise(c)}}function C(e){e._commandRef=E()}function M(e,t,n,r){function i(e){return e?r.id(e):0}function o(e,t){Object.keys(t).forEach((function(t){e[r.id(t)]=!0}))}C(e),e._fragId=i(e.static.frag),e._vertId=i(e.static.vert);var a=e._uniformSet={};o(a,t.static),o(a,t.dynamic);var s=e._attributeSet={};o(s,n.static),o(s,n.dynamic),e._hasCount="count"in e.static||"count"in e.dynamic||"elements"in e.static||"elements"in e.dynamic}function w(e,t){var n=b();i(e+" in command "+(t||E())+("unknown"===n?"":" called from "+n))}function L(e,t,n){e||w(t,n||E())}function O(e,t,n,r){e in t||w("unknown parameter ("+e+")"+a(n)+". possible values: "+Object.keys(t).join(),r||E())}function k(e,t,n,r){l(e,t)||w("invalid parameter type"+a(n)+". expected "+t+", got "+s(e),r||E())}function N(e){e()}function I(e,t,n){e.texture?d(e.texture._texture.internalformat,t,"unsupported texture format for attachment"):d(e.renderbuffer._renderbuffer.format,n,"unsupported renderbuffer format for attachment")}var P=33071,D=9728,F=9984,B=9985,U=9986,G=9987,z=5121,j=5122,V=5123,H=5124,X=5125,W=5126,Y=32819,Z=32820,q=33635,K=34042,Q=36193,$={};function J(e,t){return e===Z||e===Y||e===q?2:e===K?4:$[e]*t}function ee(e){return!(e&e-1||!e)}function te(e,t,n){var r,i=t.width,a=t.height,s=t.channels;o(i>0&&i<=n.maxTextureSize&&a>0&&a<=n.maxTextureSize,"invalid texture shape"),e.wrapS===P&&e.wrapT===P||o(ee(i)&&ee(a),"incompatible wrap mode for texture, both width and height must be power of 2"),1===t.mipmask?1!==i&&1!==a&&o(e.minFilter!==F&&e.minFilter!==U&&e.minFilter!==B&&e.minFilter!==G,"min filter requires mipmap"):(o(ee(i)&&ee(a),"texture must be a square power of 2 to support mipmapping"),o(t.mipmask===(i<<1)-1,"missing or incomplete mipmap data")),t.type===W&&(n.extensions.indexOf("oes_texture_float_linear")<0&&o(e.minFilter===D&&e.magFilter===D,"filter not supported, must enable oes_texture_float_linear"),o(!e.genMipmaps,"mipmap generation not supported with float textures"));var u=t.images;for(r=0;r<16;++r)if(u[r]){var c=i>>r,l=a>>r;o(t.mipmask&1<<r,"missing mipmap data");var f=u[r];if(o(f.width===c&&f.height===l,"invalid shape for mip images"),o(f.format===t.format&&f.internalformat===t.internalformat&&f.type===t.type,"incompatible type for mip image"),f.compressed);else if(f.data){var h=Math.ceil(J(f.type,s)*c/f.unpackAlignment)*f.unpackAlignment;o(f.data.byteLength===h*l,"invalid data for image, buffer size is inconsistent with image format")}else f.element||f.copy}else e.genMipmaps||o(!(t.mipmask&1<<r),"extra mipmap data");t.compressed&&o(!e.genMipmaps,"mipmap generation for compressed images not supported")}function ne(e,t,n,r){var i=e.width,a=e.height,s=e.channels;o(i>0&&i<=r.maxTextureSize&&a>0&&a<=r.maxTextureSize,"invalid texture shape"),o(i===a,"cube map must be square"),o(t.wrapS===P&&t.wrapT===P,"wrap mode not supported by cube map");for(var u=0;u<n.length;++u){var c=n[u];o(c.width===i&&c.height===a,"inconsistent cube map face shape"),t.genMipmaps&&(o(!c.compressed,"can not generate mipmap for compressed textures"),o(1===c.mipmask,"can not specify mipmaps and generate mipmaps"));for(var l=c.images,f=0;f<16;++f){var h=l[f];if(h){var d=i>>f,p=a>>f;o(c.mipmask&1<<f,"missing mipmap data"),o(h.width===d&&h.height===p,"invalid shape for mip images"),o(h.format===e.format&&h.internalformat===e.internalformat&&h.type===e.type,"incompatible type for mip image"),h.compressed||(h.data?o(h.data.byteLength===d*p*Math.max(J(h.type,s),h.unpackAlignment),"invalid data for image, buffer size is inconsistent with image format"):h.element||h.copy)}}}}$[5120]=$[z]=1,$[j]=$[V]=$[Q]=$[q]=$[Y]=$[Z]=2,$[H]=$[X]=$[W]=$[K]=4;var re=t(o,{optional:N,raise:i,commandRaise:w,command:L,parameter:u,commandParameter:O,constructor:v,type:f,commandType:k,isTypedArray:c,nni:h,oneOf:d,shaderError:T,linkError:R,callSite:b,saveCommandRef:C,saveDrawInfo:M,framebufferFormat:I,guessCommand:E,texture2D:te,textureCube:ne}),ie=0,oe=0;function ae(e,t){this.id=ie++,this.type=e,this.data=t}function se(e){return e.replace(/\\/g,"\\\\").replace(/"/g,'\\"')}function ue(e){if(0===e.length)return[];var t=e.charAt(0),n=e.charAt(e.length-1);if(e.length>1&&t===n&&('"'===t||"'"===t))return['"'+se(e.substr(1,e.length-2))+'"'];var r=/\[(false|true|null|\d+|'[^']*'|"[^"]*")\]/.exec(e);if(r)return ue(e.substr(0,r.index)).concat(ue(r[1])).concat(ue(e.substr(r.index+r[0].length)));var i=e.split(".");if(1===i.length)return['"'+se(e)+'"'];for(var o=[],a=0;a<i.length;++a)o=o.concat(ue(i[a]));return o}function ce(e){return"["+ue(e).join("][")+"]"}function le(e,t){return new ae(e,ce(t+""))}function fe(e){return"function"==typeof e&&!e._reglType||e instanceof ae}function he(e,t){return"function"==typeof e?new ae(oe,e):e}var de={DynamicVariable:ae,define:le,isDynamic:fe,unbox:he,accessor:ce},pe={next:"function"==typeof requestAnimationFrame?function(e){return requestAnimationFrame(e)}:function(e){return setTimeout(e,16)},cancel:"function"==typeof cancelAnimationFrame?function(e){return cancelAnimationFrame(e)}:clearTimeout},ve="undefined"!=typeof performance&&performance.now?function(){return performance.now()}:function(){return+new Date};function me(){var e={"":0},t=[""];return{id:function(n){var r=e[n];return r||(r=e[n]=t.length,t.push(n),r)},str:function(e){return t[e]}}}function ge(e,n,r){var i,o=document.createElement("canvas");function a(){var n=window.innerWidth,i=window.innerHeight;if(e!==document.body){var a=e.getBoundingClientRect();n=a.right-a.left,i=a.bottom-a.top}o.width=r*n,o.height=r*i,t(o.style,{width:n+"px",height:i+"px"})}function s(){i?i.disconnect():window.removeEventListener("resize",a),e.removeChild(o)}return t(o.style,{border:0,margin:0,padding:0,top:0,left:0}),e.appendChild(o),e===document.body&&(o.style.position="absolute",t(e.style,{margin:0,padding:0})),e!==document.body&&"function"==typeof ResizeObserver?(i=new ResizeObserver((function(){setTimeout(a)}))).observe(e):window.addEventListener("resize",a,!1),a(),{canvas:o,onDestroy:s}}function _e(e,t){function n(n){try{return e.getContext(n,t)}catch(r){return null}}return n("webgl")||n("experimental-webgl")||n("webgl-experimental")}function ye(e){return"string"==typeof e.nodeName&&"function"==typeof e.appendChild&&"function"==typeof e.getBoundingClientRect}function Ee(e){return"function"==typeof e.drawArrays||"function"==typeof e.drawElements}function be(e){return"string"==typeof e?e.split():(re(Array.isArray(e),"invalid extension array"),e)}function Ae(e){return"string"==typeof e?(re("undefined"!=typeof document,"not supported outside of DOM"),document.querySelector(e)):e}function xe(e){var t,n,r,i,o=e||{},a={},u=[],c=[],l="undefined"==typeof window?1:window.devicePixelRatio,f=!1,h=function(e){e&&re.raise(e)},d=function(){};if("string"==typeof o?(re("undefined"!=typeof document,"selector queries only supported in DOM enviroments"),t=document.querySelector(o),re(t,"invalid query string for element")):"object"===s(o)?ye(o)?t=o:Ee(o)?r=(i=o).canvas:(re.constructor(o),"gl"in o?i=o.gl:"canvas"in o?r=Ae(o.canvas):"container"in o&&(n=Ae(o.container)),"attributes"in o&&(a=o.attributes,re.type(a,"object","invalid context attributes")),"extensions"in o&&(u=be(o.extensions)),"optionalExtensions"in o&&(c=be(o.optionalExtensions)),"onDone"in o&&(re.type(o.onDone,"function","invalid or missing onDone callback"),h=o.onDone),"profile"in o&&(f=!!o.profile),"pixelRatio"in o&&(l=+o.pixelRatio,re(l>0,"invalid pixel ratio"))):re.raise("invalid arguments to regl"),t&&("canvas"===t.nodeName.toLowerCase()?r=t:n=t),!i){if(!r){re("undefined"!=typeof document,"must manually specify webgl context outside of DOM environments");var p=ge(n||document.body,h,l);if(!p)return null;r=p.canvas,d=p.onDestroy}void 0===a.premultipliedAlpha&&(a.premultipliedAlpha=!0),i=_e(r,a)}return i?{gl:i,canvas:r,container:n,extensions:u,optionalExtensions:c,pixelRatio:l,profile:f,onDone:h,onDestroy:d}:(d(),h("webgl not supported, try upgrading your browser or graphics drivers http://get.webgl.org"),null)}function Se(e,t){var n={};function r(t){re.type(t,"string","extension name must be string");var r,i=t.toLowerCase();try{r=n[i]=e.getExtension(i)}catch(o){}return!!r}for(var i=0;i<t.extensions.length;++i){var o=t.extensions[i];if(!r(o))return t.onDestroy(),t.onDone('"'+o+'" extension is not supported by the current WebGL context, try upgrading your system or a different browser'),null}return t.optionalExtensions.forEach(r),{extensions:n,restore:function(){Object.keys(n).forEach((function(e){if(n[e]&&!r(e))throw new Error("(regl): error restoring extension "+e)}))}}}function Te(e,t){for(var n=Array(e),r=0;r<e;++r)n[r]=t(r);return n}var Re=5120,Ce=5121,Me=5122,we=5123,Le=5124,Oe=5125,ke=5126;function Ne(e){for(var t=16;t<=1<<28;t*=16)if(e<=t)return t;return 0}function Ie(e){var t,n;return t=(e>65535)<<4,t|=n=((e>>>=t)>255)<<3,t|=n=((e>>>=n)>15)<<2,(t|=n=((e>>>=n)>3)<<1)|(e>>>=n)>>1}function Pe(){var e=Te(8,(function(){return[]}));function t(t){var n=Ne(t),r=e[Ie(n)>>2];return r.length>0?r.pop():new ArrayBuffer(n)}function n(t){e[Ie(t.byteLength)>>2].push(t)}function r(e,n){var r=null;switch(e){case Re:r=new Int8Array(t(n),0,n);break;case Ce:r=new Uint8Array(t(n),0,n);break;case Me:r=new Int16Array(t(2*n),0,n);break;case we:r=new Uint16Array(t(2*n),0,n);break;case Le:r=new Int32Array(t(4*n),0,n);break;case Oe:r=new Uint32Array(t(4*n),0,n);break;case ke:r=new Float32Array(t(4*n),0,n);break;default:return null}return r.length!==n?r.subarray(0,n):r}function i(e){n(e.buffer)}return{alloc:t,free:n,allocType:r,freeType:i}}var De=Pe();De.zero=Pe();var Fe=3408,Be=3410,Ue=3411,Ge=3412,ze=3413,je=3414,Ve=3415,He=33901,Xe=33902,We=3379,Ye=3386,Ze=34921,qe=36347,Ke=36348,Qe=35661,$e=35660,Je=34930,et=36349,tt=34076,nt=34024,rt=7936,it=7937,ot=7938,at=35724,st=34047,ut=36063,ct=34852,lt=3553,ft=34067,ht=34069,dt=33984,pt=6408,vt=5126,mt=5121,gt=36160,_t=36053,yt=36064,Et=16384,bt=function(e,t){var n=1;t.ext_texture_filter_anisotropic&&(n=e.getParameter(st));var r=1,i=1;t.webgl_draw_buffers&&(r=e.getParameter(ct),i=e.getParameter(ut));var o=!!t.oes_texture_float;if(o){var a=e.createTexture();e.bindTexture(lt,a),e.texImage2D(lt,0,pt,1,1,0,pt,vt,null);var s=e.createFramebuffer();if(e.bindFramebuffer(gt,s),e.framebufferTexture2D(gt,yt,lt,a,0),e.bindTexture(lt,null),e.checkFramebufferStatus(gt)!==_t)o=!1;else{e.viewport(0,0,1,1),e.clearColor(1,0,0,1),e.clear(Et);var u=De.allocType(vt,4);e.readPixels(0,0,1,1,pt,vt,u),e.getError()?o=!1:(e.deleteFramebuffer(s),e.deleteTexture(a),o=1===u[0]),De.freeType(u)}}var c=!0;if("undefined"==typeof navigator||!(/MSIE/.test(navigator.userAgent)||/Trident\//.test(navigator.appVersion)||/Edge/.test(navigator.userAgent))){var l=e.createTexture(),f=De.allocType(mt,36);e.activeTexture(dt),e.bindTexture(ft,l),e.texImage2D(ht,0,pt,3,3,0,pt,mt,f),De.freeType(f),e.bindTexture(ft,null),e.deleteTexture(l),c=!e.getError()}return{colorBits:[e.getParameter(Be),e.getParameter(Ue),e.getParameter(Ge),e.getParameter(ze)],depthBits:e.getParameter(je),stencilBits:e.getParameter(Ve),subpixelBits:e.getParameter(Fe),extensions:Object.keys(t).filter((function(e){return!!t[e]})),maxAnisotropic:n,maxDrawbuffers:r,maxColorAttachments:i,pointSizeDims:e.getParameter(He),lineWidthDims:e.getParameter(Xe),maxViewportDims:e.getParameter(Ye),maxCombinedTextureUnits:e.getParameter(Qe),maxCubeMapSize:e.getParameter(tt),maxRenderbufferSize:e.getParameter(nt),maxTextureUnits:e.getParameter(Je),maxTextureSize:e.getParameter(We),maxAttributes:e.getParameter(Ze),maxVertexUniforms:e.getParameter(qe),maxVertexTextureUnits:e.getParameter($e),maxVaryingVectors:e.getParameter(Ke),maxFragmentUniforms:e.getParameter(et),glsl:e.getParameter(at),renderer:e.getParameter(it),vendor:e.getParameter(rt),version:e.getParameter(ot),readFloat:o,npotTextureCube:c}};function At(t){return!!t&&"object"===s(t)&&Array.isArray(t.shape)&&Array.isArray(t.stride)&&"number"==typeof t.offset&&t.shape.length===t.stride.length&&(Array.isArray(t.data)||e(t.data))}var xt=function(e){return Object.keys(e).map((function(t){return e[t]}))},St={shape:Lt,flatten:wt};function Tt(e,t,n){for(var r=0;r<t;++r)n[r]=e[r]}function Rt(e,t,n,r){for(var i=0,o=0;o<t;++o)for(var a=e[o],s=0;s<n;++s)r[i++]=a[s]}function Ct(e,t,n,r,i,o){for(var a=o,s=0;s<t;++s)for(var u=e[s],c=0;c<n;++c)for(var l=u[c],f=0;f<r;++f)i[a++]=l[f]}function Mt(e,t,n,r,i){for(var o=1,a=n+1;a<t.length;++a)o*=t[a];var s=t[n];if(t.length-n==4){var u=t[n+1],c=t[n+2],l=t[n+3];for(a=0;a<s;++a)Ct(e[a],u,c,l,r,i),i+=o}else for(a=0;a<s;++a)Mt(e[a],t,n+1,r,i),i+=o}function wt(e,t,n,r){var i=1;if(t.length)for(var o=0;o<t.length;++o)i*=t[o];else i=0;var a=r||De.allocType(n,i);switch(t.length){case 0:break;case 1:Tt(e,t[0],a);break;case 2:Rt(e,t[0],t[1],a);break;case 3:Ct(e,t[0],t[1],t[2],a,0);break;default:Mt(e,t,0,a,0)}return a}function Lt(e){for(var t=[],n=e;n.length;n=n[0])t.push(n.length);return t}var Ot={"[object Int8Array]":5120,"[object Int16Array]":5122,"[object Int32Array]":5124,"[object Uint8Array]":5121,"[object Uint8ClampedArray]":5121,"[object Uint16Array]":5123,"[object Uint32Array]":5125,"[object Float32Array]":5126,"[object Float64Array]":5121,"[object ArrayBuffer]":5121},kt={int8:5120,int16:5122,int32:5124,uint8:5121,uint16:5123,uint32:5125,float:5126,float32:5126},Nt={dynamic:35048,stream:35040,static:35044},It=St.flatten,Pt=St.shape,Dt=35044,Ft=35040,Bt=5121,Ut=5126,Gt=[];function zt(e){return 0|Ot[Object.prototype.toString.call(e)]}function jt(e,t){for(var n=0;n<t.length;++n)e[n]=t[n]}function Vt(e,t,n,r,i,o,a){for(var s=0,u=0;u<n;++u)for(var c=0;c<r;++c)e[s++]=t[i*u+o*c+a]}function Ht(t,n,r,i){var o=0,a={};function s(e){this.id=o++,this.buffer=t.createBuffer(),this.type=e,this.usage=Dt,this.byteLength=0,this.dimension=1,this.dtype=Bt,this.persistentData=null,r.profile&&(this.stats={size:0})}s.prototype.bind=function(){t.bindBuffer(this.type,this.buffer)},s.prototype.destroy=function(){d(this)};var u=[];function c(e,t){var n=u.pop();return n||(n=new s(e)),n.bind(),h(n,t,Ft,0,1,!1),n}function l(e){u.push(e)}function f(e,n,r){e.byteLength=n.byteLength,t.bufferData(e.type,n,r)}function h(t,n,r,i,o,a){var s,u;if(t.usage=r,Array.isArray(n)){if(t.dtype=i||Ut,n.length>0)if(Array.isArray(n[0])){s=Pt(n);for(var c=1,l=1;l<s.length;++l)c*=s[l];t.dimension=c,f(t,u=It(n,s,t.dtype),r),a?t.persistentData=u:De.freeType(u)}else if("number"==typeof n[0]){t.dimension=o;var h=De.allocType(t.dtype,n.length);jt(h,n),f(t,h,r),a?t.persistentData=h:De.freeType(h)}else e(n[0])?(t.dimension=n[0].length,t.dtype=i||zt(n[0])||Ut,f(t,u=It(n,[n.length,n[0].length],t.dtype),r),a?t.persistentData=u:De.freeType(u)):re.raise("invalid buffer data")}else if(e(n))t.dtype=i||zt(n),t.dimension=o,f(t,n,r),a&&(t.persistentData=new Uint8Array(new Uint8Array(n.buffer)));else if(At(n)){s=n.shape;var d=n.stride,p=n.offset,v=0,m=0,g=0,_=0;1===s.length?(v=s[0],m=1,g=d[0],_=0):2===s.length?(v=s[0],m=s[1],g=d[0],_=d[1]):re.raise("invalid shape"),t.dtype=i||zt(n.data)||Ut,t.dimension=m;var y=De.allocType(t.dtype,v*m);Vt(y,n.data,v,m,g,_,p),f(t,y,r),a?t.persistentData=y:De.freeType(y)}else n instanceof ArrayBuffer?(t.dtype=Bt,t.dimension=o,f(t,n,r),a&&(t.persistentData=new Uint8Array(new Uint8Array(n)))):re.raise("invalid buffer data")}function d(e){n.bufferCount--,i(e);var r=e.buffer;re(r,"buffer must not be deleted already"),t.deleteBuffer(r),e.buffer=null,delete a[e.id]}function p(i,o,u,c){n.bufferCount++;var l=new s(o);function f(n){var i=Dt,o=null,a=0,s=0,u=1;return Array.isArray(n)||e(n)||At(n)||n instanceof ArrayBuffer?o=n:"number"==typeof n?a=0|n:n&&(re.type(n,"object","buffer arguments must be an object, a number or an array"),"data"in n&&(re(null===o||Array.isArray(o)||e(o)||At(o),"invalid data for buffer"),o=n.data),"usage"in n&&(re.parameter(n.usage,Nt,"invalid buffer usage"),i=Nt[n.usage]),"type"in n&&(re.parameter(n.type,kt,"invalid buffer type"),s=kt[n.type]),"dimension"in n&&(re.type(n.dimension,"number","invalid dimension"),u=0|n.dimension),"length"in n&&(re.nni(a,"buffer length must be a nonnegative integer"),a=0|n.length)),l.bind(),o?h(l,o,i,s,u,c):(a&&t.bufferData(l.type,a,i),l.dtype=s||Bt,l.usage=i,l.dimension=u,l.byteLength=a),r.profile&&(l.stats.size=l.byteLength*Gt[l.dtype]),f}function p(e,n){re(n+e.byteLength<=l.byteLength,"invalid buffer subdata call, buffer is too small.  Can't write data of size "+e.byteLength+" starting from offset "+n+" to a buffer of size "+l.byteLength),t.bufferSubData(l.type,n,e)}function v(t,n){var r,i=0|(n||0);if(l.bind(),e(t)||t instanceof ArrayBuffer)p(t,i);else if(Array.isArray(t)){if(t.length>0)if("number"==typeof t[0]){var o=De.allocType(l.dtype,t.length);jt(o,t),p(o,i),De.freeType(o)}else if(Array.isArray(t[0])||e(t[0])){r=Pt(t);var a=It(t,r,l.dtype);p(a,i),De.freeType(a)}else re.raise("invalid buffer data")}else if(At(t)){r=t.shape;var s=t.stride,u=0,c=0,h=0,d=0;1===r.length?(u=r[0],c=1,h=s[0],d=0):2===r.length?(u=r[0],c=r[1],h=s[0],d=s[1]):re.raise("invalid shape");var v=Array.isArray(t.data)?l.dtype:zt(t.data),m=De.allocType(v,u*c);Vt(m,t.data,u,c,h,d,t.offset),p(m,i),De.freeType(m)}else re.raise("invalid data for buffer subdata");return f}return a[l.id]=l,u||f(i),f._reglType="buffer",f._buffer=l,f.subdata=v,r.profile&&(f.stats=l.stats),f.destroy=function(){d(l)},f}function v(){xt(a).forEach((function(e){e.buffer=t.createBuffer(),t.bindBuffer(e.type,e.buffer),t.bufferData(e.type,e.persistentData||e.byteLength,e.usage)}))}return r.profile&&(n.getTotalBufferSize=function(){var e=0;return Object.keys(a).forEach((function(t){e+=a[t].stats.size})),e}),{create:p,createStream:c,destroyStream:l,clear:function(){xt(a).forEach(d),u.forEach(d)},getBuffer:function(e){return e&&e._buffer instanceof s?e._buffer:null},restore:v,_initBuffer:h}}Gt[5120]=1,Gt[5122]=2,Gt[5124]=4,Gt[5121]=1,Gt[5123]=2,Gt[5125]=4,Gt[5126]=4;var Xt=4,Wt={points:0,point:0,lines:1,line:1,triangles:4,triangle:Xt,"line loop":2,"line strip":3,"triangle strip":5,"triangle fan":6},Yt=0,Zt=1,qt=4,Kt=5120,Qt=5121,$t=5122,Jt=5123,en=5124,tn=5125,nn=34963,rn=35040,on=35044;function an(t,n,r,i){var o={},a=0,s={uint8:Qt,uint16:Jt};function u(e){this.id=a++,o[this.id]=this,this.buffer=e,this.primType=qt,this.vertCount=0,this.type=0}n.oes_element_index_uint&&(s.uint32=tn),u.prototype.bind=function(){this.buffer.bind()};var c=[];function l(e){var t=c.pop();return t||(t=new u(r.create(null,nn,!0,!1)._buffer)),h(t,e,rn,-1,-1,0,0),t}function f(e){c.push(e)}function h(i,o,a,s,u,c,l){var f;if(i.buffer.bind(),o){var h=l;l||e(o)&&(!At(o)||e(o.data))||(h=n.oes_element_index_uint?tn:Jt),r._initBuffer(i.buffer,o,a,h,3)}else t.bufferData(nn,c,a),i.buffer.dtype=f||Qt,i.buffer.usage=a,i.buffer.dimension=3,i.buffer.byteLength=c;if(f=l,!l){switch(i.buffer.dtype){case Qt:case Kt:f=Qt;break;case Jt:case $t:f=Jt;break;case tn:case en:f=tn;break;default:re.raise("unsupported type for element array")}i.buffer.dtype=f}i.type=f,re(f!==tn||!!n.oes_element_index_uint,"32 bit element buffers not supported, enable oes_element_index_uint first");var d=u;d<0&&(d=i.buffer.byteLength,f===Jt?d>>=1:f===tn&&(d>>=2)),i.vertCount=d;var p=s;if(s<0){p=qt;var v=i.buffer.dimension;1===v&&(p=Yt),2===v&&(p=Zt),3===v&&(p=qt)}i.primType=p}function d(e){i.elementsCount--,re(null!==e.buffer,"must not double destroy elements"),delete o[e.id],e.buffer.destroy(),e.buffer=null}function p(t,n){var o=r.create(null,nn,!0),a=new u(o._buffer);function c(t){if(t)if("number"==typeof t)o(t),a.primType=qt,a.vertCount=0|t,a.type=Qt;else{var n=null,r=on,i=-1,u=-1,l=0,f=0;Array.isArray(t)||e(t)||At(t)?n=t:(re.type(t,"object","invalid arguments for elements"),"data"in t&&(n=t.data,re(Array.isArray(n)||e(n)||At(n),"invalid data for element buffer")),"usage"in t&&(re.parameter(t.usage,Nt,"invalid element buffer usage"),r=Nt[t.usage]),"primitive"in t&&(re.parameter(t.primitive,Wt,"invalid element buffer primitive"),i=Wt[t.primitive]),"count"in t&&(re("number"==typeof t.count&&t.count>=0,"invalid vertex count for elements"),u=0|t.count),"type"in t&&(re.parameter(t.type,s,"invalid buffer type"),f=s[t.type]),"length"in t?l=0|t.length:(l=u,f===Jt||f===$t?l*=2:f!==tn&&f!==en||(l*=4))),h(a,n,r,i,u,l,f)}else o(),a.primType=qt,a.vertCount=0,a.type=Qt;return c}return i.elementsCount++,c(t),c._reglType="elements",c._elements=a,c.subdata=function(e,t){return o.subdata(e,t),c},c.destroy=function(){d(a)},c}return{create:p,createStream:l,destroyStream:f,getElements:function(e){return"function"==typeof e&&e._elements instanceof u?e._elements:null},clear:function(){xt(o).forEach(d)}}}var sn=new Float32Array(1),un=new Uint32Array(sn.buffer),cn=5123;function ln(e){for(var t=De.allocType(cn,e.length),n=0;n<e.length;++n)if(isNaN(e[n]))t[n]=65535;else if(e[n]===1/0)t[n]=31744;else if(e[n]===-1/0)t[n]=64512;else{sn[0]=e[n];var r=un[0],i=r>>>31<<15,o=(r<<1>>>24)-127,a=r>>13&1023;if(o<-24)t[n]=i;else if(o<-14){var s=-14-o;t[n]=i+(a+1024>>s)}else t[n]=o>15?i+31744:i+(o+15<<10)+a}return t}function fn(t){return Array.isArray(t)||e(t)}var hn=function(e){return!(e&e-1||!e)},dn=34467,pn=3553,vn=34067,mn=34069,gn=6408,_n=6406,yn=6407,En=6409,bn=6410,An=32854,xn=32855,Sn=36194,Tn=32819,Rn=32820,Cn=33635,Mn=34042,wn=6402,Ln=34041,On=35904,kn=35906,Nn=36193,In=33776,Pn=33777,Dn=33778,Fn=33779,Bn=35986,Un=35987,Gn=34798,zn=35840,jn=35841,Vn=35842,Hn=35843,Xn=36196,Wn=5121,Yn=5123,Zn=5125,qn=5126,Kn=10242,Qn=10243,$n=10497,Jn=33071,er=33648,tr=10240,nr=10241,rr=9728,ir=9729,or=9984,ar=9985,sr=9986,ur=9987,cr=33170,lr=4352,fr=4353,hr=4354,dr=34046,pr=3317,vr=37440,mr=37441,gr=37443,_r=37444,yr=33984,Er=[or,sr,ar,ur],br=[0,En,bn,yn,gn],Ar={};function xr(e){return"[object "+e+"]"}Ar[En]=Ar[_n]=Ar[wn]=1,Ar[Ln]=Ar[bn]=2,Ar[yn]=Ar[On]=3,Ar[gn]=Ar[kn]=4;var Sr=xr("HTMLCanvasElement"),Tr=xr("OffscreenCanvas"),Rr=xr("CanvasRenderingContext2D"),Cr=xr("ImageBitmap"),Mr=xr("HTMLImageElement"),wr=xr("HTMLVideoElement"),Lr=Object.keys(Ot).concat([Sr,Tr,Rr,Cr,Mr,wr]),Or=[];Or[Wn]=1,Or[qn]=4,Or[Nn]=2,Or[Yn]=2,Or[Zn]=4;var kr=[];function Nr(e){return Array.isArray(e)&&(0===e.length||"number"==typeof e[0])}function Ir(e){return!!Array.isArray(e)&&!(0===e.length||!fn(e[0]))}function Pr(e){return Object.prototype.toString.call(e)}function Dr(e){return Pr(e)===Sr}function Fr(e){return Pr(e)===Tr}function Br(e){return Pr(e)===Rr}function Ur(e){return Pr(e)===Cr}function Gr(e){return Pr(e)===Mr}function zr(e){return Pr(e)===wr}function jr(e){if(!e)return!1;var t=Pr(e);return Lr.indexOf(t)>=0||Nr(e)||Ir(e)||At(e)}function Vr(e){return 0|Ot[Object.prototype.toString.call(e)]}function Hr(e,t){var n=t.length;switch(e.type){case Wn:case Yn:case Zn:case qn:var r=De.allocType(e.type,n);r.set(t),e.data=r;break;case Nn:e.data=ln(t);break;default:re.raise("unsupported texture type, must specify a typed array")}}function Xr(e,t){return De.allocType(e.type===Nn?qn:e.type,t)}function Wr(e,t){e.type===Nn?(e.data=ln(t),De.freeType(t)):e.data=t}function Yr(e,t,n,r,i,o){for(var a=e.width,s=e.height,u=e.channels,c=Xr(e,a*s*u),l=0,f=0;f<s;++f)for(var h=0;h<a;++h)for(var d=0;d<u;++d)c[l++]=t[n*h+r*f+i*d+o];Wr(e,c)}function Zr(e,t,n,r,i,o){var a;if(a=void 0!==kr[e]?kr[e]:Ar[e]*Or[t],o&&(a*=6),i){for(var s=0,u=n;u>=1;)s+=a*u*u,u/=2;return s}return a*n*r}function qr(n,r,i,o,a,u,c){var l={"don't care":lr,"dont care":lr,nice:hr,fast:fr},f={repeat:$n,clamp:Jn,mirror:er},h={nearest:rr,linear:ir},d=t({mipmap:ur,"nearest mipmap nearest":or,"linear mipmap nearest":ar,"nearest mipmap linear":sr,"linear mipmap linear":ur},h),p={none:0,browser:_r},v={uint8:Wn,rgba4:Tn,rgb565:Cn,"rgb5 a1":Rn},m={alpha:_n,luminance:En,"luminance alpha":bn,rgb:yn,rgba:gn,rgba4:An,"rgb5 a1":xn,rgb565:Sn},g={};r.ext_srgb&&(m.srgb=On,m.srgba=kn),r.oes_texture_float&&(v.float32=v.float=qn),r.oes_texture_half_float&&(v.float16=v["half float"]=Nn),r.webgl_depth_texture&&(t(m,{depth:wn,"depth stencil":Ln}),t(v,{uint16:Yn,uint32:Zn,"depth stencil":Mn})),r.webgl_compressed_texture_s3tc&&t(g,{"rgb s3tc dxt1":In,"rgba s3tc dxt1":Pn,"rgba s3tc dxt3":Dn,"rgba s3tc dxt5":Fn}),r.webgl_compressed_texture_atc&&t(g,{"rgb atc":Bn,"rgba atc explicit alpha":Un,"rgba atc interpolated alpha":Gn}),r.webgl_compressed_texture_pvrtc&&t(g,{"rgb pvrtc 4bppv1":zn,"rgb pvrtc 2bppv1":jn,"rgba pvrtc 4bppv1":Vn,"rgba pvrtc 2bppv1":Hn}),r.webgl_compressed_texture_etc1&&(g["rgb etc1"]=Xn);var _=Array.prototype.slice.call(n.getParameter(dn));Object.keys(g).forEach((function(e){var t=g[e];_.indexOf(t)>=0&&(m[e]=t)}));var y=Object.keys(m);i.textureFormats=y;var E=[];Object.keys(m).forEach((function(e){var t=m[e];E[t]=e}));var b=[];Object.keys(v).forEach((function(e){var t=v[e];b[t]=e}));var A=[];Object.keys(h).forEach((function(e){var t=h[e];A[t]=e}));var x=[];Object.keys(d).forEach((function(e){var t=d[e];x[t]=e}));var S=[];Object.keys(f).forEach((function(e){var t=f[e];S[t]=e}));var T=y.reduce((function(e,t){var n=m[t];return n===En||n===_n||n===En||n===bn||n===wn||n===Ln||r.ext_srgb&&(n===On||n===kn)?e[n]=n:n===xn||t.indexOf("rgba")>=0?e[n]=gn:e[n]=yn,e}),{});function R(){this.internalformat=gn,this.format=gn,this.type=Wn,this.compressed=!1,this.premultiplyAlpha=!1,this.flipY=!1,this.unpackAlignment=1,this.colorSpace=_r,this.width=0,this.height=0,this.channels=0}function C(e,t){e.internalformat=t.internalformat,e.format=t.format,e.type=t.type,e.compressed=t.compressed,e.premultiplyAlpha=t.premultiplyAlpha,e.flipY=t.flipY,e.unpackAlignment=t.unpackAlignment,e.colorSpace=t.colorSpace,e.width=t.width,e.height=t.height,e.channels=t.channels}function M(e,t){if("object"===s(t)&&t){if("premultiplyAlpha"in t&&(re.type(t.premultiplyAlpha,"boolean","invalid premultiplyAlpha"),e.premultiplyAlpha=t.premultiplyAlpha),"flipY"in t&&(re.type(t.flipY,"boolean","invalid texture flip"),e.flipY=t.flipY),"alignment"in t&&(re.oneOf(t.alignment,[1,2,4,8],"invalid texture unpack alignment"),e.unpackAlignment=t.alignment),"colorSpace"in t&&(re.parameter(t.colorSpace,p,"invalid colorSpace"),e.colorSpace=p[t.colorSpace]),"type"in t){var n=t.type;re(r.oes_texture_float||!("float"===n||"float32"===n),"you must enable the OES_texture_float extension in order to use floating point textures."),re(r.oes_texture_half_float||!("half float"===n||"float16"===n),"you must enable the OES_texture_half_float extension in order to use 16-bit floating point textures."),re(r.webgl_depth_texture||!("uint16"===n||"uint32"===n||"depth stencil"===n),"you must enable the WEBGL_depth_texture extension in order to use depth/stencil textures."),re.parameter(n,v,"invalid texture type"),e.type=v[n]}var o=e.width,a=e.height,u=e.channels,c=!1;"shape"in t?(re(Array.isArray(t.shape)&&t.shape.length>=2,"shape must be an array"),o=t.shape[0],a=t.shape[1],3===t.shape.length&&(u=t.shape[2],re(u>0&&u<=4,"invalid number of channels"),c=!0),re(o>=0&&o<=i.maxTextureSize,"invalid width"),re(a>=0&&a<=i.maxTextureSize,"invalid height")):("radius"in t&&(o=a=t.radius,re(o>=0&&o<=i.maxTextureSize,"invalid radius")),"width"in t&&(o=t.width,re(o>=0&&o<=i.maxTextureSize,"invalid width")),"height"in t&&(a=t.height,re(a>=0&&a<=i.maxTextureSize,"invalid height")),"channels"in t&&(u=t.channels,re(u>0&&u<=4,"invalid number of channels"),c=!0)),e.width=0|o,e.height=0|a,e.channels=0|u;var l=!1;if("format"in t){var f=t.format;re(r.webgl_depth_texture||!("depth"===f||"depth stencil"===f),"you must enable the WEBGL_depth_texture extension in order to use depth/stencil textures."),re.parameter(f,m,"invalid texture format");var h=e.internalformat=m[f];e.format=T[h],f in v&&("type"in t||(e.type=v[f])),f in g&&(e.compressed=!0),l=!0}!c&&l?e.channels=Ar[e.format]:c&&!l?e.channels!==br[e.format]&&(e.format=e.internalformat=br[e.channels]):l&&c&&re(e.channels===Ar[e.format],"number of channels inconsistent with specified format")}}function w(e){n.pixelStorei(vr,e.flipY),n.pixelStorei(mr,e.premultiplyAlpha),n.pixelStorei(gr,e.colorSpace),n.pixelStorei(pr,e.unpackAlignment)}function L(){R.call(this),this.xOffset=0,this.yOffset=0,this.data=null,this.needsFree=!1,this.element=null,this.needsCopy=!1}function O(t,n){var r=null;if(jr(n)?r=n:n&&(re.type(n,"object","invalid pixel data type"),M(t,n),"x"in n&&(t.xOffset=0|n.x),"y"in n&&(t.yOffset=0|n.y),jr(n.data)&&(r=n.data)),re(!t.compressed||r instanceof Uint8Array,"compressed texture data must be stored in a uint8array"),n.copy){re(!r,"can not specify copy and data field for the same texture");var o=a.viewportWidth,s=a.viewportHeight;t.width=t.width||o-t.xOffset,t.height=t.height||s-t.yOffset,t.needsCopy=!0,re(t.xOffset>=0&&t.xOffset<o&&t.yOffset>=0&&t.yOffset<s&&t.width>0&&t.width<=o&&t.height>0&&t.height<=s,"copy texture read out of bounds")}else if(r){if(e(r))t.channels=t.channels||4,t.data=r,"type"in n||t.type!==Wn||(t.type=Vr(r));else if(Nr(r))t.channels=t.channels||4,Hr(t,r),t.alignment=1,t.needsFree=!0;else if(At(r)){var u=r.data;Array.isArray(u)||t.type!==Wn||(t.type=Vr(u));var c,l,f,h,d,p,v=r.shape,m=r.stride;3===v.length?(f=v[2],p=m[2]):(re(2===v.length,"invalid ndarray pixel data, must be 2 or 3D"),f=1,p=1),c=v[0],l=v[1],h=m[0],d=m[1],t.alignment=1,t.width=c,t.height=l,t.channels=f,t.format=t.internalformat=br[f],t.needsFree=!0,Yr(t,u,h,d,p,r.offset)}else if(Dr(r)||Fr(r)||Br(r))Dr(r)||Fr(r)?t.element=r:t.element=r.canvas,t.width=t.element.width,t.height=t.element.height,t.channels=4;else if(Ur(r))t.element=r,t.width=r.width,t.height=r.height,t.channels=4;else if(Gr(r))t.element=r,t.width=r.naturalWidth,t.height=r.naturalHeight,t.channels=4;else if(zr(r))t.element=r,t.width=r.videoWidth,t.height=r.videoHeight,t.channels=4;else if(Ir(r)){var g=t.width||r[0].length,_=t.height||r.length,y=t.channels;y=fn(r[0][0])?y||r[0][0].length:y||1;for(var E=St.shape(r),b=1,A=0;A<E.length;++A)b*=E[A];var x=Xr(t,b);St.flatten(r,E,"",x),Wr(t,x),t.alignment=1,t.width=g,t.height=_,t.channels=y,t.format=t.internalformat=br[y],t.needsFree=!0}}else t.width=t.width||1,t.height=t.height||1,t.channels=t.channels||4;t.type===qn?re(i.extensions.indexOf("oes_texture_float")>=0,"oes_texture_float extension not enabled"):t.type===Nn&&re(i.extensions.indexOf("oes_texture_half_float")>=0,"oes_texture_half_float extension not enabled")}function k(e,t,r){var i=e.element,a=e.data,s=e.internalformat,u=e.format,c=e.type,l=e.width,f=e.height;w(e),i?n.texImage2D(t,r,u,u,c,i):e.compressed?n.compressedTexImage2D(t,r,s,l,f,0,a):e.needsCopy?(o(),n.copyTexImage2D(t,r,u,e.xOffset,e.yOffset,l,f,0)):n.texImage2D(t,r,u,l,f,0,u,c,a||null)}function N(e,t,r,i,a){var s=e.element,u=e.data,c=e.internalformat,l=e.format,f=e.type,h=e.width,d=e.height;w(e),s?n.texSubImage2D(t,a,r,i,l,f,s):e.compressed?n.compressedTexSubImage2D(t,a,r,i,c,h,d,u):e.needsCopy?(o(),n.copyTexSubImage2D(t,a,r,i,e.xOffset,e.yOffset,h,d)):n.texSubImage2D(t,a,r,i,h,d,l,f,u)}var I=[];function P(){return I.pop()||new L}function D(e){e.needsFree&&De.freeType(e.data),L.call(e),I.push(e)}function F(){R.call(this),this.genMipmaps=!1,this.mipmapHint=lr,this.mipmask=0,this.images=Array(16)}function B(e,t,n){var r=e.images[0]=P();e.mipmask=1,r.width=e.width=t,r.height=e.height=n,r.channels=e.channels=4}function U(e,t){var n=null;if(jr(t))C(n=e.images[0]=P(),e),O(n,t),e.mipmask=1;else if(M(e,t),Array.isArray(t.mipmap))for(var r=t.mipmap,i=0;i<r.length;++i)C(n=e.images[i]=P(),e),n.width>>=i,n.height>>=i,O(n,r[i]),e.mipmask|=1<<i;else C(n=e.images[0]=P(),e),O(n,t),e.mipmask=1;C(e,e.images[0]),!e.compressed||e.internalformat!==In&&e.internalformat!==Pn&&e.internalformat!==Dn&&e.internalformat!==Fn||re(e.width%4==0&&e.height%4==0,"for compressed texture formats, mipmap level 0 must have width and height that are a multiple of 4")}function G(e,t){for(var n=e.images,r=0;r<n.length;++r){if(!n[r])return;k(n[r],t,r)}}var z=[];function j(){var e=z.pop()||new F;R.call(e),e.mipmask=0;for(var t=0;t<16;++t)e.images[t]=null;return e}function V(e){for(var t=e.images,n=0;n<t.length;++n)t[n]&&D(t[n]),t[n]=null;z.push(e)}function H(){this.minFilter=rr,this.magFilter=rr,this.wrapS=Jn,this.wrapT=Jn,this.anisotropic=1,this.genMipmaps=!1,this.mipmapHint=lr}function X(e,t){if("min"in t){var n=t.min;re.parameter(n,d),e.minFilter=d[n],Er.indexOf(e.minFilter)>=0&&!("faces"in t)&&(e.genMipmaps=!0)}if("mag"in t){var r=t.mag;re.parameter(r,h),e.magFilter=h[r]}var o=e.wrapS,a=e.wrapT;if("wrap"in t){var u=t.wrap;"string"==typeof u?(re.parameter(u,f),o=a=f[u]):Array.isArray(u)&&(re.parameter(u[0],f),re.parameter(u[1],f),o=f[u[0]],a=f[u[1]])}else{if("wrapS"in t){var c=t.wrapS;re.parameter(c,f),o=f[c]}if("wrapT"in t){var p=t.wrapT;re.parameter(p,f),a=f[p]}}if(e.wrapS=o,e.wrapT=a,"anisotropic"in t){var v=t.anisotropic;re("number"==typeof v&&v>=1&&v<=i.maxAnisotropic,"aniso samples must be between 1 and "),e.anisotropic=t.anisotropic}if("mipmap"in t){var m=!1;switch(s(t.mipmap)){case"string":re.parameter(t.mipmap,l,"invalid mipmap hint"),e.mipmapHint=l[t.mipmap],e.genMipmaps=!0,m=!0;break;case"boolean":m=e.genMipmaps=t.mipmap;break;case"object":re(Array.isArray(t.mipmap),"invalid mipmap type"),e.genMipmaps=!1,m=!0;break;default:re.raise("invalid mipmap type")}m&&!("min"in t)&&(e.minFilter=or)}}function W(e,t){n.texParameteri(t,nr,e.minFilter),n.texParameteri(t,tr,e.magFilter),n.texParameteri(t,Kn,e.wrapS),n.texParameteri(t,Qn,e.wrapT),r.ext_texture_filter_anisotropic&&n.texParameteri(t,dr,e.anisotropic),e.genMipmaps&&(n.hint(cr,e.mipmapHint),n.generateMipmap(t))}var Y=0,Z={},q=i.maxTextureUnits,K=Array(q).map((function(){return null}));function Q(e){R.call(this),this.mipmask=0,this.internalformat=gn,this.id=Y++,this.refCount=1,this.target=e,this.texture=n.createTexture(),this.unit=-1,this.bindCount=0,this.texInfo=new H,c.profile&&(this.stats={size:0})}function $(e){n.activeTexture(yr),n.bindTexture(e.target,e.texture)}function J(){var e=K[0];e?n.bindTexture(e.target,e.texture):n.bindTexture(pn,null)}function ee(e){var t=e.texture;re(t,"must not double destroy texture");var r=e.unit,i=e.target;r>=0&&(n.activeTexture(yr+r),n.bindTexture(i,null),K[r]=null),n.deleteTexture(t),e.texture=null,e.params=null,e.pixels=null,e.refCount=0,delete Z[e.id],u.textureCount--}function te(e,t){var r=new Q(pn);function o(e,t){var n=r.texInfo;H.call(n);var a=j();return"number"==typeof e?B(a,0|e,"number"==typeof t?0|t:0|e):e?(re.type(e,"object","invalid arguments to regl.texture"),X(n,e),U(a,e)):B(a,1,1),n.genMipmaps&&(a.mipmask=(a.width<<1)-1),r.mipmask=a.mipmask,C(r,a),re.texture2D(n,a,i),r.internalformat=a.internalformat,o.width=a.width,o.height=a.height,$(r),G(a,pn),W(n,pn),J(),V(a),c.profile&&(r.stats.size=Zr(r.internalformat,r.type,a.width,a.height,n.genMipmaps,!1)),o.format=E[r.internalformat],o.type=b[r.type],o.mag=A[n.magFilter],o.min=x[n.minFilter],o.wrapS=S[n.wrapS],o.wrapT=S[n.wrapT],o}function a(e,t,n,i){re(!!e,"must specify image data");var a=0|t,s=0|n,u=0|i,c=P();return C(c,r),c.width=0,c.height=0,O(c,e),c.width=c.width||(r.width>>u)-a,c.height=c.height||(r.height>>u)-s,re(r.type===c.type&&r.format===c.format&&r.internalformat===c.internalformat,"incompatible format for texture.subimage"),re(a>=0&&s>=0&&a+c.width<=r.width&&s+c.height<=r.height,"texture.subimage write out of bounds"),re(r.mipmask&1<<u,"missing mipmap data"),re(c.data||c.element||c.needsCopy,"missing image data"),$(r),N(c,pn,a,s,u),J(),D(c),o}function s(e,t){var i=0|e,a=0|t||i;if(i===r.width&&a===r.height)return o;o.width=r.width=i,o.height=r.height=a,$(r);for(var s=0;r.mipmask>>s;++s){var u=i>>s,l=a>>s;if(!u||!l)break;n.texImage2D(pn,s,r.format,u,l,0,r.format,r.type,null)}return J(),c.profile&&(r.stats.size=Zr(r.internalformat,r.type,i,a,!1,!1)),o}return Z[r.id]=r,u.textureCount++,o(e,t),o.subimage=a,o.resize=s,o._reglType="texture2d",o._texture=r,c.profile&&(o.stats=r.stats),o.destroy=function(){r.decRef()},o}function ne(e,t,r,o,a,l){var f=new Q(vn);Z[f.id]=f,u.cubeCount++;var h=new Array(6);function d(e,t,n,r,o,a){var u,l=f.texInfo;for(H.call(l),u=0;u<6;++u)h[u]=j();if("number"!=typeof e&&e)if("object"===s(e))if(t)U(h[0],e),U(h[1],t),U(h[2],n),U(h[3],r),U(h[4],o),U(h[5],a);else if(X(l,e),M(f,e),"faces"in e){var p=e.faces;for(re(Array.isArray(p)&&6===p.length,"cube faces must be a length 6 array"),u=0;u<6;++u)re("object"===s(p[u])&&!!p[u],"invalid input for cube map face"),C(h[u],f),U(h[u],p[u])}else for(u=0;u<6;++u)U(h[u],e);else re.raise("invalid arguments to cube map");else{var v=0|e||1;for(u=0;u<6;++u)B(h[u],v,v)}for(C(f,h[0]),i.npotTextureCube||re(hn(f.width)&&hn(f.height),"your browser does not support non power or two texture dimensions"),l.genMipmaps?f.mipmask=(h[0].width<<1)-1:f.mipmask=h[0].mipmask,re.textureCube(f,l,h,i),f.internalformat=h[0].internalformat,d.width=h[0].width,d.height=h[0].height,$(f),u=0;u<6;++u)G(h[u],mn+u);for(W(l,vn),J(),c.profile&&(f.stats.size=Zr(f.internalformat,f.type,d.width,d.height,l.genMipmaps,!0)),d.format=E[f.internalformat],d.type=b[f.type],d.mag=A[l.magFilter],d.min=x[l.minFilter],d.wrapS=S[l.wrapS],d.wrapT=S[l.wrapT],u=0;u<6;++u)V(h[u]);return d}function p(e,t,n,r,i){re(!!t,"must specify image data"),re("number"==typeof e&&e===(0|e)&&e>=0&&e<6,"invalid face");var o=0|n,a=0|r,s=0|i,u=P();return C(u,f),u.width=0,u.height=0,O(u,t),u.width=u.width||(f.width>>s)-o,u.height=u.height||(f.height>>s)-a,re(f.type===u.type&&f.format===u.format&&f.internalformat===u.internalformat,"incompatible format for texture.subimage"),re(o>=0&&a>=0&&o+u.width<=f.width&&a+u.height<=f.height,"texture.subimage write out of bounds"),re(f.mipmask&1<<s,"missing mipmap data"),re(u.data||u.element||u.needsCopy,"missing image data"),$(f),N(u,mn+e,o,a,s),J(),D(u),d}function v(e){var t=0|e;if(t!==f.width){d.width=f.width=t,d.height=f.height=t,$(f);for(var r=0;r<6;++r)for(var i=0;f.mipmask>>i;++i)n.texImage2D(mn+r,i,f.format,t>>i,t>>i,0,f.format,f.type,null);return J(),c.profile&&(f.stats.size=Zr(f.internalformat,f.type,d.width,d.height,!1,!0)),d}}return d(e,t,r,o,a,l),d.subimage=p,d.resize=v,d._reglType="textureCube",d._texture=f,c.profile&&(d.stats=f.stats),d.destroy=function(){f.decRef()},d}function ie(){for(var e=0;e<q;++e)n.activeTexture(yr+e),n.bindTexture(pn,null),K[e]=null;xt(Z).forEach(ee),u.cubeCount=0,u.textureCount=0}function oe(){for(var e=0;e<q;++e){var t=K[e];t&&(t.bindCount=0,t.unit=-1,K[e]=null)}xt(Z).forEach((function(e){e.texture=n.createTexture(),n.bindTexture(e.target,e.texture);for(var t=0;t<32;++t)if(e.mipmask&1<<t)if(e.target===pn)n.texImage2D(pn,t,e.internalformat,e.width>>t,e.height>>t,0,e.internalformat,e.type,null);else for(var r=0;r<6;++r)n.texImage2D(mn+r,t,e.internalformat,e.width>>t,e.height>>t,0,e.internalformat,e.type,null);W(e.texInfo,e.target)}))}return t(Q.prototype,{bind:function(){var e=this;e.bindCount+=1;var t=e.unit;if(t<0){for(var r=0;r<q;++r){var i=K[r];if(i){if(i.bindCount>0)continue;i.unit=-1}K[r]=e,t=r;break}t>=q&&re.raise("insufficient number of texture units"),c.profile&&u.maxTextureUnits<t+1&&(u.maxTextureUnits=t+1),e.unit=t,n.activeTexture(yr+t),n.bindTexture(e.target,e.texture)}return t},unbind:function(){this.bindCount-=1},decRef:function(){--this.refCount<=0&&ee(this)}}),c.profile&&(u.getTotalTextureSize=function(){var e=0;return Object.keys(Z).forEach((function(t){e+=Z[t].stats.size})),e}),{create2D:te,createCube:ne,clear:ie,getTexture:function(e){return null},restore:oe}}kr[An]=2,kr[xn]=2,kr[Sn]=2,kr[Ln]=4,kr[In]=.5,kr[Pn]=.5,kr[Dn]=1,kr[Fn]=1,kr[Bn]=.5,kr[Un]=1,kr[Gn]=1,kr[zn]=.5,kr[jn]=.25,kr[Vn]=.5,kr[Hn]=.25,kr[Xn]=.5;var Kr=36161,Qr=32854,$r=32855,Jr=36194,ei=33189,ti=36168,ni=34041,ri=35907,ii=34836,oi=34842,ai=34843,si=[];function ui(e,t,n){return si[e]*t*n}si[Qr]=2,si[$r]=2,si[Jr]=2,si[ei]=2,si[ti]=1,si[ni]=4,si[ri]=4,si[ii]=16,si[oi]=8,si[ai]=6;var ci=function(e,t,n,r,i){var o={rgba4:Qr,rgb565:Jr,"rgb5 a1":$r,depth:ei,stencil:ti,"depth stencil":ni};t.ext_srgb&&(o.srgba=ri),t.ext_color_buffer_half_float&&(o.rgba16f=oi,o.rgb16f=ai),t.webgl_color_buffer_float&&(o.rgba32f=ii);var a=[];Object.keys(o).forEach((function(e){var t=o[e];a[t]=e}));var u=0,c={};function l(e){this.id=u++,this.refCount=1,this.renderbuffer=e,this.format=Qr,this.width=0,this.height=0,i.profile&&(this.stats={size:0})}function f(t){var n=t.renderbuffer;re(n,"must not double destroy renderbuffer"),e.bindRenderbuffer(Kr,null),e.deleteRenderbuffer(n),t.renderbuffer=null,t.refCount=0,delete c[t.id],r.renderbufferCount--}function h(t,u){var f=new l(e.createRenderbuffer());function h(t,r){var u=0,c=0,l=Qr;if("object"===s(t)&&t){var d=t;if("shape"in d){var p=d.shape;re(Array.isArray(p)&&p.length>=2,"invalid renderbuffer shape"),u=0|p[0],c=0|p[1]}else"radius"in d&&(u=c=0|d.radius),"width"in d&&(u=0|d.width),"height"in d&&(c=0|d.height);"format"in d&&(re.parameter(d.format,o,"invalid renderbuffer format"),l=o[d.format])}else"number"==typeof t?(u=0|t,c="number"==typeof r?0|r:u):t?re.raise("invalid arguments to renderbuffer constructor"):u=c=1;if(re(u>0&&c>0&&u<=n.maxRenderbufferSize&&c<=n.maxRenderbufferSize,"invalid renderbuffer size"),u!==f.width||c!==f.height||l!==f.format)return h.width=f.width=u,h.height=f.height=c,f.format=l,e.bindRenderbuffer(Kr,f.renderbuffer),e.renderbufferStorage(Kr,l,u,c),re(0===e.getError(),"invalid render buffer format"),i.profile&&(f.stats.size=ui(f.format,f.width,f.height)),h.format=a[f.format],h}function d(t,r){var o=0|t,a=0|r||o;return o===f.width&&a===f.height||(re(o>0&&a>0&&o<=n.maxRenderbufferSize&&a<=n.maxRenderbufferSize,"invalid renderbuffer size"),h.width=f.width=o,h.height=f.height=a,e.bindRenderbuffer(Kr,f.renderbuffer),e.renderbufferStorage(Kr,f.format,o,a),re(0===e.getError(),"invalid render buffer format"),i.profile&&(f.stats.size=ui(f.format,f.width,f.height))),h}return c[f.id]=f,r.renderbufferCount++,h(t,u),h.resize=d,h._reglType="renderbuffer",h._renderbuffer=f,i.profile&&(h.stats=f.stats),h.destroy=function(){f.decRef()},h}function d(){xt(c).forEach((function(t){t.renderbuffer=e.createRenderbuffer(),e.bindRenderbuffer(Kr,t.renderbuffer),e.renderbufferStorage(Kr,t.format,t.width,t.height)})),e.bindRenderbuffer(Kr,null)}return l.prototype.decRef=function(){--this.refCount<=0&&f(this)},i.profile&&(r.getTotalRenderbufferSize=function(){var e=0;return Object.keys(c).forEach((function(t){e+=c[t].stats.size})),e}),{create:h,clear:function(){xt(c).forEach(f)},restore:d}},li=36160,fi=36161,hi=3553,di=34069,pi=36064,vi=36096,mi=36128,gi=33306,_i=36053,yi=36054,Ei=36055,bi=36057,Ai=36061,xi=36193,Si=5121,Ti=5126,Ri=6407,Ci=6408,Mi=6402,wi=[Ri,Ci],Li=[];Li[Ci]=4,Li[Ri]=3;var Oi=[];Oi[Si]=1,Oi[Ti]=4,Oi[xi]=2;var ki=33189,Ni=36168,Ii=34041,Pi=[32854,32855,36194,35907,34842,34843,34836],Di={};function Fi(e,n,r,i,o,a){var u={cur:null,next:null,dirty:!1,setFBO:null},c=["rgba"],l=["rgba4","rgb565","rgb5 a1"];n.ext_srgb&&l.push("srgba"),n.ext_color_buffer_half_float&&l.push("rgba16f","rgb16f"),n.webgl_color_buffer_float&&l.push("rgba32f");var f=["uint8"];function h(e,t,n){this.target=e,this.texture=t,this.renderbuffer=n;var r=0,i=0;t?(r=t.width,i=t.height):n&&(r=n.width,i=n.height),this.width=r,this.height=i}function d(e){e&&(e.texture&&e.texture._texture.decRef(),e.renderbuffer&&e.renderbuffer._renderbuffer.decRef())}function p(e,t,n){if(e)if(e.texture){var r=e.texture._texture,i=Math.max(1,r.width),o=Math.max(1,r.height);re(i===t&&o===n,"inconsistent width/height for supplied texture"),r.refCount+=1}else{var a=e.renderbuffer._renderbuffer;re(a.width===t&&a.height===n,"inconsistent width/height for renderbuffer"),a.refCount+=1}}function v(t,n){n&&(n.texture?e.framebufferTexture2D(li,t,n.target,n.texture._texture.texture,0):e.framebufferRenderbuffer(li,t,fi,n.renderbuffer._renderbuffer.renderbuffer))}function m(e){var t=hi,n=null,r=null,i=e;"object"===s(e)&&(i=e.data,"target"in e&&(t=0|e.target)),re.type(i,"function","invalid attachment data");var o=i._reglType;return"texture2d"===o?(n=i,re(t===hi)):"textureCube"===o?(n=i,re(t>=di&&t<di+6,"invalid cube map target")):"renderbuffer"===o?(r=i,t=fi):re.raise("invalid regl object for attachment"),new h(t,n,r)}function g(e,t,n,r,a){if(n){var s=i.create2D({width:e,height:t,format:r,type:a});return s._texture.refCount=0,new h(hi,s,null)}var u=o.create({width:e,height:t,format:r});return u._renderbuffer.refCount=0,new h(fi,null,u)}function _(e){return e&&(e.texture||e.renderbuffer)}function y(e,t,n){e&&(e.texture?e.texture.resize(t,n):e.renderbuffer&&e.renderbuffer.resize(t,n),e.width=t,e.height=n)}n.oes_texture_half_float&&f.push("half float","float16"),n.oes_texture_float&&f.push("float","float32");var E=0,b={};function A(){this.id=E++,b[this.id]=this,this.framebuffer=e.createFramebuffer(),this.width=0,this.height=0,this.colorAttachments=[],this.depthAttachment=null,this.stencilAttachment=null,this.depthStencilAttachment=null}function x(e){e.colorAttachments.forEach(d),d(e.depthAttachment),d(e.stencilAttachment),d(e.depthStencilAttachment)}function S(t){var n=t.framebuffer;re(n,"must not double destroy framebuffer"),e.deleteFramebuffer(n),t.framebuffer=null,a.framebufferCount--,delete b[t.id]}function T(t){var n;e.bindFramebuffer(li,t.framebuffer);var i=t.colorAttachments;for(n=0;n<i.length;++n)v(pi+n,i[n]);for(n=i.length;n<r.maxColorAttachments;++n)e.framebufferTexture2D(li,pi+n,hi,null,0);e.framebufferTexture2D(li,gi,hi,null,0),e.framebufferTexture2D(li,vi,hi,null,0),e.framebufferTexture2D(li,mi,hi,null,0),v(vi,t.depthAttachment),v(mi,t.stencilAttachment),v(gi,t.depthStencilAttachment);var o=e.checkFramebufferStatus(li);e.isContextLost()||o===_i||re.raise("framebuffer configuration not supported, status = "+Di[o]),e.bindFramebuffer(li,u.next?u.next.framebuffer:null),u.cur=u.next,e.getError()}function R(e,i){var o=new A;function s(e,t){var i;re(u.next!==o,"can not update framebuffer which is currently in use");var a=0,h=0,d=!0,v=!0,y=null,E=!0,b="rgba",A="uint8",S=1,R=null,C=null,M=null,w=!1;if("number"==typeof e)a=0|e,h=0|t||a;else if(e){re.type(e,"object","invalid arguments for framebuffer");var L=e;if("shape"in L){var O=L.shape;re(Array.isArray(O)&&O.length>=2,"invalid shape for framebuffer"),a=O[0],h=O[1]}else"radius"in L&&(a=h=L.radius),"width"in L&&(a=L.width),"height"in L&&(h=L.height);("color"in L||"colors"in L)&&(y=L.color||L.colors,Array.isArray(y)&&re(1===y.length||n.webgl_draw_buffers,"multiple render targets not supported")),y||("colorCount"in L&&(S=0|L.colorCount,re(S>0,"invalid color buffer count")),"colorTexture"in L&&(E=!!L.colorTexture,b="rgba4"),"colorType"in L&&(A=L.colorType,E?(re(n.oes_texture_float||!("float"===A||"float32"===A),"you must enable OES_texture_float in order to use floating point framebuffer objects"),re(n.oes_texture_half_float||!("half float"===A||"float16"===A),"you must enable OES_texture_half_float in order to use 16-bit floating point framebuffer objects")):"half float"===A||"float16"===A?(re(n.ext_color_buffer_half_float,"you must enable EXT_color_buffer_half_float to use 16-bit render buffers"),b="rgba16f"):"float"!==A&&"float32"!==A||(re(n.webgl_color_buffer_float,"you must enable WEBGL_color_buffer_float in order to use 32-bit floating point renderbuffers"),b="rgba32f"),re.oneOf(A,f,"invalid color type")),"colorFormat"in L&&(b=L.colorFormat,c.indexOf(b)>=0?E=!0:l.indexOf(b)>=0?E=!1:E?re.oneOf(L.colorFormat,c,"invalid color format for texture"):re.oneOf(L.colorFormat,l,"invalid color format for renderbuffer"))),("depthTexture"in L||"depthStencilTexture"in L)&&(w=!(!L.depthTexture&&!L.depthStencilTexture),re(!w||n.webgl_depth_texture,"webgl_depth_texture extension not supported")),"depth"in L&&("boolean"==typeof L.depth?d=L.depth:(R=L.depth,v=!1)),"stencil"in L&&("boolean"==typeof L.stencil?v=L.stencil:(C=L.stencil,d=!1)),"depthStencil"in L&&("boolean"==typeof L.depthStencil?d=v=L.depthStencil:(M=L.depthStencil,d=!1,v=!1))}else a=h=1;var k=null,N=null,I=null,P=null;if(Array.isArray(y))k=y.map(m);else if(y)k=[m(y)];else for(k=new Array(S),i=0;i<S;++i)k[i]=g(a,h,E,b,A);re(n.webgl_draw_buffers||k.length<=1,"you must enable the WEBGL_draw_buffers extension in order to use multiple color buffers."),re(k.length<=r.maxColorAttachments,"too many color attachments, not supported"),a=a||k[0].width,h=h||k[0].height,R?N=m(R):d&&!v&&(N=g(a,h,w,"depth","uint32")),C?I=m(C):v&&!d&&(I=g(a,h,!1,"stencil","uint8")),M?P=m(M):!R&&!C&&v&&d&&(P=g(a,h,w,"depth stencil","depth stencil")),re(!!R+!!C+!!M<=1,"invalid framebuffer configuration, can specify exactly one depth/stencil attachment");var D=null;for(i=0;i<k.length;++i)if(p(k[i],a,h),re(!k[i]||k[i].texture&&wi.indexOf(k[i].texture._texture.format)>=0||k[i].renderbuffer&&Pi.indexOf(k[i].renderbuffer._renderbuffer.format)>=0,"framebuffer color attachment "+i+" is invalid"),k[i]&&k[i].texture){var F=Li[k[i].texture._texture.format]*Oi[k[i].texture._texture.type];null===D?D=F:re(D===F,"all color attachments much have the same number of bits per pixel.")}return p(N,a,h),re(!N||N.texture&&N.texture._texture.format===Mi||N.renderbuffer&&N.renderbuffer._renderbuffer.format===ki,"invalid depth attachment for framebuffer object"),p(I,a,h),re(!I||I.renderbuffer&&I.renderbuffer._renderbuffer.format===Ni,"invalid stencil attachment for framebuffer object"),p(P,a,h),re(!P||P.texture&&P.texture._texture.format===Ii||P.renderbuffer&&P.renderbuffer._renderbuffer.format===Ii,"invalid depth-stencil attachment for framebuffer object"),x(o),o.width=a,o.height=h,o.colorAttachments=k,o.depthAttachment=N,o.stencilAttachment=I,o.depthStencilAttachment=P,s.color=k.map(_),s.depth=_(N),s.stencil=_(I),s.depthStencil=_(P),s.width=o.width,s.height=o.height,T(o),s}function h(e,t){re(u.next!==o,"can not resize a framebuffer which is currently in use");var n=Math.max(0|e,1),r=Math.max(0|t||n,1);if(n===o.width&&r===o.height)return s;for(var i=o.colorAttachments,a=0;a<i.length;++a)y(i[a],n,r);return y(o.depthAttachment,n,r),y(o.stencilAttachment,n,r),y(o.depthStencilAttachment,n,r),o.width=s.width=n,o.height=s.height=r,T(o),s}return a.framebufferCount++,s(e,i),t(s,{resize:h,_reglType:"framebuffer",_framebuffer:o,destroy:function(){S(o),x(o)},use:function(e){u.setFBO({framebuffer:s},e)}})}function C(e){var o=Array(6);function a(e){var r;re(o.indexOf(u.next)<0,"can not update framebuffer which is currently in use");var s,l={color:null},h=0,d=null,p="rgba",v="uint8",m=1;if("number"==typeof e)h=0|e;else if(e){re.type(e,"object","invalid arguments for framebuffer");var g=e;if("shape"in g){var _=g.shape;re(Array.isArray(_)&&_.length>=2,"invalid shape for framebuffer"),re(_[0]===_[1],"cube framebuffer must be square"),h=_[0]}else"radius"in g&&(h=0|g.radius),"width"in g?(h=0|g.width,"height"in g&&re(g.height===h,"must be square")):"height"in g&&(h=0|g.height);("color"in g||"colors"in g)&&(d=g.color||g.colors,Array.isArray(d)&&re(1===d.length||n.webgl_draw_buffers,"multiple render targets not supported")),d||("colorCount"in g&&(m=0|g.colorCount,re(m>0,"invalid color buffer count")),"colorType"in g&&(re.oneOf(g.colorType,f,"invalid color type"),v=g.colorType),"colorFormat"in g&&(p=g.colorFormat,re.oneOf(g.colorFormat,c,"invalid color format for texture"))),"depth"in g&&(l.depth=g.depth),"stencil"in g&&(l.stencil=g.stencil),"depthStencil"in g&&(l.depthStencil=g.depthStencil)}else h=1;if(d)if(Array.isArray(d))for(s=[],r=0;r<d.length;++r)s[r]=d[r];else s=[d];else{s=Array(m);var y={radius:h,format:p,type:v};for(r=0;r<m;++r)s[r]=i.createCube(y)}for(l.color=Array(s.length),r=0;r<s.length;++r){var E=s[r];re("function"==typeof E&&"textureCube"===E._reglType,"invalid cube map"),h=h||E.width,re(E.width===h&&E.height===h,"invalid cube map shape"),l.color[r]={target:di,data:s[r]}}for(r=0;r<6;++r){for(var b=0;b<s.length;++b)l.color[b].target=di+r;r>0&&(l.depth=o[0].depth,l.stencil=o[0].stencil,l.depthStencil=o[0].depthStencil),o[r]?o[r](l):o[r]=R(l)}return t(a,{width:h,height:h,color:s})}function s(e){var t,n=0|e;if(re(n>0&&n<=r.maxCubeMapSize,"invalid radius for cube fbo"),n===a.width)return a;var i=a.color;for(t=0;t<i.length;++t)i[t].resize(n);for(t=0;t<6;++t)o[t].resize(n);return a.width=a.height=n,a}return a(e),t(a,{faces:o,resize:s,_reglType:"framebufferCube",destroy:function(){o.forEach((function(e){e.destroy()}))}})}function M(){u.cur=null,u.next=null,u.dirty=!0,xt(b).forEach((function(t){t.framebuffer=e.createFramebuffer(),T(t)}))}return t(u,{getFramebuffer:function(e){if("function"==typeof e&&"framebuffer"===e._reglType){var t=e._framebuffer;if(t instanceof A)return t}return null},create:R,createCube:C,clear:function(){xt(b).forEach(S)},restore:M})}Di[_i]="complete",Di[yi]="incomplete attachment",Di[bi]="incomplete dimensions",Di[Ei]="incomplete, missing attachment",Di[Ai]="unsupported";var Bi=5126,Ui=34962;function Gi(){this.state=0,this.x=0,this.y=0,this.z=0,this.w=0,this.buffer=null,this.size=0,this.normalized=!1,this.type=Bi,this.offset=0,this.stride=0,this.divisor=0}function zi(t,n,r,i,o){for(var a=r.maxAttributes,s=new Array(a),u=0;u<a;++u)s[u]=new Gi;var c=0,l={},f={Record:Gi,scope:{},state:s,currentVAO:null,targetVAO:null,restore:d()?E:function(){},createVAO:b,getVAO:v,destroyBuffer:h,setVAO:d()?m:g,clear:d()?_:function(){}};function h(e){for(var n=0;n<s.length;++n){var r=s[n];r.buffer===e&&(t.disableVertexAttribArray(n),r.buffer=null)}}function d(){return n.oes_vertex_array_object}function p(){return n.angle_instanced_arrays}function v(e){return"function"==typeof e&&e._vao?e._vao:null}function m(e){if(e!==f.currentVAO){var t=d();e?t.bindVertexArrayOES(e.vao):t.bindVertexArrayOES(null),f.currentVAO=e}}function g(e){if(e!==f.currentVAO){if(e)e.bindAttrs();else for(var n=p(),r=0;r<s.length;++r){var i=s[r];i.buffer?(t.enableVertexAttribArray(r),t.vertexAttribPointer(r,i.size,i.type,i.normalized,i.stride,i.offfset),n&&n.vertexAttribDivisorANGLE(r,i.divisor)):(t.disableVertexAttribArray(r),t.vertexAttrib4f(r,i.x,i.y,i.z,i.w))}f.currentVAO=e}}function _(){xt(l).forEach((function(e){e.destroy()}))}function y(){this.id=++c,this.attributes=[];var e=d();this.vao=e?e.createVertexArrayOES():null,l[this.id]=this,this.buffers=[]}function E(){d()&&xt(l).forEach((function(e){e.refresh()}))}function b(t){var r=new y;function s(t){re(Array.isArray(t),"arguments to vertex array constructor must be an array"),re(t.length<a,"too many attributes"),re(t.length>0,"must specify at least one attribute");for(var i=0;i<r.buffers.length;++i)r.buffers[i].destroy();r.buffers.length=0;var u=r.attributes;u.length=t.length;for(var c=0;c<t.length;++c){var l=t[c],f=u[c]=new Gi;if(Array.isArray(l)||e(l)||At(l)){var h=o.create(l,Ui,!1,!0);f.buffer=o.getBuffer(h),f.size=0|f.buffer.dimension,f.normalized=!1,f.type=f.buffer.dtype,f.offset=0,f.stride=0,f.divisor=0,f.state=1,r.buffers.push(h)}else o.getBuffer(l)?(f.buffer=o.getBuffer(l),f.size=0|f.buffer.dimension,f.normalized=!1,f.type=f.buffer.dtype,f.offset=0,f.stride=0,f.divisor=0,f.state=1):o.getBuffer(l.buffer)?(f.buffer=o.getBuffer(l.buffer),f.size=0|(+l.size||f.buffer.dimension),f.normalized=!!l.normalized||!1,"type"in l?(re.parameter(l.type,kt,"invalid buffer type"),f.type=kt[l.type]):f.type=f.buffer.dtype,f.offset=0|(l.offset||0),f.stride=0|(l.stride||0),f.divisor=0|(l.divisor||0),f.state=1,re(f.size>=1&&f.size<=4,"size must be between 1 and 4"),re(f.offset>=0,"invalid offset"),re(f.stride>=0&&f.stride<=255,"stride must be between 0 and 255"),re(f.divisor>=0,"divisor must be positive"),re(!f.divisor||!!n.angle_instanced_arrays,"ANGLE_instanced_arrays must be enabled to use divisor")):"x"in l?(re(c>0,"first attribute must not be a constant"),f.x=+l.x||0,f.y=+l.y||0,f.z=+l.z||0,f.w=+l.w||0,f.state=2):re(!1,"invalid attribute spec for location "+c)}return r.refresh(),s}return i.vaoCount+=1,s.destroy=function(){r.destroy()},s._vao=r,s._reglType="vao",s(t)}return y.prototype.bindAttrs=function(){for(var e=p(),n=this.attributes,r=0;r<n.length;++r){var i=n[r];i.buffer?(t.enableVertexAttribArray(r),t.bindBuffer(Ui,i.buffer.buffer),t.vertexAttribPointer(r,i.size,i.type,i.normalized,i.stride,i.offset),e&&e.vertexAttribDivisorANGLE(r,i.divisor)):(t.disableVertexAttribArray(r),t.vertexAttrib4f(r,i.x,i.y,i.z,i.w))}for(var o=n.length;o<a;++o)t.disableVertexAttribArray(o)},y.prototype.refresh=function(){var e=d();e&&(e.bindVertexArrayOES(this.vao),this.bindAttrs(),f.currentVAO=this)},y.prototype.destroy=function(){if(this.vao){var e=d();this===f.currentVAO&&(f.currentVAO=null,e.bindVertexArrayOES(null)),e.deleteVertexArrayOES(this.vao),this.vao=null}l[this.id]&&(delete l[this.id],i.vaoCount-=1)},f}var ji=35632,Vi=35633,Hi=35718,Xi=35721;function Wi(e,t,n,r){var i={},o={};function a(e,t,n,r){this.name=e,this.id=t,this.location=n,this.info=r}function s(e,t){for(var n=0;n<e.length;++n)if(e[n].id===t.id)return void(e[n].location=t.location);e.push(t)}function u(n,r,a){var s=n===ji?i:o,u=s[r];if(!u){var c=t.str(r);u=e.createShader(n),e.shaderSource(u,c),e.compileShader(u),re.shaderError(e,u,c,n,a),s[r]=u}return u}var c={},l=[],f=0;function h(e,t){this.id=f++,this.fragId=e,this.vertId=t,this.program=null,this.uniforms=[],this.attributes=[],r.profile&&(this.stats={uniformsCount:0,attributesCount:0})}function d(n,i,o){var c,l,f=u(ji,n.fragId),h=u(Vi,n.vertId),d=n.program=e.createProgram();if(e.attachShader(d,f),e.attachShader(d,h),o)for(c=0;c<o.length;++c){var p=o[c];e.bindAttribLocation(d,p[0],p[1])}e.linkProgram(d),re.linkError(e,d,t.str(n.fragId),t.str(n.vertId),i);var v=e.getProgramParameter(d,Hi);r.profile&&(n.stats.uniformsCount=v);var m=n.uniforms;for(c=0;c<v;++c)if(l=e.getActiveUniform(d,c))if(l.size>1)for(var g=0;g<l.size;++g){var _=l.name.replace("[0]","["+g+"]");s(m,new a(_,t.id(_),e.getUniformLocation(d,_),l))}else s(m,new a(l.name,t.id(l.name),e.getUniformLocation(d,l.name),l));var y=e.getProgramParameter(d,Xi);r.profile&&(n.stats.attributesCount=y);var E=n.attributes;for(c=0;c<y;++c)(l=e.getActiveAttrib(d,c))&&s(E,new a(l.name,t.id(l.name),e.getAttribLocation(d,l.name),l))}function p(){i={},o={};for(var e=0;e<l.length;++e)d(l[e],null,l[e].attributes.map((function(e){return[e.location,e.name]})))}return r.profile&&(n.getMaxUniformsCount=function(){var e=0;return l.forEach((function(t){t.stats.uniformsCount>e&&(e=t.stats.uniformsCount)})),e},n.getMaxAttributesCount=function(){var e=0;return l.forEach((function(t){t.stats.attributesCount>e&&(e=t.stats.attributesCount)})),e}),{clear:function(){var t=e.deleteShader.bind(e);xt(i).forEach(t),i={},xt(o).forEach(t),o={},l.forEach((function(t){e.deleteProgram(t.program)})),l.length=0,c={},n.shaderCount=0},program:function(e,t,r,i){re.command(e>=0,"missing vertex shader",r),re.command(t>=0,"missing fragment shader",r);var o=c[t];o||(o=c[t]={});var a=o[e];if(a&&!i)return a;var s=new h(t,e);return n.shaderCount++,d(s,r,i),a||(o[e]=s),l.push(s),s},restore:p,shader:u,frag:-1,vert:-1}}var Yi=6408,Zi=5121,qi=3333,Ki=5126;function Qi(t,n,r,i,o,a,s){function u(u){var c;null===n.next?(re(o.preserveDrawingBuffer,'you must create a webgl context with "preserveDrawingBuffer":true in order to read pixels from the drawing buffer'),c=Zi):(re(null!==n.next.colorAttachments[0].texture,"You cannot read from a renderbuffer"),c=n.next.colorAttachments[0].texture._texture.type,a.oes_texture_float?(re(c===Zi||c===Ki,"Reading from a framebuffer is only allowed for the types 'uint8' and 'float'"),c===Ki&&re(s.readFloat,"Reading 'float' values is not permitted in your browser. For a fallback, please see: https://www.npmjs.com/package/glsl-read-float")):re(c===Zi,"Reading from a framebuffer is only allowed for the type 'uint8'"));var l=0,f=0,h=i.framebufferWidth,d=i.framebufferHeight,p=null;e(u)?p=u:u&&(re.type(u,"object","invalid arguments to regl.read()"),l=0|u.x,f=0|u.y,re(l>=0&&l<i.framebufferWidth,"invalid x offset for regl.read"),re(f>=0&&f<i.framebufferHeight,"invalid y offset for regl.read"),h=0|(u.width||i.framebufferWidth-l),d=0|(u.height||i.framebufferHeight-f),p=u.data||null),p&&(c===Zi?re(p instanceof Uint8Array,"buffer must be 'Uint8Array' when reading from a framebuffer of type 'uint8'"):c===Ki&&re(p instanceof Float32Array,"buffer must be 'Float32Array' when reading from a framebuffer of type 'float'")),re(h>0&&h+l<=i.framebufferWidth,"invalid width for read pixels"),re(d>0&&d+f<=i.framebufferHeight,"invalid height for read pixels"),r();var v=h*d*4;return p||(c===Zi?p=new Uint8Array(v):c===Ki&&(p=p||new Float32Array(v))),re.isTypedArray(p,"data buffer for regl.read() must be a typedarray"),re(p.byteLength>=v,"data buffer for regl.read() too small"),t.pixelStorei(qi,4),t.readPixels(l,f,h,d,Yi,c,p),p}function c(e){var t;return n.setFBO({framebuffer:e.framebuffer},(function(){t=u(e)})),t}function l(e){return e&&"framebuffer"in e?c(e):u(e)}return l}function $i(e){return Array.prototype.slice.call(e)}function Ji(e){return $i(e).join("")}function eo(){var e=0,n=[],r=[];function i(t){for(var i=0;i<r.length;++i)if(r[i]===t)return n[i];var o="g"+e++;return n.push(o),r.push(t),o}function o(){var n=[];function r(){n.push.apply(n,$i(arguments))}var i=[];function o(){var t="v"+e++;return i.push(t),arguments.length>0&&(n.push(t,"="),n.push.apply(n,$i(arguments)),n.push(";")),t}return t(r,{def:o,toString:function(){return Ji([i.length>0?"var "+i.join(",")+";":"",Ji(n)])}})}function a(){var e=o(),n=o(),r=e.toString,i=n.toString;function a(t,r){n(t,r,"=",e.def(t,r),";")}return t((function(){e.apply(e,$i(arguments))}),{def:e.def,entry:e,exit:n,save:a,set:function(t,n,r){a(t,n),e(t,n,"=",r,";")},toString:function(){return r()+i()}})}function s(){var e=Ji(arguments),n=a(),r=a(),i=n.toString,o=r.toString;return t(n,{then:function(){return n.apply(n,$i(arguments)),this},else:function(){return r.apply(r,$i(arguments)),this},toString:function(){var t=o();return t&&(t="else{"+t+"}"),Ji(["if(",e,"){",i(),"}",t])}})}var u=o(),c={};function l(e,n){var r=[];function i(){var e="a"+r.length;return r.push(e),e}n=n||0;for(var o=0;o<n;++o)i();var s=a(),u=s.toString;return c[e]=t(s,{arg:i,toString:function(){return Ji(["function(",r.join(),"){",u(),"}"])}})}function f(){var e=['"use strict";',u,"return {"];Object.keys(c).forEach((function(t){e.push('"',t,'":',c[t].toString(),",")})),e.push("}");var t=Ji(e).replace(/;/g,";\n").replace(/}/g,"}\n").replace(/{/g,"{\n");return Function.apply(null,n.concat(t)).apply(null,r)}return{global:u,link:i,block:o,proc:l,scope:a,cond:s,compile:f}}var to="xyzw".split(""),no=5121,ro=1,io=2,oo=0,ao=1,so=2,uo=3,co=4,lo="dither",fo="blend.enable",ho="blend.color",po="blend.equation",vo="blend.func",mo="depth.enable",go="depth.func",_o="depth.range",yo="depth.mask",Eo="colorMask",bo="cull.enable",Ao="cull.face",xo="frontFace",So="lineWidth",To="polygonOffset.enable",Ro="polygonOffset.offset",Co="sample.alpha",Mo="sample.enable",wo="sample.coverage",Lo="stencil.enable",Oo="stencil.mask",ko="stencil.func",No="stencil.opFront",Io="stencil.opBack",Po="scissor.enable",Do="scissor.box",Fo="viewport",Bo="profile",Uo="framebuffer",Go="vert",zo="frag",jo="elements",Vo="primitive",Ho="count",Xo="offset",Wo="instances",Yo="vao",Zo="Width",qo="Height",Ko=Uo+Zo,Qo=Uo+qo,$o=Fo+Zo,Jo=Fo+qo,ea="drawingBuffer",ta=ea+Zo,na=ea+qo,ra=[vo,po,ko,No,Io,wo,Fo,Do,Ro],ia=34962,oa=34963,aa=3553,sa=34067,ua=2884,ca=3042,la=3024,fa=2960,ha=2929,da=3089,pa=32823,va=32926,ma=32928,ga=5126,_a=35664,ya=35665,Ea=35666,ba=5124,Aa=35667,xa=35668,Sa=35669,Ta=35670,Ra=35671,Ca=35672,Ma=35673,wa=35674,La=35675,Oa=35676,ka=35678,Na=35680,Ia=4,Pa=1028,Da=1029,Fa=2304,Ba=2305,Ua=32775,Ga=32776,za=519,ja=7680,Va=0,Ha=1,Xa=32774,Wa=513,Ya=36160,Za=36064,qa={0:0,1:1,zero:0,one:1,"src color":768,"one minus src color":769,"src alpha":770,"one minus src alpha":771,"dst color":774,"one minus dst color":775,"dst alpha":772,"one minus dst alpha":773,"constant color":32769,"one minus constant color":32770,"constant alpha":32771,"one minus constant alpha":32772,"src alpha saturate":776},Ka=["constant color, constant alpha","one minus constant color, constant alpha","constant color, one minus constant alpha","one minus constant color, one minus constant alpha","constant alpha, constant color","constant alpha, one minus constant color","one minus constant alpha, constant color","one minus constant alpha, one minus constant color"],Qa={never:512,less:513,"<":513,equal:514,"=":514,"==":514,"===":514,lequal:515,"<=":515,greater:516,">":516,notequal:517,"!=":517,"!==":517,gequal:518,">=":518,always:519},$a={0:0,zero:0,keep:7680,replace:7681,increment:7682,decrement:7683,"increment wrap":34055,"decrement wrap":34056,invert:5386},Ja={frag:35632,vert:35633},es={cw:Fa,ccw:Ba};function ts(t){return Array.isArray(t)||e(t)||At(t)}function ns(e){return e.sort((function(e,t){return e===Fo?-1:t===Fo?1:e<t?-1:1}))}function rs(e,t,n,r){this.thisDep=e,this.contextDep=t,this.propDep=n,this.append=r}function is(e){return e&&!(e.thisDep||e.contextDep||e.propDep)}function os(e){return new rs(!1,!1,!1,e)}function as(e,t){var n=e.type;if(n===oo){var r=e.data.length;return new rs(!0,r>=1,r>=2,t)}if(n===co){var i=e.data;return new rs(i.thisDep,i.contextDep,i.propDep,t)}return new rs(n===uo,n===so,n===ao,t)}var ss=new rs(!1,!1,!1,(function(){}));function us(e,t,n,r,i,o,a,u,c,l,f,h,d,p,v){var m=l.Record,g={add:32774,subtract:32778,"reverse subtract":32779};n.ext_blend_minmax&&(g.min=Ua,g.max=Ga);var _=n.angle_instanced_arrays,y=n.webgl_draw_buffers,E={dirty:!0,profile:v.profile},b={},A=[],x={},S={};function T(e){return e.replace(".","_")}function R(e,t,n){var r=T(e);A.push(e),b[r]=E[r]=!!n,x[r]=t}function C(e,t,n){var r=T(e);A.push(e),Array.isArray(n)?(E[r]=n.slice(),b[r]=n.slice()):E[r]=b[r]=n,S[r]=t}R(lo,la),R(fo,ca),C(ho,"blendColor",[0,0,0,0]),C(po,"blendEquationSeparate",[Xa,Xa]),C(vo,"blendFuncSeparate",[Ha,Va,Ha,Va]),R(mo,ha,!0),C(go,"depthFunc",Wa),C(_o,"depthRange",[0,1]),C(yo,"depthMask",!0),C(Eo,Eo,[!0,!0,!0,!0]),R(bo,ua),C(Ao,"cullFace",Da),C(xo,xo,Ba),C(So,So,1),R(To,pa),C(Ro,"polygonOffset",[0,0]),R(Co,va),R(Mo,ma),C(wo,"sampleCoverage",[1,!1]),R(Lo,fa),C(Oo,"stencilMask",-1),C(ko,"stencilFunc",[za,0,-1]),C(No,"stencilOpSeparate",[Pa,ja,ja,ja]),C(Io,"stencilOpSeparate",[Da,ja,ja,ja]),R(Po,da),C(Do,"scissor",[0,0,e.drawingBufferWidth,e.drawingBufferHeight]),C(Fo,Fo,[0,0,e.drawingBufferWidth,e.drawingBufferHeight]);var M={gl:e,context:d,strings:t,next:b,current:E,draw:h,elements:o,buffer:i,shader:f,attributes:l.state,vao:l,uniforms:c,framebuffer:u,extensions:n,timer:p,isBufferArgs:ts},w={primTypes:Wt,compareFuncs:Qa,blendFuncs:qa,blendEquations:g,stencilOps:$a,glTypes:kt,orientationType:es};re.optional((function(){M.isArrayLike=fn})),y&&(w.backBuffer=[Da],w.drawBuffer=Te(r.maxDrawbuffers,(function(e){return 0===e?[0]:Te(e,(function(e){return Za+e}))})));var L=0;function O(){var e=eo(),n=e.link,r=e.global;e.id=L++,e.batchId="0";var i=n(M),o=e.shared={props:"a0"};Object.keys(M).forEach((function(e){o[e]=r.def(i,".",e)})),re.optional((function(){e.CHECK=n(re),e.commandStr=re.guessCommand(),e.command=n(e.commandStr),e.assert=function(e,t,r){e("if(!(",t,"))",this.CHECK,".commandRaise(",n(r),",",this.command,");")},w.invalidBlendCombinations=Ka}));var a=e.next={},s=e.current={};Object.keys(S).forEach((function(e){Array.isArray(E[e])&&(a[e]=r.def(o.next,".",e),s[e]=r.def(o.current,".",e))}));var u=e.constants={};Object.keys(w).forEach((function(e){u[e]=r.def(JSON.stringify(w[e]))})),e.invoke=function(t,r){switch(r.type){case oo:var i=["this",o.context,o.props,e.batchId];return t.def(n(r.data),".call(",i.slice(0,Math.max(r.data.length+1,4)),")");case ao:return t.def(o.props,r.data);case so:return t.def(o.context,r.data);case uo:return t.def("this",r.data);case co:return r.data.append(e,t),r.data.ref}},e.attribCache={};var c={};return e.scopeAttrib=function(e){var r=t.id(e);if(r in c)return c[r];var i=l.scope[r];return i||(i=l.scope[r]=new m),c[r]=n(i)},e}function k(e){var t,n=e.static,r=e.dynamic;if(Bo in n){var i=!!n[Bo];(t=os((function(e,t){return i}))).enable=i}else if(Bo in r){var o=r[Bo];t=as(o,(function(e,t){return e.invoke(t,o)}))}return t}function N(e,t){var n=e.static,r=e.dynamic;if(Uo in n){var i=n[Uo];return i?(i=u.getFramebuffer(i),re.command(i,"invalid framebuffer object"),os((function(e,t){var n=e.link(i),r=e.shared;t.set(r.framebuffer,".next",n);var o=r.context;return t.set(o,"."+Ko,n+".width"),t.set(o,"."+Qo,n+".height"),n}))):os((function(e,t){var n=e.shared;t.set(n.framebuffer,".next","null");var r=n.context;return t.set(r,"."+Ko,r+"."+ta),t.set(r,"."+Qo,r+"."+na),"null"}))}if(Uo in r){var o=r[Uo];return as(o,(function(e,t){var n=e.invoke(t,o),r=e.shared,i=r.framebuffer,a=t.def(i,".getFramebuffer(",n,")");re.optional((function(){e.assert(t,"!"+n+"||"+a,"invalid framebuffer object")})),t.set(i,".next",a);var s=r.context;return t.set(s,"."+Ko,a+"?"+a+".width:"+s+"."+ta),t.set(s,"."+Qo,a+"?"+a+".height:"+s+"."+na),a}))}return null}function I(e,t,n){var r=e.static,i=e.dynamic;function o(e){if(e in r){var o=r[e];re.commandType(o,"object","invalid "+e,n.commandStr);var a,s,u=!0,c=0|o.x,l=0|o.y;return"width"in o?(a=0|o.width,re.command(a>=0,"invalid "+e,n.commandStr)):u=!1,"height"in o?(s=0|o.height,re.command(s>=0,"invalid "+e,n.commandStr)):u=!1,new rs(!u&&t&&t.thisDep,!u&&t&&t.contextDep,!u&&t&&t.propDep,(function(e,t){var n=e.shared.context,r=a;"width"in o||(r=t.def(n,".",Ko,"-",c));var i=s;return"height"in o||(i=t.def(n,".",Qo,"-",l)),[c,l,r,i]}))}if(e in i){var f=i[e],h=as(f,(function(t,n){var r=t.invoke(n,f);re.optional((function(){t.assert(n,r+"&&typeof "+r+'==="object"',"invalid "+e)}));var i=t.shared.context,o=n.def(r,".x|0"),a=n.def(r,".y|0"),s=n.def('"width" in ',r,"?",r,".width|0:","(",i,".",Ko,"-",o,")"),u=n.def('"height" in ',r,"?",r,".height|0:","(",i,".",Qo,"-",a,")");return re.optional((function(){t.assert(n,s+">=0&&"+u+">=0","invalid "+e)})),[o,a,s,u]}));return t&&(h.thisDep=h.thisDep||t.thisDep,h.contextDep=h.contextDep||t.contextDep,h.propDep=h.propDep||t.propDep),h}return t?new rs(t.thisDep,t.contextDep,t.propDep,(function(e,t){var n=e.shared.context;return[0,0,t.def(n,".",Ko),t.def(n,".",Qo)]})):null}var a=o(Fo);if(a){var s=a;a=new rs(a.thisDep,a.contextDep,a.propDep,(function(e,t){var n=s.append(e,t),r=e.shared.context;return t.set(r,"."+$o,n[2]),t.set(r,"."+Jo,n[3]),n}))}return{viewport:a,scissor_box:o(Do)}}function P(e,t){var n=e.static;if("string"==typeof n[zo]&&"string"==typeof n[Go]){if(Object.keys(t.dynamic).length>0)return null;var r=t.static,i=Object.keys(r);if(i.length>0&&"number"==typeof r[i[0]]){for(var o=[],a=0;a<i.length;++a)re("number"==typeof r[i[a]],"must specify all vertex attribute locations when using vaos"),o.push([0|r[i[a]],i[a]]);return o}}return null}function D(e,n,r){var i=e.static,o=e.dynamic;function a(e){if(e in i){var n=t.id(i[e]);re.optional((function(){f.shader(Ja[e],n,re.guessCommand())}));var r=os((function(){return n}));return r.id=n,r}if(e in o){var a=o[e];return as(a,(function(t,n){var r=t.invoke(n,a),i=n.def(t.shared.strings,".id(",r,")");return re.optional((function(){n(t.shared.shader,".shader(",Ja[e],",",i,",",t.command,");")})),i}))}return null}var s,u=a(zo),c=a(Go),l=null;return is(u)&&is(c)?(l=f.program(c.id,u.id,null,r),s=os((function(e,t){return e.link(l)}))):s=new rs(u&&u.thisDep||c&&c.thisDep,u&&u.contextDep||c&&c.contextDep,u&&u.propDep||c&&c.propDep,(function(e,t){var n,r=e.shared.shader;n=u?u.append(e,t):t.def(r,".",zo);var i=r+".program("+(c?c.append(e,t):t.def(r,".",Go))+","+n;return re.optional((function(){i+=","+e.command})),t.def(i+")")})),{frag:u,vert:c,progVar:s,program:l}}function F(e,t){var n=e.static,r=e.dynamic;function i(){if(jo in n){var e=n[jo];ts(e)?e=o.getElements(o.create(e,!0)):e&&(e=o.getElements(e),re.command(e,"invalid elements",t.commandStr));var i=os((function(t,n){if(e){var r=t.link(e);return t.ELEMENTS=r,r}return t.ELEMENTS=null,null}));return i.value=e,i}if(jo in r){var a=r[jo];return as(a,(function(e,t){var n=e.shared,r=n.isBufferArgs,i=n.elements,o=e.invoke(t,a),s=t.def("null"),u=t.def(r,"(",o,")"),c=e.cond(u).then(s,"=",i,".createStream(",o,");").else(s,"=",i,".getElements(",o,");");return re.optional((function(){e.assert(c.else,"!"+o+"||"+s,"invalid elements")})),t.entry(c),t.exit(e.cond(u).then(i,".destroyStream(",s,");")),e.ELEMENTS=s,s}))}return null}var a=i();function s(){if(Vo in n){var e=n[Vo];return re.commandParameter(e,Wt,"invalid primitve",t.commandStr),os((function(t,n){return Wt[e]}))}if(Vo in r){var i=r[Vo];return as(i,(function(e,t){var n=e.constants.primTypes,r=e.invoke(t,i);return re.optional((function(){e.assert(t,r+" in "+n,"invalid primitive, must be one of "+Object.keys(Wt))})),t.def(n,"[",r,"]")}))}return a?is(a)?a.value?os((function(e,t){return t.def(e.ELEMENTS,".primType")})):os((function(){return Ia})):new rs(a.thisDep,a.contextDep,a.propDep,(function(e,t){var n=e.ELEMENTS;return t.def(n,"?",n,".primType:",Ia)})):null}function u(e,i){if(e in n){var o=0|n[e];return re.command(!i||o>=0,"invalid "+e,t.commandStr),os((function(e,t){return i&&(e.OFFSET=o),o}))}if(e in r){var s=r[e];return as(s,(function(t,n){var r=t.invoke(n,s);return i&&(t.OFFSET=r,re.optional((function(){t.assert(n,r+">=0","invalid "+e)}))),r}))}return i&&a?os((function(e,t){return e.OFFSET="0",0})):null}var c=u(Xo,!0);function l(){if(Ho in n){var e=0|n[Ho];return re.command("number"==typeof e&&e>=0,"invalid vertex count",t.commandStr),os((function(){return e}))}if(Ho in r){var i=r[Ho];return as(i,(function(e,t){var n=e.invoke(t,i);return re.optional((function(){e.assert(t,"typeof "+n+'==="number"&&'+n+">=0&&"+n+"===("+n+"|0)","invalid vertex count")})),n}))}if(a){if(is(a)){if(a)return c?new rs(c.thisDep,c.contextDep,c.propDep,(function(e,t){var n=t.def(e.ELEMENTS,".vertCount-",e.OFFSET);return re.optional((function(){e.assert(t,n+">=0","invalid vertex offset/element buffer too small")})),n})):os((function(e,t){return t.def(e.ELEMENTS,".vertCount")}));var o=os((function(){return-1}));return re.optional((function(){o.MISSING=!0})),o}var s=new rs(a.thisDep||c.thisDep,a.contextDep||c.contextDep,a.propDep||c.propDep,(function(e,t){var n=e.ELEMENTS;return e.OFFSET?t.def(n,"?",n,".vertCount-",e.OFFSET,":-1"):t.def(n,"?",n,".vertCount:-1")}));return re.optional((function(){s.DYNAMIC=!0})),s}return null}return{elements:a,primitive:s(),count:l(),instances:u(Wo,!1),offset:c}}function B(e,t){var n=e.static,i=e.dynamic,o={};return A.forEach((function(e){var a=T(e);function u(t,r){if(e in n){var s=t(n[e]);o[a]=os((function(){return s}))}else if(e in i){var u=i[e];o[a]=as(u,(function(e,t){return r(e,t,e.invoke(t,u))}))}}switch(e){case bo:case fo:case lo:case Lo:case mo:case Po:case To:case Co:case Mo:case yo:return u((function(n){return re.commandType(n,"boolean",e,t.commandStr),n}),(function(t,n,r){return re.optional((function(){t.assert(n,"typeof "+r+'==="boolean"',"invalid flag "+e,t.commandStr)})),r}));case go:return u((function(n){return re.commandParameter(n,Qa,"invalid "+e,t.commandStr),Qa[n]}),(function(t,n,r){var i=t.constants.compareFuncs;return re.optional((function(){t.assert(n,r+" in "+i,"invalid "+e+", must be one of "+Object.keys(Qa))})),n.def(i,"[",r,"]")}));case _o:return u((function(e){return re.command(fn(e)&&2===e.length&&"number"==typeof e[0]&&"number"==typeof e[1]&&e[0]<=e[1],"depth range is 2d array",t.commandStr),e}),(function(e,t,n){return re.optional((function(){e.assert(t,e.shared.isArrayLike+"("+n+")&&"+n+".length===2&&typeof "+n+'[0]==="number"&&typeof '+n+'[1]==="number"&&'+n+"[0]<="+n+"[1]","depth range must be a 2d array")})),[t.def("+",n,"[0]"),t.def("+",n,"[1]")]}));case vo:return u((function(e){re.commandType(e,"object","blend.func",t.commandStr);var n="srcRGB"in e?e.srcRGB:e.src,r="srcAlpha"in e?e.srcAlpha:e.src,i="dstRGB"in e?e.dstRGB:e.dst,o="dstAlpha"in e?e.dstAlpha:e.dst;return re.commandParameter(n,qa,a+".srcRGB",t.commandStr),re.commandParameter(r,qa,a+".srcAlpha",t.commandStr),re.commandParameter(i,qa,a+".dstRGB",t.commandStr),re.commandParameter(o,qa,a+".dstAlpha",t.commandStr),re.command(-1===Ka.indexOf(n+", "+i),"unallowed blending combination (srcRGB, dstRGB) = ("+n+", "+i+")",t.commandStr),[qa[n],qa[i],qa[r],qa[o]]}),(function(t,n,r){var i=t.constants.blendFuncs;function o(o,a){var s=n.def('"',o,a,'" in ',r,"?",r,".",o,a,":",r,".",o);return re.optional((function(){t.assert(n,s+" in "+i,"invalid "+e+"."+o+a+", must be one of "+Object.keys(qa))})),s}re.optional((function(){t.assert(n,r+"&&typeof "+r+'==="object"',"invalid blend func, must be an object")}));var a=o("src","RGB"),s=o("dst","RGB");re.optional((function(){var e=t.constants.invalidBlendCombinations;t.assert(n,e+".indexOf("+a+'+", "+'+s+") === -1 ","unallowed blending combination for (srcRGB, dstRGB)")}));var u=n.def(i,"[",a,"]"),c=n.def(i,"[",o("src","Alpha"),"]");return[u,n.def(i,"[",s,"]"),c,n.def(i,"[",o("dst","Alpha"),"]")]}));case po:return u((function(n){return"string"==typeof n?(re.commandParameter(n,g,"invalid "+e,t.commandStr),[g[n],g[n]]):"object"===s(n)?(re.commandParameter(n.rgb,g,e+".rgb",t.commandStr),re.commandParameter(n.alpha,g,e+".alpha",t.commandStr),[g[n.rgb],g[n.alpha]]):void re.commandRaise("invalid blend.equation",t.commandStr)}),(function(t,n,r){var i=t.constants.blendEquations,o=n.def(),a=n.def(),s=t.cond("typeof ",r,'==="string"');return re.optional((function(){function n(e,n,r){t.assert(e,r+" in "+i,"invalid "+n+", must be one of "+Object.keys(g))}n(s.then,e,r),t.assert(s.else,r+"&&typeof "+r+'==="object"',"invalid "+e),n(s.else,e+".rgb",r+".rgb"),n(s.else,e+".alpha",r+".alpha")})),s.then(o,"=",a,"=",i,"[",r,"];"),s.else(o,"=",i,"[",r,".rgb];",a,"=",i,"[",r,".alpha];"),n(s),[o,a]}));case ho:return u((function(e){return re.command(fn(e)&&4===e.length,"blend.color must be a 4d array",t.commandStr),Te(4,(function(t){return+e[t]}))}),(function(e,t,n){return re.optional((function(){e.assert(t,e.shared.isArrayLike+"("+n+")&&"+n+".length===4","blend.color must be a 4d array")})),Te(4,(function(e){return t.def("+",n,"[",e,"]")}))}));case Oo:return u((function(e){return re.commandType(e,"number",a,t.commandStr),0|e}),(function(e,t,n){return re.optional((function(){e.assert(t,"typeof "+n+'==="number"',"invalid stencil.mask")})),t.def(n,"|0")}));case ko:return u((function(n){re.commandType(n,"object",a,t.commandStr);var r=n.cmp||"keep",i=n.ref||0,o="mask"in n?n.mask:-1;return re.commandParameter(r,Qa,e+".cmp",t.commandStr),re.commandType(i,"number",e+".ref",t.commandStr),re.commandType(o,"number",e+".mask",t.commandStr),[Qa[r],i,o]}),(function(e,t,n){var r=e.constants.compareFuncs;return re.optional((function(){function i(){e.assert(t,Array.prototype.join.call(arguments,""),"invalid stencil.func")}i(n+"&&typeof ",n,'==="object"'),i('!("cmp" in ',n,")||(",n,".cmp in ",r,")")})),[t.def('"cmp" in ',n,"?",r,"[",n,".cmp]",":",ja),t.def(n,".ref|0"),t.def('"mask" in ',n,"?",n,".mask|0:-1")]}));case No:case Io:return u((function(n){re.commandType(n,"object",a,t.commandStr);var r=n.fail||"keep",i=n.zfail||"keep",o=n.zpass||"keep";return re.commandParameter(r,$a,e+".fail",t.commandStr),re.commandParameter(i,$a,e+".zfail",t.commandStr),re.commandParameter(o,$a,e+".zpass",t.commandStr),[e===Io?Da:Pa,$a[r],$a[i],$a[o]]}),(function(t,n,r){var i=t.constants.stencilOps;function o(o){return re.optional((function(){t.assert(n,'!("'+o+'" in '+r+")||("+r+"."+o+" in "+i+")","invalid "+e+"."+o+", must be one of "+Object.keys($a))})),n.def('"',o,'" in ',r,"?",i,"[",r,".",o,"]:",ja)}return re.optional((function(){t.assert(n,r+"&&typeof "+r+'==="object"',"invalid "+e)})),[e===Io?Da:Pa,o("fail"),o("zfail"),o("zpass")]}));case Ro:return u((function(e){re.commandType(e,"object",a,t.commandStr);var n=0|e.factor,r=0|e.units;return re.commandType(n,"number",a+".factor",t.commandStr),re.commandType(r,"number",a+".units",t.commandStr),[n,r]}),(function(t,n,r){return re.optional((function(){t.assert(n,r+"&&typeof "+r+'==="object"',"invalid "+e)})),[n.def(r,".factor|0"),n.def(r,".units|0")]}));case Ao:return u((function(e){var n=0;return"front"===e?n=Pa:"back"===e&&(n=Da),re.command(!!n,a,t.commandStr),n}),(function(e,t,n){return re.optional((function(){e.assert(t,n+'==="front"||'+n+'==="back"',"invalid cull.face")})),t.def(n,'==="front"?',Pa,":",Da)}));case So:return u((function(e){return re.command("number"==typeof e&&e>=r.lineWidthDims[0]&&e<=r.lineWidthDims[1],"invalid line width, must be a positive number between "+r.lineWidthDims[0]+" and "+r.lineWidthDims[1],t.commandStr),e}),(function(e,t,n){return re.optional((function(){e.assert(t,"typeof "+n+'==="number"&&'+n+">="+r.lineWidthDims[0]+"&&"+n+"<="+r.lineWidthDims[1],"invalid line width")})),n}));case xo:return u((function(e){return re.commandParameter(e,es,a,t.commandStr),es[e]}),(function(e,t,n){return re.optional((function(){e.assert(t,n+'==="cw"||'+n+'==="ccw"',"invalid frontFace, must be one of cw,ccw")})),t.def(n+'==="cw"?'+Fa+":"+Ba)}));case Eo:return u((function(e){return re.command(fn(e)&&4===e.length,"color.mask must be length 4 array",t.commandStr),e.map((function(e){return!!e}))}),(function(e,t,n){return re.optional((function(){e.assert(t,e.shared.isArrayLike+"("+n+")&&"+n+".length===4","invalid color.mask")})),Te(4,(function(e){return"!!"+n+"["+e+"]"}))}));case wo:return u((function(e){re.command("object"===s(e)&&e,a,t.commandStr);var n="value"in e?e.value:1,r=!!e.invert;return re.command("number"==typeof n&&n>=0&&n<=1,"sample.coverage.value must be a number between 0 and 1",t.commandStr),[n,r]}),(function(e,t,n){return re.optional((function(){e.assert(t,n+"&&typeof "+n+'==="object"',"invalid sample.coverage")})),[t.def('"value" in ',n,"?+",n,".value:1"),t.def("!!",n,".invert")]}))}})),o}function U(e,t){var n=e.static,r=e.dynamic,i={};return Object.keys(n).forEach((function(e){var r,o=n[e];if("number"==typeof o||"boolean"==typeof o)r=os((function(){return o}));else if("function"==typeof o){var a=o._reglType;"texture2d"===a||"textureCube"===a?r=os((function(e){return e.link(o)})):"framebuffer"===a||"framebufferCube"===a?(re.command(o.color.length>0,'missing color attachment for framebuffer sent to uniform "'+e+'"',t.commandStr),r=os((function(e){return e.link(o.color[0])}))):re.commandRaise('invalid data for uniform "'+e+'"',t.commandStr)}else fn(o)?r=os((function(t){return t.global.def("[",Te(o.length,(function(n){return re.command("number"==typeof o[n]||"boolean"==typeof o[n],"invalid uniform "+e,t.commandStr),o[n]})),"]")})):re.commandRaise('invalid or missing data for uniform "'+e+'"',t.commandStr);r.value=o,i[e]=r})),Object.keys(r).forEach((function(e){var t=r[e];i[e]=as(t,(function(e,n){return e.invoke(n,t)}))})),i}function G(e,n){var r=e.static,o=e.dynamic,a={};return Object.keys(r).forEach((function(e){var o=r[e],u=t.id(e),c=new m;if(ts(o))c.state=ro,c.buffer=i.getBuffer(i.create(o,ia,!1,!0)),c.type=0;else{var l=i.getBuffer(o);if(l)c.state=ro,c.buffer=l,c.type=0;else if(re.command("object"===s(o)&&o,"invalid data for attribute "+e,n.commandStr),"constant"in o){var f=o.constant;c.buffer="null",c.state=io,"number"==typeof f?c.x=f:(re.command(fn(f)&&f.length>0&&f.length<=4,"invalid constant for attribute "+e,n.commandStr),to.forEach((function(e,t){t<f.length&&(c[e]=f[t])})))}else{l=ts(o.buffer)?i.getBuffer(i.create(o.buffer,ia,!1,!0)):i.getBuffer(o.buffer),re.command(!!l,'missing buffer for attribute "'+e+'"',n.commandStr);var h=0|o.offset;re.command(h>=0,'invalid offset for attribute "'+e+'"',n.commandStr);var d=0|o.stride;re.command(d>=0&&d<256,'invalid stride for attribute "'+e+'", must be integer betweeen [0, 255]',n.commandStr);var p=0|o.size;re.command(!("size"in o)||p>0&&p<=4,'invalid size for attribute "'+e+'", must be 1,2,3,4',n.commandStr);var v=!!o.normalized,g=0;"type"in o&&(re.commandParameter(o.type,kt,"invalid type for attribute "+e,n.commandStr),g=kt[o.type]);var y=0|o.divisor;"divisor"in o&&(re.command(0===y||_,'cannot specify divisor for attribute "'+e+'", instancing not supported',n.commandStr),re.command(y>=0,'invalid divisor for attribute "'+e+'"',n.commandStr)),re.optional((function(){var t=n.commandStr,r=["buffer","offset","divisor","normalized","type","size","stride"];Object.keys(o).forEach((function(n){re.command(r.indexOf(n)>=0,'unknown parameter "'+n+'" for attribute pointer "'+e+'" (valid parameters are '+r+")",t)}))})),c.buffer=l,c.state=ro,c.size=p,c.normalized=v,c.type=g||l.dtype,c.offset=h,c.stride=d,c.divisor=y}}a[e]=os((function(e,t){var n=e.attribCache;if(u in n)return n[u];var r={isStream:!1};return Object.keys(c).forEach((function(e){r[e]=c[e]})),c.buffer&&(r.buffer=e.link(c.buffer),r.type=r.type||r.buffer+".dtype"),n[u]=r,r}))})),Object.keys(o).forEach((function(e){var t=o[e];function n(n,r){var i=n.invoke(r,t),o=n.shared,a=n.constants,s=o.isBufferArgs,u=o.buffer;re.optional((function(){n.assert(r,i+"&&(typeof "+i+'==="object"||typeof '+i+'==="function")&&('+s+"("+i+")||"+u+".getBuffer("+i+")||"+u+".getBuffer("+i+".buffer)||"+s+"("+i+'.buffer)||("constant" in '+i+"&&(typeof "+i+'.constant==="number"||'+o.isArrayLike+"("+i+".constant))))",'invalid dynamic attribute "'+e+'"')}));var c={isStream:r.def(!1)},l=new m;l.state=ro,Object.keys(l).forEach((function(e){c[e]=r.def(""+l[e])}));var f=c.buffer,h=c.type;function d(e){r(c[e],"=",i,".",e,"|0;")}return r("if(",s,"(",i,")){",c.isStream,"=true;",f,"=",u,".createStream(",ia,",",i,");",h,"=",f,".dtype;","}else{",f,"=",u,".getBuffer(",i,");","if(",f,"){",h,"=",f,".dtype;",'}else if("constant" in ',i,"){",c.state,"=",io,";","if(typeof "+i+'.constant === "number"){',c[to[0]],"=",i,".constant;",to.slice(1).map((function(e){return c[e]})).join("="),"=0;","}else{",to.map((function(e,t){return c[e]+"="+i+".constant.length>"+t+"?"+i+".constant["+t+"]:0;"})).join(""),"}}else{","if(",s,"(",i,".buffer)){",f,"=",u,".createStream(",ia,",",i,".buffer);","}else{",f,"=",u,".getBuffer(",i,".buffer);","}",h,'="type" in ',i,"?",a.glTypes,"[",i,".type]:",f,".dtype;",c.normalized,"=!!",i,".normalized;"),d("size"),d("offset"),d("stride"),d("divisor"),r("}}"),r.exit("if(",c.isStream,"){",u,".destroyStream(",f,");","}"),c}a[e]=as(t,n)})),a}function z(e,t){var n=e.static,r=e.dynamic;if(Yo in n){var i=n[Yo];return null!==i&&null===l.getVAO(i)&&(i=l.createVAO(i)),os((function(e){return e.link(l.getVAO(i))}))}if(Yo in r){var o=r[Yo];return as(o,(function(e,t){var n=e.invoke(t,o);return t.def(e.shared.vao+".getVAO("+n+")")}))}return null}function j(e){var t=e.static,n=e.dynamic,r={};return Object.keys(t).forEach((function(e){var n=t[e];r[e]=os((function(e,t){return"number"==typeof n||"boolean"==typeof n?""+n:e.link(n)}))})),Object.keys(n).forEach((function(e){var t=n[e];r[e]=as(t,(function(e,n){return e.invoke(n,t)}))})),r}function V(e,t,r,i,o){var a=e.static,s=e.dynamic;re.optional((function(){var e=[Uo,Go,zo,jo,Vo,Xo,Ho,Wo,Bo,Yo].concat(A);function t(t){Object.keys(t).forEach((function(t){re.command(e.indexOf(t)>=0,'unknown parameter "'+t+'"',o.commandStr)}))}t(a),t(s)}));var u=P(e,t),c=N(e),f=I(e,c,o),h=F(e,o),d=B(e,o),p=D(e,o,u);function v(e){var t=f[e];t&&(d[e]=t)}v(Fo),v(T(Do));var m=Object.keys(d).length>0,g={framebuffer:c,draw:h,shader:p,state:d,dirty:m,scopeVAO:null,drawVAO:null,useVAO:!1,attributes:{}};if(g.profile=k(e),g.uniforms=U(r,o),g.drawVAO=g.scopeVAO=z(e),!g.drawVAO&&p.program&&!u&&n.angle_instanced_arrays){var _=!0,y=p.program.attributes.map((function(e){var n=t.static[e];return _=_&&!!n,n}));if(_&&y.length>0){var E=l.getVAO(l.createVAO(y));g.drawVAO=new rs(null,null,null,(function(e,t){return e.link(E)})),g.useVAO=!0}}return u?g.useVAO=!0:g.attributes=G(t,o),g.context=j(i),g}function H(e,t,n){var r=e.shared.context,i=e.scope();Object.keys(n).forEach((function(o){t.save(r,"."+o);var a=n[o];i(r,".",o,"=",a.append(e,t),";")})),t(i)}function X(e,t,n,r){var i,o=e.shared,a=o.gl,s=o.framebuffer;y&&(i=t.def(o.extensions,".webgl_draw_buffers"));var u,c=e.constants,l=c.drawBuffer,f=c.backBuffer;u=n?n.append(e,t):t.def(s,".next"),r||t("if(",u,"!==",s,".cur){"),t("if(",u,"){",a,".bindFramebuffer(",Ya,",",u,".framebuffer);"),y&&t(i,".drawBuffersWEBGL(",l,"[",u,".colorAttachments.length]);"),t("}else{",a,".bindFramebuffer(",Ya,",null);"),y&&t(i,".drawBuffersWEBGL(",f,");"),t("}",s,".cur=",u,";"),r||t("}")}function W(e,t,n){var r=e.shared,i=r.gl,o=e.current,a=e.next,s=r.current,u=r.next,c=e.cond(s,".dirty");A.forEach((function(t){var r,l,f=T(t);if(!(f in n.state))if(f in a){r=a[f],l=o[f];var h=Te(E[f].length,(function(e){return c.def(r,"[",e,"]")}));c(e.cond(h.map((function(e,t){return e+"!=="+l+"["+t+"]"})).join("||")).then(i,".",S[f],"(",h,");",h.map((function(e,t){return l+"["+t+"]="+e})).join(";"),";"))}else{r=c.def(u,".",f);var d=e.cond(r,"!==",s,".",f);c(d),f in x?d(e.cond(r).then(i,".enable(",x[f],");").else(i,".disable(",x[f],");"),s,".",f,"=",r,";"):d(i,".",S[f],"(",r,");",s,".",f,"=",r,";")}})),0===Object.keys(n.state).length&&c(s,".dirty=false;"),t(c)}function Y(e,t,n,r){var i=e.shared,o=e.current,a=i.current,s=i.gl;ns(Object.keys(n)).forEach((function(i){var u=n[i];if(!r||r(u)){var c=u.append(e,t);if(x[i]){var l=x[i];is(u)?t(s,c?".enable(":".disable(",l,");"):t(e.cond(c).then(s,".enable(",l,");").else(s,".disable(",l,");")),t(a,".",i,"=",c,";")}else if(fn(c)){var f=o[i];t(s,".",S[i],"(",c,");",c.map((function(e,t){return f+"["+t+"]="+e})).join(";"),";")}else t(s,".",S[i],"(",c,");",a,".",i,"=",c,";")}}))}function Z(e,t){_&&(e.instancing=t.def(e.shared.extensions,".angle_instanced_arrays"))}function q(e,t,n,r,i){var o,a,s,u=e.shared,c=e.stats,l=u.current,f=u.timer,h=n.profile;function d(){return"undefined"==typeof performance?"Date.now()":"performance.now()"}function v(e){e(o=t.def(),"=",d(),";"),"string"==typeof i?e(c,".count+=",i,";"):e(c,".count++;"),p&&(r?e(a=t.def(),"=",f,".getNumPendingQueries();"):e(f,".beginQuery(",c,");"))}function m(e){e(c,".cpuTime+=",d(),"-",o,";"),p&&(r?e(f,".pushScopeStats(",a,",",f,".getNumPendingQueries(),",c,");"):e(f,".endQuery();"))}function g(e){var n=t.def(l,".profile");t(l,".profile=",e,";"),t.exit(l,".profile=",n,";")}if(h){if(is(h))return void(h.enable?(v(t),m(t.exit),g("true")):g("false"));g(s=h.append(e,t))}else s=t.def(l,".profile");var _=e.block();v(_),t("if(",s,"){",_,"}");var y=e.block();m(y),t.exit("if(",s,"){",y,"}")}function K(e,t,n,r,i){var o=e.shared;function a(e){switch(e){case _a:case Aa:case Ra:return 2;case ya:case xa:case Ca:return 3;case Ea:case Sa:case Ma:return 4;default:return 1}}function s(n,r,i){var a=o.gl,s=t.def(n,".location"),u=t.def(o.attributes,"[",s,"]"),c=i.state,l=i.buffer,f=[i.x,i.y,i.z,i.w],h=["buffer","normalized","offset","stride"];function d(){t("if(!",u,".buffer){",a,".enableVertexAttribArray(",s,");}");var n,o=i.type;if(n=i.size?t.def(i.size,"||",r):r,t("if(",u,".type!==",o,"||",u,".size!==",n,"||",h.map((function(e){return u+"."+e+"!=="+i[e]})).join("||"),"){",a,".bindBuffer(",ia,",",l,".buffer);",a,".vertexAttribPointer(",[s,n,o,i.normalized,i.stride,i.offset],");",u,".type=",o,";",u,".size=",n,";",h.map((function(e){return u+"."+e+"="+i[e]+";"})).join(""),"}"),_){var c=i.divisor;t("if(",u,".divisor!==",c,"){",e.instancing,".vertexAttribDivisorANGLE(",[s,c],");",u,".divisor=",c,";}")}}function p(){t("if(",u,".buffer){",a,".disableVertexAttribArray(",s,");",u,".buffer=null;","}if(",to.map((function(e,t){return u+"."+e+"!=="+f[t]})).join("||"),"){",a,".vertexAttrib4f(",s,",",f,");",to.map((function(e,t){return u+"."+e+"="+f[t]+";"})).join(""),"}")}c===ro?d():c===io?p():(t("if(",c,"===",ro,"){"),d(),t("}else{"),p(),t("}"))}r.forEach((function(r){var o,u=r.name,c=n.attributes[u];if(c){if(!i(c))return;o=c.append(e,t)}else{if(!i(ss))return;var l=e.scopeAttrib(u);re.optional((function(){e.assert(t,l+".state","missing attribute "+u)})),o={},Object.keys(new m).forEach((function(e){o[e]=t.def(l,".",e)}))}s(e.link(r),a(r.info.type),o)}))}function Q(e,n,r,i,o){for(var a,s=e.shared,u=s.gl,c=0;c<i.length;++c){var l,f=i[c],h=f.name,d=f.info.type,p=r.uniforms[h],v=e.link(f)+".location";if(p){if(!o(p))continue;if(is(p)){var m=p.value;if(re.command(null!=m,'missing uniform "'+h+'"',e.commandStr),d===ka||d===Na){re.command("function"==typeof m&&(d===ka&&("texture2d"===m._reglType||"framebuffer"===m._reglType)||d===Na&&("textureCube"===m._reglType||"framebufferCube"===m._reglType)),"invalid texture for uniform "+h,e.commandStr);var g=e.link(m._texture||m.color[0]._texture);n(u,".uniform1i(",v,",",g+".bind());"),n.exit(g,".unbind();")}else if(d===wa||d===La||d===Oa){re.optional((function(){re.command(fn(m),"invalid matrix for uniform "+h,e.commandStr),re.command(d===wa&&4===m.length||d===La&&9===m.length||d===Oa&&16===m.length,"invalid length for matrix uniform "+h,e.commandStr)}));var _=e.global.def("new Float32Array(["+Array.prototype.slice.call(m)+"])"),y=2;d===La?y=3:d===Oa&&(y=4),n(u,".uniformMatrix",y,"fv(",v,",false,",_,");")}else{switch(d){case ga:re.commandType(m,"number","uniform "+h,e.commandStr),a="1f";break;case _a:re.command(fn(m)&&2===m.length,"uniform "+h,e.commandStr),a="2f";break;case ya:re.command(fn(m)&&3===m.length,"uniform "+h,e.commandStr),a="3f";break;case Ea:re.command(fn(m)&&4===m.length,"uniform "+h,e.commandStr),a="4f";break;case Ta:re.commandType(m,"boolean","uniform "+h,e.commandStr),a="1i";break;case ba:re.commandType(m,"number","uniform "+h,e.commandStr),a="1i";break;case Ra:case Aa:re.command(fn(m)&&2===m.length,"uniform "+h,e.commandStr),a="2i";break;case Ca:case xa:re.command(fn(m)&&3===m.length,"uniform "+h,e.commandStr),a="3i";break;case Ma:case Sa:re.command(fn(m)&&4===m.length,"uniform "+h,e.commandStr),a="4i"}n(u,".uniform",a,"(",v,",",fn(m)?Array.prototype.slice.call(m):m,");")}continue}l=p.append(e,n)}else{if(!o(ss))continue;l=n.def(s.uniforms,"[",t.id(h),"]")}d===ka?n("if(",l,"&&",l,'._reglType==="framebuffer"){',l,"=",l,".color[0];","}"):d===Na&&n("if(",l,"&&",l,'._reglType==="framebufferCube"){',l,"=",l,".color[0];","}"),re.optional((function(){function t(t,r){e.assert(n,t,'bad data or missing for uniform "'+h+'".  '+r)}function r(e){t("typeof "+l+'==="'+e+'"',"invalid type, expected "+e)}function i(n,r){t(s.isArrayLike+"("+l+")&&"+l+".length==="+n,"invalid vector, should have length "+n,e.commandStr)}function o(n){t("typeof "+l+'==="function"&&'+l+'._reglType==="texture'+(n===aa?"2d":"Cube")+'"',"invalid texture type",e.commandStr)}switch(d){case ba:r("number");break;case Aa:i(2);break;case xa:i(3);break;case Sa:i(4);break;case ga:r("number");break;case _a:i(2);break;case ya:i(3);break;case Ea:i(4);break;case Ta:r("boolean");break;case Ra:i(2);break;case Ca:i(3);break;case Ma:case wa:i(4);break;case La:i(9);break;case Oa:i(16);break;case ka:o(aa);break;case Na:o(sa)}}));var E=1;switch(d){case ka:case Na:var b=n.def(l,"._texture");n(u,".uniform1i(",v,",",b,".bind());"),n.exit(b,".unbind();");continue;case ba:case Ta:a="1i";break;case Aa:case Ra:a="2i",E=2;break;case xa:case Ca:a="3i",E=3;break;case Sa:case Ma:a="4i",E=4;break;case ga:a="1f";break;case _a:a="2f",E=2;break;case ya:a="3f",E=3;break;case Ea:a="4f",E=4;break;case wa:a="Matrix2fv";break;case La:a="Matrix3fv";break;case Oa:a="Matrix4fv"}if(n(u,".uniform",a,"(",v,","),"M"===a.charAt(0)){var A=Math.pow(d-wa+2,2),x=e.global.def("new Float32Array(",A,")");n("false,(Array.isArray(",l,")||",l," instanceof Float32Array)?",l,":(",Te(A,(function(e){return x+"["+e+"]="+l+"["+e+"]"})),",",x,")")}else n(E>1?Te(E,(function(e){return l+"["+e+"]"})):l);n(");")}}function $(e,t,n,r){var i=e.shared,o=i.gl,a=i.draw,s=r.draw;function u(){var i,u=s.elements,c=t;return u?((u.contextDep&&r.contextDynamic||u.propDep)&&(c=n),i=u.append(e,c)):i=c.def(a,".",jo),i&&c("if("+i+")"+o+".bindBuffer("+oa+","+i+".buffer.buffer);"),i}function c(){var i,o=s.count,u=t;return o?((o.contextDep&&r.contextDynamic||o.propDep)&&(u=n),i=o.append(e,u),re.optional((function(){o.MISSING&&e.assert(t,"false","missing vertex count"),o.DYNAMIC&&e.assert(u,i+">=0","missing vertex count")}))):(i=u.def(a,".",Ho),re.optional((function(){e.assert(u,i+">=0","missing vertex count")}))),i}var l=u();function f(i){var o=s[i];return o?o.contextDep&&r.contextDynamic||o.propDep?o.append(e,n):o.append(e,t):t.def(a,".",i)}var h,d,p=f(Vo),v=f(Xo),m=c();if("number"==typeof m){if(0===m)return}else n("if(",m,"){"),n.exit("}");_&&(h=f(Wo),d=e.instancing);var g=l+".type",y=s.elements&&is(s.elements);function E(){function e(){n(d,".drawElementsInstancedANGLE(",[p,m,g,v+"<<(("+g+"-"+no+")>>1)",h],");")}function t(){n(d,".drawArraysInstancedANGLE(",[p,v,m,h],");")}l?y?e():(n("if(",l,"){"),e(),n("}else{"),t(),n("}")):t()}function b(){function e(){n(o+".drawElements("+[p,m,g,v+"<<(("+g+"-"+no+")>>1)"]+");")}function t(){n(o+".drawArrays("+[p,v,m]+");")}l?y?e():(n("if(",l,"){"),e(),n("}else{"),t(),n("}")):t()}_&&("number"!=typeof h||h>=0)?"string"==typeof h?(n("if(",h,">0){"),E(),n("}else if(",h,"<0){"),b(),n("}")):E():b()}function J(e,t,n,r,i){var o=O(),a=o.proc("body",i);return re.optional((function(){o.commandStr=t.commandStr,o.command=o.link(t.commandStr)})),_&&(o.instancing=a.def(o.shared.extensions,".angle_instanced_arrays")),e(o,a,n,r),o.compile().body}function ee(e,t,n,r){Z(e,t),n.useVAO?n.drawVAO?t(e.shared.vao,".setVAO(",n.drawVAO.append(e,t),");"):t(e.shared.vao,".setVAO(",e.shared.vao,".targetVAO);"):(t(e.shared.vao,".setVAO(null);"),K(e,t,n,r.attributes,(function(){return!0}))),Q(e,t,n,r.uniforms,(function(){return!0})),$(e,t,t,n)}function te(e,t){var n=e.proc("draw",1);Z(e,n),H(e,n,t.context),X(e,n,t.framebuffer),W(e,n,t),Y(e,n,t.state),q(e,n,t,!1,!0);var r=t.shader.progVar.append(e,n);if(n(e.shared.gl,".useProgram(",r,".program);"),t.shader.program)ee(e,n,t,t.shader.program);else{n(e.shared.vao,".setVAO(null);");var i=e.global.def("{}"),o=n.def(r,".id"),a=n.def(i,"[",o,"]");n(e.cond(a).then(a,".call(this,a0);").else(a,"=",i,"[",o,"]=",e.link((function(n){return J(ee,e,t,n,1)})),"(",r,");",a,".call(this,a0);"))}Object.keys(t.state).length>0&&n(e.shared.current,".dirty=true;")}function ne(e,t,n,r){function i(){return!0}e.batchId="a1",Z(e,t),K(e,t,n,r.attributes,i),Q(e,t,n,r.uniforms,i),$(e,t,t,n)}function ie(e,t,n,r){Z(e,t);var i=n.contextDep,o=t.def(),a="a0",s="a1",u=t.def();e.shared.props=u,e.batchId=o;var c=e.scope(),l=e.scope();function f(e){return e.contextDep&&i||e.propDep}function h(e){return!f(e)}if(t(c.entry,"for(",o,"=0;",o,"<",s,";++",o,"){",u,"=",a,"[",o,"];",l,"}",c.exit),n.needsContext&&H(e,l,n.context),n.needsFramebuffer&&X(e,l,n.framebuffer),Y(e,l,n.state,f),n.profile&&f(n.profile)&&q(e,l,n,!1,!0),r)n.useVAO?n.drawVAO?f(n.drawVAO)?l(e.shared.vao,".setVAO(",n.drawVAO.append(e,l),");"):c(e.shared.vao,".setVAO(",n.drawVAO.append(e,c),");"):c(e.shared.vao,".setVAO(",e.shared.vao,".targetVAO);"):(c(e.shared.vao,".setVAO(null);"),K(e,c,n,r.attributes,h),K(e,l,n,r.attributes,f)),Q(e,c,n,r.uniforms,h),Q(e,l,n,r.uniforms,f),$(e,c,l,n);else{var d=e.global.def("{}"),p=n.shader.progVar.append(e,l),v=l.def(p,".id"),m=l.def(d,"[",v,"]");l(e.shared.gl,".useProgram(",p,".program);","if(!",m,"){",m,"=",d,"[",v,"]=",e.link((function(t){return J(ne,e,n,t,2)})),"(",p,");}",m,".call(this,a0[",o,"],",o,");")}}function oe(e,t){var n=e.proc("batch",2);e.batchId="0",Z(e,n);var r=!1,i=!0;Object.keys(t.context).forEach((function(e){r=r||t.context[e].propDep})),r||(H(e,n,t.context),i=!1);var o=t.framebuffer,a=!1;function s(e){return e.contextDep&&r||e.propDep}o?(o.propDep?r=a=!0:o.contextDep&&r&&(a=!0),a||X(e,n,o)):X(e,n,null),t.state.viewport&&t.state.viewport.propDep&&(r=!0),W(e,n,t),Y(e,n,t.state,(function(e){return!s(e)})),t.profile&&s(t.profile)||q(e,n,t,!1,"a1"),t.contextDep=r,t.needsContext=i,t.needsFramebuffer=a;var u=t.shader.progVar;if(u.contextDep&&r||u.propDep)ie(e,n,t,null);else{var c=u.append(e,n);if(n(e.shared.gl,".useProgram(",c,".program);"),t.shader.program)ie(e,n,t,t.shader.program);else{n(e.shared.vao,".setVAO(null);");var l=e.global.def("{}"),f=n.def(c,".id"),h=n.def(l,"[",f,"]");n(e.cond(h).then(h,".call(this,a0,a1);").else(h,"=",l,"[",f,"]=",e.link((function(n){return J(ie,e,t,n,2)})),"(",c,");",h,".call(this,a0,a1);"))}}Object.keys(t.state).length>0&&n(e.shared.current,".dirty=true;")}function ae(e,n){var r=e.proc("scope",3);e.batchId="a2";var i=e.shared,o=i.current;function a(t){var o=n.shader[t];o&&r.set(i.shader,"."+t,o.append(e,r))}H(e,r,n.context),n.framebuffer&&n.framebuffer.append(e,r),ns(Object.keys(n.state)).forEach((function(t){var o=n.state[t].append(e,r);fn(o)?o.forEach((function(n,i){r.set(e.next[t],"["+i+"]",n)})):r.set(i.next,"."+t,o)})),q(e,r,n,!0,!0),[jo,Xo,Ho,Wo,Vo].forEach((function(t){var o=n.draw[t];o&&r.set(i.draw,"."+t,""+o.append(e,r))})),Object.keys(n.uniforms).forEach((function(o){r.set(i.uniforms,"["+t.id(o)+"]",n.uniforms[o].append(e,r))})),Object.keys(n.attributes).forEach((function(t){var i=n.attributes[t].append(e,r),o=e.scopeAttrib(t);Object.keys(new m).forEach((function(e){r.set(o,"."+e,i[e])}))})),n.scopeVAO&&r.set(i.vao,".targetVAO",n.scopeVAO.append(e,r)),a(Go),a(zo),Object.keys(n.state).length>0&&(r(o,".dirty=true;"),r.exit(o,".dirty=true;")),r("a1(",e.shared.context,",a0,",e.batchId,");")}function se(e){if("object"===s(e)&&!fn(e)){for(var t=Object.keys(e),n=0;n<t.length;++n)if(de.isDynamic(e[t[n]]))return!0;return!1}}function ue(e,t,n){var r=t.static[n];if(r&&se(r)){var i=e.global,o=Object.keys(r),a=!1,u=!1,c=!1,l=e.global.def("{}");o.forEach((function(t){var n=r[t];if(de.isDynamic(n)){"function"==typeof n&&(n=r[t]=de.unbox(n));var o=as(n,null);a=a||o.thisDep,c=c||o.propDep,u=u||o.contextDep}else{switch(i(l,".",t,"="),s(n)){case"number":i(n);break;case"string":i('"',n,'"');break;case"object":Array.isArray(n)&&i("[",n.join(),"]");break;default:i(e.link(n))}i(";")}})),t.dynamic[n]=new de.DynamicVariable(co,{thisDep:a,contextDep:u,propDep:c,ref:l,append:f}),delete t.static[n]}function f(e,t){o.forEach((function(n){var i=r[n];if(de.isDynamic(i)){var o=e.invoke(t,i);t(l,".",n,"=",o,";")}}))}}function ce(e,t,n,r,i){var o=O();o.stats=o.link(i),Object.keys(t.static).forEach((function(e){ue(o,t,e)})),ra.forEach((function(t){ue(o,e,t)}));var a=V(e,t,n,r,o);return te(o,a),ae(o,a),oe(o,a),o.compile()}return{next:b,current:E,procs:function(){var e=O(),t=e.proc("poll"),i=e.proc("refresh"),o=e.block();t(o),i(o);var a,s=e.shared,u=s.gl,c=s.next,l=s.current;o(l,".dirty=false;"),X(e,t),X(e,i,null,!0),_&&(a=e.link(_)),n.oes_vertex_array_object&&i(e.link(n.oes_vertex_array_object),".bindVertexArrayOES(null);");for(var f=0;f<r.maxAttributes;++f){var h=i.def(s.attributes,"[",f,"]"),d=e.cond(h,".buffer");d.then(u,".enableVertexAttribArray(",f,");",u,".bindBuffer(",ia,",",h,".buffer.buffer);",u,".vertexAttribPointer(",f,",",h,".size,",h,".type,",h,".normalized,",h,".stride,",h,".offset);").else(u,".disableVertexAttribArray(",f,");",u,".vertexAttrib4f(",f,",",h,".x,",h,".y,",h,".z,",h,".w);",h,".buffer=null;"),i(d),_&&i(a,".vertexAttribDivisorANGLE(",f,",",h,".divisor);")}return i(e.shared.vao,".currentVAO=null;",e.shared.vao,".setVAO(",e.shared.vao,".targetVAO);"),Object.keys(x).forEach((function(n){var r=x[n],a=o.def(c,".",n),s=e.block();s("if(",a,"){",u,".enable(",r,")}else{",u,".disable(",r,")}",l,".",n,"=",a,";"),i(s),t("if(",a,"!==",l,".",n,"){",s,"}")})),Object.keys(S).forEach((function(n){var r,a,s=S[n],f=E[n],h=e.block();if(h(u,".",s,"("),fn(f)){var d=f.length;r=e.global.def(c,".",n),a=e.global.def(l,".",n),h(Te(d,(function(e){return r+"["+e+"]"})),");",Te(d,(function(e){return a+"["+e+"]="+r+"["+e+"];"})).join("")),t("if(",Te(d,(function(e){return r+"["+e+"]!=="+a+"["+e+"]"})).join("||"),"){",h,"}")}else r=o.def(c,".",n),a=o.def(l,".",n),h(r,");",l,".",n,"=",r,";"),t("if(",r,"!==",a,"){",h,"}");i(h)})),e.compile()}(),compile:ce}}function cs(){return{vaoCount:0,bufferCount:0,elementsCount:0,framebufferCount:0,shaderCount:0,textureCount:0,cubeCount:0,renderbufferCount:0,maxTextureUnits:0}}var ls=34918,fs=34919,hs=35007,ds=function(e,t){if(!t.ext_disjoint_timer_query)return null;var n=[];function r(){return n.pop()||t.ext_disjoint_timer_query.createQueryEXT()}function i(e){n.push(e)}var o=[];function a(e){var n=r();t.ext_disjoint_timer_query.beginQueryEXT(hs,n),o.push(n),d(o.length-1,o.length,e)}function s(){t.ext_disjoint_timer_query.endQueryEXT(hs)}function u(){this.startQueryIndex=-1,this.endQueryIndex=-1,this.sum=0,this.stats=null}var c=[];function l(){return c.pop()||new u}function f(e){c.push(e)}var h=[];function d(e,t,n){var r=l();r.startQueryIndex=e,r.endQueryIndex=t,r.sum=0,r.stats=n,h.push(r)}var p=[],v=[];function m(){var e,n,r=o.length;if(0!==r){v.length=Math.max(v.length,r+1),p.length=Math.max(p.length,r+1),p[0]=0,v[0]=0;var a=0;for(e=0,n=0;n<o.length;++n){var s=o[n];t.ext_disjoint_timer_query.getQueryObjectEXT(s,fs)?(a+=t.ext_disjoint_timer_query.getQueryObjectEXT(s,ls),i(s)):o[e++]=s,p[n+1]=a,v[n+1]=e}for(o.length=e,e=0,n=0;n<h.length;++n){var u=h[n],c=u.startQueryIndex,l=u.endQueryIndex;u.sum+=p[l]-p[c];var d=v[c],m=v[l];m===d?(u.stats.gpuTime+=u.sum/1e6,f(u)):(u.startQueryIndex=d,u.endQueryIndex=m,h[e++]=u)}h.length=e}}return{beginQuery:a,endQuery:s,pushScopeStats:d,update:m,getNumPendingQueries:function(){return o.length},clear:function(){n.push.apply(n,o);for(var e=0;e<n.length;e++)t.ext_disjoint_timer_query.deleteQueryEXT(n[e]);o.length=0,n.length=0},restore:function(){o.length=0,n.length=0}}},ps=16384,vs=256,ms=1024,gs=34962,_s="webglcontextlost",ys="webglcontextrestored",Es=1,bs=2,As=3;function xs(e,t){for(var n=0;n<e.length;++n)if(e[n]===t)return n;return-1}function Ss(e){var n=xe(e);if(!n)return null;var r=n.gl,i=r.getContextAttributes(),o=r.isContextLost(),a=Se(r,n);if(!a)return null;var u=me(),c=cs(),l=a.extensions,f=ds(r,l),h=ve(),d=r.drawingBufferWidth,p=r.drawingBufferHeight,v={tick:0,time:0,viewportWidth:d,viewportHeight:p,framebufferWidth:d,framebufferHeight:p,drawingBufferWidth:d,drawingBufferHeight:p,pixelRatio:n.pixelRatio},m={},g={elements:null,primitive:4,count:-1,offset:0,instances:-1},_=bt(r,l),y=Ht(r,c,n,b),E=zi(r,l,_,c,y);function b(e){return E.destroyBuffer(e)}var A=an(r,l,y,c),x=Wi(r,u,c,n),S=qr(r,l,_,(function(){C.procs.poll()}),v,c,n),T=ci(r,l,_,c,n),R=Fi(r,l,_,S,T,c),C=us(r,u,l,_,y,A,S,R,m,E,x,g,v,f,n),M=Qi(r,R,C.procs.poll,v,i,l,_),w=C.next,L=r.canvas,O=[],k=[],N=[],I=[n.onDestroy],P=null;function D(){if(0===O.length)return f&&f.update(),void(P=null);P=pe.next(D),Z();for(var e=O.length-1;e>=0;--e){var t=O[e];t&&t(v,null,0)}r.flush(),f&&f.update()}function F(){!P&&O.length>0&&(P=pe.next(D))}function B(){P&&(pe.cancel(D),P=null)}function U(e){e.preventDefault(),o=!0,B(),k.forEach((function(e){e()}))}function G(e){r.getError(),o=!1,a.restore(),x.restore(),y.restore(),S.restore(),T.restore(),R.restore(),E.restore(),f&&f.restore(),C.procs.refresh(),F(),N.forEach((function(e){e()}))}function z(){O.length=0,B(),L&&(L.removeEventListener(_s,U),L.removeEventListener(ys,G)),x.clear(),R.clear(),T.clear(),S.clear(),A.clear(),y.clear(),E.clear(),f&&f.clear(),I.forEach((function(e){e()}))}function j(e){function n(e){var n=t({},e);function r(e){if(e in n){var t=n[e];delete n[e],Object.keys(t).forEach((function(r){n[e+"."+r]=t[r]}))}}return delete n.uniforms,delete n.attributes,delete n.context,delete n.vao,"stencil"in n&&n.stencil.op&&(n.stencil.opBack=n.stencil.opFront=n.stencil.op,delete n.stencil.op),r("blend"),r("depth"),r("cull"),r("stencil"),r("polygonOffset"),r("scissor"),r("sample"),"vao"in e&&(n.vao=e.vao),n}function r(e){var t={},n={};return Object.keys(e).forEach((function(r){var i=e[r];de.isDynamic(i)?n[r]=de.unbox(i,r):t[r]=i})),{dynamic:n,static:t}}re(!!e,"invalid args to regl({...})"),re.type(e,"object","invalid args to regl({...})");var i=r(e.context||{}),a=r(e.uniforms||{}),s=r(e.attributes||{}),u=r(n(e)),c={gpuTime:0,cpuTime:0,count:0},l=C.compile(u,s,a,i,c),f=l.draw,h=l.batch,d=l.scope,p=[];function v(e){for(;p.length<e;)p.push(null);return p}function m(e,t){var n;if(o&&re.raise("context lost"),"function"==typeof e)return d.call(this,null,e,0);if("function"==typeof t)if("number"==typeof e)for(n=0;n<e;++n)d.call(this,null,t,n);else{if(!Array.isArray(e))return d.call(this,e,t,0);for(n=0;n<e.length;++n)d.call(this,e[n],t,n)}else if("number"==typeof e){if(e>0)return h.call(this,v(0|e),0|e)}else{if(!Array.isArray(e))return f.call(this,e);if(e.length)return h.call(this,e,e.length)}}return t(m,{stats:c})}L&&(L.addEventListener(_s,U,!1),L.addEventListener(ys,G,!1));var V=R.setFBO=j({framebuffer:de.define.call(null,Es,"framebuffer")});function H(e,t){var n=0;C.procs.poll();var i=t.color;i&&(r.clearColor(+i[0]||0,+i[1]||0,+i[2]||0,+i[3]||0),n|=ps),"depth"in t&&(r.clearDepth(+t.depth),n|=vs),"stencil"in t&&(r.clearStencil(0|t.stencil),n|=ms),re(!!n,"called regl.clear with no buffer specified"),r.clear(n)}function X(e){if(re("object"===s(e)&&e,"regl.clear() takes an object as input"),"framebuffer"in e)if(e.framebuffer&&"framebufferCube"===e.framebuffer_reglType)for(var n=0;n<6;++n)V(t({framebuffer:e.framebuffer.faces[n]},e),H);else V(e,H);else H(null,e)}function W(e){function t(){var t=xs(O,e);function n(){var e=xs(O,n);O[e]=O[O.length-1],O.length-=1,O.length<=0&&B()}re(t>=0,"cannot cancel a frame twice"),O[t]=n}return re.type(e,"function","regl.frame() callback must be a function"),O.push(e),F(),{cancel:t}}function Y(){var e=w.viewport,t=w.scissor_box;e[0]=e[1]=t[0]=t[1]=0,v.viewportWidth=v.framebufferWidth=v.drawingBufferWidth=e[2]=t[2]=r.drawingBufferWidth,v.viewportHeight=v.framebufferHeight=v.drawingBufferHeight=e[3]=t[3]=r.drawingBufferHeight}function Z(){v.tick+=1,v.time=K(),Y(),C.procs.poll()}function q(){Y(),C.procs.refresh(),f&&f.update()}function K(){return(ve()-h)/1e3}function Q(e,t){var n;switch(re.type(t,"function","listener callback must be a function"),e){case"frame":return W(t);case"lost":n=k;break;case"restore":n=N;break;case"destroy":n=I;break;default:re.raise("invalid event, must be one of frame,lost,restore,destroy")}return n.push(t),{cancel:function(){for(var e=0;e<n.length;++e)if(n[e]===t)return n[e]=n[n.length-1],void n.pop()}}}q();var $=t(j,{clear:X,prop:de.define.bind(null,Es),context:de.define.bind(null,bs),this:de.define.bind(null,As),draw:j({}),buffer:function(e){return y.create(e,gs,!1,!1)},elements:function(e){return A.create(e,!1)},texture:S.create2D,cube:S.createCube,renderbuffer:T.create,framebuffer:R.create,framebufferCube:R.createCube,vao:E.createVAO,attributes:i,frame:W,on:Q,limits:_,hasExtension:function(e){return _.extensions.indexOf(e.toLowerCase())>=0},read:M,destroy:z,_gl:r,_refresh:q,poll:function(){Z(),f&&f.update()},now:K,stats:c});return n.onDone(null,$),$}return Ss}()}(YM);var ZM=YM.exports,qM=function(){return c((function e(t,n){f(this,e);var r=n.buffer,i=n.offset,o=n.stride,a=n.normalized,s=n.size,u=n.divisor;this.buffer=r,this.attribute={buffer:r.get(),offset:i||0,stride:o||0,normalized:a||!1,divisor:u||0},s&&(this.attribute.size=s)}),[{key:"get",value:function(){return this.attribute}},{key:"updateBuffer",value:function(e){this.buffer.subData(e)}},{key:"destroy",value:function(){this.buffer.destroy()}}])}(),KM=o(o(o(o(o(o(o({},Bu.POINTS,"points"),Bu.LINES,"lines"),Bu.LINE_LOOP,"line loop"),Bu.LINE_STRIP,"line strip"),Bu.TRIANGLES,"triangles"),Bu.TRIANGLE_FAN,"triangle fan"),Bu.TRIANGLE_STRIP,"triangle strip"),QM=o(o(o({},Bu.STATIC_DRAW,"static"),Bu.DYNAMIC_DRAW,"dynamic"),Bu.STREAM_DRAW,"stream"),$M=o(o(o(o(o(o({},Bu.BYTE,"int8"),Bu.INT,"int32"),Bu.UNSIGNED_BYTE,"uint8"),Bu.UNSIGNED_SHORT,"uint16"),Bu.UNSIGNED_INT,"uint32"),Bu.FLOAT,"float"),JM=o(o(o(o(o(o(o(o(o(o({},Bu.ALPHA,"alpha"),Bu.LUMINANCE,"luminance"),Bu.LUMINANCE_ALPHA,"luminance alpha"),Bu.RGB,"rgb"),Bu.RGBA,"rgba"),Bu.RGBA4,"rgba4"),Bu.RGB5_A1,"rgb5 a1"),Bu.RGB565,"rgb565"),Bu.DEPTH_COMPONENT,"depth"),Bu.DEPTH_STENCIL,"depth stencil"),ew=o(o(o({},Bu.DONT_CARE,"dont care"),Bu.NICEST,"nice"),Bu.FASTEST,"fast"),tw=o(o(o(o(o(o({},Bu.NEAREST,"nearest"),Bu.LINEAR,"linear"),Bu.LINEAR_MIPMAP_LINEAR,"mipmap"),Bu.NEAREST_MIPMAP_LINEAR,"nearest mipmap linear"),Bu.LINEAR_MIPMAP_NEAREST,"linear mipmap nearest"),Bu.NEAREST_MIPMAP_NEAREST,"nearest mipmap nearest"),nw=o(o(o({},Bu.REPEAT,"repeat"),Bu.CLAMP_TO_EDGE,"clamp"),Bu.MIRRORED_REPEAT,"mirror"),rw=o(o({},Bu.NONE,"none"),Bu.BROWSER_DEFAULT_WEBGL,"browser"),iw=o(o(o(o(o(o(o(o({},Bu.NEVER,"never"),Bu.ALWAYS,"always"),Bu.LESS,"less"),Bu.LEQUAL,"lequal"),Bu.GREATER,"greater"),Bu.GEQUAL,"gequal"),Bu.EQUAL,"equal"),Bu.NOTEQUAL,"notequal"),ow=o(o(o(o(o({},Bu.FUNC_ADD,"add"),Bu.MIN_EXT,"min"),Bu.MAX_EXT,"max"),Bu.FUNC_SUBTRACT,"subtract"),Bu.FUNC_REVERSE_SUBTRACT,"reverse subtract"),aw=(o(o(o(o(o(o(o(o(o(o(pe={},Bu.ZERO,"zero"),Bu.ONE,"one"),Bu.SRC_COLOR,"src color"),Bu.ONE_MINUS_SRC_COLOR,"one minus src color"),Bu.SRC_ALPHA,"src alpha"),Bu.ONE_MINUS_SRC_ALPHA,"one minus src alpha"),Bu.DST_COLOR,"dst color"),Bu.ONE_MINUS_DST_COLOR,"one minus dst color"),Bu.DST_ALPHA,"dst alpha"),Bu.ONE_MINUS_DST_ALPHA,"one minus dst alpha"),o(o(o(o(o(pe,Bu.CONSTANT_COLOR,"constant color"),Bu.ONE_MINUS_CONSTANT_COLOR,"one minus constant color"),Bu.CONSTANT_ALPHA,"constant alpha"),Bu.ONE_MINUS_CONSTANT_ALPHA,"one minus constant alpha"),Bu.SRC_ALPHA_SATURATE,"src alpha saturate")),sw=o(o(o(o(o(o(o(o({},Bu.NEVER,"never"),Bu.ALWAYS,"always"),Bu.LESS,"less"),Bu.LEQUAL,"lequal"),Bu.GREATER,"greater"),Bu.GEQUAL,"gequal"),Bu.EQUAL,"equal"),Bu.NOTEQUAL,"notequal"),uw=o(o(o(o(o(o(o(o({},Bu.ZERO,"zero"),Bu.KEEP,"keep"),Bu.REPLACE,"replace"),Bu.INVERT,"invert"),Bu.INCR,"increment"),Bu.DECR,"decrement"),Bu.INCR_WRAP,"increment wrap"),Bu.DECR_WRAP,"decrement wrap"),cw=o(o({},Bu.FRONT,"front"),Bu.BACK,"back"),lw=function(){return c((function e(t,n){f(this,e),this.isDestroyed=!1;var r=n.data,i=n.usage,o=n.type;this.buffer=t.buffer({data:r,usage:QM[i||Bu.STATIC_DRAW],type:$M[o||Bu.UNSIGNED_BYTE]})}),[{key:"get",value:function(){return this.buffer}},{key:"destroy",value:function(){this.isDestroyed||this.buffer.destroy(),this.isDestroyed=!0}},{key:"subData",value:function(e){var t=e.data,n=e.offset;this.buffer.subdata(t,n)}}])}(),fw=function(){return c((function e(t,n){f(this,e);var r=n.data,i=n.usage,o=n.type,a=n.count;this.elements=t.elements({data:r,usage:QM[i||Bu.STATIC_DRAW],type:$M[o||Bu.UNSIGNED_BYTE],count:a})}),[{key:"get",value:function(){return this.elements}},{key:"subData",value:function(e){var t=e.data;this.elements.subdata(t)}},{key:"destroy",value:function(){}}])}(),hw=function(){return c((function e(t,n){f(this,e);var r=n.width,i=n.height,o=n.color,a=n.colors,s={width:r,height:i};Array.isArray(a)&&(s.colors=a.map((function(e){return e.get()}))),o&&"boolean"!=typeof o&&(s.color=o.get()),this.framebuffer=t.framebuffer(s)}),[{key:"get",value:function(){return this.framebuffer}},{key:"destroy",value:function(){this.framebuffer.destroy()}},{key:"resize",value:function(e){var t=e.width,n=e.height;this.framebuffer.resize(t,n)}}])}(),dw=Object.defineProperty,pw=Object.defineProperties,vw=Object.getOwnPropertyDescriptors,mw=Object.getOwnPropertySymbols,gw=Object.prototype.hasOwnProperty,_w=Object.prototype.propertyIsEnumerable,yw=function(e,t,n){return t in e?dw(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n},Ew=function(e,t){for(var n in t||(t={}))gw.call(t,n)&&yw(e,n,t[n]);if(mw){var r,i=y(mw(t));try{for(i.s();!(r=i.n()).done;){n=r.value;_w.call(t,n)&&yw(e,n,t[n])}}catch(o){i.e(o)}finally{i.f()}}return e},bw=Ni.isPlainObject,Aw=Ni.isTypedArray,xw=function(){return c((function e(t,n){f(this,e),this.destroyed=!1,this.uniforms={},this.reGl=t;var r=n.vs,i=n.fs,o=n.attributes,a=n.uniforms,s=n.primitive,u=n.count,c=n.elements,l=n.depth,h=n.cull,d=n.instances,p={platformString:"WebGL1",glslVersion:"#version 100",explicitBindingLocations:!1,separateSamplerTextures:!1,viewportOrigin:HS.LOWER_LEFT,clipSpaceNearZ:XS.NEGATIVE_ONE,supportMRT:!1},v={};this.options=n,a&&(this.uniforms=this.extractUniforms(a),Object.keys(a).forEach((function(e){v[e]=t.prop(e)})));var m={};Object.keys(o).forEach((function(e){m[e]=o[e].get()}));var g=Wu(fR(p,"frag",i,null,!1)),_=Wu(fR(p,"vert",r,null,!1)),y={attributes:m,frag:g,uniforms:v,vert:_,colorMask:t.prop("colorMask"),lineWidth:1,blend:{enable:t.prop("blend.enable"),func:t.prop("blend.func"),equation:t.prop("blend.equation"),color:t.prop("blend.color")},stencil:{enable:t.prop("stencil.enable"),mask:t.prop("stencil.mask"),func:t.prop("stencil.func"),opFront:t.prop("stencil.opFront"),opBack:t.prop("stencil.opBack")},primitive:KM[void 0===s?Bu.TRIANGLES:s]};d&&(y.instances=d),u?y.count=u:c&&(y.elements=c.get()),this.initDepthDrawParams({depth:l},y),this.initCullDrawParams({cull:h},y),this.drawCommand=t(y),this.drawParams=y}),[{key:"updateAttributesAndElements",value:function(e,t){var n={};Object.keys(e).forEach((function(t){n[t]=e[t].get()})),this.drawParams.attributes=n,this.drawParams.elements=t.get(),this.drawCommand=this.reGl(this.drawParams)}},{key:"updateAttributes",value:function(e){var t={};Object.keys(e).forEach((function(n){t[n]=e[n].get()})),this.drawParams.attributes=t,this.drawCommand=this.reGl(this.drawParams)}},{key:"addUniforms",value:function(e){this.uniforms=Ew(Ew({},this.uniforms),this.extractUniforms(e))}},{key:"draw",value:function(e,t){if(!this.drawParams.attributes||0!==Object.keys(this.drawParams.attributes).length){var n=Ew(Ew({},this.uniforms),this.extractUniforms(e.uniforms||{})),r={};Object.keys(n).forEach((function(e){var t=s(n[e]);"boolean"===t||"number"===t||Array.isArray(n[e])||n[e].BYTES_PER_ELEMENT?r[e]=n[e]:r[e]=n[e].get()})),r.blend=t?this.getBlendDrawParams({blend:{enable:!1}}):this.getBlendDrawParams(e),r.stencil=this.getStencilDrawParams(e),r.colorMask=this.getColorMaskDrawParams(e,t),this.drawCommand(r)}}},{key:"destroy",value:function(){var e,t;null==(t=null==(e=this.drawParams)?void 0:e.elements)||t.destroy(),this.options.attributes&&Object.values(this.options.attributes).forEach((function(e){null==e||e.destroy()})),this.destroyed=!0}},{key:"initDepthDrawParams",value:function(e,t){var n=e.depth;n&&(t.depth={enable:void 0===n.enable||!!n.enable,mask:void 0===n.mask||!!n.mask,func:iw[n.func||Bu.LESS],range:n.range||[0,1]})}},{key:"getBlendDrawParams",value:function(e){var t=e.blend||{},n=t.enable,r=t.func,i=t.equation,o=t.color,a=void 0===o?[0,0,0,0]:o;return{enable:!!n,func:{srcRGB:aw[r&&r.srcRGB||Bu.SRC_ALPHA],srcAlpha:aw[r&&r.srcAlpha||Bu.SRC_ALPHA],dstRGB:aw[r&&r.dstRGB||Bu.ONE_MINUS_SRC_ALPHA],dstAlpha:aw[r&&r.dstAlpha||Bu.ONE_MINUS_SRC_ALPHA]},equation:{rgb:ow[i&&i.rgb||Bu.FUNC_ADD],alpha:ow[i&&i.alpha||Bu.FUNC_ADD]},color:a}}},{key:"getStencilDrawParams",value:function(e){var t,n,r=e.stencil||{},i=r.enable,o=r.mask,a=void 0===o?-1:o,s=r.func,u=void 0===s?{cmp:Bu.ALWAYS,ref:0,mask:-1}:s,c=r.opFront,l=void 0===c?{fail:Bu.KEEP,zfail:Bu.KEEP,zpass:Bu.KEEP}:c,f=r.opBack,h=void 0===f?{fail:Bu.KEEP,zfail:Bu.KEEP,zpass:Bu.KEEP}:f;return{enable:!!i,mask:a,func:(t=Ew({},u),n={cmp:sw[u.cmp]},pw(t,vw(n))),opFront:{fail:uw[l.fail],zfail:uw[l.zfail],zpass:uw[l.zpass]},opBack:{fail:uw[h.fail],zfail:uw[h.zfail],zpass:uw[h.zpass]}}}},{key:"getColorMaskDrawParams",value:function(e,t){var n=e.stencil;return(null==n?void 0:n.enable)&&n.opFront&&!t?[!1,!1,!1,!1]:[!0,!0,!0,!0]}},{key:"initCullDrawParams",value:function(e,t){var n=e.cull;if(n){var r=n.enable,i=n.face,o=void 0===i?Bu.BACK:i;t.cull={enable:!!r,face:cw[o]}}}},{key:"extractUniforms",value:function(e){var t=this,n={};return Object.keys(e).forEach((function(r){t.extractUniformsRecursively(r,e[r],n,"")})),n}},{key:"extractUniformsRecursively",value:function(e,t,n,r){var i=this;null===t||"number"==typeof t||"boolean"==typeof t||Array.isArray(t)&&"number"==typeof t[0]||Aw(t)||""===t||"resize"in t?n["".concat(r&&r+".").concat(e)]=t:(bw(t)&&Object.keys(t).forEach((function(o){i.extractUniformsRecursively(o,t[o],n,"".concat(r&&r+".").concat(e))})),Array.isArray(t)&&t.forEach((function(t,o){Object.keys(t).forEach((function(a){i.extractUniformsRecursively(a,t[a],n,"".concat(r&&r+".").concat(e,"[").concat(o,"]"))}))})))}}])}(),Sw=function(){return c((function e(t,n){f(this,e),this.isDestroy=!1;var r=n.data,i=n.type,o=void 0===i?Bu.UNSIGNED_BYTE:i,a=n.width,s=n.height,u=n.flipY,c=void 0!==u&&u,l=n.format,h=void 0===l?Bu.RGBA:l,d=n.mipmap,p=void 0!==d&&d,v=n.wrapS,m=void 0===v?Bu.CLAMP_TO_EDGE:v,g=n.wrapT,_=void 0===g?Bu.CLAMP_TO_EDGE:g,y=n.aniso,E=void 0===y?0:y,b=n.alignment,A=void 0===b?1:b,x=n.premultiplyAlpha,S=void 0!==x&&x,T=n.mag,R=void 0===T?Bu.NEAREST:T,C=n.min,M=void 0===C?Bu.NEAREST:C,w=n.colorSpace,L=void 0===w?Bu.BROWSER_DEFAULT_WEBGL:w,O=n.x,k=void 0===O?0:O,N=n.y,I=void 0===N?0:N,P=n.copy,D=void 0!==P&&P;this.width=a,this.height=s;var F={width:a,height:s,type:$M[o],format:JM[h],wrapS:nw[m],wrapT:nw[_],mag:tw[R],min:tw[M],alignment:A,flipY:c,colorSpace:rw[L],premultiplyAlpha:S,aniso:E,x:k,y:I,copy:D};r&&(F.data=r),"number"==typeof p?F.mipmap=ew[p]:"boolean"==typeof p&&(F.mipmap=p),this.texture=t.texture(F)}),[{key:"get",value:function(){return this.texture}},{key:"update",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.texture(e)}},{key:"bind",value:function(){this.texture._texture.bind()}},{key:"resize",value:function(e){var t=e.width,n=e.height;this.texture.resize(t,n),this.width=t,this.height=n}},{key:"getSize",value:function(){return[this.width,this.height]}},{key:"destroy",value:function(){var e;this.isDestroy||null==(e=this.texture)||e.destroy(),this.isDestroy=!0}}])}(),Tw=function(e,t,n){return new Promise((function(r,i){var o=function(e){try{s(n.next(e))}catch(t){i(t)}},a=function(e){try{s(n.throw(e))}catch(t){i(t)}},s=function(e){return e.done?r(e.value):Promise.resolve(e.value).then(o,a)};s((n=n.apply(e,t)).next())}))},Rw=function(){return c((function e(){var t=this;f(this,e),this.uniformBuffers=[],this.queryVerdorInfo=function(){return"WebGL1"},this.createModel=function(e){return new xw(t.gl,e)},this.createAttribute=function(e){return new qM(t.gl,e)},this.createBuffer=function(e){return new lw(t.gl,e)},this.createElements=function(e){return new fw(t.gl,e)},this.createTexture2D=function(e){return new Sw(t.gl,e)},this.createFramebuffer=function(e){return new hw(t.gl,e)},this.useFramebuffer=function(e,n){t.gl({framebuffer:e?e.get():null})(n)},this.useFramebufferAsync=function(e,n){return Tw(t,null,i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:this.gl({framebuffer:e?e.get():null})(n);case 1:case"end":return t.stop()}}),t,this)})))},this.clear=function(e){var n,r=e.color,i=e.depth,o=e.stencil,a=e.framebuffer,s=void 0===a?null:a,u={color:r,depth:i,stencil:o};u.framebuffer=null===s?s:s.get(),null==(n=t.gl)||n.clear(u)},this.viewport=function(e){var n=e.x,r=e.y,i=e.width,o=e.height;t.gl._gl.viewport(n,r,i,o),t.width=i,t.height=o,t.gl._refresh()},this.readPixels=function(e){var n=e.framebuffer,r={x:e.x,y:e.y,width:e.width,height:e.height};return n&&(r.framebuffer=n.get()),t.gl.read(r)},this.readPixelsAsync=function(e){return Tw(t,null,i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",this.readPixels(e));case 1:case"end":return t.stop()}}),t,this)})))},this.getViewportSize=function(){return{width:t.gl._gl.drawingBufferWidth,height:t.gl._gl.drawingBufferHeight}},this.getContainer=function(){var e;return null==(e=t.canvas)?void 0:e.parentElement},this.getCanvas=function(){return t.canvas},this.getGLContext=function(){return t.gl._gl},this.destroy=function(){var e,n,r;t.canvas=null,null==(r=null==(n=null==(e=t.gl)?void 0:e._gl)?void 0:n.getExtension("WEBGL_lose_context"))||r.loseContext(),t.gl.destroy(),t.gl=null}}),[{key:"init",value:function(e,t,n){return Tw(this,null,i().mark((function r(){var o=this;return i().wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(this.canvas=e,!n){r.next=5;break}this.gl=n,r.next=8;break;case 5:return r.next=7,new Promise((function(e,n){ZM({canvas:o.canvas,attributes:{alpha:!0,antialias:t.antialias,premultipliedAlpha:!0,preserveDrawingBuffer:t.preserveDrawingBuffer,stencil:t.stencil},extensions:["OES_element_index_uint","OES_standard_derivatives","ANGLE_instanced_arrays"],optionalExtensions:["oes_texture_float_linear","OES_texture_float","EXT_texture_filter_anisotropic","EXT_blend_minmax","WEBGL_depth_texture","WEBGL_lose_context"],profile:!0,onDone:function(t,r){!t&&r||n(t),e(r)}})}));case 7:this.gl=r.sent;case 8:this.extensionObject={OES_texture_float:this.testExtension("OES_texture_float")};case 9:case"end":return r.stop()}}),r,this)})))}},{key:"getPointSizeRange",value:function(){return this.gl._gl.getParameter(this.gl._gl.ALIASED_POINT_SIZE_RANGE)}},{key:"testExtension",value:function(e){return!!this.getGLContext().getExtension(e)}},{key:"setState",value:function(){this.gl({cull:{enable:!1,face:"back"},viewport:{x:0,y:0,height:this.width,width:this.height},blend:{enable:!0,equation:"add"},framebuffer:null}),this.gl._refresh()}},{key:"setBaseState",value:function(){this.gl({cull:{enable:!1,face:"back"},viewport:{x:0,y:0,height:this.width,width:this.height},blend:{enable:!1,equation:"add"},framebuffer:null}),this.gl._refresh()}},{key:"setCustomLayerDefaults",value:function(){var e=this.getGLContext();e.disable(e.CULL_FACE)}},{key:"setDirty",value:function(e){this.isDirty=e}},{key:"getDirty",value:function(){return this.isDirty}},{key:"beginFrame",value:function(){}},{key:"endFrame",value:function(){}}])}(),Cw=["selectstart","selecting","selectend"],Mw=function(e){function t(e){var n,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return f(this,t),(n=h(this,t)).isEnable=!1,n.onDragStart=function(e){n.box.style.display="block",n.startEvent=n.endEvent=e,n.syncBoxBound(),n.emit("selectstart",n.getLngLatBox(),n.startEvent,n.endEvent)},n.onDragging=function(e){n.endEvent=e,n.syncBoxBound(),n.emit("selecting",n.getLngLatBox(),n.startEvent,n.endEvent)},n.onDragEnd=function(e){n.endEvent=e,n.box.style.display="none",n.emit("selectend",n.getLngLatBox(),n.startEvent,n.endEvent)},n.scene=e,n.options=r,n}return d(t,e),c(t,[{key:"container",get:function(){return this.scene.getMapService().getMarkerContainer()}},{key:"enable",value:function(){if(!this.isEnable){var e=this.options.className;if(this.scene.setMapStatus({dragEnable:!1}),this.container.style.cursor="crosshair",!this.box){var t=Di("div",void 0,this.container);t.classList.add("l7-select-box"),e&&t.classList.add(e),t.style.display="none",this.box=t}this.scene.on("dragstart",this.onDragStart),this.scene.on("dragging",this.onDragging),this.scene.on("dragend",this.onDragEnd),this.isEnable=!0}}},{key:"disable",value:function(){this.isEnable&&(this.scene.setMapStatus({dragEnable:!0}),this.container.style.cursor="auto",this.scene.off("dragstart",this.onDragStart),this.scene.off("dragging",this.onDragging),this.scene.off("dragend",this.onDragEnd),this.isEnable=!1)}},{key:"syncBoxBound",value:function(){var e=this.startEvent,t=e.x,n=e.y,r=this.endEvent,i=r.x,o=r.y,a=Math.min(t,i),s=Math.min(n,o),u=Math.abs(t-i),c=Math.abs(n-o);this.box.style.top="".concat(s,"px"),this.box.style.left="".concat(a,"px"),this.box.style.width="".concat(u,"px"),this.box.style.height="".concat(c,"px")}},{key:"getLngLatBox",value:function(){var e=this.startEvent.lngLat,t=e.lng,n=e.lat,r=this.endEvent.lngLat,i=r.lng,o=r.lat;return Xi(function(e,t){void 0===t&&(t={});var n={type:"FeatureCollection"};return t.id&&(n.id=t.id),t.bbox&&(n.bbox=t.bbox),n.features=e,n}([je([[t,n],[i,o]])]))}}])}(lo.exports.EventEmitter),ww=Object.defineProperty,Lw=Object.defineProperties,Ow=Object.getOwnPropertyDescriptors,kw=Object.getOwnPropertySymbols,Nw=Object.prototype.hasOwnProperty,Iw=Object.prototype.propertyIsEnumerable,Pw=function(e,t,n){return t in e?ww(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n},Dw=function(e,t,n){return new Promise((function(r,i){var o=function(e){try{s(n.next(e))}catch(t){i(t)}},a=function(e){try{s(n.throw(e))}catch(t){i(t)}},s=function(e){return e.done?r(e.value):Promise.resolve(e.value).then(o,a)};s((n=n.apply(e,t)).next())}))},Fw=function(){return c((function e(t){f(this,e);var n=t.id,r=t.map,i=t.canvas,o=t.renderer,a=void 0===o?"regl":o,s=function(){var e=new yh,t=new Ll,n=new vl,r=new wl(n),i=new Bc,o=new Uc,a=new _l,s=new yl,u=new gl,c={id:"".concat(Vh++),globalConfigService:jh,shaderModuleService:e,debugService:t,cameraService:n,coordinateSystemService:r,fontService:i,iconService:o,markerService:a,popupService:s,controlService:u,customRenderService:{}},l=new zl(c);c.layerService=l;var f=new ch(c);c.sceneService=f;var h=new Il(c);c.interactionService=h;var d=new Bl(c);c.pickingService=d;var p={clear:new bh,pixelPicking:new xh,render:new Th,taa:new wh(e)};c.normalPassFactory=function(e){return p[e]};var v={copy:new Fh,bloom:new Oh,blurH:new Nh,blurV:new Ph,noise:new Gh,sepia:new zh,colorHalftone:new Dh,hexagonalPixelate:new Bh,ink:new Uh};return c.postProcessingPass=v,c.postProcessingPassFactory=function(e){return v[e]},c}();this.container=s,r.setContainer(s,n,i),s.rendererService="regl"===a?new Rw:new WM,this.sceneService=s.sceneService,this.mapService=s.mapService,this.iconService=s.iconService,this.fontService=s.fontService,this.controlService=s.controlService,this.layerService=s.layerService,this.debugService=s.debugService,this.debugService.setEnable(t.debug),this.markerService=s.markerService,this.interactionService=s.interactionService,this.popupService=s.popupService,this.boxSelect=new Mw(this,{}),this.initComponent(n),this.sceneService.init(t),this.initControl()}),[{key:"map",get:function(){return this.mapService.map}},{key:"loaded",get:function(){return this.sceneService.loaded}},{key:"getServiceContainer",value:function(){return this.container}},{key:"getSize",value:function(){return this.mapService.getSize()}},{key:"getMinZoom",value:function(){return this.mapService.getMinZoom()}},{key:"getMaxZoom",value:function(){return this.mapService.getMaxZoom()}},{key:"getType",value:function(){return this.mapService.getType()}},{key:"getMapContainer",value:function(){return this.mapService.getMapContainer()}},{key:"getMapCanvasContainer",value:function(){return this.mapService.getMapCanvasContainer()}},{key:"getMapService",value:function(){return this.mapService}},{key:"getDebugService",value:function(){return this.debugService}},{key:"exportPng",value:function(e){return Dw(this,null,i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",this.sceneService.exportPng(e));case 1:case"end":return t.stop()}}),t,this)})))}},{key:"exportMap",value:function(e){return Dw(this,null,i().mark((function t(){return i().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.abrupt("return",this.sceneService.exportPng(e));case 1:case"end":return t.stop()}}),t,this)})))}},{key:"registerRenderService",value:function(e){var t=this;this.sceneService.loaded?new e(this).init():this.on("loaded",(function(){new e(t).init()}))}},{key:"setBgColor",value:function(e){this.mapService.setBgColor(e)}},{key:"addLayer",value:function(e){var t=this;this.loaded?this.preAddLayer(e):this.once("loaded",(function(){t.preAddLayer(e)}))}},{key:"preAddLayer",value:function(e){var t=this,n=Hh(this.container);if(e.setContainer(n),this.sceneService.addLayer(e),e.inited){this.initTileLayer(e);var r=this.initMask(e);this.addMask(r,e.id)}else e.on("inited",(function(){t.initTileLayer(e);var n=t.initMask(e);t.addMask(n,e.id)}))}},{key:"initMask",value:function(e){var t=e.getLayerConfig(),n=t.mask,r=t.maskfence,i=t.maskColor,o=void 0===i?"#000":i,a=t.maskOpacity,s=void 0===a?0:a;if(n&&r)return(new dx).source(r).shape("fill").style({color:o,opacity:s})}},{key:"addMask",value:function(e,t){if(e){var n=this.getLayer(t);if(n){var r=Hh(this.container);e.setContainer(r),n.addMaskLayer(e),this.sceneService.addMask(e)}else console.warn("parent layer not find!")}}},{key:"getPickedLayer",value:function(){return this.layerService.pickedLayerId}},{key:"getLayers",value:function(){return this.layerService.getLayers()}},{key:"getLayer",value:function(e){return this.layerService.getLayer(e)}},{key:"getLayerByName",value:function(e){return this.layerService.getLayerByName(e)}},{key:"removeLayer",value:function(e,t){return Dw(this,null,i().mark((function n(){return i().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,this.layerService.remove(e,t);case 2:case"end":return n.stop()}}),n,this)})))}},{key:"removeAllLayer",value:function(){return Dw(this,null,i().mark((function e(){return i().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,this.layerService.removeAllLayers();case 2:case"end":return e.stop()}}),e,this)})))}},{key:"render",value:function(){this.sceneService.render()}},{key:"setEnableRender",value:function(e){this.layerService.setEnableRender(e)}},{key:"addIconFont",value:function(e,t){this.fontService.addIconFont(e,t)}},{key:"addIconFonts",value:function(e){var t=this;e.forEach((function(e){var n=a(e,2),r=n[0],i=n[1];t.fontService.addIconFont(r,i)}))}},{key:"addFontFace",value:function(e,t){var n=this;this.fontService.once("fontloaded",(function(e){n.emit("fontloaded",e)})),this.fontService.addFontFace(e,t)}},{key:"addImage",value:function(e,t){return Dw(this,null,i().mark((function n(){return i().wrap((function(n){for(;;)switch(n.prev=n.next){case 0:return n.next=2,this.iconService.addImage(e,t);case 2:case"end":return n.stop()}}),n,this)})))}},{key:"hasImage",value:function(e){return this.iconService.hasImage(e)}},{key:"removeImage",value:function(e){this.iconService.removeImage(e)}},{key:"addIconFontGlyphs",value:function(e,t){this.fontService.addIconGlyphs(t)}},{key:"addControl",value:function(e){this.controlService.addControl(e,this.container)}},{key:"removeControl",value:function(e){this.controlService.removeControl(e)}},{key:"getControlByName",value:function(e){return this.controlService.getControlByName(e)}},{key:"addMarker",value:function(e){this.markerService.addMarker(e)}},{key:"addMarkerLayer",value:function(e){this.markerService.addMarkerLayer(e)}},{key:"removeMarkerLayer",value:function(e){this.markerService.removeMarkerLayer(e)}},{key:"removeAllMarkers",value:function(){this.markerService.removeAllMarkers()}},{key:"removeAllMakers",value:function(){console.warn("removeAllMakers 已废弃，请使用 removeAllMarkers"),this.markerService.removeAllMarkers()}},{key:"addPopup",value:function(e){this.popupService.addPopup(e)}},{key:"removePopup",value:function(e){this.popupService.removePopup(e)}},{key:"on",value:function(e,t){var n;Cw.includes(e)?null==(n=this.boxSelect)||n.on(e,t):Xh.includes(e)?this.sceneService.on(e,t):this.mapService.on(e,t)}},{key:"once",value:function(e,t){var n;Cw.includes(e)?null==(n=this.boxSelect)||n.once(e,t):Xh.includes(e)?this.sceneService.once(e,t):this.mapService.once(e,t)}},{key:"emit",value:function(e,t){-1===Xh.indexOf(e)?this.mapService.on(e,t):this.sceneService.emit(e,t)}},{key:"off",value:function(e,t){var n;Cw.includes(e)?null==(n=this.boxSelect)||n.off(e,t):Xh.includes(e)?this.sceneService.off(e,t):this.mapService.off(e,t)}},{key:"getZoom",value:function(){return this.mapService.getZoom()}},{key:"getCenter",value:function(e){return this.mapService.getCenter(e)}},{key:"setCenter",value:function(e,t){return this.mapService.setCenter(e,t)}},{key:"getPitch",value:function(){return this.mapService.getPitch()}},{key:"setPitch",value:function(e){return this.mapService.setPitch(e)}},{key:"getRotation",value:function(){return this.mapService.getRotation()}},{key:"getBounds",value:function(){return this.mapService.getBounds()}},{key:"setRotation",value:function(e){this.mapService.setRotation(e)}},{key:"zoomIn",value:function(){this.mapService.zoomIn()}},{key:"zoomOut",value:function(){this.mapService.zoomOut()}},{key:"panTo",value:function(e){this.mapService.panTo(e)}},{key:"panBy",value:function(e,t){this.mapService.panBy(e,t)}},{key:"getContainer",value:function(){return this.mapService.getContainer()}},{key:"setZoom",value:function(e){this.mapService.setZoom(e)}},{key:"fitBounds",value:function(e,t){var n,r=this.sceneService.getSceneConfig(),i=r.fitBoundsOptions,o=r.animate;this.mapService.fitBounds(e,t||(n=function(e,t){for(var n in t||(t={}))Nw.call(t,n)&&Pw(e,n,t[n]);if(kw){var r,i=y(kw(t));try{for(i.s();!(r=i.n()).done;)n=r.value,Iw.call(t,n)&&Pw(e,n,t[n])}catch(o){i.e(o)}finally{i.f()}}return e}({},i),Lw(n,Ow({animate:o}))))}},{key:"setZoomAndCenter",value:function(e,t){this.mapService.setZoomAndCenter(e,t)}},{key:"setMapStyle",value:function(e){this.mapService.setMapStyle(e)}},{key:"setMapStatus",value:function(e){this.mapService.setMapStatus(e)}},{key:"pixelToLngLat",value:function(e){return this.mapService.pixelToLngLat(e)}},{key:"lngLatToPixel",value:function(e){return this.mapService.lngLatToPixel(e)}},{key:"containerToLngLat",value:function(e){return this.mapService.containerToLngLat(e)}},{key:"lngLatToContainer",value:function(e){return this.mapService.lngLatToContainer(e)}},{key:"destroy",value:function(){this.sceneService.destroy()}},{key:"registerPostProcessingPass",value:function(e){this.container.postProcessingPass.name=new e}},{key:"enableShaderPick",value:function(){this.layerService.enableShaderPick()}},{key:"diasbleShaderPick",value:function(){this.layerService.disableShaderPick()}},{key:"enableBoxSelect",value:function(){var e=this,t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];this.boxSelect.enable(),t&&this.boxSelect.once("selectend",(function(){e.disableBoxSelect()}))}},{key:"disableBoxSelect",value:function(){this.boxSelect.disable()}},{key:"getProtocol",value:function(e){return Ye.REGISTERED_PROTOCOLS[e]}},{key:"startAnimate",value:function(){this.layerService.startAnimate()}},{key:"stopAnimate",value:function(){this.layerService.stopAnimate()}},{key:"getPointSizeRange",value:function(){return this.sceneService.getPointSizeRange()}},{key:"initComponent",value:function(e){var t,n;this.controlService.init({container:(t=e,n=t,"string"==typeof t&&(n=window.document.getElementById(t)),n)},this.container),this.markerService.init(this.container),this.popupService.init(this.container)}},{key:"initControl",value:function(){var e=this.sceneService.getSceneConfig(),t=e.logoVisible,n=e.logoPosition;t&&this.addControl(new ov({position:n}))}},{key:"initTileLayer",value:function(e){e.getSource().isTile&&(e.tileLayer=new Tx(e))}}],[{key:"addProtocol",value:function(e,t){Ye.REGISTERED_PROTOCOLS[e]=t}},{key:"removeProtocol",value:function(e){delete Ye.REGISTERED_PROTOCOLS[e]}}])}();e("default",{__name:"globalMapWithNode",setup:function(e){var t=ce(null),n=[{node:"xx1",region:"cn-beijing",provider:"aws",Latitude:28.391139,Longitude:-80.588343,target:[{node:"xx2",provider:"aliyun",region:"cn-shanghai",Latitude:27.931944,Longitude:-15.386667,packageLossRate:5}]},{node:"xx2",region:"cn-shanghai",Latitude:27.931944,Longitude:-15.386667,provider:"aliyun",target:[{node:"xx1",provider:"aws",region:"cn-beijing",Latitude:28.391139,Longitude:-80.588343,packageLossRate:0}]}];return le((function(){var e=new Fw({id:t.value,map:new cS({pitch:0,style:"dark",center:[120.19382669582967,30.258134],zoom:-1,projection:"equirectangular"}),viewMode:"3d",enableScroll:!1});e.on("loaded",(function(){var t=(new Mb).source(n.flatMap((function(e){return e.target.map((function(e){return{coord:[e.Longitude,e.Latitude],color:(t=e.packageLossRate,t>=10?"#FF0000":t>0&&t<10?"#FFA500":"#008000")};var t}))})),{parser:{type:"json",coordinates:"coord"}}).color("color").size(2).linecap("round").linejoin("miter").dasharray([5,10]).style({opacity:.6});e.addLayer(t);var r=(new Jb).source(n.map((function(e){return{name:e.node,provider:e.provider,coordinate:[e.Longitude,e.Latitude]}}))).size(5).shape("circle").style({opacity:.8});e.addLayer(r),r.on("click",(function(e){var t=e.data;console.log(t)})),t.on("click",(function(e){var t=e.data;console.log(t)}))}))})),function(e,n){return he(),fe("div",{style:{height:"800px"},ref_key:"mapContainer",ref:t},null,512)}}})}}}))}();
